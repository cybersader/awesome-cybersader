/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD AND TERSER
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var __create=Object.create,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__typeError=msg=>{throw TypeError(msg)},__defNormalProp=(obj,key2,value)=>key2 in obj?__defProp(obj,key2,{enumerable:true,configurable:true,writable:true,value}):obj[key2]=value,__commonJS=(cb2,mod)=>function __require(){return mod||(0,cb2[__getOwnPropNames(cb2)[0]])((mod={exports:{}}).exports,mod),mod.exports},__export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})},__copyProps=(to,from,except,desc)=>{if(from&&"object"==typeof from||"function"==typeof from)for(let key2 of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key2)&&key2!==except)__defProp(to,key2,{get:()=>from[key2],enumerable:!(desc=__getOwnPropDesc(from,key2))||desc.enumerable});return to},__toESM=(mod,isNodeMode,target)=>(target=null!=mod?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:true}):target,mod)),__toCommonJS=mod=>__copyProps(__defProp({},"__esModule",{value:true}),mod),__publicField=(obj,key2,value)=>__defNormalProp(obj,"symbol"!=typeof key2?key2+"":key2,value),__accessCheck=(obj,member,msg)=>member.has(obj)||__typeError("Cannot "+msg),__privateGet=(obj,member,getter)=>(__accessCheck(obj,member,"read from private field"),getter?getter.call(obj):member.get(obj)),__privateAdd=(obj,member,value)=>member.has(obj)?__typeError("Cannot add the same private member more than once"):member instanceof WeakSet?member.add(obj):member.set(obj,value),__privateSet=(obj,member,value,setter)=>(__accessCheck(obj,member,"write to private field"),setter?setter.call(obj,value):member.set(obj,value),value),__privateMethod=(obj,member,method)=>(__accessCheck(obj,member,"access private method"),method),require_diff_match_patch=__commonJS({"node_modules/diff-match-patch/index.js"(exports,module2){var diff_match_patch4=function(){this.Diff_Timeout=1;this.Diff_EditCost=4;this.Match_Threshold=.5;this.Match_Distance=1e3;this.Patch_DeleteThreshold=.5;this.Patch_Margin=4;this.Match_MaxBits=32};diff_match_patch4.Diff=function(op,text2){return[op,text2]};diff_match_patch4.prototype.diff_main=function(text1,text2,opt_checklines,opt_deadline){if("undefined"==typeof opt_deadline)if(this.Diff_Timeout<=0)opt_deadline=Number.MAX_VALUE;else opt_deadline=(new Date).getTime()+1e3*this.Diff_Timeout;var deadline=opt_deadline;if(null==text1||null==text2)throw new Error("Null input. (diff_main)");if(text1==text2)if(text1)return[new diff_match_patch4.Diff(0,text1)];else return[];if("undefined"==typeof opt_checklines)opt_checklines=true;var checklines=opt_checklines,commonlength=this.diff_commonPrefix(text1,text2),commonprefix=text1.substring(0,commonlength);text1=text1.substring(commonlength);text2=text2.substring(commonlength);commonlength=this.diff_commonSuffix(text1,text2);var commonsuffix=text1.substring(text1.length-commonlength);text1=text1.substring(0,text1.length-commonlength);text2=text2.substring(0,text2.length-commonlength);var diffs=this.diff_compute_(text1,text2,checklines,deadline);if(commonprefix)diffs.unshift(new diff_match_patch4.Diff(0,commonprefix));if(commonsuffix)diffs.push(new diff_match_patch4.Diff(0,commonsuffix));this.diff_cleanupMerge(diffs);return diffs};diff_match_patch4.prototype.diff_compute_=function(text1,text2,checklines,deadline){var diffs;if(!text1)return[new diff_match_patch4.Diff(1,text2)];if(!text2)return[new diff_match_patch4.Diff(-1,text1)];var longtext=text1.length>text2.length?text1:text2,shorttext=text1.length>text2.length?text2:text1,i2=longtext.indexOf(shorttext);if(-1!=i2){diffs=[new diff_match_patch4.Diff(1,longtext.substring(0,i2)),new diff_match_patch4.Diff(0,shorttext),new diff_match_patch4.Diff(1,longtext.substring(i2+shorttext.length))];if(text1.length>text2.length)diffs[0][0]=diffs[2][0]=-1;return diffs}if(1==shorttext.length)return[new diff_match_patch4.Diff(-1,text1),new diff_match_patch4.Diff(1,text2)];var hm=this.diff_halfMatch_(text1,text2);if(hm){var text1_a=hm[0],text1_b=hm[1],text2_a=hm[2],text2_b=hm[3],mid_common=hm[4],diffs_a=this.diff_main(text1_a,text2_a,checklines,deadline),diffs_b=this.diff_main(text1_b,text2_b,checklines,deadline);return diffs_a.concat([new diff_match_patch4.Diff(0,mid_common)],diffs_b)}if(checklines&&text1.length>100&&text2.length>100)return this.diff_lineMode_(text1,text2,deadline);else return this.diff_bisect_(text1,text2,deadline)};diff_match_patch4.prototype.diff_lineMode_=function(text1,text2,deadline){var a2=this.diff_linesToChars_(text1,text2);text1=a2.chars1;text2=a2.chars2;var linearray=a2.lineArray,diffs=this.diff_main(text1,text2,false,deadline);this.diff_charsToLines_(diffs,linearray);this.diff_cleanupSemantic(diffs);diffs.push(new diff_match_patch4.Diff(0,""));for(var pointer=0,count_delete=0,count_insert=0,text_delete="",text_insert="";pointer<diffs.length;){switch(diffs[pointer][0]){case 1:count_insert++;text_insert+=diffs[pointer][1];break;case-1:count_delete++;text_delete+=diffs[pointer][1];break;case 0:if(count_delete>=1&&count_insert>=1){diffs.splice(pointer-count_delete-count_insert,count_delete+count_insert);pointer=pointer-count_delete-count_insert;for(var subDiff=this.diff_main(text_delete,text_insert,false,deadline),j2=subDiff.length-1;j2>=0;j2--)diffs.splice(pointer,0,subDiff[j2]);pointer+=subDiff.length}count_insert=0;count_delete=0;text_delete="";text_insert="";break}pointer++}diffs.pop();return diffs};diff_match_patch4.prototype.diff_bisect_=function(text1,text2,deadline){for(var text1_length=text1.length,text2_length=text2.length,max_d=Math.ceil((text1_length+text2_length)/2),v_offset=max_d,v_length=2*max_d,v1=new Array(v_length),v2=new Array(v_length),x2=0;x2<v_length;x2++){v1[x2]=-1;v2[x2]=-1}v1[v_offset+1]=0;v2[v_offset+1]=0;for(var delta=text1_length-text2_length,front=delta%2!=0,k1start=0,k1end=0,k2start=0,k2end=0,d4=0;d4<max_d&&!((new Date).getTime()>deadline);d4++){for(var k1=-d4+k1start;k1<=d4-k1end;k1+=2){var k1_offset=v_offset+k1;if(k1==-d4||k1!=d4&&v1[k1_offset-1]<v1[k1_offset+1])x1=v1[k1_offset+1];else x1=v1[k1_offset-1]+1;for(var y1=x1-k1;x1<text1_length&&y1<text2_length&&text1.charAt(x1)==text2.charAt(y1);){x1++;y1++}v1[k1_offset]=x1;if(x1>text1_length)k1end+=2;else if(y1>text2_length)k1start+=2;else if(front)if((k2_offset=v_offset+delta-k1)>=0&&k2_offset<v_length&&-1!=v2[k2_offset])if(x1>=(x22=text1_length-v2[k2_offset]))return this.diff_bisectSplit_(text1,text2,x1,y1,deadline)}for(var k2=-d4+k2start;k2<=d4-k2end;k2+=2){var x22,k2_offset=v_offset+k2;if(k2==-d4||k2!=d4&&v2[k2_offset-1]<v2[k2_offset+1])x22=v2[k2_offset+1];else x22=v2[k2_offset-1]+1;for(var y2=x22-k2;x22<text1_length&&y2<text2_length&&text1.charAt(text1_length-x22-1)==text2.charAt(text2_length-y2-1);){x22++;y2++}v2[k2_offset]=x22;if(x22>text1_length)k2end+=2;else if(y2>text2_length)k2start+=2;else if(!front)if((k1_offset=v_offset+delta-k2)>=0&&k1_offset<v_length&&-1!=v1[k1_offset]){var x1;y1=v_offset+(x1=v1[k1_offset])-k1_offset;if(x1>=(x22=text1_length-x22))return this.diff_bisectSplit_(text1,text2,x1,y1,deadline)}}}return[new diff_match_patch4.Diff(-1,text1),new diff_match_patch4.Diff(1,text2)]};diff_match_patch4.prototype.diff_bisectSplit_=function(text1,text2,x2,y2,deadline){var text1a=text1.substring(0,x2),text2a=text2.substring(0,y2),text1b=text1.substring(x2),text2b=text2.substring(y2),diffs=this.diff_main(text1a,text2a,false,deadline),diffsb=this.diff_main(text1b,text2b,false,deadline);return diffs.concat(diffsb)};diff_match_patch4.prototype.diff_linesToChars_=function(text1,text2){var lineArray=[],lineHash={};lineArray[0]="";function diff_linesToCharsMunge_(text3){for(var chars="",lineStart=0,lineEnd=-1,lineArrayLength=lineArray.length;lineEnd<text3.length-1;){if(-1==(lineEnd=text3.indexOf("\n",lineStart)))lineEnd=text3.length-1;var line=text3.substring(lineStart,lineEnd+1);if(lineHash.hasOwnProperty?lineHash.hasOwnProperty(line):void 0!==lineHash[line])chars+=String.fromCharCode(lineHash[line]);else{if(lineArrayLength==maxLines){line=text3.substring(lineStart);lineEnd=text3.length}chars+=String.fromCharCode(lineArrayLength);lineHash[line]=lineArrayLength;lineArray[lineArrayLength++]=line}lineStart=lineEnd+1}return chars}var maxLines=4e4,chars1=diff_linesToCharsMunge_(text1);maxLines=65535;return{chars1,chars2:diff_linesToCharsMunge_(text2),lineArray}};diff_match_patch4.prototype.diff_charsToLines_=function(diffs,lineArray){for(var i2=0;i2<diffs.length;i2++){for(var chars=diffs[i2][1],text2=[],j2=0;j2<chars.length;j2++)text2[j2]=lineArray[chars.charCodeAt(j2)];diffs[i2][1]=text2.join("")}};diff_match_patch4.prototype.diff_commonPrefix=function(text1,text2){if(!text1||!text2||text1.charAt(0)!=text2.charAt(0))return 0;for(var pointermin=0,pointermax=Math.min(text1.length,text2.length),pointermid=pointermax,pointerstart=0;pointermin<pointermid;){if(text1.substring(pointerstart,pointermid)==text2.substring(pointerstart,pointermid))pointerstart=pointermin=pointermid;else pointermax=pointermid;pointermid=Math.floor((pointermax-pointermin)/2+pointermin)}return pointermid};diff_match_patch4.prototype.diff_commonSuffix=function(text1,text2){if(!text1||!text2||text1.charAt(text1.length-1)!=text2.charAt(text2.length-1))return 0;for(var pointermin=0,pointermax=Math.min(text1.length,text2.length),pointermid=pointermax,pointerend=0;pointermin<pointermid;){if(text1.substring(text1.length-pointermid,text1.length-pointerend)==text2.substring(text2.length-pointermid,text2.length-pointerend))pointerend=pointermin=pointermid;else pointermax=pointermid;pointermid=Math.floor((pointermax-pointermin)/2+pointermin)}return pointermid};diff_match_patch4.prototype.diff_commonOverlap_=function(text1,text2){var text1_length=text1.length,text2_length=text2.length;if(0==text1_length||0==text2_length)return 0;if(text1_length>text2_length)text1=text1.substring(text1_length-text2_length);else if(text1_length<text2_length)text2=text2.substring(0,text1_length);var text_length=Math.min(text1_length,text2_length);if(text1==text2)return text_length;for(var best=0,length=1;;){var pattern=text1.substring(text_length-length),found=text2.indexOf(pattern);if(-1==found)return best;length+=found;if(0==found||text1.substring(text_length-length)==text2.substring(0,length)){best=length;length++}}};diff_match_patch4.prototype.diff_halfMatch_=function(text1,text2){if(this.Diff_Timeout<=0)return null;var longtext=text1.length>text2.length?text1:text2,shorttext=text1.length>text2.length?text2:text1;if(longtext.length<4||2*shorttext.length<longtext.length)return null;var dmp=this;function diff_halfMatchI_(longtext2,shorttext2,i2){for(var best_longtext_a,best_longtext_b,best_shorttext_a,best_shorttext_b,seed=longtext2.substring(i2,i2+Math.floor(longtext2.length/4)),j2=-1,best_common="";-1!=(j2=shorttext2.indexOf(seed,j2+1));){var prefixLength=dmp.diff_commonPrefix(longtext2.substring(i2),shorttext2.substring(j2)),suffixLength=dmp.diff_commonSuffix(longtext2.substring(0,i2),shorttext2.substring(0,j2));if(best_common.length<suffixLength+prefixLength){best_common=shorttext2.substring(j2-suffixLength,j2)+shorttext2.substring(j2,j2+prefixLength);best_longtext_a=longtext2.substring(0,i2-suffixLength);best_longtext_b=longtext2.substring(i2+prefixLength);best_shorttext_a=shorttext2.substring(0,j2-suffixLength);best_shorttext_b=shorttext2.substring(j2+prefixLength)}}if(2*best_common.length>=longtext2.length)return[best_longtext_a,best_longtext_b,best_shorttext_a,best_shorttext_b,best_common];else return null}var hm,text1_a,text1_b,text2_a,text2_b,hm1=diff_halfMatchI_(longtext,shorttext,Math.ceil(longtext.length/4)),hm2=diff_halfMatchI_(longtext,shorttext,Math.ceil(longtext.length/2));if(!hm1&&!hm2)return null;else if(!hm2)hm=hm1;else if(!hm1)hm=hm2;else hm=hm1[4].length>hm2[4].length?hm1:hm2;if(text1.length>text2.length){text1_a=hm[0];text1_b=hm[1];text2_a=hm[2];text2_b=hm[3]}else{text2_a=hm[0];text2_b=hm[1];text1_a=hm[2];text1_b=hm[3]}return[text1_a,text1_b,text2_a,text2_b,hm[4]]};diff_match_patch4.prototype.diff_cleanupSemantic=function(diffs){for(var changes3=false,equalities=[],equalitiesLength=0,lastEquality=null,pointer=0,length_insertions1=0,length_deletions1=0,length_insertions2=0,length_deletions2=0;pointer<diffs.length;){if(0==diffs[pointer][0]){equalities[equalitiesLength++]=pointer;length_insertions1=length_insertions2;length_deletions1=length_deletions2;length_insertions2=0;length_deletions2=0;lastEquality=diffs[pointer][1]}else{if(1==diffs[pointer][0])length_insertions2+=diffs[pointer][1].length;else length_deletions2+=diffs[pointer][1].length;if(lastEquality&&lastEquality.length<=Math.max(length_insertions1,length_deletions1)&&lastEquality.length<=Math.max(length_insertions2,length_deletions2)){diffs.splice(equalities[equalitiesLength-1],0,new diff_match_patch4.Diff(-1,lastEquality));diffs[equalities[equalitiesLength-1]+1][0]=1;equalitiesLength--;pointer=--equalitiesLength>0?equalities[equalitiesLength-1]:-1;length_insertions1=0;length_deletions1=0;length_insertions2=0;length_deletions2=0;lastEquality=null;changes3=true}}pointer++}if(changes3)this.diff_cleanupMerge(diffs);this.diff_cleanupSemanticLossless(diffs);pointer=1;for(;pointer<diffs.length;){if(-1==diffs[pointer-1][0]&&1==diffs[pointer][0]){var deletion=diffs[pointer-1][1],insertion=diffs[pointer][1],overlap_length1=this.diff_commonOverlap_(deletion,insertion),overlap_length2=this.diff_commonOverlap_(insertion,deletion);if(overlap_length1>=overlap_length2){if(overlap_length1>=deletion.length/2||overlap_length1>=insertion.length/2){diffs.splice(pointer,0,new diff_match_patch4.Diff(0,insertion.substring(0,overlap_length1)));diffs[pointer-1][1]=deletion.substring(0,deletion.length-overlap_length1);diffs[pointer+1][1]=insertion.substring(overlap_length1);pointer++}}else if(overlap_length2>=deletion.length/2||overlap_length2>=insertion.length/2){diffs.splice(pointer,0,new diff_match_patch4.Diff(0,deletion.substring(0,overlap_length2)));diffs[pointer-1][0]=1;diffs[pointer-1][1]=insertion.substring(0,insertion.length-overlap_length2);diffs[pointer+1][0]=-1;diffs[pointer+1][1]=deletion.substring(overlap_length2);pointer++}pointer++}pointer++}};diff_match_patch4.prototype.diff_cleanupSemanticLossless=function(diffs){function diff_cleanupSemanticScore_(one,two){if(!one||!two)return 6;var char1=one.charAt(one.length-1),char2=two.charAt(0),nonAlphaNumeric1=char1.match(diff_match_patch4.nonAlphaNumericRegex_),nonAlphaNumeric2=char2.match(diff_match_patch4.nonAlphaNumericRegex_),whitespace1=nonAlphaNumeric1&&char1.match(diff_match_patch4.whitespaceRegex_),whitespace2=nonAlphaNumeric2&&char2.match(diff_match_patch4.whitespaceRegex_),lineBreak1=whitespace1&&char1.match(diff_match_patch4.linebreakRegex_),lineBreak2=whitespace2&&char2.match(diff_match_patch4.linebreakRegex_),blankLine1=lineBreak1&&one.match(diff_match_patch4.blanklineEndRegex_),blankLine2=lineBreak2&&two.match(diff_match_patch4.blanklineStartRegex_);if(blankLine1||blankLine2)return 5;else if(lineBreak1||lineBreak2)return 4;else if(nonAlphaNumeric1&&!whitespace1&&whitespace2)return 3;else if(whitespace1||whitespace2)return 2;else if(nonAlphaNumeric1||nonAlphaNumeric2)return 1;return 0}for(var pointer=1;pointer<diffs.length-1;){if(0==diffs[pointer-1][0]&&0==diffs[pointer+1][0]){var equality1=diffs[pointer-1][1],edit=diffs[pointer][1],equality2=diffs[pointer+1][1],commonOffset=this.diff_commonSuffix(equality1,edit);if(commonOffset){var commonString=edit.substring(edit.length-commonOffset);equality1=equality1.substring(0,equality1.length-commonOffset);edit=commonString+edit.substring(0,edit.length-commonOffset);equality2=commonString+equality2}for(var bestEquality1=equality1,bestEdit=edit,bestEquality2=equality2,bestScore=diff_cleanupSemanticScore_(equality1,edit)+diff_cleanupSemanticScore_(edit,equality2);edit.charAt(0)===equality2.charAt(0);){equality1+=edit.charAt(0);edit=edit.substring(1)+equality2.charAt(0);equality2=equality2.substring(1);var score=diff_cleanupSemanticScore_(equality1,edit)+diff_cleanupSemanticScore_(edit,equality2);if(score>=bestScore){bestScore=score;bestEquality1=equality1;bestEdit=edit;bestEquality2=equality2}}if(diffs[pointer-1][1]!=bestEquality1){if(bestEquality1)diffs[pointer-1][1]=bestEquality1;else{diffs.splice(pointer-1,1);pointer--}diffs[pointer][1]=bestEdit;if(bestEquality2)diffs[pointer+1][1]=bestEquality2;else{diffs.splice(pointer+1,1);pointer--}}}pointer++}};diff_match_patch4.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/;diff_match_patch4.whitespaceRegex_=/\s/;diff_match_patch4.linebreakRegex_=/[\r\n]/;diff_match_patch4.blanklineEndRegex_=/\n\r?\n$/;diff_match_patch4.blanklineStartRegex_=/^\r?\n\r?\n/;diff_match_patch4.prototype.diff_cleanupEfficiency=function(diffs){for(var changes3=false,equalities=[],equalitiesLength=0,lastEquality=null,pointer=0,pre_ins=false,pre_del=false,post_ins=false,post_del=false;pointer<diffs.length;){if(0==diffs[pointer][0]){if(diffs[pointer][1].length<this.Diff_EditCost&&(post_ins||post_del)){equalities[equalitiesLength++]=pointer;pre_ins=post_ins;pre_del=post_del;lastEquality=diffs[pointer][1]}else{equalitiesLength=0;lastEquality=null}post_ins=post_del=false}else{if(-1==diffs[pointer][0])post_del=true;else post_ins=true;if(lastEquality&&(pre_ins&&pre_del&&post_ins&&post_del||lastEquality.length<this.Diff_EditCost/2&&pre_ins+pre_del+post_ins+post_del==3)){diffs.splice(equalities[equalitiesLength-1],0,new diff_match_patch4.Diff(-1,lastEquality));diffs[equalities[equalitiesLength-1]+1][0]=1;equalitiesLength--;lastEquality=null;if(pre_ins&&pre_del){post_ins=post_del=true;equalitiesLength=0}else{pointer=--equalitiesLength>0?equalities[equalitiesLength-1]:-1;post_ins=post_del=false}changes3=true}}pointer++}if(changes3)this.diff_cleanupMerge(diffs)};diff_match_patch4.prototype.diff_cleanupMerge=function(diffs){diffs.push(new diff_match_patch4.Diff(0,""));for(var commonlength,pointer=0,count_delete=0,count_insert=0,text_delete="",text_insert="";pointer<diffs.length;)switch(diffs[pointer][0]){case 1:count_insert++;text_insert+=diffs[pointer][1];pointer++;break;case-1:count_delete++;text_delete+=diffs[pointer][1];pointer++;break;case 0:if(count_delete+count_insert>1){if(0!==count_delete&&0!==count_insert){if(0!==(commonlength=this.diff_commonPrefix(text_insert,text_delete))){if(pointer-count_delete-count_insert>0&&0==diffs[pointer-count_delete-count_insert-1][0])diffs[pointer-count_delete-count_insert-1][1]+=text_insert.substring(0,commonlength);else{diffs.splice(0,0,new diff_match_patch4.Diff(0,text_insert.substring(0,commonlength)));pointer++}text_insert=text_insert.substring(commonlength);text_delete=text_delete.substring(commonlength)}if(0!==(commonlength=this.diff_commonSuffix(text_insert,text_delete))){diffs[pointer][1]=text_insert.substring(text_insert.length-commonlength)+diffs[pointer][1];text_insert=text_insert.substring(0,text_insert.length-commonlength);text_delete=text_delete.substring(0,text_delete.length-commonlength)}}pointer-=count_delete+count_insert;diffs.splice(pointer,count_delete+count_insert);if(text_delete.length){diffs.splice(pointer,0,new diff_match_patch4.Diff(-1,text_delete));pointer++}if(text_insert.length){diffs.splice(pointer,0,new diff_match_patch4.Diff(1,text_insert));pointer++}pointer++}else if(0!==pointer&&0==diffs[pointer-1][0]){diffs[pointer-1][1]+=diffs[pointer][1];diffs.splice(pointer,1)}else pointer++;count_insert=0;count_delete=0;text_delete="";text_insert="";break}if(""===diffs[diffs.length-1][1])diffs.pop();var changes3=false;pointer=1;for(;pointer<diffs.length-1;){if(0==diffs[pointer-1][0]&&0==diffs[pointer+1][0])if(diffs[pointer][1].substring(diffs[pointer][1].length-diffs[pointer-1][1].length)==diffs[pointer-1][1]){diffs[pointer][1]=diffs[pointer-1][1]+diffs[pointer][1].substring(0,diffs[pointer][1].length-diffs[pointer-1][1].length);diffs[pointer+1][1]=diffs[pointer-1][1]+diffs[pointer+1][1];diffs.splice(pointer-1,1);changes3=true}else if(diffs[pointer][1].substring(0,diffs[pointer+1][1].length)==diffs[pointer+1][1]){diffs[pointer-1][1]+=diffs[pointer+1][1];diffs[pointer][1]=diffs[pointer][1].substring(diffs[pointer+1][1].length)+diffs[pointer+1][1];diffs.splice(pointer+1,1);changes3=true}pointer++}if(changes3)this.diff_cleanupMerge(diffs)};diff_match_patch4.prototype.diff_xIndex=function(diffs,loc){var x2,chars1=0,chars2=0,last_chars1=0,last_chars2=0;for(x2=0;x2<diffs.length;x2++){if(1!==diffs[x2][0])chars1+=diffs[x2][1].length;if(-1!==diffs[x2][0])chars2+=diffs[x2][1].length;if(chars1>loc)break;last_chars1=chars1;last_chars2=chars2}if(diffs.length!=x2&&-1===diffs[x2][0])return last_chars2;else return last_chars2+(loc-last_chars1)};diff_match_patch4.prototype.diff_prettyHtml=function(diffs){for(var html=[],pattern_amp=/&/g,pattern_lt=/</g,pattern_gt=/>/g,pattern_para=/\n/g,x2=0;x2<diffs.length;x2++){var op=diffs[x2][0],text2=diffs[x2][1].replace(pattern_amp,"&amp;").replace(pattern_lt,"&lt;").replace(pattern_gt,"&gt;").replace(pattern_para,"&para;<br>");switch(op){case 1:html[x2]='<ins style="background:#e6ffe6;">'+text2+"</ins>";break;case-1:html[x2]='<del style="background:#ffe6e6;">'+text2+"</del>";break;case 0:html[x2]="<span>"+text2+"</span>";break}}return html.join("")};diff_match_patch4.prototype.diff_text1=function(diffs){for(var text2=[],x2=0;x2<diffs.length;x2++)if(1!==diffs[x2][0])text2[x2]=diffs[x2][1];return text2.join("")};diff_match_patch4.prototype.diff_text2=function(diffs){for(var text2=[],x2=0;x2<diffs.length;x2++)if(-1!==diffs[x2][0])text2[x2]=diffs[x2][1];return text2.join("")};diff_match_patch4.prototype.diff_levenshtein=function(diffs){for(var levenshtein=0,insertions=0,deletions=0,x2=0;x2<diffs.length;x2++){var op=diffs[x2][0],data=diffs[x2][1];switch(op){case 1:insertions+=data.length;break;case-1:deletions+=data.length;break;case 0:levenshtein+=Math.max(insertions,deletions);insertions=0;deletions=0;break}}return levenshtein+Math.max(insertions,deletions)};diff_match_patch4.prototype.diff_toDelta=function(diffs){for(var text2=[],x2=0;x2<diffs.length;x2++)switch(diffs[x2][0]){case 1:text2[x2]="+"+encodeURI(diffs[x2][1]);break;case-1:text2[x2]="-"+diffs[x2][1].length;break;case 0:text2[x2]="="+diffs[x2][1].length;break}return text2.join("\t").replace(/%20/g," ")};diff_match_patch4.prototype.diff_fromDelta=function(text1,delta){for(var diffs=[],diffsLength=0,pointer=0,tokens=delta.split(/\t/g),x2=0;x2<tokens.length;x2++){var param=tokens[x2].substring(1);switch(tokens[x2].charAt(0)){case"+":try{diffs[diffsLength++]=new diff_match_patch4.Diff(1,decodeURI(param))}catch(ex){throw new Error("Illegal escape in diff_fromDelta: "+param)}break;case"-":case"=":var n3=parseInt(param,10);if(isNaN(n3)||n3<0)throw new Error("Invalid number in diff_fromDelta: "+param);var text2=text1.substring(pointer,pointer+=n3);if("="==tokens[x2].charAt(0))diffs[diffsLength++]=new diff_match_patch4.Diff(0,text2);else diffs[diffsLength++]=new diff_match_patch4.Diff(-1,text2);break;default:if(tokens[x2])throw new Error("Invalid diff operation in diff_fromDelta: "+tokens[x2])}}if(pointer!=text1.length)throw new Error("Delta length ("+pointer+") does not equal source text length ("+text1.length+").");return diffs};diff_match_patch4.prototype.match_main=function(text2,pattern,loc){if(null==text2||null==pattern||null==loc)throw new Error("Null input. (match_main)");loc=Math.max(0,Math.min(loc,text2.length));if(text2==pattern)return 0;else if(!text2.length)return-1;else if(text2.substring(loc,loc+pattern.length)==pattern)return loc;else return this.match_bitap_(text2,pattern,loc)};diff_match_patch4.prototype.match_bitap_=function(text2,pattern,loc){if(pattern.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var s2=this.match_alphabet_(pattern),dmp=this;function match_bitapScore_(e4,x2){var accuracy=e4/pattern.length,proximity=Math.abs(loc-x2);if(!dmp.Match_Distance)return proximity?1:accuracy;else return accuracy+proximity/dmp.Match_Distance}var score_threshold=this.Match_Threshold,best_loc=text2.indexOf(pattern,loc);if(-1!=best_loc){score_threshold=Math.min(match_bitapScore_(0,best_loc),score_threshold);if(-1!=(best_loc=text2.lastIndexOf(pattern,loc+pattern.length)))score_threshold=Math.min(match_bitapScore_(0,best_loc),score_threshold)}var bin_min,bin_mid,matchmask=1<<pattern.length-1;best_loc=-1;for(var last_rd,bin_max=pattern.length+text2.length,d4=0;d4<pattern.length;d4++){bin_min=0;bin_mid=bin_max;for(;bin_min<bin_mid;){if(match_bitapScore_(d4,loc+bin_mid)<=score_threshold)bin_min=bin_mid;else bin_max=bin_mid;bin_mid=Math.floor((bin_max-bin_min)/2+bin_min)}bin_max=bin_mid;var start=Math.max(1,loc-bin_mid+1),finish=Math.min(loc+bin_mid,text2.length)+pattern.length,rd=Array(finish+2);rd[finish+1]=(1<<d4)-1;for(var j2=finish;j2>=start;j2--){var charMatch=s2[text2.charAt(j2-1)];if(0===d4)rd[j2]=(rd[j2+1]<<1|1)&charMatch;else rd[j2]=(rd[j2+1]<<1|1)&charMatch|(last_rd[j2+1]|last_rd[j2])<<1|1|last_rd[j2+1];if(rd[j2]&matchmask){var score=match_bitapScore_(d4,j2-1);if(score<=score_threshold){score_threshold=score;if((best_loc=j2-1)>loc)start=Math.max(1,2*loc-best_loc);else break}}}if(match_bitapScore_(d4+1,loc)>score_threshold)break;last_rd=rd}return best_loc};diff_match_patch4.prototype.match_alphabet_=function(pattern){for(var s2={},i2=0;i2<pattern.length;i2++)s2[pattern.charAt(i2)]=0;for(i2=0;i2<pattern.length;i2++)s2[pattern.charAt(i2)]|=1<<pattern.length-i2-1;return s2};diff_match_patch4.prototype.patch_addContext_=function(patch,text2){if(0!=text2.length){if(null===patch.start2)throw Error("patch not initialized");for(var pattern=text2.substring(patch.start2,patch.start2+patch.length1),padding=0;text2.indexOf(pattern)!=text2.lastIndexOf(pattern)&&pattern.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;){padding+=this.Patch_Margin;pattern=text2.substring(patch.start2-padding,patch.start2+patch.length1+padding)}padding+=this.Patch_Margin;var prefix=text2.substring(patch.start2-padding,patch.start2);if(prefix)patch.diffs.unshift(new diff_match_patch4.Diff(0,prefix));var suffix=text2.substring(patch.start2+patch.length1,patch.start2+patch.length1+padding);if(suffix)patch.diffs.push(new diff_match_patch4.Diff(0,suffix));patch.start1-=prefix.length;patch.start2-=prefix.length;patch.length1+=prefix.length+suffix.length;patch.length2+=prefix.length+suffix.length}};diff_match_patch4.prototype.patch_make=function(a2,opt_b,opt_c){var text1,diffs;if("string"==typeof a2&&"string"==typeof opt_b&&"undefined"==typeof opt_c){text1=a2;if((diffs=this.diff_main(text1,opt_b,true)).length>2){this.diff_cleanupSemantic(diffs);this.diff_cleanupEfficiency(diffs)}}else if(a2&&"object"==typeof a2&&"undefined"==typeof opt_b&&"undefined"==typeof opt_c){diffs=a2;text1=this.diff_text1(diffs)}else if("string"==typeof a2&&opt_b&&"object"==typeof opt_b&&"undefined"==typeof opt_c){text1=a2;diffs=opt_b}else if("string"==typeof a2&&"string"==typeof opt_b&&opt_c&&"object"==typeof opt_c){text1=a2;diffs=opt_c}else throw new Error("Unknown call format to patch_make.");if(0===diffs.length)return[];for(var patches=[],patch=new diff_match_patch4.patch_obj,patchDiffLength=0,char_count1=0,char_count2=0,prepatch_text=text1,postpatch_text=text1,x2=0;x2<diffs.length;x2++){var diff_type=diffs[x2][0],diff_text=diffs[x2][1];if(!patchDiffLength&&0!==diff_type){patch.start1=char_count1;patch.start2=char_count2}switch(diff_type){case 1:patch.diffs[patchDiffLength++]=diffs[x2];patch.length2+=diff_text.length;postpatch_text=postpatch_text.substring(0,char_count2)+diff_text+postpatch_text.substring(char_count2);break;case-1:patch.length1+=diff_text.length;patch.diffs[patchDiffLength++]=diffs[x2];postpatch_text=postpatch_text.substring(0,char_count2)+postpatch_text.substring(char_count2+diff_text.length);break;case 0:if(diff_text.length<=2*this.Patch_Margin&&patchDiffLength&&diffs.length!=x2+1){patch.diffs[patchDiffLength++]=diffs[x2];patch.length1+=diff_text.length;patch.length2+=diff_text.length}else if(diff_text.length>=2*this.Patch_Margin)if(patchDiffLength){this.patch_addContext_(patch,prepatch_text);patches.push(patch);patch=new diff_match_patch4.patch_obj;patchDiffLength=0;prepatch_text=postpatch_text;char_count1=char_count2}break}if(1!==diff_type)char_count1+=diff_text.length;if(-1!==diff_type)char_count2+=diff_text.length}if(patchDiffLength){this.patch_addContext_(patch,prepatch_text);patches.push(patch)}return patches};diff_match_patch4.prototype.patch_deepCopy=function(patches){for(var patchesCopy=[],x2=0;x2<patches.length;x2++){var patch=patches[x2],patchCopy=new diff_match_patch4.patch_obj;patchCopy.diffs=[];for(var y2=0;y2<patch.diffs.length;y2++)patchCopy.diffs[y2]=new diff_match_patch4.Diff(patch.diffs[y2][0],patch.diffs[y2][1]);patchCopy.start1=patch.start1;patchCopy.start2=patch.start2;patchCopy.length1=patch.length1;patchCopy.length2=patch.length2;patchesCopy[x2]=patchCopy}return patchesCopy};diff_match_patch4.prototype.patch_apply=function(patches,text2){if(0==patches.length)return[text2,[]];patches=this.patch_deepCopy(patches);var nullPadding=this.patch_addPadding(patches);text2=nullPadding+text2+nullPadding;this.patch_splitMax(patches);for(var delta=0,results=[],x2=0;x2<patches.length;x2++){var start_loc,expected_loc=patches[x2].start2+delta,text1=this.diff_text1(patches[x2].diffs),end_loc=-1;if(text1.length>this.Match_MaxBits){if(-1!=(start_loc=this.match_main(text2,text1.substring(0,this.Match_MaxBits),expected_loc)))if(-1==(end_loc=this.match_main(text2,text1.substring(text1.length-this.Match_MaxBits),expected_loc+text1.length-this.Match_MaxBits))||start_loc>=end_loc)start_loc=-1}else start_loc=this.match_main(text2,text1,expected_loc);if(-1==start_loc){results[x2]=false;delta-=patches[x2].length2-patches[x2].length1}else{results[x2]=true;delta=start_loc-expected_loc;var text22;if(-1==end_loc)text22=text2.substring(start_loc,start_loc+text1.length);else text22=text2.substring(start_loc,end_loc+this.Match_MaxBits);if(text1==text22)text2=text2.substring(0,start_loc)+this.diff_text2(patches[x2].diffs)+text2.substring(start_loc+text1.length);else{var diffs=this.diff_main(text1,text22,false);if(text1.length>this.Match_MaxBits&&this.diff_levenshtein(diffs)/text1.length>this.Patch_DeleteThreshold)results[x2]=false;else{this.diff_cleanupSemanticLossless(diffs);for(var index22,index1=0,y2=0;y2<patches[x2].diffs.length;y2++){var mod=patches[x2].diffs[y2];if(0!==mod[0])index22=this.diff_xIndex(diffs,index1);if(1===mod[0])text2=text2.substring(0,start_loc+index22)+mod[1]+text2.substring(start_loc+index22);else if(-1===mod[0])text2=text2.substring(0,start_loc+index22)+text2.substring(start_loc+this.diff_xIndex(diffs,index1+mod[1].length));if(-1!==mod[0])index1+=mod[1].length}}}}}return[text2=text2.substring(nullPadding.length,text2.length-nullPadding.length),results]};diff_match_patch4.prototype.patch_addPadding=function(patches){for(var paddingLength=this.Patch_Margin,nullPadding="",x2=1;x2<=paddingLength;x2++)nullPadding+=String.fromCharCode(x2);for(x2=0;x2<patches.length;x2++){patches[x2].start1+=paddingLength;patches[x2].start2+=paddingLength}var patch=patches[0],diffs=patch.diffs;if(0==diffs.length||0!=diffs[0][0]){diffs.unshift(new diff_match_patch4.Diff(0,nullPadding));patch.start1-=paddingLength;patch.start2-=paddingLength;patch.length1+=paddingLength;patch.length2+=paddingLength}else if(paddingLength>diffs[0][1].length){var extraLength=paddingLength-diffs[0][1].length;diffs[0][1]=nullPadding.substring(diffs[0][1].length)+diffs[0][1];patch.start1-=extraLength;patch.start2-=extraLength;patch.length1+=extraLength;patch.length2+=extraLength}if(0==(diffs=(patch=patches[patches.length-1]).diffs).length||0!=diffs[diffs.length-1][0]){diffs.push(new diff_match_patch4.Diff(0,nullPadding));patch.length1+=paddingLength;patch.length2+=paddingLength}else if(paddingLength>diffs[diffs.length-1][1].length){extraLength=paddingLength-diffs[diffs.length-1][1].length;diffs[diffs.length-1][1]+=nullPadding.substring(0,extraLength);patch.length1+=extraLength;patch.length2+=extraLength}return nullPadding};diff_match_patch4.prototype.patch_splitMax=function(patches){for(var patch_size=this.Match_MaxBits,x2=0;x2<patches.length;x2++)if(!(patches[x2].length1<=patch_size)){var bigpatch=patches[x2];patches.splice(x2--,1);for(var start1=bigpatch.start1,start2=bigpatch.start2,precontext="";0!==bigpatch.diffs.length;){var patch=new diff_match_patch4.patch_obj,empty2=true;patch.start1=start1-precontext.length;patch.start2=start2-precontext.length;if(""!==precontext){patch.length1=patch.length2=precontext.length;patch.diffs.push(new diff_match_patch4.Diff(0,precontext))}for(;0!==bigpatch.diffs.length&&patch.length1<patch_size-this.Patch_Margin;){var diff_type=bigpatch.diffs[0][0],diff_text=bigpatch.diffs[0][1];if(1===diff_type){patch.length2+=diff_text.length;start2+=diff_text.length;patch.diffs.push(bigpatch.diffs.shift());empty2=false}else if(-1===diff_type&&1==patch.diffs.length&&0==patch.diffs[0][0]&&diff_text.length>2*patch_size){patch.length1+=diff_text.length;start1+=diff_text.length;empty2=false;patch.diffs.push(new diff_match_patch4.Diff(diff_type,diff_text));bigpatch.diffs.shift()}else{diff_text=diff_text.substring(0,patch_size-patch.length1-this.Patch_Margin);patch.length1+=diff_text.length;start1+=diff_text.length;if(0===diff_type){patch.length2+=diff_text.length;start2+=diff_text.length}else empty2=false;patch.diffs.push(new diff_match_patch4.Diff(diff_type,diff_text));if(diff_text==bigpatch.diffs[0][1])bigpatch.diffs.shift();else bigpatch.diffs[0][1]=bigpatch.diffs[0][1].substring(diff_text.length)}}precontext=(precontext=this.diff_text2(patch.diffs)).substring(precontext.length-this.Patch_Margin);var postcontext=this.diff_text1(bigpatch.diffs).substring(0,this.Patch_Margin);if(""!==postcontext){patch.length1+=postcontext.length;patch.length2+=postcontext.length;if(0!==patch.diffs.length&&0===patch.diffs[patch.diffs.length-1][0])patch.diffs[patch.diffs.length-1][1]+=postcontext;else patch.diffs.push(new diff_match_patch4.Diff(0,postcontext))}if(!empty2)patches.splice(++x2,0,patch)}}};diff_match_patch4.prototype.patch_toText=function(patches){for(var text2=[],x2=0;x2<patches.length;x2++)text2[x2]=patches[x2];return text2.join("")};diff_match_patch4.prototype.patch_fromText=function(textline){var patches=[];if(!textline)return patches;for(var text2=textline.split("\n"),textPointer=0,patchHeader=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;textPointer<text2.length;){var m2=text2[textPointer].match(patchHeader);if(!m2)throw new Error("Invalid patch string: "+text2[textPointer]);var patch=new diff_match_patch4.patch_obj;patches.push(patch);patch.start1=parseInt(m2[1],10);if(""===m2[2]){patch.start1--;patch.length1=1}else if("0"==m2[2])patch.length1=0;else{patch.start1--;patch.length1=parseInt(m2[2],10)}patch.start2=parseInt(m2[3],10);if(""===m2[4]){patch.start2--;patch.length2=1}else if("0"==m2[4])patch.length2=0;else{patch.start2--;patch.length2=parseInt(m2[4],10)}textPointer++;for(;textPointer<text2.length;){var sign=text2[textPointer].charAt(0);try{var line=decodeURI(text2[textPointer].substring(1))}catch(ex){throw new Error("Illegal escape in patch_fromText: "+line)}if("-"==sign)patch.diffs.push(new diff_match_patch4.Diff(-1,line));else if("+"==sign)patch.diffs.push(new diff_match_patch4.Diff(1,line));else if(" "==sign)patch.diffs.push(new diff_match_patch4.Diff(0,line));else if("@"==sign)break;else if(""===sign);else throw new Error('Invalid patch mode "'+sign+'" in: '+line);textPointer++}}return patches};diff_match_patch4.patch_obj=function(){this.diffs=[];this.start1=null;this.start2=null;this.length1=0;this.length2=0};diff_match_patch4.patch_obj.prototype.toString=function(){var coords1,coords2;if(0===this.length1)coords1=this.start1+",0";else if(1==this.length1)coords1=this.start1+1;else coords1=this.start1+1+","+this.length1;if(0===this.length2)coords2=this.start2+",0";else if(1==this.length2)coords2=this.start2+1;else coords2=this.start2+1+","+this.length2;for(var op,text2=["@@ -"+coords1+" +"+coords2+" @@\n"],x2=0;x2<this.diffs.length;x2++){switch(this.diffs[x2][0]){case 1:op="+";break;case-1:op="-";break;case 0:op=" ";break}text2[x2+1]=op+encodeURI(this.diffs[x2][1])+"\n"}return text2.join("").replace(/%20/g," ")};module2.exports=diff_match_patch4;module2.exports["diff_match_patch"]=diff_match_patch4;module2.exports["DIFF_DELETE"]=-1;module2.exports["DIFF_INSERT"]=1;module2.exports["DIFF_EQUAL"]=0}}),require_balanced_match=__commonJS({"node_modules/balanced-match/index.js"(exports,module2){"use strict";module2.exports=balanced;function balanced(a2,b3,str){if(a2 instanceof RegExp)a2=maybeMatch(a2,str);if(b3 instanceof RegExp)b3=maybeMatch(b3,str);var r2=range2(a2,b3,str);return r2&&{start:r2[0],end:r2[1],pre:str.slice(0,r2[0]),body:str.slice(r2[0]+a2.length,r2[1]),post:str.slice(r2[1]+b3.length)}}function maybeMatch(reg,str){var m2=str.match(reg);return m2?m2[0]:null}balanced.range=range2;function range2(a2,b3,str){var begs,beg,left,right,result,ai2=str.indexOf(a2),bi2=str.indexOf(b3,ai2+1),i2=ai2;if(ai2>=0&&bi2>0){if(a2===b3)return[ai2,bi2];begs=[];left=str.length;for(;i2>=0&&!result;){if(i2==ai2){begs.push(i2);ai2=str.indexOf(a2,i2+1)}else if(1==begs.length)result=[begs.pop(),bi2];else{if((beg=begs.pop())<left){left=beg;right=bi2}bi2=str.indexOf(b3,i2+1)}i2=ai2<bi2&&ai2>=0?ai2:bi2}if(begs.length)result=[left,right]}return result}}}),require_brace_expansion=__commonJS({"node_modules/brace-expansion/index.js"(exports,module2){var balanced=require_balanced_match();module2.exports=function expandTop(str){if(!str)return[];if("{}"===str.substr(0,2))str="\\{\\}"+str.substr(2);return expand2(function escapeBraces(str){return str.split("\\\\").join(escSlash).split("\\{").join(escOpen).split("\\}").join(escClose).split("\\,").join(escComma).split("\\.").join(escPeriod)}(str),true).map(unescapeBraces)};var escSlash="\0SLASH"+Math.random()+"\0",escOpen="\0OPEN"+Math.random()+"\0",escClose="\0CLOSE"+Math.random()+"\0",escComma="\0COMMA"+Math.random()+"\0",escPeriod="\0PERIOD"+Math.random()+"\0";function numeric(str){return parseInt(str,10)==str?parseInt(str,10):str.charCodeAt(0)}function unescapeBraces(str){return str.split(escSlash).join("\\").split(escOpen).join("{").split(escClose).join("}").split(escComma).join(",").split(escPeriod).join(".")}function parseCommaParts(str){if(!str)return[""];var parts=[],m2=balanced("{","}",str);if(!m2)return str.split(",");var pre=m2.pre,body=m2.body,post=m2.post,p2=pre.split(",");p2[p2.length-1]+="{"+body+"}";var postParts=parseCommaParts(post);if(post.length){p2[p2.length-1]+=postParts.shift();p2.push.apply(p2,postParts)}parts.push.apply(parts,p2);return parts}function embrace(str){return"{"+str+"}"}function isPadded(el){return/^-?0\d/.test(el)}function lte(i2,y2){return i2<=y2}function gte(i2,y2){return i2>=y2}function expand2(str,isTop){var expansions=[],m2=balanced("{","}",str);if(!m2)return[str];var pre=m2.pre,post=m2.post.length?expand2(m2.post,false):[""];if(/\$$/.test(m2.pre))for(var k2=0;k2<post.length;k2++){var expansion=pre+"{"+m2.body+"}"+post[k2];expansions.push(expansion)}else{var n3,N2,isNumericSequence=/^-?\d+\.\.-?\d+(?:\.\.-?\d+)?$/.test(m2.body),isAlphaSequence=/^[a-zA-Z]\.\.[a-zA-Z](?:\.\.-?\d+)?$/.test(m2.body),isSequence=isNumericSequence||isAlphaSequence,isOptions=m2.body.indexOf(",")>=0;if(!isSequence&&!isOptions)if(m2.post.match(/,.*\}/))return expand2(str=m2.pre+"{"+m2.body+escClose+m2.post);else return[str];if(isSequence)n3=m2.body.split(/\.\./);else if(1===(n3=parseCommaParts(m2.body)).length)if(1===(n3=expand2(n3[0],false).map(embrace)).length)return post.map((function(p2){return m2.pre+n3[0]+p2}));if(isSequence){var x2=numeric(n3[0]),y2=numeric(n3[1]),width=Math.max(n3[0].length,n3[1].length),incr=3==n3.length?Math.abs(numeric(n3[2])):1,test=lte;if(y2<x2){incr*=-1;test=gte}var pad2=n3.some(isPadded);N2=[];for(var i2=x2;test(i2,y2);i2+=incr){var c2;if(isAlphaSequence){if("\\"===(c2=String.fromCharCode(i2)))c2=""}else{c2=String(i2);if(pad2){var need=width-c2.length;if(need>0){var z2=new Array(need+1).join("0");if(i2<0)c2="-"+z2+c2.slice(1);else c2=z2+c2}}}N2.push(c2)}}else{N2=[];for(var j2=0;j2<n3.length;j2++)N2.push.apply(N2,expand2(n3[j2],false))}for(j2=0;j2<N2.length;j2++)for(k2=0;k2<post.length;k2++){expansion=pre+N2[j2]+post[k2];if(!isTop||isSequence||expansion)expansions.push(expansion)}}return expansions}}}),require_util=__commonJS({"node_modules/fast-xml-parser/src/util.js"(exports){"use strict";var nameStartChar=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",nameRegexp="["+nameStartChar+"]["+nameStartChar+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*",regexName=new RegExp("^"+nameRegexp+"$");exports.isExist=function(v2){return"undefined"!=typeof v2};exports.isEmptyObject=function(obj){return 0===Object.keys(obj).length};exports.merge=function(target,a2,arrayMode){if(a2){const keys2=Object.keys(a2),len=keys2.length;for(let i2=0;i2<len;i2++)if("strict"===arrayMode)target[keys2[i2]]=[a2[keys2[i2]]];else target[keys2[i2]]=a2[keys2[i2]]}};exports.getValue=function(v2){if(exports.isExist(v2))return v2;else return""};exports.isName=function(string){const match3=regexName.exec(string);return!(null===match3||"undefined"==typeof match3)};exports.getAllMatches=function(string,regex){const matches=[];let match3=regex.exec(string);for(;match3;){const allmatches=[];allmatches.startIndex=regex.lastIndex-match3[0].length;const len=match3.length;for(let index5=0;index5<len;index5++)allmatches.push(match3[index5]);matches.push(allmatches);match3=regex.exec(string)}return matches};exports.nameRegexp=nameRegexp}}),require_validator=__commonJS({"node_modules/fast-xml-parser/src/validator.js"(exports){"use strict";var util=require_util(),defaultOptions={allowBooleanAttributes:false,unpairedTags:[]};exports.validate=function(xmlData,options){options=Object.assign({},defaultOptions,options);const tags=[];let tagFound=false,reachedRoot=false;if("\ufeff"===xmlData[0])xmlData=xmlData.substr(1);for(let i2=0;i2<xmlData.length;i2++)if("<"===xmlData[i2]&&"?"===xmlData[i2+1]){i2+=2;i2=readPI(xmlData,i2);if(i2.err)return i2}else if("<"===xmlData[i2]){let tagStartPos=i2;i2++;if("!"===xmlData[i2]){i2=readCommentAndCDATA(xmlData,i2);continue}else{let closingTag=false;if("/"===xmlData[i2]){closingTag=true;i2++}let tagName="";for(;i2<xmlData.length&&">"!==xmlData[i2]&&" "!==xmlData[i2]&&"\t"!==xmlData[i2]&&"\n"!==xmlData[i2]&&"\r"!==xmlData[i2];i2++)tagName+=xmlData[i2];tagName=tagName.trim();if("/"===tagName[tagName.length-1]){tagName=tagName.substring(0,tagName.length-1);i2--}if(!(tagname=tagName,util.isName(tagname))){let msg;if(0===tagName.trim().length)msg="Invalid space after '<'.";else msg="Tag '"+tagName+"' is an invalid name.";return getErrorObject("InvalidTag",msg,getLineNumberForPosition(xmlData,i2))}const result=readAttributeStr(xmlData,i2);if(false===result)return getErrorObject("InvalidAttr","Attributes for '"+tagName+"' have open quote.",getLineNumberForPosition(xmlData,i2));let attrStr=result.value;i2=result.index;if("/"===attrStr[attrStr.length-1]){const attrStrStart=i2-attrStr.length;attrStr=attrStr.substring(0,attrStr.length-1);const isValid=validateAttributeString(attrStr,options);if(true===isValid)tagFound=true;else return getErrorObject(isValid.err.code,isValid.err.msg,getLineNumberForPosition(xmlData,attrStrStart+isValid.err.line))}else if(closingTag)if(!result.tagClosed)return getErrorObject("InvalidTag","Closing tag '"+tagName+"' doesn't have proper closing.",getLineNumberForPosition(xmlData,i2));else if(attrStr.trim().length>0)return getErrorObject("InvalidTag","Closing tag '"+tagName+"' can't have attributes or invalid starting.",getLineNumberForPosition(xmlData,tagStartPos));else if(0===tags.length)return getErrorObject("InvalidTag","Closing tag '"+tagName+"' has not been opened.",getLineNumberForPosition(xmlData,tagStartPos));else{const otg=tags.pop();if(tagName!==otg.tagName){let openPos=getLineNumberForPosition(xmlData,otg.tagStartPos);return getErrorObject("InvalidTag","Expected closing tag '"+otg.tagName+"' (opened in line "+openPos.line+", col "+openPos.col+") instead of closing tag '"+tagName+"'.",getLineNumberForPosition(xmlData,tagStartPos))}if(0==tags.length)reachedRoot=true}else{const isValid=validateAttributeString(attrStr,options);if(true!==isValid)return getErrorObject(isValid.err.code,isValid.err.msg,getLineNumberForPosition(xmlData,i2-attrStr.length+isValid.err.line));if(true===reachedRoot)return getErrorObject("InvalidXml","Multiple possible root nodes found.",getLineNumberForPosition(xmlData,i2));else if(-1!==options.unpairedTags.indexOf(tagName));else tags.push({tagName,tagStartPos});tagFound=true}for(i2++;i2<xmlData.length;i2++)if("<"===xmlData[i2])if("!"===xmlData[i2+1]){i2++;i2=readCommentAndCDATA(xmlData,i2);continue}else if("?"===xmlData[i2+1]){i2=readPI(xmlData,++i2);if(i2.err)return i2}else break;else if("&"===xmlData[i2]){const afterAmp=validateAmpersand(xmlData,i2);if(-1==afterAmp)return getErrorObject("InvalidChar","char '&' is not expected.",getLineNumberForPosition(xmlData,i2));i2=afterAmp}else if(true===reachedRoot&&!isWhiteSpace(xmlData[i2]))return getErrorObject("InvalidXml","Extra text at the end",getLineNumberForPosition(xmlData,i2));if("<"===xmlData[i2])i2--}}else{if(isWhiteSpace(xmlData[i2]))continue;return getErrorObject("InvalidChar","char '"+xmlData[i2]+"' is not expected.",getLineNumberForPosition(xmlData,i2))}var tagname;if(!tagFound)return getErrorObject("InvalidXml","Start tag expected.",1);else if(1==tags.length)return getErrorObject("InvalidTag","Unclosed tag '"+tags[0].tagName+"'.",getLineNumberForPosition(xmlData,tags[0].tagStartPos));else if(tags.length>0)return getErrorObject("InvalidXml","Invalid '"+JSON.stringify(tags.map((t4=>t4.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1});return true};function isWhiteSpace(char){return" "===char||"\t"===char||"\n"===char||"\r"===char}function readPI(xmlData,i2){const start=i2;for(;i2<xmlData.length;i2++)if("?"==xmlData[i2]||" "==xmlData[i2]){const tagname=xmlData.substr(start,i2-start);if(i2>5&&"xml"===tagname)return getErrorObject("InvalidXml","XML declaration allowed only at the start of the document.",getLineNumberForPosition(xmlData,i2));else if("?"==xmlData[i2]&&">"==xmlData[i2+1]){i2++;break}else continue}return i2}function readCommentAndCDATA(xmlData,i2){if(xmlData.length>i2+5&&"-"===xmlData[i2+1]&&"-"===xmlData[i2+2]){for(i2+=3;i2<xmlData.length;i2++)if("-"===xmlData[i2]&&"-"===xmlData[i2+1]&&">"===xmlData[i2+2]){i2+=2;break}}else if(xmlData.length>i2+8&&"D"===xmlData[i2+1]&&"O"===xmlData[i2+2]&&"C"===xmlData[i2+3]&&"T"===xmlData[i2+4]&&"Y"===xmlData[i2+5]&&"P"===xmlData[i2+6]&&"E"===xmlData[i2+7]){let angleBracketsCount=1;for(i2+=8;i2<xmlData.length;i2++)if("<"===xmlData[i2])angleBracketsCount++;else if(">"===xmlData[i2]){angleBracketsCount--;if(0===angleBracketsCount)break}}else if(xmlData.length>i2+9&&"["===xmlData[i2+1]&&"C"===xmlData[i2+2]&&"D"===xmlData[i2+3]&&"A"===xmlData[i2+4]&&"T"===xmlData[i2+5]&&"A"===xmlData[i2+6]&&"["===xmlData[i2+7])for(i2+=8;i2<xmlData.length;i2++)if("]"===xmlData[i2]&&"]"===xmlData[i2+1]&&">"===xmlData[i2+2]){i2+=2;break}return i2}function readAttributeStr(xmlData,i2){let attrStr="",startChar="",tagClosed=false;for(;i2<xmlData.length;i2++){if('"'===xmlData[i2]||"'"===xmlData[i2])if(""===startChar)startChar=xmlData[i2];else if(startChar!==xmlData[i2]);else startChar="";else if(">"===xmlData[i2])if(""===startChar){tagClosed=true;break}attrStr+=xmlData[i2]}if(""!==startChar)return false;else return{value:attrStr,index:i2,tagClosed}}var validAttrStrRegxp=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function validateAttributeString(attrStr,options){const matches=util.getAllMatches(attrStr,validAttrStrRegxp),attrNames={};for(let i2=0;i2<matches.length;i2++){if(0===matches[i2][1].length)return getErrorObject("InvalidAttr","Attribute '"+matches[i2][2]+"' has no space in starting.",getPositionFromMatch(matches[i2]));else if(void 0!==matches[i2][3]&&void 0===matches[i2][4])return getErrorObject("InvalidAttr","Attribute '"+matches[i2][2]+"' is without value.",getPositionFromMatch(matches[i2]));else if(void 0===matches[i2][3]&&!options.allowBooleanAttributes)return getErrorObject("InvalidAttr","boolean attribute '"+matches[i2][2]+"' is not allowed.",getPositionFromMatch(matches[i2]));const attrName=matches[i2][2];if(!validateAttrName(attrName))return getErrorObject("InvalidAttr","Attribute '"+attrName+"' is an invalid name.",getPositionFromMatch(matches[i2]));if(!attrNames.hasOwnProperty(attrName))attrNames[attrName]=1;else return getErrorObject("InvalidAttr","Attribute '"+attrName+"' is repeated.",getPositionFromMatch(matches[i2]))}return true}function validateAmpersand(xmlData,i2){if(";"===xmlData[++i2])return-1;if("#"===xmlData[i2])return function validateNumberAmpersand(xmlData,i2){let re=/\d/;if("x"===xmlData[i2]){i2++;re=/[\da-fA-F]/}for(;i2<xmlData.length;i2++){if(";"===xmlData[i2])return i2;if(!xmlData[i2].match(re))break}return-1}(xmlData,++i2);let count=0;for(;i2<xmlData.length;i2++,count++)if(!(xmlData[i2].match(/\w/)&&count<20)){if(";"===xmlData[i2])break;return-1}return i2}function getErrorObject(code,message,lineNumber){return{err:{code,msg:message,line:lineNumber.line||lineNumber,col:lineNumber.col}}}function validateAttrName(attrName){return util.isName(attrName)}function getLineNumberForPosition(xmlData,index5){const lines=xmlData.substring(0,index5).split(/\r?\n/);return{line:lines.length,col:lines[lines.length-1].length+1}}function getPositionFromMatch(match3){return match3.startIndex+match3[1].length}}}),require_OptionsBuilder=__commonJS({"node_modules/fast-xml-parser/src/xmlparser/OptionsBuilder.js"(exports){var defaultOptions={preserveOrder:false,attributeNamePrefix:"@_",attributesGroupName:false,textNodeName:"#text",ignoreAttributes:true,removeNSPrefix:false,allowBooleanAttributes:false,parseTagValue:true,parseAttributeValue:false,trimValues:true,cdataPropName:false,numberParseOptions:{hex:true,leadingZeros:true,eNotation:true},tagValueProcessor:function(tagName,val2){return val2},attributeValueProcessor:function(attrName,val2){return val2},stopNodes:[],alwaysCreateTextNode:false,isArray:()=>false,commentPropName:false,unpairedTags:[],processEntities:true,htmlEntities:false,ignoreDeclaration:false,ignorePiTags:false,transformTagName:false,transformAttributeName:false,updateTag:function(tagName,jPath,attrs){return tagName}};exports.buildOptions=function(options){return Object.assign({},defaultOptions,options)};exports.defaultOptions=defaultOptions}}),require_xmlNode=__commonJS({"node_modules/fast-xml-parser/src/xmlparser/xmlNode.js"(exports,module2){"use strict";module2.exports=class{constructor(tagname){this.tagname=tagname;this.child=[];this[":@"]={}}add(key2,val2){if("__proto__"===key2)key2="#__proto__";this.child.push({[key2]:val2})}addChild(node){if("__proto__"===node.tagname)node.tagname="#__proto__";if(node[":@"]&&Object.keys(node[":@"]).length>0)this.child.push({[node.tagname]:node.child,[":@"]:node[":@"]});else this.child.push({[node.tagname]:node.child})}}}}),require_DocTypeReader=__commonJS({"node_modules/fast-xml-parser/src/xmlparser/DocTypeReader.js"(exports,module2){var util=require_util();function readEntityExp(xmlData,i2){let entityName2="";for(;i2<xmlData.length&&"'"!==xmlData[i2]&&'"'!==xmlData[i2];i2++)entityName2+=xmlData[i2];entityName2=entityName2.trim();if(-1!==entityName2.indexOf(" "))throw new Error("External entites are not supported");const startChar=xmlData[i2++];let val2="";for(;i2<xmlData.length&&xmlData[i2]!==startChar;i2++)val2+=xmlData[i2];return[entityName2,val2,i2]}function isComment(xmlData,i2){if("!"===xmlData[i2+1]&&"-"===xmlData[i2+2]&&"-"===xmlData[i2+3])return true;else return false}function isEntity(xmlData,i2){if("!"===xmlData[i2+1]&&"E"===xmlData[i2+2]&&"N"===xmlData[i2+3]&&"T"===xmlData[i2+4]&&"I"===xmlData[i2+5]&&"T"===xmlData[i2+6]&&"Y"===xmlData[i2+7])return true;else return false}function isElement(xmlData,i2){if("!"===xmlData[i2+1]&&"E"===xmlData[i2+2]&&"L"===xmlData[i2+3]&&"E"===xmlData[i2+4]&&"M"===xmlData[i2+5]&&"E"===xmlData[i2+6]&&"N"===xmlData[i2+7]&&"T"===xmlData[i2+8])return true;else return false}function isAttlist(xmlData,i2){if("!"===xmlData[i2+1]&&"A"===xmlData[i2+2]&&"T"===xmlData[i2+3]&&"T"===xmlData[i2+4]&&"L"===xmlData[i2+5]&&"I"===xmlData[i2+6]&&"S"===xmlData[i2+7]&&"T"===xmlData[i2+8])return true;else return false}function isNotation(xmlData,i2){if("!"===xmlData[i2+1]&&"N"===xmlData[i2+2]&&"O"===xmlData[i2+3]&&"T"===xmlData[i2+4]&&"A"===xmlData[i2+5]&&"T"===xmlData[i2+6]&&"I"===xmlData[i2+7]&&"O"===xmlData[i2+8]&&"N"===xmlData[i2+9])return true;else return false}function validateEntityName(name){if(util.isName(name))return name;else throw new Error(`Invalid entity name ${name}`)}module2.exports=function readDocType(xmlData,i2){const entities={};if("O"===xmlData[i2+3]&&"C"===xmlData[i2+4]&&"T"===xmlData[i2+5]&&"Y"===xmlData[i2+6]&&"P"===xmlData[i2+7]&&"E"===xmlData[i2+8]){i2+=9;let angleBracketsCount=1,hasBody=false,comment2=false,exp="";for(;i2<xmlData.length;i2++)if("<"===xmlData[i2]&&!comment2){if(hasBody&&isEntity(xmlData,i2)){i2+=7;[entityName,val,i2]=readEntityExp(xmlData,i2+1);if(-1===val.indexOf("&"))entities[validateEntityName(entityName)]={regx:RegExp(`&${entityName};`,"g"),val}}else if(hasBody&&isElement(xmlData,i2))i2+=8;else if(hasBody&&isAttlist(xmlData,i2))i2+=8;else if(hasBody&&isNotation(xmlData,i2))i2+=9;else if(isComment)comment2=true;else throw new Error("Invalid DOCTYPE");angleBracketsCount++;exp=""}else if(">"===xmlData[i2]){if(comment2){if("-"===xmlData[i2-1]&&"-"===xmlData[i2-2]){comment2=false;angleBracketsCount--}}else angleBracketsCount--;if(0===angleBracketsCount)break}else if("["===xmlData[i2])hasBody=true;else exp+=xmlData[i2];if(0!==angleBracketsCount)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities,i:i2}}}}),require_strnum=__commonJS({"node_modules/strnum/strnum.js"(exports,module2){var hexRegex=/^[-+]?0x[a-fA-F0-9]+$/,numRegex=/^([\-\+])?(0*)(\.[0-9]+([eE]\-?[0-9]+)?|[0-9]+(\.[0-9]+([eE]\-?[0-9]+)?)?)$/;if(!Number.parseInt&&window.parseInt)Number.parseInt=window.parseInt;if(!Number.parseFloat&&window.parseFloat)Number.parseFloat=window.parseFloat;var consider={hex:true,leadingZeros:true,decimalPoint:".",eNotation:true};module2.exports=function toNumber(str,options={}){options=Object.assign({},consider,options);if(!str||"string"!=typeof str)return str;let trimmedStr=str.trim();if(void 0!==options.skipLike&&options.skipLike.test(trimmedStr))return str;else if(options.hex&&hexRegex.test(trimmedStr))return Number.parseInt(trimmedStr,16);else{const match3=numRegex.exec(trimmedStr);if(match3){const sign=match3[1],leadingZeros=match3[2];let numTrimmedByZeros=function trimZeros(numStr){if(numStr&&-1!==numStr.indexOf(".")){if("."===(numStr=numStr.replace(/0+$/,"")))numStr="0";else if("."===numStr[0])numStr="0"+numStr;else if("."===numStr[numStr.length-1])numStr=numStr.substr(0,numStr.length-1);return numStr}return numStr}(match3[3]);const eNotation=match3[4]||match3[6];if(!options.leadingZeros&&leadingZeros.length>0&&sign&&"."!==trimmedStr[2])return str;else if(!options.leadingZeros&&leadingZeros.length>0&&!sign&&"."!==trimmedStr[1])return str;else{const num=Number(trimmedStr),numStr=""+num;if(-1!==numStr.search(/[eE]/))if(options.eNotation)return num;else return str;else if(eNotation)if(options.eNotation)return num;else return str;else if(-1!==trimmedStr.indexOf("."))if("0"===numStr&&""===numTrimmedByZeros)return num;else if(numStr===numTrimmedByZeros)return num;else if(sign&&numStr==="-"+numTrimmedByZeros)return num;else return str;if(leadingZeros)if(numTrimmedByZeros===numStr)return num;else if(sign+numTrimmedByZeros===numStr)return num;else return str;if(trimmedStr===numStr)return num;else if(trimmedStr===sign+numStr)return num;return str}}else return str}}}}),require_OrderedObjParser=__commonJS({"node_modules/fast-xml-parser/src/xmlparser/OrderedObjParser.js"(exports,module2){"use strict";var util=require_util(),xmlNode=require_xmlNode(),readDocType=require_DocTypeReader(),toNumber=require_strnum();function addExternalEntities(externalEntities){const entKeys=Object.keys(externalEntities);for(let i2=0;i2<entKeys.length;i2++){const ent=entKeys[i2];this.lastEntities[ent]={regex:new RegExp("&"+ent+";","g"),val:externalEntities[ent]}}}function parseTextData(val2,tagName,jPath,dontTrim,hasAttributes,isLeafNode,escapeEntities){if(void 0!==val2){if(this.options.trimValues&&!dontTrim)val2=val2.trim();if(val2.length>0){if(!escapeEntities)val2=this.replaceEntitiesValue(val2);const newval=this.options.tagValueProcessor(tagName,val2,jPath,hasAttributes,isLeafNode);if(null==newval)return val2;else if(typeof newval!=typeof val2||newval!==val2)return newval;else if(this.options.trimValues)return parseValue(val2,this.options.parseTagValue,this.options.numberParseOptions);else if(val2.trim()===val2)return parseValue(val2,this.options.parseTagValue,this.options.numberParseOptions);else return val2}}}function resolveNameSpace(tagname){if(this.options.removeNSPrefix){const tags=tagname.split(":"),prefix="/"===tagname.charAt(0)?"/":"";if("xmlns"===tags[0])return"";if(2===tags.length)tagname=prefix+tags[1]}return tagname}var attrsRegx=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function buildAttributesMap(attrStr,jPath,tagName){if(!this.options.ignoreAttributes&&"string"==typeof attrStr){const matches=util.getAllMatches(attrStr,attrsRegx),len=matches.length,attrs={};for(let i2=0;i2<len;i2++){const attrName=this.resolveNameSpace(matches[i2][1]);let oldVal=matches[i2][4],aName=this.options.attributeNamePrefix+attrName;if(attrName.length){if(this.options.transformAttributeName)aName=this.options.transformAttributeName(aName);if("__proto__"===aName)aName="#__proto__";if(void 0!==oldVal){if(this.options.trimValues)oldVal=oldVal.trim();oldVal=this.replaceEntitiesValue(oldVal);const newVal=this.options.attributeValueProcessor(attrName,oldVal,jPath);if(null==newVal)attrs[aName]=oldVal;else if(typeof newVal!=typeof oldVal||newVal!==oldVal)attrs[aName]=newVal;else attrs[aName]=parseValue(oldVal,this.options.parseAttributeValue,this.options.numberParseOptions)}else if(this.options.allowBooleanAttributes)attrs[aName]=true}}if(!Object.keys(attrs).length)return;if(this.options.attributesGroupName){const attrCollection={};attrCollection[this.options.attributesGroupName]=attrs;return attrCollection}return attrs}}var parseXml=function(xmlData){xmlData=xmlData.replace(/\r\n?/g,"\n");const xmlObj=new xmlNode("!xml");let currentNode=xmlObj,textData="",jPath="";for(let i2=0;i2<xmlData.length;i2++)if("<"===xmlData[i2])if("/"===xmlData[i2+1]){const closeIndex=findClosingIndex(xmlData,">",i2,"Closing Tag is not closed.");let tagName=xmlData.substring(i2+2,closeIndex).trim();if(this.options.removeNSPrefix){const colonIndex=tagName.indexOf(":");if(-1!==colonIndex)tagName=tagName.substr(colonIndex+1)}if(this.options.transformTagName)tagName=this.options.transformTagName(tagName);if(currentNode)textData=this.saveTextToParentTag(textData,currentNode,jPath);const lastTagName=jPath.substring(jPath.lastIndexOf(".")+1);if(tagName&&-1!==this.options.unpairedTags.indexOf(tagName))throw new Error(`Unpaired tag can not be used as closing tag: </${tagName}>`);let propIndex=0;if(lastTagName&&-1!==this.options.unpairedTags.indexOf(lastTagName)){propIndex=jPath.lastIndexOf(".",jPath.lastIndexOf(".")-1);this.tagsNodeStack.pop()}else propIndex=jPath.lastIndexOf(".");jPath=jPath.substring(0,propIndex);currentNode=this.tagsNodeStack.pop();textData="";i2=closeIndex}else if("?"===xmlData[i2+1]){let tagData=readTagExp(xmlData,i2,false,"?>");if(!tagData)throw new Error("Pi Tag is not closed.");textData=this.saveTextToParentTag(textData,currentNode,jPath);if(this.options.ignoreDeclaration&&"?xml"===tagData.tagName||this.options.ignorePiTags);else{const childNode=new xmlNode(tagData.tagName);childNode.add(this.options.textNodeName,"");if(tagData.tagName!==tagData.tagExp&&tagData.attrExpPresent)childNode[":@"]=this.buildAttributesMap(tagData.tagExp,jPath,tagData.tagName);this.addChild(currentNode,childNode,jPath)}i2=tagData.closeIndex+1}else if("!--"===xmlData.substr(i2+1,3)){const endIndex=findClosingIndex(xmlData,"--\x3e",i2+4,"Comment is not closed.");if(this.options.commentPropName){const comment2=xmlData.substring(i2+4,endIndex-2);textData=this.saveTextToParentTag(textData,currentNode,jPath);currentNode.add(this.options.commentPropName,[{[this.options.textNodeName]:comment2}])}i2=endIndex}else if("!D"===xmlData.substr(i2+1,2)){const result=readDocType(xmlData,i2);this.docTypeEntities=result.entities;i2=result.i}else if("!["===xmlData.substr(i2+1,2)){const closeIndex=findClosingIndex(xmlData,"]]>",i2,"CDATA is not closed.")-2,tagExp=xmlData.substring(i2+9,closeIndex);textData=this.saveTextToParentTag(textData,currentNode,jPath);let val2=this.parseTextData(tagExp,currentNode.tagname,jPath,true,false,true,true);if(null==val2)val2="";if(this.options.cdataPropName)currentNode.add(this.options.cdataPropName,[{[this.options.textNodeName]:tagExp}]);else currentNode.add(this.options.textNodeName,val2);i2=closeIndex+2}else{let result=readTagExp(xmlData,i2,this.options.removeNSPrefix),tagName=result.tagName;const rawTagName=result.rawTagName;let tagExp=result.tagExp,attrExpPresent=result.attrExpPresent,closeIndex=result.closeIndex;if(this.options.transformTagName)tagName=this.options.transformTagName(tagName);if(currentNode&&textData)if("!xml"!==currentNode.tagname)textData=this.saveTextToParentTag(textData,currentNode,jPath,false);const lastTag=currentNode;if(lastTag&&-1!==this.options.unpairedTags.indexOf(lastTag.tagname)){currentNode=this.tagsNodeStack.pop();jPath=jPath.substring(0,jPath.lastIndexOf("."))}if(tagName!==xmlObj.tagname)jPath+=jPath?"."+tagName:tagName;if(this.isItStopNode(this.options.stopNodes,jPath,tagName)){let tagContent="";if(tagExp.length>0&&tagExp.lastIndexOf("/")===tagExp.length-1){if("/"===tagName[tagName.length-1]){tagName=tagName.substr(0,tagName.length-1);jPath=jPath.substr(0,jPath.length-1);tagExp=tagName}else tagExp=tagExp.substr(0,tagExp.length-1);i2=result.closeIndex}else if(-1!==this.options.unpairedTags.indexOf(tagName))i2=result.closeIndex;else{const result2=this.readStopNodeData(xmlData,rawTagName,closeIndex+1);if(!result2)throw new Error(`Unexpected end of ${rawTagName}`);i2=result2.i;tagContent=result2.tagContent}const childNode=new xmlNode(tagName);if(tagName!==tagExp&&attrExpPresent)childNode[":@"]=this.buildAttributesMap(tagExp,jPath,tagName);if(tagContent)tagContent=this.parseTextData(tagContent,tagName,jPath,true,attrExpPresent,true,true);jPath=jPath.substr(0,jPath.lastIndexOf("."));childNode.add(this.options.textNodeName,tagContent);this.addChild(currentNode,childNode,jPath)}else{if(tagExp.length>0&&tagExp.lastIndexOf("/")===tagExp.length-1){if("/"===tagName[tagName.length-1]){tagName=tagName.substr(0,tagName.length-1);jPath=jPath.substr(0,jPath.length-1);tagExp=tagName}else tagExp=tagExp.substr(0,tagExp.length-1);if(this.options.transformTagName)tagName=this.options.transformTagName(tagName);const childNode=new xmlNode(tagName);if(tagName!==tagExp&&attrExpPresent)childNode[":@"]=this.buildAttributesMap(tagExp,jPath,tagName);this.addChild(currentNode,childNode,jPath);jPath=jPath.substr(0,jPath.lastIndexOf("."))}else{const childNode=new xmlNode(tagName);this.tagsNodeStack.push(currentNode);if(tagName!==tagExp&&attrExpPresent)childNode[":@"]=this.buildAttributesMap(tagExp,jPath,tagName);this.addChild(currentNode,childNode,jPath);currentNode=childNode}textData="";i2=closeIndex}}else textData+=xmlData[i2];return xmlObj.child};function addChild(currentNode,childNode,jPath){const result=this.options.updateTag(childNode.tagname,jPath,childNode[":@"]);if(false===result);else if("string"==typeof result){childNode.tagname=result;currentNode.addChild(childNode)}else currentNode.addChild(childNode)}var replaceEntitiesValue=function(val2){if(this.options.processEntities){for(let entityName2 in this.docTypeEntities){const entity=this.docTypeEntities[entityName2];val2=val2.replace(entity.regx,entity.val)}for(let entityName2 in this.lastEntities){const entity=this.lastEntities[entityName2];val2=val2.replace(entity.regex,entity.val)}if(this.options.htmlEntities)for(let entityName2 in this.htmlEntities){const entity=this.htmlEntities[entityName2];val2=val2.replace(entity.regex,entity.val)}val2=val2.replace(this.ampEntity.regex,this.ampEntity.val)}return val2};function saveTextToParentTag(textData,currentNode,jPath,isLeafNode){if(textData){if(void 0===isLeafNode)isLeafNode=0===Object.keys(currentNode.child).length;if(void 0!==(textData=this.parseTextData(textData,currentNode.tagname,jPath,false,currentNode[":@"]?0!==Object.keys(currentNode[":@"]).length:false,isLeafNode))&&""!==textData)currentNode.add(this.options.textNodeName,textData);textData=""}return textData}function isItStopNode(stopNodes,jPath,currentTagName){const allNodesExp="*."+currentTagName;for(const stopNodePath in stopNodes){const stopNodeExp=stopNodes[stopNodePath];if(allNodesExp===stopNodeExp||jPath===stopNodeExp)return true}return false}function findClosingIndex(xmlData,str,i2,errMsg){const closingIndex=xmlData.indexOf(str,i2);if(-1===closingIndex)throw new Error(errMsg);else return closingIndex+str.length-1}function readTagExp(xmlData,i2,removeNSPrefix,closingChar=">"){const result=function tagExpWithClosingIndex(xmlData,i2,closingChar=">"){let attrBoundary,tagExp="";for(let index5=i2;index5<xmlData.length;index5++){let ch4=xmlData[index5];if(attrBoundary){if(ch4===attrBoundary)attrBoundary=""}else if('"'===ch4||"'"===ch4)attrBoundary=ch4;else if(ch4===closingChar[0])if(closingChar[1]){if(xmlData[index5+1]===closingChar[1])return{data:tagExp,index:index5}}else return{data:tagExp,index:index5};else if("\t"===ch4)ch4=" ";tagExp+=ch4}}(xmlData,i2+1,closingChar);if(!result)return;let tagExp=result.data;const closeIndex=result.index,separatorIndex=tagExp.search(/\s/);let tagName=tagExp,attrExpPresent=true;if(-1!==separatorIndex){tagName=tagExp.substring(0,separatorIndex);tagExp=tagExp.substring(separatorIndex+1).trimStart()}const rawTagName=tagName;if(removeNSPrefix){const colonIndex=tagName.indexOf(":");if(-1!==colonIndex){tagName=tagName.substr(colonIndex+1);attrExpPresent=tagName!==result.data.substr(colonIndex+1)}}return{tagName,tagExp,closeIndex,attrExpPresent,rawTagName}}function readStopNodeData(xmlData,tagName,i2){const startIndex=i2;let openTagCount=1;for(;i2<xmlData.length;i2++)if("<"===xmlData[i2])if("/"===xmlData[i2+1]){const closeIndex=findClosingIndex(xmlData,">",i2,`${tagName} is not closed`);if(xmlData.substring(i2+2,closeIndex).trim()===tagName){openTagCount--;if(0===openTagCount)return{tagContent:xmlData.substring(startIndex,i2),i:closeIndex}}i2=closeIndex}else if("?"===xmlData[i2+1])i2=findClosingIndex(xmlData,"?>",i2+1,"StopNode is not closed.");else if("!--"===xmlData.substr(i2+1,3))i2=findClosingIndex(xmlData,"--\x3e",i2+3,"StopNode is not closed.");else if("!["===xmlData.substr(i2+1,2))i2=findClosingIndex(xmlData,"]]>",i2,"StopNode is not closed.")-2;else{const tagData=readTagExp(xmlData,i2,">");if(tagData){if((tagData&&tagData.tagName)===tagName&&"/"!==tagData.tagExp[tagData.tagExp.length-1])openTagCount++;i2=tagData.closeIndex}}}function parseValue(val2,shouldParse,options){if(shouldParse&&"string"==typeof val2){const newval=val2.trim();if("true"===newval)return true;else if("false"===newval)return false;else return toNumber(val2,options)}else if(util.isExist(val2))return val2;else return""}module2.exports=class{constructor(options){this.options=options;this.currentNode=null;this.tagsNodeStack=[];this.docTypeEntities={};this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}};this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"};this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:""},pound:{regex:/&(pound|#163);/g,val:""},yen:{regex:/&(yen|#165);/g,val:""},euro:{regex:/&(euro|#8364);/g,val:""},copyright:{regex:/&(copy|#169);/g,val:""},reg:{regex:/&(reg|#174);/g,val:""},inr:{regex:/&(inr|#8377);/g,val:""},num_dec:{regex:/&#([0-9]{1,7});/g,val:(_,str)=>String.fromCharCode(Number.parseInt(str,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(_,str)=>String.fromCharCode(Number.parseInt(str,16))}};this.addExternalEntities=addExternalEntities;this.parseXml=parseXml;this.parseTextData=parseTextData;this.resolveNameSpace=resolveNameSpace;this.buildAttributesMap=buildAttributesMap;this.isItStopNode=isItStopNode;this.replaceEntitiesValue=replaceEntitiesValue;this.readStopNodeData=readStopNodeData;this.saveTextToParentTag=saveTextToParentTag;this.addChild=addChild}}}}),require_node2json=__commonJS({"node_modules/fast-xml-parser/src/xmlparser/node2json.js"(exports){"use strict";function compress(arr,options,jPath){let text2;const compressedObj={};for(let i2=0;i2<arr.length;i2++){const tagObj=arr[i2],property=propName(tagObj);let newJpath="";if(void 0===jPath)newJpath=property;else newJpath=jPath+"."+property;if(property===options.textNodeName)if(void 0===text2)text2=tagObj[property];else text2+=""+tagObj[property];else if(void 0===property)continue;else if(tagObj[property]){let val2=compress(tagObj[property],options,newJpath);const isLeaf=isLeafTag(val2,options);if(tagObj[":@"])assignAttributes(val2,tagObj[":@"],newJpath,options);else if(1===Object.keys(val2).length&&void 0!==val2[options.textNodeName]&&!options.alwaysCreateTextNode)val2=val2[options.textNodeName];else if(0===Object.keys(val2).length)if(options.alwaysCreateTextNode)val2[options.textNodeName]="";else val2="";if(void 0!==compressedObj[property]&&compressedObj.hasOwnProperty(property)){if(!Array.isArray(compressedObj[property]))compressedObj[property]=[compressedObj[property]];compressedObj[property].push(val2)}else if(options.isArray(property,newJpath,isLeaf))compressedObj[property]=[val2];else compressedObj[property]=val2}}if("string"==typeof text2){if(text2.length>0)compressedObj[options.textNodeName]=text2}else if(void 0!==text2)compressedObj[options.textNodeName]=text2;return compressedObj}function propName(obj){const keys2=Object.keys(obj);for(let i2=0;i2<keys2.length;i2++){const key2=keys2[i2];if(":@"!==key2)return key2}}function assignAttributes(obj,attrMap,jpath,options){if(attrMap){const keys2=Object.keys(attrMap),len=keys2.length;for(let i2=0;i2<len;i2++){const atrrName=keys2[i2];if(options.isArray(atrrName,jpath+"."+atrrName,true,true))obj[atrrName]=[attrMap[atrrName]];else obj[atrrName]=attrMap[atrrName]}}}function isLeafTag(obj,options){const{textNodeName}=options,propCount=Object.keys(obj).length;if(0===propCount)return true;if(1===propCount&&(obj[textNodeName]||"boolean"==typeof obj[textNodeName]||0===obj[textNodeName]))return true;else return false}exports.prettify=function prettify(node,options){return compress(node,options)}}}),require_XMLParser=__commonJS({"node_modules/fast-xml-parser/src/xmlparser/XMLParser.js"(exports,module2){var{buildOptions}=require_OptionsBuilder(),OrderedObjParser=require_OrderedObjParser(),{prettify}=require_node2json(),validator=require_validator();module2.exports=class{constructor(options){this.externalEntities={};this.options=buildOptions(options)}parse(xmlData,validationOption){if("string"==typeof xmlData);else if(xmlData.toString)xmlData=xmlData.toString();else throw new Error("XML data is accepted in String or Bytes[] form.");if(validationOption){if(true===validationOption)validationOption={};const result=validator.validate(xmlData,validationOption);if(true!==result)throw Error(`${result.err.msg}:${result.err.line}:${result.err.col}`)}const orderedObjParser=new OrderedObjParser(this.options);orderedObjParser.addExternalEntities(this.externalEntities);const orderedResult=orderedObjParser.parseXml(xmlData);if(this.options.preserveOrder||void 0===orderedResult)return orderedResult;else return prettify(orderedResult,this.options)}addEntity(key2,value){if(-1!==value.indexOf("&"))throw new Error("Entity value can't have '&'");else if(-1!==key2.indexOf("&")||-1!==key2.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");else if("&"===value)throw new Error("An entity with value '&' is not permitted");else this.externalEntities[key2]=value}}}}),require_orderedJs2Xml=__commonJS({"node_modules/fast-xml-parser/src/xmlbuilder/orderedJs2Xml.js"(exports,module2){function arrToStr(arr,options,jPath,indentation){let xmlStr="",isPreviousElementTag=false;for(let i2=0;i2<arr.length;i2++){const tagObj=arr[i2],tagName=propName(tagObj);if(void 0===tagName)continue;let newJPath="";if(0===jPath.length)newJPath=tagName;else newJPath=`${jPath}.${tagName}`;if(tagName===options.textNodeName){let tagText=tagObj[tagName];if(!isStopNode(newJPath,options)){tagText=options.tagValueProcessor(tagName,tagText);tagText=replaceEntitiesValue(tagText,options)}if(isPreviousElementTag)xmlStr+=indentation;xmlStr+=tagText;isPreviousElementTag=false;continue}else if(tagName===options.cdataPropName){if(isPreviousElementTag)xmlStr+=indentation;xmlStr+=`<![CDATA[${tagObj[tagName][0][options.textNodeName]}]]>`;isPreviousElementTag=false;continue}else if(tagName===options.commentPropName){xmlStr+=indentation+`\x3c!--${tagObj[tagName][0][options.textNodeName]}--\x3e`;isPreviousElementTag=true;continue}else if("?"===tagName[0]){const attStr2=attr_to_str(tagObj[":@"],options),tempInd="?xml"===tagName?"":indentation;let piTextNodeName=tagObj[tagName][0][options.textNodeName];piTextNodeName=0!==piTextNodeName.length?" "+piTextNodeName:"";xmlStr+=tempInd+`<${tagName}${piTextNodeName}${attStr2}?>`;isPreviousElementTag=true;continue}let newIdentation=indentation;if(""!==newIdentation)newIdentation+=options.indentBy;const tagStart=indentation+`<${tagName}${attr_to_str(tagObj[":@"],options)}`,tagValue=arrToStr(tagObj[tagName],options,newJPath,newIdentation);if(-1!==options.unpairedTags.indexOf(tagName))if(options.suppressUnpairedNode)xmlStr+=tagStart+">";else xmlStr+=tagStart+"/>";else if((!tagValue||0===tagValue.length)&&options.suppressEmptyNode)xmlStr+=tagStart+"/>";else if(tagValue&&tagValue.endsWith(">"))xmlStr+=tagStart+`>${tagValue}${indentation}</${tagName}>`;else{xmlStr+=tagStart+">";if(tagValue&&""!==indentation&&(tagValue.includes("/>")||tagValue.includes("</")))xmlStr+=indentation+options.indentBy+tagValue+indentation;else xmlStr+=tagValue;xmlStr+=`</${tagName}>`}isPreviousElementTag=true}return xmlStr}function propName(obj){const keys2=Object.keys(obj);for(let i2=0;i2<keys2.length;i2++){const key2=keys2[i2];if(obj.hasOwnProperty(key2))if(":@"!==key2)return key2}}function attr_to_str(attrMap,options){let attrStr="";if(attrMap&&!options.ignoreAttributes)for(let attr2 in attrMap){if(!attrMap.hasOwnProperty(attr2))continue;let attrVal=options.attributeValueProcessor(attr2,attrMap[attr2]);attrVal=replaceEntitiesValue(attrVal,options);if(true===attrVal&&options.suppressBooleanAttributes)attrStr+=` ${attr2.substr(options.attributeNamePrefix.length)}`;else attrStr+=` ${attr2.substr(options.attributeNamePrefix.length)}="${attrVal}"`}return attrStr}function isStopNode(jPath,options){let tagName=(jPath=jPath.substr(0,jPath.length-options.textNodeName.length-1)).substr(jPath.lastIndexOf(".")+1);for(let index5 in options.stopNodes)if(options.stopNodes[index5]===jPath||options.stopNodes[index5]==="*."+tagName)return true;return false}function replaceEntitiesValue(textValue,options){if(textValue&&textValue.length>0&&options.processEntities)for(let i2=0;i2<options.entities.length;i2++){const entity=options.entities[i2];textValue=textValue.replace(entity.regex,entity.val)}return textValue}module2.exports=function toXml(jArray,options){let indentation="";if(options.format&&options.indentBy.length>0)indentation="\n";return arrToStr(jArray,options,"",indentation)}}}),require_json2xml=__commonJS({"node_modules/fast-xml-parser/src/xmlbuilder/json2xml.js"(exports,module2){"use strict";var buildFromOrderedJs=require_orderedJs2Xml(),defaultOptions={attributeNamePrefix:"@_",attributesGroupName:false,textNodeName:"#text",ignoreAttributes:true,cdataPropName:false,format:false,indentBy:"  ",suppressEmptyNode:false,suppressUnpairedNode:true,suppressBooleanAttributes:true,tagValueProcessor:function(key2,a2){return a2},attributeValueProcessor:function(attrName,a2){return a2},preserveOrder:false,commentPropName:false,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:true,stopNodes:[],oneListGroup:false};function Builder(options){this.options=Object.assign({},defaultOptions,options);if(this.options.ignoreAttributes||this.options.attributesGroupName)this.isAttribute=function(){return false};else{this.attrPrefixLen=this.options.attributeNamePrefix.length;this.isAttribute=isAttribute}this.processTextOrObjNode=processTextOrObjNode;if(this.options.format){this.indentate=indentate;this.tagEndChar=">\n";this.newLine="\n"}else{this.indentate=function(){return""};this.tagEndChar=">";this.newLine=""}}Builder.prototype.build=function(jObj){if(this.options.preserveOrder)return buildFromOrderedJs(jObj,this.options);else{if(Array.isArray(jObj)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1)jObj={[this.options.arrayNodeName]:jObj};return this.j2x(jObj,0).val}};Builder.prototype.j2x=function(jObj,level){let attrStr="",val2="";for(let key2 in jObj)if(Object.prototype.hasOwnProperty.call(jObj,key2))if("undefined"==typeof jObj[key2]){if(this.isAttribute(key2))val2+=""}else if(null===jObj[key2])if(this.isAttribute(key2))val2+="";else if("?"===key2[0])val2+=this.indentate(level)+"<"+key2+"?"+this.tagEndChar;else val2+=this.indentate(level)+"<"+key2+"/"+this.tagEndChar;else if(jObj[key2]instanceof Date)val2+=this.buildTextValNode(jObj[key2],key2,"",level);else if("object"!=typeof jObj[key2]){const attr2=this.isAttribute(key2);if(attr2)attrStr+=this.buildAttrPairStr(attr2,""+jObj[key2]);else if(key2===this.options.textNodeName){let newval=this.options.tagValueProcessor(key2,""+jObj[key2]);val2+=this.replaceEntitiesValue(newval)}else val2+=this.buildTextValNode(jObj[key2],key2,"",level)}else if(Array.isArray(jObj[key2])){const arrLen=jObj[key2].length;let listTagVal="",listTagAttr="";for(let j2=0;j2<arrLen;j2++){const item=jObj[key2][j2];if("undefined"==typeof item);else if(null===item)if("?"===key2[0])val2+=this.indentate(level)+"<"+key2+"?"+this.tagEndChar;else val2+=this.indentate(level)+"<"+key2+"/"+this.tagEndChar;else if("object"==typeof item)if(this.options.oneListGroup){const result=this.j2x(item,level+1);listTagVal+=result.val;if(this.options.attributesGroupName&&item.hasOwnProperty(this.options.attributesGroupName))listTagAttr+=result.attrStr}else listTagVal+=this.processTextOrObjNode(item,key2,level);else if(this.options.oneListGroup){let textValue=this.options.tagValueProcessor(key2,item);textValue=this.replaceEntitiesValue(textValue);listTagVal+=textValue}else listTagVal+=this.buildTextValNode(item,key2,"",level)}if(this.options.oneListGroup)listTagVal=this.buildObjectNode(listTagVal,key2,listTagAttr,level);val2+=listTagVal}else if(this.options.attributesGroupName&&key2===this.options.attributesGroupName){const Ks=Object.keys(jObj[key2]),L2=Ks.length;for(let j2=0;j2<L2;j2++)attrStr+=this.buildAttrPairStr(Ks[j2],""+jObj[key2][Ks[j2]])}else val2+=this.processTextOrObjNode(jObj[key2],key2,level);return{attrStr,val:val2}};Builder.prototype.buildAttrPairStr=function(attrName,val2){val2=this.options.attributeValueProcessor(attrName,""+val2);val2=this.replaceEntitiesValue(val2);if(this.options.suppressBooleanAttributes&&"true"===val2)return" "+attrName;else return" "+attrName+'="'+val2+'"'};function processTextOrObjNode(object,key2,level){const result=this.j2x(object,level+1);if(void 0!==object[this.options.textNodeName]&&1===Object.keys(object).length)return this.buildTextValNode(object[this.options.textNodeName],key2,result.attrStr,level);else return this.buildObjectNode(result.val,key2,result.attrStr,level)}Builder.prototype.buildObjectNode=function(val2,key2,attrStr,level){if(""===val2)if("?"===key2[0])return this.indentate(level)+"<"+key2+attrStr+"?"+this.tagEndChar;else return this.indentate(level)+"<"+key2+attrStr+this.closeTag(key2)+this.tagEndChar;else{let tagEndExp="</"+key2+this.tagEndChar,piClosingChar="";if("?"===key2[0]){piClosingChar="?";tagEndExp=""}if((attrStr||""===attrStr)&&-1===val2.indexOf("<"))return this.indentate(level)+"<"+key2+attrStr+piClosingChar+">"+val2+tagEndExp;else if(false!==this.options.commentPropName&&key2===this.options.commentPropName&&0===piClosingChar.length)return this.indentate(level)+`\x3c!--${val2}--\x3e`+this.newLine;else return this.indentate(level)+"<"+key2+attrStr+piClosingChar+this.tagEndChar+val2+this.indentate(level)+tagEndExp}};Builder.prototype.closeTag=function(key2){let closeTag="";if(-1!==this.options.unpairedTags.indexOf(key2)){if(!this.options.suppressUnpairedNode)closeTag="/"}else if(this.options.suppressEmptyNode)closeTag="/";else closeTag=`></${key2}`;return closeTag};Builder.prototype.buildTextValNode=function(val2,key2,attrStr,level){if(false!==this.options.cdataPropName&&key2===this.options.cdataPropName)return this.indentate(level)+`<![CDATA[${val2}]]>`+this.newLine;else if(false!==this.options.commentPropName&&key2===this.options.commentPropName)return this.indentate(level)+`\x3c!--${val2}--\x3e`+this.newLine;else if("?"===key2[0])return this.indentate(level)+"<"+key2+attrStr+"?"+this.tagEndChar;else{let textValue=this.options.tagValueProcessor(key2,val2);textValue=this.replaceEntitiesValue(textValue);if(""===textValue)return this.indentate(level)+"<"+key2+attrStr+this.closeTag(key2)+this.tagEndChar;else return this.indentate(level)+"<"+key2+attrStr+">"+textValue+"</"+key2+this.tagEndChar}};Builder.prototype.replaceEntitiesValue=function(textValue){if(textValue&&textValue.length>0&&this.options.processEntities)for(let i2=0;i2<this.options.entities.length;i2++){const entity=this.options.entities[i2];textValue=textValue.replace(entity.regex,entity.val)}return textValue};function indentate(level){return this.options.indentBy.repeat(level)}function isAttribute(name){if(name.startsWith(this.options.attributeNamePrefix)&&name!==this.options.textNodeName)return name.substr(this.attrPrefixLen);else return false}module2.exports=Builder}}),require_fxp=__commonJS({"node_modules/fast-xml-parser/src/fxp.js"(exports,module2){"use strict";var validator=require_validator(),XMLParser2=require_XMLParser(),XMLBuilder=require_json2xml();module2.exports={XMLParser:XMLParser2,XMLValidator:validator,XMLBuilder}}}),require_es5=__commonJS({"node_modules/bowser/es5.js"(exports,module2){e4=exports,t4=function(){return function(e4){var t4={};function r2(n3){if(t4[n3])return t4[n3].exports;var i2=t4[n3]={i:n3,l:false,exports:{}};return e4[n3].call(i2.exports,i2,i2.exports,r2),i2.l=true,i2.exports}return r2.m=e4,r2.c=t4,r2.d=function(e5,t5,n3){r2.o(e5,t5)||Object.defineProperty(e5,t5,{enumerable:true,get:n3})},r2.r=function(e5){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e5,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e5,"__esModule",{value:true})},r2.t=function(e5,t5){if(1&t5&&(e5=r2(e5)),8&t5)return e5;if(4&t5&&"object"==typeof e5&&e5&&e5.__esModule)return e5;var n3=Object.create(null);if(r2.r(n3),Object.defineProperty(n3,"default",{enumerable:true,value:e5}),2&t5&&"string"!=typeof e5)for(var i2 in e5)r2.d(n3,i2,(function(t6){return e5[t6]}).bind(null,i2));return n3},r2.n=function(e5){var t5=e5&&e5.__esModule?function(){return e5.default}:function(){return e5};return r2.d(t5,"a",t5),t5},r2.o=function(e5,t5){return Object.prototype.hasOwnProperty.call(e5,t5)},r2.p="",r2(r2.s=90)}({17:function(e4,t4,r2){"use strict";t4.__esModule=true,t4.default=void 0;var n3=r2(18),i2=function(){function e5(){}return e5.getFirstMatch=function(e6,t5){var r3=t5.match(e6);return r3&&r3.length>0&&r3[1]||""},e5.getSecondMatch=function(e6,t5){var r3=t5.match(e6);return r3&&r3.length>1&&r3[2]||""},e5.matchAndReturnConst=function(e6,t5,r3){if(e6.test(t5))return r3},e5.getWindowsVersionName=function(e6){switch(e6){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}},e5.getMacOSVersionName=function(e6){var t5=e6.split(".").splice(0,2).map((function(e7){return parseInt(e7,10)||0}));if(t5.push(0),10===t5[0])switch(t5[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}},e5.getAndroidVersionName=function(e6){var t5=e6.split(".").splice(0,2).map((function(e7){return parseInt(e7,10)||0}));if(t5.push(0),!(1===t5[0]&&t5[1]<5))return 1===t5[0]&&t5[1]<6?"Cupcake":1===t5[0]&&t5[1]>=6?"Donut":2===t5[0]&&t5[1]<2?"Eclair":2===t5[0]&&2===t5[1]?"Froyo":2===t5[0]&&t5[1]>2?"Gingerbread":3===t5[0]?"Honeycomb":4===t5[0]&&t5[1]<1?"Ice Cream Sandwich":4===t5[0]&&t5[1]<4?"Jelly Bean":4===t5[0]&&t5[1]>=4?"KitKat":5===t5[0]?"Lollipop":6===t5[0]?"Marshmallow":7===t5[0]?"Nougat":8===t5[0]?"Oreo":9===t5[0]?"Pie":void 0},e5.getVersionPrecision=function(e6){return e6.split(".").length},e5.compareVersions=function(t5,r3,n4){void 0===n4&&(n4=false);var i3=e5.getVersionPrecision(t5),s2=e5.getVersionPrecision(r3),a2=Math.max(i3,s2),o2=0,u2=e5.map([t5,r3],(function(t6){var r4=a2-e5.getVersionPrecision(t6),n5=t6+new Array(r4+1).join(".0");return e5.map(n5.split("."),(function(e6){return new Array(20-e6.length).join("0")+e6})).reverse()}));for(n4&&(o2=a2-Math.min(i3,s2)),a2-=1;a2>=o2;){if(u2[0][a2]>u2[1][a2])return 1;if(u2[0][a2]===u2[1][a2]){if(a2===o2)return 0;a2-=1}else if(u2[0][a2]<u2[1][a2])return-1}},e5.map=function(e6,t5){var r3,n4=[];if(Array.prototype.map)return Array.prototype.map.call(e6,t5);for(r3=0;r3<e6.length;r3+=1)n4.push(t5(e6[r3]));return n4},e5.find=function(e6,t5){var r3,n4;if(Array.prototype.find)return Array.prototype.find.call(e6,t5);for(r3=0,n4=e6.length;r3<n4;r3+=1){var i3=e6[r3];if(t5(i3,r3))return i3}},e5.assign=function(e6){for(var t5,r3,n4=e6,i3=arguments.length,s2=new Array(i3>1?i3-1:0),a2=1;a2<i3;a2++)s2[a2-1]=arguments[a2];if(Object.assign)return Object.assign.apply(Object,[e6].concat(s2));var o2=function(){var e7=s2[t5];"object"==typeof e7&&null!==e7&&Object.keys(e7).forEach((function(t6){n4[t6]=e7[t6]}))};for(t5=0,r3=s2.length;t5<r3;t5+=1)o2();return e6},e5.getBrowserAlias=function(e6){return n3.BROWSER_ALIASES_MAP[e6]},e5.getBrowserTypeByAlias=function(e6){return n3.BROWSER_MAP[e6]||""},e5}();t4.default=i2,e4.exports=t4.default},18:function(e4,t4,r2){"use strict";t4.__esModule=true,t4.ENGINE_MAP=t4.OS_MAP=t4.PLATFORMS_MAP=t4.BROWSER_MAP=t4.BROWSER_ALIASES_MAP=void 0;t4.BROWSER_ALIASES_MAP={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"};t4.BROWSER_MAP={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"};t4.PLATFORMS_MAP={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"};t4.OS_MAP={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"};t4.ENGINE_MAP={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"}},90:function(e4,t4,r2){"use strict";t4.__esModule=true,t4.default=void 0;var n3,i2=(n3=r2(91))&&n3.__esModule?n3:{default:n3},s2=r2(18),o2=function(){function e5(){}var n4;return e5.getParser=function(e6,t6){if(void 0===t6&&(t6=false),"string"!=typeof e6)throw new Error("UserAgent should be a string");return new i2.default(e6,t6)},e5.parse=function(e6){return new i2.default(e6).getResult()},(n4=[{key:"BROWSER_MAP",get:function(){return s2.BROWSER_MAP}},{key:"ENGINE_MAP",get:function(){return s2.ENGINE_MAP}},{key:"OS_MAP",get:function(){return s2.OS_MAP}},{key:"PLATFORMS_MAP",get:function(){return s2.PLATFORMS_MAP}}])&&function a2(e5,t5){for(var r3=0;r3<t5.length;r3++){var n4=t5[r3];n4.enumerable=n4.enumerable||false,n4.configurable=true,"value"in n4&&(n4.writable=true),Object.defineProperty(e5,n4.key,n4)}}(e5,n4),e5}();t4.default=o2,e4.exports=t4.default},91:function(e4,t4,r2){"use strict";t4.__esModule=true,t4.default=void 0;var n3=u2(r2(92)),i2=u2(r2(93)),s2=u2(r2(94)),a2=u2(r2(95)),o2=u2(r2(17));function u2(e5){return e5&&e5.__esModule?e5:{default:e5}}var d4=function(){function e5(e6,t6){if(void 0===t6&&(t6=false),null==e6||""===e6)throw new Error("UserAgent parameter can't be empty");this._ua=e6,this.parsedResult={},true!==t6&&this.parse()}var t5=e5.prototype;return t5.getUA=function(){return this._ua},t5.test=function(e6){return e6.test(this._ua)},t5.parseBrowser=function(){var e6=this;this.parsedResult.browser={};var t6=o2.default.find(n3.default,(function(t7){if("function"==typeof t7.test)return t7.test(e6);if(t7.test instanceof Array)return t7.test.some((function(t8){return e6.test(t8)}));throw new Error("Browser's test function is not valid")}));return t6&&(this.parsedResult.browser=t6.describe(this.getUA())),this.parsedResult.browser},t5.getBrowser=function(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()},t5.getBrowserName=function(e6){return e6?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""},t5.getBrowserVersion=function(){return this.getBrowser().version},t5.getOS=function(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()},t5.parseOS=function(){var e6=this;this.parsedResult.os={};var t6=o2.default.find(i2.default,(function(t7){if("function"==typeof t7.test)return t7.test(e6);if(t7.test instanceof Array)return t7.test.some((function(t8){return e6.test(t8)}));throw new Error("Browser's test function is not valid")}));return t6&&(this.parsedResult.os=t6.describe(this.getUA())),this.parsedResult.os},t5.getOSName=function(e6){var t6=this.getOS().name;return e6?String(t6).toLowerCase()||"":t6||""},t5.getOSVersion=function(){return this.getOS().version},t5.getPlatform=function(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()},t5.getPlatformType=function(e6){void 0===e6&&(e6=false);var t6=this.getPlatform().type;return e6?String(t6).toLowerCase()||"":t6||""},t5.parsePlatform=function(){var e6=this;this.parsedResult.platform={};var t6=o2.default.find(s2.default,(function(t7){if("function"==typeof t7.test)return t7.test(e6);if(t7.test instanceof Array)return t7.test.some((function(t8){return e6.test(t8)}));throw new Error("Browser's test function is not valid")}));return t6&&(this.parsedResult.platform=t6.describe(this.getUA())),this.parsedResult.platform},t5.getEngine=function(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()},t5.getEngineName=function(e6){return e6?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""},t5.parseEngine=function(){var e6=this;this.parsedResult.engine={};var t6=o2.default.find(a2.default,(function(t7){if("function"==typeof t7.test)return t7.test(e6);if(t7.test instanceof Array)return t7.test.some((function(t8){return e6.test(t8)}));throw new Error("Browser's test function is not valid")}));return t6&&(this.parsedResult.engine=t6.describe(this.getUA())),this.parsedResult.engine},t5.parse=function(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this},t5.getResult=function(){return o2.default.assign({},this.parsedResult)},t5.satisfies=function(e6){var t6=this,r3={},n4=0,i3={},s3=0;if(Object.keys(e6).forEach((function(t7){var a4=e6[t7];"string"==typeof a4?(i3[t7]=a4,s3+=1):"object"==typeof a4&&(r3[t7]=a4,n4+=1)})),n4>0){var a3=Object.keys(r3),u3=o2.default.find(a3,(function(e7){return t6.isOS(e7)}));if(u3){var d5=this.satisfies(r3[u3]);if(void 0!==d5)return d5}var c2=o2.default.find(a3,(function(e7){return t6.isPlatform(e7)}));if(c2){var f4=this.satisfies(r3[c2]);if(void 0!==f4)return f4}}if(s3>0){var l2=Object.keys(i3),h3=o2.default.find(l2,(function(e7){return t6.isBrowser(e7,true)}));if(void 0!==h3)return this.compareVersion(i3[h3])}},t5.isBrowser=function(e6,t6){void 0===t6&&(t6=false);var r3=this.getBrowserName().toLowerCase(),n4=e6.toLowerCase(),i3=o2.default.getBrowserTypeByAlias(n4);return t6&&i3&&(n4=i3.toLowerCase()),n4===r3},t5.compareVersion=function(e6){var t6=[0],r3=e6,n4=false,i3=this.getBrowserVersion();if("string"==typeof i3)return">"===e6[0]||"<"===e6[0]?(r3=e6.substr(1),"="===e6[1]?(n4=true,r3=e6.substr(2)):t6=[],">"===e6[0]?t6.push(1):t6.push(-1)):"="===e6[0]?r3=e6.substr(1):"~"===e6[0]&&(n4=true,r3=e6.substr(1)),t6.indexOf(o2.default.compareVersions(i3,r3,n4))>-1},t5.isOS=function(e6){return this.getOSName(true)===String(e6).toLowerCase()},t5.isPlatform=function(e6){return this.getPlatformType(true)===String(e6).toLowerCase()},t5.isEngine=function(e6){return this.getEngineName(true)===String(e6).toLowerCase()},t5.is=function(e6,t6){return void 0===t6&&(t6=false),this.isBrowser(e6,t6)||this.isOS(e6)||this.isPlatform(e6)},t5.some=function(e6){var t6=this;return void 0===e6&&(e6=[]),e6.some((function(e7){return t6.is(e7)}))},e5}();t4.default=d4,e4.exports=t4.default},92:function(e4,t4,r2){"use strict";t4.__esModule=true,t4.default=void 0;var n3,i2=(n3=r2(17))&&n3.__esModule?n3:{default:n3},s2=/version\/(\d+(\.?_?\d+)+)/i,a2=[{test:[/googlebot/i],describe:function(e5){var t5={name:"Googlebot"},r3=i2.default.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/opera/i],describe:function(e5){var t5={name:"Opera"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/opr\/|opios/i],describe:function(e5){var t5={name:"Opera"},r3=i2.default.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/SamsungBrowser/i],describe:function(e5){var t5={name:"Samsung Internet for Android"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/Whale/i],describe:function(e5){var t5={name:"NAVER Whale Browser"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/MZBrowser/i],describe:function(e5){var t5={name:"MZ Browser"},r3=i2.default.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/focus/i],describe:function(e5){var t5={name:"Focus"},r3=i2.default.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/swing/i],describe:function(e5){var t5={name:"Swing"},r3=i2.default.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/coast/i],describe:function(e5){var t5={name:"Opera Coast"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe:function(e5){var t5={name:"Opera Touch"},r3=i2.default.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/yabrowser/i],describe:function(e5){var t5={name:"Yandex Browser"},r3=i2.default.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/ucbrowser/i],describe:function(e5){var t5={name:"UC Browser"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/Maxthon|mxios/i],describe:function(e5){var t5={name:"Maxthon"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/epiphany/i],describe:function(e5){var t5={name:"Epiphany"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/puffin/i],describe:function(e5){var t5={name:"Puffin"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/sleipnir/i],describe:function(e5){var t5={name:"Sleipnir"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/k-meleon/i],describe:function(e5){var t5={name:"K-Meleon"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/micromessenger/i],describe:function(e5){var t5={name:"WeChat"},r3=i2.default.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/qqbrowser/i],describe:function(e5){var t5={name:/qqbrowserlite/i.test(e5)?"QQ Browser Lite":"QQ Browser"},r3=i2.default.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/msie|trident/i],describe:function(e5){var t5={name:"Internet Explorer"},r3=i2.default.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/\sedg\//i],describe:function(e5){var t5={name:"Microsoft Edge"},r3=i2.default.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/edg([ea]|ios)/i],describe:function(e5){var t5={name:"Microsoft Edge"},r3=i2.default.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/vivaldi/i],describe:function(e5){var t5={name:"Vivaldi"},r3=i2.default.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/seamonkey/i],describe:function(e5){var t5={name:"SeaMonkey"},r3=i2.default.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/sailfish/i],describe:function(e5){var t5={name:"Sailfish"},r3=i2.default.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/silk/i],describe:function(e5){var t5={name:"Amazon Silk"},r3=i2.default.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/phantom/i],describe:function(e5){var t5={name:"PhantomJS"},r3=i2.default.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/slimerjs/i],describe:function(e5){var t5={name:"SlimerJS"},r3=i2.default.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e5){var t5={name:"BlackBerry"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/(web|hpw)[o0]s/i],describe:function(e5){var t5={name:"WebOS Browser"},r3=i2.default.getFirstMatch(s2,e5)||i2.default.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/bada/i],describe:function(e5){var t5={name:"Bada"},r3=i2.default.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/tizen/i],describe:function(e5){var t5={name:"Tizen"},r3=i2.default.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/qupzilla/i],describe:function(e5){var t5={name:"QupZilla"},r3=i2.default.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/firefox|iceweasel|fxios/i],describe:function(e5){var t5={name:"Firefox"},r3=i2.default.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/electron/i],describe:function(e5){var t5={name:"Electron"},r3=i2.default.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/MiuiBrowser/i],describe:function(e5){var t5={name:"Miui"},r3=i2.default.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/chromium/i],describe:function(e5){var t5={name:"Chromium"},r3=i2.default.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,e5)||i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/chrome|crios|crmo/i],describe:function(e5){var t5={name:"Chrome"},r3=i2.default.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/GSA/i],describe:function(e5){var t5={name:"Google Search"},r3=i2.default.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:function(e5){var t5=!e5.test(/like android/i),r3=e5.test(/android/i);return t5&&r3},describe:function(e5){var t5={name:"Android Browser"},r3=i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/playstation 4/i],describe:function(e5){var t5={name:"PlayStation 4"},r3=i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/safari|applewebkit/i],describe:function(e5){var t5={name:"Safari"},r3=i2.default.getFirstMatch(s2,e5);return r3&&(t5.version=r3),t5}},{test:[/.*/i],describe:function(e5){var t5=-1!==e5.search("\\(")?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:i2.default.getFirstMatch(t5,e5),version:i2.default.getSecondMatch(t5,e5)}}}];t4.default=a2,e4.exports=t4.default},93:function(e4,t4,r2){"use strict";t4.__esModule=true,t4.default=void 0;var n3,i2=(n3=r2(17))&&n3.__esModule?n3:{default:n3},s2=r2(18),a2=[{test:[/Roku\/DVP/],describe:function(e5){var t5=i2.default.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,e5);return{name:s2.OS_MAP.Roku,version:t5}}},{test:[/windows phone/i],describe:function(e5){var t5=i2.default.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,e5);return{name:s2.OS_MAP.WindowsPhone,version:t5}}},{test:[/windows /i],describe:function(e5){var t5=i2.default.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,e5),r3=i2.default.getWindowsVersionName(t5);return{name:s2.OS_MAP.Windows,version:t5,versionName:r3}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(e5){var t5={name:s2.OS_MAP.iOS},r3=i2.default.getSecondMatch(/(Version\/)(\d[\d.]+)/,e5);return r3&&(t5.version=r3),t5}},{test:[/macintosh/i],describe:function(e5){var t5=i2.default.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,e5).replace(/[_\s]/g,"."),r3=i2.default.getMacOSVersionName(t5),n4={name:s2.OS_MAP.MacOS,version:t5};return r3&&(n4.versionName=r3),n4}},{test:[/(ipod|iphone|ipad)/i],describe:function(e5){var t5=i2.default.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,e5).replace(/[_\s]/g,".");return{name:s2.OS_MAP.iOS,version:t5}}},{test:function(e5){var t5=!e5.test(/like android/i),r3=e5.test(/android/i);return t5&&r3},describe:function(e5){var t5=i2.default.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,e5),r3=i2.default.getAndroidVersionName(t5),n4={name:s2.OS_MAP.Android,version:t5};return r3&&(n4.versionName=r3),n4}},{test:[/(web|hpw)[o0]s/i],describe:function(e5){var t5=i2.default.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,e5),r3={name:s2.OS_MAP.WebOS};return t5&&t5.length&&(r3.version=t5),r3}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e5){var t5=i2.default.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,e5)||i2.default.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,e5)||i2.default.getFirstMatch(/\bbb(\d+)/i,e5);return{name:s2.OS_MAP.BlackBerry,version:t5}}},{test:[/bada/i],describe:function(e5){var t5=i2.default.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,e5);return{name:s2.OS_MAP.Bada,version:t5}}},{test:[/tizen/i],describe:function(e5){var t5=i2.default.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,e5);return{name:s2.OS_MAP.Tizen,version:t5}}},{test:[/linux/i],describe:function(){return{name:s2.OS_MAP.Linux}}},{test:[/CrOS/],describe:function(){return{name:s2.OS_MAP.ChromeOS}}},{test:[/PlayStation 4/],describe:function(e5){var t5=i2.default.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,e5);return{name:s2.OS_MAP.PlayStation4,version:t5}}}];t4.default=a2,e4.exports=t4.default},94:function(e4,t4,r2){"use strict";t4.__esModule=true,t4.default=void 0;var n3,i2=(n3=r2(17))&&n3.__esModule?n3:{default:n3},s2=r2(18),a2=[{test:[/googlebot/i],describe:function(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe:function(e5){var t5=i2.default.getFirstMatch(/(can-l01)/i,e5)&&"Nova",r3={type:s2.PLATFORMS_MAP.mobile,vendor:"Huawei"};return t5&&(r3.model=t5),r3}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:function(){return{type:s2.PLATFORMS_MAP.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe:function(){return{type:s2.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(){return{type:s2.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe:function(){return{type:s2.PLATFORMS_MAP.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe:function(){return{type:s2.PLATFORMS_MAP.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe:function(){return{type:s2.PLATFORMS_MAP.tablet}}},{test:function(e5){var t5=e5.test(/ipod|iphone/i),r3=e5.test(/like (ipod|iphone)/i);return t5&&!r3},describe:function(e5){var t5=i2.default.getFirstMatch(/(ipod|iphone)/i,e5);return{type:s2.PLATFORMS_MAP.mobile,vendor:"Apple",model:t5}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:function(){return{type:s2.PLATFORMS_MAP.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe:function(){return{type:s2.PLATFORMS_MAP.mobile}}},{test:function(e5){return"blackberry"===e5.getBrowserName(true)},describe:function(){return{type:s2.PLATFORMS_MAP.mobile,vendor:"BlackBerry"}}},{test:function(e5){return"bada"===e5.getBrowserName(true)},describe:function(){return{type:s2.PLATFORMS_MAP.mobile}}},{test:function(e5){return"windows phone"===e5.getBrowserName()},describe:function(){return{type:s2.PLATFORMS_MAP.mobile,vendor:"Microsoft"}}},{test:function(e5){var t5=Number(String(e5.getOSVersion()).split(".")[0]);return"android"===e5.getOSName(true)&&t5>=3},describe:function(){return{type:s2.PLATFORMS_MAP.tablet}}},{test:function(e5){return"android"===e5.getOSName(true)},describe:function(){return{type:s2.PLATFORMS_MAP.mobile}}},{test:function(e5){return"macos"===e5.getOSName(true)},describe:function(){return{type:s2.PLATFORMS_MAP.desktop,vendor:"Apple"}}},{test:function(e5){return"windows"===e5.getOSName(true)},describe:function(){return{type:s2.PLATFORMS_MAP.desktop}}},{test:function(e5){return"linux"===e5.getOSName(true)},describe:function(){return{type:s2.PLATFORMS_MAP.desktop}}},{test:function(e5){return"playstation 4"===e5.getOSName(true)},describe:function(){return{type:s2.PLATFORMS_MAP.tv}}},{test:function(e5){return"roku"===e5.getOSName(true)},describe:function(){return{type:s2.PLATFORMS_MAP.tv}}}];t4.default=a2,e4.exports=t4.default},95:function(e4,t4,r2){"use strict";t4.__esModule=true,t4.default=void 0;var n3,i2=(n3=r2(17))&&n3.__esModule?n3:{default:n3},s2=r2(18),a2=[{test:function(e5){return"microsoft edge"===e5.getBrowserName(true)},describe:function(e5){if(/\sedg\//i.test(e5))return{name:s2.ENGINE_MAP.Blink};var t5=i2.default.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,e5);return{name:s2.ENGINE_MAP.EdgeHTML,version:t5}}},{test:[/trident/i],describe:function(e5){var t5={name:s2.ENGINE_MAP.Trident},r3=i2.default.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:function(e5){return e5.test(/presto/i)},describe:function(e5){var t5={name:s2.ENGINE_MAP.Presto},r3=i2.default.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:function(e5){var t5=e5.test(/gecko/i),r3=e5.test(/like gecko/i);return t5&&!r3},describe:function(e5){var t5={name:s2.ENGINE_MAP.Gecko},r3=i2.default.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}},{test:[/(apple)?webkit\/537\.36/i],describe:function(){return{name:s2.ENGINE_MAP.Blink}}},{test:[/(apple)?webkit/i],describe:function(e5){var t5={name:s2.ENGINE_MAP.WebKit},r3=i2.default.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,e5);return r3&&(t5.version=r3),t5}}];t4.default=a2,e4.exports=t4.default}})},"object"==typeof exports&&"object"==typeof module2?module2.exports=t4():"function"==typeof define&&define.amd?define([],t4):"object"==typeof exports?exports.bowser=t4():e4.bowser=t4();var e4,t4}}),require_events=__commonJS({"node_modules/events/events.js"(exports,module2){"use strict";var ReflectOwnKeys,R2="object"==typeof Reflect?Reflect:null,ReflectApply=R2&&"function"==typeof R2.apply?R2.apply:function ReflectApply2(target,receiver,args){return Function.prototype.apply.call(target,receiver,args)};if(R2&&"function"==typeof R2.ownKeys)ReflectOwnKeys=R2.ownKeys;else if(Object.getOwnPropertySymbols)ReflectOwnKeys=function ReflectOwnKeys2(target){return Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))};else ReflectOwnKeys=function ReflectOwnKeys2(target){return Object.getOwnPropertyNames(target)};var NumberIsNaN=Number.isNaN||function NumberIsNaN2(value){return value!=value};function EventEmitter2(){EventEmitter2.init.call(this)}module2.exports=EventEmitter2;module2.exports.once=function once3(emitter,name){return new Promise((function(resolve,reject){function errorListener(err2){emitter.removeListener(name,resolver);reject(err2)}function resolver(){if("function"==typeof emitter.removeListener)emitter.removeListener("error",errorListener);resolve([].slice.call(arguments))}eventTargetAgnosticAddListener(emitter,name,resolver,{once:true});if("error"!==name)(function addErrorHandlerIfEventEmitter(emitter,handler,flags){if("function"==typeof emitter.on)eventTargetAgnosticAddListener(emitter,"error",handler,flags)})(emitter,errorListener,{once:true})}))};EventEmitter2.EventEmitter=EventEmitter2;EventEmitter2.prototype._events=void 0;EventEmitter2.prototype._eventsCount=0;EventEmitter2.prototype._maxListeners=void 0;var defaultMaxListeners=10;function checkListener(listener){if("function"!=typeof listener)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof listener)}Object.defineProperty(EventEmitter2,"defaultMaxListeners",{enumerable:true,get:function(){return defaultMaxListeners},set:function(arg){if("number"!=typeof arg||arg<0||NumberIsNaN(arg))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+arg+".");defaultMaxListeners=arg}});EventEmitter2.init=function(){if(void 0===this._events||this._events===Object.getPrototypeOf(this)._events){this._events=Object.create(null);this._eventsCount=0}this._maxListeners=this._maxListeners||void 0};EventEmitter2.prototype.setMaxListeners=function setMaxListeners(n3){if("number"!=typeof n3||n3<0||NumberIsNaN(n3))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+n3+".");this._maxListeners=n3;return this};function _getMaxListeners(that){if(void 0===that._maxListeners)return EventEmitter2.defaultMaxListeners;else return that._maxListeners}EventEmitter2.prototype.getMaxListeners=function getMaxListeners(){return _getMaxListeners(this)};EventEmitter2.prototype.emit=function emit2(type){for(var args=[],i2=1;i2<arguments.length;i2++)args.push(arguments[i2]);var doError="error"===type,events=this._events;if(void 0!==events)doError=doError&&void 0===events.error;else if(!doError)return false;if(doError){var er;if(args.length>0)er=args[0];if(er instanceof Error)throw er;var err2=new Error("Unhandled error."+(er?" ("+er.message+")":""));err2.context=er;throw err2}var handler=events[type];if(void 0===handler)return false;if("function"==typeof handler)ReflectApply(handler,this,args);else{var len=handler.length,listeners=arrayClone(handler,len);for(i2=0;i2<len;++i2)ReflectApply(listeners[i2],this,args)}return true};function _addListener(target,type,listener,prepend){var m2,events,existing;checkListener(listener);if(void 0===(events=target._events)){events=target._events=Object.create(null);target._eventsCount=0}else{if(void 0!==events.newListener){target.emit("newListener",type,listener.listener?listener.listener:listener);events=target._events}existing=events[type]}if(void 0===existing){existing=events[type]=listener;++target._eventsCount}else{if("function"==typeof existing)existing=events[type]=prepend?[listener,existing]:[existing,listener];else if(prepend)existing.unshift(listener);else existing.push(listener);if((m2=_getMaxListeners(target))>0&&existing.length>m2&&!existing.warned){existing.warned=true;var w2=new Error("Possible EventEmitter memory leak detected. "+existing.length+" "+String(type)+" listeners added. Use emitter.setMaxListeners() to increase limit");w2.name="MaxListenersExceededWarning";w2.emitter=target;w2.type=type;w2.count=existing.length;(function ProcessEmitWarning(warning){if(console&&console.warn)console.warn(warning)})(w2)}}return target}EventEmitter2.prototype.addListener=function addListener(type,listener){return _addListener(this,type,listener,false)};EventEmitter2.prototype.on=EventEmitter2.prototype.addListener;EventEmitter2.prototype.prependListener=function prependListener(type,listener){return _addListener(this,type,listener,true)};function onceWrapper(){if(!this.fired){this.target.removeListener(this.type,this.wrapFn);this.fired=true;if(0===arguments.length)return this.listener.call(this.target);else return this.listener.apply(this.target,arguments)}}function _onceWrap(target,type,listener){var state={fired:false,wrapFn:void 0,target,type,listener},wrapped=onceWrapper.bind(state);wrapped.listener=listener;state.wrapFn=wrapped;return wrapped}EventEmitter2.prototype.once=function once4(type,listener){checkListener(listener);this.on(type,_onceWrap(this,type,listener));return this};EventEmitter2.prototype.prependOnceListener=function prependOnceListener(type,listener){checkListener(listener);this.prependListener(type,_onceWrap(this,type,listener));return this};EventEmitter2.prototype.removeListener=function removeListener(type,listener){var list,events,position,i2,originalListener;checkListener(listener);if(void 0===(events=this._events))return this;if(void 0===(list=events[type]))return this;if(list===listener||list.listener===listener)if(0==--this._eventsCount)this._events=Object.create(null);else{delete events[type];if(events.removeListener)this.emit("removeListener",type,list.listener||listener)}else if("function"!=typeof list){position=-1;for(i2=list.length-1;i2>=0;i2--)if(list[i2]===listener||list[i2].listener===listener){originalListener=list[i2].listener;position=i2;break}if(position<0)return this;if(0===position)list.shift();else(function spliceOne(list,index5){for(;index5+1<list.length;index5++)list[index5]=list[index5+1];list.pop()})(list,position);if(1===list.length)events[type]=list[0];if(void 0!==events.removeListener)this.emit("removeListener",type,originalListener||listener)}return this};EventEmitter2.prototype.off=EventEmitter2.prototype.removeListener;EventEmitter2.prototype.removeAllListeners=function removeAllListeners(type){var listeners,events,i2;if(void 0===(events=this._events))return this;if(void 0===events.removeListener){if(0===arguments.length){this._events=Object.create(null);this._eventsCount=0}else if(void 0!==events[type])if(0==--this._eventsCount)this._events=Object.create(null);else delete events[type];return this}if(0===arguments.length){var key2,keys2=Object.keys(events);for(i2=0;i2<keys2.length;++i2)if("removeListener"!==(key2=keys2[i2]))this.removeAllListeners(key2);this.removeAllListeners("removeListener");this._events=Object.create(null);this._eventsCount=0;return this}if("function"==typeof(listeners=events[type]))this.removeListener(type,listeners);else if(void 0!==listeners)for(i2=listeners.length-1;i2>=0;i2--)this.removeListener(type,listeners[i2]);return this};function _listeners(target,type,unwrap2){var events=target._events;if(void 0===events)return[];var evlistener=events[type];if(void 0===evlistener)return[];if("function"==typeof evlistener)return unwrap2?[evlistener.listener||evlistener]:[evlistener];else return unwrap2?function unwrapListeners(arr){for(var ret=new Array(arr.length),i2=0;i2<ret.length;++i2)ret[i2]=arr[i2].listener||arr[i2];return ret}(evlistener):arrayClone(evlistener,evlistener.length)}EventEmitter2.prototype.listeners=function listeners(type){return _listeners(this,type,true)};EventEmitter2.prototype.rawListeners=function rawListeners(type){return _listeners(this,type,false)};EventEmitter2.listenerCount=function(emitter,type){if("function"==typeof emitter.listenerCount)return emitter.listenerCount(type);else return listenerCount2.call(emitter,type)};EventEmitter2.prototype.listenerCount=listenerCount2;function listenerCount2(type){var events=this._events;if(void 0!==events){var evlistener=events[type];if("function"==typeof evlistener)return 1;else if(void 0!==evlistener)return evlistener.length}return 0}EventEmitter2.prototype.eventNames=function eventNames(){return this._eventsCount>0?ReflectOwnKeys(this._events):[]};function arrayClone(arr,n3){for(var copy=new Array(n3),i2=0;i2<n3;++i2)copy[i2]=arr[i2];return copy}function eventTargetAgnosticAddListener(emitter,name,listener,flags){if("function"==typeof emitter.on)if(flags.once)emitter.once(name,listener);else emitter.on(name,listener);else if("function"==typeof emitter.addEventListener)emitter.addEventListener(name,(function wrapListener(arg){if(flags.once)emitter.removeEventListener(name,wrapListener);listener(arg)}));else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof emitter)}}}),require_spark_md5=__commonJS({"node_modules/spark-md5/spark-md5.js"(exports,module2){(function(factory){if("object"==typeof exports)module2.exports=factory();else if("function"==typeof define&&define.amd)define(factory);else{var glob;try{glob=window}catch(e4){glob=self}glob.SparkMD5=factory()}})((function(undefined2){"use strict";var hex_chr=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function md5cycle(x2,k2){var a2=x2[0],b3=x2[1],c2=x2[2],d4=x2[3];b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3&c2|~b3&d4)+k2[0]-680876936|0)<<7|a2>>>25)+b3|0)&b3|~a2&c2)+k2[1]-389564586|0)<<12|d4>>>20)+a2|0)&a2|~d4&b3)+k2[2]+606105819|0)<<17|c2>>>15)+d4|0)&d4|~c2&a2)+k2[3]-1044525330|0)<<22|b3>>>10)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3&c2|~b3&d4)+k2[4]-176418897|0)<<7|a2>>>25)+b3|0)&b3|~a2&c2)+k2[5]+1200080426|0)<<12|d4>>>20)+a2|0)&a2|~d4&b3)+k2[6]-1473231341|0)<<17|c2>>>15)+d4|0)&d4|~c2&a2)+k2[7]-45705983|0)<<22|b3>>>10)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3&c2|~b3&d4)+k2[8]+1770035416|0)<<7|a2>>>25)+b3|0)&b3|~a2&c2)+k2[9]-1958414417|0)<<12|d4>>>20)+a2|0)&a2|~d4&b3)+k2[10]-42063|0)<<17|c2>>>15)+d4|0)&d4|~c2&a2)+k2[11]-1990404162|0)<<22|b3>>>10)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3&c2|~b3&d4)+k2[12]+1804603682|0)<<7|a2>>>25)+b3|0)&b3|~a2&c2)+k2[13]-40341101|0)<<12|d4>>>20)+a2|0)&a2|~d4&b3)+k2[14]-1502002290|0)<<17|c2>>>15)+d4|0)&d4|~c2&a2)+k2[15]+1236535329|0)<<22|b3>>>10)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3&d4|c2&~d4)+k2[1]-165796510|0)<<5|a2>>>27)+b3|0)&c2|b3&~c2)+k2[6]-1069501632|0)<<9|d4>>>23)+a2|0)&b3|a2&~b3)+k2[11]+643717713|0)<<14|c2>>>18)+d4|0)&a2|d4&~a2)+k2[0]-373897302|0)<<20|b3>>>12)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3&d4|c2&~d4)+k2[5]-701558691|0)<<5|a2>>>27)+b3|0)&c2|b3&~c2)+k2[10]+38016083|0)<<9|d4>>>23)+a2|0)&b3|a2&~b3)+k2[15]-660478335|0)<<14|c2>>>18)+d4|0)&a2|d4&~a2)+k2[4]-405537848|0)<<20|b3>>>12)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3&d4|c2&~d4)+k2[9]+568446438|0)<<5|a2>>>27)+b3|0)&c2|b3&~c2)+k2[14]-1019803690|0)<<9|d4>>>23)+a2|0)&b3|a2&~b3)+k2[3]-187363961|0)<<14|c2>>>18)+d4|0)&a2|d4&~a2)+k2[8]+1163531501|0)<<20|b3>>>12)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3&d4|c2&~d4)+k2[13]-1444681467|0)<<5|a2>>>27)+b3|0)&c2|b3&~c2)+k2[2]-51403784|0)<<9|d4>>>23)+a2|0)&b3|a2&~b3)+k2[7]+1735328473|0)<<14|c2>>>18)+d4|0)&a2|d4&~a2)+k2[12]-1926607734|0)<<20|b3>>>12)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3^c2^d4)+k2[5]-378558|0)<<4|a2>>>28)+b3|0)^b3^c2)+k2[8]-2022574463|0)<<11|d4>>>21)+a2|0)^a2^b3)+k2[11]+1839030562|0)<<16|c2>>>16)+d4|0)^d4^a2)+k2[14]-35309556|0)<<23|b3>>>9)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3^c2^d4)+k2[1]-1530992060|0)<<4|a2>>>28)+b3|0)^b3^c2)+k2[4]+1272893353|0)<<11|d4>>>21)+a2|0)^a2^b3)+k2[7]-155497632|0)<<16|c2>>>16)+d4|0)^d4^a2)+k2[10]-1094730640|0)<<23|b3>>>9)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3^c2^d4)+k2[13]+681279174|0)<<4|a2>>>28)+b3|0)^b3^c2)+k2[0]-358537222|0)<<11|d4>>>21)+a2|0)^a2^b3)+k2[3]-722521979|0)<<16|c2>>>16)+d4|0)^d4^a2)+k2[6]+76029189|0)<<23|b3>>>9)+c2|0;b3=((b3+=((c2=((c2+=((d4=((d4+=((a2=((a2+=(b3^c2^d4)+k2[9]-640364487|0)<<4|a2>>>28)+b3|0)^b3^c2)+k2[12]-421815835|0)<<11|d4>>>21)+a2|0)^a2^b3)+k2[15]+530742520|0)<<16|c2>>>16)+d4|0)^d4^a2)+k2[2]-995338651|0)<<23|b3>>>9)+c2|0;b3=((b3+=((d4=((d4+=(b3^((a2=((a2+=(c2^(b3|~d4))+k2[0]-198630844|0)<<6|a2>>>26)+b3|0)|~c2))+k2[7]+1126891415|0)<<10|d4>>>22)+a2|0)^((c2=((c2+=(a2^(d4|~b3))+k2[14]-1416354905|0)<<15|c2>>>17)+d4|0)|~a2))+k2[5]-57434055|0)<<21|b3>>>11)+c2|0;b3=((b3+=((d4=((d4+=(b3^((a2=((a2+=(c2^(b3|~d4))+k2[12]+1700485571|0)<<6|a2>>>26)+b3|0)|~c2))+k2[3]-1894986606|0)<<10|d4>>>22)+a2|0)^((c2=((c2+=(a2^(d4|~b3))+k2[10]-1051523|0)<<15|c2>>>17)+d4|0)|~a2))+k2[1]-2054922799|0)<<21|b3>>>11)+c2|0;b3=((b3+=((d4=((d4+=(b3^((a2=((a2+=(c2^(b3|~d4))+k2[8]+1873313359|0)<<6|a2>>>26)+b3|0)|~c2))+k2[15]-30611744|0)<<10|d4>>>22)+a2|0)^((c2=((c2+=(a2^(d4|~b3))+k2[6]-1560198380|0)<<15|c2>>>17)+d4|0)|~a2))+k2[13]+1309151649|0)<<21|b3>>>11)+c2|0;b3=((b3+=((d4=((d4+=(b3^((a2=((a2+=(c2^(b3|~d4))+k2[4]-145523070|0)<<6|a2>>>26)+b3|0)|~c2))+k2[11]-1120210379|0)<<10|d4>>>22)+a2|0)^((c2=((c2+=(a2^(d4|~b3))+k2[2]+718787259|0)<<15|c2>>>17)+d4|0)|~a2))+k2[9]-343485551|0)<<21|b3>>>11)+c2|0;x2[0]=a2+x2[0]|0;x2[1]=b3+x2[1]|0;x2[2]=c2+x2[2]|0;x2[3]=d4+x2[3]|0}function md5blk(s2){var i2,md5blks=[];for(i2=0;i2<64;i2+=4)md5blks[i2>>2]=s2.charCodeAt(i2)+(s2.charCodeAt(i2+1)<<8)+(s2.charCodeAt(i2+2)<<16)+(s2.charCodeAt(i2+3)<<24);return md5blks}function md5blk_array(a2){var i2,md5blks=[];for(i2=0;i2<64;i2+=4)md5blks[i2>>2]=a2[i2]+(a2[i2+1]<<8)+(a2[i2+2]<<16)+(a2[i2+3]<<24);return md5blks}function md51(s2){var i2,length,tail,tmp,lo,hi,n3=s2.length,state=[1732584193,-271733879,-1732584194,271733878];for(i2=64;i2<=n3;i2+=64)md5cycle(state,md5blk(s2.substring(i2-64,i2)));length=(s2=s2.substring(i2-64)).length;tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i2=0;i2<length;i2+=1)tail[i2>>2]|=s2.charCodeAt(i2)<<(i2%4<<3);tail[i2>>2]|=128<<(i2%4<<3);if(i2>55){md5cycle(state,tail);for(i2=0;i2<16;i2+=1)tail[i2]=0}tmp=(tmp=8*n3).toString(16).match(/(.*?)(.{0,8})$/);lo=parseInt(tmp[2],16);hi=parseInt(tmp[1],16)||0;tail[14]=lo;tail[15]=hi;md5cycle(state,tail);return state}function rhex(n3){var j2,s2="";for(j2=0;j2<4;j2+=1)s2+=hex_chr[n3>>8*j2+4&15]+hex_chr[n3>>8*j2&15];return s2}function hex(x2){var i2;for(i2=0;i2<x2.length;i2+=1)x2[i2]=rhex(x2[i2]);return x2.join("")}if("5d41402abc4b2a76b9719d911017c592"!==hex(md51("hello")));if("undefined"!=typeof ArrayBuffer&&!ArrayBuffer.prototype.slice)(function(){function clamp(val2,length){if((val2=0|val2||0)<0)return Math.max(val2+length,0);else return Math.min(val2,length)}ArrayBuffer.prototype.slice=function(from,to){var num,target,targetArray,sourceArray,length=this.byteLength,begin=clamp(from,length),end=length;if(to!==undefined2)end=clamp(to,length);if(begin>end)return new ArrayBuffer(0);num=end-begin;target=new ArrayBuffer(num);targetArray=new Uint8Array(target);sourceArray=new Uint8Array(this,begin,num);targetArray.set(sourceArray);return target}})();function toUtf82(str){if(/[\u0080-\uFFFF]/.test(str))str=unescape(encodeURIComponent(str));return str}function hexToBinaryString(hex2){var x2,bytes=[],length=hex2.length;for(x2=0;x2<length-1;x2+=2)bytes.push(parseInt(hex2.substr(x2,2),16));return String.fromCharCode.apply(String,bytes)}function SparkMD5(){this.reset()}SparkMD5.prototype.append=function(str){this.appendBinary(toUtf82(str));return this};SparkMD5.prototype.appendBinary=function(contents){this._buff+=contents;this._length+=contents.length;var i2,length=this._buff.length;for(i2=64;i2<=length;i2+=64)md5cycle(this._hash,md5blk(this._buff.substring(i2-64,i2)));this._buff=this._buff.substring(i2-64);return this};SparkMD5.prototype.end=function(raw){var i2,ret,buff=this._buff,length=buff.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i2=0;i2<length;i2+=1)tail[i2>>2]|=buff.charCodeAt(i2)<<(i2%4<<3);this._finish(tail,length);ret=hex(this._hash);if(raw)ret=hexToBinaryString(ret);this.reset();return ret};SparkMD5.prototype.reset=function(){this._buff="";this._length=0;this._hash=[1732584193,-271733879,-1732584194,271733878];return this};SparkMD5.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash.slice()}};SparkMD5.prototype.setState=function(state){this._buff=state.buff;this._length=state.length;this._hash=state.hash;return this};SparkMD5.prototype.destroy=function(){delete this._hash;delete this._buff;delete this._length};SparkMD5.prototype._finish=function(tail,length){var tmp,lo,hi,i2=length;tail[i2>>2]|=128<<(i2%4<<3);if(i2>55){md5cycle(this._hash,tail);for(i2=0;i2<16;i2+=1)tail[i2]=0}tmp=(tmp=8*this._length).toString(16).match(/(.*?)(.{0,8})$/);lo=parseInt(tmp[2],16);hi=parseInt(tmp[1],16)||0;tail[14]=lo;tail[15]=hi;md5cycle(this._hash,tail)};SparkMD5.hash=function(str,raw){return SparkMD5.hashBinary(toUtf82(str),raw)};SparkMD5.hashBinary=function(content,raw){var ret=hex(md51(content));return raw?hexToBinaryString(ret):ret};SparkMD5.ArrayBuffer=function(){this.reset()};SparkMD5.ArrayBuffer.prototype.append=function(arr){var i2,buff=function concatenateArrayBuffers(first,second,returnUInt8Array){var result=new Uint8Array(first.byteLength+second.byteLength);result.set(new Uint8Array(first));result.set(new Uint8Array(second),first.byteLength);return returnUInt8Array?result:result.buffer}(this._buff.buffer,arr,true),length=buff.length;this._length+=arr.byteLength;for(i2=64;i2<=length;i2+=64)md5cycle(this._hash,md5blk_array(buff.subarray(i2-64,i2)));this._buff=i2-64<length?new Uint8Array(buff.buffer.slice(i2-64)):new Uint8Array(0);return this};SparkMD5.ArrayBuffer.prototype.end=function(raw){var i2,ret,buff=this._buff,length=buff.length,tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i2=0;i2<length;i2+=1)tail[i2>>2]|=buff[i2]<<(i2%4<<3);this._finish(tail,length);ret=hex(this._hash);if(raw)ret=hexToBinaryString(ret);this.reset();return ret};SparkMD5.ArrayBuffer.prototype.reset=function(){this._buff=new Uint8Array(0);this._length=0;this._hash=[1732584193,-271733879,-1732584194,271733878];return this};SparkMD5.ArrayBuffer.prototype.getState=function(){var state=SparkMD5.prototype.getState.call(this);state.buff=function arrayBuffer2Utf8Str(buff){return String.fromCharCode.apply(null,new Uint8Array(buff))}(state.buff);return state};SparkMD5.ArrayBuffer.prototype.setState=function(state){state.buff=function utf8Str2ArrayBuffer(str,returnUInt8Array){var i2,length=str.length,buff=new ArrayBuffer(length),arr=new Uint8Array(buff);for(i2=0;i2<length;i2+=1)arr[i2]=str.charCodeAt(i2);return returnUInt8Array?arr:buff}(state.buff,true);return SparkMD5.prototype.setState.call(this,state)};SparkMD5.ArrayBuffer.prototype.destroy=SparkMD5.prototype.destroy;SparkMD5.ArrayBuffer.prototype._finish=SparkMD5.prototype._finish;SparkMD5.ArrayBuffer.hash=function(arr,raw){var hash2=function md51_array(a2){var i2,length,tail,tmp,lo,hi,n3=a2.length,state=[1732584193,-271733879,-1732584194,271733878];for(i2=64;i2<=n3;i2+=64)md5cycle(state,md5blk_array(a2.subarray(i2-64,i2)));length=(a2=i2-64<n3?a2.subarray(i2-64):new Uint8Array(0)).length;tail=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i2=0;i2<length;i2+=1)tail[i2>>2]|=a2[i2]<<(i2%4<<3);tail[i2>>2]|=128<<(i2%4<<3);if(i2>55){md5cycle(state,tail);for(i2=0;i2<16;i2+=1)tail[i2]=0}tmp=(tmp=8*n3).toString(16).match(/(.*?)(.{0,8})$/);lo=parseInt(tmp[2],16);hi=parseInt(tmp[1],16)||0;tail[14]=lo;tail[15]=hi;md5cycle(state,tail);return state}(new Uint8Array(arr)),ret=hex(hash2);return raw?hexToBinaryString(ret):ret};return SparkMD5}))}}),require_vuvuzela=__commonJS({"node_modules/vuvuzela/index.js"(exports){"use strict";exports.stringify=function stringify4(input){var queue2=[];queue2.push({obj:input});for(var next,obj,val2,i2,arrayPrefix,keys2,k2,key2,value,objPrefix,res2="";next=queue2.pop();){obj=next.obj;res2+=next.prefix||"";if(val2=next.val||"")res2+=val2;else if("object"!=typeof obj)res2+="undefined"==typeof obj?null:JSON.stringify(obj);else if(null===obj)res2+="null";else if(Array.isArray(obj)){queue2.push({val:"]"});for(i2=obj.length-1;i2>=0;i2--){arrayPrefix=0===i2?"":",";queue2.push({obj:obj[i2],prefix:arrayPrefix})}queue2.push({val:"["})}else{keys2=[];for(k2 in obj)if(obj.hasOwnProperty(k2))keys2.push(k2);queue2.push({val:"}"});for(i2=keys2.length-1;i2>=0;i2--){value=obj[key2=keys2[i2]];objPrefix=i2>0?",":"";objPrefix+=JSON.stringify(key2)+":";queue2.push({obj:value,prefix:objPrefix})}queue2.push({val:"{"})}}return res2};function pop2(obj,stack,metaStack){var lastMetaElement=metaStack[metaStack.length-1];if(obj===lastMetaElement.element){metaStack.pop();lastMetaElement=metaStack[metaStack.length-1]}var element2=lastMetaElement.element,lastElementIndex=lastMetaElement.index;if(Array.isArray(element2))element2.push(obj);else if(lastElementIndex===stack.length-2)element2[stack.pop()]=obj;else stack.push(obj)}exports.parse=function(str){for(var collationIndex2,parsedNum,numChar,parsedString,lastCh,numConsecutiveSlashes,ch4,arrayElement,objElement,stack=[],metaStack=[],i2=0;;){if("}"===(collationIndex2=str[i2++])||"]"===collationIndex2||"undefined"==typeof collationIndex2)if(1===stack.length)return stack.pop();else{pop2(stack.pop(),stack,metaStack);continue}switch(collationIndex2){case" ":case"\t":case"\n":case":":case",":break;case"n":i2+=3;pop2(null,stack,metaStack);break;case"t":i2+=3;pop2(true,stack,metaStack);break;case"f":i2+=4;pop2(false,stack,metaStack);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":parsedNum="";i2--;for(;;){numChar=str[i2++];if(/[\d\.\-e\+]/.test(numChar))parsedNum+=numChar;else{i2--;break}}pop2(parseFloat(parsedNum),stack,metaStack);break;case'"':parsedString="";lastCh=void 0;numConsecutiveSlashes=0;for(;'"'!==(ch4=str[i2++])||"\\"===lastCh&&numConsecutiveSlashes%2==1;){parsedString+=ch4;if("\\"===(lastCh=ch4))numConsecutiveSlashes++;else numConsecutiveSlashes=0}pop2(JSON.parse('"'+parsedString+'"'),stack,metaStack);break;case"[":arrayElement={element:[],index:stack.length};stack.push(arrayElement.element);metaStack.push(arrayElement);break;case"{":objElement={element:{},index:stack.length};stack.push(objElement.element);metaStack.push(objElement);break;default:throw new Error("unexpectedly reached end of input: "+collationIndex2)}}}}}),require_pouchdb_wrappers=__commonJS({"node_modules/pouchdb-wrappers/index.js"(exports,module2){"use strict";function replacementMethod(base,method){return function(...args){function doMethod(){let callback=null;const minArgs="query"===method?1:0;if(args.length>minArgs&&"function"==typeof args[args.length-1])callback=args.pop();let prev=base._originals[method].bind(base);for(const handler of base._handlers[method])prev=handler.bind(base,prev);const result=prev(...args);if(result.then&&callback)(function nodify(promise2,callback){promise2.then(((...args)=>{callback(null,...args)})).catch((err2=>{callback(err2)}))})(result,callback);return result}if("changes"!==method&&base.taskqueue&&!base.taskqueue.isReady)return new Promise(((resolve,reject)=>{base.taskqueue.addTask((error=>{if(error)reject(error);else resolve()}))})).then(doMethod);else return doMethod()}}var toExport={install:function installWrappers(base,handlers={}){if(!base._originals||!base._handlers){base._originals={};base._handlers={}}for(const[method,handler]of Object.entries(handlers)){if(!(method in base))throw new Error(`Method '${method}' does not exist on given base, so it cannot be wrapped.`);if(!(method in base._originals))base._originals[method]=base[method];if(method in base._handlers)base._handlers[method].unshift(handler);else{base._handlers[method]=[handler];base[method]=replacementMethod(base,method)}}},uninstall:function uninstallWrappers(base,handlers){if(!base._originals||!base._handlers)throw new Error("No wrapper methods installed, so no methods can be uninstalled.");for(const[method,handler]of Object.entries(handlers)){const errorMessage=`Wrapper method for '${method}' not installed: ${handler.toString()}`;if(!(method in base._handlers))throw new Error(errorMessage);const i2=base._handlers[method].indexOf(handler);if(-1===i2)throw new Error(errorMessage);else base._handlers[method].splice(i2,1)}}};try{module2.exports=toExport}catch(e4){}try{window.PouchDBWrappers=toExport}catch(e4){}}}),require_transform_pouch=__commonJS({"node_modules/transform-pouch/index.js"(exports,module2){"use strict";var wrappers=require_pouchdb_wrappers();function isntInternalKey(key2){return"_"!==key2[0]}function isUntransformable(doc){if("string"==typeof doc._id&&/^_local/.test(doc._id))return true;if(doc._deleted)return 0===Object.keys(doc).filter(isntInternalKey).length;else return false}module2.exports={transform:transform2,filter:transform2};function transform2(config){const incoming=function(doc){if(!isUntransformable(doc)&&config.incoming)return config.incoming(doc);else return doc},outgoing=function(doc){if(!isUntransformable(doc)&&config.outgoing)return config.outgoing(doc);else return doc},handlers={async get(orig,...args){const response=await orig(...args);if(Array.isArray(response)){await Promise.all(response.map((async row=>{if(row.ok)row.ok=await outgoing(row.ok)})));return response}else return outgoing(response)},async bulkDocs(orig,docs,...args){if(docs.docs)docs.docs=await Promise.all(docs.docs.map(incoming));else docs=await Promise.all(docs.map(incoming));return orig(docs,...args)},async allDocs(orig,...args){const response=await orig(...args);await Promise.all(response.rows.map((async row=>{if(row.doc)row.doc=await outgoing(row.doc)})));return response},async bulkGet(orig,...args){const mapDoc=async doc=>{if(doc.ok)return{ok:await outgoing(doc.ok)};else return doc};let{results,...res2}=await orig(...args);results=await Promise.all(results.map((async result=>{const{id,docs}=result;if(id&&docs&&Array.isArray(docs))return{id,docs:await Promise.all(docs.map(mapDoc))};else return result})));return{results,...res2}},changes(orig,...args){async function modifyChange(change){if(change.doc){change.doc=await outgoing(change.doc);return change}return change}async function modifyChanges(res2){if(res2.results){res2.results=await Promise.all(res2.results.map(modifyChange));return res2}return res2}const changes3=orig(...args),{on:origOn,then:origThen}=changes3;return Object.assign(changes3,{on(event,listener){const origListener=listener;if("change"===event)listener=async change=>{origListener(await modifyChange(change))};else if("complete"===event)listener=async res2=>{origListener(await modifyChanges(res2))};return origOn.call(changes3,event,listener)},then:(resolve,reject)=>origThen.call(changes3,modifyChanges).then(resolve,reject)})}};if("http"===this.type()){handlers.put=async function(orig,doc,...args){return orig(doc=await incoming(doc),...args)};handlers.query=async function(orig,...args){const response=await orig(...args);await Promise.all(response.rows.map((async row=>{if(row.doc)row.doc=await outgoing(row.doc)})));return response}}wrappers.install(this,handlers)}if("undefined"!=typeof window&&window.PouchDB)window.PouchDB.plugin(exports)}}),main_exports={};__export(main_exports,{default:()=>ObsidianLiveSyncPlugin});module.exports=__toCommonJS(main_exports);var LOG_LEVEL_DEBUG=-1,LOG_LEVEL_VERBOSE=16,LOG_LEVEL_INFO=32,LOG_LEVEL_NOTICE=64,LOG_LEVEL_URGENT=128,LOG_KIND_INFO=0,LOG_KIND_DEBUG=1,LOG_KIND_VERBOSE=2,LOG_KIND_WARNING=4,LOG_KIND_ERROR=8,LEVEL_DEBUG=LOG_LEVEL_DEBUG,LEVEL_INFO=LOG_LEVEL_INFO,LEVEL_NOTICE=LOG_LEVEL_NOTICE,LEVEL_URGENT=LOG_LEVEL_URGENT,LEVEL_VERBOSE=LOG_LEVEL_VERBOSE,defaultLoggerEnv={minLogLevel:LOG_LEVEL_INFO},defaultLogger=function defaultLogger2(message,level=LEVEL_INFO,key2){if(level<defaultLoggerEnv.minLogLevel)return;const newMessage=`${(new Date).toLocaleString()}\t${level}\t${"string"==typeof message?message:message instanceof Error?`${message.name}:${message.message}`:JSON.stringify(message,null,2)}`;if(level&LOG_KIND_DEBUG)console.debug(newMessage);else if(level&LOG_KIND_WARNING)console.warn(newMessage);else if(level&LOG_KIND_ERROR)console.error(newMessage);else if(level&LOG_KIND_VERBOSE)console.info(newMessage);else console.log(newMessage);if(message instanceof Error)console.dir(message.stack)},_logger=defaultLogger;function setGlobalLogFunction(logger2){_logger=logger2}function Logger(message,level,key2){_logger(message,level,key2)}function __logger(message,baseLevel,flagsOrKey,key2){let level=baseLevel;if("string"==typeof flagsOrKey)key2=flagsOrKey;else if(void 0!==flagsOrKey)level|=flagsOrKey;_logger(message,level,key2)}function info(message,flagsOrKey,key2){__logger(message,LEVEL_INFO,flagsOrKey,key2)}function debug(message,flagsOrKey,key2){__logger(message,LEVEL_INFO,flagsOrKey,key2)}function verbose(message,flagsOrKey,key2){__logger(message,LEVEL_INFO,flagsOrKey,key2)}function notice(message,flagsOrKey,key2){__logger(message,LEVEL_INFO,flagsOrKey,key2)}var RESULT_TIMED_OUT=Symbol("timed out"),RESULT_NOT_FOUND=Symbol("NotFound"),MAX_DOC_SIZE=1e3,MAX_DOC_SIZE_BIN=102400,VER=10,RECENT_MODIFIED_DOCS_QTY=30,LEAF_WAIT_TIMEOUT=9e4,REPLICATION_BUSY_TIMEOUT=3e6,CANCELLED=Symbol("cancelled"),AUTO_MERGED=Symbol("auto_merged"),NOT_CONFLICTED=Symbol("not_conflicted"),MISSING_OR_ERROR=Symbol("missing_or_error"),LEAVE_TO_SUBSEQUENT=Symbol("leave_to_subsequent_proc"),TIME_ARGUMENT_INFINITY=Symbol("infinity"),VERSIONING_DOCID="obsydian_livesync_version",MILESTONE_DOCID="_local/obsydian_livesync_milestone",NODEINFO_DOCID="_local/obsydian_livesync_nodeinfo",MODE_SELECTIVE=0,MODE_AUTOMATIC=1,MODE_PAUSED=2,MODE_SHINY=3,REMOTE_COUCHDB="",REMOTE_MINIO="MINIO",SETTING_VERSION_INITIAL=0,SETTING_VERSION_SUPPORT_CASE_INSENSITIVE=10,CURRENT_SETTING_VERSION=SETTING_VERSION_SUPPORT_CASE_INSENSITIVE,DEFAULT_SETTINGS={remoteType:REMOTE_COUCHDB,useCustomRequestHandler:false,couchDB_URI:"",couchDB_USER:"",couchDB_PASSWORD:"",couchDB_DBNAME:"",liveSync:false,syncOnSave:false,syncOnStart:false,savingDelay:200,lessInformationInLog:false,gcDelay:300,versionUpFlash:"",minimumChunkSize:20,longLineThreshold:250,showVerboseLog:false,suspendFileWatching:false,trashInsteadDelete:true,periodicReplication:false,periodicReplicationInterval:60,syncOnFileOpen:false,encrypt:false,passphrase:"",usePathObfuscation:false,doNotDeleteFolder:false,resolveConflictsByNewerFile:false,batchSave:false,batchSaveMinimumDelay:5,batchSaveMaximumDelay:60,deviceAndVaultName:"",usePluginSettings:false,showOwnPlugins:false,showStatusOnEditor:true,showStatusOnStatusbar:true,showOnlyIconsOnEditor:false,usePluginSync:false,autoSweepPlugins:false,autoSweepPluginsPeriodic:false,notifyPluginOrSettingUpdated:false,checkIntegrityOnSave:false,batch_size:25,batches_limit:25,useHistory:false,disableRequestURI:false,skipOlderFilesOnSync:true,checkConflictOnlyOnOpen:false,showMergeDialogOnlyOnActive:false,syncInternalFiles:false,syncInternalFilesBeforeReplication:false,syncInternalFilesIgnorePatterns:"\\/node_modules\\/, \\/\\.git\\/, \\/obsidian-livesync\\/",syncInternalFilesInterval:60,additionalSuffixOfDatabaseName:"",ignoreVersionCheck:false,lastReadUpdates:0,deleteMetadataOfDeletedFiles:false,syncIgnoreRegEx:"",syncOnlyRegEx:"",customChunkSize:0,readChunksOnline:true,watchInternalFileChanges:true,automaticallyDeleteMetadataOfDeletedFiles:0,disableMarkdownAutoMerge:false,writeDocumentsIfConflicted:false,useDynamicIterationCount:false,syncAfterMerge:false,configPassphraseStore:"",encryptedPassphrase:"",encryptedCouchDBConnection:"",permitEmptyPassphrase:false,useIndexedDBAdapter:true,useTimeouts:false,writeLogToTheFile:false,doNotPaceReplication:false,hashCacheMaxCount:300,hashCacheMaxAmount:50,concurrencyOfReadChunksOnline:40,minimumIntervalOfReadChunksOnline:50,hashAlg:"xxhash64",suspendParseReplicationResult:false,doNotSuspendOnFetching:false,useIgnoreFiles:false,ignoreFiles:".gitignore",syncOnEditorSave:false,pluginSyncExtendedSetting:{},syncMaxSizeInMB:50,settingSyncFile:"",writeCredentialsForSettingSync:false,notifyAllSettingSyncFile:false,isConfigured:void 0,settingVersion:CURRENT_SETTING_VERSION,enableCompression:false,accessKey:"",bucket:"",endpoint:"",region:"auto",secretKey:"",useEden:false,maxChunksInEden:10,maxTotalLengthInEden:1024,maxAgeInEden:10,disableCheckingConfigMismatch:false,displayLanguage:"",enableChunkSplitterV2:false,disableWorkerForGeneratingChunks:false,processSmallFilesInUIThread:false,notifyThresholdOfRemoteStorageSize:-1,usePluginSyncV2:false,usePluginEtc:false,handleFilenameCaseSensitive:void 0,doNotUseFixedRevisionForChunks:void 0,showLongerLogInsideEditor:false,sendChunksBulk:false,sendChunksBulkMaxSize:1,useSegmenter:false,useAdvancedMode:false,usePowerUserMode:false,useEdgeCaseMode:false,enableDebugTools:false},PREFERRED_SETTING_CLOUDANT={syncMaxSizeInMB:50,customChunkSize:0,sendChunksBulkMaxSize:1,concurrencyOfReadChunksOnline:100,minimumIntervalOfReadChunksOnline:333,doNotUseFixedRevisionForChunks:false,useSegmenter:true,usePluginSyncV2:true,handleFilenameCaseSensitive:false},PREFERRED_SETTING_SELF_HOSTED={...PREFERRED_SETTING_CLOUDANT,customChunkSize:50,sendChunksBulkMaxSize:1,concurrencyOfReadChunksOnline:30,minimumIntervalOfReadChunksOnline:25},PREFERRED_JOURNAL_SYNC={...PREFERRED_SETTING_CLOUDANT,customChunkSize:10,concurrencyOfReadChunksOnline:30,minimumIntervalOfReadChunksOnline:25},PREFERRED_SETTING_PERFORMANT={useSegmenter:true};function isMetaEntry(entry){return"children"in entry}var TweakValuesShouldMatchedTemplate={minimumChunkSize:20,longLineThreshold:250,encrypt:false,usePathObfuscation:false,enableCompression:false,useEden:false,customChunkSize:0,useDynamicIterationCount:false,hashAlg:"xxhash64",enableChunkSplitterV2:true,maxChunksInEden:10,maxTotalLengthInEden:1024,maxAgeInEden:10,usePluginSyncV2:false,handleFilenameCaseSensitive:false,doNotUseFixedRevisionForChunks:false,useSegmenter:false},CompatibilityBreakingTweakValues=["encrypt","usePathObfuscation","useDynamicIterationCount","hashAlg","handleFilenameCaseSensitive","doNotUseFixedRevisionForChunks"],TweakValuesRecommendedTemplate={useIgnoreFiles:false,useCustomRequestHandler:false,batch_size:25,batches_limit:25,useIndexedDBAdapter:true,useTimeouts:false,readChunksOnline:true,hashCacheMaxCount:300,hashCacheMaxAmount:50,concurrencyOfReadChunksOnline:40,minimumIntervalOfReadChunksOnline:50,ignoreFiles:".gitignore",syncMaxSizeInMB:50,enableChunkSplitterV2:true,usePluginSyncV2:true,handleFilenameCaseSensitive:false,doNotUseFixedRevisionForChunks:false},TweakValuesDefault={usePluginSyncV2:false},configurationNames={minimumChunkSize:{name:"Minimum Chunk Size (Not Configurable from the UI Now)."},longLineThreshold:{name:"Longest chunk line threshold value (Not Configurable from the UI Now)."},encrypt:{name:"End-to-End Encryption",desc:"Encrypt contents on the remote database. If you use the plugin's synchronization feature, enabling this is recommended."},usePathObfuscation:{name:"Path Obfuscation"},enableCompression:{name:"Data Compression",status:"EXPERIMENTAL"},useEden:{name:"Incubate Chunks in Document",desc:"If enabled, newly created chunks are temporarily kept within the document, and graduated to become independent chunks once stabilised.",status:"BETA"},customChunkSize:{name:"Enhance chunk size"},useDynamicIterationCount:{name:"Use dynamic iteration count",status:"EXPERIMENTAL"},hashAlg:{name:"The Hash algorithm for chunk IDs",status:"EXPERIMENTAL"},enableChunkSplitterV2:{name:"Use splitting-limit-capped chunk splitter",desc:"If enabled, chunks will be split into no more than 100 items. However, dedupe is slightly weaker."},maxChunksInEden:{name:"Maximum Incubating Chunks",desc:"The maximum number of chunks that can be incubated within the document. Chunks exceeding this number will immediately graduate to independent chunks."},maxTotalLengthInEden:{name:"Maximum Incubating Chunk Size",desc:"The maximum total size of chunks that can be incubated within the document. Chunks exceeding this size will immediately graduate to independent chunks."},maxAgeInEden:{name:"Maximum Incubation Period",desc:"The maximum duration for which chunks can be incubated within the document. Chunks exceeding this period will graduate to independent chunks."},usePluginSyncV2:{name:"Per-file-saved customization sync",desc:"If enabled per-filed efficient customization sync will be used. We need a small migration when enabling this. And all devices should be updated to v0.23.18. Once we enabled this, we lost a compatibility with old versions."},handleFilenameCaseSensitive:{name:"Handle files as Case-Sensitive",desc:"If this enabled, All files are handled as case-Sensitive (Previous behaviour)."},doNotUseFixedRevisionForChunks:{name:"Compute revisions for chunks (Previous behaviour)",desc:"If this enabled, all chunks will be stored with the revision made from its content. (Previous behaviour)"},useSegmenter:{name:"Use Segmented-splitter",desc:"If this enabled, chunks will be split into semantically meaningful segments. Not all platforms support this feature."}},LEVEL_ADVANCED="ADVANCED",LEVEL_POWER_USER="POWER_USER",LEVEL_EDGE_CASE="EDGE_CASE";function statusDisplay(status){if(!status)return"";if("EXPERIMENTAL"==status)return" (Experimental)";if("ALPHA"==status)return" (Alpha)";if("BETA"==status)return" (Beta)";else return` (${status})`}function confName(key2,alt=""){var _a5,_b2;if(key2 in configurationNames)return`${null==(_a5=configurationNames[key2])?void 0:_a5.name}${statusDisplay(null==(_b2=configurationNames[key2])?void 0:_b2.status)}`;else return`${alt||""}`}function confDesc(key2,alt){var _a5,_b2,_c2;if(key2 in configurationNames)if(null==(_a5=configurationNames[key2])?void 0:_a5.desc)return`${null==(_b2=configurationNames[key2])?void 0:_b2.name}${statusDisplay(null==(_c2=configurationNames[key2])?void 0:_c2.status)}`;else return alt;else return alt}var _root,_hasMagic,_uflag,_parts,_parent,_parentIndex,_negs,_filledNegs,_options,_toString,_emptyExt,_AST_instances,fillNegs_fn,_AST_static,parseAST_fn,partsToRegExp_fn,parseGlob_fn,TweakValuesTemplate={...TweakValuesRecommendedTemplate,...TweakValuesShouldMatchedTemplate},DEVICE_ID_PREFERRED="PREFERRED",PREFIXMD_LOGFILE="livesync_log_",PREFIXMD_LOGFILE_UC="LIVESYNC_LOG_",FLAGMD_REDFLAG="redflag.md",FLAGMD_REDFLAG2="redflag2.md",FLAGMD_REDFLAG2_HR="flag_rebuild.md",FLAGMD_REDFLAG3="redflag3.md",FLAGMD_REDFLAG3_HR="flag_fetch.md",SYNCINFO_ID="syncinfo",SALT_OF_PASSPHRASE="rHGMPtr6oWw7VSa3W3wpa8fT8U",PREFIX_OBFUSCATED="f:",PREFIX_CHUNK="h:",PREFIX_ENCRYPTED_CHUNK="h:+",import_obsidian=require("obsidian"),import_obsidian2=require("obsidian"),import_diff_match_patch=__toESM(require_diff_match_patch(),1),normalizePath=import_obsidian2.normalizePath,PERIODIC_PLUGIN_SWEEP=60,CHeader="h:",PSCHeader="ps:",PSCHeaderEnd="ps;",ICHeader="i:",ICHeaderEnd="i;",ICHeaderLength=ICHeader.length,ICXHeader="ix:",FileWatchEventQueueMax=10,configURIBase="obsidian://setuplivesync?settings=",LRUCache=class{constructor(maxCache,maxCacheLength,forwardOnly=false){Object.defineProperty(this,"cache",{enumerable:true,configurable:true,writable:true,value:new Map([])});Object.defineProperty(this,"revCache",{enumerable:true,configurable:true,writable:true,value:new Map([])});Object.defineProperty(this,"maxCache",{enumerable:true,configurable:true,writable:true,value:200});Object.defineProperty(this,"maxCachedLength",{enumerable:true,configurable:true,writable:true,value:5e7});Object.defineProperty(this,"cachedLength",{enumerable:true,configurable:true,writable:true,value:0});Object.defineProperty(this,"enableReversed",{enumerable:true,configurable:true,writable:true,value:true});this.maxCache=maxCache||200;this.maxCachedLength=1e6*(maxCacheLength||1);this.enableReversed=!forwardOnly;Logger(`Cache initialized ${this.maxCache} / ${this.maxCachedLength}`,LOG_LEVEL_VERBOSE)}clear(){this.cache.clear();this.revCache.clear()}has(key2){return this.cache.has(key2)}get(key2){const v2=this.cache.get(key2);if(v2){this.cache.delete(key2);this.cache.set(key2,v2);if(this.enableReversed){this.revCache.delete(v2);this.revCache.set(v2,key2)}}return v2}revGet(value){const key2=this.revCache.get(value);if(key2){this.cache.delete(key2);this.revCache.delete(value);this.cache.set(key2,value);this.revCache.set(value,key2)}return key2}set(key2,value){this.cache.set(key2,value);if(this.enableReversed)this.revCache.set(value,key2);this.cachedLength+=`${value}`.length;if(this.cache.size>this.maxCache||this.cachedLength>this.maxCachedLength)for(const[key3,value2]of this.cache){this.cache.delete(key3);if(this.enableReversed)this.revCache.delete(value2);this.cachedLength-=`${value2}`.length;if(this.cache.size<=this.maxCache&&this.cachedLength<=this.maxCachedLength)break}}},MAX_PATTERN_LENGTH=65536,assertValidPattern=pattern=>{if("string"!=typeof pattern)throw new TypeError("invalid pattern");if(pattern.length>MAX_PATTERN_LENGTH)throw new TypeError("pattern is too long")},posixClasses={"[:alnum:]":["\\p{L}\\p{Nl}\\p{Nd}",true],"[:alpha:]":["\\p{L}\\p{Nl}",true],"[:ascii:]":["\\x00-\\x7f",false],"[:blank:]":["\\p{Zs}\\t",true],"[:cntrl:]":["\\p{Cc}",true],"[:digit:]":["\\p{Nd}",true],"[:graph:]":["\\p{Z}\\p{C}",true,true],"[:lower:]":["\\p{Ll}",true],"[:print:]":["\\p{C}",true],"[:punct:]":["\\p{P}",true],"[:space:]":["\\p{Z}\\t\\r\\n\\v\\f",true],"[:upper:]":["\\p{Lu}",true],"[:word:]":["\\p{L}\\p{Nl}\\p{Nd}\\p{Pc}",true],"[:xdigit:]":["A-Fa-f0-9",false]},braceEscape=s2=>s2.replace(/[[\]\\-]/g,"\\$&"),regexpEscape=s2=>s2.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),rangesToString=ranges=>ranges.join(""),parseClass=(glob,position)=>{const pos=position;if("["!==glob.charAt(pos))throw new Error("not in a brace expression");const ranges=[],negs=[];let i2=pos+1,sawStart=false,uflag=false,escaping=false,negate3=false,endPos=pos,rangeStart="";WHILE:for(;i2<glob.length;){const c2=glob.charAt(i2);if("!"!==c2&&"^"!==c2||i2!==pos+1){if("]"===c2&&sawStart&&!escaping){endPos=i2+1;break}sawStart=true;if("\\"===c2)if(!escaping){escaping=true;i2++;continue}if("["===c2&&!escaping)for(const[cls,[unip,u2,neg]]of Object.entries(posixClasses))if(glob.startsWith(cls,i2)){if(rangeStart)return["$.",false,glob.length-pos,true];i2+=cls.length;if(neg)negs.push(unip);else ranges.push(unip);uflag=uflag||u2;continue WHILE}escaping=false;if(!rangeStart)if(!glob.startsWith("-]",i2+1))if(!glob.startsWith("-",i2+1)){ranges.push(braceEscape(c2));i2++}else{rangeStart=c2;i2+=2}else{ranges.push(braceEscape(c2+"-"));i2+=2}else{if(c2>rangeStart)ranges.push(braceEscape(rangeStart)+"-"+braceEscape(c2));else if(c2===rangeStart)ranges.push(braceEscape(c2));rangeStart="";i2++}}else{negate3=true;i2++}}if(endPos<i2)return["",false,0,false];if(!ranges.length&&!negs.length)return["$.",false,glob.length-pos,true];if(0===negs.length&&1===ranges.length&&/^\\?.$/.test(ranges[0])&&!negate3){const r2=2===ranges[0].length?ranges[0].slice(-1):ranges[0];return[regexpEscape(r2),false,endPos-pos,false]}const sranges="["+(negate3?"^":"")+rangesToString(ranges)+"]",snegs="["+(negate3?"":"^")+rangesToString(negs)+"]";return[ranges.length&&negs.length?"("+sranges+"|"+snegs+")":ranges.length?sranges:snegs,uflag,endPos-pos,true]},unescape2=(s2,{windowsPathsNoEscape=false}={})=>windowsPathsNoEscape?s2.replace(/\[([^\/\\])\]/g,"$1"):s2.replace(/((?!\\).|^)\[([^\/\\])\]/g,"$1$2").replace(/\\([^\/])/g,"$1"),types=new Set(["!","?","+","*","@"]),isExtglobType=c2=>types.has(c2),startNoTraversal="(?!(?:^|/)\\.\\.?(?:$|/))",startNoDot="(?!\\.)",addPatternStart=new Set(["[","."]),justDots=new Set(["..","."]),reSpecials=new Set("().*{}+?[]^$\\!"),regExpEscape=s2=>s2.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),qmark="[^/]",star=qmark+"*?",starNoEmpty=qmark+"+?",_AST=class _AST{constructor(type,parent,options={}){__privateAdd(this,_AST_instances);__publicField(this,"type");__privateAdd(this,_root);__privateAdd(this,_hasMagic);__privateAdd(this,_uflag,false);__privateAdd(this,_parts,[]);__privateAdd(this,_parent);__privateAdd(this,_parentIndex);__privateAdd(this,_negs);__privateAdd(this,_filledNegs,false);__privateAdd(this,_options);__privateAdd(this,_toString);__privateAdd(this,_emptyExt,false);this.type=type;if(type)__privateSet(this,_hasMagic,true);__privateSet(this,_parent,parent);__privateSet(this,_root,__privateGet(this,_parent)?__privateGet(__privateGet(this,_parent),_root):this);__privateSet(this,_options,__privateGet(this,_root)===this?options:__privateGet(__privateGet(this,_root),_options));__privateSet(this,_negs,__privateGet(this,_root)===this?[]:__privateGet(__privateGet(this,_root),_negs));if("!"===type&&!__privateGet(__privateGet(this,_root),_filledNegs))__privateGet(this,_negs).push(this);__privateSet(this,_parentIndex,__privateGet(this,_parent)?__privateGet(__privateGet(this,_parent),_parts).length:0)}get hasMagic(){if(void 0!==__privateGet(this,_hasMagic))return __privateGet(this,_hasMagic);for(const p2 of __privateGet(this,_parts))if("string"!=typeof p2)if(p2.type||p2.hasMagic)return __privateSet(this,_hasMagic,true);return __privateGet(this,_hasMagic)}toString(){if(void 0!==__privateGet(this,_toString))return __privateGet(this,_toString);if(!this.type)return __privateSet(this,_toString,__privateGet(this,_parts).map((p2=>String(p2))).join(""));else return __privateSet(this,_toString,this.type+"("+__privateGet(this,_parts).map((p2=>String(p2))).join("|")+")")}push(...parts){for(const p2 of parts)if(""!==p2){if("string"!=typeof p2&&!(p2 instanceof _AST&&__privateGet(p2,_parent)===this))throw new Error("invalid part: "+p2);__privateGet(this,_parts).push(p2)}}toJSON(){var _a5;const ret=null===this.type?__privateGet(this,_parts).slice().map((p2=>"string"==typeof p2?p2:p2.toJSON())):[this.type,...__privateGet(this,_parts).map((p2=>p2.toJSON()))];if(this.isStart()&&!this.type)ret.unshift([]);if(this.isEnd()&&(this===__privateGet(this,_root)||__privateGet(__privateGet(this,_root),_filledNegs)&&"!"===(null==(_a5=__privateGet(this,_parent))?void 0:_a5.type)))ret.push({});return ret}isStart(){var _a5;if(__privateGet(this,_root)===this)return true;if(!(null==(_a5=__privateGet(this,_parent))?void 0:_a5.isStart()))return false;if(0===__privateGet(this,_parentIndex))return true;const p2=__privateGet(this,_parent);for(let i2=0;i2<__privateGet(this,_parentIndex);i2++){const pp=__privateGet(p2,_parts)[i2];if(!(pp instanceof _AST&&"!"===pp.type))return false}return true}isEnd(){var _a5,_b2,_c2;if(__privateGet(this,_root)===this)return true;if("!"===(null==(_a5=__privateGet(this,_parent))?void 0:_a5.type))return true;if(!(null==(_b2=__privateGet(this,_parent))?void 0:_b2.isEnd()))return false;if(!this.type)return null==(_c2=__privateGet(this,_parent))?void 0:_c2.isEnd();const pl=__privateGet(this,_parent)?__privateGet(__privateGet(this,_parent),_parts).length:0;return __privateGet(this,_parentIndex)===pl-1}copyIn(part){if("string"==typeof part)this.push(part);else this.push(part.clone(this))}clone(parent){const c2=new _AST(this.type,parent);for(const p2 of __privateGet(this,_parts))c2.copyIn(p2);return c2}static fromGlob(pattern,options={}){var _a5;const ast=new _AST(null,void 0,options);__privateMethod(_a5=_AST,_AST_static,parseAST_fn).call(_a5,pattern,ast,0,options);return ast}toMMPattern(){if(this!==__privateGet(this,_root))return __privateGet(this,_root).toMMPattern();const glob=this.toString(),[re,body,hasMagic,uflag]=this.toRegExpSource();if(!(hasMagic||__privateGet(this,_hasMagic)||__privateGet(this,_options).nocase&&!__privateGet(this,_options).nocaseMagicOnly&&glob.toUpperCase()!==glob.toLowerCase()))return body;const flags=(__privateGet(this,_options).nocase?"i":"")+(uflag?"u":"");return Object.assign(new RegExp(`^${re}$`,flags),{_src:re,_glob:glob})}get options(){return __privateGet(this,_options)}toRegExpSource(allowDot){var _a5;const dot=null!=allowDot?allowDot:!!__privateGet(this,_options).dot;if(__privateGet(this,_root)===this)__privateMethod(this,_AST_instances,fillNegs_fn).call(this);if(!this.type){const noEmpty=this.isStart()&&this.isEnd(),src=__privateGet(this,_parts).map((p2=>{var _a6;const[re,_,hasMagic,uflag]="string"==typeof p2?__privateMethod(_a6=_AST,_AST_static,parseGlob_fn).call(_a6,p2,__privateGet(this,_hasMagic),noEmpty):p2.toRegExpSource(allowDot);__privateSet(this,_hasMagic,__privateGet(this,_hasMagic)||hasMagic);__privateSet(this,_uflag,__privateGet(this,_uflag)||uflag);return re})).join("");let start2="";if(this.isStart())if("string"==typeof __privateGet(this,_parts)[0])if(!(1===__privateGet(this,_parts).length&&justDots.has(__privateGet(this,_parts)[0]))){const aps=addPatternStart,needNoTrav=dot&&aps.has(src.charAt(0))||src.startsWith("\\.")&&aps.has(src.charAt(2))||src.startsWith("\\.\\.")&&aps.has(src.charAt(4)),needNoDot=!dot&&!allowDot&&aps.has(src.charAt(0));start2=needNoTrav?startNoTraversal:needNoDot?startNoDot:""}let end="";if(this.isEnd()&&__privateGet(__privateGet(this,_root),_filledNegs)&&"!"===(null==(_a5=__privateGet(this,_parent))?void 0:_a5.type))end="(?:$|\\/)";return[start2+src+end,unescape2(src),__privateSet(this,_hasMagic,!!__privateGet(this,_hasMagic)),__privateGet(this,_uflag)]}const repeated="*"===this.type||"+"===this.type,start="!"===this.type?"(?:(?!(?:":"(?:";let body=__privateMethod(this,_AST_instances,partsToRegExp_fn).call(this,dot);if(this.isStart()&&this.isEnd()&&!body&&"!"!==this.type){const s2=this.toString();__privateSet(this,_parts,[s2]);this.type=null;__privateSet(this,_hasMagic,void 0);return[s2,unescape2(this.toString()),false,false]}let bodyDotAllowed=!repeated||allowDot||dot||!startNoDot?"":__privateMethod(this,_AST_instances,partsToRegExp_fn).call(this,true);if(bodyDotAllowed===body)bodyDotAllowed="";if(bodyDotAllowed)body=`(?:${body})(?:${bodyDotAllowed})*?`;let final="";if("!"===this.type&&__privateGet(this,_emptyExt))final=(this.isStart()&&!dot?startNoDot:"")+starNoEmpty;else final=start+body+("!"===this.type?"))"+(this.isStart()&&!dot&&!allowDot?startNoDot:"")+star+")":"@"===this.type?")":"?"===this.type?")?":"+"===this.type&&bodyDotAllowed?")":"*"===this.type&&bodyDotAllowed?")?":`)${this.type}`);return[final,unescape2(body),__privateSet(this,_hasMagic,!!__privateGet(this,_hasMagic)),__privateGet(this,_uflag)]}};_root=new WeakMap;_hasMagic=new WeakMap;_uflag=new WeakMap;_parts=new WeakMap;_parent=new WeakMap;_parentIndex=new WeakMap;_negs=new WeakMap;_filledNegs=new WeakMap;_options=new WeakMap;_toString=new WeakMap;_emptyExt=new WeakMap;_AST_instances=new WeakSet;fillNegs_fn=function(){if(this!==__privateGet(this,_root))throw new Error("should only call on root");if(__privateGet(this,_filledNegs))return this;this.toString();__privateSet(this,_filledNegs,true);let n3;for(;n3=__privateGet(this,_negs).pop();){if("!"!==n3.type)continue;let p2=n3,pp=__privateGet(p2,_parent);for(;pp;){for(let i2=__privateGet(p2,_parentIndex)+1;!pp.type&&i2<__privateGet(pp,_parts).length;i2++)for(const part of __privateGet(n3,_parts)){if("string"==typeof part)throw new Error("string part in extglob AST??");part.copyIn(__privateGet(pp,_parts)[i2])}p2=pp;pp=__privateGet(p2,_parent)}}return this};_AST_static=new WeakSet;parseAST_fn=function(str,ast,pos,opt){var _a5,_b2;let escaping=false,inBrace=false,braceStart=-1,braceNeg=false;if(null===ast.type){let i3=pos,acc2="";for(;i3<str.length;){const c2=str.charAt(i3++);if(!escaping&&"\\"!==c2)if(!inBrace){if("["===c2){inBrace=true;braceStart=i3;braceNeg=false;acc2+=c2;continue}if(opt.noext||!isExtglobType(c2)||"("!==str.charAt(i3))acc2+=c2;else{ast.push(acc2);acc2="";const ext2=new _AST(c2,ast);i3=__privateMethod(_a5=_AST,_AST_static,parseAST_fn).call(_a5,str,ext2,i3,opt);ast.push(ext2)}}else{if(i3===braceStart+1){if("^"===c2||"!"===c2)braceNeg=true}else if("]"===c2&&!(i3===braceStart+2&&braceNeg))inBrace=false;acc2+=c2}else{escaping=!escaping;acc2+=c2}}ast.push(acc2);return i3}let i2=pos+1,part=new _AST(null,ast);const parts=[];let acc="";for(;i2<str.length;){const c2=str.charAt(i2++);if(!escaping&&"\\"!==c2)if(!inBrace){if("["===c2){inBrace=true;braceStart=i2;braceNeg=false;acc+=c2;continue}if(!isExtglobType(c2)||"("!==str.charAt(i2))if("|"!==c2){if(")"===c2){if(""===acc&&0===__privateGet(ast,_parts).length)__privateSet(ast,_emptyExt,true);part.push(acc);acc="";ast.push(...parts,part);return i2}acc+=c2}else{part.push(acc);acc="";parts.push(part);part=new _AST(null,ast)}else{part.push(acc);acc="";const ext2=new _AST(c2,part);part.push(ext2);i2=__privateMethod(_b2=_AST,_AST_static,parseAST_fn).call(_b2,str,ext2,i2,opt)}}else{if(i2===braceStart+1){if("^"===c2||"!"===c2)braceNeg=true}else if("]"===c2&&!(i2===braceStart+2&&braceNeg))inBrace=false;acc+=c2}else{escaping=!escaping;acc+=c2}}ast.type=null;__privateSet(ast,_hasMagic,void 0);__privateSet(ast,_parts,[str.substring(pos-1)]);return i2};partsToRegExp_fn=function(dot){return __privateGet(this,_parts).map((p2=>{if("string"==typeof p2)throw new Error("string type in extglob ast??");const[re,_,_hasMagic2,uflag]=p2.toRegExpSource(dot);__privateSet(this,_uflag,__privateGet(this,_uflag)||uflag);return re})).filter((p2=>!(this.isStart()&&this.isEnd()&&!p2))).join("|")};parseGlob_fn=function(glob,hasMagic,noEmpty=false){let escaping=false,re="",uflag=false;for(let i2=0;i2<glob.length;i2++){const c2=glob.charAt(i2);if(!escaping)if("\\"!==c2){if("["===c2){const[src,needUflag,consumed,magic]=parseClass(glob,i2);if(consumed){re+=src;uflag=uflag||needUflag;i2+=consumed-1;hasMagic=hasMagic||magic;continue}}if("*"!==c2)if("?"!==c2)re+=regExpEscape(c2);else{re+=qmark;hasMagic=true}else{if(noEmpty&&"*"===glob)re+=starNoEmpty;else re+=star;hasMagic=true}}else if(i2===glob.length-1)re+="\\\\";else escaping=true;else{escaping=false;re+=(reSpecials.has(c2)?"\\":"")+c2}}return[re,unescape2(glob),!!hasMagic,uflag]};__privateAdd(_AST,_AST_static);var AST=_AST,escape=(s2,{windowsPathsNoEscape=false}={})=>windowsPathsNoEscape?s2.replace(/[?*()[\]]/g,"[$&]"):s2.replace(/[?*()[\]\\]/g,"\\$&"),import_brace_expansion=__toESM(require_brace_expansion(),1),minimatch=(p2,pattern,options={})=>{assertValidPattern(pattern);if(!options.nocomment&&"#"===pattern.charAt(0))return false;else return new Minimatch(pattern,options).match(p2)},starDotExtRE=/^\*+([^+@!?\*\[\(]*)$/,starDotExtTest=ext2=>f4=>!f4.startsWith(".")&&f4.endsWith(ext2),starDotExtTestDot=ext2=>f4=>f4.endsWith(ext2),starDotExtTestNocase=ext2=>{ext2=ext2.toLowerCase();return f4=>!f4.startsWith(".")&&f4.toLowerCase().endsWith(ext2)},starDotExtTestNocaseDot=ext2=>{ext2=ext2.toLowerCase();return f4=>f4.toLowerCase().endsWith(ext2)},starDotStarRE=/^\*+\.\*+$/,starDotStarTest=f4=>!f4.startsWith(".")&&f4.includes("."),starDotStarTestDot=f4=>"."!==f4&&".."!==f4&&f4.includes("."),dotStarRE=/^\.\*+$/,dotStarTest=f4=>"."!==f4&&".."!==f4&&f4.startsWith("."),starRE=/^\*+$/,starTest=f4=>0!==f4.length&&!f4.startsWith("."),starTestDot=f4=>0!==f4.length&&"."!==f4&&".."!==f4,qmarksRE=/^\?+([^+@!?\*\[\(]*)?$/,qmarksTestNocase=([$0,ext2=""])=>{const noext=qmarksTestNoExt([$0]);if(!ext2)return noext;ext2=ext2.toLowerCase();return f4=>noext(f4)&&f4.toLowerCase().endsWith(ext2)},qmarksTestNocaseDot=([$0,ext2=""])=>{const noext=qmarksTestNoExtDot([$0]);if(!ext2)return noext;ext2=ext2.toLowerCase();return f4=>noext(f4)&&f4.toLowerCase().endsWith(ext2)},qmarksTestDot=([$0,ext2=""])=>{const noext=qmarksTestNoExtDot([$0]);return!ext2?noext:f4=>noext(f4)&&f4.endsWith(ext2)},qmarksTest=([$0,ext2=""])=>{const noext=qmarksTestNoExt([$0]);return!ext2?noext:f4=>noext(f4)&&f4.endsWith(ext2)},qmarksTestNoExt=([$0])=>{const len=$0.length;return f4=>f4.length===len&&!f4.startsWith(".")},qmarksTestNoExtDot=([$0])=>{const len=$0.length;return f4=>f4.length===len&&"."!==f4&&".."!==f4},defaultPlatform="object"==typeof process&&process?"object"==typeof process.env&&process.env&&process.env.__MINIMATCH_TESTING_PLATFORM__||process.platform:"posix",path={win32:{sep:"\\"},posix:{sep:"/"}},sep="win32"===defaultPlatform?path.win32.sep:path.posix.sep;minimatch.sep=sep;var GLOBSTAR=Symbol("globstar **");minimatch.GLOBSTAR=GLOBSTAR;var qmark2="[^/]",star2=qmark2+"*?",twoStarDot="(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?",twoStarNoDot="(?:(?!(?:\\/|^)\\.).)*?",filter=(pattern,options={})=>p2=>minimatch(p2,pattern,options);minimatch.filter=filter;var ext=(a2,b3={})=>Object.assign({},a2,b3),defaults=def=>{if(!def||"object"!=typeof def||!Object.keys(def).length)return minimatch;const orig=minimatch;return Object.assign(((p2,pattern,options={})=>orig(p2,pattern,ext(def,options))),{Minimatch:class Minimatch extends orig.Minimatch{constructor(pattern,options={}){super(pattern,ext(def,options))}static defaults(options){return orig.defaults(ext(def,options)).Minimatch}},AST:class AST extends orig.AST{constructor(type,parent,options={}){super(type,parent,ext(def,options))}static fromGlob(pattern,options={}){return orig.AST.fromGlob(pattern,ext(def,options))}},unescape:(s2,options={})=>orig.unescape(s2,ext(def,options)),escape:(s2,options={})=>orig.escape(s2,ext(def,options)),filter:(pattern,options={})=>orig.filter(pattern,ext(def,options)),defaults:options=>orig.defaults(ext(def,options)),makeRe:(pattern,options={})=>orig.makeRe(pattern,ext(def,options)),braceExpand:(pattern,options={})=>orig.braceExpand(pattern,ext(def,options)),match:(list,pattern,options={})=>orig.match(list,pattern,ext(def,options)),sep:orig.sep,GLOBSTAR})};minimatch.defaults=defaults;var braceExpand=(pattern,options={})=>{assertValidPattern(pattern);if(options.nobrace||!/\{(?:(?!\{).)*\}/.test(pattern))return[pattern];else return(0,import_brace_expansion.default)(pattern)};minimatch.braceExpand=braceExpand;var makeRe=(pattern,options={})=>new Minimatch(pattern,options).makeRe();minimatch.makeRe=makeRe;var match=(list,pattern,options={})=>{const mm=new Minimatch(pattern,options);list=list.filter((f4=>mm.match(f4)));if(mm.options.nonull&&!list.length)list.push(pattern);return list};minimatch.match=match;var globMagic=/[?*]|[+@!]\(.*?\)|\[|\]/,regExpEscape2=s2=>s2.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),Minimatch=class{constructor(pattern,options={}){__publicField(this,"options");__publicField(this,"set");__publicField(this,"pattern");__publicField(this,"windowsPathsNoEscape");__publicField(this,"nonegate");__publicField(this,"negate");__publicField(this,"comment");__publicField(this,"empty");__publicField(this,"preserveMultipleSlashes");__publicField(this,"partial");__publicField(this,"globSet");__publicField(this,"globParts");__publicField(this,"nocase");__publicField(this,"isWindows");__publicField(this,"platform");__publicField(this,"windowsNoMagicRoot");__publicField(this,"regexp");assertValidPattern(pattern);options=options||{};this.options=options;this.pattern=pattern;this.platform=options.platform||defaultPlatform;this.isWindows="win32"===this.platform;this.windowsPathsNoEscape=!!options.windowsPathsNoEscape||false===options.allowWindowsEscape;if(this.windowsPathsNoEscape)this.pattern=this.pattern.replace(/\\/g,"/");this.preserveMultipleSlashes=!!options.preserveMultipleSlashes;this.regexp=null;this.negate=false;this.nonegate=!!options.nonegate;this.comment=false;this.empty=false;this.partial=!!options.partial;this.nocase=!!this.options.nocase;this.windowsNoMagicRoot=void 0!==options.windowsNoMagicRoot?options.windowsNoMagicRoot:!!(this.isWindows&&this.nocase);this.globSet=[];this.globParts=[];this.set=[];this.make()}hasMagic(){if(this.options.magicalBraces&&this.set.length>1)return true;for(const pattern of this.set)for(const part of pattern)if("string"!=typeof part)return true;return false}debug(..._){}make(){const pattern=this.pattern,options=this.options;if(!options.nocomment&&"#"===pattern.charAt(0)){this.comment=true;return}if(!pattern){this.empty=true;return}this.parseNegate();this.globSet=[...new Set(this.braceExpand())];if(options.debug)this.debug=(...args)=>console.error(...args);this.debug(this.pattern,this.globSet);const rawGlobParts=this.globSet.map((s2=>this.slashSplit(s2)));this.globParts=this.preprocess(rawGlobParts);this.debug(this.pattern,this.globParts);let set=this.globParts.map(((s2,_,__)=>{if(this.isWindows&&this.windowsNoMagicRoot){const isUNC=!(""!==s2[0]||""!==s2[1]||"?"!==s2[2]&&globMagic.test(s2[2])||globMagic.test(s2[3])),isDrive=/^[a-z]:/i.test(s2[0]);if(isUNC)return[...s2.slice(0,4),...s2.slice(4).map((ss=>this.parse(ss)))];else if(isDrive)return[s2[0],...s2.slice(1).map((ss=>this.parse(ss)))]}return s2.map((ss=>this.parse(ss)))}));this.debug(this.pattern,set);this.set=set.filter((s2=>-1===s2.indexOf(false)));if(this.isWindows)for(let i2=0;i2<this.set.length;i2++){const p2=this.set[i2];if(""===p2[0]&&""===p2[1]&&"?"===this.globParts[i2][2]&&"string"==typeof p2[3]&&/^[a-z]:$/i.test(p2[3]))p2[2]="?"}this.debug(this.pattern,this.set)}preprocess(globParts){if(this.options.noglobstar)for(let i2=0;i2<globParts.length;i2++)for(let j2=0;j2<globParts[i2].length;j2++)if("**"===globParts[i2][j2])globParts[i2][j2]="*";const{optimizationLevel=1}=this.options;if(optimizationLevel>=2){globParts=this.firstPhasePreProcess(globParts);globParts=this.secondPhasePreProcess(globParts)}else if(optimizationLevel>=1)globParts=this.levelOneOptimize(globParts);else globParts=this.adjascentGlobstarOptimize(globParts);return globParts}adjascentGlobstarOptimize(globParts){return globParts.map((parts=>{let gs=-1;for(;-1!==(gs=parts.indexOf("**",gs+1));){let i2=gs;for(;"**"===parts[i2+1];)i2++;if(i2!==gs)parts.splice(gs,i2-gs)}return parts}))}levelOneOptimize(globParts){return globParts.map((parts=>0===(parts=parts.reduce(((set,part)=>{const prev=set[set.length-1];if("**"===part&&"**"===prev)return set;if(".."===part)if(prev&&".."!==prev&&"."!==prev&&"**"!==prev){set.pop();return set}set.push(part);return set}),[])).length?[""]:parts))}levelTwoFileOptimize(parts){if(!Array.isArray(parts))parts=this.slashSplit(parts);let didSomething=false;do{didSomething=false;if(!this.preserveMultipleSlashes){for(let i2=1;i2<parts.length-1;i2++){const p2=parts[i2];if(1!==i2||""!==p2||""!==parts[0])if("."===p2||""===p2){didSomething=true;parts.splice(i2,1);i2--}}if("."===parts[0]&&2===parts.length&&("."===parts[1]||""===parts[1])){didSomething=true;parts.pop()}}let dd=0;for(;-1!==(dd=parts.indexOf("..",dd+1));){const p2=parts[dd-1];if(p2&&"."!==p2&&".."!==p2&&"**"!==p2){didSomething=true;parts.splice(dd-1,2);dd-=2}}}while(didSomething);return 0===parts.length?[""]:parts}firstPhasePreProcess(globParts){let didSomething=false;do{didSomething=false;for(let parts of globParts){let gs=-1;for(;-1!==(gs=parts.indexOf("**",gs+1));){let gss=gs;for(;"**"===parts[gss+1];)gss++;if(gss>gs)parts.splice(gs+1,gss-gs);let next=parts[gs+1];const p2=parts[gs+2],p22=parts[gs+3];if(".."!==next)continue;if(!p2||"."===p2||".."===p2||!p22||"."===p22||".."===p22)continue;didSomething=true;parts.splice(gs,1);const other=parts.slice(0);other[gs]="**";globParts.push(other);gs--}if(!this.preserveMultipleSlashes){for(let i2=1;i2<parts.length-1;i2++){const p2=parts[i2];if(1!==i2||""!==p2||""!==parts[0])if("."===p2||""===p2){didSomething=true;parts.splice(i2,1);i2--}}if("."===parts[0]&&2===parts.length&&("."===parts[1]||""===parts[1])){didSomething=true;parts.pop()}}let dd=0;for(;-1!==(dd=parts.indexOf("..",dd+1));){const p2=parts[dd-1];if(p2&&"."!==p2&&".."!==p2&&"**"!==p2){didSomething=true;const splin=1===dd&&"**"===parts[dd+1]?["."]:[];parts.splice(dd-1,2,...splin);if(0===parts.length)parts.push("");dd-=2}}}}while(didSomething);return globParts}secondPhasePreProcess(globParts){for(let i2=0;i2<globParts.length-1;i2++)for(let j2=i2+1;j2<globParts.length;j2++){const matched=this.partsMatch(globParts[i2],globParts[j2],!this.preserveMultipleSlashes);if(matched){globParts[i2]=[];globParts[j2]=matched;break}}return globParts.filter((gs=>gs.length))}partsMatch(a2,b3,emptyGSMatch=false){let ai2=0,bi2=0,result=[],which="";for(;ai2<a2.length&&bi2<b3.length;)if(a2[ai2]===b3[bi2]){result.push("b"===which?b3[bi2]:a2[ai2]);ai2++;bi2++}else if(emptyGSMatch&&"**"===a2[ai2]&&b3[bi2]===a2[ai2+1]){result.push(a2[ai2]);ai2++}else if(emptyGSMatch&&"**"===b3[bi2]&&a2[ai2]===b3[bi2+1]){result.push(b3[bi2]);bi2++}else if("*"===a2[ai2]&&b3[bi2]&&(this.options.dot||!b3[bi2].startsWith("."))&&"**"!==b3[bi2]){if("b"===which)return false;which="a";result.push(a2[ai2]);ai2++;bi2++}else if("*"===b3[bi2]&&a2[ai2]&&(this.options.dot||!a2[ai2].startsWith("."))&&"**"!==a2[ai2]){if("a"===which)return false;which="b";result.push(b3[bi2]);ai2++;bi2++}else return false;return a2.length===b3.length&&result}parseNegate(){if(this.nonegate)return;const pattern=this.pattern;let negate3=false,negateOffset=0;for(let i2=0;i2<pattern.length&&"!"===pattern.charAt(i2);i2++){negate3=!negate3;negateOffset++}if(negateOffset)this.pattern=pattern.slice(negateOffset);this.negate=negate3}matchOne(file,pattern,partial=false){const options=this.options;if(this.isWindows){const fileDrive="string"==typeof file[0]&&/^[a-z]:$/i.test(file[0]),fileUNC=!fileDrive&&""===file[0]&&""===file[1]&&"?"===file[2]&&/^[a-z]:$/i.test(file[3]),patternDrive="string"==typeof pattern[0]&&/^[a-z]:$/i.test(pattern[0]),fdi=fileUNC?3:fileDrive?0:void 0,pdi=!patternDrive&&""===pattern[0]&&""===pattern[1]&&"?"===pattern[2]&&"string"==typeof pattern[3]&&/^[a-z]:$/i.test(pattern[3])?3:patternDrive?0:void 0;if("number"==typeof fdi&&"number"==typeof pdi){const[fd2,pd]=[file[fdi],pattern[pdi]];if(fd2.toLowerCase()===pd.toLowerCase()){pattern[pdi]=fd2;if(pdi>fdi)pattern=pattern.slice(pdi);else if(fdi>pdi)file=file.slice(fdi)}}}const{optimizationLevel=1}=this.options;if(optimizationLevel>=2)file=this.levelTwoFileOptimize(file);this.debug("matchOne",this,{file,pattern});this.debug("matchOne",file.length,pattern.length);for(var fi=0,pi=0,fl2=file.length,pl=pattern.length;fi<fl2&&pi<pl;fi++,pi++){this.debug("matchOne loop");var p2=pattern[pi],f4=file[fi];this.debug(pattern,p2,f4);if(false===p2)return false;if(p2===GLOBSTAR){this.debug("GLOBSTAR",[pattern,p2,f4]);var fr=fi,pr=pi+1;if(pr===pl){this.debug("** at the end");for(;fi<fl2;fi++)if("."===file[fi]||".."===file[fi]||!options.dot&&"."===file[fi].charAt(0))return false;return true}for(;fr<fl2;){var swallowee=file[fr];this.debug("\nglobstar while",file,fr,pattern,pr,swallowee);if(this.matchOne(file.slice(fr),pattern.slice(pr),partial)){this.debug("globstar found match!",fr,fl2,swallowee);return true}else{if("."===swallowee||".."===swallowee||!options.dot&&"."===swallowee.charAt(0)){this.debug("dot detected!",file,fr,pattern,pr);break}this.debug("globstar swallow a segment, and continue");fr++}}if(partial){this.debug("\n>>> no match, partial?",file,fr,pattern,pr);if(fr===fl2)return true}return false}let hit;if("string"==typeof p2){hit=f4===p2;this.debug("string match",p2,f4,hit)}else{hit=p2.test(f4);this.debug("pattern match",p2,f4,hit)}if(!hit)return false}if(fi===fl2&&pi===pl)return true;else if(fi===fl2)return partial;else if(pi===pl)return fi===fl2-1&&""===file[fi];else throw new Error("wtf?")}braceExpand(){return braceExpand(this.pattern,this.options)}parse(pattern){assertValidPattern(pattern);const options=this.options;if("**"===pattern)return GLOBSTAR;if(""===pattern)return"";let m2,fastTest=null;if(m2=pattern.match(starRE))fastTest=options.dot?starTestDot:starTest;else if(m2=pattern.match(starDotExtRE))fastTest=(options.nocase?options.dot?starDotExtTestNocaseDot:starDotExtTestNocase:options.dot?starDotExtTestDot:starDotExtTest)(m2[1]);else if(m2=pattern.match(qmarksRE))fastTest=(options.nocase?options.dot?qmarksTestNocaseDot:qmarksTestNocase:options.dot?qmarksTestDot:qmarksTest)(m2);else if(m2=pattern.match(starDotStarRE))fastTest=options.dot?starDotStarTestDot:starDotStarTest;else if(m2=pattern.match(dotStarRE))fastTest=dotStarTest;const re=AST.fromGlob(pattern,this.options).toMMPattern();if(fastTest&&"object"==typeof re)Reflect.defineProperty(re,"test",{value:fastTest});return re}makeRe(){if(this.regexp||false===this.regexp)return this.regexp;const set=this.set;if(!set.length){this.regexp=false;return this.regexp}const options=this.options,twoStar=options.noglobstar?star2:options.dot?twoStarDot:twoStarNoDot,flags=new Set(options.nocase?["i"]:[]);let re=set.map((pattern=>{const pp=pattern.map((p2=>{if(p2 instanceof RegExp)for(const f4 of p2.flags.split(""))flags.add(f4);return"string"==typeof p2?regExpEscape2(p2):p2===GLOBSTAR?GLOBSTAR:p2._src}));pp.forEach(((p2,i2)=>{const next=pp[i2+1],prev=pp[i2-1];if(p2===GLOBSTAR&&prev!==GLOBSTAR)if(void 0===prev)if(void 0!==next&&next!==GLOBSTAR)pp[i2+1]="(?:\\/|"+twoStar+"\\/)?"+next;else pp[i2]=twoStar;else if(void 0===next)pp[i2-1]=prev+"(?:\\/|"+twoStar+")?";else if(next!==GLOBSTAR){pp[i2-1]=prev+"(?:\\/|\\/"+twoStar+"\\/)"+next;pp[i2+1]=GLOBSTAR}}));return pp.filter((p2=>p2!==GLOBSTAR)).join("/")})).join("|");const[open,close]=set.length>1?["(?:",")"]:["",""];re="^"+open+re+close+"$";if(this.negate)re="^(?!"+re+").+$";try{this.regexp=new RegExp(re,[...flags].join(""))}catch(ex){this.regexp=false}return this.regexp}slashSplit(p2){if(this.preserveMultipleSlashes)return p2.split("/");else if(this.isWindows&&/^\/\/[^\/]+/.test(p2))return["",...p2.split(/\/+/)];else return p2.split(/\/+/)}match(f4,partial=this.partial){this.debug("match",f4,this.pattern);if(this.comment)return false;if(this.empty)return""===f4;if("/"===f4&&partial)return true;const options=this.options;if(this.isWindows)f4=f4.split("\\").join("/");const ff2=this.slashSplit(f4);this.debug(this.pattern,"split",ff2);const set=this.set;this.debug(this.pattern,"set",set);let filename=ff2[ff2.length-1];if(!filename)for(let i2=ff2.length-2;!filename&&i2>=0;i2--)filename=ff2[i2];for(let i2=0;i2<set.length;i2++){const pattern=set[i2];let file=ff2;if(options.matchBase&&1===pattern.length)file=[filename];if(this.matchOne(file,pattern,partial))if(options.flipNegate)return true;else return!this.negate}if(options.flipNegate)return false;else return this.negate}static defaults(def){return minimatch.defaults(def).Minimatch}};minimatch.AST=AST;minimatch.Minimatch=Minimatch;minimatch.escape=escape;minimatch.unescape=unescape2;var webcrypto,import_crypto=require("crypto");if(globalThis.crypto)webcrypto=globalThis.crypto;else{const crypto2=import_crypto.webcrypto;webcrypto=crypto2}function base64ToArrayBuffer(base64){if("string"==typeof base64)return base64ToArrayBufferInternalBrowser(base64);const bufItems=base64.map((e4=>base64ToArrayBufferInternalBrowser(e4))),len=bufItems.reduce(((p2,c2)=>p2+c2.byteLength),0),joinedArray=new Uint8Array(len);let offset=0;bufItems.forEach((e4=>{joinedArray.set(new Uint8Array(e4),offset);offset+=e4.byteLength}));return joinedArray.buffer}function base64ToArrayBufferInternalBrowser(base64){try{const binary_string=globalThis.atob(base64),len=binary_string.length,bytes=new Uint8Array(len);for(let i2=0;i2<len;i2++)bytes[i2]=binary_string.charCodeAt(i2);return bytes.buffer}catch(ex){Logger("Base64 Decode error",LOG_LEVEL_VERBOSE);Logger(ex,LOG_LEVEL_VERBOSE);return new ArrayBuffer(0)}}var encodeChunkSize=15e7;function arrayBufferToBase64internalBrowser(buffer){return new Promise(((res2,rej)=>{const blob=new Blob([buffer],{type:"application/octet-binary"}),reader=new FileReader;reader.onload=function(evt){var _a5,_b2;const dataURI=(null==(_b2=null==(_a5=evt.target)?void 0:_a5.result)?void 0:_b2.toString())||"";if(0!=buffer.byteLength&&(""==dataURI||"data:"==dataURI))return rej(new TypeError("Could not parse the encoded string"));const result=dataURI.substring(dataURI.indexOf(",")+1);res2(result)};reader.readAsDataURL(blob)}))}async function arrayBufferToBase64Single(buffer){const buf=buffer instanceof Uint8Array?buffer:new Uint8Array(buffer);if(buf.byteLength<QUANTUM)return btoa(String.fromCharCode.apply(null,[...buf]));else return await arrayBufferToBase64internalBrowser(buf)}async function arrayBufferToBase64(buffer){const buf=buffer instanceof Uint8Array?buffer:new Uint8Array(buffer);if(buf.byteLength<QUANTUM)return[btoa(String.fromCharCode.apply(null,[...buf]))];const bufLen=buf.byteLength,pieces=[];let idx2=0;do{const offset=idx2*encodeChunkSize,pBuf=new DataView(buf.buffer,offset,Math.min(encodeChunkSize,buf.byteLength-offset));pieces.push(await arrayBufferToBase64internalBrowser(pBuf));idx2++}while(idx2*encodeChunkSize<bufLen);return pieces}var QUANTUM=32768,te=new TextEncoder,td=new TextDecoder;function writeString(string){if(string.length>128)return te.encode(string);const buffer=new Uint8Array(4*string.length),length=string.length;let index5=0,chr=0,idx2=0;for(;idx2<length;){chr=string.charCodeAt(idx2++);if(chr<128)buffer[index5++]=chr;else if(chr<2048){buffer[index5++]=192|chr>>>6;buffer[index5++]=128|63&chr}else if(chr<55296||chr>57343){buffer[index5++]=224|chr>>>12;buffer[index5++]=128|chr>>>6&63;buffer[index5++]=128|63&chr}else{chr=65536+(chr-55296<<10|string.charCodeAt(idx2++)-56320);buffer[index5++]=240|chr>>>18;buffer[index5++]=128|chr>>>12&63;buffer[index5++]=128|chr>>>6&63;buffer[index5++]=128|63&chr}}return buffer.slice(0,index5)}function readString(buffer){const length=buffer.length;if(length>128)return td.decode(buffer);let index5=0;const end=length;let string="";for(;index5<end;){const chunk=[],cEnd=Math.min(index5+QUANTUM,end);for(;index5<cEnd;){const chr=buffer[index5++];if(chr<128)chunk.push(chr);else if(192==(224&chr))chunk.push((31&chr)<<6|63&buffer[index5++]);else if(224==(240&chr))chunk.push((15&chr)<<12|(63&buffer[index5++])<<6|63&buffer[index5++]);else if(240==(248&chr)){let code=(7&chr)<<18|(63&buffer[index5++])<<12|(63&buffer[index5++])<<6|63&buffer[index5++];if(code<65536)chunk.push(code);else{code-=65536;chunk.push(55296+(code>>>10),56320+(1023&code))}}}string+=String.fromCharCode(...chunk)}return string}function base64ToString(base64){try{if("string"!=typeof base64)return base64.map((e4=>base64ToString(e4))).join("");const binary_string=atob(base64),len=binary_string.length,bytes=new Uint8Array(len);for(let i2=0;i2<len;i2++)bytes[i2]=binary_string.charCodeAt(i2);return readString(bytes)}catch(ex){Logger("Base64 To String error",LOG_LEVEL_VERBOSE);Logger(ex,LOG_LEVEL_VERBOSE);if("string"!=typeof base64)return base64.join("");else return base64}}var regexpBase64=/^[A-Za-z0-9+/]+=*$/;function tryConvertBase64ToArrayBuffer(base64){try{const b64F=base64.replace(/\r|\n/g,"");if(!regexpBase64.test(b64F))return false;const binary_string=globalThis.atob(b64F);if(globalThis.btoa(binary_string)!==b64F)return false;const len=binary_string.length,bytes=new Uint8Array(len);for(let i2=0;i2<len;i2++)bytes[i2]=binary_string.charCodeAt(i2);return bytes.buffer}catch(ex){return false}}function*arrayToChunkedArray(arr,chunkLength){const source=[...arr];for(;source.length;){const s2=source.splice(0,chunkLength);yield s2}}function unique(arr){return[...new Set(arr)]}function*range(from,to){for(let i2=from;i2<=to;i2++)yield i2}var BINARY_CHUNK_MAX=31457280,table={},revTable={},decoderStreamAvailable="undefined"!=typeof TextDecoderStream;[...range(192,447)].forEach(((e4,i2)=>{table[i2]=e4;revTable[e4]=i2}));async function encodeBinaryEach(buffer){const len=buffer.byteLength,out=new Uint16Array(buffer);for(let i2=0;i2<len;i2++){const char=buffer[i2];if(char>=38&&char<=126&&58!=char);else out[i2]=table[char]}return await decodeAsync(out)}async function _encodeBinary(buffer){const len=buffer.length;if(len<BINARY_CHUNK_MAX)return[await encodeBinaryEach(buffer)];const out=[];for(let i2=0;i2<len;i2+=BINARY_CHUNK_MAX)out.push(encodeBinaryEach(buffer.subarray(i2,i2+BINARY_CHUNK_MAX)));return Promise.all(out)}async function decodeAsync(buffer){if(0==buffer.length)return"";if(!decoderStreamAvailable)return await decodeAsyncReader(buffer);const decoderStream=new TextDecoderStream("utf-16"),writer=decoderStream.writable.getWriter();writer.write(buffer);writer.close();const reader=decoderStream.readable.getReader(),result=await reader.read();if(!result.value)throw new Error("UTF-16 Parse error");return result.value}function decodeAsyncReader(buffer){return new Promise(((res2,rej)=>{const blob=new Blob([buffer],{type:"application/octet-binary"}),reader=new FileReader;reader.onload=function(evt){var _a5;const result=null==(_a5=evt.target)?void 0:_a5.result;if(!result)return rej("UTF-16 Parse error");else return res2(result)};reader.readAsText(blob,"utf-16")}))}function decodeToArrayBuffer(src){if(1==src.length)return _decodeToArrayBuffer(src[0]);const bufItems=src.map((e4=>_decodeToArrayBuffer(e4))),len=bufItems.reduce(((p2,c2)=>p2+c2.byteLength),0),joinedArray=new Uint8Array(len);let offset=0;bufItems.forEach((e4=>{joinedArray.set(new Uint8Array(e4),offset);offset+=e4.byteLength}));return joinedArray.buffer}function _decodeToArrayBuffer(src){const out=new Uint8Array(src.length),len=src.length;for(let i2=0;i2<len;i2++){const char=src.charCodeAt(i2);if(char>=38&&char<=126&&58!=char)out[i2]=char;else out[i2]=revTable[char]}return out.buffer}var revMap={},numMap={};for(let i2=0;i2<256;i2++){revMap[`00${i2.toString(16)}`.slice(-2)]=i2;numMap[i2]=`00${i2.toString(16)}`.slice(-2)}function hexStringToUint8Array(src){const len=src.length/2,ret=new Uint8Array(len);for(let i2=0;i2<len;i2++)ret[i2]=revMap[src[2*i2]+src[2*i2+1]];return ret}function uint8ArrayToHexString(src){return[...src].map((e4=>numMap[e4])).join("")}function concatUInt8Array(arrays){const length=arrays.reduce(((acc,cur)=>acc+cur.length),0),result=new Uint8Array(length);let pos=0;for(const array of arrays){result.set(array,pos);pos+=array.length}return result}function decodeBinary(src){if(0==src.length)return(new Uint8Array).buffer;if("string"==typeof src){if("%"===src[0])return _decodeToArrayBuffer(src.substring(1))}else if("%"===src[0][0]){const[head,...last]=src;return decodeToArrayBuffer([head.substring(1),...last])}return base64ToArrayBuffer(src)}async function encodeBinary(src){return await arrayBufferToBase64(src)}function replaceAll(str,search,replace){if("replaceAll"in String.prototype)return str.replaceAll(search,replace);else return str.split(search).join(replace)}function replaceAllPairs(str,...fromTo){let r2=`${str}`;for(const[from,to]of fromTo)r2=replaceAll(r2,from,to);return r2}function escapeStringToHTML(str){if(!str)return"";else return str.replace(/[<>&"'`]/g,(match3=>({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;","`":"&#x60;"}[match3])))}function versionNumberString2Number(version2){return version2.split(".").reverse().map(((e4,i2)=>e4/1*1e3**i2)).reduce(((prev,current)=>prev+current),0)}function isValidFilenameInWidows(filename){if(/[\u0000-\u001f]|[\\":?<>|*#]/g.test(filename))return false;if(/(\\|\/)(COM\d|LPT\d|CON|PRN|AUX|NUL|CLOCK$)($|\.)/gi.test(filename))return false;else return true}function isValidFilenameInDarwin(filename){return!/[\u0000-\u001f]|[:]/g.test(filename)}function isValidFilenameInLinux(filename){return!/[\u0000-\u001f]|[:]/g.test(filename)}function isValidFilenameInAndroid(filename){return!/[\u0000-\u001f]|[\\":?<>|*#]/g.test(filename)}function isFilePath(path2){if(-1===path2.indexOf(":"))return true;else return false}function stripAllPrefixes(prefixedPath){if(isFilePath(prefixedPath))return prefixedPath;const[,body]=expandFilePathPrefix(prefixedPath);return stripAllPrefixes(body)}function addPrefix(path2,prefix){if(prefix&&path2.startsWith(prefix))return path2;else return`${null!=prefix?prefix:""}${path2}`}function expandFilePathPrefix(path2){let[prefix,body]=path2.split(":",2);if(!body){body=prefix;prefix=""}else prefix+=":";return[prefix,body]}function expandDocumentIDPrefix(id){let[prefix,body]=id.split(":",2);if(!body){body=prefix;prefix=""}else prefix+=":";return[prefix,body]}var _hashString=memorizeFuncWithLRUCache((async key2=>{const buff=writeString(key2);let digest=await webcrypto.subtle.digest("SHA-256",buff);const len=key2.length;for(let i2=0;i2<len;i2++)digest=await webcrypto.subtle.digest("SHA-256",buff);return uint8ArrayToHexString(new Uint8Array(digest))}));function hashString(key2){return _hashString(key2)}async function path2id_base(filenameSrc,obfuscatePassphrase,caseInsensitive){if(filenameSrc.startsWith(PREFIX_OBFUSCATED))return`${filenameSrc}`;let filename=`${filenameSrc}`;const newPrefix=obfuscatePassphrase?PREFIX_OBFUSCATED:"";if(caseInsensitive)filename=filename.toLowerCase();let x2=filename;if(x2.startsWith("_"))x2="/"+x2;if(!obfuscatePassphrase)return newPrefix+x2;const[prefix,body]=expandFilePathPrefix(x2);if(body.startsWith(PREFIX_OBFUSCATED))return newPrefix+x2;const hashedPassphrase=await hashString(obfuscatePassphrase);return prefix+newPrefix+await hashString(`${hashedPassphrase}:${filename}`)}function id2path_base(id,entry){if(entry&&(null==entry?void 0:entry.path))return id2path_base(entry.path);if(id.startsWith(PREFIX_OBFUSCATED))throw new Error("Entry has been obfuscated!");const[prefix,body]=expandDocumentIDPrefix(id);if(body.startsWith(PREFIX_OBFUSCATED))throw new Error("Entry has been obfuscated!");if(body.startsWith("/"))return body.substring(1);else return prefix+body}function getPath(entry){return id2path_base(entry._id,entry)}function getPathWithoutPrefix(entry){return stripAllPrefixes(getPath(entry))}function stripPrefix(prefixedPath){const[prefix,body]=prefixedPath.split(":",2);if(!body)return prefix;else return body}function shouldBeIgnored(filename){if(filename==FLAGMD_REDFLAG)return true;if(filename==FLAGMD_REDFLAG2)return true;if(filename==FLAGMD_REDFLAG2_HR)return true;if(filename==FLAGMD_REDFLAG3)return true;if(filename==FLAGMD_REDFLAG3_HR)return true;if(filename.startsWith(PREFIXMD_LOGFILE))return true;if(filename.startsWith(PREFIXMD_LOGFILE_UC))return true;else return false}function isPlainText(filename){if(filename.endsWith(".md"))return true;if(filename.endsWith(".txt"))return true;if(filename.endsWith(".svg"))return true;if(filename.endsWith(".html"))return true;if(filename.endsWith(".csv"))return true;if(filename.endsWith(".css"))return true;if(filename.endsWith(".js"))return true;if(filename.endsWith(".xml"))return true;if(filename.endsWith(".canvas"))return true;else return false}function shouldSplitAsPlainText(filename){if(filename.endsWith(".md"))return true;if(filename.endsWith(".txt"))return true;if(filename.endsWith(".canvas"))return true;else return false}var matchOpts={platform:"linux",dot:true,flipNegate:true,nocase:true};function isAccepted(path2,ignore){if(-1!==path2.indexOf("./")||-1!==path2.indexOf("../"))return false;const patterns=ignore.map((e4=>e4.trim())).filter((e4=>e4.length>0&&!e4.startsWith("#")));let result;for(const pattern of patterns){if(pattern.endsWith("/"))if(minimatch(path2,`${pattern}**`,matchOpts))return false;const newResult=pattern.startsWith("!");if(minimatch(path2,pattern,matchOpts)||!pattern.endsWith("/")&&minimatch(path2,pattern+"/**",matchOpts))result=newResult}return result}async function isAcceptedAll(path2,ignoreFiles,getList){const intermediatePaths=unique(path2.substring(0,path2.lastIndexOf("/")).split("/").reduce(((p2,c2)=>[...p2,p2[p2.length-1]+"/"+c2]),[""]).map((e4=>e4.substring(1)))).reverse();for(const intermediatePath of intermediatePaths)for(const ignoreFile of ignoreFiles){const ignoreFilePath=intermediatePath+"/"+ignoreFile,list=await getList(ignoreFilePath);if(false===list)continue;const result=isAccepted(path2.substring(intermediatePath.length?intermediatePath.length+1:0),list);if(void 0!==result)return result}return true}function makeUniqueString(){const temp=[...Array(30)].map((()=>Math.floor(52*Math.random()))).map((e4=>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[e4])).join("");return`${Date.now()}-${temp}`}function Semaphore(limit,onRelease){let _limit=limit,currentProcesses=0,queue2=[];function execProcess(){queue2=queue2.filter((e4=>"DONE"!=e4.state));for(const queueItem of queue2)if("NONE"==queueItem.state){if(queueItem.quantity+currentProcesses>_limit)break;queueItem.state="RUNNING";currentProcesses+=queueItem.quantity;if(null==queueItem?void 0:queueItem.timer)clearTimeout(queueItem.timer);queueItem.notify(true)}}function release(key2){const finishedTask=queue2.find((e4=>e4.key==key2));if(!finishedTask)throw new Error("Missing locked semaphore!");if("RUNNING"==finishedTask.state)currentProcesses-=finishedTask.quantity;finishedTask.state="DONE";if(onRelease)onRelease(queue2.filter((e4=>"DONE"!=e4.state)));execProcess()}return{setLimit(limit2){_limit=limit2},_acquire(quantity,memo,timeout){const key2=makeUniqueString();if(_limit<quantity)throw Error("Too big quantity");let notify=_=>{};const semaphoreStopper=new Promise((res2=>{notify=result=>{if(result)res2((()=>{release(key2)}));else res2(false)}})),notifier={key:key2,notify,semaphoreStopper,quantity,memo,state:"NONE"};if(timeout)notifier.timer=setTimeout((()=>{release(key2);notify(false)}),timeout);queue2.push(notifier);execProcess();return semaphoreStopper},acquire(quantity=1,memo){return this._acquire(quantity,null!=memo?memo:"",0)},tryAcquire(quantity=1,timeout=1,memo){return this._acquire(quantity,null!=memo?memo:"",timeout)},peekQueues:()=>queue2}}var encryptionKey,webcrypto2=globalThis.crypto,SALT_STR="fancySyncForYou!",SALT=(new TextEncoder).encode(SALT_STR),previousPassphrase="";function resetV3Buf(){_nonceV3[0]=0;const _wk=webcrypto2.getRandomValues(new Uint8Array(12));bufV3.set(_wk);bufV3.set(_nonceV3,8)}var _nonceV3=new Uint32Array(1),bufV3=new Uint8Array(12);function incIV(){_nonceV3[0]++;bufV3.set(_nonceV3,8);if(_nonceV3[0]>1500)resetV3Buf();return bufV3}async function generateKey(passphrase){const passphraseBin=(new TextEncoder).encode(passphrase),salt=(await webcrypto2.subtle.digest("SHA-256",new Uint8Array([...passphraseBin,...SALT]))).slice(0,16),baseKey=await webcrypto2.subtle.importKey("raw",passphraseBin,"PBKDF2",false,["deriveBits","deriveKey"]),pbkdf2Params={name:"PBKDF2",hash:"SHA-256",salt,iterations:1e5};return await webcrypto2.subtle.deriveKey(pbkdf2Params,baseKey,{name:"AES-GCM",length:256},false,["decrypt","encrypt"])}async function encryptV3(input,passphrase){if(previousPassphrase!==passphrase){resetV3Buf();const key2=await generateKey(passphrase);encryptionKey=key2;previousPassphrase=passphrase}const iv=incIV(),dataBuf=writeString(input),encryptedDataArrayBuffer=await webcrypto2.subtle.encrypt({name:"AES-GCM",iv},encryptionKey,dataBuf),encryptedData2=""+await arrayBufferToBase64Single(new Uint8Array(encryptedDataArrayBuffer));return`%~${uint8ArrayToHexString(iv)}${encryptedData2}`}var decryptionKey,previousDecryptionPassphrase="";async function decryptV3(encryptedResult,passphrase){if(previousDecryptionPassphrase!==passphrase){const key2=await generateKey(passphrase);decryptionKey=key2;previousDecryptionPassphrase=passphrase}const ivStr=encryptedResult.substring(2,26),encryptedData=encryptedResult.substring(26),iv=hexStringToUint8Array(ivStr),encryptedDataArrayBuffer=base64ToArrayBuffer(encryptedData),dataBuffer=await webcrypto2.subtle.decrypt({name:"AES-GCM",iv},decryptionKey,encryptedDataArrayBuffer);return readString(new Uint8Array(dataBuffer))}var semiStaticFieldBuffer,KeyBuffs=new Map,decKeyBuffs=new Map,KEY_RECYCLE_COUNT=100,nonceBuffer=new Uint32Array(1),webcrypto3=globalThis.crypto;async function getKeyForEncrypt(passphrase,autoCalculateIterations){const buffKey=`${passphrase}-${autoCalculateIterations}`,f4=KeyBuffs.get(buffKey);if(f4){f4.count--;if(f4.count>0)return[f4.key,f4.salt];f4.count--}const passphraseLen=15-passphrase.length,iteration=autoCalculateIterations?1e3*(passphraseLen>0?passphraseLen:0)+121-passphraseLen:1e5,passphraseBin=(new TextEncoder).encode(passphrase),digest=await webcrypto3.subtle.digest({name:"SHA-256"},passphraseBin),keyMaterial=await webcrypto3.subtle.importKey("raw",digest,{name:"PBKDF2"},false,["deriveKey"]),salt=webcrypto3.getRandomValues(new Uint8Array(16)),key2=await webcrypto3.subtle.deriveKey({name:"PBKDF2",salt,iterations:iteration,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},false,["encrypt"]);KeyBuffs.set(buffKey,{key:key2,salt,count:KEY_RECYCLE_COUNT});return[key2,salt]}var keyGCCount=5*KEY_RECYCLE_COUNT,decKeyIdx=0,decKeyMin=0;async function getKeyForDecryption(passphrase,salt,autoCalculateIterations){if(--keyGCCount<0){keyGCCount=KEY_RECYCLE_COUNT;const threshold=(decKeyIdx-decKeyMin)/2;for(const[key3,buff]of decKeyBuffs){if(buff.count<threshold)decKeyBuffs.delete(key3);decKeyMin=decKeyIdx}}decKeyIdx++;const bufKey=passphrase+uint8ArrayToHexString(salt)+autoCalculateIterations,f4=decKeyBuffs.get(bufKey);if(f4){f4.count=decKeyIdx;return[f4.key,f4.salt]}const passphraseLen=15-passphrase.length,iteration=autoCalculateIterations?1e3*(passphraseLen>0?passphraseLen:0)+121-passphraseLen:1e5,passphraseBin=(new TextEncoder).encode(passphrase),digest=await webcrypto3.subtle.digest({name:"SHA-256"},passphraseBin),keyMaterial=await webcrypto3.subtle.importKey("raw",digest,{name:"PBKDF2"},false,["deriveKey"]),key2=await webcrypto3.subtle.deriveKey({name:"PBKDF2",salt,iterations:iteration,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},false,["decrypt"]);decKeyBuffs.set(bufKey,{key:key2,salt,count:0});return[key2,salt]}function getSemiStaticField(reset){if(null!=semiStaticFieldBuffer&&!reset)return semiStaticFieldBuffer;else return semiStaticFieldBuffer=webcrypto3.getRandomValues(new Uint8Array(12))}function getNonce(){nonceBuffer[0]++;if(nonceBuffer[0]>1e4)getSemiStaticField(true);return nonceBuffer}async function encryptV1(input,passphrase,autoCalculateIterations){const[key2,salt]=await getKeyForEncrypt(passphrase,autoCalculateIterations),fixedPart=getSemiStaticField(),invocationPart=getNonce(),iv=new Uint8Array([...fixedPart,...new Uint8Array(invocationPart.buffer)]),plainStringBuffer=writeString(JSON.stringify(input)),encryptedDataArrayBuffer=await webcrypto3.subtle.encrypt({name:"AES-GCM",iv},key2,plainStringBuffer);return`["${await arrayBufferToBase64Single(encryptedDataArrayBuffer)}","${uint8ArrayToHexString(iv)}","${uint8ArrayToHexString(salt)}"]`}async function encrypt(input,passphrase,autoCalculateIterations){const[key2,salt]=await getKeyForEncrypt(passphrase,autoCalculateIterations),fixedPart=getSemiStaticField(),invocationPart=getNonce(),iv=new Uint8Array([...fixedPart,...new Uint8Array(invocationPart.buffer)]),dataBuf=writeString(input),encryptedDataArrayBuffer=await webcrypto3.subtle.encrypt({name:"AES-GCM",iv},key2,dataBuf),encryptedData2=""+await arrayBufferToBase64Single(new Uint8Array(encryptedDataArrayBuffer));return`%${uint8ArrayToHexString(iv)}${uint8ArrayToHexString(salt)}${encryptedData2}`}async function getKeyForObfuscatePath(passphrase,dataBuf,autoCalculateIterations){const passphraseLen=15-passphrase.length,iteration=autoCalculateIterations?1e3*(passphraseLen>0?passphraseLen:0)+121-passphraseLen:1e5,passphraseBin=(new TextEncoder).encode(passphrase),digest=await webcrypto3.subtle.digest({name:"SHA-256"},passphraseBin),buf2=new Uint8Array(await webcrypto3.subtle.digest({name:"SHA-256"},new Uint8Array([...dataBuf,...passphraseBin]))),salt=buf2.slice(0,16),iv=buf2.slice(16,32),keyMaterial=await webcrypto3.subtle.importKey("raw",digest,{name:"PBKDF2"},false,["deriveKey"]);return[await webcrypto3.subtle.deriveKey({name:"PBKDF2",salt,iterations:iteration,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},false,["encrypt"]),salt,iv]}async function obfuscatePath(path2,passphrase,autoCalculateIterations){const dataBuf=writeString(path2),[key2,salt,iv]=await getKeyForObfuscatePath(passphrase,dataBuf,autoCalculateIterations),encryptedDataArrayBuffer=await webcrypto3.subtle.encrypt({name:"AES-GCM",iv},key2,dataBuf),encryptedData2=await arrayBufferToBase64Single(new Uint8Array(encryptedDataArrayBuffer));return`%${uint8ArrayToHexString(iv)}${uint8ArrayToHexString(salt)}${encryptedData2}`}function isPathProbablyObfuscated(path2){return path2.startsWith("%")&&path2.length>64}async function decryptV2(encryptedResult,passphrase,autoCalculateIterations){try{const ivStr=encryptedResult.substring(1,33),salt=encryptedResult.substring(33,65),encryptedData=encryptedResult.substring(65),[key2]=await getKeyForDecryption(passphrase,hexStringToUint8Array(salt),autoCalculateIterations),iv=hexStringToUint8Array(ivStr),encryptedDataArrayBuffer=decodeBinary(encryptedData),dataBuffer=await webcrypto3.subtle.decrypt({name:"AES-GCM",iv},key2,encryptedDataArrayBuffer);return readString(new Uint8Array(dataBuffer))}catch(ex){Logger("Couldn't decode! You should wrong the passphrases (V2)",LOG_LEVEL_VERBOSE);Logger(ex,LOG_LEVEL_VERBOSE);throw ex}}async function decrypt(encryptedResult,passphrase,autoCalculateIterations){try{if("%"==encryptedResult[0])if("~"===encryptedResult[1])return decryptV3(encryptedResult,passphrase);else return decryptV2(encryptedResult,passphrase,autoCalculateIterations);if(!encryptedResult.startsWith("[")||!encryptedResult.endsWith("]"))throw new Error("Encrypted data corrupted!");const w2=encryptedResult.substring(1,encryptedResult.length-1).split(",").map((e4=>'"'==e4[0]?e4.substring(1,e4.length-1):e4)),[encryptedData,ivString,salt]=w2,[key2]=await getKeyForDecryption(passphrase,hexStringToUint8Array(salt),autoCalculateIterations),iv=hexStringToUint8Array(ivString),encryptedDataBin=atob(encryptedData),len=encryptedDataBin.length,encryptedDataArrayBuffer=new Uint8Array(len);for(let i2=len;i2>=0;--i2)encryptedDataArrayBuffer[i2]=encryptedDataBin.charCodeAt(i2);const plainStringBuffer=await webcrypto3.subtle.decrypt({name:"AES-GCM",iv},key2,encryptedDataArrayBuffer),plainStringified=readString(new Uint8Array(plainStringBuffer));return JSON.parse(plainStringified)}catch(ex){Logger("Couldn't decode! You should wrong the passphrases",LOG_LEVEL_VERBOSE);Logger(ex,LOG_LEVEL_VERBOSE);throw ex}}async function tryDecrypt(encryptedResult,passphrase,autoCalculateIterations){if(!passphrase)return false;try{return await decrypt(encryptedResult,passphrase,autoCalculateIterations)}catch(ex){return false}}async function testCryptV3(){const src="supercalifragilisticexpialidocious",encoded=await encryptV3(src,"passwordTest");if(src!=await decrypt(encoded,"passwordTest",false)){Logger("WARNING! Your device would not support encryption V3.",LOG_LEVEL_VERBOSE);return false}else{Logger("CRYPT LOGIC (V3) OK",LOG_LEVEL_VERBOSE);return true}}async function testCrypt(){const src="supercalifragilisticexpialidocious",encoded=await encrypt(src,"passwordTest",false);if(src!=await decrypt(encoded,"passwordTest",false)){Logger("WARNING! Your device would not support encryption.",LOG_LEVEL_VERBOSE);return false}else{Logger("CRYPT LOGIC OK",LOG_LEVEL_VERBOSE);const w2=(new TextEncoder).encode(src),encodedBinary=await encryptBinary(w2,"passwordTest",false),decryptedBinary=await decryptBinary(encodedBinary,"passwordTest",false);if(w2.join("-")!==decryptedBinary.join("-")){Logger("WARNING! Your device would not support encryption (Binary).",LOG_LEVEL_VERBOSE);return false}else Logger("CRYPT LOGIC OK (Binary)",LOG_LEVEL_VERBOSE);return await testCryptV3()}}async function encryptBinary(input,passphrase,autoCalculateIterations){const[key2,salt]=await getKeyForEncrypt(passphrase,autoCalculateIterations),fixedPart=getSemiStaticField(),invocationPart=getNonce(),iv=new Uint8Array([...fixedPart,...new Uint8Array(invocationPart.buffer)]),dataBuf=input,encryptedDataArrayBuffer=new Uint8Array(await webcrypto3.subtle.encrypt({name:"AES-GCM",iv},key2,dataBuf)),ret=new Uint8Array(encryptedDataArrayBuffer.byteLength+iv.byteLength+salt.byteLength);ret.set(iv,0);ret.set(salt,iv.byteLength);ret.set(encryptedDataArrayBuffer,iv.byteLength+salt.byteLength);return ret}async function decryptBinary(encryptedResult,passphrase,autoCalculateIterations){try{const iv=encryptedResult.slice(0,16),salt=encryptedResult.slice(16,32),encryptedData=encryptedResult.slice(32),[key2]=await getKeyForDecryption(passphrase,salt,autoCalculateIterations),dataBuffer=await webcrypto3.subtle.decrypt({name:"AES-GCM",iv},key2,encryptedData);return new Uint8Array(dataBuffer)}catch(ex){Logger("Couldn't decode! You should wrong the passphrases (V2 Bin)",LOG_LEVEL_VERBOSE);Logger(ex,LOG_LEVEL_VERBOSE);throw ex}}var delay=(ms,result)=>new Promise((res2=>{setTimeout((()=>{res2(result)}),ms)}));function polyfillPromiseWithResolvers(){let resolve,reject;return{promise:new Promise(((res2,rej)=>{resolve=res2;reject=rej})),resolve,reject}}function nativePromiseWithResolvers(){const p2=Promise.withResolvers(),{promise:promise2,resolve,reject}=p2;return{promise:promise2,resolve,reject}}var currentYieldingAnimationFrame,currentYieldingMicrotask,promiseWithResolver="withResolvers"in Promise?nativePromiseWithResolvers:polyfillPromiseWithResolvers,noop=()=>{};function fireAndForget(p2){if("function"==typeof p2)return fireAndForget(p2());p2.then(noop).catch(noop)}function yieldMicrotask(){return new Promise((res2=>queueMicrotask(res2)))}function yieldRequestIdleCallback(options){if(!("requestIdleCallback"in globalThis))return yieldMicrotask();else return new Promise((res2=>requestIdleCallback((()=>res2()),options)))}function yieldAnimationFrame(){return new Promise((res2=>requestAnimationFrame(res2)))}function yieldNextAnimationFrame(){if(currentYieldingAnimationFrame)return currentYieldingAnimationFrame;else return currentYieldingAnimationFrame=(async()=>{const ret=await yieldAnimationFrame();currentYieldingAnimationFrame=void 0;return ret})()}function yieldNextMicrotask(){if(currentYieldingMicrotask)return currentYieldingMicrotask;else return currentYieldingMicrotask=(async()=>{await yieldMicrotask();currentYieldingMicrotask=void 0})()}var EventHub=class{constructor(){this._emitter=new EventTarget}emitEvent(event,data){this._emitter.dispatchEvent(new CustomEvent(`${event.toString()}`,{detail:null!=data?data:void 0}))}on(event,callback){const onEvent=e4=>{callback(e4,e4 instanceof CustomEvent?e4.detail:void 0)},key2=`${event.toString()}`;this._emitter.addEventListener(key2,onEvent);return()=>this._emitter.removeEventListener(key2,onEvent)}onEvent(event,callback){return this.on(event,((_,data)=>{callback(data)}))}once(event,callback){const off=this.on(event,((e4,data)=>{off();callback(e4,data)}))}onceEvent(event,callback){this.once(event,callback)}waitFor(event){return new Promise((resolve=>{const off=this.on(event,((e4,data)=>{off();resolve(data)}))}))}},eventHub=new EventHub;function inlineWorker(scriptText){let blob=new Blob([scriptText],{type:"text/javascript"}),url=URL.createObjectURL(blob),worker=new Worker(url);URL.revokeObjectURL(url);return worker}function Worker2(){return inlineWorker('var O=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),pt=t=>{throw TypeError(t)};var T=function(t,e){this[0]=t,this[1]=e},I=(t,e,r)=>{var n=(a,s,c,l)=>{try{var f=r[a](s),y=(s=f.value)instanceof T,g=f.done;Promise.resolve(y?s[0]:s).then(d=>y?n(a==="return"?a:"next",s[1]?{done:d.done,value:d.value}:d,c,l):c({value:d,done:g})).catch(d=>n("throw",d,c,l))}catch(d){l(d)}},o=a=>i[a]=s=>new Promise((c,l)=>n(a,s,c,l)),i={};return r=r.apply(t,e),i[O("asyncIterator")]=()=>i,o("next"),o("throw"),o("return"),i},p=t=>{var e=t[O("asyncIterator")],r=!1,n,o={};return e==null?(e=t[O("iterator")](),n=i=>o[i]=a=>e[i](a)):(e=e.call(t),n=i=>o[i]=a=>{if(r){if(r=!1,i==="throw")throw a;return a}return r=!0,{done:!1,value:new T(new Promise(s=>{var c=e[i](a);c instanceof Object||pt("Object expected"),s(c)}),1)}}),o[O("iterator")]=()=>o,n("next"),"throw"in e?n("throw"):o.throw=i=>{throw i},"return"in e&&n("return"),o},P=(t,e,r)=>(e=t[O("asyncIterator")])?e.call(t):(t=t[O("iterator")](),e={},r=(n,o)=>(o=t[n])&&(e[n]=i=>new Promise((a,s,c)=>(i=o.call(t,i),c=i.done,Promise.resolve(i.value).then(l=>a({value:l,done:c}),s)))),r("next"),r("return"),e);var ht={minLogLevel:32},wt=function(e,r=32,n){if(r<ht.minLogLevel)return;let i=new Date().toLocaleString(),a=typeof e=="string"?e:e instanceof Error?`${e.name}:${e.message}`:JSON.stringify(e,null,2),s=`${i}\t${r}\t${a}`;r&1?console.debug(s):r&4?console.warn(s):r&8?console.error(s):r&2?console.info(s):console.log(s),e instanceof Error&&console.dir(e.stack)},bt=wt;function B(t,e,r){bt(t,e,r)}function C(t){if(typeof t=="string")return F(t);let e=t.map(i=>F(i)),r=e.reduce((i,a)=>i+a.byteLength,0),n=new Uint8Array(r),o=0;return e.forEach(i=>{n.set(new Uint8Array(i),o),o+=i.byteLength}),n.buffer}function F(t){try{let e=globalThis.atob(t),r=e.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=e.charCodeAt(o);return n.buffer}catch(e){return B("Base64 Decode error",16),B(e,16),new ArrayBuffer(0)}}var Yt=3*5e7;function At(t){return new Promise((e,r)=>{let n=new Blob([t],{type:"application/octet-binary"}),o=new FileReader;o.onload=function(i){var c,l;let a=((l=(c=i.target)==null?void 0:c.result)==null?void 0:l.toString())||"";if(t.byteLength!=0&&(a==""||a=="data:"))return r(new TypeError("Could not parse the encoded string"));let s=a.substring(a.indexOf(",")+1);e(s)},o.readAsDataURL(n)})}async function E(t){let e=t instanceof Uint8Array?t:new Uint8Array(t);return e.byteLength<X?btoa(String.fromCharCode.apply(null,[...e])):await At(e)}var X=32768,xt=new TextEncoder,mt=new TextDecoder;function V(t){if(t.length>128)return xt.encode(t);let e=new Uint8Array(t.length*4),r=t.length,n=0,o=0,i=0;for(;i<r;)o=t.charCodeAt(i++),o<128?e[n++]=o:o<2048?(e[n++]=192|o>>>6,e[n++]=128|o&63):o<55296||o>57343?(e[n++]=224|o>>>12,e[n++]=128|o>>>6&63,e[n++]=128|o&63):(o=(o-55296<<10|t.charCodeAt(i++)-56320)+65536,e[n++]=240|o>>>18,e[n++]=128|o>>>12&63,e[n++]=128|o>>>6&63,e[n++]=128|o&63);return e.slice(0,n)}function G(t){let e=t.length;if(e>128)return mt.decode(t);let r=0,n=e,o="";for(;r<n;){let i=[],a=Math.min(r+X,n);for(;r<a;){let s=t[r++];if(s<128)i.push(s);else if((s&224)===192)i.push((s&31)<<6|t[r++]&63);else if((s&240)===224)i.push((s&15)<<12|(t[r++]&63)<<6|t[r++]&63);else if((s&248)===240){let c=(s&7)<<18|(t[r++]&63)<<12|(t[r++]&63)<<6|t[r++]&63;c<65536?i.push(c):(c-=65536,i.push((c>>>10)+55296,(c&1023)+56320))}}o+=String.fromCharCode(...i)}return o}function*Q(t,e){for(let r=t;r<=e;r++)yield r}var Qt=1024*1024*30,Bt={},Z={};[...Q(192,447)].forEach((t,e)=>{Bt[e]=t,Z[t]=e});function W(t){if(t.length==1)return v(t[0]);let e=t.map(i=>v(i)),r=e.reduce((i,a)=>i+a.byteLength,0),n=new Uint8Array(r),o=0;return e.forEach(i=>{n.set(new Uint8Array(i),o),o+=i.byteLength}),n.buffer}function v(t){let e=new Uint8Array(t.length),r=t.length;for(let n=0;n<r;n++){let o=t.charCodeAt(n);o>=38&&o<=126&&o!=58?e[n]=o:e[n]=Z[o]}return e.buffer}var z={},tt={};for(let t=0;t<256;t++)z[`00${t.toString(16)}`.slice(-2)]=t,tt[t]=`00${t.toString(16)}`.slice(-2);function A(t){let e=t.length/2,r=new Uint8Array(e);for(let n=0;n<e;n++)r[n]=z[t[n*2]+t[n*2+1]];return r}function _(t){return[...t].map(e=>tt[e]).join("")}function R(t){if(t.length==0)return new Uint8Array().buffer;if(typeof t=="string"){if(t[0]==="%")return v(t.substring(1))}else if(t[0][0]==="%"){let[e,...r]=t;return W([e.substring(1),...r])}return C(t)}function nt(t){return t.type==="text/plain"}function*St(t,e){let r="";t:do{let n=t.shift();if(typeof n=="undefined"){yield r;break t}if(n.startsWith("```")||n.startsWith(" ```")||n.startsWith("  ```")||n.startsWith("   ```")){yield r,r=n+(t.length!=0?`\n`:"");e:do{let s=t.shift();if(typeof s=="undefined")break e;r+=s+(t.length!=0?`\n`:"")}while(t.length>0&&!(t[0].startsWith("```")||t[0].startsWith(" ```")||t[0].startsWith("  ```")||t[0].startsWith("   ```")));let o=r.endsWith("="),i=r.length>2048,a=t.shift();if(typeof a!="undefined"&&(r+=a,r+=t.length!=0?`\n`:""),!o&&!i){let s=/(.*?[;,:<])/g,c=r.split(s).filter(l=>l!="");for(let l of c)yield l}else yield r;r=""}else r+=n+(t.length!=0?`\n`:""),(r.length>=e||t.length==0||t[0]=="#"||r[0]=="#")&&(yield r,r="")}while(t.length>0)}var rt=10,ot="Segmenter"in Intl?new Intl.Segmenter(navigator.language,{granularity:"sentence"}):void 0;function*M(t,e){let r=t;do{let n=e,o=r.substring(0,n);r=r.substring(n),yield o}while(r!="")}function*et(t,e,r){let n=ot.segment(t),o="",i="";for(let a of n){let s=a.segment;o==s||i.length<r?(i+=s,o=s):(o=s,i.length>0&&(yield*p(M(i,e))),i=s)}i.length>0&&(yield*p(M(i,e)))}function*Gt(t){for(let e of t){let r=-1,n=-1;do{if(n=e.indexOf(`\n`,r),n==-1){yield e.substring(r);break}for(;e[n]==`\n`;)n++;yield e.substring(r,n),r=n}while(n!=-1)}}function _t(t,e,r){let o=Gt(typeof t=="string"?[t]:t),i=0,a=!1,s=!1;return function*(){let c=[];for(let l of o)l.startsWith("````")?i==0?(i=4,s=!0):i==4&&(i=0,a=!0):l.startsWith("```")&&(i==0?(i=3,s=!0):i==3&&(i=0,a=!0)),s&&(c.length>0&&(yield*p(et(c.join(""),e,r)),c.length=0),s=!1),c.push(l),a&&(c.length>0&&(yield*p(M(c.join(""),e)),c.length=0),a=!1);c.length>0&&(i==0?yield*p(et(c.join(""),e,r)):yield*p(M(c.join(""),e)))}}function Ut(t,e,r){return function*(){yield*p(M(t,e))}}function Ot(t,e,r,n,o){return!o||!ot?Ct(t,e,r,n):r?_t(t,e,n):Ut(t,e,n)}function Ct(t,e,r,n){let o=typeof t=="string"?[t]:t;return function*(){for(let a of o)if(r){let s=a.split(`\n`),c=St(s,n);for(let l of c){let f=l;do{let y=e;f.charCodeAt(y-1)!=f.codePointAt(y-1)&&y++,yield f.substring(0,y),f=f.substring(y)}while(f!="")}}else{let s=a;do{let c=e,l=s.substring(0,c);s=s.substring(c),yield l}while(s!="")}}}function*Vt(t,e,r=25,n){let o="",i=!1,a=e.length;for(let s of t){let c=s.length;if(n&&c>n){yield o+s,i=!1,o="";continue}let l=-1,f=0;t:do{if(l=s.indexOf(e,f),l==-1)break t;o+=s.slice(f,l)+e,o.length>r?(yield o,o="",i=!1):i=!0,f=l+a}while(l<c);(f!=l||f==-1&&l==-1)&&(o+=s.slice(f),i=!0)}i&&(yield o)}function*it(t,e){let r=t.length;if(r>e){let n=0;do{let o=n+e;if(o>r){yield t.substring(n);break}for(;t.charCodeAt(o-1)!=t.codePointAt(o-1);)o++;yield t.substring(n,o),n=o}while(n<r)}else yield t}function*Mt(t,e){for(let r of t)yield*p(it(r,e))}function*Ft(t){for(let e of t)yield e}var vt=100;async function st(t,e,r,n,o,i){if(t.size==0)return function*(){};if(nt(t)){let d=await t.text();if(!r){let b=it(d,e);return function*(){yield*p(b)}}let U=d.length,u=n;for(;U/u>vt;)u+=n;let x=Ft([d]),m=Vt(x,`\n`,u),w=Mt(m,e);return function*(){yield*p(w)}}let a=!1,s=0;o&&o.endsWith(".pdf")?s=47:o&&o.endsWith(".json")&&(a=!0,s=44);let f=Math.max(a?100:1e5,Math.min(1e8,t.size)),y=1,g=f;for(;g>10;)g/=12.5,y++;return n=Math.floor(10**(y-1)),function(){return I(this,null,function*(){let U=t.size,u=0,x=new Uint8Array(yield new T(t.arrayBuffer()));do{let m=u+n,w=u+e,b,L=x.indexOf(s,m);L==-1&&(L=x.indexOf(rt,m)),L==-1?b=w:b=L<w?L:w,yield yield new T(E(x.slice(u,b))),u=b}while(u<U)})}}async function at(t,e,r,n,o,i){if(nt(t))return Ot(await t.text(),e,r,n,i!=null?i:!1);let a=0,s=!1;o&&o.endsWith(".pdf")?a=47:o&&o.endsWith(".json")&&(s=!0,a=44);let f=Math.max(s?100:1e5,Math.min(1e8,t.size)),y=1,g=f;for(;g>10;)g/=12.5,y++;return n=Math.floor(10**(y-1)),function(){return I(this,null,function*(){let U=t.size,u=0;do{let x=e,m=new Uint8Array(yield new T(t.slice(u,u+e).arrayBuffer())),w=m.indexOf(a,n);x=w==-1?e:Math.min(e,w),w==-1&&(w=m.indexOf(rt,n));let b=m.slice(0,x);u+=b.length,yield yield new T(E(b))}while(u<U)})}}var D=globalThis.crypto,Dt="fancySyncForYou!",Kt=new TextEncoder().encode(Dt);var Be=new Uint32Array(1),Ee=new Uint8Array(12);async function ft(t){let e=new TextEncoder().encode(t),n=(await D.subtle.digest("SHA-256",new Uint8Array([...e,...Kt]))).slice(0,16),o=await D.subtle.importKey("raw",e,"PBKDF2",!1,["deriveBits","deriveKey"]),i={name:"PBKDF2",hash:"SHA-256",salt:n,iterations:1e5};return await D.subtle.deriveKey(i,o,{name:"AES-GCM",length:256},!1,["decrypt","encrypt"])}var ct="",lt;async function $(t,e){ct!==e&&(lt=await ft(e),ct=e);let r=t.substring(2,26),n=t.substring(26),o=A(r),i=C(n),a=await D.subtle.decrypt({name:"AES-GCM",iv:o},lt,i);return G(new Uint8Array(a))}var ut=new Map,K=new Map,Y=100,N,H=new Uint32Array(1),h=globalThis.crypto;async function kt(t,e){let r=`${t}-${e}`,n=ut.get(r);if(n){if(n.count--,n.count>0)return[n.key,n.salt];n.count--}let o=15-t.length,i=e?(o>0?o:0)*1e3+121-o:1e5,a=new TextEncoder().encode(t),s=await h.subtle.digest({name:"SHA-256"},a),c=await h.subtle.importKey("raw",s,{name:"PBKDF2"},!1,["deriveKey"]),l=h.getRandomValues(new Uint8Array(16)),f=await h.subtle.deriveKey({name:"PBKDF2",salt:l,iterations:i,hash:"SHA-256"},c,{name:"AES-GCM",length:256},!1,["encrypt"]);return ut.set(r,{key:f,salt:l,count:Y}),[f,l]}var j=Y*5,k=0,yt=0;async function dt(t,e,r){if(j--,j<0){j=Y;let y=(k-yt)/2;for(let[g,d]of K)d.count<y&&K.delete(g),yt=k}k++;let n=t+_(e)+r,o=K.get(n);if(o)return o.count=k,[o.key,o.salt];let i=15-t.length,a=r?(i>0?i:0)*1e3+121-i:1e5,s=new TextEncoder().encode(t),c=await h.subtle.digest({name:"SHA-256"},s),l=await h.subtle.importKey("raw",c,{name:"PBKDF2"},!1,["deriveKey"]),f=await h.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:a,hash:"SHA-256"},l,{name:"AES-GCM",length:256},!1,["decrypt"]);return K.set(n,{key:f,salt:e,count:0}),[f,e]}function gt(t){return N!=null&&!t||(N=h.getRandomValues(new Uint8Array(12))),N}function It(){return H[0]++,H[0]>1e4&&gt(!0),H}async function J(t,e,r){let[n,o]=await kt(e,r),i=gt(),a=It(),s=new Uint8Array([...i,...new Uint8Array(a.buffer)]),c=V(t),l=await h.subtle.encrypt({name:"AES-GCM",iv:s},n,c),f=""+await E(new Uint8Array(l));return`%${_(s)}${_(o)}${f}`}async function Pt(t,e,r){try{let n=t.substring(1,33),o=t.substring(33,65),i=t.substring(65),[a]=await dt(e,A(o),r),s=A(n),c=R(i),l=await h.subtle.decrypt({name:"AES-GCM",iv:s},a,c);return G(new Uint8Array(l))}catch(n){throw B("Couldn\'t decode! You should wrong the passphrases (V2)",16),B(n,16),n}}async function q(t,e,r){try{if(t[0]=="%")return t[1]==="~"?$(t,e):Pt(t,e,r);if(!t.startsWith("[")||!t.endsWith("]"))throw new Error("Encrypted data corrupted!");let n=t.substring(1,t.length-1).split(",").map(u=>u[0]==\'"\'?u.substring(1,u.length-1):u),[o,i,a]=n,[s]=await dt(e,A(a),r),c=A(i),l=atob(o),f=l.length,y=new Uint8Array(f);for(let u=f;u>=0;--u)y[u]=l.charCodeAt(u);let g=await h.subtle.decrypt({name:"AES-GCM",iv:c},s,y),d=G(new Uint8Array(g));return JSON.parse(d)}catch(n){throw B("Couldn\'t decode! You should wrong the passphrases",16),B(n,16),n}}async function Wt(t){let e=t.key,r=t.dataSrc,n=t.pieceSize,o=t.plainSplit,i=t.minimumChunkSize,a=t.filename,s=t.useSegmenter,l=await(t.useV2?st:at)(r,n,o,i,a,s),f=!1;try{for(var y=P(l()),g,d,U;g=!(d=await y.next()).done;g=!1){let u=d.value;f=!0,self.postMessage({key:e,result:u})}}catch(d){U=[d]}finally{try{g&&(d=y.return)&&await d.call(y)}finally{if(U)throw U[0]}}f||self.postMessage({key:e,result:""}),self.postMessage({key:e,result:null})}async function Rt(t){let e=t.key,{type:r,input:n,passphrase:o,autoCalculateIterations:i}=t;try{if(r=="encrypt"){let a=await J(n,o,i);self.postMessage({key:e,result:a})}else if(r=="decrypt"){let a=await q(n,o,i);self.postMessage({key:e,result:a})}}catch(a){self.postMessage({key:e,error:a})}}self.onmessage=t=>{let e=t.data.data;if(e.type==="split")return Wt(e);if(e.type==="encrypt"||e.type==="decrypt")return Rt(e);self.postMessage({key:e.key,error:new Error("Invalid type")})};\n')}var EVENT_LAYOUT_READY="layout-ready",EVENT_PLUGIN_LOADED="plugin-loaded",EVENT_PLUGIN_UNLOADED="plugin-unloaded",EVENT_SETTING_SAVED="setting-saved",EVENT_FILE_RENAMED="file-renamed",EVENT_FILE_SAVED="file-saved",EVENT_LEAF_ACTIVE_CHANGED="leaf-active-changed",EVENT_LOG_ADDED="log-added",EVENT_REQUEST_OPEN_SETTINGS="request-open-settings",EVENT_REQUEST_OPEN_SETTING_WIZARD="request-open-setting-wizard",EVENT_REQUEST_OPEN_SETUP_URI="request-open-setup-uri",EVENT_REQUEST_COPY_SETUP_URI="request-copy-setup-uri",EVENT_REQUEST_RELOAD_SETTING_TAB="reload-setting-tab",EVENT_REQUEST_OPEN_PLUGIN_SYNC_DIALOG="request-open-plugin-sync-dialog",tasks=new Map,maxConcurrency=~~((navigator.hardwareConcurrency||8)/2),roundRobinIdx=0,workers=Array.from({length:maxConcurrency},(()=>({worker:Worker2(),processing:0})));function handleTaskSplit(process2,data){const key2=data.key,task=process2.task;if("result"in data)if(null===data.result){task.resolve(null);tasks.delete(key2)}else{task.resolve(data.result);process2.task=promiseWithResolver()}else{if(data.error)task.reject(data.error);else task.reject(new Error("Unknown error in background splitting"));tasks.delete(key2)}}function handleTaskEncrypt(process2,data){const key2=data.key,task=process2.task;if("result"in data)task.resolve(data.result);else if(data.error)task.reject(data.error);else task.reject(new Error("Unknown error in background encryption"));tasks.delete(key2)}for(const inst of workers){inst.worker.onmessage=({data})=>{const key2=data.key,process2=tasks.get(key2);if(process2)if("split"===process2.type)handleTaskSplit(process2,data);else if("encrypt"===process2.type||"decrypt"===process2.type)handleTaskEncrypt(process2,data);else info("Invalid response type"+process2);else info(`Invalid key ${key2} of background processing`,LOG_KIND_ERROR)};inst.worker.onerror=()=>{inst.worker.terminate();workers.remove(inst)}}function terminateWorker(){for(const inst of workers)inst.worker.terminate()}function splitPieces2Worker(dataSrc,pieceSize,plainSplit,minimumChunkSize,filename,useSegmenter){return _splitPieces2Worker(dataSrc,pieceSize,plainSplit,minimumChunkSize,filename,false,null!=useSegmenter?useSegmenter:false)}function splitPieces2WorkerV2(dataSrc,pieceSize,plainSplit,minimumChunkSize,filename,useSegmenter){return _splitPieces2Worker(dataSrc,pieceSize,plainSplit,minimumChunkSize,filename,true,null!=useSegmenter?useSegmenter:false)}function encryptWorker(input,passphrase,autoCalculateIterations){return encryptionOnWorker({type:"encrypt",input,passphrase,autoCalculateIterations})}function decryptWorker(input,passphrase,autoCalculateIterations){return encryptionOnWorker({type:"decrypt",input,passphrase,autoCalculateIterations})}function startWorker(data){const _key=key++,inst=nextWorker(),item={key:_key,task:promiseWithResolver(),type:data.type,finalize:()=>{inst.processing--}};tasks.set(_key,item);inst.processing++;inst.worker.postMessage({data:{...data,key:_key}});return item}function encryptionOnWorker(data){const process2=startWorker(data);return(async()=>{const ret=await process2.task.promise;process2.finalize();return ret})()}function nextWorker(){const inst=workers[roundRobinIdx];roundRobinIdx=(roundRobinIdx+1)%workers.length;return inst}var key=0;function _splitPieces2Worker(dataSrc,pieceSize,plainSplit,minimumChunkSize,filename,useV2,useSegmenter){const process2=startWorker({type:"split",dataSrc,pieceSize,plainSplit,minimumChunkSize,filename,useV2,useSegmenter}),_key=process2.key;return async function*(){for(;tasks.has(_key);){const{task}=tasks.get(_key),result=await task.promise;if(null===result){process2.finalize();return}yield result}}}eventHub.onEvent(EVENT_PLUGIN_UNLOADED,(()=>{terminateWorker()}));var queueTails=new Map;async function performTask(queue2){if(!queue2.isRunning)try{queue2.isRunning=true;const ret=await queue2.task();queue2.resolver(ret)}catch(ex){queue2.rejector(ex)}finally{const next=queue2.next;queue2.isFinished=true;if(next)fireAndForget((async()=>{await yieldNextMicrotask(),performTask(next)}));else queueTails.delete(queue2.key)}}function _enqueue(key2,task,{swapIfExist,shareResult}={}){const t4=promiseWithResolver(),newQueue={task,resolver:t4.resolve,rejector:t4.reject,key:key2},prev=queueTails.get(key2);if(void 0===prev)queueTails.set(key2,newQueue);else{const current=prev;queueTails.set(key2,newQueue);current.next=newQueue;if(swapIfExist)current.rejector(new Error("Cancelled"))}if(!prev||prev.isFinished)fireAndForget((()=>performTask(newQueue)));return t4.promise}function serialized(key2,proc){return _enqueue(key2,proc)}function shareRunningResult(key2,proc){const current=queueTails.get(key2);if(!current)return _enqueue(key2,proc);let oldResolver=current.resolver,oldRejector=current.rejector;const resultP=promiseWithResolver();current.resolver=result=>{null==oldResolver||oldResolver(result);resultP.resolve(result)};current.rejector=result=>{null==oldRejector||oldRejector(result);resultP.reject(result)};resultP.promise.finally((()=>{oldResolver=void 0;oldRejector=void 0}));return resultP.promise}function skipIfDuplicated(key2,proc){if(void 0!==queueTails.get(key2))return Promise.resolve(null);else return _enqueue(key2,proc)}var waitingProcess=new Map;async function scheduleOnceIfDuplicated(key2,proc){if(!isLockAcquired(key2)){await serialized(key2,proc);if(waitingProcess.has(key2)){const nextProc=waitingProcess.get(key2);waitingProcess.delete(key2);scheduleOnceIfDuplicated(key2,nextProc)}}else waitingProcess.set(key2,proc)}function isLockAcquired(key2){return void 0!==queueTails.get(key2)}var Notifier=class{constructor(){Object.defineProperty(this,"_p",{enumerable:true,configurable:true,writable:true,value:promiseWithResolver()});Object.defineProperty(this,"isUsed",{enumerable:true,configurable:true,writable:true,value:false})}notify(){if(this.isUsed){this.isUsed=false;this._p.promise.finally(noop);this._p.resolve();this._p=promiseWithResolver()}}get nextNotify(){this.isUsed=true;return this._p.promise}},processNo=0,allRunningProcessors=new Set([]),QueueProcessor=class{get nowProcessing(){return this.processingEntities}get totalNowProcessing(){var _a5;return this.nowProcessing+((null==(_a5=this._pipeTo)?void 0:_a5.totalNowProcessing)||0)}get remaining(){return this._queue.length+this.processingEntities+this.waitingEntries}get totalRemaining(){var _a5;return this.remaining+((null==(_a5=this._pipeTo)?void 0:_a5.totalRemaining)||0)}updateStatus(setFunc){setFunc();this._updateReactiveSource()}suspend(){this._isSuspended=true;this._notifier.notify();return this}resume(){this._isSuspended=false;this._notifier.notify();this.requestNextFlush();this._run();return this}resumePipeLine(){var _a5;null==(_a5=this._pipeTo)||_a5.resumePipeLine();this.resume();return this}startPipeline(){this.root.resumePipeLine();return this}get root(){if(void 0===this._root)return this;else return this._root}constructor(processor,params,items,enqueueProcessor){var _a5,_b2,_c2,_d2,_e2,_f,_g;Object.defineProperty(this,"_queue",{enumerable:true,configurable:true,writable:true,value:[]});Object.defineProperty(this,"_processor",{enumerable:true,configurable:true,writable:true,value:void 0});Object.defineProperty(this,"_enqueueProcessor",{enumerable:true,configurable:true,writable:true,value:(queue2,entity)=>(queue2.push(entity),queue2)});Object.defineProperty(this,"_isSuspended",{enumerable:true,configurable:true,writable:true,value:true});Object.defineProperty(this,"_nextProcessNeedsImmediate",{enumerable:true,configurable:true,writable:true,value:false});Object.defineProperty(this,"_pipeTo",{enumerable:true,configurable:true,writable:true,value:void 0});Object.defineProperty(this,"_waitId",{enumerable:true,configurable:true,writable:true,value:""});Object.defineProperty(this,"_root",{enumerable:true,configurable:true,writable:true,value:void 0});Object.defineProperty(this,"_instance",{enumerable:true,configurable:true,writable:true,value:processNo++});Object.defineProperty(this,"_remainingReactiveSource",{enumerable:true,configurable:true,writable:true,value:void 0});Object.defineProperty(this,"_totalRemainingReactiveSource",{enumerable:true,configurable:true,writable:true,value:void 0});Object.defineProperty(this,"_processingEntitiesReactiveSource",{enumerable:true,configurable:true,writable:true,value:void 0});Object.defineProperty(this,"_keepResultUntilDownstreamConnected",{enumerable:true,configurable:true,writable:true,value:false});Object.defineProperty(this,"_keptResult",{enumerable:true,configurable:true,writable:true,value:[]});Object.defineProperty(this,"_runOnUpdateBatch",{enumerable:true,configurable:true,writable:true,value:()=>{}});Object.defineProperty(this,"concurrentLimit",{enumerable:true,configurable:true,writable:true,value:1});Object.defineProperty(this,"batchSize",{enumerable:true,configurable:true,writable:true,value:1});Object.defineProperty(this,"yieldThreshold",{enumerable:true,configurable:true,writable:true,value:1});Object.defineProperty(this,"delay",{enumerable:true,configurable:true,writable:true,value:0});Object.defineProperty(this,"maintainDelay",{enumerable:true,configurable:true,writable:true,value:void 0});Object.defineProperty(this,"interval",{enumerable:true,configurable:true,writable:true,value:0});Object.defineProperty(this,"processingEntities",{enumerable:true,configurable:true,writable:true,value:0});Object.defineProperty(this,"waitingEntries",{enumerable:true,configurable:true,writable:true,value:0});Object.defineProperty(this,"_notifier",{enumerable:true,configurable:true,writable:true,value:new Notifier});Object.defineProperty(this,"_processingBatches",{enumerable:true,configurable:true,writable:true,value:new Set});Object.defineProperty(this,"addProcessingBatch",{enumerable:true,configurable:true,writable:true,value:value=>{const r2=this._processingBatches.add(value);this._updateBatchProcessStatus();return r2}});Object.defineProperty(this,"deleteProcessingBatch",{enumerable:true,configurable:true,writable:true,value:value=>{const r2=this._processingBatches.delete(value);this._updateBatchProcessStatus();return r2}});Object.defineProperty(this,"_processing",{enumerable:true,configurable:true,writable:true,value:false});this._root=this;this._processor=processor;this.batchSize=null!=(_a5=null==params?void 0:params.batchSize)?_a5:1;this.yieldThreshold=null!=(_c2=null!=(_b2=null==params?void 0:params.yieldThreshold)?_b2:null==params?void 0:params.batchSize)?_c2:0;this.concurrentLimit=null!=(_d2=null==params?void 0:params.concurrentLimit)?_d2:1;this.delay=null!=(_e2=null==params?void 0:params.delay)?_e2:0;this.maintainDelay=null!=(_f=null==params?void 0:params.maintainDelay)?_f:false;this.interval=null!=(_g=null==params?void 0:params.interval)?_g:0;if(null==params?void 0:params.keepResultUntilDownstreamConnected)this._keepResultUntilDownstreamConnected=params.keepResultUntilDownstreamConnected;if(null==params?void 0:params.remainingReactiveSource)this._remainingReactiveSource=null==params?void 0:params.remainingReactiveSource;if(null==params?void 0:params.totalRemainingReactiveSource)this._totalRemainingReactiveSource=null==params?void 0:params.totalRemainingReactiveSource;if(null==params?void 0:params.processingEntitiesReactiveSource)this._processingEntitiesReactiveSource=null==params?void 0:params.processingEntitiesReactiveSource;if(void 0!==(null==params?void 0:params.suspended))this._isSuspended=null==params?void 0:params.suspended;if(enqueueProcessor)this.replaceEnqueueProcessor(enqueueProcessor);if(void 0!==(null==params?void 0:params.pipeTo))this.pipeTo(params.pipeTo);if(items)this.enqueueAll(items);allRunningProcessors.add(this);this._run()}replaceEnqueueProcessor(processor){this._enqueueProcessor=processor;return this}modifyQueue(processor){this._queue=processor(this._queue);this._notifier.notify()}clearQueue(){this._queue=[];this._notifier.notify()}onUpdateProgress(proc){this._runOnUpdateBatch=proc;return this}pipeTo(pipeTo){this._pipeTo=pipeTo;this._pipeTo._root=this.root;if(this._keptResult.length>0){const temp=[...this._keptResult];this._keptResult=[];this._pipeTo.enqueueAll(temp)}return pipeTo}isIdle(){return this._isIdle()&&(!this._pipeTo?true:this._pipeTo.isIdle())}_isIdle(){return 0==this.totalRemaining}async _idleDetector(){if(this._isSuspended)return Promise.resolve();if(this._isIdle())return Promise.resolve();do{await Promise.race([delay(3e3),this._notifier.nextNotify])}while(!this._isIdle());return Promise.resolve()}idleDetectors(){const thisPromise=this._idleDetector();if(this._pipeTo)return[thisPromise,...this._pipeTo.idleDetectors()];else return[thisPromise]}get isSuspended(){var _a5;return this._isSuspended||(null==(_a5=this._pipeTo)?void 0:_a5.isSuspended)||false}_updateReactiveSource(){this.root.updateReactiveSource()}updateReactiveSource(){if(this._pipeTo)this._pipeTo.updateReactiveSource();if(this._remainingReactiveSource)this._remainingReactiveSource.value=this.remaining;if(this._totalRemainingReactiveSource)this._totalRemainingReactiveSource.value=this.totalRemaining;if(this._processingEntitiesReactiveSource)this._processingEntitiesReactiveSource.value=this.nowProcessing}_updateBatchProcessStatus(){this._updateReactiveSource();this._runOnUpdateBatch()}_collectBatch(){return this._queue.splice(0,this.batchSize)}_canCollectBatch(){return 0!==this._queue.length}enqueue(entity){this._queue=this._enqueueProcessor(this._queue,entity);this._updateBatchProcessStatus();this._notifier.notify();return this}enqueueAll(entities){let queue2=this._queue;for(const v2 of entities)queue2=this._enqueueProcessor(queue2,v2);this._queue=queue2;this._updateBatchProcessStatus();this._notifier.notify();return this}requestNextFlush(){if(this._canCollectBatch()){this._nextProcessNeedsImmediate=true;this._notifier.notify()}}flush(){if(!this._isSuspended){this.requestNextFlush();return this.waitForAllDownstream()}}async waitForAllDownstream(timeout){const baseTasks=[];if(timeout)baseTasks.push(delay(timeout,RESULT_TIMED_OUT));do{const idleTasks=this.idleDetectors(),tasks4=[...baseTasks,Promise.all(idleTasks)];if(await Promise.race(tasks4)===RESULT_TIMED_OUT)return false}while(!this.isIdle());return true}waitForAllProcessed(timeout){this.root.startPipeline();return this.root.waitForAllDownstream(timeout)}async waitForAllDoneAndTerminate(timeout){this.root.startPipeline();const r2=await this.root.waitForAllDownstream(timeout);this.terminateAll();return r2}async _runProcessor(items){const ret=await this._processor(items);if(ret)if(this._pipeTo)this._pipeTo.enqueueAll(ret);else if(this._keepResultUntilDownstreamConnected)this._keptResult.push(...ret)}async*pump(){let items,queueRunOut=true;do{await yieldNextMicrotask();if(this._canCollectBatch()){if(queueRunOut)await this.delayUntilRequested(this.delay);items=this._collectBatch();if(0!=items.length){yield items;if(this._canCollectBatch())queueRunOut=false}}else{queueRunOut=true;await Promise.race([this._notifier.nextNotify,delay(3e3)])}}while(this._canCollectBatch()&&!this._isSuspended)}async delayUntilRequested(delayMs){if(this._nextProcessNeedsImmediate){this._nextProcessNeedsImmediate=false;return}const delayTimer=delay(delayMs,RESULT_TIMED_OUT);let ret;do{ret=await Promise.race([this._notifier.nextNotify,delayTimer])}while(ret!==RESULT_TIMED_OUT&&false===this._nextProcessNeedsImmediate&&this.yieldThreshold>=this._queue.length);this._nextProcessNeedsImmediate=false}async _process(){if(this._processing&&this._isSuspended)return;let lastProcessBegin=0;try{this._processing=true;do{const batchPump=this.pump();for await(const batch of batchPump){const batchLength=batch.length;this.updateStatus((()=>{this.waitingEntries+=batchLength}));for(;this._processingBatches.size>=this.concurrentLimit;)await this._notifier.nextNotify;const key2=Date.now()+Math.random(),batchTask=async()=>{this.updateStatus((()=>{this.processingEntities+=batchLength;this.waitingEntries-=batchLength}));this.addProcessingBatch(key2);try{if(this.interval&&lastProcessBegin){const diff=Date.now()-lastProcessBegin;if(diff<this.interval){const delayMs=this.interval-diff;await delay(delayMs)}}lastProcessBegin=Date.now();await this._runProcessor(batch)}catch(ex){Logger("Processor error!");Logger(ex,LOG_LEVEL_VERBOSE)}finally{this.deleteProcessingBatch(key2);this.updateStatus((()=>{this.processingEntities-=batchLength}));this._notifier.notify()}};this._notifier.notify();fireAndForget((async()=>{await yieldNextMicrotask();await batchTask()}))}await this._notifier.nextNotify}while(!this._isSuspended)}finally{this._processing=false}}_run(){if(!this._isSuspended)if(!this._processing)fireAndForget((()=>this._process()))}terminateAll(){this.root.terminate()}terminate(){if(this._pipeTo){this._pipeTo.terminate();this._pipeTo=void 0}this._isSuspended=true;this._enqueueProcessor=()=>[];this._processor=()=>Promise.resolve([]);this.clearQueue();this._notifier.notify();this._notifier.notify();this._notifier.notify();this._queue.length=0;allRunningProcessors.delete(this)}};function stopAllRunningProcessors(){const processors=[...allRunningProcessors];for(const processor of processors)processor.terminate()}var ch2={},wk=function(c2,id,msg,transfer,cb2){var w2=new Worker(ch2[id]||(ch2[id]=URL.createObjectURL(new Blob([c2+';addEventListener("error",function(e){e=e.error;postMessage({$e$:[e.message,e.code,e.stack]})})'],{type:"text/javascript"}))));w2.onmessage=function(e4){var d4=e4.data,ed=d4.$e$;if(ed){var err2=new Error(ed[0]);err2["code"]=ed[1];err2.stack=ed[2];cb2(err2,null)}else cb2(null,d4)};w2.postMessage(msg,transfer);return w2},u8=Uint8Array,u16=Uint16Array,i32=Int32Array,fleb=new u8([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),fdeb=new u8([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),clim=new u8([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),freb=function(eb,start){for(var b3=new u16(31),i2=0;i2<31;++i2)b3[i2]=start+=1<<eb[i2-1];var r2=new i32(b3[30]);for(i2=1;i2<30;++i2)for(var j2=b3[i2];j2<b3[i2+1];++j2)r2[j2]=j2-b3[i2]<<5|i2;return{b:b3,r:r2}},_a=freb(fleb,2),fl=_a.b,revfl=_a.r;fl[28]=258,revfl[258]=28;var _b=freb(fdeb,0),fd=_b.b,revfd=_b.r,rev=new u16(32768);for(i2=0;i2<32768;++i2){x2=(61680&(x2=(52428&(x2=(43690&i2)>>1|(21845&i2)<<1))>>2|(13107&x2)<<2))>>4|(3855&x2)<<4;rev[i2]=((65280&x2)>>8|(255&x2)<<8)>>1}var hMap=function(cd2,mb,r2){for(var s2=cd2.length,i2=0,l2=new u16(mb);i2<s2;++i2)if(cd2[i2])++l2[cd2[i2]-1];var co2,le=new u16(mb);for(i2=1;i2<mb;++i2)le[i2]=le[i2-1]+l2[i2-1]<<1;if(r2){co2=new u16(1<<mb);var rvb=15-mb;for(i2=0;i2<s2;++i2)if(cd2[i2])for(var sv=i2<<4|cd2[i2],r_1=mb-cd2[i2],v2=le[cd2[i2]-1]++<<r_1,m2=v2|(1<<r_1)-1;v2<=m2;++v2)co2[rev[v2]>>rvb]=sv}else{co2=new u16(s2);for(i2=0;i2<s2;++i2)if(cd2[i2])co2[i2]=rev[le[cd2[i2]-1]++]>>15-cd2[i2]}return co2},flt=new u8(288);for(i2=0;i2<144;++i2)flt[i2]=8;for(i2=144;i2<256;++i2)flt[i2]=9;for(i2=256;i2<280;++i2)flt[i2]=7;for(i2=280;i2<288;++i2)flt[i2]=8;var fdt=new u8(32);for(i2=0;i2<32;++i2)fdt[i2]=5;var flm=hMap(flt,9,0),flrm=hMap(flt,9,1),fdm=hMap(fdt,5,0),fdrm=hMap(fdt,5,1),max=function(a2){for(var m2=a2[0],i2=1;i2<a2.length;++i2)if(a2[i2]>m2)m2=a2[i2];return m2},bits=function(d4,p2,m2){var o2=p2/8|0;return(d4[o2]|d4[o2+1]<<8)>>(7&p2)&m2},bits16=function(d4,p2){var o2=p2/8|0;return(d4[o2]|d4[o2+1]<<8|d4[o2+2]<<16)>>(7&p2)},shft=function(p2){return(p2+7)/8|0},slc=function(v2,s2,e4){if(null==s2||s2<0)s2=0;if(null==e4||e4>v2.length)e4=v2.length;return new u8(v2.subarray(s2,e4))},FlateErrorCode={UnexpectedEOF:0,InvalidBlockType:1,InvalidLengthLiteral:2,InvalidDistance:3,StreamFinished:4,NoStreamHandler:5,InvalidHeader:6,NoCallback:7,InvalidUTF8:8,ExtraFieldTooLong:9,InvalidDate:10,FilenameTooLong:11,StreamFinishing:12,InvalidZipData:13,UnknownCompressionMethod:14},ec=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],err=function(ind,msg,nt){var e4=new Error(msg||ec[ind]);e4.code=ind;if(Error.captureStackTrace)Error.captureStackTrace(e4,err);if(!nt)throw e4;return e4},inflt=function(dat,st,buf,dict){var sl=dat.length,dl=dict?dict.length:0;if(!sl||st.f&&!st.l)return buf||new u8(0);var noBuf=!buf,resize=noBuf||2!=st.i,noSt=st.i;if(noBuf)buf=new u8(3*sl);var cbuf=function(l3){var bl2=buf.length;if(l3>bl2){var nbuf=new u8(Math.max(2*bl2,l3));nbuf.set(buf);buf=nbuf}},final=st.f||0,pos=st.p||0,bt2=st.b||0,lm=st.l,dm=st.d,lbt=st.m,dbt=st.n,tbts=8*sl;do{if(!lm){final=bits(dat,pos,1);var type=bits(dat,pos+1,3);pos+=3;if(!type){var l2=dat[(s2=shft(pos)+4)-4]|dat[s2-3]<<8,t4=s2+l2;if(t4>sl){if(noSt)err(0);break}if(resize)cbuf(bt2+l2);buf.set(dat.subarray(s2,t4),bt2);st.b=bt2+=l2,st.p=pos=8*t4,st.f=final;continue}else if(1==type)lm=flrm,dm=fdrm,lbt=9,dbt=5;else if(2==type){var hLit=bits(dat,pos,31)+257,hcLen=bits(dat,pos+10,15)+4,tl=hLit+bits(dat,pos+5,31)+1;pos+=14;for(var ldt=new u8(tl),clt=new u8(19),i2=0;i2<hcLen;++i2)clt[clim[i2]]=bits(dat,pos+3*i2,7);pos+=3*hcLen;var clb=max(clt),clbmsk=(1<<clb)-1,clm=hMap(clt,clb,1);for(i2=0;i2<tl;){var s2,r2=clm[bits(dat,pos,clbmsk)];pos+=15&r2;if((s2=r2>>4)<16)ldt[i2++]=s2;else{var c2=0,n3=0;if(16==s2)n3=3+bits(dat,pos,3),pos+=2,c2=ldt[i2-1];else if(17==s2)n3=3+bits(dat,pos,7),pos+=3;else if(18==s2)n3=11+bits(dat,pos,127),pos+=7;for(;n3--;)ldt[i2++]=c2}}var lt=ldt.subarray(0,hLit),dt=ldt.subarray(hLit);lbt=max(lt);dbt=max(dt);lm=hMap(lt,lbt,1);dm=hMap(dt,dbt,1)}else err(1);if(pos>tbts){if(noSt)err(0);break}}if(resize)cbuf(bt2+131072);for(var lms=(1<<lbt)-1,dms=(1<<dbt)-1,lpos=pos;;lpos=pos){var sym=(c2=lm[bits16(dat,pos)&lms])>>4;if((pos+=15&c2)>tbts){if(noSt)err(0);break}if(!c2)err(2);if(sym<256)buf[bt2++]=sym;else if(256==sym){lpos=pos,lm=null;break}else{var add=sym-254;if(sym>264){var b3=fleb[i2=sym-257];add=bits(dat,pos,(1<<b3)-1)+fl[i2];pos+=b3}var d4=dm[bits16(dat,pos)&dms],dsym=d4>>4;if(!d4)err(3);pos+=15&d4;dt=fd[dsym];if(dsym>3){b3=fdeb[dsym];dt+=bits16(dat,pos)&(1<<b3)-1,pos+=b3}if(pos>tbts){if(noSt)err(0);break}if(resize)cbuf(bt2+131072);var end=bt2+add;if(bt2<dt){var shift=dl-dt,dend=Math.min(dt,end);if(shift+bt2<0)err(3);for(;bt2<dend;++bt2)buf[bt2]=dict[shift+bt2]}for(;bt2<end;++bt2)buf[bt2]=buf[bt2-dt]}}st.l=lm,st.p=lpos,st.b=bt2,st.f=final;if(lm)final=1,st.m=lbt,st.d=dm,st.n=dbt}while(!final);return bt2!=buf.length&&noBuf?slc(buf,0,bt2):buf.subarray(0,bt2)},wbits=function(d4,p2,v2){v2<<=7&p2;var o2=p2/8|0;d4[o2]|=v2;d4[o2+1]|=v2>>8},wbits16=function(d4,p2,v2){v2<<=7&p2;var o2=p2/8|0;d4[o2]|=v2;d4[o2+1]|=v2>>8;d4[o2+2]|=v2>>16},hTree=function(d4,mb){for(var t4=[],i2=0;i2<d4.length;++i2)if(d4[i2])t4.push({s:i2,f:d4[i2]});var s2=t4.length,t22=t4.slice();if(!s2)return{t:et,l:0};if(1==s2){var v2=new u8(t4[0].s+1);v2[t4[0].s]=1;return{t:v2,l:1}}t4.sort((function(a2,b3){return a2.f-b3.f}));t4.push({s:-1,f:25001});var l2=t4[0],r2=t4[1],i0=0,i1=1,i22=2;t4[0]={s:-1,f:l2.f+r2.f,l:l2,r:r2};for(;i1!=s2-1;){l2=t4[t4[i0].f<t4[i22].f?i0++:i22++];r2=t4[i0!=i1&&t4[i0].f<t4[i22].f?i0++:i22++];t4[i1++]={s:-1,f:l2.f+r2.f,l:l2,r:r2}}var maxSym=t22[0].s;for(i2=1;i2<s2;++i2)if(t22[i2].s>maxSym)maxSym=t22[i2].s;var tr=new u16(maxSym+1),mbt=ln(t4[i1-1],tr,0);if(mbt>mb){i2=0;var dt=0,lft=mbt-mb,cst=1<<lft;t22.sort((function(a2,b3){return tr[b3.s]-tr[a2.s]||a2.f-b3.f}));for(;i2<s2;++i2){var i2_1=t22[i2].s;if(tr[i2_1]>mb){dt+=cst-(1<<mbt-tr[i2_1]);tr[i2_1]=mb}else break}dt>>=lft;for(;dt>0;){var i2_2=t22[i2].s;if(tr[i2_2]<mb)dt-=1<<mb-tr[i2_2]++-1;else++i2}for(;i2>=0&&dt;--i2){var i2_3=t22[i2].s;if(tr[i2_3]==mb){--tr[i2_3];++dt}}mbt=mb}return{t:new u8(tr),l:mbt}},ln=function(n3,l2,d4){return-1==n3.s?Math.max(ln(n3.l,l2,d4+1),ln(n3.r,l2,d4+1)):l2[n3.s]=d4},lc=function(c2){for(var s2=c2.length;s2&&!c2[--s2];);for(var cl2=new u16(++s2),cli=0,cln=c2[0],cls=1,w2=function(v2){cl2[cli++]=v2},i2=1;i2<=s2;++i2)if(c2[i2]==cln&&i2!=s2)++cls;else{if(!cln&&cls>2){for(;cls>138;cls-=138)w2(32754);if(cls>2){w2(cls>10?cls-11<<5|28690:cls-3<<5|12305);cls=0}}else if(cls>3){w2(cln),--cls;for(;cls>6;cls-=6)w2(8304);if(cls>2)w2(cls-3<<5|8208),cls=0}for(;cls--;)w2(cln);cls=1;cln=c2[i2]}return{c:cl2.subarray(0,cli),n:s2}},clen=function(cf2,cl2){for(var l2=0,i2=0;i2<cl2.length;++i2)l2+=cf2[i2]*cl2[i2];return l2},wfblk=function(out,pos,dat){var s2=dat.length,o2=shft(pos+2);out[o2]=255&s2;out[o2+1]=s2>>8;out[o2+2]=255^out[o2];out[o2+3]=255^out[o2+1];for(var i2=0;i2<s2;++i2)out[o2+i2+4]=dat[i2];return 8*(o2+4+s2)},wblk=function(dat,out,final,syms,lf,df,eb,li,bs2,bl2,p2){wbits(out,p2++,final);++lf[256];for(var _a5=hTree(lf,15),dlt=_a5.t,mlb=_a5.l,_b2=hTree(df,15),ddt=_b2.t,mdb=_b2.l,_c2=lc(dlt),lclt=_c2.c,nlc=_c2.n,_d2=lc(ddt),lcdt=_d2.c,ndc=_d2.n,lcfreq=new u16(19),i2=0;i2<lclt.length;++i2)++lcfreq[31&lclt[i2]];for(i2=0;i2<lcdt.length;++i2)++lcfreq[31&lcdt[i2]];for(var _e2=hTree(lcfreq,7),lct=_e2.t,mlcb=_e2.l,nlcc=19;nlcc>4&&!lct[clim[nlcc-1]];--nlcc);var lm,ll,dm,dl,flen=bl2+5<<3,ftlen=clen(lf,flt)+clen(df,fdt)+eb,dtlen=clen(lf,dlt)+clen(df,ddt)+eb+14+3*nlcc+clen(lcfreq,lct)+2*lcfreq[16]+3*lcfreq[17]+7*lcfreq[18];if(bs2>=0&&flen<=ftlen&&flen<=dtlen)return wfblk(out,p2,dat.subarray(bs2,bs2+bl2));wbits(out,p2,1+(dtlen<ftlen)),p2+=2;if(dtlen<ftlen){lm=hMap(dlt,mlb,0),ll=dlt,dm=hMap(ddt,mdb,0),dl=ddt;var llm=hMap(lct,mlcb,0);wbits(out,p2,nlc-257);wbits(out,p2+5,ndc-1);wbits(out,p2+10,nlcc-4);p2+=14;for(i2=0;i2<nlcc;++i2)wbits(out,p2+3*i2,lct[clim[i2]]);p2+=3*nlcc;for(var lcts=[lclt,lcdt],it=0;it<2;++it){var clct=lcts[it];for(i2=0;i2<clct.length;++i2){var len=31&clct[i2];wbits(out,p2,llm[len]),p2+=lct[len];if(len>15)wbits(out,p2,clct[i2]>>5&127),p2+=clct[i2]>>12}}}else lm=flm,ll=flt,dm=fdm,dl=fdt;for(i2=0;i2<li;++i2){var sym=syms[i2];if(sym>255){wbits16(out,p2,lm[257+(len=sym>>18&31)]),p2+=ll[len+257];if(len>7)wbits(out,p2,sym>>23&31),p2+=fleb[len];var dst=31&sym;wbits16(out,p2,dm[dst]),p2+=dl[dst];if(dst>3)wbits16(out,p2,sym>>5&8191),p2+=fdeb[dst]}else wbits16(out,p2,lm[sym]),p2+=ll[sym]}wbits16(out,p2,lm[256]);return p2+ll[256]},deo=new i32([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),et=new u8(0),dflt=function(dat,lvl,plvl,pre,post,st){var s2=st.z||dat.length,o2=new u8(pre+s2+5*(1+Math.ceil(s2/7e3))+post),w2=o2.subarray(pre,o2.length-post),lst=st.l,pos=7&(st.r||0);if(lvl){if(pos)w2[0]=st.r>>3;for(var opt=deo[lvl-1],n3=opt>>13,c2=8191&opt,msk_1=(1<<plvl)-1,prev=st.p||new u16(32768),head=st.h||new u16(msk_1+1),bs1_1=Math.ceil(plvl/3),bs2_1=2*bs1_1,hsh=function(i3){return(dat[i3]^dat[i3+1]<<bs1_1^dat[i3+2]<<bs2_1)&msk_1},syms=new i32(25e3),lf=new u16(288),df=new u16(32),lc_1=0,eb=0,i2=st.i||0,li=0,wi=st.w||0,bs2=0;i2+2<s2;++i2){var hv=hsh(i2),imod=32767&i2,pimod=head[hv];prev[imod]=pimod;head[hv]=imod;if(wi<=i2){var rem=s2-i2;if((lc_1>7e3||li>24576)&&(rem>423||!lst)){pos=wblk(dat,w2,0,syms,lf,df,eb,li,bs2,i2-bs2,pos);li=lc_1=eb=0,bs2=i2;for(var j2=0;j2<286;++j2)lf[j2]=0;for(j2=0;j2<30;++j2)df[j2]=0}var l2=2,d4=0,ch_1=c2,dif=imod-pimod&32767;if(rem>2&&hv==hsh(i2-dif))for(var maxn=Math.min(n3,rem)-1,maxd=Math.min(32767,i2),ml=Math.min(258,rem);dif<=maxd&&--ch_1&&imod!=pimod;){if(dat[i2+l2]==dat[i2+l2-dif]){for(var nl=0;nl<ml&&dat[i2+nl]==dat[i2+nl-dif];++nl);if(nl>l2){l2=nl,d4=dif;if(nl>maxn)break;var mmd=Math.min(dif,nl-2),md=0;for(j2=0;j2<mmd;++j2){var ti=i2-dif+j2&32767,cd2=ti-prev[ti]&32767;if(cd2>md)md=cd2,pimod=ti}}}dif+=(imod=pimod)-(pimod=prev[imod])&32767}if(d4){syms[li++]=268435456|revfl[l2]<<18|revfd[d4];var lin=31&revfl[l2],din=31&revfd[d4];eb+=fleb[lin]+fdeb[din];++lf[257+lin];++df[din];wi=i2+l2;++lc_1}else{syms[li++]=dat[i2];++lf[dat[i2]]}}}for(i2=Math.max(i2,wi);i2<s2;++i2){syms[li++]=dat[i2];++lf[dat[i2]]}pos=wblk(dat,w2,lst,syms,lf,df,eb,li,bs2,i2-bs2,pos);if(!lst){st.r=7&pos|w2[pos/8|0]<<3;pos-=7;st.h=head,st.p=prev,st.i=i2,st.w=wi}}else{for(i2=st.w||0;i2<s2+lst;i2+=65535){var e4=i2+65535;if(e4>=s2){w2[pos/8|0]=lst;e4=s2}pos=wfblk(w2,pos+1,dat.subarray(i2,e4))}st.i=s2}return slc(o2,0,pre+shft(pos)+post)},crct=function(){for(var t4=new Int32Array(256),i2=0;i2<256;++i2){for(var c2=i2,k2=9;--k2;)c2=(1&c2&&-306674912)^c2>>>1;t4[i2]=c2}return t4}(),crc=function(){var c2=-1;return{p:function(d4){for(var cr2=c2,i2=0;i2<d4.length;++i2)cr2=crct[255&cr2^d4[i2]]^cr2>>>8;c2=cr2},d:function(){return~c2}}},adler=function(){var a2=1,b3=0;return{p:function(d4){for(var n3=a2,m2=b3,l2=0|d4.length,i2=0;i2!=l2;){for(var e4=Math.min(i2+2655,l2);i2<e4;++i2)m2+=n3+=d4[i2];n3=(65535&n3)+15*(n3>>16),m2=(65535&m2)+15*(m2>>16)}a2=n3,b3=m2},d:function(){return(255&(a2%=65521))<<24|(65280&a2)<<8|(255&(b3%=65521))<<8|b3>>8}}},dopt=function(dat,opt,pre,post,st){if(!st){st={l:1};if(opt.dictionary){var dict=opt.dictionary.subarray(-32768),newDat=new u8(dict.length+dat.length);newDat.set(dict);newDat.set(dat,dict.length);dat=newDat;st.w=dict.length}}return dflt(dat,null==opt.level?6:opt.level,null==opt.mem?st.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(dat.length)))):20:12+opt.mem,pre,post,st)},mrg=function(a2,b3){var o2={};for(var k2 in a2)o2[k2]=a2[k2];for(var k2 in b3)o2[k2]=b3[k2];return o2},wcln=function(fn,fnStr,td3){for(var dt=fn(),st=fn.toString(),ks=st.slice(st.indexOf("[")+1,st.lastIndexOf("]")).replace(/\s+/g,"").split(","),i2=0;i2<dt.length;++i2){var v2=dt[i2],k2=ks[i2];if("function"==typeof v2){fnStr+=";"+k2+"=";var st_1=v2.toString();if(v2.prototype)if(-1!=st_1.indexOf("[native code]")){var spInd=st_1.indexOf(" ",8)+1;fnStr+=st_1.slice(spInd,st_1.indexOf("(",spInd))}else{fnStr+=st_1;for(var t4 in v2.prototype)fnStr+=";"+k2+".prototype."+t4+"="+v2.prototype[t4].toString()}else fnStr+=st_1}else td3[k2]=v2}return fnStr},ch=[],cbfs=function(v2){var tl=[];for(var k2 in v2)if(v2[k2].buffer)tl.push((v2[k2]=new v2[k2].constructor(v2[k2])).buffer);return tl},wrkr=function(fns,init3,id,cb2){if(!ch[id]){for(var fnStr="",td_1={},m2=fns.length-1,i2=0;i2<m2;++i2)fnStr=wcln(fns[i2],fnStr,td_1);ch[id]={c:wcln(fns[m2],fnStr,td_1),e:td_1}}var td3=mrg({},ch[id].e);return wk(ch[id].c+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+init3.toString()+"}",id,td3,cbfs(td3),cb2)},bInflt=function(){return[u8,u16,i32,fleb,fdeb,clim,fl,fd,flrm,fdrm,rev,ec,hMap,max,bits,bits16,shft,slc,err,inflt,inflateSync,pbf,gopt]},bDflt=function(){return[u8,u16,i32,fleb,fdeb,clim,revfl,revfd,flm,flt,fdm,fdt,rev,deo,et,hMap,wbits,wbits16,hTree,ln,lc,clen,wfblk,wblk,shft,slc,dflt,dopt,deflateSync,pbf]},gze=function(){return[gzh,gzhl,wbytes,crc,crct]},guze=function(){return[gzs,gzl]},zle=function(){return[zlh,wbytes,adler]},zule=function(){return[zls]},pbf=function(msg){return postMessage(msg,[msg.buffer])},gopt=function(o2){return o2&&{out:o2.size&&new u8(o2.size),dictionary:o2.dictionary}},cbify=function(dat,opts,fns,init3,id,cb2){var w2=wrkr(fns,init3,id,(function(err2,dat2){w2.terminate();cb2(err2,dat2)}));w2.postMessage([dat,opts],opts.consume?[dat.buffer]:[]);return function(){w2.terminate()}},astrm=function(strm){strm.ondata=function(dat,final){return postMessage([dat,final],[dat.buffer])};return function(ev){if(ev.data.length){strm.push(ev.data[0],ev.data[1]);postMessage([ev.data[0].length])}else strm.flush()}},astrmify=function(fns,strm,opts,init3,id,flush2,ext2){var t4,w2=wrkr(fns,init3,id,(function(err2,dat){if(err2)w2.terminate(),strm.ondata.call(strm,err2);else if(!Array.isArray(dat))ext2(dat);else if(1==dat.length){strm.queuedSize-=dat[0];if(strm.ondrain)strm.ondrain(dat[0])}else{if(dat[1])w2.terminate();strm.ondata.call(strm,err2,dat[0],dat[1])}}));w2.postMessage(opts);strm.queuedSize=0;strm.push=function(d4,f4){if(!strm.ondata)err(5);if(t4)strm.ondata(err(4,0,1),null,!!f4);strm.queuedSize+=d4.length;w2.postMessage([d4,t4=f4],[d4.buffer])};strm.terminate=function(){w2.terminate()};if(flush2)strm.flush=function(){w2.postMessage([])}},b2=function(d4,b3){return d4[b3]|d4[b3+1]<<8},b4=function(d4,b3){return(d4[b3]|d4[b3+1]<<8|d4[b3+2]<<16|d4[b3+3]<<24)>>>0},b8=function(d4,b3){return b4(d4,b3)+4294967296*b4(d4,b3+4)},wbytes=function(d4,b3,v2){for(;v2;++b3)d4[b3]=v2,v2>>>=8},gzh=function(c2,o2){var fn=o2.filename;c2[0]=31,c2[1]=139,c2[2]=8,c2[8]=o2.level<2?4:9==o2.level?2:0,c2[9]=3;if(0!=o2.mtime)wbytes(c2,4,Math.floor(new Date(o2.mtime||Date.now())/1e3));if(fn){c2[3]=8;for(var i2=0;i2<=fn.length;++i2)c2[i2+10]=fn.charCodeAt(i2)}},gzs=function(d4){if(31!=d4[0]||139!=d4[1]||8!=d4[2])err(6,"invalid gzip data");var flg=d4[3],st=10;if(4&flg)st+=2+(d4[10]|d4[11]<<8);for(var zs=(flg>>3&1)+(flg>>4&1);zs>0;zs-=!d4[st++]);return st+(2&flg)},gzl=function(d4){var l2=d4.length;return(d4[l2-4]|d4[l2-3]<<8|d4[l2-2]<<16|d4[l2-1]<<24)>>>0},gzhl=function(o2){return 10+(o2.filename?o2.filename.length+1:0)},zlh=function(c2,o2){var lv=o2.level,fl2=0==lv?0:lv<6?1:9==lv?3:2;c2[0]=120,c2[1]=fl2<<6|(o2.dictionary&&32);c2[1]|=31-(c2[0]<<8|c2[1])%31;if(o2.dictionary){var h3=adler();h3.p(o2.dictionary);wbytes(c2,2,h3.d())}},zls=function(d4,dict){if(8!=(15&d4[0])||d4[0]>>4>7||(d4[0]<<8|d4[1])%31)err(6,"invalid zlib data");if((d4[1]>>5&1)==+!dict)err(6,"invalid zlib data: "+(32&d4[1]?"need":"unexpected")+" dictionary");return 2+(d4[1]>>3&4)};function StrmOpt(opts,cb2){if("function"==typeof opts)cb2=opts,opts={};this.ondata=cb2;return opts}var Deflate=function(){function Deflate2(opts,cb2){if("function"==typeof opts)cb2=opts,opts={};this.ondata=cb2;this.o=opts||{};this.s={l:0,i:32768,w:32768,z:32768};this.b=new u8(98304);if(this.o.dictionary){var dict=this.o.dictionary.subarray(-32768);this.b.set(dict,32768-dict.length);this.s.i=32768-dict.length}}Deflate2.prototype.p=function(c2,f4){this.ondata(dopt(c2,this.o,0,0,this.s),f4)};Deflate2.prototype.push=function(chunk,final){if(!this.ondata)err(5);if(this.s.l)err(4);var endLen=chunk.length+this.s.z;if(endLen>this.b.length){if(endLen>2*this.b.length-32768){var newBuf=new u8(-32768&endLen);newBuf.set(this.b.subarray(0,this.s.z));this.b=newBuf}var split=this.b.length-this.s.z;this.b.set(chunk.subarray(0,split),this.s.z);this.s.z=this.b.length;this.p(this.b,false);this.b.set(this.b.subarray(-32768));this.b.set(chunk.subarray(split),32768);this.s.z=chunk.length-split+32768;this.s.i=32766,this.s.w=32768}else{this.b.set(chunk,this.s.z);this.s.z+=chunk.length}this.s.l=1&final;if(this.s.z>this.s.w+8191||final){this.p(this.b,final||false);this.s.w=this.s.i,this.s.i-=2}};Deflate2.prototype.flush=function(){if(!this.ondata)err(5);if(this.s.l)err(4);this.p(this.b,false);this.s.w=this.s.i,this.s.i-=2};return Deflate2}(),AsyncDeflate=function(){return function AsyncDeflate2(opts,cb2){astrmify([bDflt,function(){return[astrm,Deflate]}],this,StrmOpt.call(this,opts,cb2),(function(ev){var strm=new Deflate(ev.data);onmessage=astrm(strm)}),6,1)}}();function deflate(data,opts,cb2){if(!cb2)cb2=opts,opts={};if("function"!=typeof cb2)err(7);return cbify(data,opts,[bDflt],(function(ev){return pbf(deflateSync(ev.data[0],ev.data[1]))}),0,cb2)}function deflateSync(data,opts){return dopt(data,opts||{},0,0)}var Inflate=function(){function Inflate2(opts,cb2){if("function"==typeof opts)cb2=opts,opts={};this.ondata=cb2;var dict=opts&&opts.dictionary&&opts.dictionary.subarray(-32768);this.s={i:0,b:dict?dict.length:0};this.o=new u8(32768);this.p=new u8(0);if(dict)this.o.set(dict)}Inflate2.prototype.e=function(c2){if(!this.ondata)err(5);if(this.d)err(4);if(!this.p.length)this.p=c2;else if(c2.length){var n3=new u8(this.p.length+c2.length);n3.set(this.p),n3.set(c2,this.p.length),this.p=n3}};Inflate2.prototype.c=function(final){this.s.i=+(this.d=final||false);var bts=this.s.b,dt=inflt(this.p,this.s,this.o);this.ondata(slc(dt,bts,this.s.b),this.d);this.o=slc(dt,this.s.b-32768),this.s.b=this.o.length;this.p=slc(this.p,this.s.p/8|0),this.s.p&=7};Inflate2.prototype.push=function(chunk,final){this.e(chunk),this.c(final)};return Inflate2}(),AsyncInflate=function(){return function AsyncInflate2(opts,cb2){astrmify([bInflt,function(){return[astrm,Inflate]}],this,StrmOpt.call(this,opts,cb2),(function(ev){var strm=new Inflate(ev.data);onmessage=astrm(strm)}),7,0)}}();function inflate(data,opts,cb2){if(!cb2)cb2=opts,opts={};if("function"!=typeof cb2)err(7);return cbify(data,opts,[bInflt],(function(ev){return pbf(inflateSync(ev.data[0],gopt(ev.data[1])))}),1,cb2)}function inflateSync(data,opts){return inflt(data,{i:2},opts&&opts.out,opts&&opts.dictionary)}var Gzip=function(){function Gzip2(opts,cb2){this.c=crc();this.l=0;this.v=1;Deflate.call(this,opts,cb2)}Gzip2.prototype.push=function(chunk,final){this.c.p(chunk);this.l+=chunk.length;Deflate.prototype.push.call(this,chunk,final)};Gzip2.prototype.p=function(c2,f4){var raw=dopt(c2,this.o,this.v&&gzhl(this.o),f4&&8,this.s);if(this.v)gzh(raw,this.o),this.v=0;if(f4)wbytes(raw,raw.length-8,this.c.d()),wbytes(raw,raw.length-4,this.l);this.ondata(raw,f4)};Gzip2.prototype.flush=function(){Deflate.prototype.flush.call(this)};return Gzip2}(),AsyncGzip=function(){return function AsyncGzip2(opts,cb2){astrmify([bDflt,gze,function(){return[astrm,Deflate,Gzip]}],this,StrmOpt.call(this,opts,cb2),(function(ev){var strm=new Gzip(ev.data);onmessage=astrm(strm)}),8,1)}}();function gzip(data,opts,cb2){if(!cb2)cb2=opts,opts={};if("function"!=typeof cb2)err(7);return cbify(data,opts,[bDflt,gze,function(){return[gzipSync]}],(function(ev){return pbf(gzipSync(ev.data[0],ev.data[1]))}),2,cb2)}function gzipSync(data,opts){if(!opts)opts={};var c2=crc(),l2=data.length;c2.p(data);var d4=dopt(data,opts,gzhl(opts),8),s2=d4.length;return gzh(d4,opts),wbytes(d4,s2-8,c2.d()),wbytes(d4,s2-4,l2),d4}var Gunzip=function(){function Gunzip2(opts,cb2){this.v=1;this.r=0;Inflate.call(this,opts,cb2)}Gunzip2.prototype.push=function(chunk,final){Inflate.prototype.e.call(this,chunk);this.r+=chunk.length;if(this.v){var p2=this.p.subarray(this.v-1),s2=p2.length>3?gzs(p2):4;if(s2>p2.length){if(!final)return}else if(this.v>1&&this.onmember)this.onmember(this.r-p2.length);this.p=p2.subarray(s2),this.v=0}Inflate.prototype.c.call(this,final);if(this.s.f&&!this.s.l&&!final){this.v=shft(this.s.p)+9;this.s={i:0};this.o=new u8(0);this.push(new u8(0),final)}};return Gunzip2}(),AsyncGunzip=function(){return function AsyncGunzip2(opts,cb2){var _this=this;astrmify([bInflt,guze,function(){return[astrm,Inflate,Gunzip]}],this,StrmOpt.call(this,opts,cb2),(function(ev){var strm=new Gunzip(ev.data);strm.onmember=function(offset){return postMessage(offset)};onmessage=astrm(strm)}),9,0,(function(offset){return _this.onmember&&_this.onmember(offset)}))}}();function gunzip(data,opts,cb2){if(!cb2)cb2=opts,opts={};if("function"!=typeof cb2)err(7);return cbify(data,opts,[bInflt,guze,function(){return[gunzipSync]}],(function(ev){return pbf(gunzipSync(ev.data[0],ev.data[1]))}),3,cb2)}function gunzipSync(data,opts){var st=gzs(data);if(st+8>data.length)err(6,"invalid gzip data");return inflt(data.subarray(st,-8),{i:2},opts&&opts.out||new u8(gzl(data)),opts&&opts.dictionary)}var Zlib=function(){function Zlib2(opts,cb2){this.c=adler();this.v=1;Deflate.call(this,opts,cb2)}Zlib2.prototype.push=function(chunk,final){this.c.p(chunk);Deflate.prototype.push.call(this,chunk,final)};Zlib2.prototype.p=function(c2,f4){var raw=dopt(c2,this.o,this.v&&(this.o.dictionary?6:2),f4&&4,this.s);if(this.v)zlh(raw,this.o),this.v=0;if(f4)wbytes(raw,raw.length-4,this.c.d());this.ondata(raw,f4)};Zlib2.prototype.flush=function(){Deflate.prototype.flush.call(this)};return Zlib2}(),AsyncZlib=function(){return function AsyncZlib2(opts,cb2){astrmify([bDflt,zle,function(){return[astrm,Deflate,Zlib]}],this,StrmOpt.call(this,opts,cb2),(function(ev){var strm=new Zlib(ev.data);onmessage=astrm(strm)}),10,1)}}();function zlib(data,opts,cb2){if(!cb2)cb2=opts,opts={};if("function"!=typeof cb2)err(7);return cbify(data,opts,[bDflt,zle,function(){return[zlibSync]}],(function(ev){return pbf(zlibSync(ev.data[0],ev.data[1]))}),4,cb2)}function zlibSync(data,opts){if(!opts)opts={};var a2=adler();a2.p(data);var d4=dopt(data,opts,opts.dictionary?6:2,4);return zlh(d4,opts),wbytes(d4,d4.length-4,a2.d()),d4}var Unzlib=function(){function Unzlib2(opts,cb2){Inflate.call(this,opts,cb2);this.v=opts&&opts.dictionary?2:1}Unzlib2.prototype.push=function(chunk,final){Inflate.prototype.e.call(this,chunk);if(this.v){if(this.p.length<6&&!final)return;this.p=this.p.subarray(zls(this.p,this.v-1)),this.v=0}if(final){if(this.p.length<4)err(6,"invalid zlib data");this.p=this.p.subarray(0,-4)}Inflate.prototype.c.call(this,final)};return Unzlib2}(),AsyncUnzlib=function(){return function AsyncUnzlib2(opts,cb2){astrmify([bInflt,zule,function(){return[astrm,Inflate,Unzlib]}],this,StrmOpt.call(this,opts,cb2),(function(ev){var strm=new Unzlib(ev.data);onmessage=astrm(strm)}),11,0)}}();function unzlib(data,opts,cb2){if(!cb2)cb2=opts,opts={};if("function"!=typeof cb2)err(7);return cbify(data,opts,[bInflt,zule,function(){return[unzlibSync]}],(function(ev){return pbf(unzlibSync(ev.data[0],gopt(ev.data[1])))}),5,cb2)}function unzlibSync(data,opts){return inflt(data.subarray(zls(data,opts&&opts.dictionary),-4),{i:2},opts&&opts.out,opts&&opts.dictionary)}var Decompress=function(){function Decompress2(opts,cb2){this.o=StrmOpt.call(this,opts,cb2)||{};this.G=Gunzip;this.I=Inflate;this.Z=Unzlib}Decompress2.prototype.i=function(){var _this=this;this.s.ondata=function(dat,final){_this.ondata(dat,final)}};Decompress2.prototype.push=function(chunk,final){if(!this.ondata)err(5);if(!this.s){if(this.p&&this.p.length){var n3=new u8(this.p.length+chunk.length);n3.set(this.p),n3.set(chunk,this.p.length)}else this.p=chunk;if(this.p.length>2){this.s=31==this.p[0]&&139==this.p[1]&&8==this.p[2]?new this.G(this.o):8!=(15&this.p[0])||this.p[0]>>4>7||(this.p[0]<<8|this.p[1])%31?new this.I(this.o):new this.Z(this.o);this.i();this.s.push(this.p,final);this.p=null}}else this.s.push(chunk,final)};return Decompress2}(),AsyncDecompress=function(){function AsyncDecompress2(opts,cb2){Decompress.call(this,opts,cb2);this.queuedSize=0;this.G=AsyncGunzip;this.I=AsyncInflate;this.Z=AsyncUnzlib}AsyncDecompress2.prototype.i=function(){var _this=this;this.s.ondata=function(err2,dat,final){_this.ondata(err2,dat,final)};this.s.ondrain=function(size){_this.queuedSize-=size;if(_this.ondrain)_this.ondrain(size)}};AsyncDecompress2.prototype.push=function(chunk,final){this.queuedSize+=chunk.length;Decompress.prototype.push.call(this,chunk,final)};return AsyncDecompress2}();function decompress(data,opts,cb2){if(!cb2)cb2=opts,opts={};if("function"!=typeof cb2)err(7);return 31==data[0]&&139==data[1]&&8==data[2]?gunzip(data,opts,cb2):8!=(15&data[0])||data[0]>>4>7||(data[0]<<8|data[1])%31?inflate(data,opts,cb2):unzlib(data,opts,cb2)}function decompressSync(data,opts){return 31==data[0]&&139==data[1]&&8==data[2]?gunzipSync(data,opts):8!=(15&data[0])||data[0]>>4>7||(data[0]<<8|data[1])%31?inflateSync(data,opts):unzlibSync(data,opts)}var fltn=function(d4,p2,t4,o2){for(var k2 in d4){var val2=d4[k2],n3=p2+k2,op=o2;if(Array.isArray(val2))op=mrg(o2,val2[1]),val2=val2[0];if(val2 instanceof u8)t4[n3]=[val2,op];else{t4[n3+="/"]=[new u8(0),op];fltn(val2,n3,t4,o2)}}},te2="undefined"!=typeof TextEncoder&&new TextEncoder,td2="undefined"!=typeof TextDecoder&&new TextDecoder,tds=0;try{td2.decode(et,{stream:true});tds=1}catch(e4){}var dutf8=function(d4){for(var r2="",i2=0;;){var c2=d4[i2++],eb=(c2>127)+(c2>223)+(c2>239);if(i2+eb>d4.length)return{s:r2,r:slc(d4,i2-1)};if(!eb)r2+=String.fromCharCode(c2);else if(3==eb)c2=((15&c2)<<18|(63&d4[i2++])<<12|(63&d4[i2++])<<6|63&d4[i2++])-65536,r2+=String.fromCharCode(55296|c2>>10,56320|1023&c2);else if(1&eb)r2+=String.fromCharCode((31&c2)<<6|63&d4[i2++]);else r2+=String.fromCharCode((15&c2)<<12|(63&d4[i2++])<<6|63&d4[i2++])}},DecodeUTF8=function(){function DecodeUTF82(cb2){this.ondata=cb2;if(tds)this.t=new TextDecoder;else this.p=et}DecodeUTF82.prototype.push=function(chunk,final){if(!this.ondata)err(5);final=!!final;if(!this.t){if(!this.p)err(4);var dat=new u8(this.p.length+chunk.length);dat.set(this.p);dat.set(chunk,this.p.length);var _a5=dutf8(dat),s2=_a5.s,r2=_a5.r;if(final){if(r2.length)err(8);this.p=null}else this.p=r2;this.ondata(s2,final)}else{this.ondata(this.t.decode(chunk,{stream:true}),final);if(final){if(this.t.decode().length)err(8);this.t=null}}};return DecodeUTF82}(),EncodeUTF8=function(){function EncodeUTF82(cb2){this.ondata=cb2}EncodeUTF82.prototype.push=function(chunk,final){if(!this.ondata)err(5);if(this.d)err(4);this.ondata(strToU8(chunk),this.d=final||false)};return EncodeUTF82}();function strToU8(str,latin1){if(latin1){for(var ar_1=new u8(str.length),i2=0;i2<str.length;++i2)ar_1[i2]=str.charCodeAt(i2);return ar_1}if(te2)return te2.encode(str);var l2=str.length,ar2=new u8(str.length+(str.length>>1)),ai2=0,w2=function(v2){ar2[ai2++]=v2};for(i2=0;i2<l2;++i2){if(ai2+5>ar2.length){var n3=new u8(ai2+8+(l2-i2<<1));n3.set(ar2);ar2=n3}var c2=str.charCodeAt(i2);if(c2<128||latin1)w2(c2);else if(c2<2048)w2(192|c2>>6),w2(128|63&c2);else if(c2>55295&&c2<57344)w2(240|(c2=65536+(1047552&c2)|1023&str.charCodeAt(++i2))>>18),w2(128|c2>>12&63),w2(128|c2>>6&63),w2(128|63&c2);else w2(224|c2>>12),w2(128|c2>>6&63),w2(128|63&c2)}return slc(ar2,0,ai2)}function strFromU8(dat,latin1){if(latin1){for(var r2="",i2=0;i2<dat.length;i2+=16384)r2+=String.fromCharCode.apply(null,dat.subarray(i2,i2+16384));return r2}else if(td2)return td2.decode(dat);else{var _a5=dutf8(dat),s2=_a5.s;if((r2=_a5.r).length)err(8);return s2}}var dbf=function(l2){return 1==l2?3:l2<6?2:9==l2?1:0},slzh=function(d4,b3){return b3+30+b2(d4,b3+26)+b2(d4,b3+28)},zh=function(d4,b3,z2){var fnl=b2(d4,b3+28),fn=strFromU8(d4.subarray(b3+46,b3+46+fnl),!(2048&b2(d4,b3+8))),es=b3+46+fnl,bs2=b4(d4,b3+20),_a5=z2&&4294967295==bs2?z64e(d4,es):[bs2,b4(d4,b3+24),b4(d4,b3+42)],sc=_a5[0],su=_a5[1],off=_a5[2];return[b2(d4,b3+10),sc,su,fn,es+b2(d4,b3+30)+b2(d4,b3+32),off]},z64e=function(d4,b3){for(;1!=b2(d4,b3);b3+=4+b2(d4,b3+2));return[b8(d4,b3+12),b8(d4,b3+4),b8(d4,b3+20)]},exfl=function(ex){var le=0;if(ex)for(var k2 in ex){var l2=ex[k2].length;if(l2>65535)err(9);le+=l2+4}return le},wzh=function(d4,b3,f4,fn,u2,c2,ce2,co2){var fl2=fn.length,ex=f4.extra,col=co2&&co2.length,exl=exfl(ex);wbytes(d4,b3,null!=ce2?33639248:67324752),b3+=4;if(null!=ce2)d4[b3++]=20,d4[b3++]=f4.os;d4[b3]=20,b3+=2;d4[b3++]=f4.flag<<1|(c2<0&&8),d4[b3++]=u2&&8;d4[b3++]=255&f4.compression,d4[b3++]=f4.compression>>8;var dt=new Date(null==f4.mtime?Date.now():f4.mtime),y2=dt.getFullYear()-1980;if(y2<0||y2>119)err(10);wbytes(d4,b3,y2<<25|dt.getMonth()+1<<21|dt.getDate()<<16|dt.getHours()<<11|dt.getMinutes()<<5|dt.getSeconds()>>1),b3+=4;if(-1!=c2){wbytes(d4,b3,f4.crc);wbytes(d4,b3+4,c2<0?-c2-2:c2);wbytes(d4,b3+8,f4.size)}wbytes(d4,b3+12,fl2);wbytes(d4,b3+14,exl),b3+=16;if(null!=ce2){wbytes(d4,b3,col);wbytes(d4,b3+6,f4.attrs);wbytes(d4,b3+10,ce2),b3+=14}d4.set(fn,b3);b3+=fl2;if(exl)for(var k2 in ex){var exf=ex[k2],l2=exf.length;wbytes(d4,b3,+k2);wbytes(d4,b3+2,l2);d4.set(exf,b3+4),b3+=4+l2}if(col)d4.set(co2,b3),b3+=col;return b3},wzf=function(o2,b3,c2,d4,e4){wbytes(o2,b3,101010256);wbytes(o2,b3+8,c2);wbytes(o2,b3+10,c2);wbytes(o2,b3+12,d4);wbytes(o2,b3+16,e4)},ZipPassThrough=function(){function ZipPassThrough2(filename){this.filename=filename;this.c=crc();this.size=0;this.compression=0}ZipPassThrough2.prototype.process=function(chunk,final){this.ondata(null,chunk,final)};ZipPassThrough2.prototype.push=function(chunk,final){if(!this.ondata)err(5);this.c.p(chunk);this.size+=chunk.length;if(final)this.crc=this.c.d();this.process(chunk,final||false)};return ZipPassThrough2}(),ZipDeflate=function(){function ZipDeflate2(filename,opts){var _this=this;if(!opts)opts={};ZipPassThrough.call(this,filename);this.d=new Deflate(opts,(function(dat,final){_this.ondata(null,dat,final)}));this.compression=8;this.flag=dbf(opts.level)}ZipDeflate2.prototype.process=function(chunk,final){try{this.d.push(chunk,final)}catch(e4){this.ondata(e4,null,final)}};ZipDeflate2.prototype.push=function(chunk,final){ZipPassThrough.prototype.push.call(this,chunk,final)};return ZipDeflate2}(),AsyncZipDeflate=function(){function AsyncZipDeflate2(filename,opts){var _this=this;if(!opts)opts={};ZipPassThrough.call(this,filename);this.d=new AsyncDeflate(opts,(function(err2,dat,final){_this.ondata(err2,dat,final)}));this.compression=8;this.flag=dbf(opts.level);this.terminate=this.d.terminate}AsyncZipDeflate2.prototype.process=function(chunk,final){this.d.push(chunk,final)};AsyncZipDeflate2.prototype.push=function(chunk,final){ZipPassThrough.prototype.push.call(this,chunk,final)};return AsyncZipDeflate2}(),Zip=function(){function Zip2(cb2){this.ondata=cb2;this.u=[];this.d=1}Zip2.prototype.add=function(file){var _this=this;if(!this.ondata)err(5);if(2&this.d)this.ondata(err(4+8*(1&this.d),0,1),null,false);else{var f4=strToU8(file.filename),fl_1=f4.length,com=file.comment,o2=com&&strToU8(com),u2=fl_1!=file.filename.length||o2&&com.length!=o2.length,hl_1=fl_1+exfl(file.extra)+30;if(fl_1>65535)this.ondata(err(11,0,1),null,false);var header=new u8(hl_1);wzh(header,0,file,f4,u2,-1);var chks_1=[header],pAll_1=function(){for(var _i2=0,chks_2=chks_1;_i2<chks_2.length;_i2++){var chk=chks_2[_i2];_this.ondata(null,chk,false)}chks_1=[]},tr_1=this.d;this.d=0;var ind_1=this.u.length,uf_1=mrg(file,{f:f4,u:u2,o:o2,t:function(){if(file.terminate)file.terminate()},r:function(){pAll_1();if(tr_1){var nxt=_this.u[ind_1+1];if(nxt)nxt.r();else _this.d=1}tr_1=1}}),cl_1=0;file.ondata=function(err2,dat,final){if(err2){_this.ondata(err2,dat,final);_this.terminate()}else{cl_1+=dat.length;chks_1.push(dat);if(final){var dd=new u8(16);wbytes(dd,0,134695760);wbytes(dd,4,file.crc);wbytes(dd,8,cl_1);wbytes(dd,12,file.size);chks_1.push(dd);uf_1.c=cl_1,uf_1.b=hl_1+cl_1+16,uf_1.crc=file.crc,uf_1.size=file.size;if(tr_1)uf_1.r();tr_1=1}else if(tr_1)pAll_1()}};this.u.push(uf_1)}};Zip2.prototype.end=function(){var _this=this;if(!(2&this.d)){if(this.d)this.e();else this.u.push({r:function(){if(1&_this.d){_this.u.splice(-1,1);_this.e()}},t:function(){}});this.d=3}else this.ondata(err(4+8*(1&this.d),0,1),null,true)};Zip2.prototype.e=function(){for(var bt2=0,l2=0,tl=0,_i2=0,_a5=this.u;_i2<_a5.length;_i2++)tl+=46+(f4=_a5[_i2]).f.length+exfl(f4.extra)+(f4.o?f4.o.length:0);for(var out=new u8(tl+22),_b2=0,_c2=this.u;_b2<_c2.length;_b2++){var f4=_c2[_b2];wzh(out,bt2,f4,f4.f,f4.u,-f4.c-2,l2,f4.o);bt2+=46+f4.f.length+exfl(f4.extra)+(f4.o?f4.o.length:0),l2+=f4.b}wzf(out,bt2,this.u.length,tl,l2);this.ondata(null,out,true);this.d=2};Zip2.prototype.terminate=function(){for(var _i2=0,_a5=this.u;_i2<_a5.length;_i2++)_a5[_i2].t();this.d=2};return Zip2}();function zip(data,opts,cb2){if(!cb2)cb2=opts,opts={};if("function"!=typeof cb2)err(7);var r2={};fltn(data,"",r2,opts);var k2=Object.keys(r2),lft=k2.length,o2=0,tot=0,slft=lft,files=new Array(lft),term=[],tAll=function(){for(var i3=0;i3<term.length;++i3)term[i3]()},cbd=function(a2,b3){mt((function(){cb2(a2,b3)}))};mt((function(){cbd=cb2}));var cbf=function(){var out=new u8(tot+22),oe=o2,cdl=tot-o2;tot=0;for(var i3=0;i3<slft;++i3){var f4=files[i3];try{var l2=f4.c.length;wzh(out,tot,f4,f4.f,f4.u,l2);var badd=30+f4.f.length+exfl(f4.extra),loc=tot+badd;out.set(f4.c,loc);wzh(out,o2,f4,f4.f,f4.u,l2,tot,f4.m),o2+=16+badd+(f4.m?f4.m.length:0),tot=loc+l2}catch(e4){return cbd(e4,null)}}wzf(out,o2,files.length,cdl,oe);cbd(null,out)};if(!lft)cbf();for(var _loop_1=function(i3){var fn=k2[i3],_a5=r2[fn],file=_a5[0],p2=_a5[1],c2=crc(),size=file.length;c2.p(file);var f4=strToU8(fn),s2=f4.length,com=p2.comment,m2=com&&strToU8(com),ms=m2&&m2.length,exl=exfl(p2.extra),compression=0==p2.level?0:8,cbl=function(e4,d4){if(e4){tAll();cbd(e4,null)}else{var l2=d4.length;files[i3]=mrg(p2,{size,crc:c2.d(),c:d4,f:f4,m:m2,u:s2!=fn.length||m2&&com.length!=ms,compression});o2+=30+s2+exl+l2;tot+=76+2*(s2+exl)+(ms||0)+l2;if(! --lft)cbf()}};if(s2>65535)cbl(err(11,0,1),null);if(!compression)cbl(null,file);else if(size<16e4)try{cbl(null,deflateSync(file,p2))}catch(e4){cbl(e4,null)}else term.push(deflate(file,p2,cbl))},i2=0;i2<slft;++i2)_loop_1(i2);return tAll}function zipSync(data,opts){if(!opts)opts={};var r2={},files=[];fltn(data,"",r2,opts);var o2=0,tot=0;for(var fn in r2){var _a5=r2[fn],file=_a5[0],p2=_a5[1],compression=0==p2.level?0:8,s2=(f4=strToU8(fn)).length,com=p2.comment,m2=com&&strToU8(com),ms=m2&&m2.length,exl=exfl(p2.extra);if(s2>65535)err(11);var d4=compression?deflateSync(file,p2):file,l2=d4.length,c2=crc();c2.p(file);files.push(mrg(p2,{size:file.length,crc:c2.d(),c:d4,f:f4,m:m2,u:s2!=fn.length||m2&&com.length!=ms,o:o2,compression}));o2+=30+s2+exl+l2;tot+=76+2*(s2+exl)+(ms||0)+l2}for(var out=new u8(tot+22),oe=o2,cdl=tot-o2,i2=0;i2<files.length;++i2){var f4=files[i2];wzh(out,f4.o,f4,f4.f,f4.u,f4.c.length);var badd=30+f4.f.length+exfl(f4.extra);out.set(f4.c,f4.o+badd);wzh(out,o2,f4,f4.f,f4.u,f4.c.length,f4.o,f4.m),o2+=16+badd+(f4.m?f4.m.length:0)}wzf(out,o2,files.length,cdl,oe);return out}var x2,UnzipPassThrough=function(){function UnzipPassThrough2(){}UnzipPassThrough2.prototype.push=function(data,final){this.ondata(null,data,final)};UnzipPassThrough2.compression=0;return UnzipPassThrough2}(),UnzipInflate=function(){function UnzipInflate2(){var _this=this;this.i=new Inflate((function(dat,final){_this.ondata(null,dat,final)}))}UnzipInflate2.prototype.push=function(data,final){try{this.i.push(data,final)}catch(e4){this.ondata(e4,null,final)}};UnzipInflate2.compression=8;return UnzipInflate2}(),AsyncUnzipInflate=function(){function AsyncUnzipInflate2(_,sz){var _this=this;if(sz<32e4)this.i=new Inflate((function(dat,final){_this.ondata(null,dat,final)}));else{this.i=new AsyncInflate((function(err2,dat,final){_this.ondata(err2,dat,final)}));this.terminate=this.i.terminate}}AsyncUnzipInflate2.prototype.push=function(data,final){if(this.i.terminate)data=slc(data,0);this.i.push(data,final)};AsyncUnzipInflate2.compression=8;return AsyncUnzipInflate2}(),Unzip=function(){function Unzip2(cb2){this.onfile=cb2;this.k=[];this.o={0:UnzipPassThrough};this.p=et}Unzip2.prototype.push=function(chunk,final){var _this=this;if(!this.onfile)err(5);if(!this.p)err(4);if(this.c>0){var len=Math.min(this.c,chunk.length),toAdd=chunk.subarray(0,len);this.c-=len;if(this.d)this.d.push(toAdd,!this.c);else this.k[0].push(toAdd);if((chunk=chunk.subarray(len)).length)return this.push(chunk,final)}else{var f4=0,i2=0,is=void 0,buf=void 0;if(!this.p.length)buf=chunk;else if(!chunk.length)buf=this.p;else(buf=new u8(this.p.length+chunk.length)).set(this.p),buf.set(chunk,this.p.length);for(var l2=buf.length,oc=this.c,add=oc&&this.d,_loop_2=function(){var _a5,sig=b4(buf,i2);if(67324752==sig){f4=1,is=i2;this_1.d=null;this_1.c=0;var bf2=b2(buf,i2+6),cmp_1=b2(buf,i2+8),u2=2048&bf2,dd=8&bf2,fnl=b2(buf,i2+26),es=b2(buf,i2+28);if(l2>i2+30+fnl+es){var chks_3=[];this_1.k.unshift(chks_3);f4=2;var d_1,sc_1=b4(buf,i2+18),su_1=b4(buf,i2+22),fn_1=strFromU8(buf.subarray(i2+30,i2+=30+fnl),!u2);if(4294967295==sc_1)_a5=dd?[-2]:z64e(buf,i2),sc_1=_a5[0],su_1=_a5[1];else if(dd)sc_1=-1;i2+=es;this_1.c=sc_1;var file_1={name:fn_1,compression:cmp_1,start:function(){if(!file_1.ondata)err(5);if(!sc_1)file_1.ondata(null,et,true);else{var ctr=_this.o[cmp_1];if(!ctr)file_1.ondata(err(14,"unknown compression type "+cmp_1,1),null,false);(d_1=sc_1<0?new ctr(fn_1):new ctr(fn_1,sc_1,su_1)).ondata=function(err2,dat3,final2){file_1.ondata(err2,dat3,final2)};for(var _i2=0,chks_4=chks_3;_i2<chks_4.length;_i2++){var dat2=chks_4[_i2];d_1.push(dat2,false)}if(_this.k[0]==chks_3&&_this.c)_this.d=d_1;else d_1.push(et,true)}},terminate:function(){if(d_1&&d_1.terminate)d_1.terminate()}};if(sc_1>=0)file_1.size=sc_1,file_1.originalSize=su_1;this_1.onfile(file_1)}return"break"}else if(oc)if(134695760==sig){is=i2+=12+(-2==oc&&8),f4=3,this_1.c=0;return"break"}else if(33639248==sig){is=i2-=4,f4=3,this_1.c=0;return"break"}},this_1=this;i2<l2-4&&"break"!==_loop_2();++i2);this.p=et;if(oc<0){var dat=f4?buf.subarray(0,is-12-(-2==oc&&8)-(134695760==b4(buf,is-16)&&4)):buf.subarray(0,i2);if(add)add.push(dat,!!f4);else this.k[+(2==f4)].push(dat)}if(2&f4)return this.push(buf.subarray(i2),final);this.p=buf.subarray(i2)}if(final){if(this.c)err(13);this.p=null}};Unzip2.prototype.register=function(decoder){this.o[decoder.compression]=decoder};return Unzip2}(),mt="function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout?setTimeout:function(fn){fn()};function unzip(data,opts,cb2){if(!cb2)cb2=opts,opts={};if("function"!=typeof cb2)err(7);var term=[],tAll=function(){for(var i3=0;i3<term.length;++i3)term[i3]()},files={},cbd=function(a2,b3){mt((function(){cb2(a2,b3)}))};mt((function(){cbd=cb2}));for(var e4=data.length-22;101010256!=b4(data,e4);--e4)if(!e4||data.length-e4>65558){cbd(err(13,0,1),null);return tAll}var lft=b2(data,e4+8);if(lft){var c2=lft,o2=b4(data,e4+16),z2=4294967295==o2||65535==c2;if(z2){var ze=b4(data,e4-12);if(z2=101075792==b4(data,ze)){c2=lft=b4(data,ze+32);o2=b4(data,ze+48)}}for(var fltr=opts&&opts.filter,_loop_3=function(i3){var _a5=zh(data,o2,z2),c_1=_a5[0],sc=_a5[1],su=_a5[2],fn=_a5[3],no=_a5[4],off=_a5[5],b3=slzh(data,off);o2=no;var cbl=function(e5,d4){if(e5){tAll();cbd(e5,null)}else{if(d4)files[fn]=d4;if(! --lft)cbd(null,files)}};if(!fltr||fltr({name:fn,size:sc,originalSize:su,compression:c_1}))if(!c_1)cbl(null,slc(data,b3,b3+sc));else if(8==c_1){var infl=data.subarray(b3,b3+sc);if(su<524288||sc>.8*su)try{cbl(null,inflateSync(infl,{out:new u8(su)}))}catch(e5){cbl(e5,null)}else term.push(inflate(infl,{size:su},cbl))}else cbl(err(14,"unknown compression type "+c_1,1),null);else cbl(null,null)},i2=0;i2<c2;++i2)_loop_3()}else cbd(null,{});return tAll}function unzipSync(data,opts){for(var files={},e4=data.length-22;101010256!=b4(data,e4);--e4)if(!e4||data.length-e4>65558)err(13);var c2=b2(data,e4+8);if(!c2)return{};var o2=b4(data,e4+16),z2=4294967295==o2||65535==c2;if(z2){var ze=b4(data,e4-12);if(z2=101075792==b4(data,ze)){c2=b4(data,ze+32);o2=b4(data,ze+48)}}for(var fltr=opts&&opts.filter,i2=0;i2<c2;++i2){var _a5=zh(data,o2,z2),c_2=_a5[0],sc=_a5[1],su=_a5[2],fn=_a5[3],no=_a5[4],off=_a5[5],b3=slzh(data,off);o2=no;if(!fltr||fltr({name:fn,size:sc,originalSize:su,compression:c_2}))if(!c_2)files[fn]=slc(data,b3,b3+sc);else if(8==c_2)files[fn]=inflateSync(data.subarray(b3,b3+sc),{out:new u8(su)});else err(14,"unknown compression type "+c_2)}return files}var encrypt2=encryptWorker,decrypt2=decryptWorker,isValidRemoteCouchDBURI=uri=>{if(uri.startsWith("https://"))return true;if(uri.startsWith("http://"))return true;else return false};function isCloudantURI(uri){if(-1!==uri.indexOf(".cloudantnosqldb.")||-1!==uri.indexOf(".cloudant.com"))return true;else return false}var checkRemoteVersion=async(db,migrate,barrier=VER)=>{try{const versionInfo=await db.get(VERSIONING_DOCID);if("versioninfo"!=versionInfo.type)return false;const version2=versionInfo.version;if(version2<barrier)if(await migrate(version2,barrier)){await bumpRemoteVersion(db);return true}if(version2==barrier)return true;else return false}catch(ex){if(isErrorOfMissingDoc(ex))if(await bumpRemoteVersion(db))return true;else return false;throw ex}},bumpRemoteVersion=async(db,barrier=VER)=>{const vi={_id:VERSIONING_DOCID,version:barrier,type:"versioninfo"},versionInfo=await resolveWithIgnoreKnownError(db.get(VERSIONING_DOCID),vi);if("versioninfo"!=versionInfo.type)return false;vi._rev=versionInfo._rev;await db.put(vi);return true},checkSyncInfo=async db=>{try{const syncinfo=await db.get(SYNCINFO_ID);console.log(syncinfo);return true}catch(ex){if(isErrorOfMissingDoc(ex)){const randomStrSrc="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",temp=[...Array(30)].map((e4=>Math.floor(Math.random()*randomStrSrc.length))).map((e4=>randomStrSrc[e4])).join(""),newSyncInfo={_id:SYNCINFO_ID,type:"syncinfo",data:temp};if(await db.put(newSyncInfo))return true;else return false}else{console.dir(ex);return false}}},MARK_SHIFT="L",MARK_SHIFT_COMPRESSED=`${MARK_SHIFT}Z`;function wrapFflateFunc(func){return(data,opts)=>new Promise(((res2,rej)=>{func(data,opts,((err2,result)=>{if(err2)rej(err2);else res2(result)}))}))}var wrappedInflate=wrapFflateFunc(inflate),wrappedDeflate=wrapFflateFunc(deflate);async function _compressText(text2){const converted=tryConvertBase64ToArrayBuffer(text2),data=new Uint8Array(converted||await new Blob([text2],{type:"application/octet-stream"}).arrayBuffer());if(0==data.buffer.byteLength)return"";const df=await wrappedDeflate(new Uint8Array(data),{consume:true,level:8});return(converted?"~":"")+await arrayBufferToBase64Single(df)}async function _decompressText(compressed,useUTF16=false){if(0==compressed.length)return"";const converted="~"==compressed[0],src=compressed.substring(converted?1:0);if(0==src.length)return"";const ab2=new Uint8Array(base64ToArrayBuffer(src));if(0==ab2.length)return"";const ret=await wrappedInflate(new Uint8Array(ab2),{consume:true});if(converted)return await arrayBufferToBase64Single(ret);const response=new Blob([ret]);return await response.text()}async function compressDoc(doc){if(!("data"in doc))return doc;if("string"!=typeof doc.data)return doc;if(doc.data.startsWith(MARK_SHIFT_COMPRESSED))return doc;const oldData=doc.data,compressed=await _compressText(oldData),newData=MARK_SHIFT_COMPRESSED+compressed;if(doc.data.length>newData.length)doc.data=newData;return doc}async function decompressDoc(doc){if(!("data"in doc))return doc;if("string"!=typeof doc.data)return doc;if(doc.data.startsWith(MARK_SHIFT_COMPRESSED))doc.data=await _decompressText(doc.data.substring(MARK_SHIFT_COMPRESSED.length));return doc}var replicationFilter=(db,compress)=>{db.transform({async incoming(doc){if(!compress)return doc;else return await compressDoc(doc)},outgoing:async doc=>await decompressDoc(doc)})},EDEN_ENCRYPTED_KEY="h:++encrypted";function shouldEncryptEden(doc){if("eden"in doc&&!(EDEN_ENCRYPTED_KEY in doc.eden))return true;else return false}function shouldDecryptEden(doc){if("eden"in doc&&EDEN_ENCRYPTED_KEY in doc.eden)return true;else return false}var preprocessOutgoing=async doc=>Promise.resolve(doc);function disableEncryption(){preprocessOutgoing=async doc=>doc;preprocessIncoming=async doc=>doc}var preprocessIncoming=async doc=>doc,enableEncryption=(db,passphrase,useDynamicIterationCount,migrationDecrypt)=>{const decrypted=new Map,incoming=async doc=>{const saveDoc={...doc};if(isEncryptedChunkEntry(saveDoc)||isSyncInfoEntry(saveDoc))try{if(!("e_"in saveDoc)){saveDoc.data=await encrypt2(saveDoc.data,passphrase,useDynamicIterationCount);saveDoc.e_=true}}catch(ex){Logger("Encryption failed.",LOG_LEVEL_NOTICE);Logger(ex);throw ex}if(shouldEncryptEden(saveDoc))saveDoc.eden={[EDEN_ENCRYPTED_KEY]:{data:await encrypt2(JSON.stringify(saveDoc.eden),passphrase,useDynamicIterationCount),epoch:999999}};if(isObfuscatedEntry(saveDoc))try{const path2=getPath(saveDoc);if(!isPathProbablyObfuscated(path2))saveDoc.path=await obfuscatePath(path2,passphrase,useDynamicIterationCount)}catch(ex){Logger("Encryption failed.",LOG_LEVEL_NOTICE);Logger(ex);throw ex}return saveDoc},outgoing=async doc=>{var _a5,_b2;const loadDoc={...doc},_isChunkOrSyncInfo=isEncryptedChunkEntry(loadDoc)||isSyncInfoEntry(loadDoc),_isObfuscatedEntry=isObfuscatedEntry(loadDoc),_shouldDecryptEden=shouldDecryptEden(loadDoc);if(_isChunkOrSyncInfo||_isObfuscatedEntry||_shouldDecryptEden){if(migrationDecrypt&&decrypted.has(loadDoc._id))return loadDoc;try{if(_isChunkOrSyncInfo){loadDoc.data=await decrypt2(loadDoc.data,passphrase,useDynamicIterationCount);delete loadDoc.e_}else if("e_"in loadDoc){loadDoc.data=await decrypt2(loadDoc.data,passphrase,useDynamicIterationCount);delete loadDoc.e_}if(_isObfuscatedEntry){const path2=getPath(loadDoc);if(isPathProbablyObfuscated(path2))loadDoc.path=await decrypt2(path2,passphrase,useDynamicIterationCount)}if(_shouldDecryptEden)loadDoc.eden=JSON.parse(await decrypt2(loadDoc.eden[EDEN_ENCRYPTED_KEY].data,passphrase,useDynamicIterationCount));if(migrationDecrypt)decrypted.set(loadDoc._id,true)}catch(ex){if(useDynamicIterationCount)try{if(_isChunkOrSyncInfo)loadDoc.data=await decrypt2(loadDoc.data,passphrase,false);if(_isObfuscatedEntry){const path2=getPath(loadDoc);if(isPathProbablyObfuscated(path2))loadDoc.path=await decrypt2(path2,passphrase,false)}if(_shouldDecryptEden)loadDoc.eden=JSON.parse(await decrypt2(loadDoc.eden[EDEN_ENCRYPTED_KEY].data,passphrase,false));if(migrationDecrypt)decrypted.set(loadDoc._id,true)}catch(ex2){if(migrationDecrypt&&"SyntaxError"==ex2.name)return loadDoc;Logger("Decryption failed.",LOG_LEVEL_NOTICE);Logger(ex2,LOG_LEVEL_VERBOSE);Logger(`id:${loadDoc._id}-${null==(_a5=loadDoc._rev)?void 0:_a5.substring(0,10)}`,LOG_LEVEL_VERBOSE);throw ex2}else{Logger("Decryption failed.",LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE);Logger(`id:${loadDoc._id}-${null==(_b2=loadDoc._rev)?void 0:_b2.substring(0,10)}`,LOG_LEVEL_VERBOSE);throw ex}}}return loadDoc};preprocessOutgoing=incoming;preprocessIncoming=outgoing;db.transform({incoming,outgoing})};function isErrorOfMissingDoc(ex){return 404==(ex&&(null==ex?void 0:ex.status))}async function prepareChunkDesignDoc(db){var _a5;const chunkDesignDoc={_id:"_design/chunks",_rev:void 0,ver:2,views:{collectDangling:{map:(function(doc){if(doc._id.startsWith("h:"))emit([doc._id],0);else if("children"in doc)doc.children.forEach((e4=>emit([e4],1)))}).toString(),reduce:"_sum"}}};let updateDDoc=false;try{const old=await db.get(chunkDesignDoc._id);if(null!=(_a5=null==old?void 0:old.ver)?_a5:0<chunkDesignDoc.ver){chunkDesignDoc._rev=old._rev;updateDDoc=true}}catch(ex){if(404==ex.status)updateDDoc=true;else{Logger("Failed to make design document for operating chunks");Logger(ex,LOG_LEVEL_VERBOSE);return false}}try{if(updateDDoc)await db.put(chunkDesignDoc)}catch(ex){Logger("Failed to make design document for operating chunks");Logger(ex,LOG_LEVEL_VERBOSE);return false}return true}async function collectChunksUsage(db){if(!await prepareChunkDesignDoc(db)){Logger("Could not prepare design document for operating chunks");return[]}return(await db.query("chunks/collectDangling",{reduce:true,group:true})).rows}function collectUnreferencedChunks(db){return collectChunks(db,"DANGLING")}async function collectChunks(db,type){const rows=await collectChunksUsage(db),ids=("ALL"==type?rows:rows.filter((e4=>"DANGLING"==type?0==e4.value:0!=e4.value))).flatMap((e4=>e4.key));return(await db.allDocs({keys:ids})).rows.filter((e4=>!("error"in e4))).map((e4=>({id:e4.id,rev:e4.value.rev})))}async function collectUnbalancedChunkIDs(local,remote){const chunksOnLocal=await collectChunks(local,"INUSE"),chunksOnRemote=await collectChunks(remote,"INUSE");return{onlyOnLocal:chunksOnLocal.filter((e4=>!chunksOnRemote.some((ee=>ee.id==e4.id)))),onlyOnRemote:chunksOnRemote.filter((e4=>!chunksOnLocal.some((ee=>ee.id==e4.id))))}}async function purgeChunksLocal(db,docs){await serialized("purge-local",(async()=>{try{Logger(`Purging unused ${docs.length} chunks `,LOG_LEVEL_NOTICE,"purge-local-backup");const batchDocsBackup=arrayToChunkedArray(docs,100);let total={ok:0,exist:0,error:0};for(const docsInBatch of batchDocsBackup){const backupDocs=(await db.allDocs({keys:docsInBatch.map((e4=>e4.id)),include_docs:true})).rows.filter((e4=>"doc"in e4)).map((e4=>{const chunk={...e4.doc};delete chunk._rev;chunk._id=`_local/${chunk._id}`;return chunk})),ret=await db.bulkDocs(backupDocs);total=ret.map((e4=>({ok:"ok"in e4?1:0,exist:"status"in e4&&409==e4.status?1:0,error:"status"in e4&&409!=e4.status?1:0}))).reduce(((p2,c2)=>({ok:p2.ok+c2.ok,exist:p2.exist+c2.exist,error:p2.error+c2.error})),total);Logger(`Local chunk backed up: new:${total.ok} ,exist:${total.exist}, error:${total.error}`,LOG_LEVEL_NOTICE,"purge-local-backup");const erroredItems=ret.filter((e4=>"error"in e4&&409!=e4.status));for(const item of erroredItems)Logger(`Failed to back up: ${item.id} / ${item.rev}`,LOG_LEVEL_VERBOSE)}}catch(ex){Logger("Could not back up chunks");Logger(ex,LOG_LEVEL_VERBOSE)}Logger(`Purging unused ${docs.length} chunks... `,LOG_LEVEL_NOTICE,"purge-local");const batchDocs=arrayToChunkedArray(docs,100);let totalRemoved=0;for(const docsInBatch of batchDocs){const removed=await db.purgeMulti(docsInBatch.map((e4=>[e4.id,e4.rev])));totalRemoved+=Object.values(removed).filter((e4=>"ok"in e4)).length;Logger(`Purging:  ${totalRemoved} / ${docs.length}`,LOG_LEVEL_NOTICE,"purge-local")}Logger(`Purging unused chunks done!: ${totalRemoved} chunks has been deleted.`,LOG_LEVEL_NOTICE,"purge-local")}))}var _requestToCouchDBFetch=async(baseUri,username,password,path2,body,method)=>{const utf8str=String.fromCharCode.apply(null,[...writeString(`${username}:${password}`)]),encoded=window.btoa(utf8str),uri=`${baseUri}/${path2}`,requestParam={url:uri,method:method||(body?"PUT":"GET"),headers:new Headers({authorization:"Basic "+encoded,"content-type":"application/json"}),contentType:"application/json",body:JSON.stringify(body)};return await fetch(uri,requestParam)};async function purgeChunksRemote(setting,docs){await serialized("purge-remote",(async()=>{const buffer=function makeChunkedArrayFromArray(items){const chunked=[];for(let i2=0;i2<items.length;i2+=100)chunked.push(items.slice(i2,i2+100));return chunked}(docs);for(const chunkedPayload of buffer){const rets=await _requestToCouchDBFetch(`${setting.couchDB_URI}/${setting.couchDB_DBNAME}`,setting.couchDB_USER,setting.couchDB_PASSWORD,"_purge",Object.fromEntries(chunkedPayload.map((e4=>[e4.id,[e4.rev]]))),"POST");Logger(JSON.stringify(await rets.json()),LOG_LEVEL_VERBOSE)}}))}function sizeToHumanReadable(size){if(!size)return"-";const i2=Math.floor(Math.log(size)/Math.log(1024));return Number.parseInt((size/Math.pow(1024,i2)).toFixed(2))+" "+["B","kB","MB","GB","TB"][i2]}async function purgeUnreferencedChunks(db,dryRun,connSetting,performCompact=false){const info3=await db.info();let resultCount=0;const getSize=function(info4,key2){var _a5,_b2;return Number.parseInt(null!=(_b2=null==(_a5=null==info4?void 0:info4.sizes)?void 0:_a5[key2])?_b2:0)},keySuffix=connSetting?"-remote":"-local";Logger(`${dryRun?"Counting":"Cleaning"} ${connSetting?"remote":"local"} database`,LOG_LEVEL_NOTICE);if(connSetting)Logger(`Database active-size: ${sizeToHumanReadable(getSize(info3,"active"))}, external-size:${sizeToHumanReadable(getSize(info3,"external"))}, file-size: ${sizeToHumanReadable(getSize(info3,"file"))}`,LOG_LEVEL_NOTICE);Logger(`Collecting unreferenced chunks on ${info3.db_name}`,LOG_LEVEL_NOTICE,"gc-count-chunk"+keySuffix);const chunks=await collectUnreferencedChunks(db);resultCount=chunks.length;if(0==chunks.length)Logger(`No unreferenced chunks! ${info3.db_name}`,LOG_LEVEL_NOTICE,"gc-count-chunk"+keySuffix);else{Logger(`Number of unreferenced chunks on ${info3.db_name}: ${chunks.length}`,LOG_LEVEL_NOTICE,"gc-count-chunk"+keySuffix);if(dryRun){Logger(`DryRun of cleaning ${connSetting?"remote":"local"} database up: Done`,LOG_LEVEL_NOTICE);return resultCount}if(connSetting){Logger("Cleaning unreferenced chunks on remote",LOG_LEVEL_NOTICE,"gc-purge"+keySuffix);await purgeChunksRemote(connSetting,chunks)}else{Logger("Cleaning unreferenced chunks on local",LOG_LEVEL_NOTICE,"gc-purge"+keySuffix);await purgeChunksLocal(db,chunks)}Logger("Cleaning unreferenced chunks done!",LOG_LEVEL_NOTICE,"gc-purge"+keySuffix)}if(performCompact){Logger("Compacting database...",LOG_LEVEL_NOTICE,"gc-compact"+keySuffix);await db.compact();Logger("Compacting database done",LOG_LEVEL_NOTICE,"gc-compact"+keySuffix)}if(connSetting){const endInfo=await db.info();Logger(`Processed database active-size: ${sizeToHumanReadable(getSize(endInfo,"active"))}, external-size:${sizeToHumanReadable(getSize(endInfo,"external"))}, file-size: ${sizeToHumanReadable(getSize(endInfo,"file"))}`,LOG_LEVEL_NOTICE);Logger(`Reduced sizes: active-size: ${sizeToHumanReadable(getSize(info3,"active")-getSize(endInfo,"active"))}, external-size:${sizeToHumanReadable(getSize(info3,"external")-getSize(endInfo,"external"))}, file-size: ${sizeToHumanReadable(getSize(info3,"file")-getSize(endInfo,"file"))}`,LOG_LEVEL_NOTICE)}Logger(`Cleaning ${connSetting?"remote":"local"} database up: Done`,LOG_LEVEL_NOTICE);return resultCount}function transferChunks(key2,label,dbFrom,dbTo,items){let totalProcessed=0;const total=items.length;return new QueueProcessor((async batched=>{const requestItems=batched.map((e4=>e4.id));return(await dbTo.allDocs({keys:requestItems})).rows.filter((e4=>"error"in e4&&"not_found"==e4.error)).map((e4=>e4.key))}),{batchSize:50,concurrentLimit:5,suspended:true,delay:100},items).pipeTo(new QueueProcessor((async chunkIds=>(await dbFrom.allDocs({keys:chunkIds,include_docs:true})).rows.filter((e4=>!("error"in e4))).map((e4=>e4.doc))),{batchSize:25,concurrentLimit:1,suspended:true,delay:100})).pipeTo(new QueueProcessor((async docs=>{try{await dbTo.bulkDocs(docs,{new_edits:false})}catch(ex){Logger(`${label}: Something went wrong on balancing`,LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE)}finally{totalProcessed+=docs.length;Logger(`${label}: ${totalProcessed} / ${total}`,LOG_LEVEL_NOTICE,"balance-"+key2)}}),{batchSize:100,delay:100,concurrentLimit:2,suspended:false})).startPipeline().waitForAllDoneAndTerminate()}async function balanceChunkPurgedDBs(local,remote){Logger("Complement missing chunks between databases",LOG_LEVEL_NOTICE);try{const{onlyOnLocal,onlyOnRemote}=await collectUnbalancedChunkIDs(local,remote),localToRemote=transferChunks("l2r","local -> remote",local,remote,onlyOnLocal),remoteToLocal=transferChunks("r2l","remote -> local",remote,local,onlyOnRemote);await Promise.all([localToRemote,remoteToLocal]);Logger("local -> remote: Done",LOG_LEVEL_NOTICE,"balance-l2r");Logger("remote -> local: Done",LOG_LEVEL_NOTICE,"balance-r2l")}catch(ex){Logger("Something went wrong on balancing!",LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE)}Logger("Complement completed!",LOG_LEVEL_NOTICE)}async function fetchAllUsedChunks(local,remote){try{const chunksOnRemote=await collectChunks(remote,"INUSE");await transferChunks("r2l","remote -> local",remote,local,chunksOnRemote);Logger("remote -> local: Done",LOG_LEVEL_NOTICE,"balance-r2l")}catch(ex){Logger("Something went wrong on balancing!",LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE)}}function extractObject(template,obj){const ret={...template};for(const key2 in ret)ret[key2]=obj[key2];return ret}function isObjectDifferent(a2,b3,ignoreUndefined=false){if(typeof a2!=typeof b3)return true;if("object"==typeof a2){if(null===a2||null===b3)return a2!==b3;const keys2=[...new Set([...Object.keys(a2),...Object.keys(b3)])];if(ignoreUndefined)return keys2.map((key2=>void 0!==(null==a2?void 0:a2[key2])&&void 0!==(null==b3?void 0:b3[key2])&&isObjectDifferent(null==a2?void 0:a2[key2],null==b3?void 0:b3[key2]))).some((e4=>true==e4));else return keys2.map((key2=>isObjectDifferent(null==a2?void 0:a2[key2],null==b3?void 0:b3[key2]))).some((e4=>true==e4))}else return a2!==b3}var traps={};async function waitForSignal(id,timeout){return await waitForValue(id,timeout)!==RESULT_TIMED_OUT}function waitForValue(id,timeout){let resolveTrap,trapJob;const timer=timeout?setTimeout((()=>{if(id in traps)traps[id]=traps[id].filter((e4=>e4!=trapJob));if(resolveTrap)resolveTrap(RESULT_TIMED_OUT);resolveTrap=void 0}),timeout):false;return new Promise((res2=>{if(!(id in traps))traps[id]=[];resolveTrap=res2;trapJob=result=>{if(timer)clearTimeout(timer);res2(result)};traps[id].push(trapJob)}))}function sendSignal(id){sendValue(id,true)}function sendValue(id,result){if(!(id in traps))return;const trap=traps[id];delete traps[id];for(const resolver of trap)resolver(result)}var _a2,throttle=(func,timeout)=>{let timer,lastTime=0;return(...args)=>{if(!lastTime){func(...args);lastTime=Date.now()}else{clearTimeout(timer);const delayTime=timeout-(Date.now()-lastTime);timer=setTimeout((()=>{func(...args);lastTime=Date.now()}),delayTime)}}};function sizeToHumanReadable2(size){const units=["B","KB","MB","GB","TB"];let i2=0;for(;size>=1024&&i2<units.length;){size/=1024;i2++}return size.toFixed(2)+units[i2]}function resolveWithIgnoreKnownError(p2,def){return new Promise(((res2,rej)=>{p2.then(res2).catch((ex=>isErrorOfMissingDoc(ex)?res2(def):rej(ex)))}))}var Parallels=(ps=new Set)=>({add:p2=>ps.add(!!p2.then((()=>ps.delete(p2))).catch((()=>ps.delete(p2)))&&p2),wait:limit=>ps.size>=limit&&Promise.race(ps),all:()=>Promise.all(ps)});async function allSettledWithConcurrencyLimit(processes,limit){const ps=Parallels();for(const proc of processes){ps.add(proc);await ps.wait(limit)}(await ps.all()).forEach((()=>{}))}function getDocData(doc){return"string"==typeof doc?doc:doc.join("")}function getDocDataAsArray(doc){return"string"==typeof doc?[doc]:doc}function getDocDataAsArrayBuffer(doc){if(doc instanceof ArrayBuffer)return new Uint8Array(doc);else return concatUInt8Array(getDocDataAsArray(doc).map((e4=>writeString(e4))))}function isTextBlob(blob){return"text/plain"===blob.type}function createTextBlob(data){const d4=Array.isArray(data)?data:[data];return new Blob(d4,{endings:"transparent",type:"text/plain"})}function createBinaryBlob(data){return new Blob([data],{endings:"transparent",type:"application/octet-stream"})}function createBlob(data){if(data instanceof Blob)return data;if(data instanceof Uint8Array||data instanceof ArrayBuffer)return createBinaryBlob(data);else return createTextBlob(data)}function isTextDocument(doc){if("plain"==doc.type)return true;if("plain"==doc.datatype)return true;if(isPlainText(doc.path))return true;else return false}function readAsBlob(doc){if(isTextDocument(doc))return createTextBlob(doc.data);else return createBinaryBlob(decodeBinary(doc.data))}function readContent(doc){if(isTextDocument(doc))return getDocData(doc.data);else return decodeBinary(doc.data)}var isIndexDBCmpExist="undefined"!=typeof(null==(_a2=null==window?void 0:window.indexedDB)?void 0:_a2.cmp);async function isDocContentSame(docA,docB){const blob1=createBlob(docA),blob2=createBlob(docB);if(blob1.size!=blob2.size)return false;if(isIndexDBCmpExist)return 0===window.indexedDB.cmp(await blob1.arrayBuffer(),await blob2.arrayBuffer());const length=blob1.size;let i2=0;for(;i2<length;){const ab1=await blob1.slice(i2,i2+1e4).arrayBuffer(),ab2=await blob2.slice(i2,i2+1e4).arrayBuffer();i2+=1e4;if(await arrayBufferToBase64Single(ab1)!=await arrayBufferToBase64Single(ab2))return false}return true}function isObfuscatedEntry(doc){if(doc._id.startsWith(PREFIX_OBFUSCATED))return true;else return false}function isEncryptedChunkEntry(doc){if(doc._id.startsWith(PREFIX_ENCRYPTED_CHUNK))return true;else return false}function isSyncInfoEntry(doc){if(doc._id==SYNCINFO_ID)return true;else return false}function memorizeFuncWithLRUCache(func){const cache=new LRUCache(100,1e5,true);return key2=>{if(cache.has(key2))return cache.get(key2);const value=func(key2);cache.set(key2,value);return value}}function memorizeFuncWithLRUCacheMulti(func){const cache=new LRUCache(100,1e5,true);return keys2=>{const theKey=keys2.map((e4=>"string"==typeof e4||"number"==typeof e4||"boolean"==typeof e4?e4.toString():JSON.stringify(e4))).join("-");if(cache.has(theKey))return cache.get(theKey);const value=func(...keys2);cache.set(theKey,value);return value}}function onlyNot(exclusion){return function _onlyNot(item){if(item===exclusion)return false;else return true}}var lastProcessed={};function markInterval(key2,now2){var _a5;const next=null!=now2?now2:Date.now();if(null!=(_a5=null==lastProcessed?void 0:lastProcessed[key2])?_a5:0<next)lastProcessed[key2]=next}async function runWithInterval(key2,interval,task){const now2=Date.now();try{if(!(key2 in lastProcessed)){markInterval(key2,now2);return await task()}const diff=now2-lastProcessed[key2];if(diff<interval){markInterval(key2,now2);await delay(diff)}markInterval(key2);return await task()}finally{markInterval(key2)}}async function runWithStartInterval(key2,interval,task){const now2=Date.now();if(!(key2 in lastProcessed)){markInterval(key2,now2);return await task()}const diff=now2-lastProcessed[key2];if(diff<interval){markInterval(key2,now2);await delay(diff)}markInterval(key2);return await task()}var globalConcurrencyController=Semaphore(50);function determineTypeFromBlob(data){return isTextBlob(data)?"plain":"newnote"}function determineType(path2,data){if(data instanceof Blob)return determineTypeFromBlob(data);if(isPlainText(path2))return"plain";if(data instanceof Uint8Array)return"newnote";if(data instanceof ArrayBuffer)return"newnote";else return"plain"}function isAnyNote(doc){return"type"in doc&&("newnote"==doc.type||"plain"==doc.type)}function isLoadedEntry(doc){return"type"in doc&&("newnote"==doc.type||"plain"==doc.type)&&"data"in doc}function createSavingEntryFromLoadedEntry(doc){const data=readAsBlob(doc),type=determineType(doc.path,data);return{...doc,data,datatype:type,type,children:[]}}function setAllItems(set,items){items.forEach((e4=>set.add(e4)));return set}function escapeNewLineFromString(str){if(str.indexOf("\n")<0)return str;else return"\\f"+replaceAll(replaceAll(str,"\\","\\\\"),"\n","\\n")}function unescapeNewLineFromString(str){if(!str.startsWith("\\f"))return str;else return replaceAll(replaceAll(str.substring(2),"\\\\","\\"),"\\n","\n")}function escapeMarkdownValue(value){if("string"==typeof value)return replaceAllPairs(value,["|","\\|"],["`","\\`"]);else return value}function timeDeltaToHumanReadable(delta){const sec=delta/1e3;if(sec<60)return`${sec.toFixed(2)}s`;const min=sec/60;if(min<60)return`${min.toFixed(2)}m`;const hour=min/60;if(hour<24)return`${hour.toFixed(2)}h`;const day=hour/24;if(day<365)return`${day.toFixed(2)}d`;else return`${(day/365).toFixed(2)}y`}async function wrapException(func){try{return await func()}catch(ex){if(ex instanceof Error)return ex;else return new Error(ex)}}function toRanges(sorted){if(0==(null==sorted?void 0:sorted.length))return"";const ranges=[];let start=sorted[0],end=sorted[0];for(let i2=1;i2<sorted.length;i2++)if(sorted[i2]===end+1)end=sorted[i2];else{ranges.push(start===end?`${start.toString(32)}`:`${start.toString(32)}-${end.toString(32)}`);start=sorted[i2];end=sorted[i2]}ranges.push(start===end?`${start.toString(32)}`:`${start.toString(32)}-${end.toString(32)}`);return ranges.join(",")}var previousValues=new Map;function isDirty(key2,value){if(previousValues.get(key2)===value)return false;previousValues.set(key2,value);return true}function isSensibleMargeApplicable(path2){if(path2.endsWith(".md"))return true;else return false}function isObjectMargeApplicable(path2){if(path2.endsWith(".canvas"))return true;if(path2.endsWith(".json"))return true;else return false}function tryParseJSON(str,fallbackValue){try{return JSON.parse(str)}catch(e4){return fallbackValue}}var MARK_OPERATOR="",MARK_DELETED=`${MARK_OPERATOR}__DELETED`,MARK_ISARRAY=`${MARK_OPERATOR}__ARRAY`,MARK_SWAPPED=`${MARK_OPERATOR}__SWAP`;function unorderedArrayToObject(obj){return obj.map((e4=>({[e4.id]:e4}))).reduce(((p2,c2)=>({...p2,...c2})),{})}function objectToUnorderedArray(obj){const entries=Object.entries(obj);if(entries.some((e4=>{var _a5;return e4[0]!=(null==(_a5=e4[1])?void 0:_a5.id)})))throw new Error("Item looks like not unordered array");return entries.map((e4=>e4[1]))}function generatePatchUnorderedArray(from,to){if(from.every((e4=>"object"==typeof e4&&"id"in e4))&&to.every((e4=>"object"==typeof e4&&"id"in e4))){const diff=generatePatchObj(unorderedArrayToObject(from),unorderedArrayToObject(to));if(Object.keys(diff).length>0)return{[MARK_ISARRAY]:diff};else return{}}return{[MARK_SWAPPED]:to}}function generatePatchObj(from,to){const entries=Object.entries(from),tempMap=new Map(entries),ret={},newEntries=Object.entries(to);for(const[key2,value]of newEntries)if(!tempMap.has(key2)){ret[key2]=value;tempMap.delete(key2)}else{const v2=tempMap.get(key2);if(typeof v2!=typeof value||Array.isArray(v2)!==Array.isArray(value))ret[key2]={[MARK_SWAPPED]:value};else if(null===v2&&null===value);else if(null===v2&&null!==value)ret[key2]={[MARK_SWAPPED]:value};else if(null!==v2&&null===value)ret[key2]={[MARK_SWAPPED]:value};else if("object"==typeof v2&&"object"==typeof value&&!Array.isArray(v2)&&!Array.isArray(value)){const wk2=generatePatchObj(v2,value);if(Object.keys(wk2).length>0)ret[key2]=wk2}else if("object"==typeof v2&&"object"==typeof value&&Array.isArray(v2)&&Array.isArray(value)){const wk2=generatePatchUnorderedArray(v2,value);if(Object.keys(wk2).length>0)ret[key2]=wk2}else if("object"!=typeof v2&&"object"!=typeof value){if(JSON.stringify(tempMap.get(key2))!==JSON.stringify(value))ret[key2]=value}else if(JSON.stringify(tempMap.get(key2))!==JSON.stringify(value))ret[key2]={[MARK_SWAPPED]:value};tempMap.delete(key2)}for(const[key2]of tempMap)ret[key2]=MARK_DELETED;return ret}function applyPatch(from,patch){const ret=from,patches=Object.entries(patch);for(const[key2,value]of patches)if(value!=MARK_DELETED)if(null!==value)if("object"==typeof value){if(MARK_SWAPPED in value){ret[key2]=value[MARK_SWAPPED];continue}if(MARK_ISARRAY in value){if(!(key2 in ret))ret[key2]=[];if(!Array.isArray(ret[key2]))throw new Error("Patch target type is mismatched (array to something)");const appliedArray=objectToUnorderedArray(applyPatch(unorderedArrayToObject(ret[key2]),value[MARK_ISARRAY]));ret[key2]=[...appliedArray]}else{if(!(key2 in ret)){ret[key2]=value;continue}ret[key2]=applyPatch(ret[key2],value)}}else ret[key2]=value;else ret[key2]=null;else delete ret[key2];return ret}function mergeObject(objA,objB){const newEntries=Object.entries(objB),ret={...objA};if(typeof objA!=typeof objB||Array.isArray(objA)!==Array.isArray(objB))return objB;for(const[key2,v2]of newEntries)if(key2 in ret){const value=ret[key2];if(typeof v2!=typeof value||Array.isArray(v2)!==Array.isArray(value))ret[key2]=v2;else if("object"==typeof v2&&"object"==typeof value&&!Array.isArray(v2)&&!Array.isArray(value))ret[key2]=mergeObject(v2,value);else if("object"==typeof v2&&"object"==typeof value&&Array.isArray(v2)&&Array.isArray(value))ret[key2]=[...new Set([...v2,...value])];else ret[key2]=v2}else ret[key2]=v2;const retSorted=Object.fromEntries(Object.entries(ret).sort(((a2,b3)=>a2[0]<b3[0]?-1:a2[0]>b3[0]?1:0)));if(Array.isArray(objA)&&Array.isArray(objB))return Object.values(retSorted);else return retSorted}function flattenObject(obj,path2=[]){if("object"!=typeof obj)return[[path2.join("."),obj]];if(null===obj)return[[path2.join("."),null]];if(Array.isArray(obj))return[[path2.join("."),JSON.stringify(obj)]];const e4=Object.entries(obj),ret=[];for(const[key2,value]of e4){const p2=flattenObject(value,[...path2,key2]);ret.push(...p2)}return ret}var e,t=new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,2,127,127,0,96,3,127,127,127,1,127,3,3,2,1,0,5,3,1,0,1,7,23,3,3,109,101,109,2,0,5,120,120,104,51,50,0,0,5,120,120,104,54,52,0,1,10,152,9,2,242,2,1,4,127,32,0,32,1,106,33,3,32,1,32,1,65,16,79,4,127,32,3,65,16,107,33,6,32,2,65,168,136,141,161,2,106,33,1,32,2,65,137,235,208,208,7,107,33,4,32,2,65,207,140,162,142,6,106,33,5,3,64,32,1,32,0,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,1,32,4,32,0,65,4,106,34,0,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,4,32,2,32,0,65,4,106,34,0,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,2,32,5,32,0,65,4,106,34,0,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,5,32,6,32,0,65,4,106,34,0,79,13,0,11,32,2,65,12,119,32,5,65,18,119,106,32,4,65,7,119,106,32,1,65,1,119,106,5,32,2,65,177,207,217,178,1,106,11,106,33,2,3,64,32,3,32,0,65,4,106,79,4,64,32,2,32,0,40,2,0,65,189,220,202,149,124,108,106,65,17,119,65,175,214,211,190,2,108,33,2,32,0,65,4,106,33,0,12,1,11,11,3,64,32,0,32,3,73,4,64,32,2,32,0,45,0,0,65,177,207,217,178,1,108,106,65,11,119,65,177,243,221,241,121,108,33,2,32,0,65,1,106,33,0,12,1,11,11,32,2,32,2,65,15,118,115,65,247,148,175,175,120,108,34,0,65,13,118,32,0,115,65,189,220,202,149,124,108,34,0,65,16,118,32,0,115,11,161,6,2,4,126,3,127,32,0,65,4,106,53,2,0,32,0,53,2,0,66,32,134,132,33,2,32,1,32,0,65,8,106,34,6,106,33,7,32,1,65,32,79,4,126,32,7,65,32,107,33,8,32,2,66,214,235,130,238,234,253,137,245,224,0,124,33,3,32,2,66,177,169,172,193,173,184,212,166,61,125,33,4,32,2,66,249,234,208,208,231,201,161,228,225,0,124,33,5,3,64,32,3,32,6,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,3,32,4,32,6,65,8,106,34,6,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,4,32,2,32,6,65,8,106,34,6,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,2,32,5,32,6,65,8,106,34,6,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,5,32,8,32,6,65,8,106,34,6,79,13,0,11,32,2,66,12,137,32,5,66,18,137,124,32,4,66,7,137,124,32,3,66,1,137,124,32,3,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,4,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,2,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,32,5,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,5,32,2,66,197,207,217,178,241,229,186,234,39,124,11,32,1,173,124,33,2,3,64,32,7,32,6,65,8,106,79,4,64,32,2,32,6,41,3,0,66,207,214,211,190,210,199,171,217,66,126,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,27,137,66,135,149,175,175,152,182,222,155,158,127,126,66,157,163,181,234,131,177,141,138,250,0,125,33,2,32,6,65,8,106,33,6,12,1,11,11,32,6,65,4,106,32,7,77,4,64,32,2,32,6,53,2,0,66,135,149,175,175,152,182,222,155,158,127,126,133,66,23,137,66,207,214,211,190,210,199,171,217,66,126,66,249,243,221,241,153,246,153,171,22,124,33,2,32,6,65,4,106,33,6,11,3,64,32,6,32,7,73,4,64,32,2,32,6,49,0,0,66,197,207,217,178,241,229,186,234,39,126,133,66,11,137,66,135,149,175,175,152,182,222,155,158,127,126,33,2,32,6,65,1,106,33,6,12,1,11,11,32,0,32,2,32,2,66,33,136,133,66,207,214,211,190,210,199,171,217,66,126,34,2,66,29,136,32,2,133,66,249,243,221,241,153,246,153,171,22,126,34,2,66,32,136,32,2,133,34,2,66,32,136,62,2,0,32,0,65,4,106,32,2,62,2,0,11]);function n(t4,e4,n3){if(e4.buffer.byteLength<t4.byteLength+n3){const i2=Math.ceil((t4.byteLength+n3-e4.buffer.byteLength)/65536);e4.grow(i2)}new Uint8Array(e4.buffer,n3).set(t4)}async function xxhash_wasm_default(){const{instance:{exports:{mem:i2,xxh32:o2,xxh64:r2}}}=await WebAssembly.instantiate(t);function h3(t4){let e4=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return n(t4,i2,0),o2(0,t4.byteLength,e4)>>>0}function c2(t4){let e4=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o3=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;n(t4,i2,8);const h4=new DataView(i2.buffer);return h4.setUint32(0,e4,true),h4.setUint32(4,o3,true),r2(0,t4.byteLength),h4}return{h32:function(t4){let n3=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e||(e=new TextEncoder);return h3(e.encode(t4),n3).toString(16)},h32Raw:h3,h64:function(t4){let n3=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i3=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;e||(e=new TextEncoder);const r3=c2(e.encode(t4),n3,i3);return r3.getUint32(0,true).toString(16)+r3.getUint32(4,true).toString(16)},h64Raw:function(t4){let e4=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n3=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return new Uint8Array(c2(t4,e4,n3).buffer,0,8)}}}var hashFunc,context,t2=new Uint8Array([0,97,115,109,1,0,0,0,1,48,8,96,3,127,127,127,0,96,3,127,127,127,1,127,96,2,127,127,0,96,2,127,126,0,96,1,127,1,127,96,1,127,1,126,96,3,127,127,126,1,126,96,3,126,127,127,1,126,3,11,10,1,1,2,0,4,6,7,3,0,5,5,3,1,0,1,7,85,9,3,109,101,109,2,0,5,120,120,104,51,50,0,0,6,105,110,105,116,51,50,0,2,8,117,112,100,97,116,101,51,50,0,3,8,100,105,103,101,115,116,51,50,0,4,5,120,120,104,54,52,0,5,6,105,110,105,116,54,52,0,7,8,117,112,100,97,116,101,54,52,0,8,8,100,105,103,101,115,116,54,52,0,9,10,211,23,10,242,1,1,4,127,32,0,32,1,106,33,3,32,1,65,16,79,4,127,32,3,65,16,107,33,6,32,2,65,168,136,141,161,2,106,33,3,32,2,65,247,148,175,175,120,106,33,4,32,2,65,177,243,221,241,121,107,33,5,3,64,32,0,40,2,0,65,247,148,175,175,120,108,32,3,106,65,13,119,65,177,243,221,241,121,108,33,3,32,0,65,4,106,34,0,40,2,0,65,247,148,175,175,120,108,32,4,106,65,13,119,65,177,243,221,241,121,108,33,4,32,0,65,4,106,34,0,40,2,0,65,247,148,175,175,120,108,32,2,106,65,13,119,65,177,243,221,241,121,108,33,2,32,0,65,4,106,34,0,40,2,0,65,247,148,175,175,120,108,32,5,106,65,13,119,65,177,243,221,241,121,108,33,5,32,0,65,4,106,34,0,32,6,77,13,0,11,32,2,65,12,119,32,5,65,18,119,106,32,4,65,7,119,106,32,3,65,1,119,106,5,32,2,65,177,207,217,178,1,106,11,32,1,106,32,0,32,1,65,15,113,16,1,11,146,1,0,32,1,32,2,106,33,2,3,64,32,1,65,4,106,32,2,75,69,4,64,32,1,40,2,0,65,189,220,202,149,124,108,32,0,106,65,17,119,65,175,214,211,190,2,108,33,0,32,1,65,4,106,33,1,12,1,11,11,3,64,32,1,32,2,79,69,4,64,32,1,45,0,0,65,177,207,217,178,1,108,32,0,106,65,11,119,65,177,243,221,241,121,108,33,0,32,1,65,1,106,33,1,12,1,11,11,32,0,65,15,118,32,0,115,65,247,148,175,175,120,108,34,0,32,0,65,13,118,115,65,189,220,202,149,124,108,34,0,32,0,65,16,118,115,11,63,0,32,0,65,8,106,32,1,65,168,136,141,161,2,106,54,2,0,32,0,65,12,106,32,1,65,247,148,175,175,120,106,54,2,0,32,0,65,16,106,32,1,54,2,0,32,0,65,20,106,32,1,65,177,243,221,241,121,107,54,2,0,11,211,4,1,6,127,32,1,32,2,106,33,6,32,0,65,24,106,33,5,32,0,65,40,106,40,2,0,33,3,32,0,32,0,40,2,0,32,2,106,54,2,0,32,0,65,4,106,34,4,32,4,40,2,0,32,2,65,16,79,32,0,40,2,0,65,16,79,114,114,54,2,0,32,2,32,3,106,65,16,73,4,64,32,3,32,5,106,32,1,32,2,252,10,0,0,32,0,65,40,106,32,2,32,3,106,54,2,0,15,11,32,3,4,64,32,3,32,5,106,32,1,65,16,32,3,107,34,2,252,10,0,0,32,0,65,8,106,34,3,40,2,0,32,5,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,4,32,3,32,4,54,2,0,32,0,65,12,106,34,3,40,2,0,32,5,65,4,106,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,4,32,3,32,4,54,2,0,32,0,65,16,106,34,3,40,2,0,32,5,65,8,106,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,4,32,3,32,4,54,2,0,32,0,65,20,106,34,3,40,2,0,32,5,65,12,106,40,2,0,65,247,148,175,175,120,108,106,65,13,119,65,177,243,221,241,121,108,33,4,32,3,32,4,54,2,0,32,0,65,40,106,65,0,54,2,0,32,1,32,2,106,33,1,11,32,1,32,6,65,16,107,77,4,64,32,6,65,16,107,33,8,32,0,65,8,106,40,2,0,33,2,32,0,65,12,106,40,2,0,33,3,32,0,65,16,106,40,2,0,33,4,32,0,65,20,106,40,2,0,33,7,3,64,32,1,40,2,0,65,247,148,175,175,120,108,32,2,106,65,13,119,65,177,243,221,241,121,108,33,2,32,1,65,4,106,34,1,40,2,0,65,247,148,175,175,120,108,32,3,106,65,13,119,65,177,243,221,241,121,108,33,3,32,1,65,4,106,34,1,40,2,0,65,247,148,175,175,120,108,32,4,106,65,13,119,65,177,243,221,241,121,108,33,4,32,1,65,4,106,34,1,40,2,0,65,247,148,175,175,120,108,32,7,106,65,13,119,65,177,243,221,241,121,108,33,7,32,1,65,4,106,34,1,32,8,77,13,0,11,32,0,65,8,106,32,2,54,2,0,32,0,65,12,106,32,3,54,2,0,32,0,65,16,106,32,4,54,2,0,32,0,65,20,106,32,7,54,2,0,11,32,1,32,6,73,4,64,32,5,32,1,32,6,32,1,107,34,1,252,10,0,0,32,0,65,40,106,32,1,54,2,0,11,11,97,1,1,127,32,0,65,16,106,40,2,0,33,1,32,0,65,4,106,40,2,0,4,127,32,1,65,12,119,32,0,65,20,106,40,2,0,65,18,119,106,32,0,65,12,106,40,2,0,65,7,119,106,32,0,65,8,106,40,2,0,65,1,119,106,5,32,1,65,177,207,217,178,1,106,11,32,0,40,2,0,106,32,0,65,24,106,32,0,65,40,106,40,2,0,16,1,11,157,4,2,1,127,3,126,32,0,32,1,106,33,3,32,1,65,32,79,4,126,32,3,65,32,107,33,3,32,2,66,135,149,175,175,152,182,222,155,158,127,124,66,207,214,211,190,210,199,171,217,66,124,33,4,32,2,66,207,214,211,190,210,199,171,217,66,124,33,5,32,2,66,0,124,33,6,32,2,66,135,149,175,175,152,182,222,155,158,127,125,33,2,3,64,32,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,32,4,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,4,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,32,5,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,5,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,32,6,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,6,32,0,65,8,106,34,0,41,3,0,66,207,214,211,190,210,199,171,217,66,126,32,2,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,2,32,0,65,8,106,34,0,32,3,77,13,0,11,32,6,66,12,137,32,2,66,18,137,124,32,5,66,7,137,124,32,4,66,1,137,124,32,4,66,207,214,211,190,210,199,171,217,66,126,66,0,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,227,220,202,149,252,206,242,245,133,127,124,32,5,66,207,214,211,190,210,199,171,217,66,126,66,0,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,227,220,202,149,252,206,242,245,133,127,124,32,6,66,207,214,211,190,210,199,171,217,66,126,66,0,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,227,220,202,149,252,206,242,245,133,127,124,32,2,66,207,214,211,190,210,199,171,217,66,126,66,0,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,227,220,202,149,252,206,242,245,133,127,124,5,32,2,66,197,207,217,178,241,229,186,234,39,124,11,32,1,173,124,32,0,32,1,65,31,113,16,6,11,137,2,0,32,1,32,2,106,33,2,3,64,32,1,65,8,106,32,2,77,4,64,32,1,41,3,0,66,207,214,211,190,210,199,171,217,66,126,66,0,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,32,0,133,66,27,137,66,135,149,175,175,152,182,222,155,158,127,126,66,227,220,202,149,252,206,242,245,133,127,124,33,0,32,1,65,8,106,33,1,12,1,11,11,32,1,65,4,106,32,2,77,4,64,32,1,53,2,0,66,135,149,175,175,152,182,222,155,158,127,126,32,0,133,66,23,137,66,207,214,211,190,210,199,171,217,66,126,66,249,243,221,241,153,246,153,171,22,124,33,0,32,1,65,4,106,33,1,11,3,64,32,1,32,2,73,4,64,32,1,49,0,0,66,197,207,217,178,241,229,186,234,39,126,32,0,133,66,11,137,66,135,149,175,175,152,182,222,155,158,127,126,33,0,32,1,65,1,106,33,1,12,1,11,11,32,0,66,33,136,32,0,133,66,207,214,211,190,210,199,171,217,66,126,34,0,32,0,66,29,136,133,66,249,243,221,241,153,246,153,171,22,126,34,0,32,0,66,32,136,133,11,88,0,32,0,65,8,106,32,1,66,135,149,175,175,152,182,222,155,158,127,124,66,207,214,211,190,210,199,171,217,66,124,55,3,0,32,0,65,16,106,32,1,66,207,214,211,190,210,199,171,217,66,124,55,3,0,32,0,65,24,106,32,1,55,3,0,32,0,65,32,106,32,1,66,135,149,175,175,152,182,222,155,158,127,125,55,3,0,11,132,5,2,3,127,4,126,32,1,32,2,106,33,5,32,0,65,40,106,33,4,32,0,65,200,0,106,40,2,0,33,3,32,0,32,0,41,3,0,32,2,173,124,55,3,0,32,2,32,3,106,65,32,73,4,64,32,3,32,4,106,32,1,32,2,252,10,0,0,32,0,65,200,0,106,32,2,32,3,106,54,2,0,15,11,32,3,4,64,32,3,32,4,106,32,1,65,32,32,3,107,34,2,252,10,0,0,32,0,65,8,106,34,3,41,3,0,32,4,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,6,32,3,32,6,55,3,0,32,0,65,16,106,34,3,41,3,0,32,4,65,8,106,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,6,32,3,32,6,55,3,0,32,0,65,24,106,34,3,41,3,0,32,4,65,16,106,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,6,32,3,32,6,55,3,0,32,0,65,32,106,34,3,41,3,0,32,4,65,24,106,41,3,0,66,207,214,211,190,210,199,171,217,66,126,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,6,32,3,32,6,55,3,0,32,0,65,200,0,106,65,0,54,2,0,32,1,32,2,106,33,1,11,32,1,65,32,106,32,5,77,4,64,32,5,65,32,107,33,2,32,0,65,8,106,41,3,0,33,6,32,0,65,16,106,41,3,0,33,7,32,0,65,24,106,41,3,0,33,8,32,0,65,32,106,41,3,0,33,9,3,64,32,1,41,3,0,66,207,214,211,190,210,199,171,217,66,126,32,6,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,6,32,1,65,8,106,34,1,41,3,0,66,207,214,211,190,210,199,171,217,66,126,32,7,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,7,32,1,65,8,106,34,1,41,3,0,66,207,214,211,190,210,199,171,217,66,126,32,8,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,8,32,1,65,8,106,34,1,41,3,0,66,207,214,211,190,210,199,171,217,66,126,32,9,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,33,9,32,1,65,8,106,34,1,32,2,77,13,0,11,32,0,65,8,106,32,6,55,3,0,32,0,65,16,106,32,7,55,3,0,32,0,65,24,106,32,8,55,3,0,32,0,65,32,106,32,9,55,3,0,11,32,1,32,5,73,4,64,32,4,32,1,32,5,32,1,107,34,1,252,10,0,0,32,0,65,200,0,106,32,1,54,2,0,11,11,200,2,1,5,126,32,0,65,24,106,41,3,0,33,1,32,0,41,3,0,34,2,66,32,90,4,126,32,0,65,8,106,41,3,0,34,3,66,1,137,32,0,65,16,106,41,3,0,34,4,66,7,137,124,32,1,66,12,137,32,0,65,32,106,41,3,0,34,5,66,18,137,124,124,32,3,66,207,214,211,190,210,199,171,217,66,126,66,0,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,227,220,202,149,252,206,242,245,133,127,124,32,4,66,207,214,211,190,210,199,171,217,66,126,66,0,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,227,220,202,149,252,206,242,245,133,127,124,32,1,66,207,214,211,190,210,199,171,217,66,126,66,0,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,227,220,202,149,252,206,242,245,133,127,124,32,5,66,207,214,211,190,210,199,171,217,66,126,66,0,124,66,31,137,66,135,149,175,175,152,182,222,155,158,127,126,133,66,135,149,175,175,152,182,222,155,158,127,126,66,227,220,202,149,252,206,242,245,133,127,124,5,32,1,66,197,207,217,178,241,229,186,234,39,124,11,32,2,124,32,0,65,40,106,32,2,66,31,131,167,16,6,11]);async function e2(){const{instance:{exports:{mem:e4,xxh32:n3,xxh64:r2,init32:i2,update32:o2,digest32:h3,init64:s2,update64:u2,digest64:g2}}}=await WebAssembly.instantiate(t2);let a2=new Uint8Array(e4.buffer);function c2(t4,n4){if(e4.buffer.byteLength<t4+n4){const r3=Math.ceil((t4+n4-e4.buffer.byteLength)/65536);e4.grow(r3),a2=new Uint8Array(e4.buffer)}}function l2(t4,e5,n4,r3,i3,o3){c2(t4);const h4=new Uint8Array(t4);return a2.set(h4),n4(0,e5),h4.set(a2.slice(0,t4)),{update(e6){let n5;return a2.set(h4),"string"==typeof e6?(c2(3*e6.length,t4),n5=b3.encodeInto(e6,a2.subarray(t4)).written):(c2(e6.byteLength,t4),a2.set(e6,t4),n5=e6.byteLength),r3(0,t4,n5),h4.set(a2.slice(0,t4)),this},digest:()=>(a2.set(h4),o3(i3(0)))}}function d4(t4){return t4>>>0}const f4=BigInt(2)**BigInt(64)-BigInt(1);function y2(t4){return t4&f4}const b3=new TextEncoder,w2=BigInt(0);function p2(t4){let e5=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return c2(3*t4.length,0),d4(n3(0,b3.encodeInto(t4,a2).written,e5))}function v2(t4){let e5=arguments.length>1&&void 0!==arguments[1]?arguments[1]:w2;return c2(3*t4.length,0),y2(r2(0,b3.encodeInto(t4,a2).written,e5))}return{h32:p2,h32ToString(t4){return p2(t4,arguments.length>1&&void 0!==arguments[1]?arguments[1]:0).toString(16).padStart(8,"0")},h32Raw(t4){let e5=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return c2(t4.byteLength,0),a2.set(t4),d4(n3(0,t4.byteLength,e5))},create32(){return l2(48,arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i2,o2,h3,d4)},h64:v2,h64ToString(t4){return v2(t4,arguments.length>1&&void 0!==arguments[1]?arguments[1]:w2).toString(16).padStart(16,"0")},h64Raw(t4){let e5=arguments.length>1&&void 0!==arguments[1]?arguments[1]:w2;return c2(t4.byteLength,0),a2.set(t4),y2(r2(0,t4.byteLength,e5))},create64(){return l2(88,arguments.length>0&&void 0!==arguments[0]?arguments[0]:w2,s2,u2,g2,y2)}}}async function initHashFunc(){try{const{h32ToString}=await e2();hashFunc=h32ToString;Logger("xxhash for plugin initialised",LOG_LEVEL_VERBOSE)}catch(ex){Logger("Could not initialise xxhash. fallback...",LOG_LEVEL_VERBOSE);Logger(ex);try{const{h32}=await xxhash_wasm_default();hashFunc=str=>h32(str)}catch(ex2){Logger("Could not initialise old xxhash for plugin: use sha1",LOG_LEVEL_VERBOSE);Logger(ex2);hashFunc=str=>str}}return hashFunc}initHashFunc();async function sha1(src){const bytes=writeString(src),digest=await globalThis.crypto.subtle.digest({name:"SHA-1"},bytes);return await arrayBufferToBase64Single(digest)}function digestHash(src){let hash2="";for(const v2 of src)hash2=hashFunc(hash2+v2);if(""==hash2)return hashFunc("**");else return hash2}function reactiveSource(initialValue){return _reactive({initialValue})}function reactive(expression,initialValue){return _reactive({expression,initialValue})}function _reactive({expression,initialValue}){let value,_isDirty=false;const changeHandlers=new Set,instance8={myContext:new Set,markDirty(){_isDirty=true;instance8.markDependedDirty()},rippleChanged(){changeHandlers.forEach((e4=>e4(instance8)));instance8.myContext.forEach((e4=>e4.rippleChanged()))},markClean(){_isDirty=false},markDependedDirty(){instance8.myContext.forEach((e4=>e4.markDirty()))},get isDirty(){return _isDirty},get value(){if(context)instance8.myContext.add(context);if(!expression)return value;if(_isDirty){const oldValue=value,newValue=expression();if(isObjectDifferent(oldValue,newValue)){value=newValue;instance8.markClean();instance8.markDependedDirty()}}return value},set value(newValue){if(isObjectDifferent(value,newValue)){value=newValue;instance8.markDirty();instance8.rippleChanged()}},onChanged(handler){changeHandlers.add(handler);instance8.markDirty()},offChanged(handler){changeHandlers.delete(handler)}};value=function initialize(){const previousContext=context;context=instance8;const r2=expression?expression(initialValue):initialValue;context=previousContext;return r2}();return instance8}function computed(expression){const v2=reactive(expression);return()=>v2.value}var lockStats=reactiveSource({pending:[],running:[],count:0}),collectingChunks=reactiveSource(0),pluginScanningCount=reactiveSource(0),hiddenFilesProcessingCount=reactiveSource(0),hiddenFilesEventCount=reactiveSource(0),logStore=new QueueProcessor((e4=>e4),{batchSize:1,suspended:false,keepResultUntilDownstreamConnected:true}),logMessages=reactiveSource([]);function isTextBlob2(blob){return"text/plain"===blob.type}function*pickPiece(leftData,minimumChunkSize){let buffer="";L1:do{const curLine=leftData.shift();if("undefined"==typeof curLine){yield buffer;break L1}if(curLine.startsWith("```")||curLine.startsWith(" ```")||curLine.startsWith("  ```")||curLine.startsWith("   ```")){yield buffer;buffer=curLine+(0!=leftData.length?"\n":"");L2:do{const curPx=leftData.shift();if("undefined"==typeof curPx)break L2;buffer+=curPx+(0!=leftData.length?"\n":"")}while(leftData.length>0&&!(leftData[0].startsWith("```")||leftData[0].startsWith(" ```")||leftData[0].startsWith("  ```")||leftData[0].startsWith("   ```")));const isLooksLikeBASE64=buffer.endsWith("="),maybeUneditable=buffer.length>2048,endOfCodeBlock=leftData.shift();if("undefined"!=typeof endOfCodeBlock){buffer+=endOfCodeBlock;buffer+=0!=leftData.length?"\n":""}if(!isLooksLikeBASE64&&!maybeUneditable){const splitExpr=/(.*?[;,:<])/g,sx=buffer.split(splitExpr).filter((e4=>""!=e4));for(const v2 of sx)yield v2}else yield buffer;buffer=""}else{buffer+=curLine+(0!=leftData.length?"\n":"");if(buffer.length>=minimumChunkSize||0==leftData.length||"#"==leftData[0]||"#"==buffer[0]){yield buffer;buffer=""}}}while(leftData.length>0)}var charNewLine="\n".charCodeAt(0),segmenter="Segmenter"in Intl?new Intl.Segmenter(navigator.language,{granularity:"sentence"}):void 0;function*splitStringWithinLength(text2,pieceSize){let leftData=text2;do{const splitSize=pieceSize,piece=leftData.substring(0,splitSize);leftData=leftData.substring(splitSize);yield piece}while(""!=leftData)}function*splitTextInSegment(text2,pieceSize,minimumChunkSize){const segments=segmenter.segment(text2);let prev="",buf="";for(const seg of segments){const buffer=seg.segment;if(prev==buffer||buf.length<minimumChunkSize){buf+=buffer;prev=buffer}else{prev=buffer;if(buf.length>0)yield*splitStringWithinLength(buf,pieceSize);buf=buffer}}if(buf.length>0)yield*splitStringWithinLength(buf,pieceSize)}function*splitInNewLine(texts){for(const text2 of texts){let start=-1,end=-1;do{end=text2.indexOf("\n",start);if(-1==end){yield text2.substring(start);break}for(;"\n"==text2[end];)end++;yield text2.substring(start,end);start=end}while(-1!=end)}}function splitPiecesTextV2(dataSrc,pieceSize,minimumChunkSize){const dataListAll=splitInNewLine("string"==typeof dataSrc?[dataSrc]:dataSrc);let inCodeBlock=0,flush2=false,flushBefore=false;return function*(){const buf=[];for(const line of dataListAll){if(line.startsWith("````")){if(0==inCodeBlock){inCodeBlock=4;flushBefore=true}else if(4==inCodeBlock){inCodeBlock=0;flush2=true}}else if(line.startsWith("```"))if(0==inCodeBlock){inCodeBlock=3;flushBefore=true}else if(3==inCodeBlock){inCodeBlock=0;flush2=true}if(flushBefore){if(buf.length>0){yield*splitTextInSegment(buf.join(""),pieceSize,minimumChunkSize);buf.length=0}flushBefore=false}buf.push(line);if(flush2){if(buf.length>0){yield*splitStringWithinLength(buf.join(""),pieceSize);buf.length=0}flush2=false}}if(buf.length>0)if(0==inCodeBlock)yield*splitTextInSegment(buf.join(""),pieceSize,minimumChunkSize);else yield*splitStringWithinLength(buf.join(""),pieceSize)}}function binaryTextSplit(data,pieceSize,minimumChunkSize){return function*pieces(){yield*splitStringWithinLength(data,pieceSize)}}function splitPiecesText(dataSrc,pieceSize,plainSplit,minimumChunkSize,useSegmenter){if(!useSegmenter||!segmenter)return splitPiecesTextV1(dataSrc,pieceSize,plainSplit,minimumChunkSize);if(!plainSplit)return binaryTextSplit(dataSrc,pieceSize,minimumChunkSize);else return splitPiecesTextV2(dataSrc,pieceSize,minimumChunkSize)}function splitPiecesTextV1(dataSrc,pieceSize,plainSplit,minimumChunkSize){const dataList="string"==typeof dataSrc?[dataSrc]:dataSrc;return function*pieces(){for(const data of dataList)if(plainSplit){const f4=pickPiece(data.split("\n"),minimumChunkSize);for(const piece of f4){let buffer=piece;do{let ps=pieceSize;if(buffer.charCodeAt(ps-1)!=buffer.codePointAt(ps-1))ps++;yield buffer.substring(0,ps);buffer=buffer.substring(ps)}while(""!=buffer)}}else{let leftData=data;do{const splitSize=pieceSize,piece=leftData.substring(0,splitSize);leftData=leftData.substring(splitSize);yield piece}while(""!=leftData)}}}function*splitByDelimiterWithMinLength(sources,delimiter,minimumChunkLength=25,splitThreshold){let buf="",last=false;const dl=delimiter.length;for(const source of sources){const max3=source.length;if(splitThreshold&&max3>splitThreshold){yield buf+source;last=false;buf="";continue}let i2=-1,prev=0;L1:do{i2=source.indexOf(delimiter,prev);if(-1==i2)break L1;buf+=source.slice(prev,i2)+delimiter;if(buf.length>minimumChunkLength){yield buf;buf="";last=false}else last=true;prev=i2+dl}while(i2<max3);if(prev!=i2||-1==prev&&-1==i2){buf+=source.slice(prev);last=true}}if(last)yield buf}function*chunkStringGenerator(source,maxLength){const strLen=source.length;if(strLen>maxLength){let from=0;do{let end=from+maxLength;if(end>strLen){yield source.substring(from);break}for(;source.charCodeAt(end-1)!=source.codePointAt(end-1);)end++;yield source.substring(from,end);from=end}while(from<strLen)}else yield source}function*chunkStringGeneratorFromGenerator(sources,maxLength){for(const source of sources)yield*chunkStringGenerator(source,maxLength)}function*stringGenerator(sources){for(const str of sources)yield str}async function collectGenAll(strGen){const ret=[];for await(const str of strGen)ret.push(str);return ret}async function concatGeneratedAll(strGen){return(await collectGenAll(strGen)).join("")}var MAX_ITEMS=100;async function splitPieces2V2(dataSrc,pieceSize,plainSplit,minimumChunkSize,filename,useSegmenter){if(0==dataSrc.size)return function*noItems(){};if(isTextBlob2(dataSrc)){const text2=await dataSrc.text();if(!plainSplit){const gen2=chunkStringGenerator(text2,pieceSize);return function*pieces(){yield*gen2}}const textLen=text2.length;let xMinimumChunkSize=minimumChunkSize;for(;textLen/xMinimumChunkSize>MAX_ITEMS;)xMinimumChunkSize+=minimumChunkSize;const gen=chunkStringGeneratorFromGenerator(splitByDelimiterWithMinLength(stringGenerator([text2]),"\n",xMinimumChunkSize),pieceSize);return function*pieces(){yield*gen}}let canBeSmall=false,delimiter=0;if(filename&&filename.endsWith(".pdf"))delimiter="/".charCodeAt(0);else if(filename&&filename.endsWith(".json")){canBeSmall=true;delimiter=",".charCodeAt(0)}const clampMin=canBeSmall?100:1e5;let step=1,w2=Math.max(clampMin,Math.min(1e8,dataSrc.size));for(;w2>10;){w2/=12.5;step++}minimumChunkSize=Math.floor(10**(step-1));return async function*piecesBlob(){const size=dataSrc.size;let i2=0;const buf=new Uint8Array(await dataSrc.arrayBuffer());do{const findStart=i2+minimumChunkSize,defaultSplitEnd=i2+pieceSize;let splitEnd,i1=buf.indexOf(delimiter,findStart);if(-1==i1)i1=buf.indexOf(charNewLine,findStart);if(-1==i1)splitEnd=defaultSplitEnd;else splitEnd=i1<defaultSplitEnd?i1:defaultSplitEnd;yield await arrayBufferToBase64Single(buf.slice(i2,splitEnd));i2=splitEnd}while(i2<size)}}async function splitPieces2(dataSrc,pieceSize,plainSplit,minimumChunkSize,filename,useSegmenter){if(isTextBlob2(dataSrc))return splitPiecesText(await dataSrc.text(),pieceSize,plainSplit,minimumChunkSize,null!=useSegmenter?useSegmenter:false);let delimiter=0,canBeSmall=false;if(filename&&filename.endsWith(".pdf"))delimiter="/".charCodeAt(0);else if(filename&&filename.endsWith(".json")){canBeSmall=true;delimiter=",".charCodeAt(0)}const clampMin=canBeSmall?100:1e5;let step=1,w2=Math.max(clampMin,Math.min(1e8,dataSrc.size));for(;w2>10;){w2/=12.5;step++}minimumChunkSize=Math.floor(10**(step-1));return async function*piecesBlob(){const size=dataSrc.size;let i2=0;do{let splitSize=pieceSize;const currentData=new Uint8Array(await dataSrc.slice(i2,i2+pieceSize).arrayBuffer());let nextIdx=currentData.indexOf(delimiter,minimumChunkSize);splitSize=-1==nextIdx?pieceSize:Math.min(pieceSize,nextIdx);if(-1==nextIdx)nextIdx=currentData.indexOf(charNewLine,minimumChunkSize);const piece=currentData.slice(0,splitSize);i2+=piece.length;const b64=await arrayBufferToBase64Single(piece);yield b64}while(i2<size)}}var import_diff_match_patch2=__toESM(require_diff_match_patch(),1);function getNoFromRev(rev3){if(!rev3)return 0;else return parseInt(rev3.split("-")[0])}function createChunkRev(chunk){return`1-${(Math.imul(chunk.data.length,21+chunk._id.charCodeAt(5)).toString(16)+"0".repeat(32)).slice(0,32)}`}var idbProxyableTypes,cursorAdvanceMethods,LiveSyncLocalDB=class{constructor(dbname,env){this.isReady=false;this.xxhash64=false;this.hashCaches=new LRUCache(10,1e3);this.changeHandler=null;this.chunkVersion=-1;this.maxChunkVersion=-1;this.minChunkVersion=-1;this.needScanning=false;this._chunkCollectProcessor=new QueueProcessor((async requesting=>{try{const chunks=await this._collectChunks(requesting,false);if(chunks)chunks.forEach((chunk=>sendValue(`chunk-fetch-${chunk._id}`,chunk)));else throw new Error("Failed: CollectChunksInternal")}catch(ex){Logger("Exception raised while retrieving chunks",LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE);requesting.forEach((id=>sendValue(`chunk-fetch-${id}`,[])))}}),{batchSize:100,interval:100,concurrentLimit:1,maintainDelay:true,suspended:false,totalRemainingReactiveSource:collectingChunks});this.auth={username:"",password:""};this.dbname=dbname;this.env=env;this.refreshSettings()}async _prepareHashFunctions(){if(null==this.h32)if("sha1"!=this.settings.hashAlg)try{const{h32ToString,h32Raw,h32,h64}=await e2();this.xxhash64=h64;this.xxhash32=h32;this.h32=h32ToString;this.h32Raw=h32Raw;Logger("Newer xxhash has been initialised",LOG_LEVEL_VERBOSE)}catch(ex){Logger("Could not initialise xxhash: use v1",LOG_LEVEL_VERBOSE);Logger(ex);try{this.xxhash64=false;const{h32,h32Raw}=await xxhash_wasm_default();this.h32=h32;this.h32Raw=h32Raw;this.xxhash32=str=>h32Raw(writeString(str))}catch(ex2){Logger("Could not initialise xxhash: use sha1F",LOG_LEVEL_VERBOSE);Logger(ex2);this.settings.hashAlg="sha1"}}else Logger("Fallback(SHA1) is used for hashing",LOG_LEVEL_VERBOSE)}get isOnDemandChunkEnabled(){if(this.settings.remoteType!==REMOTE_COUCHDB)return false;else return this.settings.readChunksOnline}onunload(){var _a5,_b2;this.env.$allOnDBUnload(this);null==(_a5=this.changeHandler)||_a5.cancel();null==(_b2=this.changeHandler)||_b2.removeAllListeners();this.localDatabase.removeAllListeners()}refreshSettings(){const settings=this.env.getSettings();this.settings=settings;this.hashCaches=new LRUCache(settings.hashCacheMaxCount,settings.hashCacheMaxAmount)}id2path(id,entry,stripPrefix2){return this.env.$$id2path(id,entry,stripPrefix2)}async path2id(filename,prefix){return await this.env.$$path2id(filename,prefix)}async close(){var _a5,_b2;Logger("Database closed (by close)");this.isReady=false;null==(_a5=this.changeHandler)||_a5.cancel();null==(_b2=this.changeHandler)||_b2.removeAllListeners();if(null!=this.localDatabase)await this.localDatabase.close();this.env.$allOnDBClose(this)}async initializeDatabase(){var _a5,_b2;await this._prepareHashFunctions();if(null!=this.localDatabase)await this.localDatabase.close();null==(_a5=this.changeHandler)||_a5.cancel();await(null==(_b2=this.changeHandler)?void 0:_b2.removeAllListeners());this.localDatabase=null;this.localDatabase=this.env.$$createPouchDBInstance(this.dbname+"-livesync-v2",{auto_compaction:false,revs_limit:100,deterministic_revs:true});if(!await this.env.$everyOnInitializeDatabase(this))Logger("Initializing Database has been failed on some module",LOG_LEVEL_NOTICE);Logger("Opening Database...");Logger("Database info",LOG_LEVEL_VERBOSE);Logger(await this.localDatabase.info(),LOG_LEVEL_VERBOSE);this.localDatabase.on("close",(()=>{var _a6;Logger("Database closed.");this.isReady=false;this.localDatabase.removeAllListeners();null==(_a6=this.env.$$getReplicator())||_a6.closeReplication()}));const changes3=this.localDatabase.changes({since:"now",live:true,filter:doc=>"leaf"==doc.type}).on("change",(e4=>{if(!e4.deleted)sendValue(`leaf-${e4.id}`,e4.doc)}));this.changeHandler=changes3;this.isReady=true;Logger("Database is now ready.");return true}async readChunk(id,timeout){const leaf=this.hashCaches.get(id);if(leaf)return leaf;let w2;try{w2=await this.localDatabase.get(id)}catch(ex){if(!isErrorOfMissingDoc(ex))throw ex}if(void 0===w2&&0!=timeout){const ret=await waitForValue(`leaf-${id}`,timeout);if(ret===RESULT_TIMED_OUT)throw new Error(`Timed out: ${id}`);w2=ret}if(void 0===w2)throw new Error(`Missing chunks of: ${id}`);if("leaf"!=w2.type)throw new Error(`Corrupted chunk has been detected: ${id}`);this.hashCaches.set(id,w2.data);return w2.data}async getChunk(piece,doc){const cachedChunkId=this.hashCaches.revGet(piece);if(void 0!==cachedChunkId)return{isNew:false,id:cachedChunkId,piece};const chunkId=PREFIX_CHUNK+await this.generateHashedChunk(piece);if(chunkId in doc.eden)return{isNew:false,id:chunkId,piece};const cachedPiece=this.hashCaches.get(chunkId);if(cachedPiece&&cachedPiece!=piece){Logger(`Hash collided! If possible, please report the following string:${chunkId}=>\nA:--${cachedPiece}--\nB:--${piece}--`,LOG_LEVEL_NOTICE);return false}this.hashCaches.set(chunkId,piece);return{isNew:true,id:chunkId,piece}}async generateHashedChunk(piece){const userPassphrase=this.settings.passphrase;if("sha1"==this.settings.hashAlg)if(this.settings.encrypt)return"+"+await sha1(`${piece}-${userPassphrase}-${piece.length}`);else return await sha1(`${piece}-${piece.length}`);else if(""===this.settings.hashAlg)if(this.settings.encrypt){const userPasswordHash=this.h32Raw((new TextEncoder).encode(userPassphrase));return"+"+(this.h32Raw((new TextEncoder).encode(piece))^userPasswordHash^piece.length).toString(36)}else return(this.h32Raw((new TextEncoder).encode(piece))^piece.length).toString(36);else if("xxhash64"==this.settings.hashAlg&&this.xxhash64)if(this.settings.encrypt)return"+"+this.xxhash64(`${piece}-${userPassphrase}-${piece.length}`).toString(36);else return this.xxhash64(`${piece}-${piece.length}`).toString(36);else if(this.settings.encrypt)return"+"+this.xxhash32(`${piece}-${userPassphrase}-${piece.length}`).toString(36);else return this.xxhash32(`${piece}-${piece.length}`).toString(36)}async getDBLeafWithTimeout(id,timeout){try{return await this.readChunk(id,timeout)}catch(ex){Logger("Something went wrong while retrieving chunks");Logger(ex,LOG_LEVEL_VERBOSE);throw ex}}getDBLeaf(id,waitForReady){return this.getDBLeafWithTimeout(id,waitForReady?LEAF_WAIT_TIMEOUT:0)}async getDBEntryMeta(path2,opt,includeDeleted=false){var _a5,_b2;if(!this.isTargetFile(path2))return false;const id=await this.path2id(path2);try{let obj=null;if(opt)obj=await this.localDatabase.get(id,opt);else obj=await this.localDatabase.get(id);const deleted=null!=(_b2=null!=(_a5=null==obj?void 0:obj.deleted)?_a5:obj._deleted)?_b2:void 0;if(!includeDeleted&&deleted)return false;if(obj.type&&"leaf"==obj.type)return false;if(!obj.type||obj.type&&"notes"==obj.type||"newnote"==obj.type||"plain"==obj.type){const note=obj;let children2=[],type="plain";if("newnote"==obj.type||"plain"==obj.type){children2=obj.children;type=obj.type}return{data:"",_id:note._id,path:path2,ctime:note.ctime,mtime:note.mtime,size:note.size,_rev:obj._rev,_conflicts:obj._conflicts,children:children2,datatype:type,deleted,type,eden:"eden"in obj?obj.eden:{}}}}catch(ex){if(isErrorOfMissingDoc(ex))return false;throw ex}return false}async getDBEntry(path2,opt,dump=false,waitForReady=true,includeDeleted=false){const meta=await this.getDBEntryMeta(path2,opt,includeDeleted);if(meta)return await this.getDBEntryFromMeta(meta,opt,dump,waitForReady,includeDeleted);else return false}async getDBEntryFromMeta(meta,opt,dump=false,waitForReady=true,includeDeleted=false){var _a5,_b2,_c2;const filename=this.id2path(meta._id,meta);if(!this.isTargetFile(filename))return false;const dispFilename=stripAllPrefixes(filename),deleted=null!=(_b2=null!=(_a5=meta.deleted)?_a5:meta._deleted)?_b2:void 0;if(!meta.type||meta.type&&"notes"==meta.type){const note=meta,doc={data:note.data,path:note.path,_id:note._id,ctime:note.ctime,mtime:note.mtime,size:note.size,_rev:meta._rev,_conflicts:meta._conflicts,children:[],datatype:"newnote",deleted,type:"newnote",eden:"eden"in meta?meta.eden:{}};if(dump){Logger("--Old fashioned document--");Logger(doc)}return doc}if("newnote"==meta.type||"plain"==meta.type){if(dump){const conflicts=await this.localDatabase.get(meta._id,{conflicts:true,revs_info:true});Logger("-- Conflicts --");Logger(null!=(_c2=conflicts._conflicts)?_c2:"No conflicts");Logger("-- Revs info -- ");Logger(conflicts._revs_info)}try{if(dump){Logger("--Bare document--");Logger(meta)}const childrenKeys=[...meta.children],loadedChildrenMap=new Map;if(meta.eden)Object.entries(meta.eden).forEach((([key2,chunk])=>loadedChildrenMap.set(key2,chunk.data)));const missingChunks=unique(childrenKeys).filter((e4=>!loadedChildrenMap.has(e4)));if(0!=missingChunks.length)if(this.isOnDemandChunkEnabled){const items=await this.collectChunks(missingChunks,false,waitForReady);if(!items||items.some((leaf=>"leaf"!=leaf.type))){Logger(`Chunks of ${dispFilename} (${meta._id.substring(0,8)}) are not valid. (p1)`,LOG_LEVEL_NOTICE);if(items)Logger(`Missing chunks: ${items.map((e4=>e4._id)).join(",")}`,LOG_LEVEL_VERBOSE);return false}items.forEach((chunk=>loadedChildrenMap.set(chunk._id,chunk.data)))}else try{if(waitForReady)(await Promise.all(missingChunks.map((e4=>this.getDBLeaf(e4,waitForReady))))).forEach(((value,idx2)=>loadedChildrenMap.set(missingChunks[idx2],value)));else{const chunkDocs=await this.localDatabase.allDocs({keys:missingChunks,include_docs:true});if(chunkDocs.rows.some((e4=>"error"in e4))){const missingChunks2=chunkDocs.rows.filter((e4=>"error"in e4)).map((e4=>e4.key)).join(", ");Logger(`Chunks of ${dispFilename} (${meta._id.substring(0,8)}) are not valid. (p2)`,LOG_LEVEL_NOTICE);Logger(`Missing chunks: ${missingChunks2}`,LOG_LEVEL_VERBOSE);return false}if(chunkDocs.rows.some((e4=>e4.doc&&"leaf"!=e4.doc.type))){const missingChunks2=chunkDocs.rows.filter((e4=>e4.doc&&"leaf"!=e4.doc.type)).map((e4=>e4.id)).join(", ");Logger(`Chunks of ${dispFilename} (${meta._id.substring(0,8)}) are not valid. (p3)`,LOG_LEVEL_NOTICE);Logger(`Corrupted chunks: ${missingChunks2}`,LOG_LEVEL_VERBOSE);return false}chunkDocs.rows.forEach(((value,idx2)=>"doc"in value&&loadedChildrenMap.set(value.doc._id,value.doc.data)))}}catch(ex){Logger(`Something went wrong on reading chunks of ${dispFilename}(${meta._id.substring(0,8)}) from database, see verbose info for detail.`,LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE);return false}const l2=childrenKeys.map((e4=>loadedChildrenMap.get(e4)));if(l2.some((e4=>void 0===e4)))throw new Error("Load failed");const doc={data:l2,path:meta.path,_id:meta._id,ctime:meta.ctime,mtime:meta.mtime,size:meta.size,_rev:meta._rev,children:meta.children,datatype:meta.type,_conflicts:meta._conflicts,eden:meta.eden,deleted,type:meta.type};if(dump){Logger("--Loaded Document--");Logger(doc)}return doc}catch(ex){if(isErrorOfMissingDoc(ex)){Logger(`Missing document content!, could not read ${dispFilename}(${meta._id.substring(0,8)}) from database.`,LOG_LEVEL_NOTICE);return false}Logger(`Something went wrong on reading ${dispFilename}(${meta._id.substring(0,8)}) from database:`,LOG_LEVEL_NOTICE);Logger(ex)}}return false}async deleteDBEntry(path2,opt){var _a5;if(!this.isTargetFile(path2))return false;const id=await this.path2id(path2);try{return null!=(_a5=await serialized("file:"+path2,(async()=>{let obj=null;if(opt)obj=await this.localDatabase.get(id,opt);else obj=await this.localDatabase.get(id);const revDeletion=opt&&""!=("rev"in opt?opt.rev:"");if(obj.type&&"leaf"==obj.type)return false;if(!obj.type||obj.type&&"notes"==obj.type){obj._deleted=true;const r2=await this.localDatabase.put(obj,{force:!revDeletion});Logger(`Entry removed:${path2} (${obj._id.substring(0,8)}-${r2.rev})`);return true}if("newnote"==obj.type||"plain"==obj.type){if(revDeletion)obj._deleted=true;else{obj.deleted=true;obj.mtime=Date.now();if(this.settings.deleteMetadataOfDeletedFiles)obj._deleted=true}const r2=await this.localDatabase.put(obj,{force:!revDeletion});Logger(`Entry removed:${path2} (${obj._id.substring(0,8)}-${r2.rev})`);return true}else return false})))?_a5:false}catch(ex){if(isErrorOfMissingDoc(ex))return false;throw ex}}async deleteDBEntryPrefix(prefix){let c2=0,readCount=0;const delDocs=[];do{const result=await this.localDatabase.allDocs({include_docs:false,skip:c2,limit:100,conflicts:true});readCount=result.rows.length;if(readCount>0)for(const v2 of result.rows){const decodedPath=this.id2path(v2.id,v2.doc);if(decodedPath.startsWith(prefix)){if(this.isTargetFile(decodedPath))delDocs.push(v2.id)}else if(!v2.id.startsWith("h:"));}c2+=readCount}while(0!=readCount);let deleteCount=0,notfound=0;for(const v2 of delDocs)try{await serialized("file:"+v2,(async()=>{const item=await this.localDatabase.get(v2);if("newnote"==item.type||"plain"==item.type){item.deleted=true;if(this.settings.deleteMetadataOfDeletedFiles)item._deleted=true;item.mtime=Date.now()}else item._deleted=true;await this.localDatabase.put(item,{force:true})}));deleteCount++}catch(ex){if(isErrorOfMissingDoc(ex))notfound++;else throw ex}Logger(`deleteDBEntryPrefix:deleted ${deleteCount} items, skipped ${notfound}`);return true}async putDBEntry(note,onlyChunks){var _a5;const filename=this.id2path(note._id,note),dispFilename=stripAllPrefixes(filename);if(!note.eden)note.eden={};if(!this.isTargetFile(filename)){Logger(`File skipped:${dispFilename}`,LOG_LEVEL_VERBOSE);return false}let processed=0;const pieceSize=Math.floor(MAX_DOC_SIZE_BIN*(1*(this.settings.customChunkSize||0)+1));let plainSplit=false;const minimumChunkSize=this.settings.minimumChunkSize;if(false)plainSplit=false;else if(shouldSplitAsPlainText(filename))plainSplit=true;const data=note.data instanceof Blob?note.data:createTextBlob(note.data);note.type=isTextBlob(data)?"plain":"newnote";note.datatype=note.type;const splitFuncInMainThread=this.settings.enableChunkSplitterV2?splitPieces2V2:splitPieces2,splitFuncInWorker=this.settings.enableChunkSplitterV2?splitPieces2WorkerV2:splitPieces2Worker,splitFunc=this.settings.disableWorkerForGeneratingChunks?splitFuncInMainThread:this.settings.processSmallFilesInUIThread&&note.data.size<1024?splitFuncInMainThread:splitFuncInWorker,pieces=await splitFunc(data,pieceSize,plainSplit,minimumChunkSize,filename,this.settings.useSegmenter),chunkTasks=[];for await(const piece of pieces()){processed++;chunkTasks.push(this.getChunk(piece,note))}const chunks=await Promise.all(chunkTasks);if(chunks.some((e4=>false===e4))){Logger(`This document could not be saved:${dispFilename}`,LOG_LEVEL_NOTICE);return false}let eden={},currentRevAsNo=0;if("eden"in note)eden=note.eden;let newChunks=[];if(this.settings.useEden&&!onlyChunks){try{const old=await this.localDatabase.get(note._id);currentRevAsNo=getNoFromRev(old._rev);eden={..."eden"in old?old.eden:{},...eden}}catch(ex){if(isErrorOfMissingDoc(ex));else throw ex}const chunkOnEdenInitial=Object.keys(eden).length;let removedChunkOnEden=0;const removeEdenChunks=Object.keys(eden).filter((e4=>chunks.every((c2=>c2.id!==e4))));for(const removeId of removeEdenChunks){removedChunkOnEden++;delete eden[removeId]}let newChunkOnEden=0,existChunkOnEden=0;for(const chunk of chunks)if(chunk.id in eden)existChunkOnEden++;else{newChunkOnEden++;eden[chunk.id]={epoch:currentRevAsNo+1,data:chunk.piece}}const allEdenChunks=Object.entries(eden).sort(((a2,b3)=>b3[1].epoch-a2[1].epoch));let totalLength=0,count=0;const allEdenChunksKey=Object.keys(eden);let alreadyIndependent=0,independent=0;const edenChunkOnDB=(await this.localDatabase.allDocs({keys:allEdenChunksKey})).rows.reduce(((p2,c2)=>({...p2,[c2.key]:c2})),{});for(const[key2,chunk]of allEdenChunks){count++;let makeChunkIndependent=false;if(!(key2 in edenChunkOnDB)||edenChunkOnDB[key2].error){if(chunk.data.length>1024)makeChunkIndependent=true;else if(chunk.epoch+this.settings.maxAgeInEden<currentRevAsNo)makeChunkIndependent=true;if(totalLength>this.settings.maxTotalLengthInEden)makeChunkIndependent=true;if(count>this.settings.maxChunksInEden)makeChunkIndependent=true;if(makeChunkIndependent){count--;independent++;newChunks.push({_id:key2,data:chunk.data,type:"leaf"});delete eden[key2]}else totalLength+=chunk.data.length}else{count--;delete eden[key2];alreadyIndependent++}}Logger(`Progress on Eden: doc: ${dispFilename} : ${chunkOnEdenInitial}->${Object.keys(eden).length} (removed: ${removedChunkOnEden}, new: ${newChunkOnEden}, exist: ${existChunkOnEden}, alreadyIndependent:${alreadyIndependent}, independent:${independent})`,LOG_LEVEL_VERBOSE)}else newChunks=chunks.filter((e4=>e4.isNew)).map((e4=>({_id:e4.id,data:e4.piece,type:"leaf"})));const cached=processed-newChunks.length;if(newChunks.length){if(!this.settings.doNotUseFixedRevisionForChunks)newChunks=newChunks.map((e4=>({...e4,_rev:createChunkRev(e4)})));const existsMap=(await this.localDatabase.allDocs({keys:newChunks.map((e4=>e4._id)),include_docs:false})).rows.map((e4=>[e4.key,"error"in e4?e4.error:e4.value.rev])).reduce(((p2,c2)=>({...p2,[c2[0]]:c2[1]})),{}),result=await this.localDatabase.bulkDocs(newChunks,{new_edits:!!this.settings.doNotUseFixedRevisionForChunks});if(this.settings.doNotUseFixedRevisionForChunks){const mappedResults=result.reduce(((p2,item)=>{if("ok"in item){p2.ok.push(item);return p2}if("error"in item)if(409==item.status){p2.skip.push(item);return p2}p2.failed.push(item);return p2}),{ok:[],skip:[],failed:[]});if(mappedResults.failed.length){Logger(`Save failed.: ${dispFilename} :${mappedResults.failed.map((e4=>{var _a6;return null!=(_a6=null==e4?void 0:e4.id)?_a6:e4.toString()})).join(",")}`,LOG_LEVEL_VERBOSE);Logger(`This document could not be saved:${dispFilename}`,LOG_LEVEL_NOTICE);return false}Logger(`Chunks saved: doc: ${dispFilename} ,chunks: ${processed} (new:${mappedResults.ok.length}, recycled:${mappedResults.skip.length}, cached:${cached})`)}else{const erroredItems=newChunks.filter((e4=>e4._id in existsMap&&existsMap[e4._id].startsWith("1-")&&existsMap[e4._id]!=e4._rev)),actualNewChunks=newChunks.filter((e4=>!(e4._id in existsMap)||!existsMap[e4._id].startsWith("1-")));if(erroredItems.length){Logger(`Save failed.: ${dispFilename} :${erroredItems.length} items mismatched`,LOG_LEVEL_VERBOSE);Logger(`This document could not be saved:${dispFilename}`,LOG_LEVEL_NOTICE);Logger(`Mismatched items: ${erroredItems.map((e4=>e4._id)).join(",")}`,LOG_LEVEL_VERBOSE);Logger(`Revision mismatch: ${erroredItems.map((e4=>`${e4._rev}, ${existsMap[e4._id]}`)).join(",")}`,LOG_LEVEL_VERBOSE);return false}Logger(`Chunks saved (with fixed): doc: ${dispFilename} ,chunks: ${processed} (new:${actualNewChunks.length}, recycled:${newChunks.length-actualNewChunks.length}, cached:${cached})`)}}if(onlyChunks)return{id:note._id,ok:true,rev:"dummy"};const newDoc={children:chunks.map((e4=>e4.id)),_id:note._id,path:note.path,ctime:note.ctime,mtime:note.mtime,size:note.size,type:note.datatype,eden};return null!=(_a5=await serialized("file:"+filename,(async()=>{try{const old=await this.localDatabase.get(newDoc._id);newDoc._rev=old._rev}catch(ex){if(isErrorOfMissingDoc(ex));else throw ex}const r2=await this.localDatabase.put(newDoc,{force:true});if(r2.ok)return r2;else return false})))?_a5:false}async resetDatabase(){var _a5,_b2;null==(_a5=this.changeHandler)||_a5.cancel();await(null==(_b2=this.changeHandler)?void 0:_b2.removeAllListeners());this.env.$$getReplicator().closeReplication();if(!await this.env.$everyOnResetDatabase(this)){Logger("Database reset has been prevented or failed on some modules.",LOG_LEVEL_NOTICE);return false}Logger("Database closed for reset Database.");this.isReady=false;await this.localDatabase.destroy();this.localDatabase=null;await this.initializeDatabase();Logger("Local Database Reset",LOG_LEVEL_NOTICE)}isTargetFile(filenameSrc){const file=filenameSrc.startsWith("i:")?filenameSrc.substring(2):filenameSrc;if(file.startsWith("ix:"))return true;if(file.startsWith("ps:"))return true;if(file.includes(":"))return false;if(this.settings.syncOnlyRegEx){const syncOnly=new RegExp(this.settings.syncOnlyRegEx,this.settings.handleFilenameCaseSensitive?"":"i");if(!file.match(syncOnly))return false}if(this.settings.syncIgnoreRegEx){const syncIgnore=new RegExp(this.settings.syncIgnoreRegEx,this.settings.handleFilenameCaseSensitive?"":"i");if(file.match(syncIgnore))return false}return true}async collectChunks(ids,showResult=false,waitForReady){const localChunks=await this.collectChunksWithCache(ids);if(0==localChunks.filter((e4=>false===e4.chunk)).map((e4=>e4.id)).length)return localChunks.map((e4=>e4.chunk));this._chunkCollectProcessor.batchSize=this.settings.concurrencyOfReadChunksOnline;this._chunkCollectProcessor.interval=this.settings.minimumIntervalOfReadChunksOnline;this._chunkCollectProcessor.enqueueAll(ids);const fetchChunkTasks=ids.map((id=>waitForValue(`chunk-fetch-${id}`)));return(await Promise.all(fetchChunkTasks)).filter(onlyNot(RESULT_TIMED_OUT))}async _collectChunks(ids,showResult=false){const localChunks=await this.collectChunksWithCache(ids),missingChunks=localChunks.filter((e4=>false===e4.chunk)).map((e4=>e4.id));if(0==missingChunks.length)return localChunks.map((e4=>e4.chunk));const remoteDocs=await this.env.$$getReplicator().fetchRemoteChunks(missingChunks,showResult);if(false==remoteDocs){Logger("Could not fetch chunks from the server. ",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_VERBOSE,"fetch");return false}remoteDocs.forEach((e4=>this.hashCaches.set(e4._id,e4.data)));await this.localDatabase.bulkDocs(remoteDocs,{new_edits:false});const chunks=Object.fromEntries([...localChunks.map((e4=>e4.chunk)).filter((e4=>false!==e4)),...remoteDocs].map((e4=>[e4._id,e4]))),ret=ids.map((e4=>{var _a5;return null!=(_a5=null==chunks?void 0:chunks[e4])?_a5:void 0}));if(ret.some((e4=>void 0===e4)))return false;else return ret}async*findAllChunks(opt){const targets=[()=>this.findEntries("h:","h:",null!=opt?opt:{})];for(const targetFun of targets){const target=targetFun();for await(const f4 of target)yield f4}}async*findEntries(startKey,endKey,opt){let nextKey=startKey;if(""==endKey)endKey="";let req=this.allDocsRaw({limit:100,startkey:nextKey,endkey:endKey,include_docs:true,...opt});do{const docs=await req;if(0===docs.rows.length)break;nextKey=`${docs.rows[docs.rows.length-1].id}`;req=this.allDocsRaw({limit:100,skip:1,startkey:nextKey,endkey:endKey,include_docs:true,...opt});for(const row of docs.rows){const doc=row.doc;if("type"in doc)if("newnote"==doc.type||"plain"==doc.type)yield doc}}while(""!=nextKey)}async*findAllDocs(opt){const targets=[()=>this.findEntries("","_",null!=opt?opt:{}),()=>this.findEntries("_","h:",null!=opt?opt:{}),()=>this.findEntries("h:","",null!=opt?opt:{})];for(const targetFun of targets){const target=targetFun();for await(const f4 of target)yield f4}}async*findEntryNames(startKey,endKey,opt){let nextKey=startKey;if(""==endKey)endKey="";let req=this.allDocsRaw({limit:100,startkey:nextKey,endkey:endKey,...opt});do{const docs=await req;if(0==docs.rows.length){nextKey="";break}nextKey=`${docs.rows[docs.rows.length-1].key}`;req=this.allDocsRaw({limit:100,skip:1,startkey:nextKey,endkey:endKey,...opt});for(const row of docs.rows)yield row.id}while(""!=nextKey)}async*findAllDocNames(opt){const targets=[()=>this.findEntryNames("","_",null!=opt?opt:{}),()=>this.findEntryNames("_","h:",null!=opt?opt:{}),()=>this.findEntryNames("h:","i:",null!=opt?opt:{}),()=>this.findEntryNames("i:","ix:",null!=opt?opt:{}),()=>this.findEntryNames("ix:","ps:",null!=opt?opt:{}),()=>this.findEntryNames("ps:","",null!=opt?opt:{})];for(const targetFun of targets){const target=targetFun();for await(const f4 of target)if(!f4.startsWith("_"))if(f4!=VERSIONING_DOCID)yield f4}}async*findAllNormalDocs(opt){const targets=[()=>this.findEntries("","_",null!=opt?opt:{}),()=>this.findEntries("_","h:",null!=opt?opt:{}),()=>this.findEntries("h:","i:",null!=opt?opt:{}),()=>this.findEntries("i:","ix:",null!=opt?opt:{}),()=>this.findEntries("ix:","ps:",null!=opt?opt:{}),()=>this.findEntries("ps:","",null!=opt?opt:{})];for(const targetFun of targets){const target=targetFun();for await(const f4 of target)if(!f4._id.startsWith("_"))if("newnote"==f4.type||"plain"==f4.type)yield f4}}async removeRevision(docId,revision){try{const doc=await this.localDatabase.get(docId,{rev:revision});doc._deleted=true;await this.localDatabase.put(doc);return true}catch(ex){if(isErrorOfMissingDoc(ex))Logger(`Remove revision: Missing target revision, ${docId}-${revision}`,LOG_LEVEL_VERBOSE)}return false}getRaw(docId,options){return this.localDatabase.get(docId,options||{})}removeRaw(docId,revision,options){return this.localDatabase.remove(docId,revision,options||{})}putRaw(doc,options){return this.localDatabase.put(doc,options||{})}allDocsRaw(options){return this.localDatabase.allDocs(options)}bulkDocsRaw(docs,options){return this.localDatabase.bulkDocs(docs,options||{})}async collectChunksWithCache(keys2){const exists=keys2.map((e4=>this.hashCaches.has(e4)?{id:e4,chunk:this.hashCaches.get(e4)}:{id:e4,chunk:false})),notExists=exists.filter((e4=>false===e4.chunk));if(notExists.length>0){const chunks=await this.localDatabase.allDocs({keys:notExists.map((e4=>e4.id)),include_docs:true}),existChunks=chunks.rows.filter((e4=>!("error"in e4))).map((e4=>e4.doc)),nonExistsLocal=chunks.rows.filter((e4=>"error"in e4)).map((e4=>e4.key)),existChunksPurged=(await this.localDatabase.allDocs({keys:nonExistsLocal.map((e4=>`_local/${e4}`)),include_docs:true})).rows.filter((e4=>!("error"in e4))).map((e4=>({...e4.doc,_id:e4.id.substring(7)}))),temp=Object.fromEntries(existChunksPurged.map((e4=>[e4._id,e4.data])));for(const chunk of existChunks){temp[chunk._id]=chunk.data;this.hashCaches.set(chunk._id,chunk.data)}return exists.map((e4=>({id:e4.id,chunk:false!==e4.chunk?e4.chunk:e4.id in temp?temp[e4.id]:false}))).map((e4=>({id:e4.id,chunk:false!==e4.chunk?{_id:e4.id,data:e4.chunk,type:"leaf"}:false})))}else return exists.map((e4=>({id:e4.id,chunk:{_id:e4.id,data:e4.chunk,type:"leaf"}})))}async UXFileInfoToSavingEntry(file){const datatype=determineTypeFromBlob(file.body),fullPath=file.path;return{_id:await this.path2id(fullPath),path:fullPath,data:file.body,mtime:file.stat.mtime,ctime:file.stat.ctime,size:file.stat.size,children:[],datatype,type:datatype,eden:{}}}async getConflictedDoc(path2,rev3){try{const doc=await this.getDBEntry(path2,{rev:rev3},false,false,true);if(false===doc)return false;let data=getDocData(doc.data);if("newnote"==doc.datatype)data=readString(new Uint8Array(decodeBinary(doc.data)));else if("plain"==doc.datatype);return{deleted:doc.deleted||doc._deleted,ctime:doc.ctime,mtime:doc.mtime,rev:rev3,data}}catch(ex){if(isErrorOfMissingDoc(ex))return false}return false}async mergeSensibly(path2,baseRev,currentRev,conflictedRev){var _a5,_b2,_c2,_d2;const baseLeaf=await this.getConflictedDoc(path2,baseRev),leftLeaf=await this.getConflictedDoc(path2,currentRev),rightLeaf=await this.getConflictedDoc(path2,conflictedRev);let autoMerge=false;if(false==baseLeaf||false==leftLeaf||false==rightLeaf)return false;if(leftLeaf.deleted&&rightLeaf.deleted)return false;const dmp=new import_diff_match_patch2.diff_match_patch,mapLeft=dmp.diff_linesToChars_(baseLeaf.data,leftLeaf.data),diffLeftSrc=dmp.diff_main(mapLeft.chars1,mapLeft.chars2,false);dmp.diff_charsToLines_(diffLeftSrc,mapLeft.lineArray);const mapRight=dmp.diff_linesToChars_(baseLeaf.data,rightLeaf.data),diffRightSrc=dmp.diff_main(mapRight.chars1,mapRight.chars2,false);dmp.diff_charsToLines_(diffRightSrc,mapRight.lineArray);function splitDiffPiece(src){const ret=[];do{const d4=src.shift();if(void 0===d4)return ret;const pieces=d4[1].split(/([^\n]*\n)/).filter((f4=>""!=f4));if("undefined"==typeof d4)break;if(d4[0]!=import_diff_match_patch2.DIFF_DELETE)ret.push(...pieces.map((e4=>[d4[0],e4])));if(d4[0]==import_diff_match_patch2.DIFF_DELETE){const nd=src.shift();if("undefined"!=typeof nd){const piecesPair=nd[1].split(/([^\n]*\n)/).filter((f4=>""!=f4));if(nd[0]==import_diff_match_patch2.DIFF_INSERT){for(const pt of pieces){ret.push([d4[0],pt]);const pairP=piecesPair.shift();if("undefined"!=typeof pairP)ret.push([import_diff_match_patch2.DIFF_INSERT,pairP])}ret.push(...piecesPair.map((e4=>[nd[0],e4])))}else{ret.push(...pieces.map((e4=>[d4[0],e4])));ret.push(...piecesPair.map((e4=>[nd[0],e4])))}}else ret.push(...pieces.map((e4=>[0,e4])))}}while(src.length>0);return ret}const diffLeft=splitDiffPiece(diffLeftSrc),diffRight=splitDiffPiece(diffRightSrc);let rightIdx=0,leftIdx=0;const merged=[];autoMerge=true;LOOP_MERGE:do{if(leftIdx>=diffLeft.length&&rightIdx>=diffRight.length)break LOOP_MERGE;const leftItem=null!=(_a5=diffLeft[leftIdx])?_a5:[0,""],rightItem=null!=(_b2=diffRight[rightIdx])?_b2:[0,""];leftIdx++;rightIdx++;if(leftItem[0]!=import_diff_match_patch2.DIFF_EQUAL||rightItem[0]!=import_diff_match_patch2.DIFF_EQUAL||leftItem[1]!=rightItem[1]){if(leftItem[0]==import_diff_match_patch2.DIFF_DELETE&&rightItem[0]==import_diff_match_patch2.DIFF_DELETE&&leftItem[1]==rightItem[1]){const nextLeftIdx=leftIdx,nextRightIdx=rightIdx,[nextLeftItem,nextRightItem]=[null!=(_c2=diffLeft[nextLeftIdx])?_c2:[0,""],null!=(_d2=diffRight[nextRightIdx])?_d2:[0,""]];if(nextLeftItem[0]==import_diff_match_patch2.DIFF_INSERT&&nextRightItem[0]==import_diff_match_patch2.DIFF_INSERT&&nextLeftItem[1]!=nextRightItem[1]){autoMerge=false;break}else{merged.push(leftItem);continue}}if(leftItem[0]==import_diff_match_patch2.DIFF_INSERT&&rightItem[0]==import_diff_match_patch2.DIFF_INSERT)if(leftItem[1]==rightItem[1]){merged.push(leftItem);continue}else if(leftLeaf.mtime<=rightLeaf.mtime){merged.push(leftItem);merged.push(rightItem);continue}else{merged.push(rightItem);merged.push(leftItem);continue}if(leftItem[0]!=import_diff_match_patch2.DIFF_INSERT)if(rightItem[0]!=import_diff_match_patch2.DIFF_INSERT){if(rightItem[1]!=leftItem[1]){Logger(`MERGING PANIC:${leftItem[0]},${leftItem[1]} == ${rightItem[0]},${rightItem[1]}`,LOG_LEVEL_VERBOSE);autoMerge=false;break LOOP_MERGE}if(leftItem[0]==import_diff_match_patch2.DIFF_DELETE)if(rightItem[0]==import_diff_match_patch2.DIFF_EQUAL){merged.push(leftItem);continue}else{autoMerge=false;break LOOP_MERGE}if(rightItem[0]==import_diff_match_patch2.DIFF_DELETE)if(leftItem[0]==import_diff_match_patch2.DIFF_EQUAL){merged.push(rightItem);continue}else{autoMerge=false;break LOOP_MERGE}Logger(`Weird condition:${leftItem[0]},${leftItem[1]} == ${rightItem[0]},${rightItem[1]}`,LOG_LEVEL_VERBOSE);break LOOP_MERGE}else{leftIdx--;merged.push(rightItem)}else{rightIdx--;merged.push(leftItem)}}else merged.push(leftItem)}while(leftIdx<diffLeft.length||rightIdx<diffRight.length);if(autoMerge){Logger("Sensibly merge available",LOG_LEVEL_VERBOSE);return merged}else return false}async mergeObject(path2,baseRev,currentRev,conflictedRev){try{const baseLeaf=await this.getConflictedDoc(path2,baseRev),leftLeaf=await this.getConflictedDoc(path2,currentRev),rightLeaf=await this.getConflictedDoc(path2,conflictedRev);if(false==baseLeaf||false==leftLeaf||false==rightLeaf)return false;if(leftLeaf.deleted&&rightLeaf.deleted)return false;const baseObj={data:tryParseJSON(baseLeaf.data,{})},leftObj={data:tryParseJSON(leftLeaf.data,{})},rightObj={data:tryParseJSON(rightLeaf.data,{})},diffLeft=generatePatchObj(baseObj,leftObj),diffRight=generatePatchObj(baseObj,rightObj),diffSetLeft=new Map(flattenObject(diffLeft)),diffSetRight=new Map(flattenObject(diffRight));for(const[key2,value]of diffSetLeft)if(diffSetRight.has(key2))if(diffSetRight.get(key2)==value)diffSetRight.delete(key2);for(const[key2,value]of diffSetRight)if(diffSetLeft.has(key2)&&diffSetLeft.get(key2)!=value)return false;const patches=[{mtime:leftLeaf.mtime,patch:diffLeft},{mtime:rightLeaf.mtime,patch:diffRight}].sort(((a2,b3)=>a2.mtime-b3.mtime));let newObj={...baseObj};for(const patch of patches)newObj=applyPatch(newObj,patch.patch);return JSON.stringify(newObj.data)}catch(ex){Logger("Could not merge object");Logger(ex,LOG_LEVEL_VERBOSE);return false}}async tryAutoMerge(path2,enableMarkdownAutoMerge){var _a5,_b2;const test=await this.getDBEntry(path2,{conflicts:true,revs_info:true},false,false,true);if(false===test)return{ok:MISSING_OR_ERROR};if(null==test)return{ok:MISSING_OR_ERROR};if(!test._conflicts)return{ok:NOT_CONFLICTED};if(0==test._conflicts.length)return{ok:NOT_CONFLICTED};const conflicts=test._conflicts.sort(((a2,b3)=>Number(a2.split("-")[0])-Number(b3.split("-")[0])));if((isSensibleMargeApplicable(path2)||isObjectMargeApplicable(path2))&&enableMarkdownAutoMerge){const conflictedRev=conflicts[0],conflictedRevNo=Number(conflictedRev.split("-")[0]),commonBase=null!=(_b2=null==(_a5=((await this.getRaw(await this.path2id(path2),{revs_info:true}))._revs_info||[]).filter((e4=>"available"==e4.status&&Number(e4.rev.split("-")[0])<conflictedRevNo)).first())?void 0:_a5.rev)?_b2:"";let p2;if(commonBase){if(isSensibleMargeApplicable(path2)){const result=await this.mergeSensibly(path2,commonBase,test._rev,conflictedRev);if(result){p2=result.filter((e4=>e4[0]!=import_diff_match_patch2.DIFF_DELETE)).map((e4=>e4[1])).join("");Logger(`Sensible merge:${path2}`,LOG_LEVEL_INFO)}else Logger("Sensible merge is not applicable.",LOG_LEVEL_VERBOSE)}else if(isObjectMargeApplicable(path2)){const result=await this.mergeObject(path2,commonBase,test._rev,conflictedRev);if(result){Logger(`Object merge:${path2}`,LOG_LEVEL_INFO);p2=result}else Logger("Object merge is not applicable.",LOG_LEVEL_VERBOSE)}if(void 0!==p2)return{result:p2,conflictedRev}}}const leftLeaf=await this.getConflictedDoc(path2,test._rev),rightLeaf=await this.getConflictedDoc(path2,conflicts[0]);return{leftRev:test._rev,rightRev:conflicts[0],leftLeaf,rightLeaf}}},LiveSyncAbstractReplicator=class{constructor(env){this.syncStatus="NOT_CONNECTED";this.docArrived=0;this.docSent=0;this.lastSyncPullSeq=0;this.maxPullSeq=0;this.lastSyncPushSeq=0;this.maxPushSeq=0;this.nodeid="";this.remoteLocked=false;this.remoteCleaned=false;this.remoteLockedAndDeviceNotAccepted=false;this.tweakSettingsMismatched=false;this.updateInfo=()=>{this.env.replicationStat.value={sent:this.docSent,arrived:this.docArrived,maxPullSeq:this.maxPullSeq,maxPushSeq:this.maxPushSeq,lastSyncPullSeq:this.lastSyncPullSeq,lastSyncPushSeq:this.lastSyncPushSeq,syncStatus:this.syncStatus}};this.env=env}async initializeDatabaseForReplication(){const db=this.env.getDatabase();try{const nodeinfo=await resolveWithIgnoreKnownError(db.get(NODEINFO_DOCID),{_id:NODEINFO_DOCID,type:"nodeinfo",nodeid:"",v20220607:true});if(""==nodeinfo.nodeid){nodeinfo.nodeid=Math.random().toString(36).slice(-10);await db.put(nodeinfo)}this.nodeid=nodeinfo.nodeid;return true}catch(ex){Logger(ex)}return false}},instanceOfAny=(object,constructors)=>constructors.some((c2=>object instanceof c2));function getIdbProxyableTypes(){return idbProxyableTypes||(idbProxyableTypes=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function getCursorAdvanceMethods(){return cursorAdvanceMethods||(cursorAdvanceMethods=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var transactionDoneMap=new WeakMap,transformCache=new WeakMap,reverseTransformCache=new WeakMap;function promisifyRequest(request2){const promise2=new Promise(((resolve,reject)=>{const unlisten=()=>{request2.removeEventListener("success",success);request2.removeEventListener("error",error)},success=()=>{resolve(wrap(request2.result));unlisten()},error=()=>{reject(request2.error);unlisten()};request2.addEventListener("success",success);request2.addEventListener("error",error)}));reverseTransformCache.set(promise2,request2);return promise2}function cacheDonePromiseForTransaction(tx){if(transactionDoneMap.has(tx))return;const done=new Promise(((resolve,reject)=>{const unlisten=()=>{tx.removeEventListener("complete",complete);tx.removeEventListener("error",error);tx.removeEventListener("abort",error)},complete=()=>{resolve();unlisten()},error=()=>{reject(tx.error||new DOMException("AbortError","AbortError"));unlisten()};tx.addEventListener("complete",complete);tx.addEventListener("error",error);tx.addEventListener("abort",error)}));transactionDoneMap.set(tx,done)}var idbProxyTraps={get(target,prop,receiver){if(target instanceof IDBTransaction){if("done"===prop)return transactionDoneMap.get(target);if("store"===prop)return receiver.objectStoreNames[1]?void 0:receiver.objectStore(receiver.objectStoreNames[0])}return wrap(target[prop])},set(target,prop,value){target[prop]=value;return true},has(target,prop){if(target instanceof IDBTransaction&&("done"===prop||"store"===prop))return true;else return prop in target}};function replaceTraps(callback){idbProxyTraps=callback(idbProxyTraps)}function wrapFunction(func){if(getCursorAdvanceMethods().includes(func))return function(...args){func.apply(unwrap(this),args);return wrap(this.request)};else return function(...args){return wrap(func.apply(unwrap(this),args))}}function transformCachableValue(value){if("function"==typeof value)return wrapFunction(value);if(value instanceof IDBTransaction)cacheDonePromiseForTransaction(value);if(instanceOfAny(value,getIdbProxyableTypes()))return new Proxy(value,idbProxyTraps);else return value}function wrap(value){if(value instanceof IDBRequest)return promisifyRequest(value);if(transformCache.has(value))return transformCache.get(value);const newValue=transformCachableValue(value);if(newValue!==value){transformCache.set(value,newValue);reverseTransformCache.set(newValue,value)}return newValue}var unwrap=value=>reverseTransformCache.get(value);function openDB(name,version2,{blocked,upgrade,blocking,terminated}={}){const request2=indexedDB.open(name,version2),openPromise=wrap(request2);if(upgrade)request2.addEventListener("upgradeneeded",(event=>{upgrade(wrap(request2.result),event.oldVersion,event.newVersion,wrap(request2.transaction),event)}));if(blocked)request2.addEventListener("blocked",(event=>blocked(event.oldVersion,event.newVersion,event)));openPromise.then((db=>{if(terminated)db.addEventListener("close",(()=>terminated()));if(blocking)db.addEventListener("versionchange",(event=>blocking(event.oldVersion,event.newVersion,event)))})).catch((()=>{}));return openPromise}function deleteDB(name,{blocked}={}){const request2=indexedDB.deleteDatabase(name);if(blocked)request2.addEventListener("blocked",(event=>blocked(event.oldVersion,event)));return wrap(request2).then((()=>{}))}var readMethods=["get","getKey","getAll","getAllKeys","count"],writeMethods=["put","add","delete","clear"],cachedMethods=new Map;function getMethod(target,prop){if(!(target instanceof IDBDatabase&&!(prop in target)&&"string"==typeof prop))return;if(cachedMethods.get(prop))return cachedMethods.get(prop);const targetFuncName=prop.replace(/FromIndex$/,""),useIndex=prop!==targetFuncName,isWrite=writeMethods.includes(targetFuncName);if(!(targetFuncName in(useIndex?IDBIndex:IDBObjectStore).prototype)||!(isWrite||readMethods.includes(targetFuncName)))return;const method=async function(storeName,...args){const tx=this.transaction(storeName,isWrite?"readwrite":"readonly");let target2=tx.store;if(useIndex)target2=target2.index(args.shift());return(await Promise.all([target2[targetFuncName](...args),isWrite&&tx.done]))[0]};cachedMethods.set(prop,method);return method}replaceTraps((oldTraps=>({...oldTraps,get:(target,prop,receiver)=>getMethod(target,prop)||oldTraps.get(target,prop,receiver),has:(target,prop)=>!!getMethod(target,prop)||oldTraps.has(target,prop)})));var advanceMethodProps=["continue","continuePrimaryKey","advance"],methodMap={},advanceResults=new WeakMap,ittrProxiedCursorToOriginalProxy=new WeakMap,cursorIteratorTraps={get(target,prop){if(!advanceMethodProps.includes(prop))return target[prop];let cachedFunc=methodMap[prop];if(!cachedFunc)cachedFunc=methodMap[prop]=function(...args){advanceResults.set(this,ittrProxiedCursorToOriginalProxy.get(this)[prop](...args))};return cachedFunc}};async function*iterate(...args){let cursor=this;if(!(cursor instanceof IDBCursor))cursor=await cursor.openCursor(...args);if(!cursor)return;const proxiedCursor=new Proxy(cursor,cursorIteratorTraps);ittrProxiedCursorToOriginalProxy.set(proxiedCursor,cursor);reverseTransformCache.set(proxiedCursor,unwrap(cursor));for(;cursor;){yield proxiedCursor;cursor=await(advanceResults.get(proxiedCursor)||cursor.continue());advanceResults.delete(proxiedCursor)}}function isIteratorProp(target,prop){return prop===Symbol.asyncIterator&&instanceOfAny(target,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===prop&&instanceOfAny(target,[IDBIndex,IDBObjectStore])}replaceTraps((oldTraps=>({...oldTraps,get(target,prop,receiver){if(isIteratorProp(target,prop))return iterate;else return oldTraps.get(target,prop,receiver)},has:(target,prop)=>isIteratorProp(target,prop)||oldTraps.has(target,prop)})));var databaseCache={},OpenKeyValueDatabase=async dbKey=>{if(dbKey in databaseCache){databaseCache[dbKey].close();delete databaseCache[dbKey]}const storeKey=dbKey,dbPromise=openDB(dbKey,1,{upgrade(db2){db2.createObjectStore(storeKey)}}),db=await dbPromise;databaseCache[dbKey]=db;return{get:async key2=>await db.get(storeKey,key2),set:async(key2,value)=>await db.put(storeKey,value,key2),del:async key2=>await db.delete(storeKey,key2),clear:async()=>await db.clear(storeKey),keys:async(query3,count)=>await db.getAllKeys(storeKey,query3,count),close(){delete databaseCache[dbKey];return db.close()},async destroy(){delete databaseCache[dbKey];db.close();await deleteDB(dbKey)}}};function unwrapTaskResult(result){if("ok"in result)return result.ok;if("err"in result)return result.err;throw new Error("Argument Exception: Could not unwrap")}function isTaskWaiting(task){if(task instanceof Promise)return false;if(task instanceof Function)return true;throw new Error("Invalid state")}async function wrapEachProcess(key2,task){try{return{key:key2,ok:await task}}catch(ex){return{key:key2,err:ex instanceof Error?ex:new Error(`${ex}`)}}}async function*processAllGeneratorTasksWithConcurrencyLimit(limit,tasks4){const nowProcessing=new Map;let idx2=0,generatorDone=false;for(;nowProcessing.size>0||!generatorDone;){L2:for(;nowProcessing.size<limit&&!generatorDone;){const w2=await tasks4.next();if(w2.done)generatorDone=true;if(void 0===w2.value)break L2;const task=w2.value;idx2++;const wrappedPromise=wrapEachProcess(idx2,isTaskWaiting(task)?task():task);nowProcessing.set(idx2,wrappedPromise)}const done=await Promise.race(nowProcessing.values());nowProcessing.delete(done.key);yield done}}async function*pipeGeneratorToGenerator(generator,callback){for await(const e4 of generator){const closure=()=>callback(e4);yield closure}}async function*pipeArrayToGenerator(array,callback){for(const e4 of array){const closure=()=>callback(e4);yield closure}}async function*processAllTasksWithConcurrencyLimit(limit,tasks4){const nowProcessing=new Map;let idx2=0;const pendingTasks=tasks4.reverse();for(;pendingTasks.length>0||nowProcessing.size>0;){L2:for(;nowProcessing.size<limit&&pendingTasks.length>0;){const task=pendingTasks.pop();if(void 0===task)break L2;idx2++;const wrappedPromise=wrapEachProcess(idx2,isTaskWaiting(task)?task():task);nowProcessing.set(idx2,wrappedPromise)}const done=await Promise.race(nowProcessing.values());nowProcessing.delete(done.key);yield done}}async function mapAllTasksWithConcurrencyLimit(limit,tasks4){const results=new Map;for await(const v2 of processAllTasksWithConcurrencyLimit(limit,tasks4))results.set(v2.key,v2);return[...results.entries()].sort(((a2,b3)=>a2[0]-b3[0])).map((e4=>e4[1]))}var tasks2={};function scheduleTask(key2,timeout,proc,skipIfTaskExist){if(!skipIfTaskExist||!(key2 in tasks2)){cancelTask(key2);tasks2[key2]=setTimeout((async()=>{delete tasks2[key2];await proc()}),timeout)}}function cancelTask(key2){if(key2 in tasks2){clearTimeout(tasks2[key2]);delete tasks2[key2]}}function cancelAllTasks(){for(const v2 in tasks2){clearTimeout(tasks2[v2]);delete tasks2[v2]}}var intervals={};function setPeriodicTask(key2,timeout,proc){cancelPeriodicTask(key2);intervals[key2]=setInterval((async()=>{delete intervals[key2];await proc()}),timeout)}function cancelPeriodicTask(key2){if(key2 in intervals){clearInterval(intervals[key2]);delete intervals[key2]}}function cancelAllPeriodicTask(){for(const v2 in intervals){clearInterval(intervals[v2]);delete intervals[v2]}}var waitingItems=new Map;function waitForTimeout(key2,timeout){if(waitingItems.has(key2))return waitingItems.get(key2).timeoutPromise.promise;const timeoutPromise=promiseWithResolver(),timer=setTimeout((()=>{finishWaitingForTimeout(key2,true)}),timeout);waitingItems.set(key2,{waitFrom:Date.now(),timeout,timeoutPromise,timer});return timeoutPromise.promise}function finishWaitingForTimeout(key2,hasTimeout=false){const x2=waitingItems.get(key2);if(x2){if(x2.timer)clearTimeout(x2.timer);x2.timeoutPromise.resolve(hasTimeout);waitingItems.delete(key2);return true}return false}function finishAllWaitingForTimeout(prefix,hasTimeout){for(const[key2,_]of waitingItems)if(key2.startsWith(prefix))finishWaitingForTimeout(key2,hasTimeout)}function isWaitingForTimeout(key2){return waitingItems.has(key2)}var sameChangePairs,YieldOperationNumbers=100,PersistentMap=class{flush(){this._save()}_save(){localStorage.setItem(this._key,JSON.stringify([...this._map.entries()]))}_load(suppliedEntries=[]){var _a5;try{const savedSource=null!=(_a5=localStorage.getItem(this._key))?_a5:"",sourceToParse=""===savedSource?"[]":savedSource,obj=JSON.parse(sourceToParse);this._map=new Map([...obj,...suppliedEntries])}catch(ex){console.log(`Map read error : ${this._key}`);console.dir(ex);this._map=new Map([...suppliedEntries])}return Promise.resolve()}_queueSave(){this._setCount--;if(this._setCount<0){this._setCount=YieldOperationNumbers;scheduleTask(`save-map-${this._key}`,0,(()=>this._save()))}scheduleTask(`save-map-${this._key}`,150,(()=>this._save()))}delete(key2){const ret=this._map.delete(key2);this._queueSave();return ret}has(key2){return this._map.has(key2)}set(key2,value){this._map.set(key2,value);this._queueSave();return this}clear(){this._map=new Map;this._save()}get(key2,defValue){const v2=this._map.get(key2);if(void 0===v2)return defValue;else return v2}constructor(key2,entries){Object.defineProperty(this,"_setCount",{enumerable:true,configurable:true,writable:true,value:YieldOperationNumbers});Object.defineProperty(this,"_map",{enumerable:true,configurable:true,writable:true,value:void 0});Object.defineProperty(this,"_key",{enumerable:true,configurable:true,writable:true,value:void 0});this._key=key2;this._map=new Map(null!=entries?entries:[]);this._load(entries)}};function initializeStores(vaultName){sameChangePairs=new PersistentMap(`ls-persist-same-changes-${vaultName}`)}async function path2id(filename,obfuscatePassphrase,caseInsensitive){const temp=filename.split(":"),path2=temp.pop(),normalizedPath=normalizePath(path2);temp.push(normalizedPath);const fixedPath=temp.join(":");return await path2id_base(fixedPath,obfuscatePassphrase,caseInsensitive)}function id2path(id,entry){const temp=id2path_base(id,entry).split(":"),path2=temp.pop(),normalizedPath=normalizePath(path2);temp.push(normalizedPath);return temp.join(":")}function getPath2(entry){return id2path(entry._id,entry)}function getPathWithoutPrefix2(entry){return stripAllPrefixes(getPath2(entry))}function getPathFromTFile(file){return file.path}function isInternalFile(file){if("string"==typeof file)return file.startsWith(ICHeader);if(file.isInternal)return true;else return false}function getPathFromUXFileInfo(file){if("string"==typeof file)return file;else return file.path}function getStoragePathFromUXFileInfo(file){if("string"==typeof file)return stripAllPrefixes(file);else return stripAllPrefixes(file.path)}function getDatabasePathFromUXFileInfo(file){const prefix=isInternalFile(file)?ICHeader:"";if("string"==typeof file)return prefix+stripAllPrefixes(file);else return prefix+stripAllPrefixes(file.path)}var memos={};function memoObject(key2,obj){memos[key2]=obj;return memos[key2]}async function memoIfNotExist(key2,func){if(!(key2 in memos)){const w2=func(),v2=w2 instanceof Promise?await w2:w2;memos[key2]=v2}return memos[key2]}function retrieveMemoObject(key2){if(key2 in memos)return memos[key2];else return false}function disposeMemoObject(key2){delete memos[key2]}function isValidPath(filename){if(import_obsidian.Platform.isDesktop){if("darwin"==process.platform)return isValidFilenameInDarwin(filename);if("linux"==process.platform)return isValidFilenameInLinux(filename);else return isValidFilenameInWidows(filename)}if(import_obsidian.Platform.isAndroidApp)return isValidFilenameInAndroid(filename);if(import_obsidian.Platform.isIosApp)return isValidFilenameInDarwin(filename);Logger("Could not determine platform for checking filename",LOG_LEVEL_VERBOSE);return isValidFilenameInWidows(filename)}function trimPrefix(target,prefix){return target.startsWith(prefix)?target.substring(prefix.length):target}function isInternalMetadata(id){return id.startsWith(ICHeader)}function stripInternalMetadataPrefix(id){return id.substring(ICHeaderLength)}function id2InternalMetadataId(id){return ICHeader+id}function isChunk(str){return str.startsWith(CHeader)}function isPluginMetadata(str){return str.startsWith(PSCHeader)}function isCustomisationSyncMetadata(str){return str.startsWith(ICXHeader)}var PeriodicProcessor=class{constructor(plugin3,process2){this._timer=void 0;this._plugin=plugin3;this._process=process2;eventHub.onceEvent(EVENT_PLUGIN_UNLOADED,(()=>{this.disable()}))}async process(){try{await this._process()}catch(ex){Logger(ex)}}enable(interval){this.disable();if(0!=interval){this._timer=window.setInterval((()=>fireAndForget((async()=>{await this.process();if(this._plugin.$$isUnloaded())this.disable()}))),interval);this._plugin.registerInterval(this._timer)}}disable(){if(void 0!==this._timer){window.clearInterval(this._timer);this._timer=void 0}}},_requestToCouchDBFetch2=async(baseUri,username,password,path2,body,method)=>{const utf8str=String.fromCharCode.apply(null,[...writeString(`${username}:${password}`)]),encoded=window.btoa(utf8str),uri=`${baseUri}/${path2}`,requestParam={url:uri,method:method||(body?"PUT":"GET"),headers:new Headers({authorization:"Basic "+encoded,"content-type":"application/json"}),contentType:"application/json",body:JSON.stringify(body)};return await fetch(uri,requestParam)},_requestToCouchDB=async(baseUri,username,password,origin2,path2,body,method)=>{const utf8str=String.fromCharCode.apply(null,[...writeString(`${username}:${password}`)]),requestParam={url:`${baseUri}/${path2}`,method:method||(body?"PUT":"GET"),headers:{authorization:"Basic "+window.btoa(utf8str),origin:origin2},contentType:"application/json",body:body?JSON.stringify(body):void 0};return await(0,import_obsidian.requestUrl)(requestParam)},requestToCouchDB=async(baseUri,username,password,origin2="",key2,body,method)=>{const uri="_node/_local/_config"+(key2?"/"+key2:"");return await _requestToCouchDB(baseUri,username,password,origin2,uri,body,method)},BASE_IS_NEW=Symbol("base"),TARGET_IS_NEW=Symbol("target"),EVEN=Symbol("even"),resolution=2e3;function compareMTime(baseMTime,targetMTime){const truncatedBaseMTime=~~(baseMTime/resolution)*resolution,truncatedTargetMTime=~~(targetMTime/resolution)*resolution;if(truncatedBaseMTime==truncatedTargetMTime)return EVEN;if(truncatedBaseMTime>truncatedTargetMTime)return BASE_IS_NEW;if(truncatedBaseMTime<truncatedTargetMTime)return TARGET_IS_NEW;throw new Error("Unexpected error")}function getKey(file){return"string"==typeof file?file:stripAllPrefixes(file.path)}function markChangesAreSame(file,mtime1,mtime2){if(mtime1===mtime2)return true;const key2=getKey(file),pairs=sameChangePairs.get(key2,[])||[];if(pairs.some((e4=>e4==mtime1||e4==mtime2)))sameChangePairs.set(key2,[...new Set([...pairs,mtime1,mtime2])]);else sameChangePairs.set(key2,[mtime1,mtime2])}function unmarkChanges(file){const key2=getKey(file);sameChangePairs.delete(key2)}function isMarkedAsSameChanges(file,mtimes){const key2=getKey(file),pairs=sameChangePairs.get(key2,[])||[];if(mtimes.every((e4=>-1!==pairs.indexOf(e4))))return EVEN}function compareFileFreshness(baseFile,checkTarget){var _a5,_b2,_c2,_d2,_e2,_f;if(void 0===baseFile&&null==checkTarget)return EVEN;if(null==baseFile)return TARGET_IS_NEW;if(null==checkTarget)return BASE_IS_NEW;const modifiedBase="stat"in baseFile?null!=(_b2=null==(_a5=null==baseFile?void 0:baseFile.stat)?void 0:_a5.mtime)?_b2:0:null!=(_c2=null==baseFile?void 0:baseFile.mtime)?_c2:0,modifiedTarget="stat"in checkTarget?null!=(_e2=null==(_d2=null==checkTarget?void 0:checkTarget.stat)?void 0:_d2.mtime)?_e2:0:null!=(_f=null==checkTarget?void 0:checkTarget.mtime)?_f:0;if(modifiedBase&&modifiedTarget&&isMarkedAsSameChanges(baseFile,[modifiedBase,modifiedTarget]))return EVEN;else return compareMTime(modifiedBase,modifiedTarget)}var _cached=new Map;function useMemo({key:key2,forceUpdate,validator},updateFunc){const cached=_cached.get(key2),context2=(null==cached?void 0:cached.context)||new Map;if(cached&&!forceUpdate&&(!validator||validator&&!validator(context2)))return cached.value;const value=updateFunc(context2,null==cached?void 0:cached.value);if(value!==(null==cached?void 0:cached.value))_cached.set(key2,{value,context:context2});return value}var _staticObj=new Map;function useStatic(key2,initial){const obj=_staticObj.get(key2);if(void 0!==obj)return obj;else{const obj2={_buf:initial,get value(){return this._buf},set value(value){this._buf=value}};_staticObj.set(key2,obj2);return obj2}}function disposeMemo(key2){_cached.delete(key2)}function disposeAllMemo(){_cached.clear()}function displayRev(rev3){const[number,hash2]=rev3.split("-");return`${number}-${hash2.substring(0,6)}`}function getDocProps(doc){const id=doc._id,shortenedId=id.substring(0,10),prefixedPath=getPath2(doc),path2=stripAllPrefixes(prefixedPath),rev3=doc._rev,revDisplay=rev3?displayRev(rev3):"0-NOREVS",shortenedPath=path2.substring(0,10);return{id,rev:rev3,revDisplay,prefixedPath,path:path2,isDeleted:doc._deleted||doc.deleted||false,shortenedId,shortenedPath}}function getLogLevel(showNotice){return showNotice?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO}async function autosaveCache(db,mapKey){var _a5;const savedData=null!=(_a5=await db.get(mapKey))?_a5:new Map,_commit=()=>{try{scheduleTask("commit-map-save-"+mapKey,250,(async()=>{await db.set(mapKey,savedData)}))}catch(e4){}};return{set(key2,value){const modified=savedData.get(key2)!==value,result=savedData.set(key2,value);if(modified)_commit();return result},clear(){savedData.clear();_commit()},delete(key2){const result=savedData.delete(key2);if(result)_commit();return result},get:key2=>savedData.get(key2),has:key2=>savedData.has(key2),keys:()=>savedData.keys(),get size(){return savedData.size}}}function onlyInNTimes(n3,proc){let counter=0;return function(){if(counter++%n3==0)proc(counter)}}function isOverridableKey(key2){return key2.startsWith("$")}function isInjectableKey(key2){return key2.startsWith("$$")}function isAllExecuteKey(key2){return key2.startsWith("$all")}function isEveryExecuteKey(key2){return key2.startsWith("$every")}function isAnyExecuteKey(key2){return key2.startsWith("$any")}function injectModules(target,modules){const allKeys=unique([...Object.keys(Object.getOwnPropertyDescriptors(target)),...Object.keys(Object.getOwnPropertyDescriptors(Object.getPrototypeOf(target)))]).filter((e4=>e4.startsWith("$"))),moduleMap=new Map;for(const module2 of modules)for(const key2 of allKeys)if(isOverridableKey(key2))if(key2 in module2){const list=moduleMap.get(key2)||[];if("function"==typeof module2[key2])module2[key2]=module2[key2].bind(module2);list.push(module2);moduleMap.set(key2,list)}Logger(`Injecting modules for ${target.constructor.name}`,LOG_LEVEL_VERBOSE);for(const key2 of allKeys){const modules2=moduleMap.get(key2)||[];if(isInjectableKey(key2)){if(0==modules2.length)throw new Error(`No module injected for ${key2}. This is a fatal error.`);target[key2]=modules2[0][key2];Logger(`[${modules2[0].constructor.name}]: Injected ${key2} `,LOG_LEVEL_VERBOSE)}else if(isAllExecuteKey(key2)){const modules3=moduleMap.get(key2)||[];target[key2]=async(...args)=>{for(const module2 of modules3)try{await module2[key2](...args)}catch(ex){Logger(`[${module2.constructor.name}]: All handler for ${key2} failed`,LOG_LEVEL_VERBOSE);Logger(ex,LOG_LEVEL_VERBOSE)}return true};for(const module2 of modules3)Logger(`[${module2.constructor.name}]: Injected (All) ${key2} `,LOG_LEVEL_VERBOSE)}else if(isEveryExecuteKey(key2)){target[key2]=async(...args)=>{for(const module2 of modules2)try{const ret=await module2[key2](...args);if(void 0!==ret&&!ret)return ret}catch(ex){Logger(`[${module2.constructor.name}]: Every handler for ${key2} failed`);Logger(ex,LOG_LEVEL_VERBOSE)}return true};for(const module2 of modules2)Logger(`[${module2.constructor.name}]: Injected (Every) ${key2} `,LOG_LEVEL_VERBOSE)}else if(isAnyExecuteKey(key2)){target[key2]=async(...args)=>{for(const module2 of modules2)try{const ret=await module2[key2](...args);if(ret)return ret}catch(ex){Logger(`[${module2.constructor.name}]: Any handler for ${key2} failed`);Logger(ex,LOG_LEVEL_VERBOSE)}return false};for(const module2 of modules2)Logger(`[${module2.constructor.name}]: Injected (Any) ${key2} `,LOG_LEVEL_VERBOSE)}else Logger(`No injected handler for ${key2} `,LOG_LEVEL_VERBOSE)}Logger(`Injected   modules for ${target.constructor.name}`,LOG_LEVEL_VERBOSE);return true}var AbstractModule=class{constructor(core){this.core=core;this._log=(msg,level=LOG_LEVEL_INFO,key2)=>{if("string"==typeof msg&&level!==LOG_LEVEL_NOTICE)msg=`[${this.constructor.name}] ${msg}`;Logger(msg,level,key2)};this.saveSettings=this.core.saveSettings.bind(this.core);Logger(`[${this.constructor.name}] Loaded`,LOG_LEVEL_VERBOSE)}get localDatabase(){return this.core.localDatabase}get settings(){return this.core.settings}set settings(value){this.core.settings=value}addTestResult(key2,value,summary,message){this.core.$$addTestResult(`${this.constructor.name}`,key2,value,summary,message)}testDone(result=true){return Promise.resolve(result)}testFail(message){this._log(message,LOG_LEVEL_NOTICE);return this.testDone(false)}async _test(key2,process2){this._log(`Testing ${key2}`,LOG_LEVEL_VERBOSE);try{const ret=await process2();if(true!==ret){this.addTestResult(key2,false,ret.toString());return this.testFail(`${key2} failed: ${ret}`)}this.addTestResult(key2,true,"")}catch(ex){this.addTestResult(key2,false,"Failed by Exception",ex.toString());return this.testFail(`${key2} failed: ${ex}`)}return this.testDone()}},AbstractObsidianModule=class extends AbstractModule{constructor(plugin3,core){super(core);this.plugin=plugin3;this.core=core;this.addCommand=this.plugin.addCommand.bind(this.plugin);this.registerView=this.plugin.registerView.bind(this.plugin);this.addRibbonIcon=this.plugin.addRibbonIcon.bind(this.plugin);this.registerObsidianProtocolHandler=this.plugin.registerObsidianProtocolHandler.bind(this.plugin);this.saveSettings=this.plugin.saveSettings.bind(this.plugin)}get localDatabase(){return this.plugin.localDatabase}get settings(){return this.plugin.settings}set settings(value){this.plugin.settings=value}get app(){return this.plugin.app}_isMainReady(){return this.core.$$isReady()}_isMainSuspended(){return this.core.$$isSuspended()}_isDatabaseReady(){return this.core.$$isDatabaseReady()}_isThisModuleEnabled(){return true}};function noop2(){}var src_url_equal_anchor,identity=x2=>x2;function assign(tar,src){for(const k2 in src)tar[k2]=src[k2];return tar}function is_promise(value){return!!value&&("object"==typeof value||"function"==typeof value)&&"function"==typeof value.then}function add_location(element2,file,line,column,char){element2.__svelte_meta={loc:{file,line,column,char}}}function run(fn){return fn()}function blank_object(){return Object.create(null)}function run_all(fns){fns.forEach(run)}function is_function(thing){return"function"==typeof thing}function safe_not_equal(a2,b3){return a2!=a2?b3==b3:a2!==b3||a2&&"object"==typeof a2||"function"==typeof a2}function src_url_equal(element_src,url){if(element_src===url)return true;if(!src_url_equal_anchor)src_url_equal_anchor=document.createElement("a");src_url_equal_anchor.href=url;return element_src===src_url_equal_anchor.href}function split_srcset(srcset){return srcset.split(",").map((src=>src.trim().split(" ").filter(Boolean)))}function srcset_url_equal(element_srcset,srcset){const element_urls=split_srcset(element_srcset.srcset),urls=split_srcset(srcset||"");return urls.length===element_urls.length&&urls.every((([url,width],i2)=>width===element_urls[i2][1]&&(src_url_equal(element_urls[i2][0],url)||src_url_equal(url,element_urls[i2][0]))))}function not_equal(a2,b3){return a2!=a2?b3==b3:a2!==b3}function is_empty(obj){return 0===Object.keys(obj).length}function validate_store(store,name){if(null!=store&&"function"!=typeof store.subscribe)throw new Error(`'${name}' is not a store with a 'subscribe' method`)}function subscribe(store,...callbacks){if(null==store){for(const callback of callbacks)callback(void 0);return noop2}const unsub=store.subscribe(...callbacks);return unsub.unsubscribe?()=>unsub.unsubscribe():unsub}function get_store_value(store){let value;subscribe(store,(_=>value=_))();return value}function component_subscribe(component,store,callback){component.$$.on_destroy.push(subscribe(store,callback))}function create_slot(definition,ctx,$$scope,fn){if(definition){const slot_ctx=get_slot_context(definition,ctx,$$scope,fn);return definition[0](slot_ctx)}}function get_slot_context(definition,ctx,$$scope,fn){return definition[1]&&fn?assign($$scope.ctx.slice(),definition[1](fn(ctx))):$$scope.ctx}function get_slot_changes(definition,$$scope,dirty,fn){if(definition[2]&&fn){const lets=definition[2](fn(dirty));if(void 0===$$scope.dirty)return lets;if("object"==typeof lets){const merged=[],len=Math.max($$scope.dirty.length,lets.length);for(let i2=0;i2<len;i2+=1)merged[i2]=$$scope.dirty[i2]|lets[i2];return merged}return $$scope.dirty|lets}return $$scope.dirty}function update_slot_base(slot,slot_definition,ctx,$$scope,slot_changes,get_slot_context_fn){if(slot_changes){const slot_context=get_slot_context(slot_definition,ctx,$$scope,get_slot_context_fn);slot.p(slot_context,slot_changes)}}function update_slot(slot,slot_definition,ctx,$$scope,dirty,get_slot_changes_fn,get_slot_context_fn){update_slot_base(slot,slot_definition,ctx,$$scope,get_slot_changes(slot_definition,$$scope,dirty,get_slot_changes_fn),get_slot_context_fn)}function get_all_dirty_from_scope($$scope){if($$scope.ctx.length>32){const dirty=[],length=$$scope.ctx.length/32;for(let i2=0;i2<length;i2++)dirty[i2]=-1;return dirty}return-1}function exclude_internal_props(props){const result={};for(const k2 in props)if("$"!==k2[0])result[k2]=props[k2];return result}function compute_rest_props(props,keys2){const rest={};keys2=new Set(keys2);for(const k2 in props)if(!keys2.has(k2)&&"$"!==k2[0])rest[k2]=props[k2];return rest}function compute_slots(slots){const result={};for(const key2 in slots)result[key2]=true;return result}function once(fn){let ran=false;return function(...args){if(!ran){ran=true;fn.call(this,...args)}}}function null_to_empty(value){return null==value?"":value}function set_store_value(store,ret,value){store.set(value);return ret}var has_prop=(obj,prop)=>Object.prototype.hasOwnProperty.call(obj,prop);function action_destroyer(action_result){return action_result&&is_function(action_result.destroy)?action_result.destroy:noop2}function split_css_unit(value){const split="string"==typeof value&&value.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return split?[parseFloat(split[1]),split[2]||"px"]:[value,"px"]}var contenteditable_truthy_values=["",true,1,"true","contenteditable"],is_client="undefined"!=typeof window,now=is_client?()=>window.performance.now():()=>Date.now(),raf=is_client?cb2=>requestAnimationFrame(cb2):noop2;function set_now(fn){now=fn}function set_raf(fn){raf=fn}var tasks3=new Set;function run_tasks(now2){tasks3.forEach((task=>{if(!task.c(now2)){tasks3.delete(task);task.f()}}));if(0!==tasks3.size)raf(run_tasks)}function clear_loops(){tasks3.clear()}function loop(callback){let task;if(0===tasks3.size)raf(run_tasks);return{promise:new Promise((fulfill=>{tasks3.add(task={c:callback,f:fulfill})})),abort(){tasks3.delete(task)}}}var globals="undefined"!=typeof window?window:"undefined"!=typeof globalThis?globalThis:window,ResizeObserverSingleton=class _ResizeObserverSingleton{constructor(options){__publicField(this,"_listeners","WeakMap"in globals?new WeakMap:void 0);__publicField(this,"_observer");__publicField(this,"options");this.options=options}observe(element2,listener){this._listeners.set(element2,listener);this._getObserver().observe(element2,this.options);return()=>{this._listeners.delete(element2);this._observer.unobserve(element2)}}_getObserver(){var _a5;return null!=(_a5=this._observer)?_a5:this._observer=new ResizeObserver((entries=>{var _a6;for(const entry of entries){_ResizeObserverSingleton.entries.set(entry.target,entry);null==(_a6=this._listeners.get(entry.target))||_a6(entry)}}))}};ResizeObserverSingleton.entries="WeakMap"in globals?new WeakMap:void 0;var is_hydrating=false;function start_hydrating(){is_hydrating=true}function end_hydrating(){is_hydrating=false}function upper_bound(low,high,key2,value){for(;low<high;){const mid=low+(high-low>>1);if(key2(mid)<=value)low=mid+1;else high=mid}return low}function init_hydrate(target){if(target.hydrate_init)return;target.hydrate_init=true;let children2=target.childNodes;if("HEAD"===target.nodeName){const my_children=[];for(let i2=0;i2<children2.length;i2++){const node=children2[i2];if(void 0!==node.claim_order)my_children.push(node)}children2=my_children}const m2=new Int32Array(children2.length+1),p2=new Int32Array(children2.length);m2[0]=-1;let longest=0;for(let i2=0;i2<children2.length;i2++){const current=children2[i2].claim_order,seq_len=(longest>0&&children2[m2[longest]].claim_order<=current?longest+1:upper_bound(1,longest,(idx2=>children2[m2[idx2]].claim_order),current))-1;p2[i2]=m2[seq_len]+1;const new_len=seq_len+1;m2[new_len]=i2;longest=Math.max(new_len,longest)}const lis=[],to_move=[];let last=children2.length-1;for(let cur=m2[longest]+1;0!=cur;cur=p2[cur-1]){lis.push(children2[cur-1]);for(;last>=cur;last--)to_move.push(children2[last]);last--}for(;last>=0;last--)to_move.push(children2[last]);lis.reverse();to_move.sort(((a2,b3)=>a2.claim_order-b3.claim_order));for(let i2=0,j2=0;i2<to_move.length;i2++){for(;j2<lis.length&&to_move[i2].claim_order>=lis[j2].claim_order;)j2++;const anchor=j2<lis.length?lis[j2]:null;target.insertBefore(to_move[i2],anchor)}}function append(target,node){target.appendChild(node)}function append_styles(target,style_sheet_id,styles){const append_styles_to=get_root_for_style(target);if(!append_styles_to.getElementById(style_sheet_id)){const style=element("style");style.id=style_sheet_id;style.textContent=styles;append_stylesheet(append_styles_to,style)}}function get_root_for_style(node){if(!node)return document;const root=node.getRootNode?node.getRootNode():node.ownerDocument;if(root&&root.host)return root;else return node.ownerDocument}function append_empty_stylesheet(node){const style_element=element("style");style_element.textContent="/* empty */";append_stylesheet(get_root_for_style(node),style_element);return style_element.sheet}function append_stylesheet(node,style){append(node.head||node,style);return style.sheet}function append_hydration(target,node){if(is_hydrating){init_hydrate(target);if(void 0===target.actual_end_child||null!==target.actual_end_child&&target.actual_end_child.parentNode!==target)target.actual_end_child=target.firstChild;for(;null!==target.actual_end_child&&void 0===target.actual_end_child.claim_order;)target.actual_end_child=target.actual_end_child.nextSibling;if(node!==target.actual_end_child){if(void 0!==node.claim_order||node.parentNode!==target)target.insertBefore(node,target.actual_end_child)}else target.actual_end_child=node.nextSibling}else if(node.parentNode!==target||null!==node.nextSibling)target.appendChild(node)}function insert(target,node,anchor){target.insertBefore(node,anchor||null)}function insert_hydration(target,node,anchor){if(is_hydrating&&!anchor)append_hydration(target,node);else if(node.parentNode!==target||node.nextSibling!=anchor)target.insertBefore(node,anchor||null)}function detach(node){if(node.parentNode)node.parentNode.removeChild(node)}function destroy_each(iterations,detaching){for(let i2=0;i2<iterations.length;i2+=1)if(iterations[i2])iterations[i2].d(detaching)}function element(name){return document.createElement(name)}function element_is(name,is){return document.createElement(name,{is})}function object_without_properties(obj,exclude){const target={};for(const k2 in obj)if(has_prop(obj,k2)&&-1===exclude.indexOf(k2))target[k2]=obj[k2];return target}function svg_element(name){return document.createElementNS("http://www.w3.org/2000/svg",name)}function text(data){return document.createTextNode(data)}function space(){return text(" ")}function empty(){return text("")}function comment(content){return document.createComment(content)}function listen(node,event,handler,options){node.addEventListener(event,handler,options);return()=>node.removeEventListener(event,handler,options)}function prevent_default(fn){return function(event){event.preventDefault();return fn.call(this,event)}}function stop_propagation(fn){return function(event){event.stopPropagation();return fn.call(this,event)}}function stop_immediate_propagation(fn){return function(event){event.stopImmediatePropagation();return fn.call(this,event)}}function self2(fn){return function(event){if(event.target===this)fn.call(this,event)}}function trusted(fn){return function(event){if(event.isTrusted)fn.call(this,event)}}function attr(node,attribute,value){if(null==value)node.removeAttribute(attribute);else if(node.getAttribute(attribute)!==value)node.setAttribute(attribute,value)}var crossorigin,always_set_through_set_attribute=["width","height"];function set_attributes(node,attributes){const descriptors=Object.getOwnPropertyDescriptors(node.__proto__);for(const key2 in attributes)if(null==attributes[key2])node.removeAttribute(key2);else if("style"===key2)node.style.cssText=attributes[key2];else if("__value"===key2)node.value=node[key2]=attributes[key2];else if(descriptors[key2]&&descriptors[key2].set&&-1===always_set_through_set_attribute.indexOf(key2))node[key2]=attributes[key2];else attr(node,key2,attributes[key2])}function set_svg_attributes(node,attributes){for(const key2 in attributes)attr(node,key2,attributes[key2])}function set_custom_element_data_map(node,data_map){Object.keys(data_map).forEach((key2=>{set_custom_element_data(node,key2,data_map[key2])}))}function set_custom_element_data(node,prop,value){const lower=prop.toLowerCase();if(lower in node)node[lower]="boolean"==typeof node[lower]&&""===value?true:value;else if(prop in node)node[prop]="boolean"==typeof node[prop]&&""===value?true:value;else attr(node,prop,value)}function set_dynamic_element_data(tag){return/-/.test(tag)?set_custom_element_data_map:set_attributes}function xlink_attr(node,attribute,value){node.setAttributeNS("http://www.w3.org/1999/xlink",attribute,value)}function get_svelte_dataset(node){return node.dataset.svelteH}function get_binding_group_value(group,__value,checked){const value=new Set;for(let i2=0;i2<group.length;i2+=1)if(group[i2].checked)value.add(group[i2].__value);if(!checked)value.delete(__value);return Array.from(value)}function init_binding_group(group){let _inputs;return{p(...inputs){_inputs=inputs;_inputs.forEach((input=>group.push(input)))},r(){_inputs.forEach((input=>group.splice(group.indexOf(input),1)))}}}function init_binding_group_dynamic(group,indexes2){let _inputs,_group=get_binding_group(group);function get_binding_group(group2){for(let i2=0;i2<indexes2.length;i2++)group2=group2[indexes2[i2]]=group2[indexes2[i2]]||[];return group2}function push(){_inputs.forEach((input=>_group.push(input)))}function remove(){_inputs.forEach((input=>_group.splice(_group.indexOf(input),1)))}return{u(new_indexes){indexes2=new_indexes;const new_group=get_binding_group(group);if(new_group!==_group){remove();_group=new_group;push()}},p(...inputs){_inputs=inputs;push()},r:remove}}function to_number(value){return""===value?null:+value}function time_ranges_to_array(ranges){const array=[];for(let i2=0;i2<ranges.length;i2+=1)array.push({start:ranges.start(i2),end:ranges.end(i2)});return array}function children(element2){return Array.from(element2.childNodes)}function init_claim_info(nodes){if(void 0===nodes.claim_info)nodes.claim_info={last_index:0,total_claimed:0}}function claim_node(nodes,predicate,process_node,create_node,dont_update_last_index=false){init_claim_info(nodes);const result_node=(()=>{for(let i2=nodes.claim_info.last_index;i2<nodes.length;i2++){const node=nodes[i2];if(predicate(node)){const replacement=process_node(node);if(void 0===replacement)nodes.splice(i2,1);else nodes[i2]=replacement;if(!dont_update_last_index)nodes.claim_info.last_index=i2;return node}}for(let i2=nodes.claim_info.last_index-1;i2>=0;i2--){const node=nodes[i2];if(predicate(node)){const replacement=process_node(node);if(void 0===replacement)nodes.splice(i2,1);else nodes[i2]=replacement;if(!dont_update_last_index)nodes.claim_info.last_index=i2;else if(void 0===replacement)nodes.claim_info.last_index--;return node}}return create_node()})();result_node.claim_order=nodes.claim_info.total_claimed;nodes.claim_info.total_claimed+=1;return result_node}function claim_element_base(nodes,name,attributes,create_element){return claim_node(nodes,(node=>node.nodeName===name),(node=>{const remove=[];for(let j2=0;j2<node.attributes.length;j2++){const attribute=node.attributes[j2];if(!attributes[attribute.name])remove.push(attribute.name)}remove.forEach((v2=>node.removeAttribute(v2)))}),(()=>create_element(name)))}function claim_element(nodes,name,attributes){return claim_element_base(nodes,name,attributes,element)}function claim_svg_element(nodes,name,attributes){return claim_element_base(nodes,name,attributes,svg_element)}function claim_text(nodes,data){return claim_node(nodes,(node=>3===node.nodeType),(node=>{const data_str=""+data;if(node.data.startsWith(data_str)){if(node.data.length!==data_str.length)return node.splitText(data_str.length)}else node.data=data_str}),(()=>text(data)),true)}function claim_space(nodes){return claim_text(nodes," ")}function claim_comment(nodes,data){return claim_node(nodes,(node=>8===node.nodeType),(node=>{node.data=""+data}),(()=>comment(data)),true)}function get_comment_idx(nodes,text2,start){for(let i2=start;i2<nodes.length;i2+=1){const node=nodes[i2];if(8===node.nodeType&&node.textContent.trim()===text2)return i2}return-1}function claim_html_tag(nodes,is_svg2){const start_index=get_comment_idx(nodes,"HTML_TAG_START",0),end_index=get_comment_idx(nodes,"HTML_TAG_END",start_index+1);if(-1===start_index||-1===end_index)return new HtmlTagHydration(is_svg2);init_claim_info(nodes);const html_tag_nodes=nodes.splice(start_index,end_index-start_index+1);detach(html_tag_nodes[0]);detach(html_tag_nodes[html_tag_nodes.length-1]);const claimed_nodes=html_tag_nodes.slice(1,html_tag_nodes.length-1);if(0===claimed_nodes.length)return new HtmlTagHydration(is_svg2);for(const n3 of claimed_nodes){n3.claim_order=nodes.claim_info.total_claimed;nodes.claim_info.total_claimed+=1}return new HtmlTagHydration(is_svg2,claimed_nodes)}function set_data(text2,data){data=""+data;if(text2.data!==data)text2.data=data}function set_data_contenteditable(text2,data){data=""+data;if(text2.wholeText!==data)text2.data=data}function set_data_maybe_contenteditable(text2,data,attr_value){if(~contenteditable_truthy_values.indexOf(attr_value))set_data_contenteditable(text2,data);else set_data(text2,data)}function set_input_value(input,value){input.value=null==value?"":value}function set_input_type(input,type){try{input.type=type}catch(e4){}}function set_style(node,key2,value,important){if(null==value)node.style.removeProperty(key2);else node.style.setProperty(key2,value,important?"important":"")}function select_option(select,value,mounting){for(let i2=0;i2<select.options.length;i2+=1){const option=select.options[i2];if(option.__value===value){option.selected=true;return}}if(!mounting||void 0!==value)select.selectedIndex=-1}function select_options(select,value){for(let i2=0;i2<select.options.length;i2+=1){const option=select.options[i2];option.selected=~value.indexOf(option.__value)}}function select_value(select){const selected_option=select.querySelector(":checked");return selected_option&&selected_option.__value}function select_multiple_value(select){return[].map.call(select.querySelectorAll(":checked"),(option=>option.__value))}function is_crossorigin(){if(void 0===crossorigin){crossorigin=false;try{if("undefined"!=typeof window&&window.parent)window.parent.document}catch(error){crossorigin=true}}return crossorigin}function add_iframe_resize_listener(node,fn){if("static"===getComputedStyle(node).position)node.style.position="relative";const iframe=element("iframe");iframe.setAttribute("style","display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; border: 0; opacity: 0; pointer-events: none; z-index: -1;");iframe.setAttribute("aria-hidden","true");iframe.tabIndex=-1;const crossorigin2=is_crossorigin();let unsubscribe;if(crossorigin2){iframe.src="data:text/html,<script>onresize=function(){parent.postMessage(0,'*')}<\/script>";unsubscribe=listen(window,"message",(event=>{if(event.source===iframe.contentWindow)fn()}))}else{iframe.src="about:blank";iframe.onload=()=>{unsubscribe=listen(iframe.contentWindow,"resize",fn);fn()}}append(node,iframe);return()=>{if(crossorigin2)unsubscribe();else if(unsubscribe&&iframe.contentWindow)unsubscribe();detach(iframe)}}var resize_observer_content_box=new ResizeObserverSingleton({box:"content-box"}),resize_observer_border_box=new ResizeObserverSingleton({box:"border-box"}),resize_observer_device_pixel_content_box=new ResizeObserverSingleton({box:"device-pixel-content-box"});function toggle_class(element2,name,toggle){element2.classList.toggle(name,!!toggle)}function custom_event(type,detail,{bubbles=false,cancelable=false}={}){return new CustomEvent(type,{detail,bubbles,cancelable})}function query_selector_all(selector,parent=document.body){return Array.from(parent.querySelectorAll(selector))}function head_selector(nodeId,head){const result=[];let started=0;for(const node of head.childNodes)if(8===node.nodeType){const comment2=node.textContent.trim();if(comment2===`HEAD_${nodeId}_END`){started-=1;result.push(node)}else if(comment2===`HEAD_${nodeId}_START`){started+=1;result.push(node)}}else if(started>0)result.push(node);return result}var HtmlTag=class{constructor(is_svg2=false){__publicField(this,"is_svg",false);__publicField(this,"e");__publicField(this,"n");__publicField(this,"t");__publicField(this,"a");this.is_svg=is_svg2;this.e=this.n=null}c(html){this.h(html)}m(html,target,anchor=null){if(!this.e){if(this.is_svg)this.e=svg_element(target.nodeName);else this.e=element(11===target.nodeType?"TEMPLATE":target.nodeName);this.t="TEMPLATE"!==target.tagName?target:target.content;this.c(html)}this.i(anchor)}h(html){this.e.innerHTML=html;this.n=Array.from("TEMPLATE"===this.e.nodeName?this.e.content.childNodes:this.e.childNodes)}i(anchor){for(let i2=0;i2<this.n.length;i2+=1)insert(this.t,this.n[i2],anchor)}p(html){this.d();this.h(html);this.i(this.a)}d(){this.n.forEach(detach)}},HtmlTagHydration=class extends HtmlTag{constructor(is_svg2=false,claimed_nodes){super(is_svg2);__publicField(this,"l");this.e=this.n=null;this.l=claimed_nodes}c(html){if(this.l)this.n=this.l;else super.c(html)}i(anchor){for(let i2=0;i2<this.n.length;i2+=1)insert_hydration(this.t,this.n[i2],anchor)}};function attribute_to_object(attributes){const result={};for(const attribute of attributes)result[attribute.name]=attribute.value;return result}var escaped={'"':"&quot;","&":"&amp;","<":"&lt;"},regex_attribute_characters_to_escape=/["&<]/g;function escape_attribute(attribute){return String(attribute).replace(regex_attribute_characters_to_escape,(match3=>escaped[match3]))}function stringify_spread(attributes){let str=" ";for(const key2 in attributes)if(null!=attributes[key2])str+=`${key2}="${escape_attribute(attributes[key2])}" `;return str}function get_custom_elements_slots(element2){const result={};element2.childNodes.forEach((node=>{result[node.slot||"default"]=true}));return result}function construct_svelte_component(component,props){return new component(props)}var current_component,managed_styles=new Map,active=0;function hash(str){let hash2=5381,i2=str.length;for(;i2--;)hash2=(hash2<<5)-hash2^str.charCodeAt(i2);return hash2>>>0}function create_style_information(doc,node){const info3={stylesheet:append_empty_stylesheet(node),rules:{}};managed_styles.set(doc,info3);return info3}function create_rule(node,a2,b3,duration,delay2,ease,fn,uid=0){const step=16.666/duration;let keyframes="{\n";for(let p2=0;p2<=1;p2+=step){const t4=a2+(b3-a2)*ease(p2);keyframes+=100*p2+`%{${fn(t4,1-t4)}}\n`}const rule=keyframes+`100% {${fn(b3,1-b3)}}\n}`,name=`__svelte_${hash(rule)}_${uid}`,doc=get_root_for_style(node),{stylesheet,rules}=managed_styles.get(doc)||create_style_information(doc,node);if(!rules[name]){rules[name]=true;stylesheet.insertRule(`@keyframes ${name} ${rule}`,stylesheet.cssRules.length)}const animation=node.style.animation||"";node.style.animation=`${animation?`${animation}, `:""}${name} ${duration}ms linear ${delay2}ms 1 both`;active+=1;return name}function delete_rule(node,name){const previous=(node.style.animation||"").split(", "),next=previous.filter(name?anim=>anim.indexOf(name)<0:anim=>-1===anim.indexOf("__svelte")),deleted=previous.length-next.length;if(deleted){node.style.animation=next.join(", ");if(!(active-=deleted))clear_rules()}}function clear_rules(){raf((()=>{if(!active){managed_styles.forEach((info3=>{const{ownerNode}=info3.stylesheet;if(ownerNode)detach(ownerNode)}));managed_styles.clear()}}))}function create_animation(node,from,fn,params){if(!from)return noop2;const to=node.getBoundingClientRect();if(from.left===to.left&&from.right===to.right&&from.top===to.top&&from.bottom===to.bottom)return noop2;const{delay:delay2=0,duration=300,easing=identity,start:start_time=now()+delay2,end=start_time+duration,tick:tick2=noop2,css}=fn(node,{from,to},params);let name,running2=true,started=false;function stop(){if(css)delete_rule(node,name);running2=false}loop((now2=>{if(!started&&now2>=start_time)started=true;if(started&&now2>=end){tick2(1,0);stop()}if(!running2)return false;if(started){const t4=0+1*easing((now2-start_time)/duration);tick2(t4,1-t4)}return true}));(function start(){if(css)name=create_rule(node,0,1,duration,delay2,easing,css);if(!delay2)started=true})();tick2(0,1);return stop}function fix_position(node){const style=getComputedStyle(node);if("absolute"!==style.position&&"fixed"!==style.position){const{width,height}=style,a2=node.getBoundingClientRect();node.style.position="absolute";node.style.width=width;node.style.height=height;add_transform(node,a2)}}function add_transform(node,a2){const b3=node.getBoundingClientRect();if(a2.left!==b3.left||a2.top!==b3.top){const style=getComputedStyle(node),transform2="none"===style.transform?"":style.transform;node.style.transform=`${transform2} translate(${a2.left-b3.left}px, ${a2.top-b3.top}px)`}}function set_current_component(component){current_component=component}function get_current_component(){if(!current_component)throw new Error("Function called outside component initialization");return current_component}function beforeUpdate(fn){get_current_component().$$.before_update.push(fn)}function onMount(fn){get_current_component().$$.on_mount.push(fn)}function afterUpdate(fn){get_current_component().$$.after_update.push(fn)}function onDestroy(fn){get_current_component().$$.on_destroy.push(fn)}function createEventDispatcher(){const component=get_current_component();return(type,detail,{cancelable=false}={})=>{const callbacks=component.$$.callbacks[type];if(callbacks){const event=custom_event(type,detail,{cancelable});callbacks.slice().forEach((fn=>{fn.call(component,event)}));return!event.defaultPrevented}return true}}function setContext(key2,context2){get_current_component().$$.context.set(key2,context2);return context2}function getContext(key2){return get_current_component().$$.context.get(key2)}function getAllContexts(){return get_current_component().$$.context}function hasContext(key2){return get_current_component().$$.context.has(key2)}function bubble(component,event){const callbacks=component.$$.callbacks[event.type];if(callbacks)callbacks.slice().forEach((fn=>fn.call(this,event)))}var dirty_components=[],intros={enabled:false},binding_callbacks=[],render_callbacks=[],flush_callbacks=[],resolved_promise=Promise.resolve(),update_scheduled=false;function schedule_update(){if(!update_scheduled){update_scheduled=true;resolved_promise.then(flush)}}function tick(){schedule_update();return resolved_promise}function add_render_callback(fn){render_callbacks.push(fn)}function add_flush_callback(fn){flush_callbacks.push(fn)}var promise,seen_callbacks=new Set,flushidx=0;function flush(){if(0!==flushidx)return;const saved_component=current_component;do{try{for(;flushidx<dirty_components.length;){const component=dirty_components[flushidx];flushidx++;set_current_component(component);update(component.$$)}}catch(e4){dirty_components.length=0;flushidx=0;throw e4}set_current_component(null);dirty_components.length=0;flushidx=0;for(;binding_callbacks.length;)binding_callbacks.pop()();for(let i2=0;i2<render_callbacks.length;i2+=1){const callback=render_callbacks[i2];if(!seen_callbacks.has(callback)){seen_callbacks.add(callback);callback()}}render_callbacks.length=0}while(dirty_components.length);for(;flush_callbacks.length;)flush_callbacks.pop()();update_scheduled=false;seen_callbacks.clear();set_current_component(saved_component)}function update($$){if(null!==$$.fragment){$$.update();run_all($$.before_update);const dirty=$$.dirty;$$.dirty=[-1];$$.fragment&&$$.fragment.p($$.ctx,dirty);$$.after_update.forEach(add_render_callback)}}function flush_render_callbacks(fns){const filtered=[],targets=[];render_callbacks.forEach((c2=>-1===fns.indexOf(c2)?filtered.push(c2):targets.push(c2)));targets.forEach((c2=>c2()));render_callbacks=filtered}function wait(){if(!promise)(promise=Promise.resolve()).then((()=>{promise=null}));return promise}function dispatch(node,direction,kind){node.dispatchEvent(custom_event(`${direction?"intro":"outro"}${kind}`))}var outros,outroing=new Set;function group_outros(){outros={r:0,c:[],p:outros}}function check_outros(){if(!outros.r)run_all(outros.c);outros=outros.p}function transition_in(block,local){if(block&&block.i){outroing.delete(block);block.i(local)}}function transition_out(block,local,detach2,callback){if(block&&block.o){if(outroing.has(block))return;outroing.add(block);outros.c.push((()=>{outroing.delete(block);if(callback){if(detach2)block.d(1);callback()}}));block.o(local)}else if(callback)callback()}var null_transition={duration:0};function create_in_transition(node,fn,params){const options={direction:"in"};let animation_name,task,config=fn(node,params,options),running2=false,uid=0;function cleanup(){if(animation_name)delete_rule(node,animation_name)}function go(){const{delay:delay2=0,duration=300,easing=identity,tick:tick2=noop2,css}=config||null_transition;if(css)animation_name=create_rule(node,0,1,duration,delay2,easing,css,uid++);tick2(0,1);const start_time=now()+delay2,end_time=start_time+duration;if(task)task.abort();running2=true;add_render_callback((()=>dispatch(node,true,"start")));task=loop((now2=>{if(running2){if(now2>=end_time){tick2(1,0);dispatch(node,true,"end");cleanup();return running2=false}if(now2>=start_time){const t4=easing((now2-start_time)/duration);tick2(t4,1-t4)}}return running2}))}let started=false;return{start(){if(!started){started=true;delete_rule(node);if(is_function(config)){config=config(options);wait().then(go)}else go()}},invalidate(){started=false},end(){if(running2){cleanup();running2=false}}}}function create_out_transition(node,fn,params){const options={direction:"out"};let animation_name,config=fn(node,params,options),running2=true;const group=outros;group.r+=1;let original_inert_value;function go(){const{delay:delay2=0,duration=300,easing=identity,tick:tick2=noop2,css}=config||null_transition;if(css)animation_name=create_rule(node,1,0,duration,delay2,easing,css);const start_time=now()+delay2,end_time=start_time+duration;add_render_callback((()=>dispatch(node,false,"start")));if("inert"in node){original_inert_value=node.inert;node.inert=true}loop((now2=>{if(running2){if(now2>=end_time){tick2(0,1);dispatch(node,false,"end");if(! --group.r)run_all(group.c);return false}if(now2>=start_time){const t4=easing((now2-start_time)/duration);tick2(1-t4,t4)}}return running2}))}if(is_function(config))wait().then((()=>{config=config(options);go()}));else go();return{end(reset){if(reset&&"inert"in node)node.inert=original_inert_value;if(reset&&config.tick)config.tick(1,0);if(running2){if(animation_name)delete_rule(node,animation_name);running2=false}}}}function create_bidirectional_transition(node,fn,params,intro){let original_inert_value,config=fn(node,params,{direction:"both"}),t4=intro?0:1,running_program=null,pending_program=null,animation_name=null;function clear_animation(){if(animation_name)delete_rule(node,animation_name)}function init3(program,duration){const d4=program.b-t4;duration*=Math.abs(d4);return{a:t4,b:program.b,d:d4,duration,start:program.start,end:program.start+duration,group:program.group}}function go(b3){const{delay:delay2=0,duration=300,easing=identity,tick:tick2=noop2,css}=config||null_transition,program={start:now()+delay2,b:b3};if(!b3){program.group=outros;outros.r+=1}if("inert"in node)if(b3){if(void 0!==original_inert_value)node.inert=original_inert_value}else{original_inert_value=node.inert;node.inert=true}if(running_program||pending_program)pending_program=program;else{if(css){clear_animation();animation_name=create_rule(node,t4,b3,duration,delay2,easing,css)}if(b3)tick2(0,1);running_program=init3(program,duration);add_render_callback((()=>dispatch(node,b3,"start")));loop((now2=>{if(pending_program&&now2>pending_program.start){running_program=init3(pending_program,duration);pending_program=null;dispatch(node,running_program.b,"start");if(css){clear_animation();animation_name=create_rule(node,t4,running_program.b,running_program.duration,0,easing,config.css)}}if(running_program)if(now2>=running_program.end){tick2(t4=running_program.b,1-t4);dispatch(node,running_program.b,"end");if(!pending_program)if(running_program.b)clear_animation();else if(! --running_program.group.r)run_all(running_program.group.c);running_program=null}else if(now2>=running_program.start){const p2=now2-running_program.start;t4=running_program.a+running_program.d*easing(p2/running_program.duration);tick2(t4,1-t4)}return!!(running_program||pending_program)}))}}return{run(b3){if(is_function(config))wait().then((()=>{config=config({direction:b3?"in":"out"});go(b3)}));else go(b3)},end(){clear_animation();running_program=pending_program=null}}}function handle_promise(promise2,info3){const token=info3.token={};function update2(type,index5,key2,value){if(info3.token!==token)return;info3.resolved=value;let child_ctx=info3.ctx;if(void 0!==key2){child_ctx=child_ctx.slice();child_ctx[key2]=value}const block=type&&(info3.current=type)(child_ctx);let needs_flush=false;if(info3.block){if(info3.blocks)info3.blocks.forEach(((block2,i2)=>{if(i2!==index5&&block2){group_outros();transition_out(block2,1,1,(()=>{if(info3.blocks[i2]===block2)info3.blocks[i2]=null}));check_outros()}}));else info3.block.d(1);block.c();transition_in(block,1);block.m(info3.mount(),info3.anchor);needs_flush=true}info3.block=block;if(info3.blocks)info3.blocks[index5]=block;if(needs_flush)flush()}if(is_promise(promise2)){const current_component2=get_current_component();promise2.then((value=>{set_current_component(current_component2);update2(info3.then,1,info3.value,value);set_current_component(null)}),(error=>{set_current_component(current_component2);update2(info3.catch,2,info3.error,error);set_current_component(null);if(!info3.hasCatch)throw error}));if(info3.current!==info3.pending){update2(info3.pending,0);return true}}else{if(info3.current!==info3.then){update2(info3.then,1,info3.value,promise2);return true}info3.resolved=promise2}}function update_await_block_branch(info3,ctx,dirty){const child_ctx=ctx.slice(),{resolved}=info3;if(info3.current===info3.then)child_ctx[info3.value]=resolved;if(info3.current===info3.catch)child_ctx[info3.error]=resolved;info3.block.p(child_ctx,dirty)}function ensure_array_like(array_like_or_iterator){return void 0!==(null==array_like_or_iterator?void 0:array_like_or_iterator.length)?array_like_or_iterator:Array.from(array_like_or_iterator)}function destroy_block(block,lookup){block.d(1);lookup.delete(block.key)}function outro_and_destroy_block(block,lookup){transition_out(block,1,1,(()=>{lookup.delete(block.key)}))}function fix_and_destroy_block(block,lookup){block.f();destroy_block(block,lookup)}function fix_and_outro_and_destroy_block(block,lookup){block.f();outro_and_destroy_block(block,lookup)}function update_keyed_each(old_blocks,dirty,get_key,dynamic,ctx,list,lookup,node,destroy2,create_each_block8,next,get_context){let o2=old_blocks.length,n3=list.length,i2=o2;const old_indexes={};for(;i2--;)old_indexes[old_blocks[i2].key]=i2;const new_blocks=[],new_lookup=new Map,deltas=new Map,updates=[];i2=n3;for(;i2--;){const child_ctx=get_context(ctx,list,i2),key2=get_key(child_ctx);let block=lookup.get(key2);if(!block){block=create_each_block8(key2,child_ctx);block.c()}else if(dynamic)updates.push((()=>block.p(child_ctx,dirty)));new_lookup.set(key2,new_blocks[i2]=block);if(key2 in old_indexes)deltas.set(key2,Math.abs(i2-old_indexes[key2]))}const will_move=new Set,did_move=new Set;function insert2(block){transition_in(block,1);block.m(node,next);lookup.set(block.key,block);next=block.first;n3--}for(;o2&&n3;){const new_block=new_blocks[n3-1],old_block=old_blocks[o2-1],new_key=new_block.key,old_key=old_block.key;if(new_block===old_block){next=new_block.first;o2--;n3--}else if(!new_lookup.has(old_key)){destroy2(old_block,lookup);o2--}else if(!lookup.has(new_key)||will_move.has(new_key))insert2(new_block);else if(did_move.has(old_key))o2--;else if(deltas.get(new_key)>deltas.get(old_key)){did_move.add(new_key);insert2(new_block)}else{will_move.add(old_key);o2--}}for(;o2--;){const old_block=old_blocks[o2];if(!new_lookup.has(old_block.key))destroy2(old_block,lookup)}for(;n3;)insert2(new_blocks[n3-1]);run_all(updates);return new_blocks}function validate_each_keys(ctx,list,get_context,get_key){const keys2=new Map;for(let i2=0;i2<list.length;i2++){const key2=get_key(get_context(ctx,list,i2));if(keys2.has(key2)){let value="";try{value=`with value '${String(key2)}' `}catch(e4){}throw new Error(`Cannot have duplicate keys in a keyed each: Keys at index ${keys2.get(key2)} and ${i2} ${value}are duplicates`)}keys2.set(key2,i2)}}function get_spread_update(levels,updates){const update2={},to_null_out={},accounted_for={$$scope:1};let i2=levels.length;for(;i2--;){const o2=levels[i2],n3=updates[i2];if(n3){for(const key2 in o2)if(!(key2 in n3))to_null_out[key2]=1;for(const key2 in n3)if(!accounted_for[key2]){update2[key2]=n3[key2];accounted_for[key2]=1}levels[i2]=n3}else for(const key2 in o2)accounted_for[key2]=1}for(const key2 in to_null_out)if(!(key2 in update2))update2[key2]=void 0;return update2}function get_spread_object(spread_props){return"object"==typeof spread_props&&null!==spread_props?spread_props:{}}var _boolean_attributes=["allowfullscreen","allowpaymentrequest","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","hidden","inert","ismap","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected"],boolean_attributes=new Set([..._boolean_attributes]),ATTR_REGEX=/[&"<]/g,CONTENT_REGEX=/[&<]/g;function escape2(value,is_attr=false){const str=String(value),pattern=is_attr?ATTR_REGEX:CONTENT_REGEX;pattern.lastIndex=0;let escaped2="",last=0;for(;pattern.test(str);){const i2=pattern.lastIndex-1,ch4=str[i2];escaped2+=str.substring(last,i2)+("&"===ch4?"&amp;":'"'===ch4?"&quot;":"&lt;");last=i2+1}return escaped2+str.substring(last)}var void_element_names=/^(?:area|base|br|col|command|embed|hr|img|input|keygen|link|meta|param|source|track|wbr)$/,html_element_names=/^(?:a|abbr|address|area|article|aside|audio|b|base|bdi|bdo|blockquote|body|br|button|canvas|caption|cite|code|col|colgroup|data|datalist|dd|del|details|dfn|dialog|div|dl|dt|em|embed|fieldset|figcaption|figure|footer|form|h1|h2|h3|h4|h5|h6|head|header|hr|html|i|iframe|img|input|ins|kbd|label|legend|li|link|main|map|mark|meta|meter|nav|noscript|object|ol|optgroup|option|output|p|param|picture|pre|progress|q|rp|rt|ruby|s|samp|script|section|select|small|source|span|strong|style|sub|summary|sup|table|tbody|td|template|textarea|tfoot|th|thead|time|title|tr|track|u|ul|var|video|wbr)$/,svg=/^(?:altGlyph|altGlyphDef|altGlyphItem|animate|animateColor|animateMotion|animateTransform|circle|clipPath|color-profile|cursor|defs|desc|discard|ellipse|feBlend|feColorMatrix|feComponentTransfer|feComposite|feConvolveMatrix|feDiffuseLighting|feDisplacementMap|feDistantLight|feDropShadow|feFlood|feFuncA|feFuncB|feFuncG|feFuncR|feGaussianBlur|feImage|feMerge|feMergeNode|feMorphology|feOffset|fePointLight|feSpecularLighting|feSpotLight|feTile|feTurbulence|filter|font|font-face|font-face-format|font-face-name|font-face-src|font-face-uri|foreignObject|g|glyph|glyphRef|hatch|hatchpath|hkern|image|line|linearGradient|marker|mask|mesh|meshgradient|meshpatch|meshrow|metadata|missing-glyph|mpath|path|pattern|polygon|polyline|radialGradient|rect|set|solidcolor|stop|svg|switch|symbol|text|textPath|tref|tspan|unknown|use|view|vkern)$/;function is_void(name){return void_element_names.test(name)||"!doctype"===name.toLowerCase()}function is_html(name){return html_element_names.test(name)}function is_svg(name){return svg.test(name)}var invalid_attribute_name_character=/[\s'">/=\u{FDD0}-\u{FDEF}\u{FFFE}\u{FFFF}\u{1FFFE}\u{1FFFF}\u{2FFFE}\u{2FFFF}\u{3FFFE}\u{3FFFF}\u{4FFFE}\u{4FFFF}\u{5FFFE}\u{5FFFF}\u{6FFFE}\u{6FFFF}\u{7FFFE}\u{7FFFF}\u{8FFFE}\u{8FFFF}\u{9FFFE}\u{9FFFF}\u{AFFFE}\u{AFFFF}\u{BFFFE}\u{BFFFF}\u{CFFFE}\u{CFFFF}\u{DFFFE}\u{DFFFF}\u{EFFFE}\u{EFFFF}\u{FFFFE}\u{FFFFF}\u{10FFFE}\u{10FFFF}]/u;function spread(args,attrs_to_add){const attributes=Object.assign({},...args);if(attrs_to_add){const classes_to_add=attrs_to_add.classes,styles_to_add=attrs_to_add.styles;if(classes_to_add)if(null==attributes.class)attributes.class=classes_to_add;else attributes.class+=" "+classes_to_add;if(styles_to_add)if(null==attributes.style)attributes.style=style_object_to_string(styles_to_add);else attributes.style=style_object_to_string(merge_ssr_styles(attributes.style,styles_to_add))}let str="";Object.keys(attributes).forEach((name=>{if(invalid_attribute_name_character.test(name))return;const value=attributes[name];if(true===value)str+=" "+name;else if(boolean_attributes.has(name.toLowerCase())){if(value)str+=" "+name}else if(null!=value)str+=` ${name}="${value}"`}));return str}function merge_ssr_styles(style_attribute,style_directive){const style_object={};for(const individual_style of style_attribute.split(";")){const colon_index=individual_style.indexOf(":"),name=individual_style.slice(0,colon_index).trim(),value=individual_style.slice(colon_index+1).trim();if(name)style_object[name]=value}for(const name in style_directive){const value=style_directive[name];if(value)style_object[name]=value;else delete style_object[name]}return style_object}function escape_attribute_value(value){return"string"==typeof value||value&&"object"==typeof value?escape2(value,true):value}function escape_object(obj){const result={};for(const key2 in obj)result[key2]=escape_attribute_value(obj[key2]);return result}function each(items,fn){items=ensure_array_like(items);let str="";for(let i2=0;i2<items.length;i2+=1)str+=fn(items[i2],i2);return str}var on_destroy,SvelteElement,missing_component={$$render:()=>""};function validate_component(component,name){if(!component||!component.$$render){if("svelte:component"===name)name+=" this={...}";throw new Error(`<${name}> is not a valid SSR component. You may need to review your build config to ensure that dependencies are compiled, rather than imported as pre-compiled modules. Otherwise you may need to fix a <${name}>.`)}return component}function debug2(file,line,column,values){console.log(`{@debug} ${file?file+" ":""}(${line}:${column})`);console.log(values);return""}function create_ssr_component(fn){function $$render(result,props,bindings,slots,context2){const parent_component=current_component;set_current_component({$$:{on_destroy,context:new Map(context2||(parent_component?parent_component.$$.context:[])),on_mount:[],before_update:[],after_update:[],callbacks:blank_object()}});const html=fn(result,props,bindings,slots);set_current_component(parent_component);return html}return{render:(props={},{$$slots={},context:context2=new Map}={})=>{on_destroy=[];const result={title:"",head:"",css:new Set},html=$$render(result,props,{},$$slots,context2);run_all(on_destroy);return{html,css:{code:Array.from(result.css).map((css=>css.code)).join("\n"),map:null},head:result.title+result.head}},$$render}}function add_attribute(name,value,boolean){if(null==value||boolean&&!value)return"";else return` ${name}${boolean&&true===value?"":`="${escape2(value,true)}"`}`}function add_classes(classes){return classes?` class="${classes}"`:""}function style_object_to_string(style_object){return Object.keys(style_object).filter((key2=>null!=style_object[key2]&&""!==style_object[key2])).map((key2=>`${key2}: ${escape_attribute_value(style_object[key2])};`)).join(" ")}function add_styles(style_object){const styles=style_object_to_string(style_object);return styles?` style="${styles}"`:""}function bind(component,name,callback){const index5=component.$$.props[name];if(void 0!==index5){component.$$.bound[index5]=callback;callback(component.$$.ctx[index5])}}function create_component(block){block&&block.c()}function claim_component(block,parent_nodes){block&&block.l(parent_nodes)}function mount_component(component,target,anchor){const{fragment,after_update}=component.$$;fragment&&fragment.m(target,anchor);add_render_callback((()=>{const new_on_destroy=component.$$.on_mount.map(run).filter(is_function);if(component.$$.on_destroy)component.$$.on_destroy.push(...new_on_destroy);else run_all(new_on_destroy);component.$$.on_mount=[]}));after_update.forEach(add_render_callback)}function destroy_component(component,detaching){const $$=component.$$;if(null!==$$.fragment){flush_render_callbacks($$.after_update);run_all($$.on_destroy);$$.fragment&&$$.fragment.d(detaching);$$.on_destroy=$$.fragment=null;$$.ctx=[]}}function make_dirty(component,i2){if(-1===component.$$.dirty[0]){dirty_components.push(component);schedule_update();component.$$.dirty.fill(0)}component.$$.dirty[i2/31|0]|=1<<i2%31}function init(component,options,instance8,create_fragment8,not_equal2,props,append_styles2=null,dirty=[-1]){const parent_component=current_component;set_current_component(component);const $$=component.$$={fragment:null,ctx:[],props,update:noop2,not_equal:not_equal2,bound:blank_object(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(options.context||(parent_component?parent_component.$$.context:[])),callbacks:blank_object(),dirty,skip_bound:false,root:options.target||parent_component.$$.root};append_styles2&&append_styles2($$.root);let ready=false;$$.ctx=instance8?instance8(component,options.props||{},((i2,ret,...rest)=>{const value=rest.length?rest[0]:ret;if($$.ctx&&not_equal2($$.ctx[i2],$$.ctx[i2]=value)){if(!$$.skip_bound&&$$.bound[i2])$$.bound[i2](value);if(ready)make_dirty(component,i2)}return ret})):[];$$.update();ready=true;run_all($$.before_update);$$.fragment=create_fragment8?create_fragment8($$.ctx):false;if(options.target){if(options.hydrate){start_hydrating();const nodes=children(options.target);$$.fragment&&$$.fragment.l(nodes);nodes.forEach(detach)}else $$.fragment&&$$.fragment.c();if(options.intro)transition_in(component.$$.fragment);mount_component(component,options.target,options.anchor);end_hydrating();flush()}set_current_component(parent_component)}if("function"==typeof HTMLElement)SvelteElement=class extends HTMLElement{constructor($$componentCtor,$$slots,use_shadow_dom){super();__publicField(this,"$$ctor");__publicField(this,"$$s");__publicField(this,"$$c");__publicField(this,"$$cn",false);__publicField(this,"$$d",{});__publicField(this,"$$r",false);__publicField(this,"$$p_d",{});__publicField(this,"$$l",{});__publicField(this,"$$l_u",new Map);this.$$ctor=$$componentCtor;this.$$s=$$slots;if(use_shadow_dom)this.attachShadow({mode:"open"})}addEventListener(type,listener,options){this.$$l[type]=this.$$l[type]||[];this.$$l[type].push(listener);if(this.$$c){const unsub=this.$$c.$on(type,listener);this.$$l_u.set(listener,unsub)}super.addEventListener(type,listener,options)}removeEventListener(type,listener,options){super.removeEventListener(type,listener,options);if(this.$$c){const unsub=this.$$l_u.get(listener);if(unsub){unsub();this.$$l_u.delete(listener)}}}async connectedCallback(){this.$$cn=true;if(!this.$$c){let create_slot2=function(name){return()=>{let node;return{c:function create(){node=element("slot");if("default"!==name)attr(node,"name",name)},m:function mount(target,anchor){insert(target,node,anchor)},d:function destroy2(detaching){if(detaching)detach(node)}}}};await Promise.resolve();if(!this.$$cn||this.$$c)return;const $$slots={},existing_slots=get_custom_elements_slots(this);for(const name of this.$$s)if(name in existing_slots)$$slots[name]=[create_slot2(name)];for(const attribute of this.attributes){const name=this.$$g_p(attribute.name);if(!(name in this.$$d))this.$$d[name]=get_custom_element_value(name,attribute.value,this.$$p_d,"toProp")}for(const key2 in this.$$p_d)if(!(key2 in this.$$d)&&void 0!==this[key2]){this.$$d[key2]=this[key2];delete this[key2]}this.$$c=new this.$$ctor({target:this.shadowRoot||this,props:{...this.$$d,$$slots,$$scope:{ctx:[]}}});const reflect_attributes=()=>{this.$$r=true;for(const key2 in this.$$p_d){this.$$d[key2]=this.$$c.$$.ctx[this.$$c.$$.props[key2]];if(this.$$p_d[key2].reflect){const attribute_value=get_custom_element_value(key2,this.$$d[key2],this.$$p_d,"toAttribute");if(null==attribute_value)this.removeAttribute(this.$$p_d[key2].attribute||key2);else this.setAttribute(this.$$p_d[key2].attribute||key2,attribute_value)}}this.$$r=false};this.$$c.$$.after_update.push(reflect_attributes);reflect_attributes();for(const type in this.$$l)for(const listener of this.$$l[type]){const unsub=this.$$c.$on(type,listener);this.$$l_u.set(listener,unsub)}this.$$l={}}}attributeChangedCallback(attr2,_oldValue,newValue){var _a5;if(!this.$$r){attr2=this.$$g_p(attr2);this.$$d[attr2]=get_custom_element_value(attr2,newValue,this.$$p_d,"toProp");null==(_a5=this.$$c)||_a5.$set({[attr2]:this.$$d[attr2]})}}disconnectedCallback(){this.$$cn=false;Promise.resolve().then((()=>{if(!this.$$cn&&this.$$c){this.$$c.$destroy();this.$$c=void 0}}))}$$g_p(attribute_name){return Object.keys(this.$$p_d).find((key2=>this.$$p_d[key2].attribute===attribute_name||!this.$$p_d[key2].attribute&&key2.toLowerCase()===attribute_name))||attribute_name}};function get_custom_element_value(prop,value,props_definition,transform2){var _a5;const type=null==(_a5=props_definition[prop])?void 0:_a5.type;value="Boolean"===type&&"boolean"!=typeof value?null!=value:value;if(!transform2||!props_definition[prop])return value;else if("toAttribute"===transform2)switch(type){case"Object":case"Array":return null==value?null:JSON.stringify(value);case"Boolean":return value?"":null;case"Number":return null==value?null:value;default:return value}else switch(type){case"Object":case"Array":return value&&JSON.parse(value);case"Boolean":return value;case"Number":return null!=value?+value:value;default:return value}}function create_custom_element(Component,props_definition,slots,accessors,use_shadow_dom,extend){let Class=class extends SvelteElement{constructor(){super(Component,slots,use_shadow_dom);this.$$p_d=props_definition}static get observedAttributes(){return Object.keys(props_definition).map((key2=>(props_definition[key2].attribute||key2).toLowerCase()))}};Object.keys(props_definition).forEach((prop=>{Object.defineProperty(Class.prototype,prop,{get(){return this.$$c&&prop in this.$$c?this.$$c[prop]:this.$$d[prop]},set(value){var _a5;value=get_custom_element_value(prop,value,props_definition);this.$$d[prop]=value;null==(_a5=this.$$c)||_a5.$set({[prop]:value})}})}));accessors.forEach((accessor=>{Object.defineProperty(Class.prototype,accessor,{get(){var _a5;return null==(_a5=this.$$c)?void 0:_a5[accessor]}})}));if(extend)Class=extend(Class);Component.element=Class;return Class}var SvelteComponent=class{constructor(){__publicField(this,"$$");__publicField(this,"$$set")}$destroy(){destroy_component(this,1);this.$destroy=noop2}$on(type,callback){if(!is_function(callback))return noop2;const callbacks=this.$$.callbacks[type]||(this.$$.callbacks[type]=[]);callbacks.push(callback);return()=>{const index5=callbacks.indexOf(callback);if(-1!==index5)callbacks.splice(index5,1)}}$set(props){if(this.$$set&&!is_empty(props)){this.$$.skip_bound=true;this.$$set(props);this.$$.skip_bound=false}}},VERSION="4.2.19",PUBLIC_VERSION="4";function dispatch_dev(type,detail){document.dispatchEvent(custom_event(type,{version:VERSION,...detail},{bubbles:true}))}function append_dev(target,node){dispatch_dev("SvelteDOMInsert",{target,node});append(target,node)}function append_hydration_dev(target,node){dispatch_dev("SvelteDOMInsert",{target,node});append_hydration(target,node)}function insert_dev(target,node,anchor){dispatch_dev("SvelteDOMInsert",{target,node,anchor});insert(target,node,anchor)}function insert_hydration_dev(target,node,anchor){dispatch_dev("SvelteDOMInsert",{target,node,anchor});insert_hydration(target,node,anchor)}function detach_dev(node){dispatch_dev("SvelteDOMRemove",{node});detach(node)}function detach_between_dev(before,after){for(;before.nextSibling&&before.nextSibling!==after;)detach_dev(before.nextSibling)}function detach_before_dev(after){for(;after.previousSibling;)detach_dev(after.previousSibling)}function detach_after_dev(before){for(;before.nextSibling;)detach_dev(before.nextSibling)}function listen_dev(node,event,handler,options,has_prevent_default,has_stop_propagation,has_stop_immediate_propagation){const modifiers=true===options?["capture"]:options?Array.from(Object.keys(options)):[];if(has_prevent_default)modifiers.push("preventDefault");if(has_stop_propagation)modifiers.push("stopPropagation");if(has_stop_immediate_propagation)modifiers.push("stopImmediatePropagation");dispatch_dev("SvelteDOMAddEventListener",{node,event,handler,modifiers});const dispose=listen(node,event,handler,options);return()=>{dispatch_dev("SvelteDOMRemoveEventListener",{node,event,handler,modifiers});dispose()}}function attr_dev(node,attribute,value){attr(node,attribute,value);if(null==value)dispatch_dev("SvelteDOMRemoveAttribute",{node,attribute});else dispatch_dev("SvelteDOMSetAttribute",{node,attribute,value})}function prop_dev(node,property,value){node[property]=value;dispatch_dev("SvelteDOMSetProperty",{node,property,value})}function dataset_dev(node,property,value){node.dataset[property]=value;dispatch_dev("SvelteDOMSetDataset",{node,property,value})}function set_data_dev(text2,data){data=""+data;if(text2.data!==data){dispatch_dev("SvelteDOMSetData",{node:text2,data});text2.data=data}}function set_data_contenteditable_dev(text2,data){data=""+data;if(text2.wholeText!==data){dispatch_dev("SvelteDOMSetData",{node:text2,data});text2.data=data}}function set_data_maybe_contenteditable_dev(text2,data,attr_value){if(~contenteditable_truthy_values.indexOf(attr_value))set_data_contenteditable_dev(text2,data);else set_data_dev(text2,data)}function ensure_array_like_dev(arg){if(!("string"==typeof arg||arg&&"object"==typeof arg&&"length"in arg||"function"==typeof Symbol&&arg&&Symbol.iterator in arg))throw new Error("{#each} only works with iterable values.");return ensure_array_like(arg)}function validate_slots(name,slot,keys2){for(const slot_key of Object.keys(slot))if(!~keys2.indexOf(slot_key))console.warn(`<${name}> received an unexpected slot "${slot_key}".`)}function validate_dynamic_element(tag){if(tag&&!("string"==typeof tag))throw new Error('<svelte:element> expects "this" attribute to be a string.')}function validate_void_dynamic_element(tag){if(tag&&is_void(tag))console.warn(`<svelte:element this="${tag}"> is self-closing and cannot have content.`)}function construct_svelte_component_dev(component,props){const error_message="this={...} of <svelte:component> should specify a Svelte component.";try{const instance8=new component(props);if(!(instance8.$$&&instance8.$set&&instance8.$on&&instance8.$destroy))throw new Error(error_message);return instance8}catch(err2){const{message}=err2;if("string"==typeof message&&-1!==message.indexOf("is not a constructor"))throw new Error(error_message);else throw err2}}var SvelteComponentDev=class extends SvelteComponent{constructor(options){if(!options||!options.target&&!options.$$inline)throw new Error("'target' is a required option");super();__publicField(this,"$$prop_def");__publicField(this,"$$events_def");__publicField(this,"$$slot_def")}$destroy(){super.$destroy();this.$destroy=()=>{console.warn("Component was already destroyed")}}$capture_state(){}$inject_state(){}},SvelteComponentTyped=class extends SvelteComponentDev{};function loop_guard(timeout){const start=Date.now();return()=>{if(Date.now()-start>timeout)throw new Error("Infinite loop detected")}}if("undefined"!=typeof window)(window.__svelte||(window.__svelte={v:new Set})).v.add(PUBLIC_VERSION);function add_css(target){append_styles(target,"svelte-1j0mkaj",".svelte-1j0mkaj.svelte-1j0mkaj{box-sizing:border-box}.logpane.svelte-1j0mkaj.svelte-1j0mkaj{display:flex;height:100%;flex-direction:column}.log.svelte-1j0mkaj.svelte-1j0mkaj{overflow-y:scroll;user-select:text;padding-bottom:2em}.log.svelte-1j0mkaj>pre.svelte-1j0mkaj{margin:0}.log.svelte-1j0mkaj>pre.wrap-right.svelte-1j0mkaj{word-break:break-all;max-width:100%;width:100%;white-space:normal}.row.svelte-1j0mkaj.svelte-1j0mkaj{display:flex;flex-direction:row;justify-content:flex-end}.row.svelte-1j0mkaj>label.svelte-1j0mkaj{display:flex;align-items:center;min-width:5em;margin-right:1em}")}function get_each_context(ctx,list,i2){const child_ctx=ctx.slice();child_ctx[11]=list[i2];return child_ctx}function create_each_block(ctx){let pre,t4,t_value=ctx[11]+"";return{c(){pre=element("pre");t4=text(t_value);attr(pre,"class","svelte-1j0mkaj");toggle_class(pre,"wrap-right",ctx[1])},m(target,anchor){insert(target,pre,anchor);append(pre,t4)},p(ctx2,dirty){if(1&dirty&&t_value!==(t_value=ctx2[11]+""))set_data(t4,t_value);if(2&dirty)toggle_class(pre,"wrap-right",ctx2[1])},d(detaching){if(detaching)detach(pre)}}}function create_fragment(ctx){let div3,div1,div0,label0,input0,span0,t1,label1,input1,span1,t32,label2,input2,span2,t5,div2,mounted,dispose,each_value=ensure_array_like(ctx[0]),each_blocks=[];for(let i2=0;i2<each_value.length;i2+=1)each_blocks[i2]=create_each_block(get_each_context(ctx,each_value,i2));return{c(){div3=element("div");div1=element("div");div0=element("div");label0=element("label");input0=element("input");span0=element("span");span0.textContent="Wrap";t1=space();label1=element("label");input1=element("input");span1=element("span");span1.textContent="Auto scroll";t32=space();label2=element("label");input2=element("input");span2=element("span");span2.textContent="Pause";t5=space();div2=element("div");for(let i2=0;i2<each_blocks.length;i2+=1)each_blocks[i2].c();attr(input0,"type","checkbox");attr(input0,"class","svelte-1j0mkaj");attr(span0,"class","svelte-1j0mkaj");attr(label0,"class","svelte-1j0mkaj");attr(input1,"type","checkbox");attr(input1,"class","svelte-1j0mkaj");attr(span1,"class","svelte-1j0mkaj");attr(label1,"class","svelte-1j0mkaj");attr(input2,"type","checkbox");attr(input2,"class","svelte-1j0mkaj");attr(span2,"class","svelte-1j0mkaj");attr(label2,"class","svelte-1j0mkaj");attr(div0,"class","row svelte-1j0mkaj");attr(div1,"class","control svelte-1j0mkaj");attr(div2,"class","log svelte-1j0mkaj");attr(div3,"class","logpane svelte-1j0mkaj")},m(target,anchor){insert(target,div3,anchor);append(div3,div1);append(div1,div0);append(div0,label0);append(label0,input0);input0.checked=ctx[1];append(label0,span0);append(div0,t1);append(div0,label1);append(label1,input1);input1.checked=ctx[2];append(label1,span1);append(div0,t32);append(div0,label2);append(label2,input2);input2.checked=ctx[3];append(label2,span2);append(div3,t5);append(div3,div2);for(let i2=0;i2<each_blocks.length;i2+=1)if(each_blocks[i2])each_blocks[i2].m(div2,null);ctx[8](div2);if(!mounted){dispose=[listen(input0,"change",ctx[5]),listen(input1,"change",ctx[6]),listen(input2,"change",ctx[7])];mounted=true}},p(ctx2,[dirty]){if(2&dirty)input0.checked=ctx2[1];if(4&dirty)input1.checked=ctx2[2];if(8&dirty)input2.checked=ctx2[3];if(3&dirty){each_value=ensure_array_like(ctx2[0]);let i2;for(i2=0;i2<each_value.length;i2+=1){const child_ctx=get_each_context(ctx2,each_value,i2);if(each_blocks[i2])each_blocks[i2].p(child_ctx,dirty);else{each_blocks[i2]=create_each_block(child_ctx);each_blocks[i2].c();each_blocks[i2].m(div2,null)}}for(;i2<each_blocks.length;i2+=1)each_blocks[i2].d(1);each_blocks.length=each_value.length}},i:noop2,o:noop2,d(detaching){if(detaching)detach(div3);destroy_each(each_blocks,detaching);ctx[8](null);mounted=false;run_all(dispose)}}}function instance($$self,$$props,$$invalidate){let unsubscribe,scroll,messages=[],wrapRight=false,autoScroll=true,suspended=false;function updateLog(logs){const e4=logs.value;if(!suspended){$$invalidate(0,messages=[...e4]);setTimeout((()=>{if(scroll)$$invalidate(4,scroll.scrollTop=scroll.scrollHeight,scroll)}),10)}}onMount((async()=>{logMessages.onChanged(updateLog);Logger("Log window opened");unsubscribe=()=>logMessages.offChanged(updateLog)}));onDestroy((()=>{if(unsubscribe)unsubscribe()}));return[messages,wrapRight,autoScroll,suspended,scroll,function input0_change_handler(){wrapRight=this.checked;$$invalidate(1,wrapRight)},function input1_change_handler(){autoScroll=this.checked;$$invalidate(2,autoScroll)},function input2_change_handler(){suspended=this.checked;$$invalidate(3,suspended)},function div2_binding($$value){binding_callbacks[$$value?"unshift":"push"]((()=>{scroll=$$value;$$invalidate(4,scroll)}))}]}var LogPane=class extends SvelteComponent{constructor(options){super();init(this,options,instance,create_fragment,safe_not_equal,{},add_css)}},LogPane_default=LogPane,import_obsidian3=require("obsidian"),VIEW_TYPE_LOG="log-log",LogPaneView=class extends import_obsidian3.ItemView{constructor(leaf,plugin3){super(leaf);this.icon="view-log";this.title="";this.navigation=true;this.plugin=plugin3}getIcon(){return"view-log"}getViewType(){return VIEW_TYPE_LOG}getDisplayText(){return"Self-hosted LiveSync Log"}async onOpen(){this.component=new LogPane_default({target:this.contentEl,props:{}});await Promise.resolve()}async onClose(){var _a5;null==(_a5=this.component)||_a5.$destroy();await Promise.resolve()}};setGlobalLogFunction(((message,level,key2)=>{const entry={message,level,key:key2};logStore.enqueue(entry)}));var recentLogs=[],recentLogProcessor=new QueueProcessor((logs=>{recentLogs=[...recentLogs,...logs].splice(-200);logMessages.value=recentLogs}),{batchSize:25,delay:10,suspended:false,concurrentLimit:1}).resumePipeLine(),showDebugLog=false,MARK_DONE="",ModuleLog=class extends AbstractObsidianModule{constructor(){super(...arguments);this.registerView=this.plugin.registerView.bind(this.plugin);this.statusLog=reactiveSource("");this.notifies={};this.nextFrameQueue=void 0;this.logLines=[]}observeForLogs(){const padSpaces="".repeat(10);function padLeftSpComputed(numI,mark){const formatted=reactiveSource("");let timer,maxLen=1;numI.onChanged((numX=>{const num=numX.value,numLen=`${Math.abs(num)}`.length+1;maxLen=maxLen<numLen?numLen:maxLen;if(timer)clearTimeout(timer);if(0==num)timer=setTimeout((()=>{formatted.value="";maxLen=1}),3e3);formatted.value=` ${mark}${`${padSpaces}${num}`.slice(-maxLen)}`}));return computed((()=>formatted.value))}const labelReplication=padLeftSpComputed(this.core.replicationResultCount,""),labelDBCount=padLeftSpComputed(this.core.databaseQueueCount,""),labelStorageCount=padLeftSpComputed(this.core.storageApplyingCount,""),labelChunkCount=padLeftSpComputed(collectingChunks,""),labelPluginScanCount=padLeftSpComputed(pluginScanningCount,""),labelConflictProcessCount=padLeftSpComputed(this.core.conflictProcessQueueCount,""),labelHiddenFilesCount=padLeftSpComputed(reactive((()=>hiddenFilesEventCount.value-hiddenFilesProcessingCount.value)),""),queueCountLabelX=reactive((()=>`${labelReplication()}${labelDBCount()}${labelStorageCount()}${labelChunkCount()}${labelPluginScanCount()}${labelHiddenFilesCount()}${labelConflictProcessCount()}`)),requestingStatLabel=computed((()=>0!=this.core.requestCount.value-this.core.responseCount.value?" ":"")),replicationStatLabel=computed((()=>{const e4=this.core.replicationStat.value,sent=e4.sent,arrived=e4.arrived,maxPullSeq=e4.maxPullSeq,maxPushSeq=e4.maxPushSeq,lastSyncPullSeq=e4.lastSyncPullSeq,lastSyncPushSeq=e4.lastSyncPushSeq;let pushLast="",pullLast="",w2="";const labels={CONNECTED:"",JOURNAL_SEND:"",JOURNAL_RECEIVE:""};switch(e4.syncStatus){case"CLOSED":case"COMPLETED":case"NOT_CONNECTED":w2="";break;case"STARTED":w2="";break;case"PAUSED":w2="";break;case"CONNECTED":case"JOURNAL_SEND":case"JOURNAL_RECEIVE":w2=labels[e4.syncStatus]||"";pushLast=0==lastSyncPushSeq?"":lastSyncPushSeq>=maxPushSeq?" (LIVE)":` (${maxPushSeq-lastSyncPushSeq})`;pullLast=0==lastSyncPullSeq?"":lastSyncPullSeq>=maxPullSeq?" (LIVE)":` (${maxPullSeq-lastSyncPullSeq})`;break;case"ERRORED":w2="";break;default:w2="?"}return{w:w2,sent,pushLast,arrived,pullLast}})),labelProc=padLeftSpComputed(this.core.processing,""),labelPend=padLeftSpComputed(this.core.totalQueued,""),labelInBatchDelay=padLeftSpComputed(this.core.batched,""),waitingLabel=computed((()=>`${labelProc()}${labelPend()}${labelInBatchDelay()}`)),statusLineLabel=computed((()=>{const{w:w2,sent,pushLast,arrived,pullLast}=replicationStatLabel(),queued=queueCountLabelX.value,waiting=waitingLabel();return{message:`${requestingStatLabel()}Sync: ${w2}  ${sent}${pushLast}  ${arrived}${pullLast}${waiting}${queued}`}})),statusBarLabels=reactive((()=>{const scheduleMessage=this.core.$$isReloadingScheduled()?"WARNING! RESTARTING OBSIDIAN IS SCHEDULED!\n":"",{message}=statusLineLabel();return{message,status:scheduleMessage+this.statusLog.value}}));this.statusBarLabels=statusBarLabels;const applyToDisplay=throttle((label=>{this.applyStatusBarText()}),20);statusBarLabels.onChanged((label=>applyToDisplay(label.value)))}$everyOnload(){eventHub.onEvent(EVENT_LEAF_ACTIVE_CHANGED,(()=>this.onActiveLeafChange()));eventHub.onceEvent(EVENT_LAYOUT_READY,(()=>this.onActiveLeafChange()));return Promise.resolve(true)}adjustStatusDivPosition(){const mdv=this.app.workspace.getMostRecentLeaf();if(mdv&&this.statusDiv){this.statusDiv.remove();const container=mdv.view.containerEl;container.insertBefore(this.statusDiv,container.lastChild)}}async getActiveFileStatus(){const thisFile=this.app.workspace.getActiveFile();if(!thisFile)return"";if(this.core.$$shouldCheckCaseInsensitive())if(this.core.storageAccess.getFiles().map((e4=>e4.path)).filter((e4=>e4.toLowerCase()==thisFile.path.toLowerCase())).length>1)return"Not synchronised: There are multiple files with the same name";if(!await this.core.$$isTargetFile(thisFile.path))return"Not synchronised: not a target file";if(this.core.$$isFileSizeExceeded(thisFile.stat.size))return"Not synchronised: File size exceeded";else return""}async setFileStatus(){this.messageArea.innerText=await this.getActiveFileStatus()}onActiveLeafChange(){fireAndForget((async()=>{this.adjustStatusDivPosition();await this.setFileStatus()}))}applyStatusBarText(){if(!this.nextFrameQueue){this.nextFrameQueue=requestAnimationFrame((()=>{var _a5,_b2,_c2;this.nextFrameQueue=void 0;const{message,status}=this.statusBarLabels.value,newMsg=message;let newLog=(null==(_a5=this.settings)?void 0:_a5.showOnlyIconsOnEditor)?"":status;const moduleTagEnd=newLog.indexOf("]");if(-1!=moduleTagEnd)newLog=newLog.substring(moduleTagEnd+2);null==(_b2=this.statusBar)||_b2.setText(newMsg.split("\n")[0]);if((null==(_c2=this.settings)?void 0:_c2.showStatusOnEditor)&&this.statusDiv){if(this.settings.showLongerLogInsideEditor){const now2=(new Date).getTime();this.logLines=this.logLines.filter((e4=>e4.ttl>now2));const minimumNext=this.logLines.reduce(((a2,b3)=>a2<b3.ttl?a2:b3.ttl),Number.MAX_SAFE_INTEGER);if(this.logLines.length>0)setTimeout((()=>this.applyStatusBarText()),minimumNext-now2);const recentLogs2=this.logLines.map((e4=>e4.message)).reverse().join("\n");if(isDirty("recentLogs",recentLogs2))this.logHistory.innerText=recentLogs2}if(isDirty("newMsg",newMsg))this.statusLine.innerText=newMsg;if(isDirty("newLog",newLog))this.logMessage.innerText=newLog}}));scheduleTask("log-hide",3e3,(()=>{this.statusLog.value=""}))}}$allStartOnUnload(){var _a5;if(this.statusDiv)this.statusDiv.remove();null==(_a5=document.querySelectorAll(".livesync-status"))||_a5.forEach((e4=>e4.remove()));return Promise.resolve(true)}$everyOnloadStart(){(0,import_obsidian.addIcon)("view-log",'<g transform="matrix(1.28 0 0 1.28 -131 -411)" fill="currentColor" fill-rule="evenodd">\n        <path d="m103 330h76v12h-76z"/>\n        <path d="m106 346v44h70v-44zm45 16h-20v-8h20z"/>\n       </g>');this.addRibbonIcon("view-log","Show log",(()=>{this.core.$$showView(VIEW_TYPE_LOG)})).addClass("livesync-ribbon-showlog");this.addCommand({id:"view-log",name:"Show log",callback:()=>{this.core.$$showView(VIEW_TYPE_LOG)}});this.registerView(VIEW_TYPE_LOG,(leaf=>new LogPaneView(leaf,this.plugin)));return Promise.resolve(true)}$everyOnloadAfterLoadSettings(){var _a5;logStore.pipeTo(new QueueProcessor((logs=>logs.forEach((e4=>this.core.$$addLog(e4.message,e4.level,e4.key)))),{suspended:false,batchSize:20,concurrentLimit:1,delay:0})).startPipeline();eventHub.onEvent(EVENT_FILE_RENAMED,(data=>{this.setFileStatus()}));document.querySelectorAll(".livesync-status").forEach((e4=>e4.remove()));this.observeForLogs();this.statusDiv=this.app.workspace.containerEl.createDiv({cls:"livesync-status"});this.statusLine=this.statusDiv.createDiv({cls:"livesync-status-statusline"});this.messageArea=this.statusDiv.createDiv({cls:"livesync-status-messagearea"});this.logMessage=this.statusDiv.createDiv({cls:"livesync-status-logmessage"});this.logHistory=this.statusDiv.createDiv({cls:"livesync-status-loghistory"});eventHub.onEvent(EVENT_LAYOUT_READY,(()=>this.adjustStatusDivPosition()));if(null==(_a5=this.settings)?void 0:_a5.showStatusOnStatusbar){this.statusBar=this.core.addStatusBarItem();this.statusBar.addClass("syncstatusbar")}this.adjustStatusDivPosition();return Promise.resolve(true)}writeLogToTheFile(now2,vaultName,newMessage){fireAndForget((()=>serialized("writeLog",(async()=>{const time=now2.toISOString().split("T")[0],logDate=`${PREFIXMD_LOGFILE}${time}.md`;if(!await this.core.storageAccess.isExists(normalizePath(logDate)))await this.core.storageAccess.appendHiddenFile(normalizePath(logDate),"```\n");await this.core.storageAccess.appendHiddenFile(normalizePath(logDate),vaultName+":"+newMessage+"\n")}))))}$$addLog(message,level=LOG_LEVEL_INFO,key2=""){var _a5,_b2,_c2;if(level==LOG_LEVEL_DEBUG&&!showDebugLog)return;if(level<LOG_LEVEL_INFO&&this.settings&&this.settings.lessInformationInLog)return;if(this.settings&&!this.settings.showVerboseLog&&level==LOG_LEVEL_VERBOSE)return;const vaultName=this.core.$$getVaultName(),now2=new Date,timestamp=now2.toLocaleString(),messageContent="string"==typeof message?message:message instanceof Error?`${message.name}:${message.message}`:JSON.stringify(message,null,2);if(message instanceof Error)console.dir(message.stack);const newMessage=timestamp+"->"+messageContent;console.log(vaultName+":"+newMessage);if(!(null==(_a5=this.settings)?void 0:_a5.showOnlyIconsOnEditor))this.statusLog.value=messageContent;if(null==(_b2=this.settings)?void 0:_b2.writeLogToTheFile)this.writeLogToTheFile(now2,vaultName,newMessage);recentLogProcessor.enqueue(newMessage);this.logLines.push({ttl:now2.getTime()+3e3,message:newMessage});if(level>=LOG_LEVEL_NOTICE){if(!key2)key2=messageContent;if(key2 in this.notifies){if(!(null==(_c2=this.notifies[key2].notice.noticeEl)?void 0:_c2.isShown()))this.notifies[key2].notice=new import_obsidian.Notice(messageContent,0);cancelTask(`notify-${key2}`);if(key2==messageContent){this.notifies[key2].count++;this.notifies[key2].notice.setMessage(`(${this.notifies[key2].count}):${messageContent}`)}else this.notifies[key2].notice.setMessage(`${messageContent}`)}else{const notify=new import_obsidian.Notice(messageContent,0);this.notifies[key2]={count:0,notice:notify}}const timeout=5e3;if(!key2.startsWith("keepalive-")||-1!==messageContent.indexOf(MARK_DONE))scheduleTask(`notify-${key2}`,timeout,(()=>{const notify=this.notifies[key2].notice;delete this.notifies[key2];try{notify.hide()}catch(e4){}}))}}},noticeIndex=0,LiveSyncCommands=class{constructor(plugin3){this._log=(msg,level=LOG_LEVEL_INFO,key2)=>{if("string"==typeof msg&&level!==LOG_LEVEL_NOTICE)msg=`[${this.constructor.name}] ${msg}`;Logger(msg,level,key2)};this._verbose=(msg,key2)=>{this._log(msg,LOG_LEVEL_VERBOSE,key2)};this._info=(msg,key2)=>{this._log(msg,LOG_LEVEL_INFO,key2)};this._notice=(msg,key2)=>{this._log(msg,LOG_LEVEL_NOTICE,key2)};this._progress=(prefix="",level=LOG_LEVEL_NOTICE)=>{const key2="keepalive-progress-"+noticeIndex++;return{log:msg=>{this._log(prefix+msg,level,key2)},once:msg=>{this._log(prefix+msg,level)},done:(msg="Done")=>{this._log(prefix+msg+MARK_DONE,level,key2)}}};this._debug=(msg,key2)=>{this._log(msg,LOG_LEVEL_VERBOSE,key2)};this.plugin=plugin3}get app(){return this.plugin.app}get settings(){return this.plugin.settings}get localDatabase(){return this.plugin.localDatabase}id2path(id,entry,stripPrefix2){return this.plugin.$$id2path(id,entry,stripPrefix2)}async path2id(filename,prefix){return await this.plugin.$$path2id(filename,prefix)}getPath(entry){return getPath2(entry)}_isMainReady(){return this.plugin.$$isReady()}_isMainSuspended(){return this.plugin.$$isSuspended()}_isDatabaseReady(){return this.plugin.$$isDatabaseReady()}};function add_css2(target){append_styles(target,"svelte-10t8oe0",".spacer.svelte-10t8oe0{flex-grow:1}.infos.svelte-10t8oe0{display:flex;justify-content:space-between;margin:4px 0.5em}.deleted.svelte-10t8oe0{text-decoration:line-through}.svelte-10t8oe0{box-sizing:border-box}.scroller.svelte-10t8oe0{display:flex;flex-direction:column;overflow-y:scroll;max-height:60vh;user-select:text}.json-source.svelte-10t8oe0{white-space:pre;height:auto;overflow:auto;min-height:var(--font-ui-medium);flex-grow:1}")}function get_each_context2(ctx,list,i2){const child_ctx=ctx.slice();child_ctx[28]=list[i2];return child_ctx}function get_each_context_1(ctx,list,i2){const child_ctx=ctx.slice();child_ctx[31]=list[i2];return child_ctx}function create_else_block(ctx){let div0,t0,t1,div1,table2,tr0,th0,t22,t32,td0,t4,t5,t6,td1,t7,t8,t9,tr1,th1,t10,t11,td22,t12,t13,t14,td3,t15,t16,t17,div2,t18,button,mounted,dispose,t5_value=new Date(ctx[4].mtime).toLocaleString()+"",t7_value=ctx[6].length+"",t13_value=new Date(ctx[5].mtime).toLocaleString()+"",t15_value=ctx[7].length+"",each_value_1=ensure_array_like(ctx[12]),each_blocks=[];for(let i2=0;i2<each_value_1.length;i2+=1)each_blocks[i2]=create_each_block_1(get_each_context_1(ctx,each_value_1,i2));function select_block_type_1(ctx2,dirty){if(false!=ctx2[9])return create_if_block_4;else return create_else_block_1}let current_block_type=select_block_type_1(ctx),if_block0=current_block_type(ctx),if_block1=ctx[4]._id==ctx[5]._id&&create_if_block_3(ctx),if_block2=ctx[4]._id==ctx[5]._id&&create_if_block_2(ctx),if_block3=ctx[3]&&create_if_block_1(ctx);return{c(){div0=element("div");for(let i2=0;i2<each_blocks.length;i2+=1)each_blocks[i2].c();t0=space();if_block0.c();t1=space();div1=element("div");table2=element("table");tr0=element("tr");th0=element("th");t22=text(ctx[1]);t32=space();td0=element("td");if(if_block1)if_block1.c();t4=space();t5=text(t5_value);t6=space();td1=element("td");t7=text(t7_value);t8=text(" letters");t9=space();tr1=element("tr");th1=element("th");t10=text(ctx[2]);t11=space();td22=element("td");if(if_block2)if_block2.c();t12=space();t13=text(t13_value);t14=space();td3=element("td");t15=text(t15_value);t16=text(" letters");t17=space();div2=element("div");if(if_block3)if_block3.c();t18=space();button=element("button");button.textContent="Apply";attr(div0,"class","options svelte-10t8oe0");attr(th0,"class","svelte-10t8oe0");attr(td0,"class","svelte-10t8oe0");attr(td1,"class","svelte-10t8oe0");attr(tr0,"class","svelte-10t8oe0");attr(th1,"class","svelte-10t8oe0");attr(td22,"class","svelte-10t8oe0");attr(td3,"class","svelte-10t8oe0");attr(tr1,"class","svelte-10t8oe0");attr(table2,"class","svelte-10t8oe0");attr(div1,"class","infos svelte-10t8oe0");attr(button,"class","svelte-10t8oe0");attr(div2,"class","buttons svelte-10t8oe0")},m(target,anchor){insert(target,div0,anchor);for(let i2=0;i2<each_blocks.length;i2+=1)if(each_blocks[i2])each_blocks[i2].m(div0,null);insert(target,t0,anchor);if_block0.m(target,anchor);insert(target,t1,anchor);insert(target,div1,anchor);append(div1,table2);append(table2,tr0);append(tr0,th0);append(th0,t22);append(tr0,t32);append(tr0,td0);if(if_block1)if_block1.m(td0,null);append(td0,t4);append(td0,t5);append(tr0,t6);append(tr0,td1);append(td1,t7);append(td1,t8);append(table2,t9);append(table2,tr1);append(tr1,th1);append(th1,t10);append(tr1,t11);append(tr1,td22);if(if_block2)if_block2.m(td22,null);append(td22,t12);append(td22,t13);append(tr1,t14);append(tr1,td3);append(td3,t15);append(td3,t16);insert(target,t17,anchor);insert(target,div2,anchor);if(if_block3)if_block3.m(div2,null);append(div2,t18);append(div2,button);if(!mounted){dispose=listen(button,"click",ctx[13]);mounted=true}},p(ctx2,dirty){if(5376&dirty[0]){each_value_1=ensure_array_like(ctx2[12]);let i2;for(i2=0;i2<each_value_1.length;i2+=1){const child_ctx=get_each_context_1(ctx2,each_value_1,i2);if(each_blocks[i2])each_blocks[i2].p(child_ctx,dirty);else{each_blocks[i2]=create_each_block_1(child_ctx);each_blocks[i2].c();each_blocks[i2].m(div0,null)}}for(;i2<each_blocks.length;i2+=1)each_blocks[i2].d(1);each_blocks.length=each_value_1.length}if(current_block_type===(current_block_type=select_block_type_1(ctx2))&&if_block0)if_block0.p(ctx2,dirty);else{if_block0.d(1);if_block0=current_block_type(ctx2);if(if_block0){if_block0.c();if_block0.m(t1.parentNode,t1)}}if(2&dirty[0])set_data(t22,ctx2[1]);if(ctx2[4]._id==ctx2[5]._id)if(if_block1)if_block1.p(ctx2,dirty);else{if_block1=create_if_block_3(ctx2);if_block1.c();if_block1.m(td0,t4)}else if(if_block1){if_block1.d(1);if_block1=null}if(16&dirty[0]&&t5_value!==(t5_value=new Date(ctx2[4].mtime).toLocaleString()+""))set_data(t5,t5_value);if(64&dirty[0]&&t7_value!==(t7_value=ctx2[6].length+""))set_data(t7,t7_value);if(4&dirty[0])set_data(t10,ctx2[2]);if(ctx2[4]._id==ctx2[5]._id)if(if_block2)if_block2.p(ctx2,dirty);else{if_block2=create_if_block_2(ctx2);if_block2.c();if_block2.m(td22,t12)}else if(if_block2){if_block2.d(1);if_block2=null}if(32&dirty[0]&&t13_value!==(t13_value=new Date(ctx2[5].mtime).toLocaleString()+""))set_data(t13,t13_value);if(128&dirty[0]&&t15_value!==(t15_value=ctx2[7].length+""))set_data(t15,t15_value);if(ctx2[3])if(if_block3)if_block3.p(ctx2,dirty);else{if_block3=create_if_block_1(ctx2);if_block3.c();if_block3.m(div2,t18)}else if(if_block3){if_block3.d(1);if_block3=null}},d(detaching){if(detaching){detach(div0);detach(t0);detach(t1);detach(div1);detach(t17);detach(div2)}destroy_each(each_blocks,detaching);if_block0.d(detaching);if(if_block1)if_block1.d();if(if_block2)if_block2.d();if(if_block3)if_block3.d();mounted=false;dispose()}}}function create_if_block(ctx){let div0,t1,div1,button,mounted,dispose;return{c(){div0=element("div");div0.textContent="Just for a minute, please!";t1=space();div1=element("div");button=element("button");button.textContent="Dismiss";attr(div0,"class","message svelte-10t8oe0");attr(button,"class","svelte-10t8oe0");attr(div1,"class","buttons svelte-10t8oe0")},m(target,anchor){insert(target,div0,anchor);insert(target,t1,anchor);insert(target,div1,anchor);append(div1,button);if(!mounted){dispose=listen(button,"click",ctx[13]);mounted=true}},p:noop2,d(detaching){if(detaching){detach(div0);detach(t1);detach(div1)}mounted=false;dispose()}}}function create_if_block_5(ctx){let label,input,input_value_value,t0,div,t1,label_class_value,binding_group,mounted,dispose,value_has_changed=false,t1_value=ctx[31][1]+"";binding_group=init_binding_group(ctx[24][0]);return{c(){label=element("label");input=element("input");t0=space();div=element("div");t1=text(t1_value);attr(input,"type","radio");attr(input,"name","disp");input.__value=input_value_value=ctx[31][0];set_input_value(input,input.__value);attr(input,"class","sls-setting-tab svelte-10t8oe0");attr(div,"class","sls-setting-menu-btn svelte-10t8oe0");attr(label,"class",label_class_value=null_to_empty("sls-setting-label "+(ctx[31][0]==ctx[8]?"selected":""))+" svelte-10t8oe0");binding_group.p(input)},m(target,anchor){insert(target,label,anchor);append(label,input);input.checked=input.__value===ctx[8];append(label,t0);append(label,div);append(div,t1);if(!mounted){dispose=listen(input,"change",ctx[23]);mounted=true}},p(ctx2,dirty){if(4096&dirty[0]&&input_value_value!==(input_value_value=ctx2[31][0])){input.__value=input_value_value;set_input_value(input,input.__value);value_has_changed=true}if(value_has_changed||4352&dirty[0])input.checked=input.__value===ctx2[8];if(4096&dirty[0]&&t1_value!==(t1_value=ctx2[31][1]+""))set_data(t1,t1_value);if(4352&dirty[0]&&label_class_value!==(label_class_value=null_to_empty("sls-setting-label "+(ctx2[31][0]==ctx2[8]?"selected":""))+" svelte-10t8oe0"))attr(label,"class",label_class_value)},d(detaching){if(detaching)detach(label);binding_group.r();mounted=false;dispose()}}}function create_each_block_1(ctx){let if_block_anchor,if_block=(""==ctx[31][0]||false!=ctx[10][ctx[31][0]])&&create_if_block_5(ctx);return{c(){if(if_block)if_block.c();if_block_anchor=empty()},m(target,anchor){if(if_block)if_block.m(target,anchor);insert(target,if_block_anchor,anchor)},p(ctx2,dirty){if(""==ctx2[31][0]||false!=ctx2[10][ctx2[31][0]])if(if_block)if_block.p(ctx2,dirty);else{if_block=create_if_block_5(ctx2);if_block.c();if_block.m(if_block_anchor.parentNode,if_block_anchor)}else if(if_block){if_block.d(1);if_block=null}},d(detaching){if(detaching)detach(if_block_anchor);if(if_block)if_block.d(detaching)}}}function create_else_block_1(ctx){let t4;return{c(){t4=text("NO PREVIEW")},m(target,anchor){insert(target,t4,anchor)},p:noop2,d(detaching){if(detaching)detach(t4)}}}function create_if_block_4(ctx){let div,each_value=ensure_array_like(ctx[11]),each_blocks=[];for(let i2=0;i2<each_value.length;i2+=1)each_blocks[i2]=create_each_block2(get_each_context2(ctx,each_value,i2));return{c(){div=element("div");for(let i2=0;i2<each_blocks.length;i2+=1)each_blocks[i2].c();attr(div,"class","op-scrollable json-source svelte-10t8oe0")},m(target,anchor){insert(target,div,anchor);for(let i2=0;i2<each_blocks.length;i2+=1)if(each_blocks[i2])each_blocks[i2].m(div,null)},p(ctx2,dirty){if(2048&dirty[0]){each_value=ensure_array_like(ctx2[11]);let i2;for(i2=0;i2<each_value.length;i2+=1){const child_ctx=get_each_context2(ctx2,each_value,i2);if(each_blocks[i2])each_blocks[i2].p(child_ctx,dirty);else{each_blocks[i2]=create_each_block2(child_ctx);each_blocks[i2].c();each_blocks[i2].m(div,null)}}for(;i2<each_blocks.length;i2+=1)each_blocks[i2].d(1);each_blocks.length=each_value.length}},d(detaching){if(detaching)detach(div);destroy_each(each_blocks,detaching)}}}function create_each_block2(ctx){let span,t4,span_class_value,t_value=ctx[28][1]+"";return{c(){span=element("span");t4=text(t_value);attr(span,"class",span_class_value=null_to_empty(ctx[28][0]==import_diff_match_patch.DIFF_DELETE?"deleted":ctx[28][0]==import_diff_match_patch.DIFF_INSERT?"added":"normal")+" svelte-10t8oe0")},m(target,anchor){insert(target,span,anchor);append(span,t4)},p(ctx2,dirty){if(2048&dirty[0]&&t_value!==(t_value=ctx2[28][1]+""))set_data(t4,t_value);if(2048&dirty[0]&&span_class_value!==(span_class_value=null_to_empty(ctx2[28][0]==import_diff_match_patch.DIFF_DELETE?"deleted":ctx2[28][0]==import_diff_match_patch.DIFF_INSERT?"added":"normal")+" svelte-10t8oe0"))attr(span,"class",span_class_value)},d(detaching){if(detaching)detach(span)}}}function create_if_block_3(ctx){let t0,t1,t1_value=revStringToRevNumber(ctx[4]._rev)+"";return{c(){t0=text("Rev:");t1=text(t1_value)},m(target,anchor){insert(target,t0,anchor);insert(target,t1,anchor)},p(ctx2,dirty){if(16&dirty[0]&&t1_value!==(t1_value=revStringToRevNumber(ctx2[4]._rev)+""))set_data(t1,t1_value)},d(detaching){if(detaching){detach(t0);detach(t1)}}}}function create_if_block_2(ctx){let t0,t1,t1_value=revStringToRevNumber(ctx[5]._rev)+"";return{c(){t0=text("Rev:");t1=text(t1_value)},m(target,anchor){insert(target,t0,anchor);insert(target,t1,anchor)},p(ctx2,dirty){if(32&dirty[0]&&t1_value!==(t1_value=revStringToRevNumber(ctx2[5]._rev)+""))set_data(t1,t1_value)},d(detaching){if(detaching){detach(t0);detach(t1)}}}}function create_if_block_1(ctx){let button,mounted,dispose;return{c(){button=element("button");button.textContent="Cancel";attr(button,"class","svelte-10t8oe0")},m(target,anchor){insert(target,button,anchor);if(!mounted){dispose=listen(button,"click",ctx[14]);mounted=true}},p:noop2,d(detaching){if(detaching)detach(button);mounted=false;dispose()}}}function create_fragment2(ctx){let h22,t0,t1,if_block_anchor;function select_block_type(ctx2,dirty){if(!ctx2[4]||!ctx2[5])return create_if_block;else return create_else_block}let current_block_type=select_block_type(ctx),if_block=current_block_type(ctx);return{c(){h22=element("h2");t0=text(ctx[0]);t1=space();if_block.c();if_block_anchor=empty();attr(h22,"class","svelte-10t8oe0")},m(target,anchor){insert(target,h22,anchor);append(h22,t0);insert(target,t1,anchor);if_block.m(target,anchor);insert(target,if_block_anchor,anchor)},p(ctx2,dirty){if(1&dirty[0])set_data(t0,ctx2[0]);if(current_block_type===(current_block_type=select_block_type(ctx2))&&if_block)if_block.p(ctx2,dirty);else{if_block.d(1);if_block=current_block_type(ctx2);if(if_block){if_block.c();if_block.m(if_block_anchor.parentNode,if_block_anchor)}}},i:noop2,o:noop2,d(detaching){if(detaching){detach(h22);detach(t1);detach(if_block_anchor)}if_block.d(detaching)}}}function revStringToRevNumber(rev3){if(!rev3)return"";else return rev3.split("-")[0]}function instance2($$self,$$props,$$invalidate){let mergedObjs,selectedObj,docA,docB,diffs,{docs=[]}=$$props,{callback=async(_,__)=>{Promise.resolve()}}=$$props,{filename=""}=$$props,{nameA="A"}=$$props,{nameB="B"}=$$props,{defaultSelect=""}=$$props,{keepOrder=false}=$$props,{hideLocal=false}=$$props,docAContent="",docBContent="",objA={},objB={},objAB={},objBA={},mode=defaultSelect;function docToString(doc){return"plain"==doc.datatype?getDocData(doc.data):readString(new Uint8Array(decodeBinary(doc.data)))}let modes=[];$$self.$$set=$$props2=>{if("docs"in $$props2)$$invalidate(15,docs=$$props2.docs);if("callback"in $$props2)$$invalidate(16,callback=$$props2.callback);if("filename"in $$props2)$$invalidate(0,filename=$$props2.filename);if("nameA"in $$props2)$$invalidate(1,nameA=$$props2.nameA);if("nameB"in $$props2)$$invalidate(2,nameB=$$props2.nameB);if("defaultSelect"in $$props2)$$invalidate(17,defaultSelect=$$props2.defaultSelect);if("keepOrder"in $$props2)$$invalidate(18,keepOrder=$$props2.keepOrder);if("hideLocal"in $$props2)$$invalidate(3,hideLocal=$$props2.hideLocal)};$$self.$$.update=()=>{if(8159472&$$self.$$.dirty[0])if(docs&&docs.length>=1){if(keepOrder||docs[0].mtime<docs[1].mtime){$$invalidate(4,docA=docs[0]);$$invalidate(5,docB=docs[1])}else{$$invalidate(4,docA=docs[1]);$$invalidate(5,docB=docs[0])}$$invalidate(6,docAContent=docToString(docA));$$invalidate(7,docBContent=docToString(docB));try{$$invalidate(19,objA=false);$$invalidate(20,objB=false);$$invalidate(19,objA=JSON.parse(docAContent));$$invalidate(20,objB=JSON.parse(docBContent));$$invalidate(21,objAB=mergeObject(objA,objB));$$invalidate(22,objBA=mergeObject(objB,objA));if(JSON.stringify(objAB)==JSON.stringify(objBA))$$invalidate(22,objBA=false)}catch(ex){$$invalidate(22,objBA=false);$$invalidate(21,objAB=false)}}if(7864320&$$self.$$.dirty[0])$$invalidate(10,mergedObjs={"":false,A:objA,B:objB,AB:objAB,BA:objBA});if(1280&$$self.$$.dirty[0])$$invalidate(9,selectedObj=mode in mergedObjs?mergedObjs[mode]:{});if(524800&$$self.$$.dirty[0])$$invalidate(11,diffs=function getJsonDiff(a2,b3){return function getDiff(left,right){const dmp=new import_diff_match_patch.diff_match_patch,mapLeft=dmp.diff_linesToChars_(left,right),diffLeftSrc=dmp.diff_main(mapLeft.chars1,mapLeft.chars2,false);dmp.diff_charsToLines_(diffLeftSrc,mapLeft.lineArray);return diffLeftSrc}(JSON.stringify(a2,null,2),JSON.stringify(b3,null,2))}(objA,selectedObj));if(14&$$self.$$.dirty[0]){let newModes=[];if(!hideLocal){newModes.push(["","Not now"]);newModes.push(["A",nameA||"A"])}newModes.push(["B",nameB||"B"]);newModes.push(["AB",`${nameA||"A"} + ${nameB||"B"}`]);newModes.push(["BA",`${nameB||"B"} + ${nameA||"A"}`]);$$invalidate(12,modes=newModes)}};return[filename,nameA,nameB,hideLocal,docA,docB,docAContent,docBContent,mode,selectedObj,mergedObjs,diffs,modes,function apply(){if(docA._id==docB._id){if("A"==mode)return callback(docA._rev,void 0);if("B"==mode)return callback(docB._rev,void 0)}else{if("A"==mode)return callback(void 0,docToString(docA));if("B"==mode)return callback(void 0,docToString(docB))}if("BA"==mode)return callback(void 0,JSON.stringify(objBA,null,2));if("AB"==mode)return callback(void 0,JSON.stringify(objAB,null,2));callback(void 0,void 0)},function cancel(){callback(void 0,void 0)},docs,callback,defaultSelect,keepOrder,objA,objB,objAB,objBA,function input_change_handler(){mode=this.__value;$$invalidate(8,mode)},[[]]]}var JsonResolvePane=class extends SvelteComponent{constructor(options){super();init(this,options,instance2,create_fragment2,safe_not_equal,{docs:15,callback:16,filename:0,nameA:1,nameB:2,defaultSelect:17,keepOrder:18,hideLocal:3},add_css2,[-1,-1])}},JsonResolvePane_default=JsonResolvePane,JsonResolveModal=class extends import_obsidian.Modal{constructor(app2,filename,docs,callback,nameA,nameB,defaultSelect,keepOrder,hideLocal,title="Conflicted Setting"){super(app2);this.title="Conflicted Setting";this.callback=callback;this.filename=filename;this.docs=docs;this.nameA=nameA||"";this.nameB=nameB||"";this.keepOrder=keepOrder||false;this.defaultSelect=defaultSelect||"";this.title=title;this.hideLocal=null!=hideLocal?hideLocal:false;waitForSignal(`cancel-internal-conflict:${filename}`).then((()=>this.close()))}async UICallback(keepRev,mergedStr){if(this.callback)await this.callback(keepRev,mergedStr);this.close();this.callback=void 0}onOpen(){const{contentEl}=this;this.titleEl.setText(this.title);contentEl.empty();if(null==this.component)this.component=new JsonResolvePane_default({target:contentEl,props:{docs:this.docs,filename:this.filename,nameA:this.nameA,nameB:this.nameB,defaultSelect:this.defaultSelect,keepOrder:this.keepOrder,hideLocal:this.hideLocal,callback:(keepRev,mergedStr)=>this.UICallback(keepRev,mergedStr)}})}onClose(){const{contentEl}=this;contentEl.empty();if(null!=this.callback)this.callback(void 0);if(null!=this.component){this.component.$destroy();this.component=void 0}}};function getComparingMTime(doc,includeDeleted=false){var _a5,_b2,_c2;if(null===doc)return 0;if(false===doc)return 0;if(void 0===doc)return 0;if(!includeDeleted){if("deleted"in doc&&doc.deleted)return 0;if("_deleted"in doc&&doc._deleted)return 0}if("stat"in doc)return null!=(_b2=null==(_a5=doc.stat)?void 0:_a5.mtime)?_b2:0;else return null!=(_c2=doc.mtime)?_c2:0}var HiddenFileSync=class extends LiveSyncCommands{constructor(){super(...arguments);this.periodicInternalFileScanProcessor=new PeriodicProcessor(this.plugin,(async()=>this._isThisModuleEnabled()&&this._isDatabaseReady()&&await this.scanAllStorageChanges(false)));this.shouldSkipFile=[];this.semaphore=Semaphore(10);this.conflictResolutionProcessor=new QueueProcessor((async paths=>{var _a5,_b2,_c2;const path2=paths[0];sendSignal(`cancel-internal-conflict:${path2}`);try{const id=await this.path2id(path2,ICHeader),doc=await this.localDatabase.getRaw(id,{conflicts:true});if(void 0===doc._conflicts)return[];if(0==doc._conflicts.length)return[];this._log(`Hidden file conflicted:${path2}`);const conflicts=doc._conflicts.sort(((a2,b3)=>Number(a2.split("-")[0])-Number(b3.split("-")[0]))),revA=doc._rev,revB=conflicts[0];if(path2.endsWith(".json")){const conflictedRev=conflicts[0],conflictedRevNo=Number(conflictedRev.split("-")[0]),commonBase=null!=(_c2=null==(_b2=null==(_a5=(await this.localDatabase.getRaw(id,{revs_info:true}))._revs_info)?void 0:_a5.filter((e4=>"available"==e4.status&&Number(e4.rev.split("-")[0])<conflictedRevNo)).first())?void 0:_b2.rev)?_c2:"",result=await this.plugin.localDatabase.mergeObject(path2,commonBase,doc._rev,conflictedRev);if(result){this._log(`Object merge:${path2}`,LOG_LEVEL_INFO);const filename=stripAllPrefixes(path2);await this.ensureDir(filename);const stat=await this.writeFile(filename,result);if(!stat)throw new Error(`conflictResolutionProcessor: Failed to stat file ${filename}`);await this.storeInternalFileToDatabase({path:filename,...stat});await this.extractInternalFileFromDatabase(filename);await this.localDatabase.removeRevision(id,revB);this.conflictResolutionProcessor.enqueue(path2);return[]}else this._log("Object merge is not applicable.",LOG_LEVEL_VERBOSE);return[{path:path2,revA,revB,id,doc}]}await this.resolveByNewerEntry(id,path2,doc,revA,revB);return[]}catch(ex){this._log(`Failed to resolve conflict (Hidden): ${path2}`);this._log(ex,LOG_LEVEL_VERBOSE);return[]}}),{suspended:false,batchSize:1,concurrentLimit:5,delay:10,keepResultUntilDownstreamConnected:true,yieldThreshold:10,pipeTo:new QueueProcessor((async results=>{const{id,doc,path:path2,revA,revB}=results[0],prefixedPath=addPrefix(path2,ICHeader),docAMerge=await this.localDatabase.getDBEntry(prefixedPath,{rev:revA}),docBMerge=await this.localDatabase.getDBEntry(prefixedPath,{rev:revB});if(false==docAMerge||false==docBMerge)await this.resolveByNewerEntry(id,path2,doc,revA,revB);else if(await this.showJSONMergeDialogAndMerge(docAMerge,docBMerge))this.conflictResolutionProcessor.enqueue(path2)}),{suspended:false,batchSize:1,concurrentLimit:1,delay:10,keepResultUntilDownstreamConnected:false,yieldThreshold:10})});this.queuedNotificationFiles=new Set;this.ignorePatterns=[]}_isThisModuleEnabled(){return this.plugin.settings.syncInternalFiles}get kvDB(){return this.plugin.kvDB}getConflictedDoc(path2,rev3){return this.plugin.localDatabase.getConflictedDoc(path2,rev3)}onunload(){var _a5;null==(_a5=this.periodicInternalFileScanProcessor)||_a5.disable()}onload(){this.plugin.addCommand({id:"livesync-sync-internal",name:"(re)initialise hidden files between storage and database",callback:()=>{if(this.isReady())this.initialiseInternalFileSync("safe",true)}});this.plugin.addCommand({id:"livesync-scaninternal-storage",name:"Scan hidden file changes on the storage",callback:()=>{if(this.isReady())this.scanAllStorageChanges(true)}});this.plugin.addCommand({id:"livesync-scaninternal-database",name:"Scan hidden file changes on the local database",callback:()=>{if(this.isReady())this.scanAllDatabaseChanges(true)}});this.plugin.addCommand({id:"livesync-internal-scan-offline-changes",name:"Scan and apply all offline hidden-file changes",callback:()=>{if(this.isReady())this.applyOfflineChanges(true)}});eventHub.onEvent(EVENT_SETTING_SAVED,(()=>{this.updateSettingCache()}))}async $everyOnInitializeDatabase(db){this._fileInfoLastProcessed=await autosaveCache(this.kvDB,"hidden-file-lastProcessed");this._databaseInfoLastProcessed=await autosaveCache(this.kvDB,"hidden-file-lastProcessed-database");this._fileInfoLastKnown=await autosaveCache(this.kvDB,"hidden-file-lastKnown");return true}async $everyOnDatabaseInitialized(showNotice){if(this._isThisModuleEnabled())if(0==this._fileInfoLastProcessed.size&&0==this._fileInfoLastProcessed.size){this._log("No cache found. Performing startup scan.",LOG_LEVEL_VERBOSE);await this.performStartupScan(true)}else await this.performStartupScan(showNotice);return true}async $everyBeforeReplicate(showNotice){if(this._isThisModuleEnabled()&&this._isDatabaseReady()&&this.settings.syncInternalFilesBeforeReplication&&!this.settings.watchInternalFileChanges)await this.scanAllStorageChanges();return true}$everyOnloadAfterLoadSettings(){this.updateSettingCache();return Promise.resolve(true)}updateSettingCache(){const ignorePatterns=this.settings.syncInternalFilesIgnorePatterns.replace(/\n| /g,"").split(",").filter((e4=>e4)).map((e4=>new RegExp(e4,"i")));this.ignorePatterns=ignorePatterns;this.shouldSkipFile=[];const configDir=normalizePath(this.app.vault.configDir),shouldSKip=!this.settings.usePluginSync?[]:Object.values(this.settings.pluginSyncExtendedSetting).filter((e4=>e4.mode==MODE_SELECTIVE||e4.mode==MODE_PAUSED)).map((e4=>e4.files)).flat().map((e4=>`${configDir}/${e4}`.toLowerCase()));this.shouldSkipFile=shouldSKip;this._log(`Hidden file will skip ${this.shouldSkipFile.length} files`,LOG_LEVEL_INFO)}isReady(){if(!this._isMainReady)return false;if(this._isMainSuspended())return false;if(!this._isThisModuleEnabled())return false;else return true}async performStartupScan(showNotice){await this.applyOfflineChanges(showNotice)}async $everyOnResumeProcess(){var _a5;null==(_a5=this.periodicInternalFileScanProcessor)||_a5.disable();if(this._isMainSuspended())return true;if(this._isThisModuleEnabled())await this.performStartupScan(false);this.periodicInternalFileScanProcessor.enable(this._isThisModuleEnabled()&&this.settings.syncInternalFilesInterval?1e3*this.settings.syncInternalFilesInterval:0);return true}$everyRealizeSettingSyncMode(){var _a5;null==(_a5=this.periodicInternalFileScanProcessor)||_a5.disable();if(this._isMainSuspended())return Promise.resolve(true);if(!this.plugin.$$isReady())return Promise.resolve(true);this.periodicInternalFileScanProcessor.enable(this._isThisModuleEnabled()&&this.settings.syncInternalFilesInterval?1e3*this.settings.syncInternalFilesInterval:0);const ignorePatterns=this.settings.syncInternalFilesIgnorePatterns.replace(/\n| /g,"").split(",").filter((e4=>e4)).map((e4=>new RegExp(e4,"i")));this.ignorePatterns=ignorePatterns;return Promise.resolve(true)}async $anyProcessOptionalFileEvent(path2){if(this.isReady())return await this.trackStorageFileModification(path2)}$anyGetOptionalConflictCheckMethod(path2){if(isInternalMetadata(path2)){this.queueConflictCheck(path2);return Promise.resolve(true)}return Promise.resolve(false)}async $anyProcessOptionalSyncFiles(doc){if(isInternalMetadata(doc._id)){if(this._isThisModuleEnabled()){const filename=getPath2(doc);if(await this.plugin.$$isTargetFile(filename)){await this.processReplicationResult(doc);return true}else{this._log(`Skipped (Not target:${filename})`,LOG_LEVEL_VERBOSE);return false}}return true}return false}async loadFileWithInfo(path2){var _a5,_b2;const stat=await this.plugin.storageAccess.statHidden(path2);if(!stat)return{name:null!=(_a5=path2.split("/").pop())?_a5:"",path:path2,stat:{size:0,mtime:0,ctime:0,type:"file"},isInternal:true,deleted:true,body:createBlob(new Uint8Array(0))};const content=await this.plugin.storageAccess.readHiddenFileAuto(path2);return{name:null!=(_b2=path2.split("/").pop())?_b2:"",path:path2,stat,isInternal:true,deleted:false,body:createBlob(content)}}statToKey(stat){var _a5,_b2;return`${null!=(_a5=null==stat?void 0:stat.mtime)?_a5:0}-${null!=(_b2=null==stat?void 0:stat.size)?_b2:0}`}docToKey(doc){return`${doc.mtime}-${doc.size}-${doc._rev}-${doc._deleted||doc.deleted||false?"-0":"-1"}`}async fileToStatKey(file,stat=null){if(!stat)stat=await this.plugin.storageAccess.statHidden(file);return this.statToKey(stat)}updateLastProcessedFile(file,keySrc){const key2="string"==typeof keySrc?keySrc:this.statToKey(keySrc),splitted=key2.split("-");if("0"!=splitted[0])this._fileInfoLastKnown.set(file,Number(splitted[0]));this._fileInfoLastProcessed.set(file,key2)}async updateLastProcessedAsActualFile(file,stat){if(!stat)stat=await this.plugin.storageAccess.statHidden(file);this._fileInfoLastProcessed.set(file,this.statToKey(stat))}resetLastProcessedFile(targetFiles){if(targetFiles)for(const key2 of targetFiles)this._fileInfoLastProcessed.delete(key2);else{this._log("Delete all processed mark.",LOG_LEVEL_VERBOSE);this._fileInfoLastProcessed.clear()}}getLastProcessedFileMTime(file){const key2=this._fileInfoLastKnown.get(file);if(!key2)return 0;else return key2}getLastProcessedFileKey(file){return this._fileInfoLastProcessed.get(file)}getLastProcessedDatabaseKey(file){return this._databaseInfoLastProcessed.get(file)}updateLastProcessedDatabase(file,keySrc){const key2="string"==typeof keySrc?keySrc:this.docToKey(keySrc);this._databaseInfoLastProcessed.set(file,key2)}updateLastProcessed(path2,db,stat){this.updateLastProcessedDatabase(path2,db);this.updateLastProcessedFile(path2,this.statToKey(stat));const dbMTime=getComparingMTime(db),storageMTime=getComparingMTime(stat);if(0==dbMTime||0==storageMTime)unmarkChanges(path2);else markChangesAreSame(path2,getComparingMTime(db),getComparingMTime(stat))}updateLastProcessedDeletion(path2,db){unmarkChanges(path2);if(db)this.updateLastProcessedDatabase(path2,db);this.updateLastProcessedFile(path2,this.statToKey(null))}async ensureDir(path2){if(!await this.plugin.storageAccess.isExistsIncludeHidden(path2))await this.plugin.storageAccess.ensureDir(path2)}async writeFile(path2,data,opt){await this.plugin.storageAccess.writeHiddenFileAuto(path2,data,opt);return await this.plugin.storageAccess.statHidden(path2)}async __removeFile(path2){try{if(!await this.plugin.storageAccess.isExistsIncludeHidden(path2))return"ALREADY";if(await this.plugin.storageAccess.removeHidden(path2))return"OK"}catch(ex){this._log(`Failed to remove file:${path2}`);this._log(ex,LOG_LEVEL_VERBOSE)}return false}async triggerEvent(path2){try{await this.plugin.storageAccess.triggerHiddenFile(path2)}catch(ex){this._log("Failed to call internal API(reconcileInternalFile)",LOG_LEVEL_VERBOSE);this._log(ex,LOG_LEVEL_VERBOSE)}}async updateLastProcessedAsActualDatabase(file,doc){const dbPath=addPrefix(file,ICHeader);if(!doc)doc=await this.localDatabase.getDBEntryMeta(dbPath);if(doc)this._databaseInfoLastProcessed.set(file,this.docToKey(doc))}resetLastProcessedDatabase(targetFiles){if(targetFiles)for(const key2 of targetFiles)this._databaseInfoLastProcessed.delete(key2);else{this._log("Delete all processed mark.",LOG_LEVEL_VERBOSE);this._databaseInfoLastProcessed.clear()}}async adoptCurrentStorageFilesAsProcessed(targetFiles){const allFiles=await this.scanInternalFileNames(),files=targetFiles?allFiles.filter((e4=>targetFiles.some((t4=>-1!==e4.indexOf(t4))))):allFiles;for(const file of files)await this.updateLastProcessedAsActualFile(file)}async adoptCurrentDatabaseFilesAsProcessed(targetFiles){const allFiles=await this.getAllDatabaseFiles(),files=targetFiles?allFiles.filter((e4=>targetFiles.some((t4=>-1!==e4.path.indexOf(t4))))):allFiles;for(const file of files){const path2=stripAllPrefixes(this.getPath(file));await this.updateLastProcessedAsActualDatabase(path2,file)}}async serializedForEvent(file,fn){hiddenFilesEventCount.value++;const rel=await this.semaphore.acquire();try{return await serialized(`hidden-file-event:${file}`,(async()=>{hiddenFilesProcessingCount.value++;try{return await fn()}finally{hiddenFilesProcessingCount.value--}}))}finally{rel();hiddenFilesEventCount.value--}}async useStorageFiles(files,showNotice=false,onlyNew=false){return await this.trackScannedStorageChanges(files,showNotice,onlyNew,true)}async trackScannedStorageChanges(processFiles,showNotice=false,onlyNew=false,forceWriteAll=false,includeDeleted=true){const logLevel=getLogLevel(showNotice),p2=this._progress("[ Storage -> DB ]\n",logLevel),notifyProgress=onlyInNTimes(100,(progress=>p2.log(`${progress}/${processFiles.length}`))),processes=processFiles.map((async(file,i2)=>{try{await this.trackStorageFileModification(file,onlyNew,forceWriteAll,includeDeleted);notifyProgress()}catch(ex){p2.once(`Failed to process storage change file:${file}`);this._log(ex,LOG_LEVEL_VERBOSE)}}));await Promise.all(processes);p2.done()}async scanAllStorageChanges(showNotice=false,onlyNew=false,forceWriteAll=false,includeDeleted=true){return await skipIfDuplicated("scanAllStorageChanges",(async()=>{const logLevel=getLogLevel(showNotice),p2=this._progress("[ Scanning Storage -> DB ]\n",logLevel);p2.log("Scanning storage files...");const knownNames=[...this._fileInfoLastProcessed.keys()],existNames=await this.scanInternalFileNames(),files=new Set([...knownNames,...existNames]);this._log(`Known/Exist ${knownNames.length}/${existNames.length}, Totally ${files.size} files.`,LOG_LEVEL_VERBOSE);const taskNameAndMeta=[...files].map((async e4=>[e4,await this.plugin.storageAccess.statHidden(e4)])),processFiles=(await Promise.all(taskNameAndMeta)).filter((([path2,stat])=>{if(forceWriteAll)return true;else return this.getLastProcessedFileKey(path2)!=this.statToKey(stat)})).map((([path2,stat])=>path2)),staticsMessage=`[Storage hidden file statics]\nKnown files: ${knownNames.length}\nActual files: ${existNames.length}\nAll files: ${files.size}\nOffline Changed files: ${processFiles.length}`;p2.once(staticsMessage);await this.trackScannedStorageChanges(processFiles,showNotice,onlyNew,forceWriteAll,includeDeleted);p2.done()}))}async trackStorageFileModification(path2,onlyNew=false,forceWrite=false,includeDeleted=true){if(this.shouldSkipFile.some((e4=>e4.startsWith(path2.toLowerCase())))){this._log(`Hidden file skipped: ${path2} is synchronized in customization sync.`,LOG_LEVEL_VERBOSE);return false}try{return await this.serializedForEvent(path2,(async()=>{let stat=await this.plugin.storageAccess.statHidden(path2);if(null!=stat&&"file"!=stat.type)return false;const key2=await this.fileToStatKey(path2,stat),lastKey=this.getLastProcessedFileKey(path2);if(lastKey==key2){this._log(`${path2} Already processed.`,LOG_LEVEL_DEBUG);return true}const cache=await this.loadFileWithInfo(path2);if(getComparingMTime(cache.stat)!=getComparingMTime(stat)){this._log(`Hidden file:${path2} is changed.`,LOG_LEVEL_VERBOSE);stat=cache.stat}this.updateLastProcessedFile(path2,stat);const lastIsNotFound=!lastKey||lastKey.endsWith("-0-0"),nowIsNotFound=cache.deleted,type=lastIsNotFound&&nowIsNotFound?"invalid":nowIsNotFound?"delete":"modified";if("invalid"==type)return false;const storageMTimeActual=getComparingMTime(stat),storageMTime=0==storageMTimeActual?this.getLastProcessedFileMTime(path2):storageMTimeActual;if(onlyNew){const prefixedFileName=addPrefix(path2,ICHeader),filesOnDB=await this.localDatabase.getDBEntryMeta(prefixedFileName);if(compareMTime(storageMTime,getComparingMTime(filesOnDB,includeDeleted))!=TARGET_IS_NEW){this._log(`Hidden file:${path2} is not new.`,LOG_LEVEL_VERBOSE);if(filesOnDB&&stat)this.updateLastProcessed(path2,filesOnDB,stat);return true}}if("delete"==type){this._log(`Deletion detected: ${path2}`);return await this.deleteInternalFileOnDatabase(path2,forceWrite)}else if("modified"==type){this._log(`Modification detected:${path2}`,LOG_LEVEL_VERBOSE);const result=await this.storeInternalFileToDatabase(cache,forceWrite),resultText=void 0===result?"Nothing changed":result?"Updated":"Failed";this._log(`${resultText}: ${path2} ${resultText}`,LOG_LEVEL_VERBOSE);return result}}))}catch(ex){this._log(`Failed to process hidden file:${path2}`);this._log(ex,LOG_LEVEL_VERBOSE)}return true}queueConflictCheck(path2){this.conflictResolutionProcessor.enqueue(path2)}async resolveConflictOnInternalFiles(){const conflicted=this.localDatabase.findEntries(ICHeader,ICHeaderEnd,{conflicts:true});this.conflictResolutionProcessor.suspend();try{for await(const doc of conflicted)if("_conflicts"in doc)if(isInternalMetadata(doc._id))this.conflictResolutionProcessor.enqueue(doc.path)}catch(ex){this._log("something went wrong on resolving all conflicted internal files");this._log(ex,LOG_LEVEL_VERBOSE)}await this.conflictResolutionProcessor.startPipeline().waitForAllProcessed()}async resolveByNewerEntry(id,path2,currentDoc,currentRev,conflictedRev){var _a5;const conflictedDoc=await this.localDatabase.getRaw(id,{rev:conflictedRev}),delRev=getComparingMTime(currentDoc,true)<getComparingMTime(conflictedDoc,true)?currentRev:conflictedRev;await this.localDatabase.removeRevision(id,delRev);this._log(`Older one has been deleted:${path2}`);if(0===(null==(_a5=(await this.localDatabase.getRaw(id,{conflicts:true}))._conflicts)?void 0:_a5.length))await this.extractInternalFileFromDatabase(stripAllPrefixes(path2));else this.conflictResolutionProcessor.enqueue(path2)}showJSONMergeDialogAndMerge(docA,docB){return new Promise((res2=>{this._log("Opening data-merging dialog",LOG_LEVEL_VERBOSE);const docs=[docA,docB],strippedPath=stripAllPrefixes(docA.path),storageFilePath=strippedPath,storeFilePath=strippedPath,displayFilename=`${storeFilePath}`;new JsonResolveModal(this.app,storageFilePath,[docA,docB],(async(keep,result)=>{var _a5,_b2;try{let needFlush=false;if(!result&&!keep){this._log(`Skipped merging: ${displayFilename}`);res2(false);return}if(result||keep)for(const doc of docs)if(doc._rev!=keep)if(await this.localDatabase.deleteDBEntry(this.getPath(doc),{rev:doc._rev})){this._log(`Conflicted revision has been deleted: ${displayFilename}`);needFlush=true}if(!keep&&result){if(!await this.plugin.storageAccess.isExistsIncludeHidden(storageFilePath))await this.plugin.storageAccess.ensureDir(storageFilePath);const stat=await this.writeFile(storageFilePath,result);if(!stat)throw new Error("Stat failed");const mtime=getComparingMTime(stat);await this.storeInternalFileToDatabase({path:storageFilePath,mtime,ctime:null!=(_a5=null==stat?void 0:stat.ctime)?_a5:mtime,size:null!=(_b2=null==stat?void 0:stat.size)?_b2:0},true);await this.triggerEvent(storageFilePath);this._log(`STORAGE <-- DB:${displayFilename}: written (hidden,merged)`)}if(needFlush)if(await this.extractInternalFileFromDatabase(storeFilePath,false))this._log(`STORAGE --\x3e DB:${displayFilename}: extracted (hidden,merged)`);else this._log(`STORAGE --\x3e DB:${displayFilename}: extracted (hidden,merged) Failed`);res2(true)}catch(ex){this._log("Could not merge conflicted json");this._log(ex,LOG_LEVEL_VERBOSE);res2(false)}})).open()}))}async processReplicationResult(doc){const info3=getDocProps(doc),path2=info3.path,headerLine=`Tracking DB ${info3.path} (${info3.revDisplay}) :`,ret=await this.trackDatabaseFileModification(path2,headerLine);this._log(`${headerLine} Done: ${info3.shortenedId})`,LOG_LEVEL_VERBOSE);return ret}async trackScannedDatabaseChange(processFiles,showNotice=false,onlyNew=false,forceWriteAll=false,includeDeletion=true){const logLevel=getLogLevel(showNotice),p2=this._progress("[ DB -> Storage ]\n",logLevel),notifyProgress=onlyInNTimes(100,(progress=>p2.log(`${progress}/${processFiles.length}`))),processes=processFiles.map((async file=>{try{const path2=stripAllPrefixes(this.getPath(file));await this.trackDatabaseFileModification(path2,"[Hidden file scan]",!forceWriteAll,onlyNew,file,includeDeletion);notifyProgress()}catch(ex){this._log(`Failed to process storage change file:${file}`,logLevel);this._log(ex,LOG_LEVEL_VERBOSE)}}));await Promise.all(processes);p2.done()}async applyOfflineChanges(showNotice){const logLevel=getLogLevel(showNotice);return await serialized("applyOfflineChanges",(async()=>{const p2=this._progress("[ Apply untracked changes ]\n",logLevel);this._log("Track changes.",logLevel);p2.log("Enumerating local files...");const currentStorageFiles=await this.scanInternalFileNames();p2.log("Enumerating database files...");const currentDatabaseFiles=await this.getAllDatabaseFiles(),allDatabaseMap=Object.fromEntries(currentDatabaseFiles.map((e4=>[stripAllPrefixes(getPath2(e4)),e4]))),currentDatabaseFileNames=[...Object.keys(allDatabaseMap)],untrackedLocal=currentStorageFiles.filter((e4=>!this._fileInfoLastProcessed.has(e4))),untrackedDatabase=currentDatabaseFileNames.filter((e4=>!this._databaseInfoLastProcessed.has(e4))),bothUntracked=untrackedLocal.filter((e4=>-1!==untrackedDatabase.indexOf(e4)));p2.log("Applying untracked changes...");const stat=`Tracking statics:\nLocal files: ${currentStorageFiles.length}\nDatabase files: ${currentDatabaseFileNames.length}\nUntracked local files: ${untrackedLocal.length}\nUntracked database files: ${untrackedDatabase.length}\nCommon untracked files: ${bothUntracked.length}`;p2.once(stat);const semaphores=Semaphore(10),notifyProgress=onlyInNTimes(25,(progress=>p2.log(`${progress}/${bothUntracked.length}`))),allProcesses=bothUntracked.map((async file=>{notifyProgress();const rel=await semaphores.acquire();try{const fileStat=await this.plugin.storageAccess.statHidden(file);if(null==fileStat){this._log(`Unexpected error: Failed to stat file during applyOfflineChange :${file}`);return}const dbInfo=allDatabaseMap[file];if(dbInfo.deleted||dbInfo._deleted)return;const diff=compareMTime(getComparingMTime(fileStat),getComparingMTime(dbInfo));if(diff==BASE_IS_NEW)await this.trackStorageFileModification(file,true);else if(diff==TARGET_IS_NEW)await this.trackDatabaseFileModification(file,"[Apply]",true,true,dbInfo);else if(diff==EVEN)this.updateLastProcessed(file,dbInfo,fileStat)}finally{rel()}}));await Promise.all(allProcesses);await this.scanAllStorageChanges(showNotice);await this.scanAllDatabaseChanges(showNotice);p2.done()}))}async scanAllDatabaseChanges(showNotice=false,onlyNew=false,forceWriteAll=false,includeDeletion=true){return await skipIfDuplicated("scanAllDatabaseChanges",(async()=>{const databaseFiles=await this.getAllDatabaseFiles(),files=databaseFiles.filter((e4=>{const doc=e4,key2=this.docToKey(doc),path2=stripAllPrefixes(this.getPath(doc));return this.getLastProcessedDatabaseKey(path2)!=key2})),logLevel=getLogLevel(showNotice),staticsMessage=`[Database hidden file statics]\nAll files: ${databaseFiles.length}\nOffline Changed files: ${files.length}`;this._log(staticsMessage,logLevel,"scan-changes");return await this.trackScannedDatabaseChange(files,showNotice,onlyNew,forceWriteAll,includeDeletion)}))}async useDatabaseFiles(files,showNotice=false,onlyNew=false){const logLevel=getLogLevel(showNotice),p2=this._progress("[ Scanning DB -> Storage ]\n",logLevel);p2.log("Scanning database files...");const notifyProgress=onlyInNTimes(25,(progress=>p2.log(`${progress}/${files.length}`))),processFiles=files.map((async file=>{try{const path2=stripAllPrefixes(this.getPath(file));await this.trackDatabaseFileModification(path2,"[Scanning]",true,onlyNew,file);notifyProgress()}catch(ex){this._log(`Failed to process database changes:${file}`);this._log(ex,LOG_LEVEL_VERBOSE)}}));await Promise.all(processFiles);p2.done();return true}async trackDatabaseFileModification(path2,headerLine,preventDoubleProcess=false,onlyNew=false,meta=false,includeDeletion=true){return await this.serializedForEvent(path2,(async()=>{try{const prefixedPath=addPrefix(path2,ICHeader),docMeta=meta?meta:await this.localDatabase.getDBEntryMeta(prefixedPath,{conflicts:true},true);if(false===docMeta){this._log(`${headerLine}: Failed to read detail of ${path2}`);throw new Error(`Failed to read detail ${path2}`)}if(docMeta._conflicts&&docMeta._conflicts.length>0){this.conflictResolutionProcessor.enqueue(path2);this._log(`${headerLine} Hidden file conflicted, enqueued to resolve`);return true}if(await this.extractInternalFileFromDatabase(path2,false,docMeta,preventDoubleProcess,onlyNew,includeDeletion))this._log(`${headerLine} Hidden file processed`)}catch(ex){this._log(`${headerLine} Failed to process hidden file`);this._log(ex,LOG_LEVEL_VERBOSE)}return true}))}notifyConfigChange(){const updatedFolders=[...this.queuedNotificationFiles];this.queuedNotificationFiles.clear();try{const manifests=Object.values(this.app.plugins.manifests),enabledPlugins=this.app.plugins.enabledPlugins,modifiedManifests=manifests.filter((e4=>enabledPlugins.has(e4.id))).filter((e4=>{var _a5;return updatedFolders.indexOf(null!=(_a5=null==e4?void 0:e4.dir)?_a5:"")>=0}));for(const manifest of modifiedManifests){const updatePluginId=manifest.id,updatePluginName=manifest.name;this.plugin.confirm.askInPopup(`updated-${updatePluginId}`,`Files in ${updatePluginName} has been updated!\nPress {HERE} to reload ${updatePluginName}, or press elsewhere to dismiss this message.`,(anchor=>{anchor.text="HERE";anchor.addEventListener("click",(()=>{fireAndForget((async()=>{this._log(`Unloading plugin: ${updatePluginName}`,LOG_LEVEL_NOTICE,"plugin-reload-"+updatePluginId);await this.app.plugins.unloadPlugin(updatePluginId);await this.app.plugins.loadPlugin(updatePluginId);this._log(`Plugin reloaded: ${updatePluginName}`,LOG_LEVEL_NOTICE,"plugin-reload-"+updatePluginId)}))}))}))}}catch(ex){this._log("Error on checking plugin status.");this._log(ex,LOG_LEVEL_VERBOSE)}if(updatedFolders.indexOf(this.plugin.app.vault.configDir)>=0)if(!this.plugin.$$isReloadingScheduled())this.plugin.confirm.askInPopup("updated-any-hidden","Some setting files have been modified\nPress {HERE} to schedule a reload of Obsidian, or press elsewhere to dismiss this message.",(anchor=>{anchor.text="HERE";anchor.addEventListener("click",(()=>{this.plugin.$$scheduleAppReload()}))}))}queueNotification(key2){const configDir=this.plugin.app.vault.configDir;if(!key2.startsWith(configDir))return;const dirName=key2.split("/").slice(0,-1).join("/");this.queuedNotificationFiles.add(dirName);scheduleTask("notify-config-change",1e3,(()=>{this.notifyConfigChange()}))}async rebuildMerging(showNotice,targetFiles=false){const logLevel=getLogLevel(showNotice),p2=this._progress("[ Rebuild by Merge ]\n",logLevel);this._log("Rebuilding hidden files from the storage and the local database.",logLevel);p2.log("Enumerating local files...");const currentStorageFilesAll=await this.scanInternalFileNames(),currentStorageFiles=targetFiles?currentStorageFilesAll.filter((e4=>targetFiles.some((f4=>f4==e4)))):currentStorageFilesAll;p2.log("Enumerating database files...");const allDatabaseFiles=await this.getAllDatabaseFiles(),allDatabaseMap=new Map(allDatabaseFiles.map((e4=>[stripAllPrefixes(getPath2(e4)),e4]))),currentDatabaseFiles=targetFiles?allDatabaseFiles.filter((e4=>targetFiles.some((f4=>f4==stripAllPrefixes(getPath2(e4)))))):allDatabaseFiles,allFileNames=new Set([...currentStorageFiles,...currentDatabaseFiles.map((e4=>stripAllPrefixes(getPath2(e4))))]),storageToDatabase=[],databaseToStorage=[],eachProgress=onlyInNTimes(100,(progress=>p2.log(`Checking ${progress}/${allFileNames.size}`)));for(const file of allFileNames){eachProgress();const mtimeStorage=getComparingMTime(await this.plugin.storageAccess.statHidden(file)),dbEntry=allDatabaseMap.get(file),diff=compareMTime(mtimeStorage,getComparingMTime(dbEntry));if(diff==BASE_IS_NEW)storageToDatabase.push(file);else if(diff==TARGET_IS_NEW)databaseToStorage.push(dbEntry);else if(diff==EVEN)storageToDatabase.push(file)}p2.once(`Storage to Database: ${storageToDatabase.length} files\n Database to Storage: ${databaseToStorage.length} files`);this.resetLastProcessedDatabase(targetFiles);this.resetLastProcessedFile(targetFiles);const processes=[this.useStorageFiles(storageToDatabase,showNotice,false),this.useDatabaseFiles(databaseToStorage,showNotice,false)];p2.log("Start processing...");await Promise.all(processes);p2.done();return[...allFileNames]}async rebuildFromStorage(showNotice,targetFiles=false,onlyNew=false){const logLevel=getLogLevel(showNotice);this._verbose("Rebuilding hidden files from the storage.");this._log("Rebuilding hidden files from the storage.",logLevel);const p2=this._progress("[ Rebuild by Storage ]\n",logLevel);p2.log("Enumerating local files...");const currentFilesAll=await this.scanInternalFileNames(),currentFiles=targetFiles?currentFilesAll.filter((e4=>targetFiles.some((f4=>f4==e4)))):currentFilesAll;p2.once(`Storage to Database: ${currentFiles.length} files.`);p2.log("Start processing...");this.resetLastProcessedFile(targetFiles);await this.useStorageFiles(currentFiles,showNotice,onlyNew);p2.done();return currentFiles}async getAllDatabaseFiles(){return(await this.localDatabase.allDocsRaw({startkey:ICHeader,endkey:ICHeaderEnd,include_docs:true})).rows.filter((e4=>isInternalMetadata(e4.id))).map((e4=>e4.doc))}async rebuildFromDatabase(showNotice,targetFiles=false,onlyNew=false){const logLevel=getLogLevel(showNotice);this._verbose("Rebuilding hidden files from the local database.");const p2=this._progress("[ Rebuild by Database ]\n",logLevel);p2.log("Enumerating database files...");const allFiles=await this.getAllDatabaseFiles(),currentFiles=targetFiles?allFiles.filter((e4=>targetFiles.some((f4=>f4==stripAllPrefixes(getPath2(e4)))))):allFiles;p2.once(`Database to Storage: ${currentFiles.length} files.`);this.resetLastProcessedDatabase(targetFiles);p2.log("Start processing...");await this.useDatabaseFiles(currentFiles,showNotice,onlyNew);p2.done();return currentFiles}async initialiseInternalFileSync(direction,showMessage,targetFilesSrc=false){const logLevel=showMessage?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,p2=this._progress("[ Initialise]\n",logLevel);p2.log("Initialising hidden files sync...");const targetFiles=targetFilesSrc?targetFilesSrc.map((e4=>stripAllPrefixes(e4))):false;if("pushForce"==direction||"push"==direction){const onlyNew="push"==direction;p2.log("Started: Storage --\x3e Database "+(onlyNew?"(Only New)":""));const updatedFiles=await this.rebuildFromStorage(showMessage,targetFiles,onlyNew);await this.adoptCurrentStorageFilesAsProcessed(updatedFiles);await this.adoptCurrentDatabaseFilesAsProcessed(updatedFiles);await this.scanAllStorageChanges(showMessage,true,false);await this.scanAllDatabaseChanges(showMessage,true,false)}if("pullForce"==direction||"pull"==direction){const onlyNew="pull"==direction;p2.log("Started: Database --\x3e Storage "+(onlyNew?"(Only New)":""));const updatedFiles=(await this.rebuildFromDatabase(showMessage,targetFiles,onlyNew)).map((e4=>stripAllPrefixes(getPath2(e4))));await this.adoptCurrentStorageFilesAsProcessed(updatedFiles);await this.adoptCurrentDatabaseFilesAsProcessed(updatedFiles);await this.scanAllDatabaseChanges(showMessage,true,false);await this.scanAllStorageChanges(showMessage,true,false)}if("safe"==direction){p2.log("Started: Database <--\x3e Storage (by modified date)");const updatedFiles=await this.rebuildMerging(showMessage,targetFiles);await this.adoptCurrentStorageFilesAsProcessed(updatedFiles);await this.adoptCurrentDatabaseFilesAsProcessed(updatedFiles);await this.scanAllStorageChanges(showMessage,true,false);await this.scanAllDatabaseChanges(showMessage,true,false)}p2.done()}async __loadBaseSaveData(file,includeContent=true){const prefixedFileName=addPrefix(file,ICHeader),id=await this.path2id(prefixedFileName,ICHeader);try{const old=includeContent?await this.localDatabase.getDBEntry(prefixedFileName,void 0,false,true):await this.localDatabase.getDBEntryMeta(prefixedFileName,{conflicts:true},true);if(false===old)return{_id:id,data:[],path:prefixedFileName,mtime:0,ctime:0,datatype:"newnote",children:[],size:0,deleted:false,type:"newnote",eden:{}};else return old}catch(ex){this._log("Getting base save data failed");this._log(ex,LOG_LEVEL_VERBOSE);return false}}async storeInternalFileToDatabase(file,forceWrite=false){const storeFilePath=stripAllPrefixes(file.path),storageFilePath=file.path;if(await this.plugin.$$isIgnoredByIgnoreFiles(storageFilePath))return;const prefixedFileName=addPrefix(storeFilePath,ICHeader);return await serialized("file-"+prefixedFileName,(async()=>{try{const fileInfo="stat"in file&&"body"in file?file:await this.loadFileWithInfo(storeFilePath);if(fileInfo.deleted)throw new Error(`Hidden file:${storeFilePath} is deleted. This should not be occurred.`);const baseData=await this.__loadBaseSaveData(storeFilePath,true);if(false===baseData)throw new Error("Failed to load base data");if(baseData._rev&&!forceWrite)if(await isDocContentSame(readAsBlob(baseData),fileInfo.body)){this.updateLastProcessed(storeFilePath,baseData,fileInfo.stat);return}const saveData={...baseData,data:fileInfo.body,mtime:fileInfo.stat.mtime,size:fileInfo.stat.size,children:[],deleted:false,type:baseData.datatype},ret=await this.localDatabase.putDBEntry(saveData);if(ret&&ret.ok){saveData._rev=ret.rev;this.updateLastProcessed(storeFilePath,saveData,fileInfo.stat)}const success=ret&&ret.ok;this._log(`STORAGE --\x3e DB:${storageFilePath}: (hidden) ${success?"Done":"Failed"}`);return success}catch(ex){this._log(`STORAGE --\x3e DB:${storageFilePath}: (hidden) Failed`);this._log(ex,LOG_LEVEL_VERBOSE);return false}}))}async deleteInternalFileOnDatabase(filenameSrc,forceWrite=false){const storeFilePath=filenameSrc,storageFilePath=filenameSrc,displayFileName=filenameSrc,prefixedFileName=addPrefix(storeFilePath,ICHeader),mtime=(new Date).getTime();if(!await this.plugin.$$isIgnoredByIgnoreFiles(storageFilePath))return await serialized("file-"+prefixedFileName,(async()=>{try{const baseData=await this.__loadBaseSaveData(storeFilePath,false);if(false===baseData)throw new Error("Failed to load base data during deleting");if(void 0!==baseData._conflicts)for(const conflictRev of baseData._conflicts){await this.localDatabase.removeRevision(baseData._id,conflictRev);this._log(`STORAGE -x> DB: ${displayFileName}: (hidden) conflict removed ${baseData._rev} =>  ${conflictRev}`,LOG_LEVEL_VERBOSE)}if(baseData.deleted){this._log(`STORAGE -x> DB: ${displayFileName}: (hidden) already deleted`,LOG_LEVEL_VERBOSE);this.updateLastProcessedDeletion(storeFilePath,baseData);return true}const saveData={...baseData,mtime,size:0,children:[],deleted:true,type:baseData.datatype},ret=await this.localDatabase.putRaw(saveData);if(ret&&ret.ok){this._log(`STORAGE -x> DB: ${displayFileName}: (hidden) Done`);saveData._rev=ret.rev;this.updateLastProcessedDeletion(storeFilePath,saveData);return true}else{this._log(`STORAGE -x> DB: ${displayFileName}: (hidden) Failed`);return false}}catch(ex){this._log(`STORAGE -x> DB: ${displayFileName}: (hidden) Failed`);this._log(ex,LOG_LEVEL_VERBOSE);return false}}))}async extractInternalFileFromDatabase(storageFilePath,force=false,metaEntry,preventDoubleProcess=true,onlyNew=false,includeDeletion=true){const prefixedFileName=addPrefix(storageFilePath,ICHeader);if(!await this.plugin.$$isIgnoredByIgnoreFiles(storageFilePath))return await serialized("file-"+prefixedFileName,(async()=>{var _a5,_b2;try{const metaOnDB=metaEntry?metaEntry:await this.localDatabase.getDBEntryMeta(prefixedFileName,{conflicts:true},true);if(false===metaOnDB)throw new Error(`File not found on database.:${storageFilePath}`);if(null==(_a5=null==metaOnDB?void 0:metaOnDB._conflicts)?void 0:_a5.length){this._log(`Hidden file ${storageFilePath} has conflicted revisions, to keep in safe, writing to storage has been prevented`,LOG_LEVEL_INFO);return false}if(preventDoubleProcess){const key2=this.docToKey(metaOnDB);if(this.getLastProcessedDatabaseKey(storageFilePath)==key2&&!force){this._log(`STORAGE <-- DB: ${storageFilePath}: skipped (hidden, overwrite${force?", force":""}) (Previously processed)`);return}}if(onlyNew){const dbMTime=getComparingMTime(metaOnDB,includeDeletion),storageStat=await this.plugin.storageAccess.statHidden(storageFilePath),storageMTimeActual=null!=(_b2=null==storageStat?void 0:storageStat.mtime)?_b2:0;if(compareMTime(0==storageMTimeActual?this.getLastProcessedFileMTime(storageFilePath):storageMTimeActual,dbMTime)!=TARGET_IS_NEW){this._log(`STORAGE <-- DB: ${storageFilePath}: skipped (hidden, overwrite${force?", force":""}) (Not new)`);this.updateLastProcessedDatabase(storageFilePath,metaOnDB);if(storageStat)this.updateLastProcessedFile(storageFilePath,storageStat);return}}if(metaOnDB.deleted||metaOnDB._deleted||false){const result=await this._deleteFile(storageFilePath);if("OK"==result){this.updateLastProcessedDeletion(storageFilePath,metaOnDB);return true}else if("ALREADY"==result){this.updateLastProcessedDatabase(storageFilePath,metaOnDB);return true}return false}else{const fileOnDB=await this.localDatabase.getDBEntryFromMeta(metaOnDB,{},false,true,true);if(false===fileOnDB)throw new Error(`Failed to read file from database:${storageFilePath}`);const resultStat=await this._writeFile(storageFilePath,fileOnDB,force);if(resultStat){this.updateLastProcessed(storageFilePath,metaOnDB,resultStat);this.queueNotification(storageFilePath);this._log(`STORAGE <-- DB: ${storageFilePath}: written (hidden, overwrite${force?", force":""}) Done`);return true}}return false}catch(ex){this._log(`STORAGE <-- DB: ${storageFilePath}: written (hidden, overwrite${force?", force":""}) Failed`);this._log(ex,LOG_LEVEL_VERBOSE);return false}}))}async __checkIsNeedToWriteFile(storageFilePath,content){try{const storageContent=await this.plugin.storageAccess.readHiddenFileAuto(storageFilePath);return!await isDocContentSame(storageContent,content)}catch(ex){this._log(`Cannot check the content of ${storageFilePath}`);this._log(ex,LOG_LEVEL_VERBOSE);return true}}async _writeFile(storageFilePath,fileOnDB,force){try{const statBefore=await this.plugin.storageAccess.statHidden(storageFilePath),isExist=null!=statBefore,writeContent=readContent(fileOnDB);await this.ensureDir(storageFilePath);if(!(force||!isExist||isExist&&await this.__checkIsNeedToWriteFile(storageFilePath,writeContent))){this._log(`STORAGE <-- DB: ${storageFilePath}: skipped (hidden) Not changed`,LOG_LEVEL_DEBUG);return statBefore}const writeResultStat=await this.writeFile(storageFilePath,writeContent,{mtime:fileOnDB.mtime,ctime:fileOnDB.ctime});if(null==writeResultStat){this._log(`STORAGE <-- DB: ${storageFilePath}: written (hidden,new${force?", force":""}) Failed (writeResult)`);return false}this._log(`STORAGE <-- DB: ${storageFilePath}: written (hidden, overwrite${force?", force":""})`);return writeResultStat}catch(ex){this._log(`STORAGE <-- DB: ${storageFilePath}: written (hidden, overwrite${force?", force":""}) Failed`);this._log(ex,LOG_LEVEL_VERBOSE);return false}}async _deleteFile(storageFilePath){const result=await this.__removeFile(storageFilePath);if(false===result){this._log(`STORAGE <x- DB: ${storageFilePath}: deleting (hidden) Failed`);return false}if("OK"===result)await this.triggerEvent(storageFilePath);this._log(`STORAGE <x- DB: ${storageFilePath}: deleting (hidden) ${"OK"==result?"Done":"Already not found"}`);return result}async $allAskUsingOptionalSyncFeature(opt){await this._askHiddenFileConfiguration(opt);return true}async _askHiddenFileConfiguration(opt){const message=`Would you like to enable **Hidden File Synchronization**?\n\n> [!DETAILS]-\n> This feature allows you to synchronize all hidden files without any user interaction.\n> To enable this feature, you should choose one of the following options:\n${opt.enableFetch?"> - Fetch: Use the files stored from other devices. Choose this option if you have already configured hidden file synchronization on those devices and wish to accept their files.\n":""}${opt.enableOverwrite?"> - Overwrite: Use the files from this device. Select this option if you want to overwrite the files stored on other devices.\n":""}> - Merge: Merge the files from this device with those on other devices. Choose this option if you wish to combine files from multiple sources.\n>  However, please be reminded that merging may cause conflicts if the files are not identical. Additionally, this process may occur within the same folder, potentially breaking your plug-in or theme settings that comprise multiple files.\n\n\n> [!IMPORTANT]\n> Please keep in mind that enabling this feature alongside customisation sync may override certain behaviors.`,choices=[];if(null==opt?void 0:opt.enableFetch)choices.push("Fetch");if(null==opt?void 0:opt.enableOverwrite)choices.push("Overwrite");choices.push("Merge");choices.push("Disable");const ret=await this.plugin.confirm.confirmWithMessage("Hidden file sync",message,choices,"Disable",40);if("Fetch"==ret)await this.configureHiddenFileSync("FETCH");else if("Overwrite"==ret)await this.configureHiddenFileSync("OVERWRITE");else if("Merge"==ret)await this.configureHiddenFileSync("MERGE");else if("Disable"==ret)await this.configureHiddenFileSync("DISABLE_HIDDEN")}$allSuspendExtraSync(){if(this.plugin.settings.syncInternalFiles){this._log("Hidden file synchronization have been temporarily disabled. Please enable them after the fetching, if you need them.",LOG_LEVEL_NOTICE);this.plugin.settings.syncInternalFiles=false}return Promise.resolve(true)}async $anyConfigureOptionalSyncFeature(mode){await this.configureHiddenFileSync(mode)}async configureHiddenFileSync(mode){if("FETCH"==mode||"OVERWRITE"==mode||"MERGE"==mode||"DISABLE"==mode||"DISABLE_HIDDEN"==mode)if("DISABLE"!=mode&&"DISABLE_HIDDEN"!=mode){this._log("Gathering files for enabling Hidden File Sync",LOG_LEVEL_NOTICE);if("FETCH"==mode)await this.initialiseInternalFileSync("pullForce",true);else if("OVERWRITE"==mode)await this.initialiseInternalFileSync("pushForce",true);else if("MERGE"==mode)await this.initialiseInternalFileSync("safe",true);this.plugin.settings.useAdvancedMode=true;this.plugin.settings.syncInternalFiles=true;await this.plugin.saveSettings();this._log("Done! Restarting the app is strongly recommended!",LOG_LEVEL_NOTICE)}else{this.plugin.settings.syncInternalFiles=false;await this.plugin.saveSettings()}}async scanInternalFileNames(){const configDir=normalizePath(this.app.vault.configDir),ignoreFilter=this.settings.syncInternalFilesIgnorePatterns.replace(/\n| /g,"").split(",").filter((e4=>e4)).map((e4=>new RegExp(e4,"i"))),synchronisedInConfigSync=!this.settings.usePluginSync?[]:Object.values(this.settings.pluginSyncExtendedSetting).filter((e4=>e4.mode==MODE_SELECTIVE||e4.mode==MODE_PAUSED)).map((e4=>e4.files)).flat().map((e4=>`${configDir}/${e4}`.toLowerCase())),findRoot=this.app.vault.getRoot().path;return(await this.getFiles(findRoot,[],void 0,ignoreFilter)).filter((e4=>e4.startsWith("."))).filter((e4=>!e4.startsWith(".trash"))).filter((path2=>synchronisedInConfigSync.every((filterFile=>!path2.toLowerCase().startsWith(filterFile)))))}async scanInternalFiles(){var _a5,_b2,_c2,_d2,_e2,_f;const files=(await this.scanInternalFileNames()).map((async e4=>({path:e4,stat:await this.plugin.storageAccess.statHidden(e4)}))),result=[];for(const f4 of files){const w2=await f4;if(await this.plugin.$$isIgnoredByIgnoreFiles(w2.path))continue;const mtime=null!=(_b2=null==(_a5=w2.stat)?void 0:_a5.mtime)?_b2:0,ctime=null!=(_d2=null==(_c2=w2.stat)?void 0:_c2.ctime)?_d2:mtime,size=null!=(_f=null==(_e2=w2.stat)?void 0:_e2.size)?_f:0;result.push({...w2,mtime,ctime,size})}return result}async getFiles(path2,ignoreList,filter3,ignoreFilter){let w2;try{w2=await this.app.vault.adapter.list(path2)}catch(ex){this._log(`Could not traverse(HiddenSync):${path2}`,LOG_LEVEL_INFO);this._log(ex,LOG_LEVEL_VERBOSE);return[]}const filesSrc=[...w2.files.filter((e4=>!ignoreList.some((ee=>e4.endsWith(ee))))).filter((e4=>!filter3||filter3.some((ee=>e4.match(ee))))).filter((e4=>!ignoreFilter||ignoreFilter.every((ee=>!e4.match(ee)))))];let files=[];for(const file of filesSrc)if(!await this.plugin.$$isIgnoredByIgnoreFiles(file))files.push(file);L1:for(const v2 of w2.folders){for(const ignore of ignoreList)if(v2.endsWith(ignore))continue L1;if(!ignoreFilter||!ignoreFilter.some((e4=>v2.match(e4))))if(!await this.plugin.$$isIgnoredByIgnoreFiles(v2))files=files.concat(await this.getFiles(v2,ignoreList,filter3,ignoreFilter))}return files}},subscriber_queue=[];function readable(value,start){return{subscribe:writable(value,start).subscribe}}function writable(value,start=noop2){let stop;const subscribers=new Set;function set(new_value){if(safe_not_equal(value,new_value)){value=new_value;if(stop){const run_queue=!subscriber_queue.length;for(const subscriber of subscribers){subscriber[1]();subscriber_queue.push(subscriber,value)}if(run_queue){for(let i2=0;i2<subscriber_queue.length;i2+=2)subscriber_queue[i2][0](subscriber_queue[i2+1]);subscriber_queue.length=0}}}}function update2(fn){set(fn(value))}return{set,update:update2,subscribe:function subscribe2(run2,invalidate=noop2){const subscriber=[run2,invalidate];subscribers.add(subscriber);if(1===subscribers.size)stop=start(set,update2)||noop2;run2(value);return()=>{subscribers.delete(subscriber);if(0===subscribers.size&&stop){stop();stop=null}}}}}function derived(stores,fn,initial_value){const single=!Array.isArray(stores),stores_array=single?[stores]:stores;if(!stores_array.every(Boolean))throw new Error("derived() expects stores as input, got a falsy value");const auto=fn.length<2;return readable(initial_value,((set,update2)=>{let started=false;const values=[];let pending=0,cleanup=noop2;const sync2=()=>{if(pending)return;cleanup();const result=fn(single?values[0]:values,set,update2);if(auto)set(result);else cleanup=is_function(result)?result:noop2},unsubscribers=stores_array.map(((store,i2)=>subscribe(store,(value=>{values[i2]=value;pending&=~(1<<i2);if(started)sync2()}),(()=>{pending|=1<<i2}))));started=true;sync2();return function stop(){run_all(unsubscribers);cleanup();started=false}}))}function readonly(store){return{subscribe:store.subscribe.bind(store)}}var import_diff_match_patch3=__toESM(require_diff_match_patch(),1),ConflictResolveModal=class extends import_obsidian.Modal{constructor(app2,filename,diff,pluginPickMode,remoteName){super(app2);this.response=CANCELLED;this.isClosed=false;this.consumed=false;this.title="Conflicting changes";this.pluginPickMode=false;this.localName="Keep A";this.remoteName="Keep B";this.result=diff;this.filename=filename;this.pluginPickMode=pluginPickMode||false;if(this.pluginPickMode){this.title="Pick a version";this.remoteName=`Use ${remoteName||"Remote"}`;this.localName="Use Local"}sendValue("cancel-resolve-conflict:"+this.filename,true)}onOpen(){const{contentEl}=this;sendValue("cancel-resolve-conflict:"+this.filename,true);setTimeout((()=>{fireAndForget((async()=>{if(await waitForValue("cancel-resolve-conflict:"+this.filename))this.sendResponse(CANCELLED)}))}),10);this.titleEl.setText(this.title);contentEl.empty();contentEl.createEl("span",{text:this.filename});const div=contentEl.createDiv("");div.addClass("op-scrollable");let diff="";for(const v2 of this.result.diff){const x1=v2[0],x2=v2[1];if(x1==import_diff_match_patch3.DIFF_DELETE)diff+="<span class='deleted'>"+escapeStringToHTML(x2).replace(/\n/g,"<span class='ls-mark-cr'></span>\n")+"</span>";else if(x1==import_diff_match_patch3.DIFF_EQUAL)diff+="<span class='normal'>"+escapeStringToHTML(x2).replace(/\n/g,"<span class='ls-mark-cr'></span>\n")+"</span>";else if(x1==import_diff_match_patch3.DIFF_INSERT)diff+="<span class='added'>"+escapeStringToHTML(x2).replace(/\n/g,"<span class='ls-mark-cr'></span>\n")+"</span>"}diff=diff.replace(/\n/g,"<br>");div.innerHTML=diff;const div2=contentEl.createDiv(""),date1=new Date(this.result.left.mtime).toLocaleString()+(this.result.left.deleted?" (Deleted)":""),date2=new Date(this.result.right.mtime).toLocaleString()+(this.result.right.deleted?" (Deleted)":"");div2.innerHTML=`\n<span class='deleted'>A:${date1}</span><br /><span class='added'>B:${date2}</span><br> \n        `;contentEl.createEl("button",{text:this.localName},(e4=>e4.addEventListener("click",(()=>this.sendResponse(this.result.right.rev))))).style.marginRight="4px";contentEl.createEl("button",{text:this.remoteName},(e4=>e4.addEventListener("click",(()=>this.sendResponse(this.result.left.rev))))).style.marginRight="4px";if(!this.pluginPickMode)contentEl.createEl("button",{text:"Concat both"},(e4=>e4.addEventListener("click",(()=>this.sendResponse(LEAVE_TO_SUBSEQUENT))))).style.marginRight="4px";contentEl.createEl("button",{text:!this.pluginPickMode?"Not now":"Cancel"},(e4=>e4.addEventListener("click",(()=>this.sendResponse(CANCELLED))))).style.marginRight="4px"}sendResponse(result){this.response=result;this.close()}onClose(){const{contentEl}=this;contentEl.empty();if(!this.consumed){this.consumed=true;sendValue("close-resolve-conflict:"+this.filename,this.response);sendValue("cancel-resolve-conflict:"+this.filename,false)}}async waitForResult(){await delay(100);const r2=await waitForValue("close-resolve-conflict:"+this.filename);if(r2===RESULT_TIMED_OUT)return CANCELLED;else return r2}},import_obsidian4=require("obsidian");function add_css3(target){append_styles(target,"svelte-21bw70",'.spacer.svelte-21bw70{min-width:1px;flex-grow:1}button.svelte-21bw70{margin:2px 4px;min-width:3em;max-width:4em}button.svelte-21bw70:disabled{border:none;box-shadow:none;background-color:transparent;visibility:collapse}button.svelte-21bw70:disabled:hover{border:none;box-shadow:none;background-color:transparent;visibility:collapse}span.message.svelte-21bw70{color:var(--text-muted);font-size:var(--font-ui-smaller);padding:0 1em;line-height:var(--line-height-tight)}.is-mobile .spacer.svelte-21bw70{margin-left:auto}.chip-wrap.svelte-21bw70{display:flex;gap:2px;flex-direction:column;justify-content:center;align-items:flex-start}.chip.svelte-21bw70{display:inline-block;border-radius:2px;font-size:0.8em;padding:0 4px;margin:0 2px;border-color:var(--tag-border-color);background-color:var(--tag-background);color:var(--tag-color)}.chip.svelte-21bw70:empty{display:none}.chip.svelte-21bw70:not(:empty)::before{min-width:1.8em;display:inline-block}.chip.content.svelte-21bw70:not(:empty)::before{content:": "}.chip.version.svelte-21bw70:not(:empty)::before{content:": "}.chip.modified.svelte-21bw70:not(:empty)::before{content:": "}')}function get_each_context3(ctx,list,i2){const child_ctx=ctx.slice();child_ctx[35]=list[i2];return child_ctx}function create_else_block_4(ctx){let span0,t0,span1,t22,button0,t32,button1;return{c(){span0=element("span");t0=space();span1=element("span");span1.textContent="All the same or non-existent";t22=space();button0=element("button");t32=space();button1=element("button");attr(span0,"class","spacer svelte-21bw70");attr(span1,"class","message even svelte-21bw70");button0.disabled=true;attr(button0,"class","svelte-21bw70");button1.disabled=true;attr(button1,"class","svelte-21bw70")},m(target,anchor){insert(target,span0,anchor);insert(target,t0,anchor);insert(target,span1,anchor);insert(target,t22,anchor);insert(target,button0,anchor);insert(target,t32,anchor);insert(target,button1,anchor)},p:noop2,d(detaching){if(detaching){detach(span0);detach(t0);detach(span1);detach(t22);detach(button0);detach(t32);detach(button1)}}}}function create_if_block2(ctx){let span,t4,if_block_anchor,if_block=!ctx[1]&&create_if_block_12(ctx);return{c(){span=element("span");t4=space();if(if_block)if_block.c();if_block_anchor=empty();attr(span,"class","spacer svelte-21bw70")},m(target,anchor){insert(target,span,anchor);insert(target,t4,anchor);if(if_block)if_block.m(target,anchor);insert(target,if_block_anchor,anchor)},p(ctx2,dirty){if(!ctx2[1])if(if_block)if_block.p(ctx2,dirty);else{if_block=create_if_block_12(ctx2);if_block.c();if_block.m(if_block_anchor.parentNode,if_block_anchor)}else if(if_block){if_block.d(1);if_block=null}},d(detaching){if(detaching){detach(span);detach(t4);detach(if_block_anchor)}if(if_block)if_block.d(detaching)}}}function create_if_block_12(ctx){let span3,span0,t0,t1,span1,t22,t32,span2,t4,t5,select,option,option_value_value,t7,t8,if_block1_anchor,mounted,dispose,each_value=ensure_array_like(ctx[9]),each_blocks=[];for(let i2=0;i2<each_value.length;i2+=1)each_blocks[i2]=create_each_block3(get_each_context3(ctx,each_value,i2));function select_block_type_1(ctx2,dirty){if(ctx2[6]||ctx2[2]&&""!=ctx2[0])return create_if_block_42;else return create_else_block_3}let current_block_type=select_block_type_1(ctx),if_block0=current_block_type(ctx),if_block1=ctx[2]&&create_if_block_22(ctx);return{c(){span3=element("span");span0=element("span");t0=text(ctx[3]);t1=space();span1=element("span");t22=text(ctx[4]);t32=space();span2=element("span");t4=text(ctx[5]);t5=space();select=element("select");option=element("option");option.textContent="-";for(let i2=0;i2<each_blocks.length;i2+=1)each_blocks[i2].c();t7=space();if_block0.c();t8=space();if(if_block1)if_block1.c();if_block1_anchor=empty();attr(span0,"class","chip modified svelte-21bw70");attr(span1,"class","chip content svelte-21bw70");attr(span2,"class","chip version svelte-21bw70");attr(span3,"class","chip-wrap svelte-21bw70");option.__value=option_value_value="";set_input_value(option,option.__value);if(void 0===ctx[0])add_render_callback((()=>ctx[28].call(select)))},m(target,anchor){insert(target,span3,anchor);append(span3,span0);append(span0,t0);append(span3,t1);append(span3,span1);append(span1,t22);append(span3,t32);append(span3,span2);append(span2,t4);insert(target,t5,anchor);insert(target,select,anchor);append(select,option);for(let i2=0;i2<each_blocks.length;i2+=1)if(each_blocks[i2])each_blocks[i2].m(select,null);select_option(select,ctx[0],true);insert(target,t7,anchor);if_block0.m(target,anchor);insert(target,t8,anchor);if(if_block1)if_block1.m(target,anchor);insert(target,if_block1_anchor,anchor);if(!mounted){dispose=listen(select,"change",ctx[28]);mounted=true}},p(ctx2,dirty){if(8&dirty[0])set_data(t0,ctx2[3]);if(16&dirty[0])set_data(t22,ctx2[4]);if(32&dirty[0])set_data(t4,ctx2[5]);if(512&dirty[0]){each_value=ensure_array_like(ctx2[9]);let i2;for(i2=0;i2<each_value.length;i2+=1){const child_ctx=get_each_context3(ctx2,each_value,i2);if(each_blocks[i2])each_blocks[i2].p(child_ctx,dirty);else{each_blocks[i2]=create_each_block3(child_ctx);each_blocks[i2].c();each_blocks[i2].m(select,null)}}for(;i2<each_blocks.length;i2+=1)each_blocks[i2].d(1);each_blocks.length=each_value.length}if(513&dirty[0])select_option(select,ctx2[0]);if(current_block_type===(current_block_type=select_block_type_1(ctx2))&&if_block0)if_block0.p(ctx2,dirty);else{if_block0.d(1);if_block0=current_block_type(ctx2);if(if_block0){if_block0.c();if_block0.m(t8.parentNode,t8)}}if(ctx2[2])if(if_block1)if_block1.p(ctx2,dirty);else{if_block1=create_if_block_22(ctx2);if_block1.c();if_block1.m(if_block1_anchor.parentNode,if_block1_anchor)}else if(if_block1){if_block1.d(1);if_block1=null}},d(detaching){if(detaching){detach(span3);detach(t5);detach(select);detach(t7);detach(t8);detach(if_block1_anchor)}destroy_each(each_blocks,detaching);if_block0.d(detaching);if(if_block1)if_block1.d(detaching);mounted=false;dispose()}}}function create_each_block3(ctx){let option,t4,option_value_value,t_value=ctx[35]+"";return{c(){option=element("option");t4=text(t_value);option.__value=option_value_value=ctx[35];set_input_value(option,option.__value)},m(target,anchor){insert(target,option,anchor);append(option,t4)},p(ctx2,dirty){if(512&dirty[0]&&t_value!==(t_value=ctx2[35]+""))set_data(t4,t_value);if(512&dirty[0]&&option_value_value!==(option_value_value=ctx2[35])){option.__value=option_value_value;set_input_value(option,option.__value)}},d(detaching){if(detaching)detach(option)}}}function create_else_block_3(ctx){let button0,t4,button1;return{c(){button0=element("button");t4=space();button1=element("button");button0.disabled=true;attr(button0,"class","svelte-21bw70");button1.disabled=true;attr(button1,"class","svelte-21bw70")},m(target,anchor){insert(target,button0,anchor);insert(target,t4,anchor);insert(target,button1,anchor)},p:noop2,d(detaching){if(detaching){detach(button0);detach(t4);detach(button1)}}}}function create_if_block_42(ctx){let t0,button,mounted,dispose;function select_block_type_2(ctx2,dirty){if(ctx2[7])return create_if_block_52;else return create_else_block_2}let current_block_type=select_block_type_2(ctx),if_block=current_block_type(ctx);return{c(){if_block.c();t0=space();button=element("button");button.textContent="";attr(button,"class","svelte-21bw70")},m(target,anchor){if_block.m(target,anchor);insert(target,t0,anchor);insert(target,button,anchor);if(!mounted){dispose=listen(button,"click",ctx[10]);mounted=true}},p(ctx2,dirty){if(current_block_type===(current_block_type=select_block_type_2(ctx2))&&if_block)if_block.p(ctx2,dirty);else{if_block.d(1);if_block=current_block_type(ctx2);if(if_block){if_block.c();if_block.m(t0.parentNode,t0)}}},d(detaching){if(detaching){detach(t0);detach(button)}if_block.d(detaching);mounted=false;dispose()}}}function create_else_block_2(ctx){let button;return{c(){button=element("button");button.disabled=true;attr(button,"class","svelte-21bw70")},m(target,anchor){insert(target,button,anchor)},p:noop2,d(detaching){if(detaching)detach(button)}}}function create_if_block_52(ctx){let if_block_anchor;function select_block_type_3(ctx2,dirty){if(ctx2[8])return create_if_block_6;else return create_else_block_12}let current_block_type=select_block_type_3(ctx),if_block=current_block_type(ctx);return{c(){if_block.c();if_block_anchor=empty()},m(target,anchor){if_block.m(target,anchor);insert(target,if_block_anchor,anchor)},p(ctx2,dirty){if(current_block_type===(current_block_type=select_block_type_3(ctx2))&&if_block)if_block.p(ctx2,dirty);else{if_block.d(1);if_block=current_block_type(ctx2);if(if_block){if_block.c();if_block.m(if_block_anchor.parentNode,if_block_anchor)}}},d(detaching){if(detaching)detach(if_block_anchor);if_block.d(detaching)}}}function create_else_block_12(ctx){let button,mounted,dispose;return{c(){button=element("button");button.textContent="";attr(button,"class","svelte-21bw70")},m(target,anchor){insert(target,button,anchor);if(!mounted){dispose=listen(button,"click",ctx[11]);mounted=true}},p:noop2,d(detaching){if(detaching)detach(button);mounted=false;dispose()}}}function create_if_block_6(ctx){let button,mounted,dispose;return{c(){button=element("button");button.textContent="";attr(button,"class","svelte-21bw70")},m(target,anchor){insert(target,button,anchor);if(!mounted){dispose=listen(button,"click",ctx[12]);mounted=true}},p:noop2,d(detaching){if(detaching)detach(button);mounted=false;dispose()}}}function create_if_block_22(ctx){let if_block_anchor;function select_block_type_4(ctx2,dirty){if(""!=ctx2[0])return create_if_block_32;else return create_else_block2}let current_block_type=select_block_type_4(ctx),if_block=current_block_type(ctx);return{c(){if_block.c();if_block_anchor=empty()},m(target,anchor){if_block.m(target,anchor);insert(target,if_block_anchor,anchor)},p(ctx2,dirty){if(current_block_type===(current_block_type=select_block_type_4(ctx2))&&if_block)if_block.p(ctx2,dirty);else{if_block.d(1);if_block=current_block_type(ctx2);if(if_block){if_block.c();if_block.m(if_block_anchor.parentNode,if_block_anchor)}}},d(detaching){if(detaching)detach(if_block_anchor);if_block.d(detaching)}}}function create_else_block2(ctx){let button,mounted,dispose;return{c(){button=element("button");button.textContent="";attr(button,"class","svelte-21bw70")},m(target,anchor){insert(target,button,anchor);if(!mounted){dispose=listen(button,"click",ctx[14]);mounted=true}},p:noop2,d(detaching){if(detaching)detach(button);mounted=false;dispose()}}}function create_if_block_32(ctx){let button,mounted,dispose;return{c(){button=element("button");button.textContent="";attr(button,"class","svelte-21bw70")},m(target,anchor){insert(target,button,anchor);if(!mounted){dispose=listen(button,"click",ctx[13]);mounted=true}},p:noop2,d(detaching){if(detaching)detach(button);mounted=false;dispose()}}}function create_fragment3(ctx){let if_block_anchor;function select_block_type(ctx2,dirty){if(ctx2[9].length>0)return create_if_block2;else return create_else_block_4}let current_block_type=select_block_type(ctx),if_block=current_block_type(ctx);return{c(){if_block.c();if_block_anchor=empty()},m(target,anchor){if_block.m(target,anchor);insert(target,if_block_anchor,anchor)},p(ctx2,dirty){if(current_block_type===(current_block_type=select_block_type(ctx2))&&if_block)if_block.p(ctx2,dirty);else{if_block.d(1);if_block=current_block_type(ctx2);if(if_block){if_block.c();if_block.m(if_block_anchor.parentNode,if_block_anchor)}}},i:noop2,o:noop2,d(detaching){if(detaching)detach(if_block_anchor);if_block.d(detaching)}}}function instance3($$self,$$props,$$invalidate){let{list=[]}=$$props,{thisTerm=""}=$$props,{hideNotApplicable=false}=$$props,{selectNewest=0}=$$props,{selectNewestStyle=0}=$$props,{applyAllPluse=0}=$$props,{applyData}=$$props,{compareData}=$$props,{deleteData}=$$props,{hidden}=$$props,{plugin:plugin3}=$$props,{isMaintenanceMode=false}=$$props,{isFlagged=false}=$$props;const addOn=plugin3.getAddOn(ConfigSync.name);if(!addOn){Logger(`Could not load the add-on ${ConfigSync.name}`,LOG_LEVEL_INFO);throw new Error(`Could not load the add-on ${ConfigSync.name}`)}let{selected=""}=$$props,freshness="",equivalency="",version2="",canApply=false,canCompare=false,pickToCompare=false,currentSelectNewest=0,currentApplyAll=0,terms=[];async function comparePlugin(local,remote){var _a5,_b2;let freshness2="",version3="",contentCheck=false,canApply2=false;if(!local&&!remote)freshness2="";else if(local&&!remote)freshness2="Local only";else if(remote&&!local){freshness2="Remote only";canApply2=true}else{const dtDiff=(null!==(_a5=null==local?void 0:local.mtime)&&void 0!==_a5?_a5:0)-(null!==(_b2=null==remote?void 0:remote.mtime)&&void 0!==_b2?_b2:0),diff=timeDeltaToHumanReadable(Math.abs(dtDiff));if(dtDiff/1e3<-10){freshness2=`Newer (${diff})`;canApply2=true;contentCheck=true}else if(dtDiff/1e3>10){freshness2=`Older (${diff})`;canApply2=true;contentCheck=true}else{freshness2="Same";canApply2=false;contentCheck=true}}const localVersionStr=(null==local?void 0:local.version)||"0.0.0",remoteVersionStr=(null==remote?void 0:remote.version)||"0.0.0";if((null==local?void 0:local.version)||(null==remote?void 0:remote.version)){const compare2=`${localVersionStr}`.localeCompare(remoteVersionStr,void 0,{numeric:true});if(0==compare2)version3="Same";else if(compare2<0)version3=`Lower (${localVersionStr} < ${remoteVersionStr})`;else if(compare2>0)version3=`Higher (${localVersionStr} > ${remoteVersionStr})`}if(contentCheck)if(local&&remote){const{canApply:canApply3,equivalency:equivalency3,canCompare:canCompare3}=await async function checkEquivalency(local,remote){let equivalency2="",canApply2=false,canCompare2=false;const matchingStatus=[...new Set([...local.files.map((e4=>e4.filename)),...remote.files.map((e4=>e4.filename))])].map((filename=>{const localFile=local.files.find((e4=>e4.filename==filename)),remoteFile=remote.files.find((e4=>e4.filename==filename));if(!localFile&&!remoteFile)return 0;else if(localFile&&!remoteFile)return 2;else if(!localFile&&remoteFile)return 8;else if(localFile&&remoteFile)if(getDocData(localFile.data)==getDocData(remoteFile.data))return 4;else return 16;else return 16})).reduce(((p2,c2)=>p2|c2),0);if(4==matchingStatus){equivalency2="Same";canApply2=false}else if(matchingStatus<=4){equivalency2="Same or local only";canApply2=false}else if(16==matchingStatus){canApply2=true;canCompare2=true;equivalency2="Different"}else{canApply2=true;canCompare2=true;equivalency2="Mixed"}return{equivalency:equivalency2,canApply:canApply2,canCompare:canCompare2}}(local,remote);return{canApply:canApply3,freshness:freshness2,equivalency:equivalency3,version:version3,canCompare:canCompare3}}return{canApply:canApply2,freshness:freshness2,equivalency:"",version:version3,canCompare:false}}async function applySelected(){const local=list.find((e4=>e4.term==thisTerm)),selectedItem=list.find((e4=>e4.term==selected));if(selectedItem&&await applyData(selectedItem))addOn.updatePluginList(true,null==local?void 0:local.documentPath)}async function compareItems(local,remote,filename){if(!local||!remote){if(!remote&&!local)Logger("Could not find both remote and local item",LOG_LEVEL_INFO);else if(!remote)Logger("Could not find remote item",LOG_LEVEL_INFO);else if(!local)Logger("Could not locally item",LOG_LEVEL_INFO)}else if(!filename){if(await compareData(local,remote))addOn.updatePluginList(true,local.documentPath);return}else{const localCopy=local instanceof PluginDataExDisplayV2?new PluginDataExDisplayV2(local):{...local},remoteCopy=remote instanceof PluginDataExDisplayV2?new PluginDataExDisplayV2(remote):{...remote};localCopy.files=localCopy.files.filter((e4=>e4.filename==filename));remoteCopy.files=remoteCopy.files.filter((e4=>e4.filename==filename));if(await compareData(localCopy,remoteCopy,true))addOn.updatePluginList(true,local.documentPath)}}$$self.$$set=$$props2=>{if("list"in $$props2)$$invalidate(15,list=$$props2.list);if("thisTerm"in $$props2)$$invalidate(16,thisTerm=$$props2.thisTerm);if("hideNotApplicable"in $$props2)$$invalidate(17,hideNotApplicable=$$props2.hideNotApplicable);if("selectNewest"in $$props2)$$invalidate(18,selectNewest=$$props2.selectNewest);if("selectNewestStyle"in $$props2)$$invalidate(19,selectNewestStyle=$$props2.selectNewestStyle);if("applyAllPluse"in $$props2)$$invalidate(20,applyAllPluse=$$props2.applyAllPluse);if("applyData"in $$props2)$$invalidate(21,applyData=$$props2.applyData);if("compareData"in $$props2)$$invalidate(22,compareData=$$props2.compareData);if("deleteData"in $$props2)$$invalidate(23,deleteData=$$props2.deleteData);if("hidden"in $$props2)$$invalidate(1,hidden=$$props2.hidden);if("plugin"in $$props2)$$invalidate(24,plugin3=$$props2.plugin);if("isMaintenanceMode"in $$props2)$$invalidate(2,isMaintenanceMode=$$props2.isMaintenanceMode);if("isFlagged"in $$props2)$$invalidate(25,isFlagged=$$props2.isFlagged);if("selected"in $$props2)$$invalidate(0,selected=$$props2.selected)};$$self.$$.update=()=>{if(101482500&$$self.$$.dirty[0]){let doSelectNewest=false;if(selectNewest!=currentSelectNewest)if(1==selectNewestStyle)doSelectNewest=true;else if(2==selectNewestStyle)doSelectNewest=isFlagged;else if(3==selectNewestStyle)$$invalidate(0,selected="");(async function updateTerms(list2,selectNewest2,isMaintenanceMode2){const local=list2.find((e4=>e4.term==thisTerm));if(isMaintenanceMode2)$$invalidate(9,terms=[...new Set(list2.map((e4=>e4.term)))]);else if(hideNotApplicable){const termsTmp=[],wk2=[...new Set(list2.map((e4=>e4.term)))];for(const termName of wk2){const remote=list2.find((e4=>e4.term==termName));if((await comparePlugin(local,remote)).canApply)termsTmp.push(termName)}$$invalidate(9,terms=[...termsTmp])}else $$invalidate(9,terms=[...new Set(list2.map((e4=>e4.term)))].filter((e4=>e4!=thisTerm)));let newest=local;if(selectNewest2){for(const term of terms){const remote=list2.find((e4=>e4.term==term));if(remote&&remote.mtime&&((null==newest?void 0:newest.mtime)||0)<remote.mtime)newest=remote}if(newest&&newest.term!=thisTerm)$$invalidate(0,selected=newest.term)}if(terms.indexOf(selected)<0)$$invalidate(0,selected="")})(list,doSelectNewest,isMaintenanceMode);$$invalidate(26,currentSelectNewest=selectNewest)}if(135266307&$$self.$$.dirty[0]){const doApply=applyAllPluse!=currentApplyAll;$$invalidate(27,currentApplyAll=applyAllPluse);if(doApply&&selected)if(!hidden)applySelected()}if(98305&$$self.$$.dirty[0]){$$invalidate(3,freshness="");$$invalidate(4,equivalency="");$$invalidate(5,version2="");$$invalidate(6,canApply=false);if(""==selected);else if(selected==thisTerm){$$invalidate(3,freshness="This device");$$invalidate(6,canApply=false)}else(async function performCompare(local,remote){const result=await comparePlugin(local,remote);$$invalidate(6,canApply=result.canApply);$$invalidate(3,freshness=result.freshness);$$invalidate(4,equivalency=result.equivalency);$$invalidate(5,version2=result.version);$$invalidate(7,canCompare=result.canCompare);$$invalidate(8,pickToCompare=false);if(canCompare)if((null==local?void 0:local.files.length)==(null==remote?void 0:remote.files.length)&&1==(null==local?void 0:local.files.length)&&(null==local?void 0:local.files[0].filename)==(null==remote?void 0:remote.files[0].filename))$$invalidate(8,pickToCompare=false);else $$invalidate(8,pickToCompare=true)})(list.find((e4=>e4.term==thisTerm)),list.find((e4=>e4.term==selected)))}};return[selected,hidden,isMaintenanceMode,freshness,equivalency,version2,canApply,canCompare,pickToCompare,terms,applySelected,async function compareSelected(){const local=list.find((e4=>e4.term==thisTerm)),selectedItem=list.find((e4=>e4.term==selected));await compareItems(local,selectedItem)},async function pickCompareItem(evt){const local=list.find((e4=>e4.term==thisTerm)),selectedItem=list.find((e4=>e4.term==selected));if(!local)return;if(!selectedItem)return;const menu=new import_obsidian4.Menu;menu.addItem((item=>item.setTitle("Compare file").setIsLabel(true)));menu.addSeparator();const files=unique(local.files.map((e4=>e4.filename)).concat(selectedItem.files.map((e4=>e4.filename)))),convDate=dt=>{if(!dt)return"(Missing)";else return new Date(dt.mtime).toLocaleString()};for(const filename of files)menu.addItem((item=>{const localFile=local.files.find((e4=>e4.filename==filename)),remoteFile=selectedItem.files.find((e4=>e4.filename==filename)),title=`${filename} (${convDate(localFile)} <--\x3e ${convDate(remoteFile)})`;item.setTitle(title).onClick((e4=>compareItems(local,selectedItem,filename)))}));menu.showAtMouseEvent(evt)},async function deleteSelected(){const selectedItem=list.find((e4=>e4.term==selected));if(selectedItem&&await deleteData(selectedItem))addOn.reloadPluginList(true)},async function duplicateItem(){const local=list.find((e4=>e4.term==thisTerm));if(!local){Logger("Could not find local item",LOG_LEVEL_VERBOSE);return}const duplicateTermName=await plugin3.confirm.askString("Duplicate","device name","");if(duplicateTermName){if(duplicateTermName.contains("/")){Logger('We can not use "/" to the device name',LOG_LEVEL_NOTICE);return}const key2=`${plugin3.app.vault.configDir}/${local.files[0].filename}`;await addOn.storeCustomizationFiles(key2,duplicateTermName);await addOn.updatePluginList(false,addOn.filenameToUnifiedKey(key2,duplicateTermName))}},list,thisTerm,hideNotApplicable,selectNewest,selectNewestStyle,applyAllPluse,applyData,compareData,deleteData,plugin3,isFlagged,currentSelectNewest,currentApplyAll,function select_change_handler(){selected=select_value(this);$$invalidate(0,selected),$$invalidate(18,selectNewest),$$invalidate(26,currentSelectNewest),$$invalidate(19,selectNewestStyle),$$invalidate(25,isFlagged),$$invalidate(15,list),$$invalidate(2,isMaintenanceMode);$$invalidate(9,terms)}]}var PluginCombo=class extends SvelteComponent{constructor(options){super();init(this,options,instance3,create_fragment3,safe_not_equal,{list:15,thisTerm:16,hideNotApplicable:17,selectNewest:18,selectNewestStyle:19,applyAllPluse:20,applyData:21,compareData:22,deleteData:23,hidden:1,plugin:24,isMaintenanceMode:2,isFlagged:25,selected:0},add_css3,[-1,-1])}},PluginCombo_default=PluginCombo,import_obsidian5=require("obsidian");function add_css4(target){append_styles(target,"svelte-if2qsj",".buttonsWrap.svelte-if2qsj.svelte-if2qsj{padding-bottom:4px}h3.svelte-if2qsj.svelte-if2qsj{position:sticky;top:0;background-color:var(--modal-background)}.labelrow.svelte-if2qsj.svelte-if2qsj{margin-left:0.4em;display:flex;justify-content:flex-start;align-items:center;border-top:1px solid var(--background-modifier-border);padding:4px;flex-wrap:wrap}.filerow.svelte-if2qsj.svelte-if2qsj{margin-left:1.25em;display:flex;justify-content:flex-start;align-items:center;padding-right:4px;flex-wrap:wrap}.filerow.hideeven.svelte-if2qsj.svelte-if2qsj:has(.even),.labelrow.hideeven.svelte-if2qsj.svelte-if2qsj:has(.even){display:none}.noterow.svelte-if2qsj.svelte-if2qsj{min-height:2em;display:flex}button.status.svelte-if2qsj.svelte-if2qsj{flex-grow:0;margin:2px 4px;min-width:3em;max-width:4em}.statusnote.svelte-if2qsj.svelte-if2qsj{display:flex;justify-content:flex-end;padding-right:var(--size-4-12);align-items:center;min-width:10em;flex-grow:1}.list.svelte-if2qsj.svelte-if2qsj{overflow-y:auto}.title.svelte-if2qsj.svelte-if2qsj{color:var(--text-normal);font-size:var(--font-ui-medium);line-height:var(--line-height-tight);margin-right:auto}.body.svelte-if2qsj.svelte-if2qsj{margin-left:auto;display:flex;justify-content:flex-start;align-items:center}.filetitle.svelte-if2qsj.svelte-if2qsj{color:var(--text-normal);font-size:var(--font-ui-medium);line-height:var(--line-height-tight);margin-right:auto}.buttons.svelte-if2qsj.svelte-if2qsj{display:flex;flex-direction:row;justify-content:flex-end;margin-top:8px;flex-wrap:wrap}.buttons.svelte-if2qsj>button.svelte-if2qsj{margin-left:4px;width:auto}label.svelte-if2qsj.svelte-if2qsj{display:flex;justify-content:center;align-items:center}label.svelte-if2qsj>span.svelte-if2qsj{margin-right:0.25em}.is-mobile .title.svelte-if2qsj.svelte-if2qsj,.is-mobile .filetitle.svelte-if2qsj.svelte-if2qsj{width:100%}.center.svelte-if2qsj.svelte-if2qsj{display:flex;justify-content:center;align-items:center;min-height:3em}.maintenancerow.svelte-if2qsj.svelte-if2qsj{display:flex;justify-content:flex-end;align-items:center}.maintenancerow.svelte-if2qsj label.svelte-if2qsj{margin-right:0.5em;margin-left:0.5em}.loading.svelte-if2qsj.svelte-if2qsj{transition:height 0.25s ease-in-out;transition-delay:4ms;overflow-y:hidden;flex-shrink:0;display:flex;justify-content:flex-start;align-items:center}.loading.svelte-if2qsj.svelte-if2qsj:empty{height:0px;transition:height 0.25s ease-in-out;transition-delay:1s}.loading.svelte-if2qsj.svelte-if2qsj:not(:empty){height:2em;transition:height 0.25s ease-in-out;transition-delay:0}")}function get_each_context4(ctx,list,i2){const child_ctx=ctx.slice();child_ctx[67]=list[i2];return child_ctx}function get_each_context_12(ctx,list,i2){var _a5,_b2,_c2,_d2;const child_ctx=ctx.slice();child_ctx[70]=list[i2][0];child_ctx[71]=list[i2][1];const constants_0=`${PREFIX_PLUGIN_ALL}/${child_ctx[70]}`;child_ctx[72]=constants_0;const constants_1=null!=(_a5=child_ctx[6].get(child_ctx[72]))?_a5:MODE_SELECTIVE;child_ctx[73]=constants_1;const constants_2=`${PREFIX_PLUGIN_MAIN}/${child_ctx[70]}`;child_ctx[74]=constants_2;const constants_3=null!=(_b2=child_ctx[6].get(child_ctx[74]))?_b2:MODE_SELECTIVE;child_ctx[75]=constants_3;const constants_4=`${PREFIX_PLUGIN_DATA}/${child_ctx[70]}`;child_ctx[76]=constants_4;const constants_5=null!=(_c2=child_ctx[6].get(child_ctx[76]))?_c2:MODE_SELECTIVE;child_ctx[77]=constants_5;const constants_6=`${PREFIX_PLUGIN_ETC}/${child_ctx[70]}`;child_ctx[78]=constants_6;const constants_7=null!=(_d2=child_ctx[6].get(child_ctx[78]))?_d2:MODE_SELECTIVE;child_ctx[79]=constants_7;return child_ctx}function get_each_context_2(ctx,list,i2){const child_ctx=ctx.slice();child_ctx[82]=list[i2][0];child_ctx[83]=list[i2][1];return child_ctx}function get_each_context_3(ctx,list,i2){var _a5;const child_ctx=ctx.slice();child_ctx[70]=list[i2];const constants_0=`${child_ctx[82]}/${child_ctx[70]}`;child_ctx[86]=constants_0;const constants_1=null!=(_a5=child_ctx[6].get(child_ctx[86]))?_a5:MODE_SELECTIVE;child_ctx[87]=constants_1;return child_ctx}function create_if_block_10(ctx){let button,mounted,dispose;return{c(){button=element("button");button.textContent="Reload";attr(button,"class","svelte-if2qsj")},m(target,anchor){insert(target,button,anchor);if(!mounted){dispose=listen(button,"click",ctx[36]);mounted=true}},p:noop2,d(detaching){if(detaching)detach(button);mounted=false;dispose()}}}function create_if_block_9(ctx){let span,t0,t1,t1_value=0==ctx[12]?"":` (${ctx[12]})`;return{c(){span=element("span");t0=text("Updating list...");t1=text(t1_value)},m(target,anchor){insert(target,span,anchor);append(span,t0);append(span,t1)},p(ctx2,dirty){if(4096&dirty[0]&&t1_value!==(t1_value=0==ctx2[12]?"":` (${ctx2[12]})`))set_data(t1,t1_value)},d(detaching){if(detaching)detach(span)}}}function create_else_block3(ctx){let t0,div,h3,t22,current,each_value_2=ensure_array_like(ctx[9]),each_blocks_1=[];for(let i2=0;i2<each_value_2.length;i2+=1)each_blocks_1[i2]=create_each_block_2(get_each_context_2(ctx,each_value_2,i2));const out=i2=>transition_out(each_blocks_1[i2],1,1,(()=>{each_blocks_1[i2]=null}));let each_value_1=ensure_array_like(ctx[10]),each_blocks=[];for(let i2=0;i2<each_value_1.length;i2+=1)each_blocks[i2]=create_each_block_12(get_each_context_12(ctx,each_value_1,i2));const out_1=i2=>transition_out(each_blocks[i2],1,1,(()=>{each_blocks[i2]=null}));return{c(){for(let i2=0;i2<each_blocks_1.length;i2+=1)each_blocks_1[i2].c();t0=space();div=element("div");h3=element("h3");h3.textContent="Plugins";t22=space();for(let i2=0;i2<each_blocks.length;i2+=1)each_blocks[i2].c();attr(h3,"class","svelte-if2qsj")},m(target,anchor){for(let i2=0;i2<each_blocks_1.length;i2+=1)if(each_blocks_1[i2])each_blocks_1[i2].m(target,anchor);insert(target,t0,anchor);insert(target,div,anchor);append(div,h3);append(div,t22);for(let i2=0;i2<each_blocks.length;i2+=1)if(each_blocks[i2])each_blocks[i2].m(div,null);current=true},p(ctx2,dirty){if(13634381&dirty[0]){each_value_2=ensure_array_like(ctx2[9]);let i2;for(i2=0;i2<each_value_2.length;i2+=1){const child_ctx=get_each_context_2(ctx2,each_value_2,i2);if(each_blocks_1[i2]){each_blocks_1[i2].p(child_ctx,dirty);transition_in(each_blocks_1[i2],1)}else{each_blocks_1[i2]=create_each_block_2(child_ctx);each_blocks_1[i2].c();transition_in(each_blocks_1[i2],1);each_blocks_1[i2].m(t0.parentNode,t0)}}group_outros();for(i2=each_value_2.length;i2<each_blocks_1.length;i2+=1)out(i2);check_outros()}if(47189320&dirty[0]){each_value_1=ensure_array_like(ctx2[10]);let i2;for(i2=0;i2<each_value_1.length;i2+=1){const child_ctx=get_each_context_12(ctx2,each_value_1,i2);if(each_blocks[i2]){each_blocks[i2].p(child_ctx,dirty);transition_in(each_blocks[i2],1)}else{each_blocks[i2]=create_each_block_12(child_ctx);each_blocks[i2].c();transition_in(each_blocks[i2],1);each_blocks[i2].m(div,null)}}group_outros();for(i2=each_value_1.length;i2<each_blocks.length;i2+=1)out_1(i2);check_outros()}},i(local){if(!current){for(let i2=0;i2<each_value_2.length;i2+=1)transition_in(each_blocks_1[i2]);for(let i2=0;i2<each_value_1.length;i2+=1)transition_in(each_blocks[i2]);current=true}},o(local){each_blocks_1=each_blocks_1.filter(Boolean);for(let i2=0;i2<each_blocks_1.length;i2+=1)transition_out(each_blocks_1[i2]);each_blocks=each_blocks.filter(Boolean);for(let i2=0;i2<each_blocks.length;i2+=1)transition_out(each_blocks[i2]);current=false},d(detaching){if(detaching){detach(t0);detach(div)}destroy_each(each_blocks_1,detaching);destroy_each(each_blocks,detaching)}}}function create_if_block_13(ctx){let div;return{c(){div=element("div");div.textContent="No Items.";attr(div,"class","center svelte-if2qsj")},m(target,anchor){insert(target,div,anchor)},p:noop2,i:noop2,o:noop2,d(detaching){if(detaching)detach(div)}}}function create_else_block_5(ctx){let div,t4,t_value=ctx[22][ctx[87]]+"";return{c(){div=element("div");t4=text(t_value);attr(div,"class","statusnote svelte-if2qsj")},m(target,anchor){insert(target,div,anchor);append(div,t4)},p(ctx2,dirty){if(580&dirty[0]&&t_value!==(t_value=ctx2[22][ctx2[87]]+""))set_data(t4,t_value)},i:noop2,o:noop2,d(detaching){if(detaching)detach(div)}}}function create_if_block_8(ctx){let plugincombo,current;function func(...args){return ctx[42](ctx[82],ctx[70],...args)}const plugincombo_spread_levels=[ctx[11],{isFlagged:ctx[87]==MODE_SHINY},{list:ctx[0].filter(func)},{hidden:false}];let plugincombo_props={};for(let i2=0;i2<plugincombo_spread_levels.length;i2+=1)plugincombo_props=assign(plugincombo_props,plugincombo_spread_levels[i2]);plugincombo=new PluginCombo_default({props:plugincombo_props});return{c(){create_component(plugincombo.$$.fragment)},m(target,anchor){mount_component(plugincombo,target,anchor);current=true},p(new_ctx,dirty){ctx=new_ctx;const plugincombo_changes=2629&dirty[0]?get_spread_update(plugincombo_spread_levels,[2048&dirty[0]&&get_spread_object(ctx[11]),580&dirty[0]&&{isFlagged:ctx[87]==MODE_SHINY},517&dirty[0]&&{list:ctx[0].filter(func)},plugincombo_spread_levels[3]]):{};plugincombo.$set(plugincombo_changes)},i(local){if(!current){transition_in(plugincombo.$$.fragment,local);current=true}},o(local){transition_out(plugincombo.$$.fragment,local);current=false},d(detaching){destroy_component(plugincombo,detaching)}}}function create_each_block_3(ctx){let div2,div0,button,t0,t1,span,t22,t32,div1,current_block_type_index,if_block,div2_class_value,current,mounted,dispose,t0_value=ctx[23](ctx[87])+"",t2_value=("THEME"==ctx[82]&&ctx[8].get(`themes/${ctx[70]}`)||ctx[70])+"";function click_handler_8(...args){return ctx[41](ctx[82],ctx[70],ctx[86],...args)}const if_block_creators=[create_if_block_8,create_else_block_5],if_blocks=[];function select_block_type_1(ctx2,dirty){if(ctx2[87]==MODE_SELECTIVE||ctx2[87]==MODE_SHINY)return 0;else return 1}current_block_type_index=select_block_type_1(ctx);if_block=if_blocks[current_block_type_index]=if_block_creators[current_block_type_index](ctx);return{c(){div2=element("div");div0=element("div");button=element("button");t0=text(t0_value);t1=space();span=element("span");t22=text(t2_value);t32=space();div1=element("div");if_block.c();attr(button,"class","status svelte-if2qsj");attr(span,"class","name");attr(div0,"class","title svelte-if2qsj");attr(div1,"class","body svelte-if2qsj");attr(div2,"class",div2_class_value="labelrow "+(ctx[3]?"hideeven":"")+" svelte-if2qsj")},m(target,anchor){insert(target,div2,anchor);append(div2,div0);append(div0,button);append(button,t0);append(div0,t1);append(div0,span);append(span,t22);append(div2,t32);append(div2,div1);if_blocks[current_block_type_index].m(div1,null);current=true;if(!mounted){dispose=listen(button,"click",click_handler_8);mounted=true}},p(new_ctx,dirty){ctx=new_ctx;if((!current||580&dirty[0])&&t0_value!==(t0_value=ctx[23](ctx[87])+""))set_data(t0,t0_value);if((!current||772&dirty[0])&&t2_value!==(t2_value=("THEME"==ctx[82]&&ctx[8].get(`themes/${ctx[70]}`)||ctx[70])+""))set_data(t22,t2_value);let previous_block_index=current_block_type_index;current_block_type_index=select_block_type_1(ctx);if(current_block_type_index===previous_block_index)if_blocks[current_block_type_index].p(ctx,dirty);else{group_outros();transition_out(if_blocks[previous_block_index],1,1,(()=>{if_blocks[previous_block_index]=null}));check_outros();if_block=if_blocks[current_block_type_index];if(!if_block){if_block=if_blocks[current_block_type_index]=if_block_creators[current_block_type_index](ctx);if_block.c()}else if_block.p(ctx,dirty);transition_in(if_block,1);if_block.m(div1,null)}if(!current||8&dirty[0]&&div2_class_value!==(div2_class_value="labelrow "+(ctx[3]?"hideeven":"")+" svelte-if2qsj"))attr(div2,"class",div2_class_value)},i(local){if(!current){transition_in(if_block);current=true}},o(local){transition_out(if_block);current=false},d(detaching){if(detaching)detach(div2);if_blocks[current_block_type_index].d();mounted=false;dispose()}}}function create_each_block_2(ctx){let div,h3,t0,t1,current,t0_value=ctx[83]+"",each_value_3=ensure_array_like(ctx[2][ctx[82]]),each_blocks=[];for(let i2=0;i2<each_value_3.length;i2+=1)each_blocks[i2]=create_each_block_3(get_each_context_3(ctx,each_value_3,i2));const out=i2=>transition_out(each_blocks[i2],1,1,(()=>{each_blocks[i2]=null}));return{c(){div=element("div");h3=element("h3");t0=text(t0_value);t1=space();for(let i2=0;i2<each_blocks.length;i2+=1)each_blocks[i2].c();attr(h3,"class","svelte-if2qsj")},m(target,anchor){insert(target,div,anchor);append(div,h3);append(h3,t0);append(div,t1);for(let i2=0;i2<each_blocks.length;i2+=1)if(each_blocks[i2])each_blocks[i2].m(div,null);current=true},p(ctx2,dirty){if((!current||512&dirty[0])&&t0_value!==(t0_value=ctx2[83]+""))set_data(t0,t0_value);if(13634381&dirty[0]){each_value_3=ensure_array_like(ctx2[2][ctx2[82]]);let i2;for(i2=0;i2<each_value_3.length;i2+=1){const child_ctx=get_each_context_3(ctx2,each_value_3,i2);if(each_blocks[i2]){each_blocks[i2].p(child_ctx,dirty);transition_in(each_blocks[i2],1)}else{each_blocks[i2]=create_each_block_3(child_ctx);each_blocks[i2].c();transition_in(each_blocks[i2],1);each_blocks[i2].m(div,null)}}group_outros();for(i2=each_value_3.length;i2<each_blocks.length;i2+=1)out(i2);check_outros()}},i(local){if(!current){for(let i2=0;i2<each_value_3.length;i2+=1)transition_in(each_blocks[i2]);current=true}},o(local){each_blocks=each_blocks.filter(Boolean);for(let i2=0;i2<each_blocks.length;i2+=1)transition_out(each_blocks[i2]);current=false},d(detaching){if(detaching)detach(div);destroy_each(each_blocks,detaching)}}}function create_if_block_7(ctx){let plugincombo,current;const plugincombo_spread_levels=[ctx[11],{isFlagged:ctx[73]==MODE_SHINY},{list:ctx[71]},{hidden:true}];let plugincombo_props={};for(let i2=0;i2<plugincombo_spread_levels.length;i2+=1)plugincombo_props=assign(plugincombo_props,plugincombo_spread_levels[i2]);plugincombo=new PluginCombo_default({props:plugincombo_props});return{c(){create_component(plugincombo.$$.fragment)},m(target,anchor){mount_component(plugincombo,target,anchor);current=true},p(ctx2,dirty){const plugincombo_changes=3136&dirty[0]?get_spread_update(plugincombo_spread_levels,[2048&dirty[0]&&get_spread_object(ctx2[11]),1088&dirty[0]&&{isFlagged:ctx2[73]==MODE_SHINY},1024&dirty[0]&&{list:ctx2[71]},plugincombo_spread_levels[3]]):{};plugincombo.$set(plugincombo_changes)},i(local){if(!current){transition_in(plugincombo.$$.fragment,local);current=true}},o(local){transition_out(plugincombo.$$.fragment,local);current=false},d(detaching){destroy_component(plugincombo,detaching)}}}function create_else_block_42(ctx){let div1,div0,t0,t1,t0_value=ctx[22][ctx[73]]+"";return{c(){div1=element("div");div0=element("div");t0=text(t0_value);t1=space();attr(div0,"class","statusnote svelte-if2qsj");attr(div1,"class","noterow svelte-if2qsj")},m(target,anchor){insert(target,div1,anchor);append(div1,div0);append(div0,t0);append(div1,t1)},p(ctx2,dirty){if(1088&dirty[0]&&t0_value!==(t0_value=ctx2[22][ctx2[73]]+""))set_data(t0,t0_value)},i:noop2,o:noop2,d(detaching){if(detaching)detach(div1)}}}function create_if_block_23(ctx){let div2,div0,button0,t0,t1,span0,t32,div1,current_block_type_index,if_block0,div2_class_value,t4,div5,div3,button1,t5,t6,span1,t8,div4,current_block_type_index_1,if_block1,div5_class_value,t9,if_block2_anchor,current,mounted,dispose,t0_value=ctx[23](ctx[75])+"",t5_value=ctx[23](ctx[77])+"";function click_handler_10(...args){return ctx[44](ctx[70],ctx[74],...args)}const if_block_creators=[create_if_block_62,create_else_block_32],if_blocks=[];function select_block_type_3(ctx2,dirty){if(ctx2[75]==MODE_SELECTIVE||ctx2[75]==MODE_SHINY)return 0;else return 1}current_block_type_index=select_block_type_3(ctx);if_block0=if_blocks[current_block_type_index]=if_block_creators[current_block_type_index](ctx);function click_handler_11(...args){return ctx[45](ctx[70],ctx[76],...args)}const if_block_creators_1=[create_if_block_53,create_else_block_22],if_blocks_1=[];function select_block_type_4(ctx2,dirty){if(ctx2[77]==MODE_SELECTIVE||ctx2[77]==MODE_SHINY)return 0;else return 1}current_block_type_index_1=select_block_type_4(ctx);if_block1=if_blocks_1[current_block_type_index_1]=if_block_creators_1[current_block_type_index_1](ctx);let if_block2=ctx[25]&&create_if_block_33(ctx);return{c(){div2=element("div");div0=element("div");button0=element("button");t0=text(t0_value);t1=space();span0=element("span");span0.textContent="MAIN";t32=space();div1=element("div");if_block0.c();t4=space();div5=element("div");div3=element("div");button1=element("button");t5=text(t5_value);t6=space();span1=element("span");span1.textContent="DATA";t8=space();div4=element("div");if_block1.c();t9=space();if(if_block2)if_block2.c();if_block2_anchor=empty();attr(button0,"class","status svelte-if2qsj");attr(span0,"class","name");attr(div0,"class","filetitle svelte-if2qsj");attr(div1,"class","body svelte-if2qsj");attr(div2,"class",div2_class_value="filerow "+(ctx[3]?"hideeven":"")+" svelte-if2qsj");attr(button1,"class","status svelte-if2qsj");attr(span1,"class","name");attr(div3,"class","filetitle svelte-if2qsj");attr(div4,"class","body svelte-if2qsj");attr(div5,"class",div5_class_value="filerow "+(ctx[3]?"hideeven":"")+" svelte-if2qsj")},m(target,anchor){insert(target,div2,anchor);append(div2,div0);append(div0,button0);append(button0,t0);append(div0,t1);append(div0,span0);append(div2,t32);append(div2,div1);if_blocks[current_block_type_index].m(div1,null);insert(target,t4,anchor);insert(target,div5,anchor);append(div5,div3);append(div3,button1);append(button1,t5);append(div3,t6);append(div3,span1);append(div5,t8);append(div5,div4);if_blocks_1[current_block_type_index_1].m(div4,null);insert(target,t9,anchor);if(if_block2)if_block2.m(target,anchor);insert(target,if_block2_anchor,anchor);current=true;if(!mounted){dispose=[listen(button0,"click",click_handler_10),listen(button1,"click",click_handler_11)];mounted=true}},p(new_ctx,dirty){ctx=new_ctx;if((!current||1088&dirty[0])&&t0_value!==(t0_value=ctx[23](ctx[75])+""))set_data(t0,t0_value);let previous_block_index=current_block_type_index;current_block_type_index=select_block_type_3(ctx);if(current_block_type_index===previous_block_index)if_blocks[current_block_type_index].p(ctx,dirty);else{group_outros();transition_out(if_blocks[previous_block_index],1,1,(()=>{if_blocks[previous_block_index]=null}));check_outros();if_block0=if_blocks[current_block_type_index];if(!if_block0){if_block0=if_blocks[current_block_type_index]=if_block_creators[current_block_type_index](ctx);if_block0.c()}else if_block0.p(ctx,dirty);transition_in(if_block0,1);if_block0.m(div1,null)}if(!current||8&dirty[0]&&div2_class_value!==(div2_class_value="filerow "+(ctx[3]?"hideeven":"")+" svelte-if2qsj"))attr(div2,"class",div2_class_value);if((!current||1088&dirty[0])&&t5_value!==(t5_value=ctx[23](ctx[77])+""))set_data(t5,t5_value);let previous_block_index_1=current_block_type_index_1;current_block_type_index_1=select_block_type_4(ctx);if(current_block_type_index_1===previous_block_index_1)if_blocks_1[current_block_type_index_1].p(ctx,dirty);else{group_outros();transition_out(if_blocks_1[previous_block_index_1],1,1,(()=>{if_blocks_1[previous_block_index_1]=null}));check_outros();if_block1=if_blocks_1[current_block_type_index_1];if(!if_block1){if_block1=if_blocks_1[current_block_type_index_1]=if_block_creators_1[current_block_type_index_1](ctx);if_block1.c()}else if_block1.p(ctx,dirty);transition_in(if_block1,1);if_block1.m(div4,null)}if(!current||8&dirty[0]&&div5_class_value!==(div5_class_value="filerow "+(ctx[3]?"hideeven":"")+" svelte-if2qsj"))attr(div5,"class",div5_class_value);if(ctx[25])if_block2.p(ctx,dirty)},i(local){if(!current){transition_in(if_block0);transition_in(if_block1);transition_in(if_block2);current=true}},o(local){transition_out(if_block0);transition_out(if_block1);transition_out(if_block2);current=false},d(detaching){if(detaching){detach(div2);detach(t4);detach(div5);detach(t9);detach(if_block2_anchor)}if_blocks[current_block_type_index].d();if_blocks_1[current_block_type_index_1].d();if(if_block2)if_block2.d(detaching);mounted=false;run_all(dispose)}}}function create_else_block_32(ctx){let div,t4,t_value=ctx[22][ctx[75]]+"";return{c(){div=element("div");t4=text(t_value);attr(div,"class","statusnote svelte-if2qsj")},m(target,anchor){insert(target,div,anchor);append(div,t4)},p(ctx2,dirty){if(1088&dirty[0]&&t_value!==(t_value=ctx2[22][ctx2[75]]+""))set_data(t4,t_value)},i:noop2,o:noop2,d(detaching){if(detaching)detach(div)}}}function create_if_block_62(ctx){let plugincombo,current;const plugincombo_spread_levels=[ctx[11],{isFlagged:ctx[75]==MODE_SHINY},{list:filterList(ctx[71],["PLUGIN_MAIN"])},{hidden:false}];let plugincombo_props={};for(let i2=0;i2<plugincombo_spread_levels.length;i2+=1)plugincombo_props=assign(plugincombo_props,plugincombo_spread_levels[i2]);plugincombo=new PluginCombo_default({props:plugincombo_props});return{c(){create_component(plugincombo.$$.fragment)},m(target,anchor){mount_component(plugincombo,target,anchor);current=true},p(ctx2,dirty){const plugincombo_changes=3136&dirty[0]?get_spread_update(plugincombo_spread_levels,[2048&dirty[0]&&get_spread_object(ctx2[11]),1088&dirty[0]&&{isFlagged:ctx2[75]==MODE_SHINY},1024&dirty[0]&&{list:filterList(ctx2[71],["PLUGIN_MAIN"])},plugincombo_spread_levels[3]]):{};plugincombo.$set(plugincombo_changes)},i(local){if(!current){transition_in(plugincombo.$$.fragment,local);current=true}},o(local){transition_out(plugincombo.$$.fragment,local);current=false},d(detaching){destroy_component(plugincombo,detaching)}}}function create_else_block_22(ctx){let div,t4,t_value=ctx[22][ctx[77]]+"";return{c(){div=element("div");t4=text(t_value);attr(div,"class","statusnote svelte-if2qsj")},m(target,anchor){insert(target,div,anchor);append(div,t4)},p(ctx2,dirty){if(1088&dirty[0]&&t_value!==(t_value=ctx2[22][ctx2[77]]+""))set_data(t4,t_value)},i:noop2,o:noop2,d(detaching){if(detaching)detach(div)}}}function create_if_block_53(ctx){let plugincombo,current;const plugincombo_spread_levels=[ctx[11],{isFlagged:ctx[77]==MODE_SHINY},{list:filterList(ctx[71],["PLUGIN_DATA"])},{hidden:false}];let plugincombo_props={};for(let i2=0;i2<plugincombo_spread_levels.length;i2+=1)plugincombo_props=assign(plugincombo_props,plugincombo_spread_levels[i2]);plugincombo=new PluginCombo_default({props:plugincombo_props});return{c(){create_component(plugincombo.$$.fragment)},m(target,anchor){mount_component(plugincombo,target,anchor);current=true},p(ctx2,dirty){const plugincombo_changes=3136&dirty[0]?get_spread_update(plugincombo_spread_levels,[2048&dirty[0]&&get_spread_object(ctx2[11]),1088&dirty[0]&&{isFlagged:ctx2[77]==MODE_SHINY},1024&dirty[0]&&{list:filterList(ctx2[71],["PLUGIN_DATA"])},plugincombo_spread_levels[3]]):{};plugincombo.$set(plugincombo_changes)},i(local){if(!current){transition_in(plugincombo.$$.fragment,local);current=true}},o(local){transition_out(plugincombo.$$.fragment,local);current=false},d(detaching){destroy_component(plugincombo,detaching)}}}function create_if_block_33(ctx){let div2,div0,button,t0,t1,span,t32,div1,current_block_type_index,if_block,t4,div2_class_value,current,mounted,dispose,t0_value=ctx[23](ctx[79])+"";function click_handler_12(...args){return ctx[46](ctx[70],ctx[78],...args)}const if_block_creators=[create_if_block_43,create_else_block_13],if_blocks=[];function select_block_type_5(ctx2,dirty){if(ctx2[79]==MODE_SELECTIVE||ctx2[79]==MODE_SHINY)return 0;else return 1}current_block_type_index=select_block_type_5(ctx);if_block=if_blocks[current_block_type_index]=if_block_creators[current_block_type_index](ctx);return{c(){div2=element("div");div0=element("div");button=element("button");t0=text(t0_value);t1=space();span=element("span");span.textContent="Other files";t32=space();div1=element("div");if_block.c();t4=space();attr(button,"class","status svelte-if2qsj");attr(span,"class","name");attr(div0,"class","filetitle svelte-if2qsj");attr(div1,"class","body svelte-if2qsj");attr(div2,"class",div2_class_value="filerow "+(ctx[3]?"hideeven":"")+" svelte-if2qsj")},m(target,anchor){insert(target,div2,anchor);append(div2,div0);append(div0,button);append(button,t0);append(div0,t1);append(div0,span);append(div2,t32);append(div2,div1);if_blocks[current_block_type_index].m(div1,null);append(div2,t4);current=true;if(!mounted){dispose=listen(button,"click",click_handler_12);mounted=true}},p(new_ctx,dirty){ctx=new_ctx;if((!current||1088&dirty[0])&&t0_value!==(t0_value=ctx[23](ctx[79])+""))set_data(t0,t0_value);let previous_block_index=current_block_type_index;current_block_type_index=select_block_type_5(ctx);if(current_block_type_index===previous_block_index)if_blocks[current_block_type_index].p(ctx,dirty);else{group_outros();transition_out(if_blocks[previous_block_index],1,1,(()=>{if_blocks[previous_block_index]=null}));check_outros();if_block=if_blocks[current_block_type_index];if(!if_block){if_block=if_blocks[current_block_type_index]=if_block_creators[current_block_type_index](ctx);if_block.c()}else if_block.p(ctx,dirty);transition_in(if_block,1);if_block.m(div1,null)}if(!current||8&dirty[0]&&div2_class_value!==(div2_class_value="filerow "+(ctx[3]?"hideeven":"")+" svelte-if2qsj"))attr(div2,"class",div2_class_value)},i(local){if(!current){transition_in(if_block);current=true}},o(local){transition_out(if_block);current=false},d(detaching){if(detaching)detach(div2);if_blocks[current_block_type_index].d();mounted=false;dispose()}}}function create_else_block_13(ctx){let div,t4,t_value=ctx[22][ctx[79]]+"";return{c(){div=element("div");t4=text(t_value);attr(div,"class","statusnote svelte-if2qsj")},m(target,anchor){insert(target,div,anchor);append(div,t4)},p(ctx2,dirty){if(1088&dirty[0]&&t_value!==(t_value=ctx2[22][ctx2[79]]+""))set_data(t4,t_value)},i:noop2,o:noop2,d(detaching){if(detaching)detach(div)}}}function create_if_block_43(ctx){let plugincombo,current;const plugincombo_spread_levels=[ctx[11],{isFlagged:ctx[79]==MODE_SHINY},{list:filterList(ctx[71],["PLUGIN_ETC"])},{hidden:false}];let plugincombo_props={};for(let i2=0;i2<plugincombo_spread_levels.length;i2+=1)plugincombo_props=assign(plugincombo_props,plugincombo_spread_levels[i2]);plugincombo=new PluginCombo_default({props:plugincombo_props});return{c(){create_component(plugincombo.$$.fragment)},m(target,anchor){mount_component(plugincombo,target,anchor);current=true},p(ctx2,dirty){const plugincombo_changes=3136&dirty[0]?get_spread_update(plugincombo_spread_levels,[2048&dirty[0]&&get_spread_object(ctx2[11]),1088&dirty[0]&&{isFlagged:ctx2[79]==MODE_SHINY},1024&dirty[0]&&{list:filterList(ctx2[71],["PLUGIN_ETC"])},plugincombo_spread_levels[3]]):{};plugincombo.$set(plugincombo_changes)},i(local){if(!current){transition_in(plugincombo.$$.fragment,local);current=true}},o(local){transition_out(plugincombo.$$.fragment,local);current=false},d(detaching){destroy_component(plugincombo,detaching)}}}function create_each_block_12(ctx){let div2,div0,button,t0,t1,span,t22,t32,div1,div2_class_value,t4,current_block_type_index,if_block1,if_block1_anchor,current,mounted,dispose,t0_value=ctx[23](ctx[73])+"",t2_value=(ctx[8].get(`plugins/${ctx[70]}`)||ctx[70])+"";function click_handler_9(...args){return ctx[43](ctx[70],ctx[72],...args)}let if_block0=(ctx[73]==MODE_SELECTIVE||ctx[73]==MODE_SHINY)&&create_if_block_7(ctx);const if_block_creators=[create_if_block_23,create_else_block_42],if_blocks=[];function select_block_type_2(ctx2,dirty){if(ctx2[73]==MODE_SELECTIVE||ctx2[73]==MODE_SHINY)return 0;else return 1}current_block_type_index=select_block_type_2(ctx);if_block1=if_blocks[current_block_type_index]=if_block_creators[current_block_type_index](ctx);return{c(){div2=element("div");div0=element("div");button=element("button");t0=text(t0_value);t1=space();span=element("span");t22=text(t2_value);t32=space();div1=element("div");if(if_block0)if_block0.c();t4=space();if_block1.c();if_block1_anchor=empty();attr(button,"class","status svelte-if2qsj");attr(span,"class","name");attr(div0,"class","title svelte-if2qsj");attr(div1,"class","body svelte-if2qsj");attr(div2,"class",div2_class_value="labelrow "+(ctx[3]?"hideeven":"")+" svelte-if2qsj")},m(target,anchor){insert(target,div2,anchor);append(div2,div0);append(div0,button);append(button,t0);append(div0,t1);append(div0,span);append(span,t22);append(div2,t32);append(div2,div1);if(if_block0)if_block0.m(div1,null);insert(target,t4,anchor);if_blocks[current_block_type_index].m(target,anchor);insert(target,if_block1_anchor,anchor);current=true;if(!mounted){dispose=listen(button,"click",click_handler_9);mounted=true}},p(new_ctx,dirty){ctx=new_ctx;if((!current||1088&dirty[0])&&t0_value!==(t0_value=ctx[23](ctx[73])+""))set_data(t0,t0_value);if((!current||1280&dirty[0])&&t2_value!==(t2_value=(ctx[8].get(`plugins/${ctx[70]}`)||ctx[70])+""))set_data(t22,t2_value);if(ctx[73]==MODE_SELECTIVE||ctx[73]==MODE_SHINY)if(if_block0){if_block0.p(ctx,dirty);if(1088&dirty[0])transition_in(if_block0,1)}else{if_block0=create_if_block_7(ctx);if_block0.c();transition_in(if_block0,1);if_block0.m(div1,null)}else if(if_block0){group_outros();transition_out(if_block0,1,1,(()=>{if_block0=null}));check_outros()}if(!current||8&dirty[0]&&div2_class_value!==(div2_class_value="labelrow "+(ctx[3]?"hideeven":"")+" svelte-if2qsj"))attr(div2,"class",div2_class_value);let previous_block_index=current_block_type_index;current_block_type_index=select_block_type_2(ctx);if(current_block_type_index===previous_block_index)if_blocks[current_block_type_index].p(ctx,dirty);else{group_outros();transition_out(if_blocks[previous_block_index],1,1,(()=>{if_blocks[previous_block_index]=null}));check_outros();if_block1=if_blocks[current_block_type_index];if(!if_block1){if_block1=if_blocks[current_block_type_index]=if_block_creators[current_block_type_index](ctx);if_block1.c()}else if_block1.p(ctx,dirty);transition_in(if_block1,1);if_block1.m(if_block1_anchor.parentNode,if_block1_anchor)}},i(local){if(!current){transition_in(if_block0);transition_in(if_block1);current=true}},o(local){transition_out(if_block0);transition_out(if_block1);current=false},d(detaching){if(detaching){detach(div2);detach(t4);detach(if_block1_anchor)}if(if_block0)if_block0.d();if_blocks[current_block_type_index].d(detaching);mounted=false;dispose()}}}function create_if_block3(ctx){let div2,div1,h3,t1,div0,label_1,t32,select,t4,button,mounted,dispose,each_value=ensure_array_like(ctx[5]),each_blocks=[];for(let i2=0;i2<each_value.length;i2+=1)each_blocks[i2]=create_each_block4(get_each_context4(ctx,each_value,i2));return{c(){div2=element("div");div1=element("div");h3=element("h3");h3.textContent="Maintenance Commands";t1=space();div0=element("div");label_1=element("label");label_1.textContent="Delete All of";t32=space();select=element("select");for(let i2=0;i2<each_blocks.length;i2+=1)each_blocks[i2].c();t4=space();button=element("button");button.textContent="";attr(h3,"class","svelte-if2qsj");attr(label_1,"for","");attr(label_1,"class","svelte-if2qsj");if(void 0===ctx[7])add_render_callback((()=>ctx[47].call(select)));attr(button,"class","status svelte-if2qsj");attr(div0,"class","maintenancerow svelte-if2qsj");attr(div2,"class","buttons svelte-if2qsj")},m(target,anchor){insert(target,div2,anchor);append(div2,div1);append(div1,h3);append(div1,t1);append(div1,div0);append(div0,label_1);append(div0,t32);append(div0,select);for(let i2=0;i2<each_blocks.length;i2+=1)if(each_blocks[i2])each_blocks[i2].m(select,null);select_option(select,ctx[7],true);append(div0,t4);append(div0,button);if(!mounted){dispose=[listen(select,"change",ctx[47]),listen(button,"click",ctx[48])];mounted=true}},p(ctx2,dirty){if(32&dirty[0]){each_value=ensure_array_like(ctx2[5]);let i2;for(i2=0;i2<each_value.length;i2+=1){const child_ctx=get_each_context4(ctx2,each_value,i2);if(each_blocks[i2])each_blocks[i2].p(child_ctx,dirty);else{each_blocks[i2]=create_each_block4(child_ctx);each_blocks[i2].c();each_blocks[i2].m(select,null)}}for(;i2<each_blocks.length;i2+=1)each_blocks[i2].d(1);each_blocks.length=each_value.length}if(160&dirty[0])select_option(select,ctx2[7])},d(detaching){if(detaching)detach(div2);destroy_each(each_blocks,detaching);mounted=false;run_all(dispose)}}}function create_each_block4(ctx){let option,t4,option_value_value,t_value=ctx[67]+"";return{c(){option=element("option");t4=text(t_value);option.__value=option_value_value=ctx[67];set_input_value(option,option.__value)},m(target,anchor){insert(target,option,anchor);append(option,t4)},p(ctx2,dirty){if(32&dirty[0]&&t_value!==(t_value=ctx2[67]+""))set_data(t4,t_value);if(32&dirty[0]&&option_value_value!==(option_value_value=ctx2[67])){option.__value=option_value_value;set_input_value(option,option.__value)}},d(detaching){if(detaching)detach(option)}}}function create_fragment4(ctx){let div2,div0,button0,t1,button1,t32,button2,t5,t6,div1,button3,t8,button4,t11,button5,t13,button6,t15,div3,t16,div4,current_block_type_index,if_block2,t17,t18,div5,label0,span0,input0,t20,div6,label1,span1,input1,current,mounted,dispose,if_block0=ctx[1]&&create_if_block_10(ctx),if_block1=(ctx[4]||0!==ctx[12])&&create_if_block_9(ctx);const if_block_creators=[create_if_block_13,create_else_block3],if_blocks=[];function select_block_type(ctx2,dirty){if(0==ctx2[0].length)return 0;else return 1}current_block_type_index=select_block_type(ctx);if_block2=if_blocks[current_block_type_index]=if_block_creators[current_block_type_index](ctx);let if_block3=ctx[1]&&create_if_block3(ctx);return{c(){div2=element("div");div0=element("div");button0=element("button");button0.textContent="Scan changes";t1=space();button1=element("button");button1.textContent="Sync once";t32=space();button2=element("button");button2.textContent="Refresh";t5=space();if(if_block0)if_block0.c();t6=space();div1=element("div");button3=element("button");button3.textContent="Select All Shiny";t8=space();button4=element("button");button4.textContent=`${ctx[21]} Select Flagged Shiny`;t11=space();button5=element("button");button5.textContent="Deselect all";t13=space();button6=element("button");button6.textContent="Apply All Selected";t15=space();div3=element("div");if(if_block1)if_block1.c();t16=space();div4=element("div");if_block2.c();t17=space();if(if_block3)if_block3.c();t18=space();div5=element("div");label0=element("label");span0=element("span");span0.textContent="Hide not applicable items";input0=element("input");t20=space();div6=element("div");label1=element("label");span1=element("span");span1.textContent="Maintenance mode";input1=element("input");attr(button0,"class","svelte-if2qsj");attr(button1,"class","svelte-if2qsj");attr(button2,"class","svelte-if2qsj");attr(div0,"class","buttons svelte-if2qsj");attr(button3,"class","svelte-if2qsj");attr(button4,"class","svelte-if2qsj");attr(button5,"class","svelte-if2qsj");attr(button6,"class","mod-cta svelte-if2qsj");attr(div1,"class","buttons svelte-if2qsj");attr(div2,"class","buttonsWrap svelte-if2qsj");attr(div3,"class","loading svelte-if2qsj");attr(div4,"class","list svelte-if2qsj");attr(span0,"class","svelte-if2qsj");attr(input0,"type","checkbox");attr(label0,"class","svelte-if2qsj");attr(div5,"class","buttons svelte-if2qsj");attr(span1,"class","svelte-if2qsj");attr(input1,"type","checkbox");attr(label1,"class","svelte-if2qsj");attr(div6,"class","buttons svelte-if2qsj")},m(target,anchor){insert(target,div2,anchor);append(div2,div0);append(div0,button0);append(div0,t1);append(div0,button1);append(div0,t32);append(div0,button2);append(div0,t5);if(if_block0)if_block0.m(div0,null);append(div2,t6);append(div2,div1);append(div1,button3);append(div1,t8);append(div1,button4);append(div1,t11);append(div1,button5);append(div1,t13);append(div1,button6);insert(target,t15,anchor);insert(target,div3,anchor);if(if_block1)if_block1.m(div3,null);insert(target,t16,anchor);insert(target,div4,anchor);if_blocks[current_block_type_index].m(div4,null);insert(target,t17,anchor);if(if_block3)if_block3.m(target,anchor);insert(target,t18,anchor);insert(target,div5,anchor);append(div5,label0);append(label0,span0);append(label0,input0);input0.checked=ctx[3];insert(target,t20,anchor);insert(target,div6,anchor);append(div6,label1);append(label1,span1);append(label1,input1);input1.checked=ctx[1];current=true;if(!mounted){dispose=[listen(button0,"click",ctx[33]),listen(button1,"click",ctx[34]),listen(button2,"click",ctx[35]),listen(button3,"click",ctx[37]),listen(button4,"click",ctx[38]),listen(button5,"click",ctx[39]),listen(button6,"click",ctx[40]),listen(input0,"change",ctx[49]),listen(input1,"change",ctx[50])];mounted=true}},p(ctx2,dirty){if(ctx2[1])if(if_block0)if_block0.p(ctx2,dirty);else{if_block0=create_if_block_10(ctx2);if_block0.c();if_block0.m(div0,null)}else if(if_block0){if_block0.d(1);if_block0=null}if(ctx2[4]||0!==ctx2[12])if(if_block1)if_block1.p(ctx2,dirty);else{if_block1=create_if_block_9(ctx2);if_block1.c();if_block1.m(div3,null)}else if(if_block1){if_block1.d(1);if_block1=null}let previous_block_index=current_block_type_index;current_block_type_index=select_block_type(ctx2);if(current_block_type_index===previous_block_index)if_blocks[current_block_type_index].p(ctx2,dirty);else{group_outros();transition_out(if_blocks[previous_block_index],1,1,(()=>{if_blocks[previous_block_index]=null}));check_outros();if_block2=if_blocks[current_block_type_index];if(!if_block2){if_block2=if_blocks[current_block_type_index]=if_block_creators[current_block_type_index](ctx2);if_block2.c()}else if_block2.p(ctx2,dirty);transition_in(if_block2,1);if_block2.m(div4,null)}if(ctx2[1])if(if_block3)if_block3.p(ctx2,dirty);else{if_block3=create_if_block3(ctx2);if_block3.c();if_block3.m(t18.parentNode,t18)}else if(if_block3){if_block3.d(1);if_block3=null}if(8&dirty[0])input0.checked=ctx2[3];if(2&dirty[0])input1.checked=ctx2[1]},i(local){if(!current){transition_in(if_block2);current=true}},o(local){transition_out(if_block2);current=false},d(detaching){if(detaching){detach(div2);detach(t15);detach(div3);detach(t16);detach(div4);detach(t17);detach(t18);detach(div5);detach(t20);detach(div6)}if(if_block0)if_block0.d();if(if_block1)if_block1.d();if_blocks[current_block_type_index].d();if(if_block3)if_block3.d(detaching);mounted=false;run_all(dispose)}}}var PREFIX_PLUGIN_ALL="PLUGIN_ALL",PREFIX_PLUGIN_DATA="PLUGIN_DATA",PREFIX_PLUGIN_MAIN="PLUGIN_MAIN",PREFIX_PLUGIN_ETC="PLUGIN_ETC";function filterList(list,categories){return list.filter((e4=>-1!==categories.indexOf(e4.category))).sort(((a2,b3)=>`${a2.category}-${a2.name}`.localeCompare(`${b3.category}-${b3.name}`)))}function groupBy(items,key2){let ret={};for(const v2 of items){const k2=key2 in v2?v2[key2]:"";ret[k2]=ret[k2]||[];ret[k2].push(v2)}for(const k2 in ret)ret[k2]=ret[k2].sort(((a2,b3)=>`${a2.category}-${a2.name}`.localeCompare(`${b3.category}-${b3.name}`)));return Object.entries(ret).sort((([a2],[b3])=>`${a2}`.localeCompare(`${b3}`)))}function instance4($$self,$$props,$$invalidate){let hideNotApplicable,thisTerm,options,$pluginManifestStore,$pluginV2Progress;component_subscribe($$self,pluginManifestStore,($$value=>$$invalidate(32,$pluginManifestStore=$$value)));component_subscribe($$self,pluginV2Progress,($$value=>$$invalidate(12,$pluginV2Progress=$$value)));let{plugin:plugin3}=$$props;const addOn=plugin3.getAddOn(ConfigSync.name);if(!addOn){const msg="AddOn Module (ConfigSync) has not been loaded. This is very unexpected situation. Please report this issue.";Logger(msg,LOG_LEVEL_NOTICE);throw new Error(msg)}const addOnHiddenFileSync=plugin3.getAddOn(HiddenFileSync.name);if(!addOnHiddenFileSync){const msg="AddOn Module (HiddenFileSync) has not been loaded. This is very unexpected situation. Please report this issue.";Logger(msg,LOG_LEVEL_NOTICE);throw new Error(msg)}let list=[],selectNewestPulse=0,selectNewestStyle=0,hideEven=false,loading=false,applyAllPluse=0,isMaintenanceMode=false;async function requestUpdate(){await addOn.updatePluginList(true)}async function requestReload(){await addOn.reloadPluginList(true)}let allTerms=[];pluginList.subscribe((e4=>{$$invalidate(0,list=e4);$$invalidate(5,allTerms=unique(list.map((e5=>e5.term))))}));pluginIsEnumerating.subscribe((e4=>{$$invalidate(4,loading=e4)}));onMount((async()=>{requestUpdate()}));const displays={CONFIG:"Configuration",THEME:"Themes",SNIPPET:"Snippets"};async function scanAgain(){await addOn.scanAllConfigFiles(true);await requestUpdate()}async function replicate2(){await plugin3.$$replicate(true)}function selectAllNewest(selectMode){$$invalidate(27,selectNewestPulse++,selectNewestPulse);$$invalidate(28,selectNewestStyle=selectMode?1:2)}function resetSelectNewest(){$$invalidate(27,selectNewestPulse++,selectNewestPulse);$$invalidate(28,selectNewestStyle=3)}function applyAll(){$$invalidate(29,applyAllPluse++,applyAllPluse)}async function applyData(data){return await addOn.applyData(data)}async function compareData(docA,docB,compareEach=false){return await addOn.compareUsingDisplayData(docA,docB,compareEach)}async function deleteData(data){return await addOn.deleteData(data)}function askMode(evt,title,key2){var _a5;const menu=new import_obsidian5.Menu;menu.addItem((item=>item.setTitle(title).setIsLabel(true)));menu.addSeparator();const prevMode=null!==(_a5=automaticList.get(key2))&&void 0!==_a5?_a5:MODE_SELECTIVE;for(const mode of[MODE_SELECTIVE,MODE_AUTOMATIC,MODE_PAUSED,MODE_SHINY])menu.addItem((item=>{item.setTitle(`${getIcon(mode)}:${TITLES[mode]}`).onClick((e4=>{if(mode===MODE_AUTOMATIC)askOverwriteModeForAutomatic(evt,key2);else setMode(key2,mode)})).setChecked(prevMode==mode).setDisabled(prevMode==mode)}));menu.showAtMouseEvent(evt)}function applyAutomaticSync(key2,direction){var _a5,_b2;setMode(key2,MODE_AUTOMATIC);const configDir=normalizePath(plugin3.app.vault.configDir),files=(null!==(_b2=null===(_a5=plugin3.settings.pluginSyncExtendedSetting[key2])||void 0===_a5?void 0:_a5.files)&&void 0!==_b2?_b2:[]).map((e4=>`${configDir}/${e4}`));addOnHiddenFileSync.initialiseInternalFileSync(direction,true,files)}function askOverwriteModeForAutomatic(evt,key2){const menu=new import_obsidian5.Menu;menu.addItem((item=>item.setTitle("Initial Action").setIsLabel(true)));menu.addSeparator();menu.addItem((item=>{item.setTitle(": Overwrite Remote").onClick((e4=>{applyAutomaticSync(key2,"pushForce")}))})).addItem((item=>{item.setTitle(": Overwrite Local").onClick((e4=>{applyAutomaticSync(key2,"pullForce")}))})).addItem((item=>{item.setTitle(": Use newer").onClick((e4=>{applyAutomaticSync(key2,"safe")}))}));menu.showAtMouseEvent(evt)}const ICONS={[MODE_SELECTIVE]:"",[MODE_PAUSED]:"",[MODE_AUTOMATIC]:"",[MODE_SHINY]:""},TITLES={[MODE_SELECTIVE]:"Selective",[MODE_PAUSED]:"Ignore",[MODE_AUTOMATIC]:"Automatic",[MODE_SHINY]:"Flagged Selective"};function setMode(key2,mode){if(key2.startsWith(PREFIX_PLUGIN_ALL+"/")){setMode(PREFIX_PLUGIN_DATA+key2.substring(PREFIX_PLUGIN_ALL.length),mode);setMode(PREFIX_PLUGIN_MAIN+key2.substring(PREFIX_PLUGIN_ALL.length),mode);return}const files=unique(list.filter((e4=>`${e4.category}/${e4.name}`==key2)).map((e4=>e4.files)).flat().map((e4=>e4.filename)));if(mode==MODE_SELECTIVE){automaticList.delete(key2);delete plugin3.settings.pluginSyncExtendedSetting[key2];$$invalidate(6,automaticListDisp=automaticList)}else{automaticList.set(key2,mode);$$invalidate(6,automaticListDisp=automaticList);if(!(key2 in plugin3.settings.pluginSyncExtendedSetting))$$invalidate(26,plugin3.settings.pluginSyncExtendedSetting[key2]={key:key2,mode,files:[]},plugin3);$$invalidate(26,plugin3.settings.pluginSyncExtendedSetting[key2].files=files,plugin3);$$invalidate(26,plugin3.settings.pluginSyncExtendedSetting[key2].mode=mode,plugin3)}plugin3.$$saveSettingData()}function getIcon(mode){if(mode in ICONS)return ICONS[mode]}let automaticList=new Map,automaticListDisp=new Map;for(const{key:key2,mode}of Object.values(plugin3.settings.pluginSyncExtendedSetting))automaticList.set(key2,mode);automaticListDisp=automaticList;let displayKeys={},deleteTerm="";async function deleteAllItems(term){const deleteItems=list.filter((e4=>e4.term==term));for(const item of deleteItems)await deleteData(item);addOn.reloadPluginList(true)}let nameMap=new Map,displayEntries=[],pluginEntries=[],useSyncPluginEtc=plugin3.settings.usePluginEtc;$$self.$$set=$$props2=>{if("plugin"in $$props2)$$invalidate(26,plugin3=$$props2.plugin)};$$self.$$.update=()=>{if(67108864&$$self.$$.dirty[0])$$invalidate(31,thisTerm=plugin3.$$getDeviceAndVaultName());if(2080374786&$$self.$$.dirty[0]|1&$$self.$$.dirty[1])$$invalidate(11,options={thisTerm,hideNotApplicable,selectNewest:selectNewestPulse,selectNewestStyle,applyAllPluse,applyData,compareData,deleteData,plugin:plugin3,isMaintenanceMode});if(1&$$self.$$.dirty[0])$$invalidate(2,displayKeys=function computeDisplayKeys(list2){return[...list2,...Object.keys(plugin3.settings.pluginSyncExtendedSetting).map((e4=>`${e4}///`.split("/"))).filter((e4=>e4[0]&&e4[1])).map((e4=>({category:e4[0],name:e4[1],displayName:e4[1]})))].sort(((a2,b3)=>{var _a5,_b2;return(null!==(_a5=a2.displayName)&&void 0!==_a5?_a5:a2.name).localeCompare(null!==(_b2=b3.displayName)&&void 0!==_b2?_b2:b3.name)})).reduce(((p2,c2)=>{var _a5,_b2;return{...p2,[c2.category]:unique(c2.category in p2?[...p2[c2.category],null!==(_a5=c2.displayName)&&void 0!==_a5?_a5:c2.name]:[null!==(_b2=c2.displayName)&&void 0!==_b2?_b2:c2.name])}}),{})}(list));if(2&$$self.$$.dirty[1])(function updateNameMap(e4){const items=[...e4.entries()].map((([k2,v2])=>[k2.split("/").slice(-2).join("/"),v2.name])),newMap=new Map(items);if(newMap.size==nameMap.size){let diff=false;for(const[k2,v2]of newMap)if(nameMap.get(k2)!=v2){diff=true;break}if(!diff)return}$$invalidate(8,nameMap=newMap)})($pluginManifestStore);if(4&$$self.$$.dirty[0])$$invalidate(9,displayEntries=Object.entries(displays).filter((([key2,_])=>key2 in displayKeys)));if(1&$$self.$$.dirty[0])$$invalidate(10,pluginEntries=groupBy(filterList(list,["PLUGIN_MAIN","PLUGIN_DATA","PLUGIN_ETC"]),"name"))};$$invalidate(30,hideNotApplicable=false);return[list,isMaintenanceMode,displayKeys,hideEven,loading,allTerms,automaticListDisp,deleteTerm,nameMap,displayEntries,pluginEntries,options,$pluginV2Progress,requestUpdate,requestReload,scanAgain,replicate2,selectAllNewest,resetSelectNewest,applyAll,askMode,"",TITLES,getIcon,deleteAllItems,useSyncPluginEtc,plugin3,selectNewestPulse,selectNewestStyle,applyAllPluse,hideNotApplicable,thisTerm,$pluginManifestStore,()=>scanAgain(),()=>replicate2(),()=>requestUpdate(),()=>requestReload(),()=>selectAllNewest(true),()=>selectAllNewest(false),()=>resetSelectNewest(),()=>applyAll(),(key2,name,bindKey,evt)=>askMode(evt,`${key2}/${name}`,bindKey),(key2,name,e4)=>e4.category==key2&&e4.name==name,(name,bindKeyAll,evt)=>askMode(evt,`${PREFIX_PLUGIN_ALL}/${name}`,bindKeyAll),(name,bindKeyMain,evt)=>askMode(evt,`${PREFIX_PLUGIN_MAIN}/${name}/MAIN`,bindKeyMain),(name,bindKeyData,evt)=>askMode(evt,`${PREFIX_PLUGIN_DATA}/${name}`,bindKeyData),(name,bindKeyETC,evt)=>askMode(evt,`${PREFIX_PLUGIN_ETC}/${name}`,bindKeyETC),function select_change_handler(){deleteTerm=select_value(this);$$invalidate(7,deleteTerm);$$invalidate(5,allTerms)},evt=>{deleteAllItems(deleteTerm)},function input0_change_handler(){hideEven=this.checked;$$invalidate(3,hideEven)},function input1_change_handler(){isMaintenanceMode=this.checked;$$invalidate(1,isMaintenanceMode)}]}var PluginPane=class extends SvelteComponent{constructor(options){super();init(this,options,instance4,create_fragment4,safe_not_equal,{plugin:26},add_css4,[-1,-1,-1])}},PluginPane_default=PluginPane,PluginDialogModal=class extends import_obsidian.Modal{isOpened(){return null!=this.component}constructor(app2,plugin3){super(app2);this.plugin=plugin3}onOpen(){const{contentEl}=this;this.contentEl.style.overflow="auto";this.contentEl.style.display="flex";this.contentEl.style.flexDirection="column";this.titleEl.setText("Customization Sync (Beta3)");if(!this.component)this.component=new PluginPane_default({target:contentEl,props:{plugin:this.plugin}})}onClose(){if(this.component){this.component.$destroy();this.component=void 0}}},d="",d2="\n";function serialize(data){var _a5,_b2,_c2,_d2,_e2;let ret="";ret+=":";ret+=data.category+d+data.name+d+data.term+d2;ret+=(null!=(_a5=data.version)?_a5:"")+d2;ret+=data.mtime+d2;for(const file of data.files){ret+=file.filename+d+(null!=(_b2=file.displayName)?_b2:"")+d+(null!=(_c2=file.version)?_c2:"")+d2;const hash2=digestHash(null!=(_d2=file.data)?_d2:[]);ret+=file.mtime+d+file.size+d+hash2+d2;for(const data2 of null!=(_e2=file.data)?_e2:[])ret+=data2+d;ret+=d2}return ret}var DUMMY_HEAD=serialize({category:"CONFIG",name:"migrated",files:[],mtime:0,term:"-",displayName:"MIRAGED"}),DUMMY_END=d+d2+"";function splitWithDelimiters(sources){const result=[];for(const str of sources){let startIndex=0;const maxLen=str.length;let i1,i22,i2=-1;do{i1=str.indexOf(d,startIndex);i22=str.indexOf(d2,startIndex);if(-1==i1&&-1==i22)break;if(-1==i1)i2=i22;else if(-1==i22)i2=i1;else i2=i1<i22?i1:i22;result.push(str.slice(startIndex,i2+1));startIndex=i2+1}while(i2<maxLen);if(startIndex<maxLen)result.push(str.slice(startIndex))}if(""==sources[sources.length-1])result.push("");return result}function getTokenizer(source){const sources=splitWithDelimiters(source);sources[0]=sources[0].substring(1);let pos=0,lineRunOut=false;return{next(){if(lineRunOut)return"";if(pos>=sources.length)return"";const item=sources[pos];if(!item.endsWith(d2))pos++;else lineRunOut=true;if(item.endsWith(d)||item.endsWith(d2))return item.substring(0,item.length-1);else return item+this.next()},nextLine(){if(lineRunOut)pos++;else{for(;!sources[pos].endsWith(d2);){pos++;if(pos>=sources.length)break}pos++}lineRunOut=false}}}function deserialize2(str){const tokens=getTokenizer(str),category=tokens.next(),name=tokens.next(),term=tokens.next();tokens.nextLine();const version2=tokens.next();tokens.nextLine();const mtime=Number(tokens.next());tokens.nextLine();const result=Object.assign({},{category,name,term,version:version2,mtime,files:[]});let filename="";do{filename=tokens.next();if(!filename)break;const displayName=tokens.next(),version3=tokens.next();tokens.nextLine();const mtime2=Number(tokens.next()),size=Number(tokens.next()),hash2=tokens.next();tokens.nextLine();const data=[];let piece="";do{piece=tokens.next();if(""==piece)break;data.push(piece)}while(""!=piece);result.files.push({filename,displayName,version:version3,mtime:mtime2,size,data,hash:hash2});tokens.nextLine()}while(filename);return result}function deserialize(str,def){try{if(":"==str[0][0])return deserialize2(str);else return JSON.parse(str.join(""))}catch(e4){try{return(0,import_obsidian.parseYaml)(str.join(""))}catch(e5){return def}}}var pluginList=writable([]),pluginIsEnumerating=writable(false),pluginV2Progress=writable(0);function categoryToFolder(category,configDir=""){switch(category){case"CONFIG":return`${configDir}/`;case"THEME":return`${configDir}/themes/`;case"SNIPPET":return`${configDir}/snippets/`;case"PLUGIN_MAIN":return`${configDir}/plugins/`;case"PLUGIN_DATA":return`${configDir}/plugins/`;case"PLUGIN_ETC":return`${configDir}/plugins/`;default:return""}}var pluginManifests=new Map,pluginManifestStore=writable(pluginManifests);function setManifest(key2,manifest){const old=pluginManifests.get(key2);if(!old||isObjectDifferent(manifest,old)){pluginManifests.set(key2,manifest);pluginManifestStore.set(pluginManifests)}}var HttpAuthLocation,HttpApiKeyAuthLocation,EndpointURLScheme,AlgorithmId,PluginDataExDisplayV2=class{constructor(data){this.files=[];this.documentPath=`${data.documentPath}`;this.category=`${data.category}`;this.name=`${data.name}`;this.term=`${data.term}`;this.files=[...data.files];this.confKey=`${categoryToFolder(this.category,this.term)}${this.name}`;this.applyLoadedManifest()}async setFile(file){const old=this.files.find((e4=>e4.filename==file.filename));if(old){if(old.mtime==file.mtime&&await isDocContentSame(old.data,file.data))return;this.files=this.files.filter((e4=>e4.filename!=file.filename))}this.files.push(file);if("manifest.json"==file.filename)this.applyLoadedManifest()}deleteFile(filename){this.files=this.files.filter((e4=>e4.filename!=filename))}applyLoadedManifest(){const manifest=pluginManifests.get(this.confKey);if(manifest){this._displayName=manifest.name;if("PLUGIN_MAIN"==this.category||"THEME"==this.category)this._version=null==manifest?void 0:manifest.version}}get displayName(){return this._displayName||this.name}get version(){return this._version}get mtime(){return~~this.files.reduce(((a2,b3)=>a2+b3.mtime),0)/this.files.length}},ConfigSync=class extends LiveSyncCommands{constructor(plugin3){super(plugin3);this.pluginDialog=void 0;this.periodicPluginSweepProcessor=new PeriodicProcessor(this.plugin,(async()=>await this.scanAllConfigFiles(false)));this.pluginList=[];this.addRibbonIcon=this.plugin.addRibbonIcon.bind(this.plugin);this.pluginScanProcessor=new QueueProcessor((async v2=>{const plugin3=v2[0];if(this.useV2){await this.migrateV1ToV2(false,plugin3);return[]}const path2=plugin3.path||this.getPath(plugin3),oldEntry=this.pluginList.find((e4=>e4.documentPath==path2));if(oldEntry&&oldEntry.mtime==plugin3.mtime)return[];try{const pluginData=await this.loadPluginData(path2);if(pluginData){let newList=[...this.pluginList];newList=newList.filter((x2=>x2.documentPath!=pluginData.documentPath));newList.push(pluginData);this.pluginList=newList;pluginList.set(newList)}return[]}catch(ex){this._log(`Something happened at enumerating customization :${path2}`,LOG_LEVEL_NOTICE);this._log(ex,LOG_LEVEL_VERBOSE)}return[]}),{suspended:false,batchSize:1,concurrentLimit:10,delay:100,yieldThreshold:10,maintainDelay:false,totalRemainingReactiveSource:pluginScanningCount}).startPipeline();this.pluginScanProcessorV2=new QueueProcessor((async v2=>{const plugin3=v2[0],path2=plugin3.path||this.getPath(plugin3),oldEntry=this.pluginList.find((e4=>e4.documentPath==path2));if(oldEntry&&oldEntry.mtime==plugin3.mtime)return[];try{const pluginData=await this.loadPluginData(path2);if(pluginData){let newList=[...this.pluginList];newList=newList.filter((x2=>x2.documentPath!=pluginData.documentPath));newList.push(pluginData);this.pluginList=newList;pluginList.set(newList)}return[]}catch(ex){this._log(`Something happened at enumerating customization :${path2}`,LOG_LEVEL_NOTICE);this._log(ex,LOG_LEVEL_VERBOSE)}return[]}),{suspended:false,batchSize:1,concurrentLimit:10,delay:100,yieldThreshold:10,maintainDelay:false,totalRemainingReactiveSource:pluginScanningCount}).startPipeline();this.loadedManifest_mTime=new Map;this.updatingV2Count=0;this.recentProcessedInternalFiles=[];pluginScanningCount.onChanged((e4=>{const total=e4.value;pluginIsEnumerating.set(0!=total)}))}get kvDB(){return this.plugin.kvDB}get useV2(){return this.plugin.settings.usePluginSyncV2}get useSyncPluginEtc(){return this.plugin.settings.usePluginEtc}_isThisModuleEnabled(){return this.plugin.settings.usePluginSync}showPluginSyncModal(){if(this._isThisModuleEnabled())if(this.pluginDialog)this.pluginDialog.open();else{this.pluginDialog=new PluginDialogModal(this.app,this.plugin);this.pluginDialog.open()}}hidePluginSyncModal(){if(null!=this.pluginDialog){this.pluginDialog.close();this.pluginDialog=void 0}}onunload(){var _a5;this.hidePluginSyncModal();null==(_a5=this.periodicPluginSweepProcessor)||_a5.disable()}onload(){(0,import_obsidian.addIcon)("custom-sync",'<g transform="rotate(-90 75 218)"  fill="currentColor" fill-rule="evenodd">\n            <path d="m272 166-9.38 9.38 9.38 9.38 9.38-9.38c1.96-1.93 5.11-1.9 7.03 0.058 1.91 1.94 1.91 5.04 0 6.98l-9.38 9.38 5.86 5.86-11.7 11.7c-8.34 8.35-21.4 9.68-31.3 3.19l-3.84 3.98c-8.45 8.7-20.1 13.6-32.2 13.6h-5.55v-9.95h5.55c9.43-0.0182 18.5-3.84 25-10.6l3.95-4.09c-6.54-9.86-5.23-23 3.14-31.3l11.7-11.7 5.86 5.86 9.38-9.38c1.96-1.93 5.11-1.9 7.03 0.0564 1.91 1.93 1.91 5.04 2e-3 6.98z"/>\n        </g>');this.plugin.addCommand({id:"livesync-plugin-dialog-ex",name:"Show customization sync dialog",callback:()=>{this.showPluginSyncModal()}});this.addRibbonIcon("custom-sync","Show Customization sync",(()=>{this.showPluginSyncModal()})).addClass("livesync-ribbon-showcustom");eventHub.onEvent(EVENT_REQUEST_OPEN_PLUGIN_SYNC_DIALOG,(()=>this.showPluginSyncModal()))}getFileCategory(filePath){if(2==filePath.split("/").length&&filePath.endsWith(".json"))return"CONFIG";if(4==filePath.split("/").length&&filePath.startsWith(`${this.app.vault.configDir}/themes/`))return"THEME";if(filePath.startsWith(`${this.app.vault.configDir}/snippets/`)&&filePath.endsWith(".css"))return"SNIPPET";if(filePath.startsWith(`${this.app.vault.configDir}/plugins/`))if(filePath.endsWith("/styles.css")||filePath.endsWith("/manifest.json")||filePath.endsWith("/main.js"))return"PLUGIN_MAIN";else if(filePath.endsWith("/data.json"))return"PLUGIN_DATA";else return this.useV2&&this.useSyncPluginEtc?"PLUGIN_ETC":"";return""}isTargetPath(filePath){if(!filePath.startsWith(this.app.vault.configDir))return false;else return""!=this.getFileCategory(filePath)}async $everyOnDatabaseInitialized(showNotice){if(!this._isThisModuleEnabled())return true;try{this._log("Scanning customizations...");await this.scanAllConfigFiles(showNotice);this._log("Scanning customizations : done")}catch(ex){this._log("Scanning customizations : failed");this._log(ex,LOG_LEVEL_VERBOSE)}return true}async $everyBeforeReplicate(showNotice){if(!this._isThisModuleEnabled())return true;if(this.settings.autoSweepPlugins){await this.scanAllConfigFiles(showNotice);return true}return true}async $everyOnResumeProcess(){if(!this._isThisModuleEnabled())return true;if(this._isMainSuspended())return true;if(this.settings.autoSweepPlugins)await this.scanAllConfigFiles(false);this.periodicPluginSweepProcessor.enable(this.settings.autoSweepPluginsPeriodic&&!this.settings.watchInternalFileChanges?1e3*PERIODIC_PLUGIN_SWEEP:0);return true}$everyAfterResumeProcess(){const q2=activeDocument.querySelector(".livesync-ribbon-showcustom");null==q2||q2.toggleClass("sls-hidden",!this._isThisModuleEnabled());return Promise.resolve(true)}async reloadPluginList(showMessage){this.pluginList=[];this.loadedManifest_mTime.clear();pluginList.set(this.pluginList);await this.updatePluginList(showMessage)}async loadPluginData(path2){const wx=await this.localDatabase.getDBEntry(path2,void 0,false,false);if(wx){const data=deserialize(getDocDataAsArray(wx.data),{}),xFiles=[];let missingHash=false;for(const file of data.files){const work={...file,data:[]};if(!file.hash){const hash2=digestHash(getDocDataAsArray(work.data));file.hash=hash2;missingHash=true}work.data=[file.hash];xFiles.push(work)}if(missingHash){this._log(`Digest created for ${path2} to improve checking`,LOG_LEVEL_VERBOSE);wx.data=serialize(data);fireAndForget((()=>this.localDatabase.putDBEntry(createSavingEntryFromLoadedEntry(wx))))}return{...data,documentPath:this.getPath(wx),files:xFiles}}return false}filenameToUnifiedKey(path2,termOverRide){const term=termOverRide||this.plugin.$$getDeviceAndVaultName(),category=this.getFileCategory(path2),name="CONFIG"==category||"SNIPPET"==category?path2.split("/").slice(-1)[0]:"PLUGIN_ETC"==category?path2.split("/").slice(-2).join("/"):path2.split("/").slice(-2)[0];return`${ICXHeader}${term}/${category}/${name}.md`}filenameWithUnifiedKey(path2,termOverRide){const term=termOverRide||this.plugin.$$getDeviceAndVaultName(),category=this.getFileCategory(path2),name="CONFIG"==category||"SNIPPET"==category?path2.split("/").slice(-1)[0]:path2.split("/").slice(-2)[0],baseName="CONFIG"==category||"SNIPPET"==category?name:path2.split("/").slice(3).join("/");return`${ICXHeader}${term}/${category}/${name}%${baseName}`}unifiedKeyPrefixOfTerminal(termOverRide){const term=termOverRide||this.plugin.$$getDeviceAndVaultName();return`${ICXHeader}${term}/`}parseUnifiedPath(unifiedPath){const[device,category,...rest]=stripAllPrefixes(unifiedPath).split("/"),relativePath=rest.join("/"),[key2,filename]=relativePath.split("%");return{device,category,key:key2,filename,pathV1:unifiedPath.split("%")[0]+".md"}}async createPluginDataExFileV2(unifiedPathV2,loaded){const{category,key:key2,filename,device}=this.parseUnifiedPath(unifiedPathV2);if(!loaded){const d4=await this.localDatabase.getDBEntry(unifiedPathV2);if(!d4){this._log(`The file ${unifiedPathV2} is not found`,LOG_LEVEL_VERBOSE);return false}if(!isLoadedEntry(d4)){this._log(`The file ${unifiedPathV2} is not a note`,LOG_LEVEL_VERBOSE);return false}loaded=d4}const confKey=`${categoryToFolder(category,device)}${key2}`,relativeFilename=`${categoryToFolder(category,"")}${"CONFIG"==category||"SNIPPET"==category?"":key2+"/"}${filename}`.substring(1),dataSrc=getDocData(loaded.data),dataStart=dataSrc.indexOf(DUMMY_END),data=dataSrc.substring(dataStart+DUMMY_END.length),file={...loaded,hash:"",data:[base64ToString(data)],filename:relativeFilename,displayName:filename};if("manifest.json"==filename)if(this.loadedManifest_mTime.get(confKey)!=file.mtime&&null==pluginManifests.get(confKey)){try{const parsedManifest=JSON.parse(base64ToString(data));setManifest(confKey,parsedManifest);this.pluginList.filter((e4=>e4 instanceof PluginDataExDisplayV2&&e4.confKey==confKey)).forEach((e4=>e4.applyLoadedManifest()));pluginList.set(this.pluginList)}catch(ex){this._log(`The file ${loaded.path} seems to manifest, but could not be decoded as JSON`,LOG_LEVEL_VERBOSE);this._log(ex,LOG_LEVEL_VERBOSE)}this.loadedManifest_mTime.set(confKey,file.mtime)}else{this.pluginList.filter((e4=>e4 instanceof PluginDataExDisplayV2&&e4.confKey==confKey)).forEach((e4=>e4.applyLoadedManifest()));pluginList.set(this.pluginList)}return file}createPluginDataFromV2(unifiedPathV2){const{category,device,key:key2,pathV1}=this.parseUnifiedPath(unifiedPathV2);if(""!=category)return new PluginDataExDisplayV2({documentPath:pathV1,category,name:key2,term:`${device}`,files:[],mtime:0})}async updatePluginListV2(showMessage,unifiedFilenameWithKey){try{this.updatingV2Count++;pluginV2Progress.set(this.updatingV2Count);const{pathV1}=this.parseUnifiedPath(unifiedFilenameWithKey),oldEntry=this.pluginList.find((e4=>e4.documentPath==pathV1));let entry;if(!(oldEntry&&oldEntry instanceof PluginDataExDisplayV2)){const newEntry=this.createPluginDataFromV2(unifiedFilenameWithKey);if(newEntry)entry=newEntry}else if(oldEntry instanceof PluginDataExDisplayV2)entry=oldEntry;if(!entry)return;const file=await this.createPluginDataExFileV2(unifiedFilenameWithKey);if(file)await entry.setFile(file);else{entry.deleteFile(unifiedFilenameWithKey);if(0==entry.files.length)this.pluginList=this.pluginList.filter((e4=>e4.documentPath!=pathV1))}const newList=this.pluginList.filter((e4=>e4.documentPath!=entry.documentPath));newList.push(entry);this.pluginList=newList;scheduleTask("updatePluginListV2",100,(()=>{pluginList.set(this.pluginList)}))}finally{this.updatingV2Count--;pluginV2Progress.set(this.updatingV2Count)}}async migrateV1ToV2(showMessage,entry){var _a5;const v1Path=entry.path;this._log(`Migrating ${entry.path} to V2`,showMessage?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO);if(entry.deleted){this._log(`The entry ${v1Path} is already deleted`,LOG_LEVEL_VERBOSE);return}if(!v1Path.endsWith(".md")&&!v1Path.startsWith(ICXHeader)){this._log(`The entry ${v1Path} is not a customisation sync binder`,LOG_LEVEL_VERBOSE);return}if(-1!==v1Path.indexOf("%")){this._log(`The entry ${v1Path} is already migrated`,LOG_LEVEL_VERBOSE);return}const loadedEntry=await this.localDatabase.getDBEntry(v1Path);if(!loadedEntry){this._log(`The entry ${v1Path} is not found`,LOG_LEVEL_VERBOSE);return}const pluginData=deserialize(getDocDataAsArray(loadedEntry.data),{}),prefixPath=v1Path.slice(0,-3)+"%",category=pluginData.category;for(const f4 of pluginData.files){const stripTable={CONFIG:0,THEME:2,SNIPPET:1,PLUGIN_MAIN:2,PLUGIN_DATA:2,PLUGIN_ETC:2},deletePrefixCount=null!=(_a5=null==stripTable?void 0:stripTable[category])?_a5:1,relativeFilename=f4.filename.split("/").slice(deletePrefixCount).join("/"),v2Path=prefixPath+relativeFilename;this._log(`Migrating ${v1Path} / ${relativeFilename} to ${v2Path}`,LOG_LEVEL_VERBOSE);const newId=await this.plugin.$$path2id(v2Path),data=createBlob([DUMMY_HEAD,DUMMY_END,...getDocDataAsArray(f4.data)]),saving={...loadedEntry,_rev:void 0,_id:newId,path:v2Path,data,datatype:"plain",type:"plain",children:[],eden:{}},r2=await this.plugin.localDatabase.putDBEntry(saving);if(r2&&r2.ok){this._log(`Migrated ${v1Path} / ${f4.filename} to ${v2Path}`,LOG_LEVEL_INFO);if(await this.deleteConfigOnDatabase(v1Path))this._log(`Deleted ${v1Path} successfully`,LOG_LEVEL_INFO);else this._log(`Failed to delete ${v1Path}`,LOG_LEVEL_NOTICE)}}}async updatePluginList(showMessage,updatedDocumentPath){if(this._isThisModuleEnabled()){try{this.updatingV2Count++;pluginV2Progress.set(this.updatingV2Count);const updatedDocumentId=updatedDocumentPath?await this.path2id(updatedDocumentPath):"",plugins=updatedDocumentPath?this.localDatabase.findEntries(updatedDocumentId,updatedDocumentId+"",{include_docs:true,key:updatedDocumentId,limit:1}):this.localDatabase.findEntries(ICXHeader+"",`${ICXHeader}`,{include_docs:true});for await(const v2 of plugins){if(v2.deleted||v2._deleted)continue;if(-1!==v2.path.indexOf("%")){fireAndForget((()=>this.updatePluginListV2(showMessage,v2.path)));continue}const path2=v2.path||this.getPath(v2);if(!updatedDocumentPath||updatedDocumentPath==path2)this.pluginScanProcessor.enqueue(v2)}}finally{pluginIsEnumerating.set(false);this.updatingV2Count--;pluginV2Progress.set(this.updatingV2Count)}pluginIsEnumerating.set(false)}else{this.pluginScanProcessor.clearQueue();this.pluginList=[];pluginList.set(this.pluginList)}}async compareUsingDisplayData(dataA,dataB,compareEach=false){const loadFile=async data=>{if(data instanceof PluginDataExDisplayV2||compareEach)return data.files[0];const loadDoc=await this.localDatabase.getDBEntry(data.documentPath);if(!loadDoc)return false;const pluginData=deserialize(getDocDataAsArray(loadDoc.data),{});pluginData.documentPath=data.documentPath;const file=pluginData.files[0];return{...loadDoc,...file,datatype:"newnote"}},fileA=await loadFile(dataA),fileB=await loadFile(dataB);this._log(`Comparing: ${dataA.documentPath} <-> ${dataB.documentPath}`,LOG_LEVEL_VERBOSE);if(!fileA||!fileB){this._log(`Could not load ${dataA.name} for comparison: ${!fileA?dataA.term:""}${!fileB?dataB.term:""}`,LOG_LEVEL_NOTICE);return false}let path2=stripAllPrefixes(fileA.path.split("/").slice(-1).join("/"));if(-1!==path2.indexOf("%"))path2=path2.split("%")[1];if(fileA.path.endsWith(".json"))return serialized("config:merge-data",(()=>new Promise((res2=>{this._log("Opening data-merging dialog",LOG_LEVEL_VERBOSE);new JsonResolveModal(this.app,path2,[fileA,fileB],(async(keep,result)=>{if(null==result)return res2(false);try{res2(await this.applyData(dataA,result))}catch(ex){this._log("Could not apply merged file");this._log(ex,LOG_LEVEL_VERBOSE);res2(false)}}),"Local",`${dataB.term}`,"B",true,true,"Difference between local and remote").open()}))));else{const dmp=new import_diff_match_patch.diff_match_patch;let docAData=getDocData(fileA.data),docBData=getDocData(fileB.data);if("plain"!=(null==fileA?void 0:fileA.datatype))docAData=base64ToString(docAData);if("plain"!=(null==fileB?void 0:fileB.datatype))docBData=base64ToString(docBData);const diffMap=dmp.diff_linesToChars_(docAData,docBData),diff=dmp.diff_main(diffMap.chars1,diffMap.chars2,false);dmp.diff_charsToLines_(diff,diffMap.lineArray);dmp.diff_cleanupSemantic(diff);const diffResult={left:{rev:"A",...fileA,data:docAData},right:{rev:"B",...fileB,data:docBData},diff},d4=new ConflictResolveModal(this.app,path2,diffResult,true,dataB.term);d4.open();const ret=await d4.waitForResult();if(ret===CANCELLED)return false;if(ret===LEAVE_TO_SUBSEQUENT)return false;const resultContent="A"==ret?docAData:"B"==ret?docBData:void 0;if(resultContent)return await this.applyData(dataA,resultContent);else return false}}async applyDataV2(data,content){const baseDir=this.app.vault.configDir;try{if(content){const filename=data.files[0].filename;this._log(`Applying ${filename} of ${data.displayName||data.name}..`);const path2=`${baseDir}/${filename}`;await this.plugin.storageAccess.ensureDir(path2);await this.plugin.storageAccess.writeHiddenFileAuto(path2,content);await this.storeCustomisationFileV2(path2,this.plugin.$$getDeviceAndVaultName())}else{const files=data.files;for(const f4 of files){const stat={mtime:f4.mtime,ctime:f4.ctime},path2=`${baseDir}/${f4.filename}`;this._log(`Applying ${f4.filename} of ${data.displayName||data.name}..`);await this.plugin.storageAccess.ensureDir(path2);if("newnote"==f4.datatype){let oldData;try{oldData=await this.plugin.storageAccess.readHiddenFileBinary(path2)}catch(ex){this._log(`Could not read the file ${f4.filename}`,LOG_LEVEL_VERBOSE);this._log(ex,LOG_LEVEL_VERBOSE);oldData=new ArrayBuffer(0)}const content2=base64ToArrayBuffer(f4.data);if(await isDocContentSame(oldData,content2)){this._log(`The file ${f4.filename} is already up-to-date`,LOG_LEVEL_VERBOSE);continue}await this.plugin.storageAccess.writeHiddenFileAuto(path2,content2,stat)}else{let oldData;try{oldData=await this.plugin.storageAccess.readHiddenFileText(path2)}catch(ex){this._log(`Could not read the file ${f4.filename}`,LOG_LEVEL_VERBOSE);this._log(ex,LOG_LEVEL_VERBOSE);oldData=""}const content2=getDocData(f4.data);if(await isDocContentSame(oldData,content2)){this._log(`The file ${f4.filename} is already up-to-date`,LOG_LEVEL_VERBOSE);continue}await this.plugin.storageAccess.writeHiddenFileAuto(path2,content2,stat)}this._log(`Applied ${f4.filename} of ${data.displayName||data.name}..`);await this.storeCustomisationFileV2(path2,this.plugin.$$getDeviceAndVaultName())}}}catch(ex){this._log(`Applying ${data.displayName||data.name}.. Failed`,LOG_LEVEL_NOTICE);this._log(ex,LOG_LEVEL_VERBOSE);return false}return true}async applyData(data,content){this._log(`Applying ${data.displayName||data.name}..`);if(data instanceof PluginDataExDisplayV2)return this.applyDataV2(data,content);const baseDir=this.app.vault.configDir;try{if(!data.documentPath)throw"InternalError: Document path not exist";const dx=await this.localDatabase.getDBEntry(data.documentPath);if(false==dx)throw"Not found on database";const loadedData=deserialize(getDocDataAsArray(dx.data),{});for(const f4 of loadedData.files){this._log(`Applying ${f4.filename} of ${data.displayName||data.name}..`);try{const path2=`${baseDir}/${f4.filename}`;await this.plugin.storageAccess.ensureDir(path2);if(!content){const dt=decodeBinary(f4.data);await this.plugin.storageAccess.writeHiddenFileAuto(path2,dt)}else await this.plugin.storageAccess.writeHiddenFileAuto(path2,content);this._log(`Applying ${f4.filename} of ${data.displayName||data.name}.. Done`)}catch(ex){this._log(`Applying ${f4.filename} of ${data.displayName||data.name}.. Failed`);this._log(ex,LOG_LEVEL_VERBOSE)}}const uPath=`${baseDir}/${loadedData.files[0].filename}`;await this.storeCustomizationFiles(uPath);await this.updatePluginList(true,uPath);await delay(100);this._log(`Config ${data.displayName||data.name} has been applied`,LOG_LEVEL_NOTICE);if("PLUGIN_DATA"==data.category||"PLUGIN_MAIN"==data.category){const manifests=Object.values(this.app.plugins.manifests),enabledPlugins=this.app.plugins.enabledPlugins,pluginManifest=manifests.find((manifest=>enabledPlugins.has(manifest.id)&&manifest.dir==`${baseDir}/plugins/${data.name}`));if(pluginManifest){this._log(`Unloading plugin: ${pluginManifest.name}`,LOG_LEVEL_NOTICE,"plugin-reload-"+pluginManifest.id);await this.app.plugins.unloadPlugin(pluginManifest.id);await this.app.plugins.loadPlugin(pluginManifest.id);this._log(`Plugin reloaded: ${pluginManifest.name}`,LOG_LEVEL_NOTICE,"plugin-reload-"+pluginManifest.id)}}else if("CONFIG"==data.category)this.plugin.$$askReload();return true}catch(ex){this._log(`Applying ${data.displayName||data.name}.. Failed`);this._log(ex,LOG_LEVEL_VERBOSE);return false}}async deleteData(data){try{if(data.documentPath){const delList=[];if(this.useV2){const deleteList=this.pluginList.filter((e4=>e4.documentPath==data.documentPath)).filter((e4=>e4 instanceof PluginDataExDisplayV2)).map((e4=>e4.files)).flat();for(const e4 of deleteList)delList.push(e4.path)}delList.push(data.documentPath);const p2=delList.map((async e4=>{await this.deleteConfigOnDatabase(e4);await this.updatePluginList(false,e4)}));await Promise.allSettled(p2);this._log(`Deleted: ${data.category}/${data.name} of ${data.category} (${delList.length} items)`,LOG_LEVEL_NOTICE)}return true}catch(ex){this._log(`Failed to delete: ${data.documentPath}`,LOG_LEVEL_NOTICE);this._log(ex,LOG_LEVEL_VERBOSE);return false}}async $anyModuleParsedReplicationResultItem(docs){if(docs._id.startsWith(ICXHeader)){if(this._isThisModuleEnabled())await this.updatePluginList(false,docs.path?docs.path:this.getPath(docs));if(this._isThisModuleEnabled()&&this.plugin.settings.notifyPluginOrSettingUpdated)if(!this.pluginDialog||this.pluginDialog&&!this.pluginDialog.isOpened()){const fragment=createFragment((doc=>{doc.createEl("span",void 0,(a2=>{a2.appendText("Some configuration has been arrived, Press ");a2.appendChild(a2.createEl("a",void 0,(anchor=>{anchor.text="HERE";anchor.addEventListener("click",(()=>{this.showPluginSyncModal()}))})));a2.appendText(" to open the config sync dialog , or press elsewhere to dismiss this message.")}))})),updatedPluginKey="popupUpdated-plugins";scheduleTask(updatedPluginKey,1e3,(async()=>{var _a5;const popup=await memoIfNotExist(updatedPluginKey,(()=>new import_obsidian.Notice(fragment,0)));if(!(null==(_a5=null==popup?void 0:popup.noticeEl)?void 0:_a5.isShown()))memoObject(updatedPluginKey,new import_obsidian.Notice(fragment,0));scheduleTask(updatedPluginKey+"-close",2e4,(()=>{var _a6;const popup2=retrieveMemoObject(updatedPluginKey);if(popup2){if(null==(_a6=null==popup2?void 0:popup2.noticeEl)?void 0:_a6.isShown())popup2.hide();disposeMemoObject(updatedPluginKey)}}))}))}return true}}async $everyRealizeSettingSyncMode(){var _a5;null==(_a5=this.periodicPluginSweepProcessor)||_a5.disable();if(!this._isMainReady)return true;if(!this._isMainSuspended())return true;if(!this._isThisModuleEnabled())return true;if(this.settings.autoSweepPlugins)await this.scanAllConfigFiles(false);this.periodicPluginSweepProcessor.enable(this.settings.autoSweepPluginsPeriodic&&!this.settings.watchInternalFileChanges?1e3*PERIODIC_PLUGIN_SWEEP:0);return true}async makeEntryFromFile(path2){const stat=await this.plugin.storageAccess.statHidden(path2);let version2,displayName;if(!stat)return false;const contentBin=await this.plugin.storageAccess.readHiddenFileBinary(path2);let content;try{content=await arrayBufferToBase64(contentBin);if(path2.toLowerCase().endsWith("/manifest.json")){const v2=readString(new Uint8Array(contentBin));try{const json=JSON.parse(v2);if("version"in json)version2=`${json.version}`;if("name"in json)displayName=`${json.name}`}catch(ex){this._log(`Configuration sync data: ${path2} looks like manifest, but could not read the version`,LOG_LEVEL_INFO);this._log(ex,LOG_LEVEL_VERBOSE)}}}catch(ex){this._log(`The file ${path2} could not be encoded`);this._log(ex,LOG_LEVEL_VERBOSE);return false}const mtime=stat.mtime;return{filename:path2.substring(this.app.vault.configDir.length+1),data:content,mtime,size:stat.size,version:version2,displayName}}async storeCustomisationFileV2(path2,term,force=false){const vf=this.filenameWithUnifiedKey(path2,term);return await serialized(`plugin-${vf}`,(async()=>{const prefixedFileName=vf,id=await this.path2id(prefixedFileName),stat=await this.plugin.storageAccess.statHidden(path2);if(!stat)return false;const mtime=stat.mtime,content=await this.plugin.storageAccess.readHiddenFileBinary(path2),contentBlob=createBlob([DUMMY_HEAD,DUMMY_END,...await arrayBufferToBase64(content)]);try{const old=await this.localDatabase.getDBEntryMeta(prefixedFileName,void 0,false);let saveData;if(false===old)saveData={_id:id,path:prefixedFileName,data:contentBlob,mtime,ctime:mtime,datatype:"plain",size:contentBlob.size,children:[],deleted:false,type:"plain",eden:{}};else{if(isMarkedAsSameChanges(prefixedFileName,[old.mtime,mtime+1])==EVEN){this._log(`STORAGE --\x3e DB:${prefixedFileName}: (config) Skipped (Already checked the same)`,LOG_LEVEL_DEBUG);return}const docXDoc=await this.localDatabase.getDBEntryFromMeta(old,{},false,false);if(false==docXDoc)throw"Could not load the document";const dataSrc=getDocData(docXDoc.data),dataStart=dataSrc.indexOf(DUMMY_END),oldContentArray=base64ToArrayBuffer(dataSrc.substring(dataStart+DUMMY_END.length));if(await isDocContentSame(oldContentArray,content)){this._log(`STORAGE --\x3e DB:${prefixedFileName}: (config) Skipped (the same content)`,LOG_LEVEL_VERBOSE);markChangesAreSame(prefixedFileName,old.mtime,mtime+1);return true}saveData={...old,data:contentBlob,mtime,size:contentBlob.size,datatype:"plain",children:[],deleted:false,type:"plain"}}const ret=await this.localDatabase.putDBEntry(saveData);this._log(`STORAGE --\x3e DB:${prefixedFileName}: (config) Done`);fireAndForget((()=>this.updatePluginListV2(false,this.filenameWithUnifiedKey(path2))));return ret}catch(ex){this._log(`STORAGE --\x3e DB:${prefixedFileName}: (config) Failed`);this._log(ex,LOG_LEVEL_VERBOSE);return false}}))}async storeCustomizationFiles(path2,termOverRide){const term=termOverRide||this.plugin.$$getDeviceAndVaultName();if(""==term){this._log("We have to configure the device name",LOG_LEVEL_NOTICE);return}if(this.useV2)return await this.storeCustomisationFileV2(path2,term);const vf=this.filenameToUnifiedKey(path2,term);return await serialized(`plugin-${vf}`,(async()=>{const category=this.getFileCategory(path2);let mtime=0,fileTargets=[];const name="CONFIG"==category||"SNIPPET"==category?path2.split("/").reverse()[0]:path2.split("/").reverse()[1],parentPath=path2.split("/").slice(0,-1).join("/"),prefixedFileName=this.filenameToUnifiedKey(path2,term),id=await this.path2id(prefixedFileName),dt={category,files:[],name,mtime:0,term};if("CONFIG"==category||"SNIPPET"==category||"PLUGIN_ETC"==category||"PLUGIN_DATA"==category){fileTargets=[path2];if("PLUGIN_ETC"==category)dt.displayName=path2.split("/").slice(-1).join("/")}else if("PLUGIN_MAIN"==category)fileTargets=["manifest.json","main.js","styles.css"].map((e4=>`${parentPath}/${e4}`));else if("THEME"==category)fileTargets=["manifest.json","theme.css"].map((e4=>`${parentPath}/${e4}`));for(const target of fileTargets){const data=await this.makeEntryFromFile(target);if(false!=data){if(data.version)dt.version=data.version;if(data.displayName)dt.displayName=data.displayName;mtime=0==mtime?data.mtime:(data.mtime+mtime)/2;dt.files.push(data)}else this._log(`Config: skipped (Possibly is not exist): ${target} `,LOG_LEVEL_VERBOSE)}dt.mtime=mtime;if(0==dt.files.length){this._log(`Nothing left: deleting.. ${path2}`);await this.deleteConfigOnDatabase(prefixedFileName);await this.updatePluginList(false,prefixedFileName);return}const content=createTextBlob(serialize(dt));try{const old=await this.localDatabase.getDBEntryMeta(prefixedFileName,void 0,false);let saveData;if(false===old)saveData={_id:id,path:prefixedFileName,data:content,mtime,ctime:mtime,datatype:"newnote",size:content.size,children:[],deleted:false,type:"newnote",eden:{}};else{if(old.mtime==mtime)return true;const oldC=await this.localDatabase.getDBEntryFromMeta(old,{},false,false);if(oldC){const d4=await deserialize(getDocDataAsArray(oldC.data),{});if(d4.files.length==dt.files.length){const diffs=d4.files.map((previous=>({prev:previous,curr:dt.files.find((e4=>e4.filename==previous.filename))}))).map((async e4=>{var _a5,_b2;try{return await isDocContentSame(null!=(_b2=null==(_a5=e4.curr)?void 0:_a5.data)?_b2:[],e4.prev.data)}catch(e5){return false}}));if((await Promise.all(diffs)).every((e4=>true==e4))){this._log(`STORAGE --\x3e DB:${prefixedFileName}: (config) Skipped (Same content)`,LOG_LEVEL_VERBOSE);return true}}}saveData={...old,data:content,mtime,size:content.size,datatype:"newnote",children:[],deleted:false,type:"newnote"}}const ret=await this.localDatabase.putDBEntry(saveData);await this.updatePluginList(false,saveData.path);this._log(`STORAGE --\x3e DB:${prefixedFileName}: (config) Done`);return ret}catch(ex){this._log(`STORAGE --\x3e DB:${prefixedFileName}: (config) Failed`);this._log(ex,LOG_LEVEL_VERBOSE);return false}}))}async $anyProcessOptionalFileEvent(path2){return await this.watchVaultRawEventsAsync(path2)}async watchVaultRawEventsAsync(path2){if(!this._isMainReady)return false;if(this._isMainSuspended())return false;if(!this._isThisModuleEnabled())return false;const stat=await this.plugin.storageAccess.statHidden(path2);if(stat&&"file"!=stat.type)return false;const configDir=normalizePath(this.app.vault.configDir);if(Object.values(this.settings.pluginSyncExtendedSetting).filter((e4=>e4.mode!=MODE_SELECTIVE&&e4.mode!=MODE_SHINY)).map((e4=>e4.files)).flat().map((e4=>`${configDir}/${e4}`.toLowerCase())).some((e4=>e4.startsWith(path2.toLowerCase())))){this._log(`Customization file skipped: ${path2}`,LOG_LEVEL_VERBOSE);return false}const storageMTime=~~((stat&&stat.mtime||0)/1e3),key2=`${path2}-${storageMTime}`;if(this.recentProcessedInternalFiles.contains(key2))return true;this.recentProcessedInternalFiles=[key2,...this.recentProcessedInternalFiles].slice(0,100);scheduleTask(this.filenameToUnifiedKey(path2),100,(async()=>{await this.storeCustomizationFiles(path2)}));return true}async scanAllConfigFiles(showMessage){await shareRunningResult("scanAllConfigFiles",(async()=>{var _a5;const logLevel=showMessage?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO;this._log("Scanning customizing files.",logLevel,"scan-all-config");const term=this.plugin.$$getDeviceAndVaultName();if(""==term){this._log("We have to configure the device name",LOG_LEVEL_NOTICE);return}const filesAll=await this.scanInternalFiles();if(this.useV2){const filesAllUnified=filesAll.filter((e4=>this.isTargetPath(e4))).map((e4=>[this.filenameWithUnifiedKey(e4,term),e4])),localFileMap=new Map(filesAllUnified.map((e4=>[e4[0],e4[1]]))),prefix=this.unifiedKeyPrefixOfTerminal(term),entries=this.localDatabase.findEntries(prefix+"",`${prefix}`,{include_docs:true}),tasks4=[],semaphore=Semaphore(10);for await(const item of entries)if(-1===item.path.indexOf("%"))tasks4.push((async()=>{const releaser=await semaphore.acquire();try{const unifiedFilenameWithKey=`${item._id}`,localPath=localFileMap.get(unifiedFilenameWithKey);if(localPath){await this.storeCustomisationFileV2(localPath,term);localFileMap.delete(unifiedFilenameWithKey)}else await this.deleteConfigOnDatabase(unifiedFilenameWithKey)}catch(ex){this._log(`scanAllConfigFiles - Error: ${item._id}`,LOG_LEVEL_VERBOSE);this._log(ex,LOG_LEVEL_VERBOSE)}finally{releaser()}}));await Promise.all(tasks4.map((e4=>e4())));const taskExtra=[];for(const[,filePath]of localFileMap)taskExtra.push((async()=>{const releaser=await semaphore.acquire();try{await this.storeCustomisationFileV2(filePath,term)}catch(ex){this._log(`scanAllConfigFiles - Error: ${filePath}`,LOG_LEVEL_VERBOSE);this._log(ex,LOG_LEVEL_VERBOSE)}finally{releaser()}}));await Promise.all(taskExtra.map((e4=>e4())));fireAndForget((()=>this.updatePluginList(false)))}else{const files=filesAll.filter((e4=>this.isTargetPath(e4))).map((e4=>({key:this.filenameToUnifiedKey(e4),file:e4}))),virtualPathsOfLocalFiles=[...new Set(files.map((e4=>e4.key)))];let deleteCandidate=(await this.localDatabase.allDocsRaw({startkey:ICXHeader+"",endkey:`${ICXHeader}`,include_docs:true})).rows.map((e4=>e4.doc)).filter((e4=>!e4.deleted)).map((e4=>this.getPath(e4))).filter((e4=>e4.startsWith(`${ICXHeader}${term}/`)));for(const vp of virtualPathsOfLocalFiles){const p2=null==(_a5=files.find((e4=>e4.key==vp)))?void 0:_a5.file;if(p2){await this.storeCustomizationFiles(p2);deleteCandidate=deleteCandidate.filter((e4=>e4!=vp))}else this._log(`scanAllConfigFiles - File not found: ${vp}`,LOG_LEVEL_VERBOSE)}for(const vp of deleteCandidate)await this.deleteConfigOnDatabase(vp);fireAndForget((()=>this.updatePluginList(false)))}}))}async deleteConfigOnDatabase(prefixedFileName,forceWrite=false){const mtime=(new Date).getTime();return await serialized("file-x-"+prefixedFileName,(async()=>{try{const old=await this.localDatabase.getDBEntryMeta(prefixedFileName,void 0,false);let saveData;if(false===old){this._log(`STORAGE -x> DB:${prefixedFileName}: (config) already deleted (Not found on database)`);return true}else{if(old.deleted){this._log(`STORAGE -x> DB:${prefixedFileName}: (config) already deleted`);return true}saveData={...old,mtime,size:0,children:[],deleted:true,type:"newnote"}}await this.localDatabase.putRaw(saveData);await this.updatePluginList(false,prefixedFileName);this._log(`STORAGE -x> DB:${prefixedFileName}: (config) Done`);return true}catch(ex){this._log(`STORAGE -x> DB:${prefixedFileName}: (config) Failed`);this._log(ex,LOG_LEVEL_VERBOSE);return false}}))}async scanInternalFiles(){return(await this.getFiles(this.app.vault.configDir,2)).filter((e4=>e4.startsWith("."))).filter((e4=>!e4.startsWith(".trash")))}async $allAskUsingOptionalSyncFeature(opt){await this._askHiddenFileConfiguration(opt);return true}async _askHiddenFileConfiguration(opt){const choices=[];choices.push("Yes, Enable it");choices.push("No, Disable it");choices.push("Later");const ret=await this.plugin.confirm.askSelectStringDialogue("Would you like to enable **Customization sync**?\n\n> [!DETAILS]-\n> This feature allows you to sync your customisations -- such as configurations, themes, snippets, and plugins -- across your devices in a fully controlled manner, unlike the fully automatic behaviour of hidden file synchronisation.\n> \n> You may use this feature alongside hidden file synchronisation. When both features are enabled, items configured as `Automatic` in this feature will be managed by **hidden file synchronisation**.\n> Do not worry, you will be prompted to enable or keep disabled **hidden file synchronisation** after this dialogue.\n",choices,{defaultAction:"Later",timeout:40,title:"Customisation sync"});if("Yes, Enable it"==ret)await this.configureHiddenFileSync("CUSTOMIZE");else if("No, Disable it"==ret)await this.configureHiddenFileSync("DISABLE_CUSTOM")}$anyGetOptionalConflictCheckMethod(path2){if(isPluginMetadata(path2))return Promise.resolve("newer");if(isCustomisationSyncMetadata(path2))return Promise.resolve("newer");else return Promise.resolve(false)}$allSuspendExtraSync(){if(this.plugin.settings.usePluginSync||this.plugin.settings.autoSweepPlugins){this._log("Customisation sync have been temporarily disabled. Please enable them after the fetching, if you need them.",LOG_LEVEL_NOTICE);this.plugin.settings.usePluginSync=false;this.plugin.settings.autoSweepPlugins=false}return Promise.resolve(true)}async $anyConfigureOptionalSyncFeature(mode){await this.configureHiddenFileSync(mode)}async configureHiddenFileSync(mode){if("DISABLE"!=mode){if("CUSTOMIZE"==mode){if(!this.plugin.$$getDeviceAndVaultName()){let name=await this.plugin.confirm.askString("Device name","Please set this device name","desktop");if(!name){if(import_obsidian.Platform.isAndroidApp)name="android-app";else if(import_obsidian.Platform.isIosApp)name="ios";else if(import_obsidian.Platform.isMacOS)name="macos";else if(import_obsidian.Platform.isMobileApp)name="mobile-app";else if(import_obsidian.Platform.isMobile)name="mobile";else if(import_obsidian.Platform.isSafari)name="safari";else if(import_obsidian.Platform.isDesktop)name="desktop";else if(import_obsidian.Platform.isDesktopApp)name="desktop-app";else name="unknown";name+=Math.random().toString(36).slice(-4)}this.plugin.$$setDeviceAndVaultName(name)}this.plugin.settings.usePluginSync=true;this.plugin.settings.useAdvancedMode=true;await this.plugin.saveSettings();await this.scanAllConfigFiles(true)}}else{this.plugin.settings.usePluginSync=false;await this.plugin.saveSettings()}}async getFiles(path2,lastDepth){if(-1==lastDepth)return[];let w2;try{w2=await this.app.vault.adapter.list(path2)}catch(ex){this._log(`Could not traverse(ConfigSync):${path2}`,LOG_LEVEL_INFO);this._log(ex,LOG_LEVEL_VERBOSE);return[]}let files=[...w2.files];for(const v2 of w2.folders)files=files.concat(await this.getFiles(v2,lastDepth-1));return files}},getHttpHandlerExtensionConfiguration=runtimeConfig=>{let httpHandler=runtimeConfig.httpHandler;return{setHttpHandler(handler){httpHandler=handler},httpHandler:()=>httpHandler,updateHttpClientConfig(key2,value){httpHandler.updateHttpClientConfig(key2,value)},httpHandlerConfigs:()=>httpHandler.httpHandlerConfigs()}},resolveHttpHandlerRuntimeConfig=httpHandlerExtensionConfiguration=>({httpHandler:httpHandlerExtensionConfiguration.httpHandler()});(function(HttpAuthLocation2){HttpAuthLocation2["HEADER"]="header";HttpAuthLocation2["QUERY"]="query"})(HttpAuthLocation||(HttpAuthLocation={}));(function(HttpApiKeyAuthLocation2){HttpApiKeyAuthLocation2["HEADER"]="header";HttpApiKeyAuthLocation2["QUERY"]="query"})(HttpApiKeyAuthLocation||(HttpApiKeyAuthLocation={}));(function(EndpointURLScheme2){EndpointURLScheme2["HTTP"]="http";EndpointURLScheme2["HTTPS"]="https"})(EndpointURLScheme||(EndpointURLScheme={}));(function(AlgorithmId2){AlgorithmId2["MD5"]="md5";AlgorithmId2["CRC32"]="crc32";AlgorithmId2["CRC32C"]="crc32c";AlgorithmId2["SHA1"]="sha1";AlgorithmId2["SHA256"]="sha256"})(AlgorithmId||(AlgorithmId={}));var FieldPosition,getChecksumConfiguration=runtimeConfig=>{const checksumAlgorithms=[];if(void 0!==runtimeConfig.sha256)checksumAlgorithms.push({algorithmId:()=>AlgorithmId.SHA256,checksumConstructor:()=>runtimeConfig.sha256});if(null!=runtimeConfig.md5)checksumAlgorithms.push({algorithmId:()=>AlgorithmId.MD5,checksumConstructor:()=>runtimeConfig.md5});return{_checksumAlgorithms:checksumAlgorithms,addChecksumAlgorithm(algo){this._checksumAlgorithms.push(algo)},checksumAlgorithms(){return this._checksumAlgorithms}}},resolveChecksumRuntimeConfig=clientConfig=>{const runtimeConfig={};clientConfig.checksumAlgorithms().forEach((checksumAlgorithm=>{runtimeConfig[checksumAlgorithm.algorithmId()]=checksumAlgorithm.checksumConstructor()}));return runtimeConfig},getDefaultClientConfiguration=runtimeConfig=>({...getChecksumConfiguration(runtimeConfig)}),resolveDefaultRuntimeConfig=config=>({...resolveChecksumRuntimeConfig(config)});(function(FieldPosition2){FieldPosition2[FieldPosition2["HEADER"]=0]="HEADER";FieldPosition2[FieldPosition2["TRAILER"]=1]="TRAILER"})(FieldPosition||(FieldPosition={}));var IniSectionType,RequestHandlerProtocol,SMITHY_CONTEXT_KEY="__smithy_context";(function(IniSectionType2){IniSectionType2["PROFILE"]="profile";IniSectionType2["SSO_SESSION"]="sso-session";IniSectionType2["SERVICES"]="services"})(IniSectionType||(IniSectionType={}));(function(RequestHandlerProtocol2){RequestHandlerProtocol2["HTTP_0_9"]="http/0.9";RequestHandlerProtocol2["HTTP_1_0"]="http/1.0";RequestHandlerProtocol2["TDS_8_0"]="tds/8.0"})(RequestHandlerProtocol||(RequestHandlerProtocol={}));var Field=class{constructor({name,kind=FieldPosition.HEADER,values=[]}){this.name=name;this.kind=kind;this.values=values}add(value){this.values.push(value)}set(values){this.values=values}remove(value){this.values=this.values.filter((v2=>v2!==value))}toString(){return this.values.map((v2=>v2.includes(",")||v2.includes(" ")?`"${v2}"`:v2)).join(", ")}get(){return this.values}},HttpRequest=class _HttpRequest{constructor(options){this.method=options.method||"GET";this.hostname=options.hostname||"localhost";this.port=options.port;this.query=options.query||{};this.headers=options.headers||{};this.body=options.body;this.protocol=options.protocol?":"!==options.protocol.slice(-1)?`${options.protocol}:`:options.protocol:"https:";this.path=options.path?"/"!==options.path.charAt(0)?`/${options.path}`:options.path:"/";this.username=options.username;this.password=options.password;this.fragment=options.fragment}static clone(request2){const cloned=new _HttpRequest({...request2,headers:{...request2.headers}});if(cloned.query)cloned.query=cloneQuery(cloned.query);return cloned}static isInstance(request2){if(!request2)return false;const req=request2;return"method"in req&&"protocol"in req&&"hostname"in req&&"path"in req&&"object"==typeof req["query"]&&"object"==typeof req["headers"]}clone(){return _HttpRequest.clone(this)}};function cloneQuery(query3){return Object.keys(query3).reduce(((carry,paramName)=>{const param=query3[paramName];return{...carry,[paramName]:Array.isArray(param)?[...param]:param}}),{})}var HttpResponse=class{constructor(options){this.statusCode=options.statusCode;this.reason=options.reason;this.headers=options.headers||{};this.body=options.body}static isInstance(response){if(!response)return false;const resp=response;return"number"==typeof resp.statusCode&&"object"==typeof resp.headers}};function isValidHostname(hostname){return/^[a-z0-9][a-z0-9\.\-]*[a-z0-9]$/.test(hostname)}function addExpectContinueMiddleware(options){return next=>async args=>{var _a5,_b2;const{request:request2}=args;if(HttpRequest.isInstance(request2)&&request2.body&&"node"===options.runtime)if("FetchHttpHandler"!==(null==(_b2=null==(_a5=options.requestHandler)?void 0:_a5.constructor)?void 0:_b2.name))request2.headers={...request2.headers,Expect:"100-continue"};return next({...args,request:request2})}}var addExpectContinueMiddlewareOptions={step:"build",tags:["SET_EXPECT_HEADER","EXPECT_HEADER"],name:"addExpectContinueMiddleware",override:true},getAddExpectContinuePlugin=options=>({applyToStack:clientStack=>{clientStack.add(addExpectContinueMiddleware(options),addExpectContinueMiddlewareOptions)}});function resolveHostHeaderConfig(input){return input}var hostHeaderMiddleware=options=>next=>async args=>{if(!HttpRequest.isInstance(args.request))return next(args);const{request:request2}=args,{handlerProtocol=""}=options.requestHandler.metadata||{};if(handlerProtocol.indexOf("h2")>=0&&!request2.headers[":authority"]){delete request2.headers["host"];request2.headers[":authority"]=request2.hostname+(request2.port?":"+request2.port:"")}else if(!request2.headers["host"]){let host=request2.hostname;if(null!=request2.port)host+=`:${request2.port}`;request2.headers["host"]=host}return next(args)},hostHeaderMiddlewareOptions={name:"hostHeaderMiddleware",step:"build",priority:"low",tags:["HOST"],override:true},getHostHeaderPlugin=options=>({applyToStack:clientStack=>{clientStack.add(hostHeaderMiddleware(options),hostHeaderMiddlewareOptions)}}),loggerMiddleware=()=>(next,context2)=>async args=>{var _a5,_b2;try{const response=await next(args),{clientName,commandName,logger:logger2,dynamoDbDocumentClientOptions={}}=context2,{overrideInputFilterSensitiveLog,overrideOutputFilterSensitiveLog}=dynamoDbDocumentClientOptions,inputFilterSensitiveLog=null!=overrideInputFilterSensitiveLog?overrideInputFilterSensitiveLog:context2.inputFilterSensitiveLog,outputFilterSensitiveLog=null!=overrideOutputFilterSensitiveLog?overrideOutputFilterSensitiveLog:context2.outputFilterSensitiveLog,{$metadata,...outputWithoutMetadata}=response.output;null==(_a5=null==logger2?void 0:logger2.info)||_a5.call(logger2,{clientName,commandName,input:inputFilterSensitiveLog(args.input),output:outputFilterSensitiveLog(outputWithoutMetadata),metadata:$metadata});return response}catch(error){const{clientName,commandName,logger:logger2,dynamoDbDocumentClientOptions={}}=context2,{overrideInputFilterSensitiveLog}=dynamoDbDocumentClientOptions,inputFilterSensitiveLog=null!=overrideInputFilterSensitiveLog?overrideInputFilterSensitiveLog:context2.inputFilterSensitiveLog;null==(_b2=null==logger2?void 0:logger2.error)||_b2.call(logger2,{clientName,commandName,input:inputFilterSensitiveLog(args.input),error,metadata:error.$metadata});throw error}},loggerMiddlewareOptions={name:"loggerMiddleware",tags:["LOGGER"],step:"initialize",override:true},getLoggerPlugin=options=>({applyToStack:clientStack=>{clientStack.add(loggerMiddleware(),loggerMiddlewareOptions)}}),TRACE_ID_HEADER_NAME="X-Amzn-Trace-Id",ENV_LAMBDA_FUNCTION_NAME="AWS_LAMBDA_FUNCTION_NAME",ENV_TRACE_ID="_X_AMZN_TRACE_ID",recursionDetectionMiddleware=options=>next=>async args=>{const{request:request2}=args;if(!HttpRequest.isInstance(request2)||"node"!==options.runtime||request2.headers.hasOwnProperty(TRACE_ID_HEADER_NAME))return next(args);const functionName=process.env[ENV_LAMBDA_FUNCTION_NAME],traceId=process.env[ENV_TRACE_ID],nonEmptyString=str=>"string"==typeof str&&str.length>0;if(nonEmptyString(functionName)&&nonEmptyString(traceId))request2.headers[TRACE_ID_HEADER_NAME]=traceId;return next({...args,request:request2})},addRecursionDetectionMiddlewareOptions={step:"build",tags:["RECURSION_DETECTION"],name:"recursionDetectionMiddleware",override:true,priority:"low"},getRecursionDetectionPlugin=options=>({applyToStack:clientStack=>{clientStack.add(recursionDetectionMiddleware(options),addRecursionDetectionMiddlewareOptions)}}),NoOpLogger=class{trace(){}debug(){}info(){}warn(){}error(){}},getAllAliases=(name,aliases)=>{const _aliases=[];if(name)_aliases.push(name);if(aliases)for(const alias of aliases)_aliases.push(alias);return _aliases},getMiddlewareNameWithAliases=(name,aliases)=>`${name||"anonymous"}${aliases&&aliases.length>0?` (a.k.a. ${aliases.join(",")})`:""}`,constructStack=()=>{let absoluteEntries=[],relativeEntries=[],identifyOnResolve=false;const entriesNameSet=new Set,cloneTo=toStack=>{var _a5;absoluteEntries.forEach((entry=>{toStack.add(entry.middleware,{...entry})}));relativeEntries.forEach((entry=>{toStack.addRelativeTo(entry.middleware,{...entry})}));null==(_a5=toStack.identifyOnResolve)||_a5.call(toStack,stack.identifyOnResolve());return toStack},expandRelativeMiddlewareList=from=>{const expandedMiddlewareList=[];from.before.forEach((entry=>{if(0===entry.before.length&&0===entry.after.length)expandedMiddlewareList.push(entry);else expandedMiddlewareList.push(...expandRelativeMiddlewareList(entry))}));expandedMiddlewareList.push(from);from.after.reverse().forEach((entry=>{if(0===entry.before.length&&0===entry.after.length)expandedMiddlewareList.push(entry);else expandedMiddlewareList.push(...expandRelativeMiddlewareList(entry))}));return expandedMiddlewareList},getMiddlewareList=(debug3=false)=>{const normalizedAbsoluteEntries=[],normalizedRelativeEntries=[],normalizedEntriesNameMap={};absoluteEntries.forEach((entry=>{const normalizedEntry={...entry,before:[],after:[]};for(const alias of getAllAliases(normalizedEntry.name,normalizedEntry.aliases))normalizedEntriesNameMap[alias]=normalizedEntry;normalizedAbsoluteEntries.push(normalizedEntry)}));relativeEntries.forEach((entry=>{const normalizedEntry={...entry,before:[],after:[]};for(const alias of getAllAliases(normalizedEntry.name,normalizedEntry.aliases))normalizedEntriesNameMap[alias]=normalizedEntry;normalizedRelativeEntries.push(normalizedEntry)}));normalizedRelativeEntries.forEach((entry=>{if(entry.toMiddleware){const toMiddleware=normalizedEntriesNameMap[entry.toMiddleware];if(void 0===toMiddleware){if(debug3)return;throw new Error(`${entry.toMiddleware} is not found when adding ${getMiddlewareNameWithAliases(entry.name,entry.aliases)} middleware ${entry.relation} ${entry.toMiddleware}`)}if("after"===entry.relation)toMiddleware.after.push(entry);if("before"===entry.relation)toMiddleware.before.push(entry)}}));var entries;return(entries=normalizedAbsoluteEntries,entries.sort(((a2,b3)=>stepWeights[b3.step]-stepWeights[a2.step]||priorityWeights[b3.priority||"normal"]-priorityWeights[a2.priority||"normal"]))).map(expandRelativeMiddlewareList).reduce(((wholeList,expandedMiddlewareList)=>{wholeList.push(...expandedMiddlewareList);return wholeList}),[])},stack={add:(middleware,options={})=>{const{name,override,aliases:_aliases}=options,entry={step:"initialize",priority:"normal",middleware,...options},aliases=getAllAliases(name,_aliases);if(aliases.length>0){if(aliases.some((alias=>entriesNameSet.has(alias)))){if(!override)throw new Error(`Duplicate middleware name '${getMiddlewareNameWithAliases(name,_aliases)}'`);for(const alias of aliases){const toOverrideIndex=absoluteEntries.findIndex((entry2=>{var _a5;return entry2.name===alias||(null==(_a5=entry2.aliases)?void 0:_a5.some((a2=>a2===alias)))}));if(-1===toOverrideIndex)continue;const toOverride=absoluteEntries[toOverrideIndex];if(toOverride.step!==entry.step||entry.priority!==toOverride.priority)throw new Error(`"${getMiddlewareNameWithAliases(toOverride.name,toOverride.aliases)}" middleware with ${toOverride.priority} priority in ${toOverride.step} step cannot be overridden by "${getMiddlewareNameWithAliases(name,_aliases)}" middleware with ${entry.priority} priority in ${entry.step} step.`);absoluteEntries.splice(toOverrideIndex,1)}}for(const alias of aliases)entriesNameSet.add(alias)}absoluteEntries.push(entry)},addRelativeTo:(middleware,options)=>{const{name,override,aliases:_aliases}=options,entry={middleware,...options},aliases=getAllAliases(name,_aliases);if(aliases.length>0){if(aliases.some((alias=>entriesNameSet.has(alias)))){if(!override)throw new Error(`Duplicate middleware name '${getMiddlewareNameWithAliases(name,_aliases)}'`);for(const alias of aliases){const toOverrideIndex=relativeEntries.findIndex((entry2=>{var _a5;return entry2.name===alias||(null==(_a5=entry2.aliases)?void 0:_a5.some((a2=>a2===alias)))}));if(-1===toOverrideIndex)continue;const toOverride=relativeEntries[toOverrideIndex];if(toOverride.toMiddleware!==entry.toMiddleware||toOverride.relation!==entry.relation)throw new Error(`"${getMiddlewareNameWithAliases(toOverride.name,toOverride.aliases)}" middleware ${toOverride.relation} "${toOverride.toMiddleware}" middleware cannot be overridden by "${getMiddlewareNameWithAliases(name,_aliases)}" middleware ${entry.relation} "${entry.toMiddleware}" middleware.`);relativeEntries.splice(toOverrideIndex,1)}}for(const alias of aliases)entriesNameSet.add(alias)}relativeEntries.push(entry)},clone:()=>cloneTo(constructStack()),use:plugin3=>{plugin3.applyToStack(stack)},remove:toRemove=>{if("string"==typeof toRemove)return(toRemove=>{let isRemoved=false;const filterCb=entry=>{const aliases=getAllAliases(entry.name,entry.aliases);if(aliases.includes(toRemove)){isRemoved=true;for(const alias of aliases)entriesNameSet.delete(alias);return false}return true};absoluteEntries=absoluteEntries.filter(filterCb);relativeEntries=relativeEntries.filter(filterCb);return isRemoved})(toRemove);else return(toRemove=>{let isRemoved=false;const filterCb=entry=>{if(entry.middleware===toRemove){isRemoved=true;for(const alias of getAllAliases(entry.name,entry.aliases))entriesNameSet.delete(alias);return false}return true};absoluteEntries=absoluteEntries.filter(filterCb);relativeEntries=relativeEntries.filter(filterCb);return isRemoved})(toRemove)},removeByTag:toRemove=>{let isRemoved=false;const filterCb=entry=>{const{tags,name,aliases:_aliases}=entry;if(tags&&tags.includes(toRemove)){const aliases=getAllAliases(name,_aliases);for(const alias of aliases)entriesNameSet.delete(alias);isRemoved=true;return false}return true};absoluteEntries=absoluteEntries.filter(filterCb);relativeEntries=relativeEntries.filter(filterCb);return isRemoved},concat:from=>{var _a5,_b2;const cloned=cloneTo(constructStack());cloned.use(from);cloned.identifyOnResolve(identifyOnResolve||cloned.identifyOnResolve()||(null!=(_b2=null==(_a5=from.identifyOnResolve)?void 0:_a5.call(from))?_b2:false));return cloned},applyToStack:cloneTo,identify:()=>getMiddlewareList(true).map((mw=>{var _a5;const step=null!=(_a5=mw.step)?_a5:mw.relation+" "+mw.toMiddleware;return getMiddlewareNameWithAliases(mw.name,mw.aliases)+" - "+step})),identifyOnResolve(toggle){if("boolean"==typeof toggle)identifyOnResolve=toggle;return identifyOnResolve},resolve:(handler,context2)=>{for(const middleware of getMiddlewareList().map((entry=>entry.middleware)).reverse())handler=middleware(handler,context2);if(identifyOnResolve)console.log(stack.identify());return handler}};return stack},stepWeights={initialize:5,serialize:4,build:3,finalizeRequest:2,deserialize:1},priorityWeights={high:3,normal:2,low:1},Client=class{constructor(config){this.middlewareStack=constructStack();this.config=config}send(command,optionsOrCb,cb2){const options="function"!=typeof optionsOrCb?optionsOrCb:void 0,callback="function"==typeof optionsOrCb?optionsOrCb:cb2,handler=command.resolveMiddleware(this.middlewareStack,this.config,options);if(callback)handler(command).then((result=>callback(null,result.output)),(err2=>callback(err2))).catch((()=>{}));else return handler(command).then((result=>result.output))}destroy(){if(this.config.requestHandler.destroy)this.config.requestHandler.destroy()}},alphabetByEncoding={},alphabetByValue=new Array(64);for(let i2=0,start="A".charCodeAt(0),limit="Z".charCodeAt(0);i2+start<=limit;i2++){const char=String.fromCharCode(i2+start);alphabetByEncoding[char]=i2;alphabetByValue[i2]=char}for(let i2=0,start="a".charCodeAt(0),limit="z".charCodeAt(0);i2+start<=limit;i2++){const char=String.fromCharCode(i2+start),index5=i2+26;alphabetByEncoding[char]=index5;alphabetByValue[index5]=char}for(let i2=0;i2<10;i2++){alphabetByEncoding[i2.toString(10)]=i2+52;const char=i2.toString(10),index5=i2+52;alphabetByEncoding[char]=index5;alphabetByValue[index5]=char}alphabetByEncoding["+"]=62;alphabetByValue[62]="+";alphabetByEncoding["/"]=63;alphabetByValue[63]="/";var bitsPerLetter=6,bitsPerByte=8,maxLetterValue=63,fromBase64=input=>{let totalByteLength=input.length/4*3;if("=="===input.slice(-2))totalByteLength-=2;else if("="===input.slice(-1))totalByteLength--;const out=new ArrayBuffer(totalByteLength),dataView=new DataView(out);for(let i2=0;i2<input.length;i2+=4){let bits2=0,bitLength=0;for(let j2=i2,limit=i2+3;j2<=limit;j2++)if("="!==input[j2]){if(!(input[j2]in alphabetByEncoding))throw new TypeError(`Invalid character ${input[j2]} in base64 string.`);bits2|=alphabetByEncoding[input[j2]]<<(limit-j2)*bitsPerLetter;bitLength+=bitsPerLetter}else bits2>>=bitsPerLetter;const chunkOffset=i2/4*3;bits2>>=bitLength%bitsPerByte;const byteLength=Math.floor(bitLength/bitsPerByte);for(let k2=0;k2<byteLength;k2++){const offset=(byteLength-k2-1)*bitsPerByte;dataView.setUint8(chunkOffset+k2,(bits2&255<<offset)>>offset)}}return new Uint8Array(out)},fromUtf8=input=>(new TextEncoder).encode(input),toUint8Array=data=>{if("string"==typeof data)return fromUtf8(data);if(ArrayBuffer.isView(data))return new Uint8Array(data.buffer,data.byteOffset,data.byteLength/Uint8Array.BYTES_PER_ELEMENT);else return new Uint8Array(data)},toUtf8=input=>{if("string"==typeof input)return input;if("object"!=typeof input||"number"!=typeof input.byteOffset||"number"!=typeof input.byteLength)throw new Error("@smithy/util-utf8: toUtf8 encoder function only accepts string | Uint8Array.");return new TextDecoder("utf-8").decode(input)};function toBase64(_input){let input;if("string"==typeof _input)input=fromUtf8(_input);else input=_input;const isArrayLike="object"==typeof input&&"number"==typeof input.length,isUint8Array="object"==typeof input&&"number"==typeof input.byteOffset&&"number"==typeof input.byteLength;if(!isArrayLike&&!isUint8Array)throw new Error("@smithy/util-base64: toBase64 encoder function only accepts string | Uint8Array.");let str="";for(let i2=0;i2<input.length;i2+=3){let bits2=0,bitLength=0;for(let j2=i2,limit=Math.min(i2+3,input.length);j2<limit;j2++){bits2|=input[j2]<<(limit-j2-1)*bitsPerByte;bitLength+=bitsPerByte}const bitClusterCount=Math.ceil(bitLength/bitsPerLetter);bits2<<=bitClusterCount*bitsPerLetter-bitLength;for(let k2=1;k2<=bitClusterCount;k2++){const offset=(bitClusterCount-k2)*bitsPerLetter;str+=alphabetByValue[(bits2&maxLetterValue<<offset)>>offset]}str+="==".slice(0,4-bitClusterCount)}return str}function transformToString(payload,encoding="utf-8"){if("base64"===encoding)return toBase64(payload);else return toUtf8(payload)}function transformFromString(str,encoding){if("base64"===encoding)return Uint8ArrayBlobAdapter.mutate(fromBase64(str));else return Uint8ArrayBlobAdapter.mutate(fromUtf8(str))}var Uint8ArrayBlobAdapter=class _Uint8ArrayBlobAdapter extends Uint8Array{static fromString(source,encoding="utf-8"){switch(typeof source){case"string":return transformFromString(source,encoding);default:throw new Error(`Unsupported conversion from ${typeof source} to Uint8ArrayBlobAdapter.`)}}static mutate(source){Object.setPrototypeOf(source,_Uint8ArrayBlobAdapter.prototype);return source}transformToString(encoding="utf-8"){return transformToString(this,encoding)}},getAwsChunkedEncodingStream=(readableStream,options)=>{const{base64Encoder,bodyLengthChecker,checksumAlgorithmFn,checksumLocationName,streamHasher}=options,checksumRequired=void 0!==base64Encoder&&void 0!==bodyLengthChecker&&void 0!==checksumAlgorithmFn&&void 0!==checksumLocationName&&void 0!==streamHasher,digest=checksumRequired?streamHasher(checksumAlgorithmFn,readableStream):void 0,reader=readableStream.getReader();return new ReadableStream({async pull(controller){const{value,done}=await reader.read();if(done){controller.enqueue("0\r\n");if(checksumRequired){const checksum=base64Encoder(await digest);controller.enqueue(`${checksumLocationName}:${checksum}\r\n`);controller.enqueue("\r\n")}controller.close()}else controller.enqueue(`${(bodyLengthChecker(value)||0).toString(16)}\r\n${value}\r\n`)}})},escapeUri=uri=>encodeURIComponent(uri).replace(/[!'()*]/g,hexEncode),hexEncode=c2=>`%${c2.charCodeAt(0).toString(16).toUpperCase()}`,escapeUriPath=uri=>uri.split("/").map(escapeUri).join("/");function buildQueryString(query3){const parts=[];for(let key2 of Object.keys(query3).sort()){const value=query3[key2];key2=escapeUri(key2);if(Array.isArray(value))for(let i2=0,iLen=value.length;i2<iLen;i2++)parts.push(`${key2}=${escapeUri(value[i2])}`);else{let qsEntry=key2;if(value||"string"==typeof value)qsEntry+=`=${escapeUri(value)}`;parts.push(qsEntry)}}return parts.join("&")}function requestTimeout(timeoutInMs=0){return new Promise(((resolve,reject)=>{if(timeoutInMs)setTimeout((()=>{const timeoutError=new Error(`Request did not complete within ${timeoutInMs} ms`);timeoutError.name="TimeoutError";reject(timeoutError)}),timeoutInMs)}))}var keepAliveSupport={supported:void 0},FetchHttpHandler=class _FetchHttpHandler{static create(instanceOrOptions){if("function"==typeof(null==instanceOrOptions?void 0:instanceOrOptions.handle))return instanceOrOptions;else return new _FetchHttpHandler(instanceOrOptions)}constructor(options){if("function"==typeof options)this.configProvider=options().then((opts=>opts||{}));else{this.config=null!=options?options:{};this.configProvider=Promise.resolve(this.config)}if(void 0===keepAliveSupport.supported)keepAliveSupport.supported=Boolean("undefined"!=typeof Request&&"keepalive"in new Request("https://[::1]"))}destroy(){}async handle(request2,{abortSignal}={}){var _a5,_b2;if(!this.config)this.config=await this.configProvider;const requestTimeoutInMs=this.config.requestTimeout,keepAlive=true===this.config.keepAlive,credentials=this.config.credentials;if(null==abortSignal?void 0:abortSignal.aborted){const abortError=new Error("Request aborted");abortError.name="AbortError";return Promise.reject(abortError)}let path2=request2.path;const queryString=buildQueryString(request2.query||{});if(queryString)path2+=`?${queryString}`;if(request2.fragment)path2+=`#${request2.fragment}`;let auth="";if(null!=request2.username||null!=request2.password)auth=`${null!=(_a5=request2.username)?_a5:""}:${null!=(_b2=request2.password)?_b2:""}@`;const{port,method}=request2,url=`${request2.protocol}//${auth}${request2.hostname}${port?`:${port}`:""}${path2}`,body="GET"===method||"HEAD"===method?void 0:request2.body,requestOptions={body,headers:new Headers(request2.headers),method,credentials};if(body)requestOptions.duplex="half";if("undefined"!=typeof AbortController)requestOptions.signal=abortSignal;if(keepAliveSupport.supported)requestOptions.keepalive=keepAlive;let removeSignalEventListener=()=>{};const fetchRequest=new Request(url,requestOptions),raceOfPromises=[fetch(fetchRequest).then((response=>{const fetchHeaders=response.headers,transformedHeaders={};for(const pair of fetchHeaders.entries())transformedHeaders[pair[0]]=pair[1];if(!(null!=response.body))return response.blob().then((body2=>({response:new HttpResponse({headers:transformedHeaders,reason:response.statusText,statusCode:response.status,body:body2})})));else return{response:new HttpResponse({headers:transformedHeaders,reason:response.statusText,statusCode:response.status,body:response.body})}})),requestTimeout(requestTimeoutInMs)];if(abortSignal)raceOfPromises.push(new Promise(((resolve,reject)=>{const onAbort=()=>{const abortError=new Error("Request aborted");abortError.name="AbortError";reject(abortError)};if("function"==typeof abortSignal.addEventListener){const signal=abortSignal;signal.addEventListener("abort",onAbort,{once:true});removeSignalEventListener=()=>signal.removeEventListener("abort",onAbort)}else abortSignal.onabort=onAbort})));return Promise.race(raceOfPromises).finally(removeSignalEventListener)}updateHttpClientConfig(key2,value){this.config=void 0;this.configProvider=this.configProvider.then((config=>{config[key2]=value;return config}))}httpHandlerConfigs(){var _a5;return null!=(_a5=this.config)?_a5:{}}},streamCollector=stream=>{if("function"==typeof Blob&&stream instanceof Blob)return collectBlob(stream);else return collectStream(stream)};async function collectBlob(blob){const base64=await readToBase64(blob),arrayBuffer=fromBase64(base64);return new Uint8Array(arrayBuffer)}async function collectStream(stream){const chunks=[],reader=stream.getReader();let isDone=false,length=0;for(;!isDone;){const{done,value}=await reader.read();if(value){chunks.push(value);length+=value.length}isDone=done}const collected=new Uint8Array(length);let offset=0;for(const chunk of chunks){collected.set(chunk,offset);offset+=chunk.length}return collected}function readToBase64(blob){return new Promise(((resolve,reject)=>{const reader=new FileReader;reader.onloadend=()=>{var _a5;if(2!==reader.readyState)return reject(new Error("Reader aborted too early"));const result=null!=(_a5=reader.result)?_a5:"",commaIndex=result.indexOf(","),dataOffset=commaIndex>-1?commaIndex+1:result.length;resolve(result.substring(dataOffset))};reader.onabort=()=>reject(new Error("Read aborted"));reader.onerror=()=>reject(reader.error);reader.readAsDataURL(blob)}))}var SHORT_TO_HEX={},HEX_TO_SHORT={};for(let i2=0;i2<256;i2++){let encodedByte=i2.toString(16).toLowerCase();if(1===encodedByte.length)encodedByte=`0${encodedByte}`;SHORT_TO_HEX[i2]=encodedByte;HEX_TO_SHORT[encodedByte]=i2}function fromHex(encoded){if(encoded.length%2!=0)throw new Error("Hex encoded strings must have an even number length");const out=new Uint8Array(encoded.length/2);for(let i2=0;i2<encoded.length;i2+=2){const encodedByte=encoded.slice(i2,i2+2).toLowerCase();if(encodedByte in HEX_TO_SHORT)out[i2/2]=HEX_TO_SHORT[encodedByte];else throw new Error(`Cannot decode unrecognized sequence ${encodedByte} as hexadecimal`)}return out}function toHex(bytes){let out="";for(let i2=0;i2<bytes.byteLength;i2++)out+=SHORT_TO_HEX[bytes[i2]];return out}var isReadableStream=stream=>{var _a5;return"function"==typeof ReadableStream&&((null==(_a5=null==stream?void 0:stream.constructor)?void 0:_a5.name)===ReadableStream.name||stream instanceof ReadableStream)},ERR_MSG_STREAM_HAS_BEEN_TRANSFORMED="The stream has already been transformed.",sdkStreamMixin=stream=>{var _a5,_b2;if(!isBlobInstance(stream)&&!isReadableStream(stream)){const name=(null==(_b2=null==(_a5=null==stream?void 0:stream.__proto__)?void 0:_a5.constructor)?void 0:_b2.name)||stream;throw new Error(`Unexpected stream implementation, expect Blob or ReadableStream, got ${name}`)}let transformed=false;const transformToByteArray=async()=>{if(transformed)throw new Error(ERR_MSG_STREAM_HAS_BEEN_TRANSFORMED);transformed=true;return await streamCollector(stream)};return Object.assign(stream,{transformToByteArray,transformToString:async encoding=>{const buf=await transformToByteArray();if("base64"===encoding)return toBase64(buf);else if("hex"===encoding)return toHex(buf);else if(void 0===encoding||"utf8"===encoding||"utf-8"===encoding)return toUtf8(buf);else if("function"==typeof TextDecoder)return new TextDecoder(encoding).decode(buf);else throw new Error("TextDecoder is not available, please make sure polyfill is provided.")},transformToWebStream:()=>{if(transformed)throw new Error(ERR_MSG_STREAM_HAS_BEEN_TRANSFORMED);transformed=true;if(isBlobInstance(stream))return(blob=>{if("function"!=typeof blob.stream)throw new Error("Cannot transform payload Blob to web stream. Please make sure the Blob.stream() is polyfilled.\nIf you are using React Native, this API is not yet supported, see: https://react-native.canny.io/feature-requests/p/fetch-streaming-body");return blob.stream()})(stream);else if(isReadableStream(stream))return stream;else throw new Error(`Cannot transform payload to web stream, got ${stream}`)}})},isBlobInstance=stream=>"function"==typeof Blob&&stream instanceof Blob;async function splitStream(stream){if("function"==typeof stream.stream)stream=stream.stream();return stream.tee()}async function headStream(stream,bytes){var _a5;let byteLengthCounter=0;const chunks=[],reader=stream.getReader();let isDone=false;for(;!isDone;){const{done,value}=await reader.read();if(value){chunks.push(value);byteLengthCounter+=null!=(_a5=null==value?void 0:value.byteLength)?_a5:0}if(byteLengthCounter>=bytes)break;isDone=done}reader.releaseLock();const collected=new Uint8Array(Math.min(bytes,byteLengthCounter));let offset=0;for(const chunk of chunks){if(chunk.byteLength>collected.byteLength-offset){collected.set(chunk.subarray(0,collected.byteLength-offset),offset);break}else collected.set(chunk,offset);offset+=chunk.length}return collected}var collectBody=async(streamBody=new Uint8Array,context2)=>{if(streamBody instanceof Uint8Array)return Uint8ArrayBlobAdapter.mutate(streamBody);if(!streamBody)return Uint8ArrayBlobAdapter.mutate(new Uint8Array);const fromContext=context2.streamCollector(streamBody);return Uint8ArrayBlobAdapter.mutate(await fromContext)},Command=class{constructor(){this.middlewareStack=constructStack()}static classBuilder(){return new ClassBuilder}resolveMiddlewareWithContext(clientStack,configuration,options,{middlewareFn,clientName,commandName,inputFilterSensitiveLog,outputFilterSensitiveLog,smithyContext,additionalContext,CommandCtor}){for(const mw of middlewareFn.bind(this)(CommandCtor,clientStack,configuration,options))this.middlewareStack.use(mw);const stack=clientStack.concat(this.middlewareStack),{logger:logger2}=configuration,handlerExecutionContext={logger:logger2,clientName,commandName,inputFilterSensitiveLog,outputFilterSensitiveLog,[SMITHY_CONTEXT_KEY]:{commandInstance:this,...smithyContext},...additionalContext},{requestHandler}=configuration;return stack.resolve((request2=>requestHandler.handle(request2.request,options||{})),handlerExecutionContext)}},ClassBuilder=class{constructor(){this._init=()=>{};this._ep={};this._middlewareFn=()=>[];this._commandName="";this._clientName="";this._additionalContext={};this._smithyContext={};this._inputFilterSensitiveLog=_=>_;this._outputFilterSensitiveLog=_=>_;this._serializer=null;this._deserializer=null}init(cb2){this._init=cb2}ep(endpointParameterInstructions){this._ep=endpointParameterInstructions;return this}m(middlewareSupplier){this._middlewareFn=middlewareSupplier;return this}s(service,operation,smithyContext={}){this._smithyContext={service,operation,...smithyContext};return this}c(additionalContext={}){this._additionalContext=additionalContext;return this}n(clientName,commandName){this._clientName=clientName;this._commandName=commandName;return this}f(inputFilter=_=>_,outputFilter=_=>_){this._inputFilterSensitiveLog=inputFilter;this._outputFilterSensitiveLog=outputFilter;return this}ser(serializer){this._serializer=serializer;return this}de(deserializer){this._deserializer=deserializer;return this}build(){const closure=this;let CommandRef;return CommandRef=class extends Command{static getEndpointParameterInstructions(){return closure._ep}constructor(...[input]){super();this.serialize=closure._serializer;this.deserialize=closure._deserializer;this.input=null!=input?input:{};closure._init(this)}resolveMiddleware(stack,configuration,options){return this.resolveMiddlewareWithContext(stack,configuration,options,{CommandCtor:CommandRef,middlewareFn:closure._middlewareFn,clientName:closure._clientName,commandName:closure._commandName,inputFilterSensitiveLog:closure._inputFilterSensitiveLog,outputFilterSensitiveLog:closure._outputFilterSensitiveLog,smithyContext:closure._smithyContext,additionalContext:closure._additionalContext})}}}},SENSITIVE_STRING="***SensitiveInformation***",createAggregatedClient=(commands2,Client2)=>{for(const command of Object.keys(commands2)){const CommandCtor=commands2[command],methodImpl=async function(args,optionsOrCb,cb2){const command2=new CommandCtor(args);if("function"==typeof optionsOrCb)this.send(command2,optionsOrCb);else if("function"==typeof cb2){if("object"!=typeof optionsOrCb)throw new Error("Expected http options but got "+typeof optionsOrCb);this.send(command2,optionsOrCb||{},cb2)}else return this.send(command2,optionsOrCb)},methodName=(command[0].toLowerCase()+command.slice(1)).replace(/Command$/,"");Client2.prototype[methodName]=methodImpl}},parseBoolean=value=>{switch(value){case"true":return true;case"false":return false;default:throw new Error(`Unable to parse boolean value "${value}"`)}},expectBoolean=value=>{if(null!=value){if("number"==typeof value){if(0===value||1===value)logger.warn(stackTraceWarning(`Expected boolean, got ${typeof value}: ${value}`));if(0===value)return false;if(1===value)return true}if("string"==typeof value){const lower=value.toLowerCase();if("false"===lower||"true"===lower)logger.warn(stackTraceWarning(`Expected boolean, got ${typeof value}: ${value}`));if("false"===lower)return false;if("true"===lower)return true}if("boolean"==typeof value)return value;throw new TypeError(`Expected boolean, got ${typeof value}: ${value}`)}},expectNumber=value=>{if(null!=value){if("string"==typeof value){const parsed=parseFloat(value);if(!Number.isNaN(parsed)){if(String(parsed)!==String(value))logger.warn(stackTraceWarning(`Expected number but observed string: ${value}`));return parsed}}if("number"==typeof value)return value;throw new TypeError(`Expected number, got ${typeof value}: ${value}`)}},MAX_FLOAT=Math.ceil(2**127*(2-2**-23)),expectFloat32=value=>{const expected=expectNumber(value);if(void 0!==expected&&!Number.isNaN(expected)&&expected!==1/0&&expected!==-1/0)if(Math.abs(expected)>MAX_FLOAT)throw new TypeError(`Expected 32-bit float, got ${value}`);return expected},expectLong=value=>{if(null!=value){if(Number.isInteger(value)&&!Number.isNaN(value))return value;throw new TypeError(`Expected integer, got ${typeof value}: ${value}`)}},expectInt=expectLong,expectInt32=value=>expectSizedInt(value,32),expectShort=value=>expectSizedInt(value,16),expectByte=value=>expectSizedInt(value,8),expectSizedInt=(value,size)=>{const expected=expectLong(value);if(void 0!==expected&&castInt(expected,size)!==expected)throw new TypeError(`Expected ${size}-bit integer, got ${value}`);return expected},castInt=(value,size)=>{switch(size){case 32:return Int32Array.of(value)[0];case 16:return Int16Array.of(value)[0];case 8:return Int8Array.of(value)[0]}},expectNonNull=(value,location)=>{if(null==value){if(location)throw new TypeError(`Expected a non-null value for ${location}`);throw new TypeError("Expected a non-null value")}return value},expectObject=value=>{if(null==value)return;if("object"==typeof value&&!Array.isArray(value))return value;const receivedType=Array.isArray(value)?"array":typeof value;throw new TypeError(`Expected object, got ${receivedType}: ${value}`)},expectString=value=>{if(null!=value){if("string"==typeof value)return value;if(["boolean","number","bigint"].includes(typeof value)){logger.warn(stackTraceWarning(`Expected string, got ${typeof value}: ${value}`));return String(value)}throw new TypeError(`Expected string, got ${typeof value}: ${value}`)}},expectUnion=value=>{if(null==value)return;const asObject=expectObject(value),setKeys=Object.entries(asObject).filter((([,v2])=>null!=v2)).map((([k2])=>k2));if(0===setKeys.length)throw new TypeError("Unions must have exactly one non-null member. None were found.");if(setKeys.length>1)throw new TypeError(`Unions must have exactly one non-null member. Keys ${setKeys} were not null.`);return asObject},strictParseDouble=value=>{if("string"==typeof value)return expectNumber(parseNumber(value));else return expectNumber(value)},strictParseFloat=strictParseDouble,strictParseFloat32=value=>{if("string"==typeof value)return expectFloat32(parseNumber(value));else return expectFloat32(value)},NUMBER_REGEX=/(-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)|(-?Infinity)|(NaN)/g,parseNumber=value=>{const matches=value.match(NUMBER_REGEX);if(null===matches||matches[0].length!==value.length)throw new TypeError("Expected real number, got implicit NaN");return parseFloat(value)},limitedParseDouble=value=>{if("string"==typeof value)return parseFloatString(value);else return expectNumber(value)},handleFloat=limitedParseDouble,limitedParseFloat=limitedParseDouble,limitedParseFloat32=value=>{if("string"==typeof value)return parseFloatString(value);else return expectFloat32(value)},parseFloatString=value=>{switch(value){case"NaN":return NaN;case"Infinity":return 1/0;case"-Infinity":return-1/0;default:throw new Error(`Unable to parse float value: ${value}`)}},strictParseLong=value=>{if("string"==typeof value)return expectLong(parseNumber(value));else return expectLong(value)},strictParseInt=strictParseLong,strictParseInt32=value=>{if("string"==typeof value)return expectInt32(parseNumber(value));else return expectInt32(value)},strictParseShort=value=>{if("string"==typeof value)return expectShort(parseNumber(value));else return expectShort(value)},strictParseByte=value=>{if("string"==typeof value)return expectByte(parseNumber(value));else return expectByte(value)},stackTraceWarning=message=>String(new TypeError(message).stack||message).split("\n").slice(0,5).filter((s2=>!s2.includes("stackTraceWarning"))).join("\n"),logger={warn:console.warn},DAYS=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],MONTHS=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function dateToUtcString(date){const year=date.getUTCFullYear(),month=date.getUTCMonth(),dayOfWeek=date.getUTCDay(),dayOfMonthInt=date.getUTCDate(),hoursInt=date.getUTCHours(),minutesInt=date.getUTCMinutes(),secondsInt=date.getUTCSeconds(),dayOfMonthString=dayOfMonthInt<10?`0${dayOfMonthInt}`:`${dayOfMonthInt}`,hoursString=hoursInt<10?`0${hoursInt}`:`${hoursInt}`,minutesString=minutesInt<10?`0${minutesInt}`:`${minutesInt}`,secondsString=secondsInt<10?`0${secondsInt}`:`${secondsInt}`;return`${DAYS[dayOfWeek]}, ${dayOfMonthString} ${MONTHS[month]} ${year} ${hoursString}:${minutesString}:${secondsString} GMT`}var RFC3339=new RegExp(/^(\d{4})-(\d{2})-(\d{2})[tT](\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?[zZ]$/),parseRfc3339DateTime=value=>{if(null==value)return;if("string"!=typeof value)throw new TypeError("RFC-3339 date-times must be expressed as strings");const match3=RFC3339.exec(value);if(!match3)throw new TypeError("Invalid RFC-3339 date-time value");const[_,yearStr,monthStr,dayStr,hours,minutes,seconds,fractionalMilliseconds]=match3,year=strictParseShort(stripLeadingZeroes(yearStr)),month=parseDateValue(monthStr,"month",1,12),day=parseDateValue(dayStr,"day",1,31);return buildDate(year,month,day,{hours,minutes,seconds,fractionalMilliseconds})},RFC3339_WITH_OFFSET=new RegExp(/^(\d{4})-(\d{2})-(\d{2})[tT](\d{2}):(\d{2}):(\d{2})(?:\.(\d+))?(([-+]\d{2}\:\d{2})|[zZ])$/),parseRfc3339DateTimeWithOffset=value=>{if(null==value)return;if("string"!=typeof value)throw new TypeError("RFC-3339 date-times must be expressed as strings");const match3=RFC3339_WITH_OFFSET.exec(value);if(!match3)throw new TypeError("Invalid RFC-3339 date-time value");const[_,yearStr,monthStr,dayStr,hours,minutes,seconds,fractionalMilliseconds,offsetStr]=match3,year=strictParseShort(stripLeadingZeroes(yearStr)),month=parseDateValue(monthStr,"month",1,12),day=parseDateValue(dayStr,"day",1,31),date=buildDate(year,month,day,{hours,minutes,seconds,fractionalMilliseconds});if("Z"!=offsetStr.toUpperCase())date.setTime(date.getTime()-parseOffsetToMilliseconds(offsetStr));return date},IMF_FIXDATE=new RegExp(/^(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d{2}) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d{1,2}):(\d{2}):(\d{2})(?:\.(\d+))? GMT$/),RFC_850_DATE=new RegExp(/^(?:Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d{2})-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d{2}) (\d{1,2}):(\d{2}):(\d{2})(?:\.(\d+))? GMT$/),ASC_TIME=new RegExp(/^(?:Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( [1-9]|\d{2}) (\d{1,2}):(\d{2}):(\d{2})(?:\.(\d+))? (\d{4})$/),parseRfc7231DateTime=value=>{if(null==value)return;if("string"!=typeof value)throw new TypeError("RFC-7231 date-times must be expressed as strings");let match3=IMF_FIXDATE.exec(value);if(match3){const[_,dayStr,monthStr,yearStr,hours,minutes,seconds,fractionalMilliseconds]=match3;return buildDate(strictParseShort(stripLeadingZeroes(yearStr)),parseMonthByShortName(monthStr),parseDateValue(dayStr,"day",1,31),{hours,minutes,seconds,fractionalMilliseconds})}match3=RFC_850_DATE.exec(value);if(match3){const[_,dayStr,monthStr,yearStr,hours,minutes,seconds,fractionalMilliseconds]=match3;return adjustRfc850Year(buildDate(parseTwoDigitYear(yearStr),parseMonthByShortName(monthStr),parseDateValue(dayStr,"day",1,31),{hours,minutes,seconds,fractionalMilliseconds}))}match3=ASC_TIME.exec(value);if(match3){const[_,monthStr,dayStr,hours,minutes,seconds,fractionalMilliseconds,yearStr]=match3;return buildDate(strictParseShort(stripLeadingZeroes(yearStr)),parseMonthByShortName(monthStr),parseDateValue(dayStr.trimLeft(),"day",1,31),{hours,minutes,seconds,fractionalMilliseconds})}throw new TypeError("Invalid RFC-7231 date-time value")},parseEpochTimestamp=value=>{if(null==value)return;let valueAsDouble;if("number"==typeof value)valueAsDouble=value;else if("string"==typeof value)valueAsDouble=strictParseDouble(value);else if("object"==typeof value&&1===value.tag)valueAsDouble=value.value;else throw new TypeError("Epoch timestamps must be expressed as floating point numbers or their string representation");if(Number.isNaN(valueAsDouble)||valueAsDouble===1/0||valueAsDouble===-1/0)throw new TypeError("Epoch timestamps must be valid, non-Infinite, non-NaN numerics");return new Date(Math.round(1e3*valueAsDouble))},buildDate=(year,month,day,time)=>{const adjustedMonth=month-1;validateDayOfMonth(year,adjustedMonth,day);return new Date(Date.UTC(year,adjustedMonth,day,parseDateValue(time.hours,"hour",0,23),parseDateValue(time.minutes,"minute",0,59),parseDateValue(time.seconds,"seconds",0,60),parseMilliseconds(time.fractionalMilliseconds)))},parseTwoDigitYear=value=>{const thisYear=(new Date).getUTCFullYear(),valueInThisCentury=100*Math.floor(thisYear/100)+strictParseShort(stripLeadingZeroes(value));if(valueInThisCentury<thisYear)return valueInThisCentury+100;else return valueInThisCentury},FIFTY_YEARS_IN_MILLIS=15768e8,adjustRfc850Year=input=>{if(input.getTime()-(new Date).getTime()>FIFTY_YEARS_IN_MILLIS)return new Date(Date.UTC(input.getUTCFullYear()-100,input.getUTCMonth(),input.getUTCDate(),input.getUTCHours(),input.getUTCMinutes(),input.getUTCSeconds(),input.getUTCMilliseconds()));else return input},parseMonthByShortName=value=>{const monthIdx=MONTHS.indexOf(value);if(monthIdx<0)throw new TypeError(`Invalid month: ${value}`);return monthIdx+1},DAYS_IN_MONTH=[31,28,31,30,31,30,31,31,30,31,30,31],validateDayOfMonth=(year,month,day)=>{let maxDays=DAYS_IN_MONTH[month];if(1===month&&isLeapYear(year))maxDays=29;if(day>maxDays)throw new TypeError(`Invalid day for ${MONTHS[month]} in ${year}: ${day}`)},isLeapYear=year=>year%4==0&&(year%100!=0||year%400==0),parseDateValue=(value,type,lower,upper)=>{const dateVal=strictParseByte(stripLeadingZeroes(value));if(dateVal<lower||dateVal>upper)throw new TypeError(`${type} must be between ${lower} and ${upper}, inclusive`);return dateVal},parseMilliseconds=value=>{if(null==value)return 0;else return 1e3*strictParseFloat32("0."+value)},parseOffsetToMilliseconds=value=>{const directionStr=value[0];let direction=1;if("+"==directionStr)direction=1;else if("-"==directionStr)direction=-1;else throw new TypeError(`Offset direction, ${directionStr}, must be "+" or "-"`);return direction*(60*Number(value.substring(1,3))+Number(value.substring(4,6)))*60*1e3},stripLeadingZeroes=value=>{let idx2=0;for(;idx2<value.length-1&&"0"===value.charAt(idx2);)idx2++;if(0===idx2)return value;else return value.slice(idx2)},ServiceException=class _ServiceException extends Error{constructor(options){super(options.message);Object.setPrototypeOf(this,_ServiceException.prototype);this.name=options.name;this.$fault=options.$fault;this.$metadata=options.$metadata}},decorateServiceException=(exception,additions={})=>{Object.entries(additions).filter((([,v2])=>void 0!==v2)).forEach((([k2,v2])=>{if(null==exception[k2]||""===exception[k2])exception[k2]=v2}));const message=exception.message||exception.Message||"UnknownError";exception.message=message;delete exception.Message;return exception},throwDefaultError=({output,parsedBody,exceptionCtor,errorCode})=>{const $metadata=deserializeMetadata(output),statusCode=$metadata.httpStatusCode?$metadata.httpStatusCode+"":void 0,response=new exceptionCtor({name:(null==parsedBody?void 0:parsedBody.code)||(null==parsedBody?void 0:parsedBody.Code)||errorCode||statusCode||"UnknownError",$fault:"client",$metadata});throw decorateServiceException(response,parsedBody)},withBaseException=ExceptionCtor=>({output,parsedBody,errorCode})=>{throwDefaultError({output,parsedBody,exceptionCtor:ExceptionCtor,errorCode})},deserializeMetadata=output=>{var _a5,_b2;return{httpStatusCode:output.statusCode,requestId:null!=(_b2=null!=(_a5=output.headers["x-amzn-requestid"])?_a5:output.headers["x-amzn-request-id"])?_b2:output.headers["x-amz-request-id"],extendedRequestId:output.headers["x-amz-id-2"],cfId:output.headers["x-amz-cf-id"]}},loadConfigsForDefaultMode=mode=>{switch(mode){case"standard":return{retryMode:"standard",connectionTimeout:3100};case"in-region":return{retryMode:"standard",connectionTimeout:1100};case"cross-region":return{retryMode:"standard",connectionTimeout:3100};case"mobile":return{retryMode:"standard",connectionTimeout:3e4};default:return{}}},getChecksumConfiguration2=runtimeConfig=>{const checksumAlgorithms=[];for(const id in AlgorithmId){const algorithmId=AlgorithmId[id];if(void 0!==runtimeConfig[algorithmId])checksumAlgorithms.push({algorithmId:()=>algorithmId,checksumConstructor:()=>runtimeConfig[algorithmId]})}return{_checksumAlgorithms:checksumAlgorithms,addChecksumAlgorithm(algo){this._checksumAlgorithms.push(algo)},checksumAlgorithms(){return this._checksumAlgorithms}}},resolveChecksumRuntimeConfig2=clientConfig=>{const runtimeConfig={};clientConfig.checksumAlgorithms().forEach((checksumAlgorithm=>{runtimeConfig[checksumAlgorithm.algorithmId()]=checksumAlgorithm.checksumConstructor()}));return runtimeConfig},getRetryConfiguration=runtimeConfig=>{let _retryStrategy=runtimeConfig.retryStrategy;return{setRetryStrategy(retryStrategy){_retryStrategy=retryStrategy},retryStrategy:()=>_retryStrategy}},resolveRetryRuntimeConfig=retryStrategyConfiguration=>{const runtimeConfig={};runtimeConfig.retryStrategy=retryStrategyConfiguration.retryStrategy();return runtimeConfig},getDefaultExtensionConfiguration=runtimeConfig=>({...getChecksumConfiguration2(runtimeConfig),...getRetryConfiguration(runtimeConfig)}),getDefaultClientConfiguration2=getDefaultExtensionConfiguration,resolveDefaultRuntimeConfig2=config=>({...resolveChecksumRuntimeConfig2(config),...resolveRetryRuntimeConfig(config)});function extendedEncodeURIComponent(str){return encodeURIComponent(str).replace(/[!'()*]/g,(function(c2){return"%"+c2.charCodeAt(0).toString(16).toUpperCase()}))}var getArrayIfSingleItem=mayBeArray=>Array.isArray(mayBeArray)?mayBeArray:[mayBeArray],getValueFromTextNode=obj=>{for(const key2 in obj)if(obj.hasOwnProperty(key2)&&void 0!==obj[key2]["#text"])obj[key2]=obj[key2]["#text"];else if("object"==typeof obj[key2]&&null!==obj[key2])obj[key2]=getValueFromTextNode(obj[key2]);return obj},StringWrapper=function(){const Class=Object.getPrototypeOf(this).constructor,instance8=new(Function.bind.apply(String,[null,...arguments]));Object.setPrototypeOf(instance8,Class.prototype);return instance8};StringWrapper.prototype=Object.create(String.prototype,{constructor:{value:StringWrapper,enumerable:false,writable:true,configurable:true}});Object.setPrototypeOf(StringWrapper,String);var LazyJsonString=class _LazyJsonString extends StringWrapper{deserializeJSON(){return JSON.parse(super.toString())}toJSON(){return super.toString()}static fromObject(object){if(object instanceof _LazyJsonString)return object;else if(object instanceof String||"string"==typeof object)return new _LazyJsonString(object);return new _LazyJsonString(JSON.stringify(object))}};function map(arg0,arg1,arg2){let target,filter3,instructions;if("undefined"==typeof arg1&&"undefined"==typeof arg2){target={};instructions=arg0}else{target=arg0;if("function"==typeof arg1){filter3=arg1;instructions=arg2;return mapWithFilter(target,filter3,instructions)}else instructions=arg1}for(const key2 of Object.keys(instructions))if(Array.isArray(instructions[key2]))applyInstruction(target,null,instructions,key2);else target[key2]=instructions[key2];return target}var convertMap=target=>{const output={};for(const[k2,v2]of Object.entries(target||{}))output[k2]=[,v2];return output},take=(source,instructions)=>{const out={};for(const key2 in instructions)applyInstruction(out,source,instructions,key2);return out},mapWithFilter=(target,filter3,instructions)=>map(target,Object.entries(instructions).reduce(((_instructions,[key2,value])=>{if(Array.isArray(value))_instructions[key2]=value;else if("function"==typeof value)_instructions[key2]=[filter3,value()];else _instructions[key2]=[filter3,value];return _instructions}),{})),applyInstruction=(target,source,instructions,targetKey)=>{if(null!==source){let instruction=instructions[targetKey];if("function"==typeof instruction)instruction=[,instruction];const[filter4=nonNullish,valueFn=pass,sourceKey=targetKey]=instruction;if("function"==typeof filter4&&filter4(source[sourceKey])||"function"!=typeof filter4&&!!filter4)target[targetKey]=valueFn(source[sourceKey]);return}let[filter3,value]=instructions[targetKey];if("function"==typeof value){let _value;const defaultFilterPassed=void 0===filter3&&null!=(_value=value()),customFilterPassed="function"==typeof filter3&&!!filter3(void 0)||"function"!=typeof filter3&&!!filter3;if(defaultFilterPassed)target[targetKey]=_value;else if(customFilterPassed)target[targetKey]=value()}else{const defaultFilterPassed=void 0===filter3&&null!=value,customFilterPassed="function"==typeof filter3&&!!filter3(value)||"function"!=typeof filter3&&!!filter3;if(defaultFilterPassed||customFilterPassed)target[targetKey]=value}},nonNullish=_=>null!=_,pass=_=>_,resolvedPath=(resolvedPath2,input,memberName,labelValueProvider,uriLabel,isGreedyLabel)=>{if(null!=input&&void 0!==input[memberName]){const labelValue=labelValueProvider();if(labelValue.length<=0)throw new Error("Empty value provided for input HTTP label: "+memberName+".");resolvedPath2=resolvedPath2.replace(uriLabel,isGreedyLabel?labelValue.split("/").map((segment=>extendedEncodeURIComponent(segment))).join("/"):extendedEncodeURIComponent(labelValue))}else throw new Error("No value provided for input HTTP label: "+memberName+".");return resolvedPath2},serializeFloat=value=>{if(value!=value)return"NaN";switch(value){case 1/0:return"Infinity";case-1/0:return"-Infinity";default:return value}},serializeDateTime=date=>date.toISOString().replace(".000Z","Z"),CONTENT_LENGTH_HEADER="content-length";function checkContentLengthHeader(){return(next,context2)=>async args=>{var _a5;const{request:request2}=args;if(HttpRequest.isInstance(request2))if(!(CONTENT_LENGTH_HEADER in request2.headers)){const message="Are you using a Stream of unknown length as the Body of a PutObject request? Consider using Upload instead from @aws-sdk/lib-storage.";if("function"==typeof(null==(_a5=null==context2?void 0:context2.logger)?void 0:_a5.warn)&&!(context2.logger instanceof NoOpLogger))context2.logger.warn(message);else console.warn(message)}return next({...args})}}var checkContentLengthHeaderMiddlewareOptions={step:"finalizeRequest",tags:["CHECK_CONTENT_LENGTH_HEADER"],name:"getCheckContentLengthHeaderPlugin",override:true},getCheckContentLengthHeaderPlugin=unused=>({applyToStack:clientStack=>{clientStack.add(checkContentLengthHeader(),checkContentLengthHeaderMiddlewareOptions)}}),regionRedirectEndpointMiddleware=config=>(next,context2)=>async args=>{const originalRegion=await config.region(),regionProviderRef=config.region;let unlock=()=>{};if(context2.__s3RegionRedirect){Object.defineProperty(config,"region",{writable:false,value:async()=>context2.__s3RegionRedirect});unlock=()=>Object.defineProperty(config,"region",{writable:true,value:regionProviderRef})}try{const result=await next(args);if(context2.__s3RegionRedirect){unlock();if(originalRegion!==await config.region())throw new Error("Region was not restored following S3 region redirect.")}return result}catch(e4){unlock();throw e4}},regionRedirectEndpointMiddlewareOptions={tags:["REGION_REDIRECT","S3"],name:"regionRedirectEndpointMiddleware",override:true,relation:"before",toMiddleware:"endpointV2Middleware"};function regionRedirectMiddleware(clientConfig){return(next,context2)=>async args=>{var _a5,_b2;try{return await next(args)}catch(err2){if(clientConfig.followRegionRedirects&&301===(null==(_a5=null==err2?void 0:err2.$metadata)?void 0:_a5.httpStatusCode)){try{const actualRegion=err2.$response.headers["x-amz-bucket-region"];null==(_b2=context2.logger)||_b2.debug(`Redirecting from ${await clientConfig.region()} to ${actualRegion}`);context2.__s3RegionRedirect=actualRegion}catch(e4){throw new Error("Region redirect failed: "+e4)}return next(args)}else throw err2}}}var regionRedirectMiddlewareOptions={step:"initialize",tags:["REGION_REDIRECT","S3"],name:"regionRedirectMiddleware",override:true},getRegionRedirectMiddlewarePlugin=clientConfig=>({applyToStack:clientStack=>{clientStack.add(regionRedirectMiddleware(clientConfig),regionRedirectMiddlewareOptions);clientStack.addRelativeTo(regionRedirectEndpointMiddleware(clientConfig),regionRedirectEndpointMiddlewareOptions)}}),s3ExpiresMiddleware=config=>(next,context2)=>async args=>{var _a5;const result=await next(args),{response}=result;if(HttpResponse.isInstance(response))if(response.headers.expires){response.headers.expiresstring=response.headers.expires;try{parseRfc7231DateTime(response.headers.expires)}catch(e4){null==(_a5=context2.logger)||_a5.warn(`AWS SDK Warning for ${context2.clientName}::${context2.commandName} response parsing (${response.headers.expires}): ${e4}`);delete response.headers.expires}}return result},s3ExpiresMiddlewareOptions={tags:["S3"],name:"s3ExpiresMiddleware",override:true,relation:"after",toMiddleware:"deserializerMiddleware"},getS3ExpiresMiddlewarePlugin=clientConfig=>({applyToStack:clientStack=>{clientStack.addRelativeTo(s3ExpiresMiddleware(clientConfig),s3ExpiresMiddlewareOptions)}}),S3ExpressIdentityCache=class _S3ExpressIdentityCache{constructor(data={}){this.data=data;this.lastPurgeTime=Date.now()}get(key2){const entry=this.data[key2];if(entry)return entry}set(key2,entry){this.data[key2]=entry;return entry}delete(key2){delete this.data[key2]}async purgeExpired(){const now2=Date.now();if(!(this.lastPurgeTime+_S3ExpressIdentityCache.EXPIRED_CREDENTIAL_PURGE_INTERVAL_MS>now2))for(const key2 in this.data){const entry=this.data[key2];if(!entry.isRefreshing){const credential=await entry.identity;if(credential.expiration)if(credential.expiration.getTime()<now2)delete this.data[key2]}}}};S3ExpressIdentityCache.EXPIRED_CREDENTIAL_PURGE_INTERVAL_MS=3e4;var S3ExpressIdentityCacheEntry=class{constructor(_identity,isRefreshing=false,accessed=Date.now()){this._identity=_identity;this.isRefreshing=isRefreshing;this.accessed=accessed}get identity(){this.accessed=Date.now();return this._identity}},S3ExpressIdentityProviderImpl=class _S3ExpressIdentityProviderImpl{constructor(createSessionFn,cache=new S3ExpressIdentityCache){this.createSessionFn=createSessionFn;this.cache=cache}async getS3ExpressIdentity(awsIdentity,identityProperties){const key2=identityProperties.Bucket,{cache}=this,entry=cache.get(key2);if(entry)return entry.identity.then((identity2=>{var _a5,_b2,_c2,_d2;if((null!=(_b2=null==(_a5=identity2.expiration)?void 0:_a5.getTime())?_b2:0)<Date.now())return cache.set(key2,new S3ExpressIdentityCacheEntry(this.getIdentity(key2))).identity;if((null!=(_d2=null==(_c2=identity2.expiration)?void 0:_c2.getTime())?_d2:0)<Date.now()+_S3ExpressIdentityProviderImpl.REFRESH_WINDOW_MS&&!entry.isRefreshing){entry.isRefreshing=true;this.getIdentity(key2).then((id=>{cache.set(key2,new S3ExpressIdentityCacheEntry(Promise.resolve(id)))}))}return identity2}));else return cache.set(key2,new S3ExpressIdentityCacheEntry(this.getIdentity(key2))).identity}async getIdentity(key2){var _a5,_b2;await this.cache.purgeExpired().catch((error=>{console.warn("Error while clearing expired entries in S3ExpressIdentityCache: \n"+error)}));const session=await this.createSessionFn(key2);if(!(null==(_a5=session.Credentials)?void 0:_a5.AccessKeyId)||!(null==(_b2=session.Credentials)?void 0:_b2.SecretAccessKey))throw new Error("s3#createSession response credential missing AccessKeyId or SecretAccessKey.");return{accessKeyId:session.Credentials.AccessKeyId,secretAccessKey:session.Credentials.SecretAccessKey,sessionToken:session.Credentials.SessionToken,expiration:session.Credentials.Expiration?new Date(session.Credentials.Expiration):void 0}}};S3ExpressIdentityProviderImpl.REFRESH_WINDOW_MS=6e4;var HEADER_VALUE_TYPE,getSmithyContext=context2=>context2[SMITHY_CONTEXT_KEY]||(context2[SMITHY_CONTEXT_KEY]={}),normalizeProvider=input=>{if("function"==typeof input)return input;const promisified=Promise.resolve(input);return()=>promisified},ALGORITHM_QUERY_PARAM="X-Amz-Algorithm",CREDENTIAL_QUERY_PARAM="X-Amz-Credential",AMZ_DATE_QUERY_PARAM="X-Amz-Date",SIGNED_HEADERS_QUERY_PARAM="X-Amz-SignedHeaders",EXPIRES_QUERY_PARAM="X-Amz-Expires",SIGNATURE_QUERY_PARAM="X-Amz-Signature",TOKEN_QUERY_PARAM="X-Amz-Security-Token",REGION_SET_PARAM="X-Amz-Region-Set",AUTH_HEADER="authorization",AMZ_DATE_HEADER=AMZ_DATE_QUERY_PARAM.toLowerCase(),DATE_HEADER="date",GENERATED_HEADERS=[AUTH_HEADER,AMZ_DATE_HEADER,DATE_HEADER],SIGNATURE_HEADER=SIGNATURE_QUERY_PARAM.toLowerCase(),SHA256_HEADER="x-amz-content-sha256",TOKEN_HEADER=TOKEN_QUERY_PARAM.toLowerCase(),HOST_HEADER="host",ALWAYS_UNSIGNABLE_HEADERS={authorization:true,"cache-control":true,connection:true,expect:true,from:true,"keep-alive":true,"max-forwards":true,pragma:true,referer:true,te:true,trailer:true,"transfer-encoding":true,upgrade:true,"user-agent":true,"x-amzn-trace-id":true},PROXY_HEADER_PATTERN=/^proxy-/,SEC_HEADER_PATTERN=/^sec-/,UNSIGNABLE_PATTERNS=[/^proxy-/i,/^sec-/i],ALGORITHM_IDENTIFIER="AWS4-HMAC-SHA256",ALGORITHM_IDENTIFIER_V4A="AWS4-ECDSA-P256-SHA256",EVENT_ALGORITHM_IDENTIFIER="AWS4-HMAC-SHA256-PAYLOAD",UNSIGNED_PAYLOAD="UNSIGNED-PAYLOAD",MAX_CACHE_SIZE=50,KEY_TYPE_IDENTIFIER="aws4_request",MAX_PRESIGNED_TTL=604800,signingKeyCache={},cacheQueue=[],createScope=(shortDate,region,service)=>`${shortDate}/${region}/${service}/${KEY_TYPE_IDENTIFIER}`,getSigningKey=async(sha256Constructor,credentials,shortDate,region,service)=>{const cacheKey=`${shortDate}:${region}:${service}:${toHex(await hmac(sha256Constructor,credentials.secretAccessKey,credentials.accessKeyId))}:${credentials.sessionToken}`;if(cacheKey in signingKeyCache)return signingKeyCache[cacheKey];cacheQueue.push(cacheKey);for(;cacheQueue.length>MAX_CACHE_SIZE;)delete signingKeyCache[cacheQueue.shift()];let key2=`AWS4${credentials.secretAccessKey}`;for(const signable of[shortDate,region,service,KEY_TYPE_IDENTIFIER])key2=await hmac(sha256Constructor,key2,signable);return signingKeyCache[cacheKey]=key2},clearCredentialCache=()=>{cacheQueue.length=0;Object.keys(signingKeyCache).forEach((cacheKey=>{delete signingKeyCache[cacheKey]}))},hmac=(ctor,secret,data)=>{const hash2=new ctor(secret);hash2.update(toUint8Array(data));return hash2.digest()},getCanonicalHeaders=({headers},unsignableHeaders,signableHeaders)=>{const canonical={};for(const headerName of Object.keys(headers).sort()){if(null==headers[headerName])continue;const canonicalHeaderName=headerName.toLowerCase();if(canonicalHeaderName in ALWAYS_UNSIGNABLE_HEADERS||(null==unsignableHeaders?void 0:unsignableHeaders.has(canonicalHeaderName))||PROXY_HEADER_PATTERN.test(canonicalHeaderName)||SEC_HEADER_PATTERN.test(canonicalHeaderName))if(!signableHeaders||signableHeaders&&!signableHeaders.has(canonicalHeaderName))continue;canonical[canonicalHeaderName]=headers[headerName].trim().replace(/\s+/g," ")}return canonical},getCanonicalQuery=({query:query3={}})=>{const keys2=[],serialized2={};for(const key2 of Object.keys(query3).sort()){if(key2.toLowerCase()===SIGNATURE_HEADER)continue;keys2.push(key2);const value=query3[key2];if("string"==typeof value)serialized2[key2]=`${escapeUri(key2)}=${escapeUri(value)}`;else if(Array.isArray(value))serialized2[key2]=value.slice(0).reduce(((encoded,value2)=>encoded.concat([`${escapeUri(key2)}=${escapeUri(value2)}`])),[]).sort().join("&")}return keys2.map((key2=>serialized2[key2])).filter((serialized3=>serialized3)).join("&")},isArrayBuffer=arg=>"function"==typeof ArrayBuffer&&arg instanceof ArrayBuffer||"[object ArrayBuffer]"===Object.prototype.toString.call(arg),getPayloadHash=async({headers,body},hashConstructor)=>{for(const headerName of Object.keys(headers))if(headerName.toLowerCase()===SHA256_HEADER)return headers[headerName];if(null==body)return"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855";else if("string"==typeof body||ArrayBuffer.isView(body)||isArrayBuffer(body)){const hashCtor=new hashConstructor;hashCtor.update(toUint8Array(body));return toHex(await hashCtor.digest())}return UNSIGNED_PAYLOAD},HeaderFormatter=class{format(headers){const chunks=[];for(const headerName of Object.keys(headers)){const bytes=fromUtf8(headerName);chunks.push(Uint8Array.from([bytes.byteLength]),bytes,this.formatHeaderValue(headers[headerName]))}const out=new Uint8Array(chunks.reduce(((carry,bytes)=>carry+bytes.byteLength),0));let position=0;for(const chunk of chunks){out.set(chunk,position);position+=chunk.byteLength}return out}formatHeaderValue(header){switch(header.type){case"boolean":return Uint8Array.from([header.value?0:1]);case"byte":return Uint8Array.from([2,header.value]);case"short":const shortView=new DataView(new ArrayBuffer(3));shortView.setUint8(0,3);shortView.setInt16(1,header.value,false);return new Uint8Array(shortView.buffer);case"integer":const intView=new DataView(new ArrayBuffer(5));intView.setUint8(0,4);intView.setInt32(1,header.value,false);return new Uint8Array(intView.buffer);case"long":const longBytes=new Uint8Array(9);longBytes[0]=5;longBytes.set(header.value.bytes,1);return longBytes;case"binary":const binView=new DataView(new ArrayBuffer(3+header.value.byteLength));binView.setUint8(0,6);binView.setUint16(1,header.value.byteLength,false);const binBytes=new Uint8Array(binView.buffer);binBytes.set(header.value,3);return binBytes;case"string":const utf8Bytes=fromUtf8(header.value),strView=new DataView(new ArrayBuffer(3+utf8Bytes.byteLength));strView.setUint8(0,7);strView.setUint16(1,utf8Bytes.byteLength,false);const strBytes=new Uint8Array(strView.buffer);strBytes.set(utf8Bytes,3);return strBytes;case"timestamp":const tsBytes=new Uint8Array(9);tsBytes[0]=8;tsBytes.set(Int64.fromNumber(header.value.valueOf()).bytes,1);return tsBytes;case"uuid":if(!UUID_PATTERN.test(header.value))throw new Error(`Invalid UUID received: ${header.value}`);const uuidBytes=new Uint8Array(17);uuidBytes[0]=9;uuidBytes.set(fromHex(header.value.replace(/\-/g,"")),1);return uuidBytes}}};(function(HEADER_VALUE_TYPE3){HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["boolTrue"]=0]="boolTrue";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["boolFalse"]=1]="boolFalse";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["byte"]=2]="byte";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["short"]=3]="short";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["integer"]=4]="integer";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["long"]=5]="long";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["byteArray"]=6]="byteArray";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["string"]=7]="string";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["timestamp"]=8]="timestamp";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["uuid"]=9]="uuid"})(HEADER_VALUE_TYPE||(HEADER_VALUE_TYPE={}));var UUID_PATTERN=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/,Int64=class _Int64{constructor(bytes){this.bytes=bytes;if(8!==bytes.byteLength)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(number){if(number>0x8000000000000000||number<-0x8000000000000000)throw new Error(`${number} is too large (or, if negative, too small) to represent as an Int64`);const bytes=new Uint8Array(8);for(let i2=7,remaining=Math.abs(Math.round(number));i2>-1&&remaining>0;i2--,remaining/=256)bytes[i2]=remaining;if(number<0)negate(bytes);return new _Int64(bytes)}valueOf(){const bytes=this.bytes.slice(0),negative=128&bytes[0];if(negative)negate(bytes);return parseInt(toHex(bytes),16)*(negative?-1:1)}toString(){return String(this.valueOf())}};function negate(bytes){for(let i2=0;i2<8;i2++)bytes[i2]^=255;for(let i2=7;i2>-1;i2--){bytes[i2]++;if(0!==bytes[i2])break}}var SelectorType,hasHeader=(soughtHeader,headers)=>{soughtHeader=soughtHeader.toLowerCase();for(const headerName of Object.keys(headers))if(soughtHeader===headerName.toLowerCase())return true;return false},getHeaderValue=(soughtHeader,headers)=>{soughtHeader=soughtHeader.toLowerCase();for(const headerName of Object.keys(headers))if(soughtHeader===headerName.toLowerCase())return headers[headerName]},deleteHeader=(soughtHeader,headers)=>{soughtHeader=soughtHeader.toLowerCase();for(const headerName of Object.keys(headers))if(soughtHeader===headerName.toLowerCase())delete headers[headerName]},moveHeadersToQuery=(request2,options={})=>{var _a5;const{headers,query:query3={}}=HttpRequest.clone(request2);for(const name of Object.keys(headers)){const lname=name.toLowerCase();if("x-amz-"===lname.slice(0,6)&&!(null==(_a5=options.unhoistableHeaders)?void 0:_a5.has(lname))){query3[name]=headers[name];delete headers[name]}}return{...request2,headers,query:query3}},prepareRequest=request2=>{request2=HttpRequest.clone(request2);for(const headerName of Object.keys(request2.headers))if(GENERATED_HEADERS.indexOf(headerName.toLowerCase())>-1)delete request2.headers[headerName];return request2},iso8601=time=>toDate(time).toISOString().replace(/\.\d{3}Z$/,"Z"),toDate=time=>{if("number"==typeof time)return new Date(1e3*time);if("string"==typeof time)if(Number(time))return new Date(1e3*Number(time));else return new Date(time);return time},SignatureV4=class{constructor({applyChecksum,credentials,region,service,sha256,uriEscapePath=true}){this.headerFormatter=new HeaderFormatter;this.service=service;this.sha256=sha256;this.uriEscapePath=uriEscapePath;this.applyChecksum="boolean"==typeof applyChecksum?applyChecksum:true;this.regionProvider=normalizeProvider(region);this.credentialProvider=normalizeProvider(credentials)}async presign(originalRequest,options={}){const{signingDate=new Date,expiresIn=3600,unsignableHeaders,unhoistableHeaders,signableHeaders,signingRegion,signingService}=options,credentials=await this.credentialProvider();this.validateResolvedCredentials(credentials);const region=null!=signingRegion?signingRegion:await this.regionProvider(),{longDate,shortDate}=formatDate(signingDate);if(expiresIn>MAX_PRESIGNED_TTL)return Promise.reject("Signature version 4 presigned URLs must have an expiration date less than one week in the future");const scope=createScope(shortDate,region,null!=signingService?signingService:this.service),request2=moveHeadersToQuery(prepareRequest(originalRequest),{unhoistableHeaders});if(credentials.sessionToken)request2.query[TOKEN_QUERY_PARAM]=credentials.sessionToken;request2.query[ALGORITHM_QUERY_PARAM]=ALGORITHM_IDENTIFIER;request2.query[CREDENTIAL_QUERY_PARAM]=`${credentials.accessKeyId}/${scope}`;request2.query[AMZ_DATE_QUERY_PARAM]=longDate;request2.query[EXPIRES_QUERY_PARAM]=expiresIn.toString(10);const canonicalHeaders=getCanonicalHeaders(request2,unsignableHeaders,signableHeaders);request2.query[SIGNED_HEADERS_QUERY_PARAM]=getCanonicalHeaderList(canonicalHeaders);request2.query[SIGNATURE_QUERY_PARAM]=await this.getSignature(longDate,scope,this.getSigningKey(credentials,region,shortDate,signingService),this.createCanonicalRequest(request2,canonicalHeaders,await getPayloadHash(originalRequest,this.sha256)));return request2}async sign(toSign,options){if("string"==typeof toSign)return this.signString(toSign,options);else if(toSign.headers&&toSign.payload)return this.signEvent(toSign,options);else if(toSign.message)return this.signMessage(toSign,options);else return this.signRequest(toSign,options)}async signEvent({headers,payload},{signingDate=new Date,priorSignature,signingRegion,signingService}){const region=null!=signingRegion?signingRegion:await this.regionProvider(),{shortDate,longDate}=formatDate(signingDate),scope=createScope(shortDate,region,null!=signingService?signingService:this.service),hashedPayload=await getPayloadHash({headers:{},body:payload},this.sha256),hash2=new this.sha256;hash2.update(headers);const hashedHeaders=toHex(await hash2.digest()),stringToSign=[EVENT_ALGORITHM_IDENTIFIER,longDate,scope,priorSignature,hashedHeaders,hashedPayload].join("\n");return this.signString(stringToSign,{signingDate,signingRegion:region,signingService})}async signMessage(signableMessage,{signingDate=new Date,signingRegion,signingService}){return this.signEvent({headers:this.headerFormatter.format(signableMessage.message.headers),payload:signableMessage.message.body},{signingDate,signingRegion,signingService,priorSignature:signableMessage.priorSignature}).then((signature=>({message:signableMessage.message,signature})))}async signString(stringToSign,{signingDate=new Date,signingRegion,signingService}={}){const credentials=await this.credentialProvider();this.validateResolvedCredentials(credentials);const region=null!=signingRegion?signingRegion:await this.regionProvider(),{shortDate}=formatDate(signingDate),hash2=new this.sha256(await this.getSigningKey(credentials,region,shortDate,signingService));hash2.update(toUint8Array(stringToSign));return toHex(await hash2.digest())}async signRequest(requestToSign,{signingDate=new Date,signableHeaders,unsignableHeaders,signingRegion,signingService}={}){const credentials=await this.credentialProvider();this.validateResolvedCredentials(credentials);const region=null!=signingRegion?signingRegion:await this.regionProvider(),request2=prepareRequest(requestToSign),{longDate,shortDate}=formatDate(signingDate),scope=createScope(shortDate,region,null!=signingService?signingService:this.service);request2.headers[AMZ_DATE_HEADER]=longDate;if(credentials.sessionToken)request2.headers[TOKEN_HEADER]=credentials.sessionToken;const payloadHash=await getPayloadHash(request2,this.sha256);if(!hasHeader(SHA256_HEADER,request2.headers)&&this.applyChecksum)request2.headers[SHA256_HEADER]=payloadHash;const canonicalHeaders=getCanonicalHeaders(request2,unsignableHeaders,signableHeaders),signature=await this.getSignature(longDate,scope,this.getSigningKey(credentials,region,shortDate,signingService),this.createCanonicalRequest(request2,canonicalHeaders,payloadHash));request2.headers[AUTH_HEADER]=`${ALGORITHM_IDENTIFIER} Credential=${credentials.accessKeyId}/${scope}, SignedHeaders=${getCanonicalHeaderList(canonicalHeaders)}, Signature=${signature}`;return request2}createCanonicalRequest(request2,canonicalHeaders,payloadHash){const sortedHeaders=Object.keys(canonicalHeaders).sort();return`${request2.method}\n${this.getCanonicalPath(request2)}\n${getCanonicalQuery(request2)}\n${sortedHeaders.map((name=>`${name}:${canonicalHeaders[name]}`)).join("\n")}\n\n${sortedHeaders.join(";")}\n${payloadHash}`}async createStringToSign(longDate,credentialScope,canonicalRequest){const hash2=new this.sha256;hash2.update(toUint8Array(canonicalRequest));const hashedRequest=await hash2.digest();return`${ALGORITHM_IDENTIFIER}\n${longDate}\n${credentialScope}\n${toHex(hashedRequest)}`}getCanonicalPath({path:path2}){if(this.uriEscapePath){const normalizedPathSegments=[];for(const pathSegment of path2.split("/"))if(0!==(null==pathSegment?void 0:pathSegment.length))if("."!==pathSegment)if(".."===pathSegment)normalizedPathSegments.pop();else normalizedPathSegments.push(pathSegment);const normalizedPath=`${(null==path2?void 0:path2.startsWith("/"))?"/":""}${normalizedPathSegments.join("/")}${normalizedPathSegments.length>0&&(null==path2?void 0:path2.endsWith("/"))?"/":""}`;return escapeUri(normalizedPath).replace(/%2F/g,"/")}return path2}async getSignature(longDate,credentialScope,keyPromise,canonicalRequest){const stringToSign=await this.createStringToSign(longDate,credentialScope,canonicalRequest),hash2=new this.sha256(await keyPromise);hash2.update(toUint8Array(stringToSign));return toHex(await hash2.digest())}getSigningKey(credentials,region,shortDate,service){return getSigningKey(this.sha256,credentials,shortDate,region,service||this.service)}validateResolvedCredentials(credentials){if("object"!=typeof credentials||"string"!=typeof credentials.accessKeyId||"string"!=typeof credentials.secretAccessKey)throw new Error("Resolved credential object is not valid")}},formatDate=now2=>{const longDate=iso8601(now2).replace(/[\-:]/g,"");return{longDate,shortDate:longDate.slice(0,8)}},getCanonicalHeaderList=headers=>Object.keys(headers).sort().join(";"),booleanSelector=(obj,key2,type)=>{if(key2 in obj){if("true"===obj[key2])return true;if("false"===obj[key2])return false;throw new Error(`Cannot load ${type} "${key2}". Expected "true" or "false", got ${obj[key2]}.`)}};(function(SelectorType2){SelectorType2["ENV"]="env";SelectorType2["CONFIG"]="shared config entry"})(SelectorType||(SelectorType={}));var S3_EXPRESS_BUCKET_TYPE="Directory",S3_EXPRESS_BACKEND="S3Express",S3_EXPRESS_AUTH_SCHEME="sigv4-s3express",SESSION_TOKEN_QUERY_PARAM="X-Amz-S3session-Token",SESSION_TOKEN_HEADER=SESSION_TOKEN_QUERY_PARAM.toLowerCase(),NODE_DISABLE_S3_EXPRESS_SESSION_AUTH_ENV_NAME="AWS_S3_DISABLE_EXPRESS_SESSION_AUTH",NODE_DISABLE_S3_EXPRESS_SESSION_AUTH_INI_NAME="s3_disable_express_session_auth",NODE_DISABLE_S3_EXPRESS_SESSION_AUTH_OPTIONS={environmentVariableSelector:env=>booleanSelector(env,NODE_DISABLE_S3_EXPRESS_SESSION_AUTH_ENV_NAME,SelectorType.ENV),configFileSelector:profile=>booleanSelector(profile,NODE_DISABLE_S3_EXPRESS_SESSION_AUTH_INI_NAME,SelectorType.CONFIG),default:false},SignatureV4S3Express=class extends SignatureV4{async signWithCredentials(requestToSign,credentials,options){const credentialsWithoutSessionToken=getCredentialsWithoutSessionToken(credentials);requestToSign.headers[SESSION_TOKEN_HEADER]=credentials.sessionToken;setSingleOverride(this,credentialsWithoutSessionToken);return this.signRequest(requestToSign,null!=options?options:{})}async presignWithCredentials(requestToSign,credentials,options){var _a5;const credentialsWithoutSessionToken=getCredentialsWithoutSessionToken(credentials);delete requestToSign.headers[SESSION_TOKEN_HEADER];requestToSign.headers[SESSION_TOKEN_QUERY_PARAM]=credentials.sessionToken;requestToSign.query=null!=(_a5=requestToSign.query)?_a5:{};requestToSign.query[SESSION_TOKEN_QUERY_PARAM]=credentials.sessionToken;setSingleOverride(this,credentialsWithoutSessionToken);return this.presign(requestToSign,options)}};function getCredentialsWithoutSessionToken(credentials){return{accessKeyId:credentials.accessKeyId,secretAccessKey:credentials.secretAccessKey,expiration:credentials.expiration}}function setSingleOverride(privateAccess,credentialsWithoutSessionToken){const id=setTimeout((()=>{throw new Error("SignatureV4S3Express credential override was created but not called.")}),10),currentCredentialProvider=privateAccess.credentialProvider;privateAccess.credentialProvider=()=>{clearTimeout(id);privateAccess.credentialProvider=currentCredentialProvider;return Promise.resolve(credentialsWithoutSessionToken)}}var s3ExpressMiddleware=options=>(next,context2)=>async args=>{var _a5,_b2,_c2,_d2,_e2;if(context2.endpointV2){const endpoint=context2.endpointV2,isS3ExpressAuth=(null==(_c2=null==(_b2=null==(_a5=endpoint.properties)?void 0:_a5.authSchemes)?void 0:_b2[0])?void 0:_c2.name)===S3_EXPRESS_AUTH_SCHEME;if((null==(_d2=endpoint.properties)?void 0:_d2.backend)===S3_EXPRESS_BACKEND||(null==(_e2=endpoint.properties)?void 0:_e2.bucketType)===S3_EXPRESS_BUCKET_TYPE)context2.isS3ExpressBucket=true;if(isS3ExpressAuth){const requestBucket=args.input.Bucket;if(requestBucket){const s3ExpressIdentity=await options.s3ExpressIdentityProvider.getS3ExpressIdentity(await options.credentials(),{Bucket:requestBucket});context2.s3ExpressIdentity=s3ExpressIdentity;if(HttpRequest.isInstance(args.request)&&s3ExpressIdentity.sessionToken)args.request.headers[SESSION_TOKEN_HEADER]=s3ExpressIdentity.sessionToken}}}return next(args)},s3ExpressMiddlewareOptions={name:"s3ExpressMiddleware",step:"build",tags:["S3","S3_EXPRESS"],override:true},getS3ExpressPlugin=options=>({applyToStack:clientStack=>{clientStack.add(s3ExpressMiddleware(options),s3ExpressMiddlewareOptions)}});function convertHttpAuthSchemesToMap(httpAuthSchemes){const map2=new Map;for(const scheme of httpAuthSchemes)map2.set(scheme.schemeId,scheme);return map2}var httpAuthSchemeMiddleware=(config,mwOptions)=>(next,context2)=>async args=>{var _a5;const options=config.httpAuthSchemeProvider(await mwOptions.httpAuthSchemeParametersProvider(config,context2,args.input)),authSchemes=convertHttpAuthSchemesToMap(config.httpAuthSchemes),smithyContext=getSmithyContext(context2),failureReasons=[];for(const option of options){const scheme=authSchemes.get(option.schemeId);if(!scheme){failureReasons.push(`HttpAuthScheme \`${option.schemeId}\` was not enabled for this service.`);continue}const identityProvider=scheme.identityProvider(await mwOptions.identityProviderConfigProvider(config));if(!identityProvider){failureReasons.push(`HttpAuthScheme \`${option.schemeId}\` did not have an IdentityProvider configured.`);continue}const{identityProperties={},signingProperties={}}=(null==(_a5=option.propertiesExtractor)?void 0:_a5.call(option,config,context2))||{};option.identityProperties=Object.assign(option.identityProperties||{},identityProperties);option.signingProperties=Object.assign(option.signingProperties||{},signingProperties);smithyContext.selectedHttpAuthScheme={httpAuthOption:option,identity:await identityProvider(option.identityProperties),signer:scheme.signer};break}if(!smithyContext.selectedHttpAuthScheme)throw new Error(failureReasons.join("\n"));return next(args)},resolveParamsForS3=async endpointParams=>{const bucket=(null==endpointParams?void 0:endpointParams.Bucket)||"";if("string"==typeof endpointParams.Bucket)endpointParams.Bucket=bucket.replace(/#/g,encodeURIComponent("#")).replace(/\?/g,encodeURIComponent("?"));if(isArnBucketName(bucket)){if(true===endpointParams.ForcePathStyle)throw new Error("Path-style addressing cannot be used with ARN buckets")}else if(!isDnsCompatibleBucketName(bucket)||-1!==bucket.indexOf(".")&&!String(endpointParams.Endpoint).startsWith("http:")||bucket.toLowerCase()!==bucket||bucket.length<3)endpointParams.ForcePathStyle=true;if(endpointParams.DisableMultiRegionAccessPoints){endpointParams.disableMultiRegionAccessPoints=true;endpointParams.DisableMRAP=true}return endpointParams},DOMAIN_PATTERN=/^[a-z0-9][a-z0-9\.\-]{1,61}[a-z0-9]$/,IP_ADDRESS_PATTERN=/(\d+\.){3}\d+/,DOTS_PATTERN=/\.\./,DOT_PATTERN=/\./,S3_HOSTNAME_PATTERN=/^(.+\.)?s3(-fips)?(\.dualstack)?[.-]([a-z0-9-]+)\./,isDnsCompatibleBucketName=bucketName=>DOMAIN_PATTERN.test(bucketName)&&!IP_ADDRESS_PATTERN.test(bucketName)&&!DOTS_PATTERN.test(bucketName),isArnBucketName=bucketName=>{const[arn,partition2,service,,,bucket]=bucketName.split(":"),isArn="arn"===arn&&bucketName.split(":").length>=6,isValidArn=Boolean(isArn&&partition2&&service&&bucket);if(isArn&&!isValidArn)throw new Error(`Invalid ARN: ${bucketName} was an invalid ARN.`);return isValidArn},createConfigValueProvider=(configKey,canonicalEndpointParamKey,config)=>{const configProvider=async()=>{var _a5;const configValue=null!=(_a5=config[configKey])?_a5:config[canonicalEndpointParamKey];if("function"==typeof configValue)return configValue();else return configValue};if("credentialScope"===configKey||"CredentialScope"===canonicalEndpointParamKey)return async()=>{var _a5;const credentials="function"==typeof config.credentials?await config.credentials():config.credentials;return null!=(_a5=null==credentials?void 0:credentials.credentialScope)?_a5:null==credentials?void 0:credentials.CredentialScope};if("accountId"===configKey||"AccountId"===canonicalEndpointParamKey)return async()=>{var _a5;const credentials="function"==typeof config.credentials?await config.credentials():config.credentials;return null!=(_a5=null==credentials?void 0:credentials.accountId)?_a5:null==credentials?void 0:credentials.AccountId};if("endpoint"===configKey||"endpoint"===canonicalEndpointParamKey)return async()=>{const endpoint=await configProvider();if(endpoint&&"object"==typeof endpoint){if("url"in endpoint)return endpoint.url.href;if("hostname"in endpoint){const{protocol,hostname,port,path:path2}=endpoint;return`${protocol}//${hostname}${port?":"+port:""}${path2}`}}return endpoint};else return configProvider},getEndpointFromConfig=async serviceId=>{};function parseQueryString(querystring){const query3={};if(querystring=querystring.replace(/^\?/,""))for(const pair of querystring.split("&")){let[key2,value=null]=pair.split("=");key2=decodeURIComponent(key2);if(value)value=decodeURIComponent(value);if(!(key2 in query3))query3[key2]=value;else if(Array.isArray(query3[key2]))query3[key2].push(value);else query3[key2]=[query3[key2],value]}return query3}var parseUrl=url=>{if("string"==typeof url)return parseUrl(new URL(url));const{hostname,pathname,port,protocol,search}=url;let query3;if(search)query3=parseQueryString(search);return{hostname,port:port?parseInt(port):void 0,protocol,path:pathname,query:query3}},toEndpointV1=endpoint=>{if("object"==typeof endpoint)if("url"in endpoint)return parseUrl(endpoint.url);else return endpoint;return parseUrl(endpoint)},getEndpointFromInstructions=async(commandInput,instructionsSupplier,clientConfig,context2)=>{if(!clientConfig.endpoint){const endpointFromConfig=await getEndpointFromConfig(clientConfig.serviceId||"");if(endpointFromConfig)clientConfig.endpoint=()=>Promise.resolve(toEndpointV1(endpointFromConfig))}const endpointParams=await resolveParams(commandInput,instructionsSupplier,clientConfig);if("function"!=typeof clientConfig.endpointProvider)throw new Error("config.endpointProvider is not set.");return clientConfig.endpointProvider(endpointParams,context2)},resolveParams=async(commandInput,instructionsSupplier,clientConfig)=>{var _a5;const endpointParams={},instructions=(null==(_a5=null==instructionsSupplier?void 0:instructionsSupplier.getEndpointParameterInstructions)?void 0:_a5.call(instructionsSupplier))||{};for(const[name,instruction]of Object.entries(instructions))switch(instruction.type){case"staticContextParams":endpointParams[name]=instruction.value;break;case"contextParams":endpointParams[name]=commandInput[instruction.name];break;case"clientContextParams":case"builtInParams":endpointParams[name]=await createConfigValueProvider(instruction.name,name,clientConfig)();break;default:throw new Error("Unrecognized endpoint parameter instruction: "+JSON.stringify(instruction))}if(0===Object.keys(instructions).length)Object.assign(endpointParams,clientConfig);if("s3"===String(clientConfig.serviceId).toLowerCase())await resolveParamsForS3(endpointParams);return endpointParams},endpointMiddleware=({config,instructions})=>(next,context2)=>async args=>{var _a5,_b2,_c2;const endpoint=await getEndpointFromInstructions(args.input,{getEndpointParameterInstructions:()=>instructions},{...config},context2);context2.endpointV2=endpoint;context2.authSchemes=null==(_a5=endpoint.properties)?void 0:_a5.authSchemes;const authScheme=null==(_b2=context2.authSchemes)?void 0:_b2[0];if(authScheme){context2["signing_region"]=authScheme.signingRegion;context2["signing_service"]=authScheme.signingName;const smithyContext=getSmithyContext(context2),httpAuthOption=null==(_c2=null==smithyContext?void 0:smithyContext.selectedHttpAuthScheme)?void 0:_c2.httpAuthOption;if(httpAuthOption)httpAuthOption.signingProperties=Object.assign(httpAuthOption.signingProperties||{},{signing_region:authScheme.signingRegion,signingRegion:authScheme.signingRegion,signing_service:authScheme.signingName,signingName:authScheme.signingName,signingRegionSet:authScheme.signingRegionSet},authScheme.properties)}return next({...args})},deserializerMiddleware=(options,deserializer)=>next=>async args=>{const{response}=await next(args);try{return{response,output:await deserializer(response,options)}}catch(error){Object.defineProperty(error,"$response",{value:response});if(!("$metadata"in error)){const hint="Deserialization error: to see the raw response, inspect the hidden field {error}.$response on this object.";error.message+="\n  "+hint;if("undefined"!=typeof error.$responseBodyText)if(error.$response)error.$response.body=error.$responseBodyText}throw error}},serializerMiddleware=(options,serializer)=>(next,context2)=>async args=>{var _a5;const endpoint=(null==(_a5=context2.endpointV2)?void 0:_a5.url)&&options.urlParser?async()=>options.urlParser(context2.endpointV2.url):options.endpoint;if(!endpoint)throw new Error("No valid endpoint provider available.");const request2=await serializer(args.input,{...options,endpoint});return next({...args,request:request2})},deserializerMiddlewareOption={name:"deserializerMiddleware",step:"deserialize",tags:["DESERIALIZER"],override:true},serializerMiddlewareOption={name:"serializerMiddleware",step:"serialize",tags:["SERIALIZER"],override:true};function getSerdePlugin(config,serializer,deserializer){return{applyToStack:commandStack=>{commandStack.add(deserializerMiddleware(config,deserializer),deserializerMiddlewareOption);commandStack.add(serializerMiddleware(config,serializer),serializerMiddlewareOption)}}}var RETRY_MODES,endpointMiddlewareOptions={step:"serialize",tags:["ENDPOINT_PARAMETERS","ENDPOINT_V2","ENDPOINT"],name:"endpointV2Middleware",override:true,relation:"before",toMiddleware:serializerMiddlewareOption.name},getEndpointPlugin=(config,instructions)=>({applyToStack:clientStack=>{clientStack.addRelativeTo(endpointMiddleware({config,instructions}),endpointMiddlewareOptions)}}),resolveEndpointConfig=input=>{var _a5,_b2,_c2;const tls=null!=(_a5=input.tls)?_a5:true,{endpoint}=input,customEndpointProvider=null!=endpoint?async()=>toEndpointV1(await normalizeProvider(endpoint)()):void 0,isCustomEndpoint=!!endpoint;return{...input,endpoint:customEndpointProvider,tls,isCustomEndpoint,useDualstackEndpoint:normalizeProvider(null!=(_b2=input.useDualstackEndpoint)?_b2:false),useFipsEndpoint:normalizeProvider(null!=(_c2=input.useFipsEndpoint)?_c2:false)}},httpAuthSchemeEndpointRuleSetMiddlewareOptions={step:"serialize",tags:["HTTP_AUTH_SCHEME"],name:"httpAuthSchemeMiddleware",override:true,relation:"before",toMiddleware:endpointMiddlewareOptions.name},getHttpAuthSchemeEndpointRuleSetPlugin=(config,{httpAuthSchemeParametersProvider,identityProviderConfigProvider})=>({applyToStack:clientStack=>{clientStack.addRelativeTo(httpAuthSchemeMiddleware(config,{httpAuthSchemeParametersProvider,identityProviderConfigProvider}),httpAuthSchemeEndpointRuleSetMiddlewareOptions)}}),httpAuthSchemeMiddlewareOptions={step:"serialize",tags:["HTTP_AUTH_SCHEME"],name:"httpAuthSchemeMiddleware",override:true,relation:"before",toMiddleware:serializerMiddlewareOption.name},getHttpAuthSchemePlugin=(config,{httpAuthSchemeParametersProvider,identityProviderConfigProvider})=>({applyToStack:clientStack=>{clientStack.addRelativeTo(httpAuthSchemeMiddleware(config,{httpAuthSchemeParametersProvider,identityProviderConfigProvider}),httpAuthSchemeMiddlewareOptions)}}),defaultErrorHandler=signingProperties=>error=>{throw error},defaultSuccessHandler=(httpResponse,signingProperties)=>{},httpSigningMiddleware=config=>(next,context2)=>async args=>{if(!HttpRequest.isInstance(args.request))return next(args);const scheme=getSmithyContext(context2).selectedHttpAuthScheme;if(!scheme)throw new Error("No HttpAuthScheme was selected: unable to sign request");const{httpAuthOption:{signingProperties={}},identity:identity2,signer}=scheme,output=await next({...args,request:await signer.sign(args.request,identity2,signingProperties)}).catch((signer.errorHandler||defaultErrorHandler)(signingProperties));(signer.successHandler||defaultSuccessHandler)(output.response,signingProperties);return output};(function(RETRY_MODES2){RETRY_MODES2["STANDARD"]="standard";RETRY_MODES2["ADAPTIVE"]="adaptive"})(RETRY_MODES||(RETRY_MODES={}));var getRandomValues,DEFAULT_MAX_ATTEMPTS=3,DEFAULT_RETRY_MODE=RETRY_MODES.STANDARD,CLOCK_SKEW_ERROR_CODES=["AuthFailure","InvalidSignatureException","RequestExpired","RequestInTheFuture","RequestTimeTooSkewed","SignatureDoesNotMatch"],THROTTLING_ERROR_CODES=["BandwidthLimitExceeded","EC2ThrottledException","LimitExceededException","PriorRequestNotComplete","ProvisionedThroughputExceededException","RequestLimitExceeded","RequestThrottled","RequestThrottledException","SlowDown","ThrottledException","Throttling","ThrottlingException","TooManyRequestsException","TransactionInProgressException"],TRANSIENT_ERROR_CODES=["TimeoutError","RequestTimeout","RequestTimeoutException"],TRANSIENT_ERROR_STATUS_CODES=[500,502,503,504],NODEJS_TIMEOUT_ERROR_CODES=["ECONNRESET","ECONNREFUSED","EPIPE","ETIMEDOUT"],isRetryableByTrait=error=>void 0!==error.$retryable,isClockSkewError=error=>CLOCK_SKEW_ERROR_CODES.includes(error.name),isClockSkewCorrectedError=error=>{var _a5;return null==(_a5=error.$metadata)?void 0:_a5.clockSkewCorrected},isThrottlingError=error=>{var _a5,_b2;return 429===(null==(_a5=error.$metadata)?void 0:_a5.httpStatusCode)||THROTTLING_ERROR_CODES.includes(error.name)||true==(null==(_b2=error.$retryable)?void 0:_b2.throttling)},isTransientError=error=>{var _a5;return isClockSkewCorrectedError(error)||TRANSIENT_ERROR_CODES.includes(error.name)||NODEJS_TIMEOUT_ERROR_CODES.includes((null==error?void 0:error.code)||"")||TRANSIENT_ERROR_STATUS_CODES.includes((null==(_a5=error.$metadata)?void 0:_a5.httpStatusCode)||0)},isServerError=error=>{var _a5;if(void 0!==(null==(_a5=error.$metadata)?void 0:_a5.httpStatusCode)){const statusCode=error.$metadata.httpStatusCode;if(500<=statusCode&&statusCode<=599&&!isTransientError(error))return true;else return false}return false},DefaultRateLimiter=class{constructor(options){var _a5,_b2,_c2,_d2,_e2;this.currentCapacity=0;this.enabled=false;this.lastMaxRate=0;this.measuredTxRate=0;this.requestCount=0;this.lastTimestamp=0;this.timeWindow=0;this.beta=null!=(_a5=null==options?void 0:options.beta)?_a5:.7;this.minCapacity=null!=(_b2=null==options?void 0:options.minCapacity)?_b2:1;this.minFillRate=null!=(_c2=null==options?void 0:options.minFillRate)?_c2:.5;this.scaleConstant=null!=(_d2=null==options?void 0:options.scaleConstant)?_d2:.4;this.smooth=null!=(_e2=null==options?void 0:options.smooth)?_e2:.8;const currentTimeInSeconds=this.getCurrentTimeInSeconds();this.lastThrottleTime=currentTimeInSeconds;this.lastTxRateBucket=Math.floor(this.getCurrentTimeInSeconds());this.fillRate=this.minFillRate;this.maxCapacity=this.minCapacity}getCurrentTimeInSeconds(){return Date.now()/1e3}async getSendToken(){return this.acquireTokenBucket(1)}async acquireTokenBucket(amount){if(this.enabled){this.refillTokenBucket();if(amount>this.currentCapacity){const delay2=(amount-this.currentCapacity)/this.fillRate*1e3;await new Promise((resolve=>setTimeout(resolve,delay2)))}this.currentCapacity=this.currentCapacity-amount}}refillTokenBucket(){const timestamp=this.getCurrentTimeInSeconds();if(!this.lastTimestamp){this.lastTimestamp=timestamp;return}const fillAmount=(timestamp-this.lastTimestamp)*this.fillRate;this.currentCapacity=Math.min(this.maxCapacity,this.currentCapacity+fillAmount);this.lastTimestamp=timestamp}updateClientSendingRate(response){let calculatedRate;this.updateMeasuredRate();if(isThrottlingError(response)){const rateToUse=!this.enabled?this.measuredTxRate:Math.min(this.measuredTxRate,this.fillRate);this.lastMaxRate=rateToUse;this.calculateTimeWindow();this.lastThrottleTime=this.getCurrentTimeInSeconds();calculatedRate=this.cubicThrottle(rateToUse);this.enableTokenBucket()}else{this.calculateTimeWindow();calculatedRate=this.cubicSuccess(this.getCurrentTimeInSeconds())}const newRate=Math.min(calculatedRate,2*this.measuredTxRate);this.updateTokenBucketRate(newRate)}calculateTimeWindow(){this.timeWindow=this.getPrecise(Math.pow(this.lastMaxRate*(1-this.beta)/this.scaleConstant,1/3))}cubicThrottle(rateToUse){return this.getPrecise(rateToUse*this.beta)}cubicSuccess(timestamp){return this.getPrecise(this.scaleConstant*Math.pow(timestamp-this.lastThrottleTime-this.timeWindow,3)+this.lastMaxRate)}enableTokenBucket(){this.enabled=true}updateTokenBucketRate(newRate){this.refillTokenBucket();this.fillRate=Math.max(newRate,this.minFillRate);this.maxCapacity=Math.max(newRate,this.minCapacity);this.currentCapacity=Math.min(this.currentCapacity,this.maxCapacity)}updateMeasuredRate(){const t4=this.getCurrentTimeInSeconds(),timeBucket=Math.floor(2*t4)/2;this.requestCount++;if(timeBucket>this.lastTxRateBucket){const currentRate=this.requestCount/(timeBucket-this.lastTxRateBucket);this.measuredTxRate=this.getPrecise(currentRate*this.smooth+this.measuredTxRate*(1-this.smooth));this.requestCount=0;this.lastTxRateBucket=timeBucket}}getPrecise(num){return parseFloat(num.toFixed(8))}},DEFAULT_RETRY_DELAY_BASE=100,MAXIMUM_RETRY_DELAY=2e4,THROTTLING_RETRY_DELAY_BASE=500,INITIAL_RETRY_TOKENS=500,RETRY_COST=5,TIMEOUT_RETRY_COST=10,NO_RETRY_INCREMENT=1,INVOCATION_ID_HEADER="amz-sdk-invocation-id",REQUEST_HEADER="amz-sdk-request",getDefaultRetryBackoffStrategy=()=>{let delayBase=DEFAULT_RETRY_DELAY_BASE;return{computeNextBackoffDelay:attempts=>Math.floor(Math.min(MAXIMUM_RETRY_DELAY,Math.random()*2**attempts*delayBase)),setDelayBase:delay2=>{delayBase=delay2}}},createDefaultRetryToken=({retryDelay,retryCount,retryCost})=>({getRetryCount:()=>retryCount,getRetryDelay:()=>Math.min(MAXIMUM_RETRY_DELAY,retryDelay),getRetryCost:()=>retryCost}),StandardRetryStrategy=class{constructor(maxAttempts){this.maxAttempts=maxAttempts;this.mode=RETRY_MODES.STANDARD;this.capacity=INITIAL_RETRY_TOKENS;this.retryBackoffStrategy=getDefaultRetryBackoffStrategy();this.maxAttemptsProvider="function"==typeof maxAttempts?maxAttempts:async()=>maxAttempts}async acquireInitialRetryToken(retryTokenScope){return createDefaultRetryToken({retryDelay:DEFAULT_RETRY_DELAY_BASE,retryCount:0})}async refreshRetryTokenForRetry(token,errorInfo){const maxAttempts=await this.getMaxAttempts();if(this.shouldRetry(token,errorInfo,maxAttempts)){const errorType=errorInfo.errorType;this.retryBackoffStrategy.setDelayBase("THROTTLING"===errorType?THROTTLING_RETRY_DELAY_BASE:DEFAULT_RETRY_DELAY_BASE);const delayFromErrorType=this.retryBackoffStrategy.computeNextBackoffDelay(token.getRetryCount()),retryDelay=errorInfo.retryAfterHint?Math.max(errorInfo.retryAfterHint.getTime()-Date.now()||0,delayFromErrorType):delayFromErrorType,capacityCost=this.getCapacityCost(errorType);this.capacity-=capacityCost;return createDefaultRetryToken({retryDelay,retryCount:token.getRetryCount()+1,retryCost:capacityCost})}throw new Error("No retry token available")}recordSuccess(token){var _a5;this.capacity=Math.max(INITIAL_RETRY_TOKENS,this.capacity+(null!=(_a5=token.getRetryCost())?_a5:NO_RETRY_INCREMENT))}getCapacity(){return this.capacity}async getMaxAttempts(){try{return await this.maxAttemptsProvider()}catch(error){console.warn(`Max attempts provider could not resolve. Using default of ${DEFAULT_MAX_ATTEMPTS}`);return DEFAULT_MAX_ATTEMPTS}}shouldRetry(tokenToRenew,errorInfo,maxAttempts){return tokenToRenew.getRetryCount()+1<maxAttempts&&this.capacity>=this.getCapacityCost(errorInfo.errorType)&&this.isRetryableError(errorInfo.errorType)}getCapacityCost(errorType){return"TRANSIENT"===errorType?TIMEOUT_RETRY_COST:RETRY_COST}isRetryableError(errorType){return"THROTTLING"===errorType||"TRANSIENT"===errorType}},AdaptiveRetryStrategy=class{constructor(maxAttemptsProvider,options){this.maxAttemptsProvider=maxAttemptsProvider;this.mode=RETRY_MODES.ADAPTIVE;const{rateLimiter}=null!=options?options:{};this.rateLimiter=null!=rateLimiter?rateLimiter:new DefaultRateLimiter;this.standardRetryStrategy=new StandardRetryStrategy(maxAttemptsProvider)}async acquireInitialRetryToken(retryTokenScope){await this.rateLimiter.getSendToken();return this.standardRetryStrategy.acquireInitialRetryToken(retryTokenScope)}async refreshRetryTokenForRetry(tokenToRenew,errorInfo){this.rateLimiter.updateClientSendingRate(errorInfo);return this.standardRetryStrategy.refreshRetryTokenForRetry(tokenToRenew,errorInfo)}recordSuccess(token){this.rateLimiter.updateClientSendingRate({});this.standardRetryStrategy.recordSuccess(token)}},ConfiguredRetryStrategy=class extends StandardRetryStrategy{constructor(maxAttempts,computeNextBackoffDelay=DEFAULT_RETRY_DELAY_BASE){super("function"==typeof maxAttempts?maxAttempts:async()=>maxAttempts);if("number"==typeof computeNextBackoffDelay)this.computeNextBackoffDelay=()=>computeNextBackoffDelay;else this.computeNextBackoffDelay=computeNextBackoffDelay}async refreshRetryTokenForRetry(tokenToRenew,errorInfo){const token=await super.refreshRetryTokenForRetry(tokenToRenew,errorInfo);token.getRetryDelay=()=>this.computeNextBackoffDelay(token.getRetryCount());return token}},rnds8=new Uint8Array(16);function rng(){if(!getRandomValues)if(!(getRandomValues="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}var regex_default=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate(uuid2){return"string"==typeof uuid2&&regex_default.test(uuid2)}var validate_default=validate,byteToHex=[];for(let i2=0;i2<256;++i2)byteToHex.push((i2+256).toString(16).slice(1));function unsafeStringify(arr,offset=0){return byteToHex[arr[offset+0]]+byteToHex[arr[offset+1]]+byteToHex[arr[offset+2]]+byteToHex[arr[offset+3]]+"-"+byteToHex[arr[offset+4]]+byteToHex[arr[offset+5]]+"-"+byteToHex[arr[offset+6]]+byteToHex[arr[offset+7]]+"-"+byteToHex[arr[offset+8]]+byteToHex[arr[offset+9]]+"-"+byteToHex[arr[offset+10]]+byteToHex[arr[offset+11]]+byteToHex[arr[offset+12]]+byteToHex[arr[offset+13]]+byteToHex[arr[offset+14]]+byteToHex[arr[offset+15]]}function stringify(arr,offset=0){const uuid2=unsafeStringify(arr,offset);if(!validate_default(uuid2))throw TypeError("Stringified UUID is invalid");return uuid2}var stringify_default=stringify,randomUUID="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),native_default={randomUUID};function v4(options,buf,offset){if(native_default.randomUUID&&!buf&&!options)return native_default.randomUUID();const rnds=(options=options||{}).random||(options.rng||rng)();rnds[6]=15&rnds[6]|64;rnds[8]=63&rnds[8]|128;if(buf){offset=offset||0;for(let i2=0;i2<16;++i2)buf[offset+i2]=rnds[i2];return buf}return unsafeStringify(rnds)}var v4_default=v4,getDefaultRetryQuota=(initialRetryTokens,options)=>{var _a5,_b2,_c2;const MAX_CAPACITY=initialRetryTokens,noRetryIncrement=null!=(_a5=null==options?void 0:options.noRetryIncrement)?_a5:NO_RETRY_INCREMENT,retryCost=null!=(_b2=null==options?void 0:options.retryCost)?_b2:RETRY_COST,timeoutRetryCost=null!=(_c2=null==options?void 0:options.timeoutRetryCost)?_c2:TIMEOUT_RETRY_COST;let availableCapacity=initialRetryTokens;const getCapacityAmount=error=>"TimeoutError"===error.name?timeoutRetryCost:retryCost,hasRetryTokens=error=>getCapacityAmount(error)<=availableCapacity;return Object.freeze({hasRetryTokens,retrieveRetryTokens:error=>{if(!hasRetryTokens(error))throw new Error("No retry token available");const capacityAmount=getCapacityAmount(error);availableCapacity-=capacityAmount;return capacityAmount},releaseRetryTokens:capacityReleaseAmount=>{availableCapacity+=null!=capacityReleaseAmount?capacityReleaseAmount:noRetryIncrement;availableCapacity=Math.min(availableCapacity,MAX_CAPACITY)}})},defaultDelayDecider=(delayBase,attempts)=>Math.floor(Math.min(MAXIMUM_RETRY_DELAY,Math.random()*2**attempts*delayBase)),defaultRetryDecider=error=>{if(!error)return false;else return isRetryableByTrait(error)||isClockSkewError(error)||isThrottlingError(error)||isTransientError(error)},asSdkError=error=>{if(error instanceof Error)return error;if(error instanceof Object)return Object.assign(new Error,error);if("string"==typeof error)return new Error(error);else return new Error(`AWS SDK error wrapper for ${error}`)},StandardRetryStrategy2=class{constructor(maxAttemptsProvider,options){var _a5,_b2,_c2;this.maxAttemptsProvider=maxAttemptsProvider;this.mode=RETRY_MODES.STANDARD;this.retryDecider=null!=(_a5=null==options?void 0:options.retryDecider)?_a5:defaultRetryDecider;this.delayDecider=null!=(_b2=null==options?void 0:options.delayDecider)?_b2:defaultDelayDecider;this.retryQuota=null!=(_c2=null==options?void 0:options.retryQuota)?_c2:getDefaultRetryQuota(INITIAL_RETRY_TOKENS)}shouldRetry(error,attempts,maxAttempts){return attempts<maxAttempts&&this.retryDecider(error)&&this.retryQuota.hasRetryTokens(error)}async getMaxAttempts(){let maxAttempts;try{maxAttempts=await this.maxAttemptsProvider()}catch(error){maxAttempts=DEFAULT_MAX_ATTEMPTS}return maxAttempts}async retry(next,args,options){let retryTokenAmount,attempts=0,totalDelay=0;const maxAttempts=await this.getMaxAttempts(),{request:request2}=args;if(HttpRequest.isInstance(request2))request2.headers[INVOCATION_ID_HEADER]=v4_default();for(;;)try{if(HttpRequest.isInstance(request2))request2.headers[REQUEST_HEADER]=`attempt=${attempts+1}; max=${maxAttempts}`;if(null==options?void 0:options.beforeRequest)await options.beforeRequest();const{response,output}=await next(args);if(null==options?void 0:options.afterRequest)options.afterRequest(response);this.retryQuota.releaseRetryTokens(retryTokenAmount);output.$metadata.attempts=attempts+1;output.$metadata.totalRetryDelay=totalDelay;return{response,output}}catch(e4){const err2=asSdkError(e4);attempts++;if(this.shouldRetry(err2,attempts,maxAttempts)){retryTokenAmount=this.retryQuota.retrieveRetryTokens(err2);const delayFromDecider=this.delayDecider(isThrottlingError(err2)?THROTTLING_RETRY_DELAY_BASE:DEFAULT_RETRY_DELAY_BASE,attempts),delayFromResponse=getDelayFromRetryAfterHeader(err2.$response),delay2=Math.max(delayFromResponse||0,delayFromDecider);totalDelay+=delay2;await new Promise((resolve=>setTimeout(resolve,delay2)));continue}if(!err2.$metadata)err2.$metadata={};err2.$metadata.attempts=attempts;err2.$metadata.totalRetryDelay=totalDelay;throw err2}}},getDelayFromRetryAfterHeader=response=>{if(!HttpResponse.isInstance(response))return;const retryAfterHeaderName=Object.keys(response.headers).find((key2=>"retry-after"===key2.toLowerCase()));if(!retryAfterHeaderName)return;const retryAfter=response.headers[retryAfterHeaderName],retryAfterSeconds=Number(retryAfter);if(!Number.isNaN(retryAfterSeconds))return 1e3*retryAfterSeconds;else return new Date(retryAfter).getTime()-Date.now()},AdaptiveRetryStrategy2=class extends StandardRetryStrategy2{constructor(maxAttemptsProvider,options){const{rateLimiter,...superOptions}=null!=options?options:{};super(maxAttemptsProvider,superOptions);this.rateLimiter=null!=rateLimiter?rateLimiter:new DefaultRateLimiter;this.mode=RETRY_MODES.ADAPTIVE}async retry(next,args){return super.retry(next,args,{beforeRequest:async()=>this.rateLimiter.getSendToken(),afterRequest:response=>{this.rateLimiter.updateClientSendingRate(response)}})}},ENV_MAX_ATTEMPTS="AWS_MAX_ATTEMPTS",CONFIG_MAX_ATTEMPTS="max_attempts",NODE_MAX_ATTEMPT_CONFIG_OPTIONS={environmentVariableSelector:env=>{const value=env[ENV_MAX_ATTEMPTS];if(!value)return;const maxAttempt=parseInt(value);if(Number.isNaN(maxAttempt))throw new Error(`Environment variable ${ENV_MAX_ATTEMPTS} mast be a number, got "${value}"`);return maxAttempt},configFileSelector:profile=>{const value=profile[CONFIG_MAX_ATTEMPTS];if(!value)return;const maxAttempt=parseInt(value);if(Number.isNaN(maxAttempt))throw new Error(`Shared config file entry ${CONFIG_MAX_ATTEMPTS} mast be a number, got "${value}"`);return maxAttempt},default:DEFAULT_MAX_ATTEMPTS},resolveRetryConfig=input=>{var _a5;const{retryStrategy}=input,maxAttempts=normalizeProvider(null!=(_a5=input.maxAttempts)?_a5:DEFAULT_MAX_ATTEMPTS);return{...input,maxAttempts,retryStrategy:async()=>{if(retryStrategy)return retryStrategy;if(await normalizeProvider(input.retryMode)()===RETRY_MODES.ADAPTIVE)return new AdaptiveRetryStrategy(maxAttempts);else return new StandardRetryStrategy(maxAttempts)}}},ENV_RETRY_MODE="AWS_RETRY_MODE",CONFIG_RETRY_MODE="retry_mode",NODE_RETRY_MODE_CONFIG_OPTIONS={environmentVariableSelector:env=>env[ENV_RETRY_MODE],configFileSelector:profile=>profile[CONFIG_RETRY_MODE],default:DEFAULT_RETRY_MODE},omitRetryHeadersMiddleware=()=>next=>async args=>{const{request:request2}=args;if(HttpRequest.isInstance(request2)){delete request2.headers[INVOCATION_ID_HEADER];delete request2.headers[REQUEST_HEADER]}return next(args)},omitRetryHeadersMiddlewareOptions={name:"omitRetryHeadersMiddleware",tags:["RETRY","HEADERS","OMIT_RETRY_HEADERS"],relation:"before",toMiddleware:"awsAuthMiddleware",override:true},getOmitRetryHeadersPlugin=options=>({applyToStack:clientStack=>{clientStack.addRelativeTo(omitRetryHeadersMiddleware(),omitRetryHeadersMiddlewareOptions)}}),isStreamingPayload=request2=>(null==request2?void 0:request2.body)instanceof ReadableStream,retryMiddleware=options=>(next,context2)=>async args=>{var _a5;let retryStrategy=await options.retryStrategy();const maxAttempts=await options.maxAttempts();if(isRetryStrategyV2(retryStrategy)){let retryToken=await retryStrategy.acquireInitialRetryToken(context2["partition_id"]),lastError=new Error,attempts=0,totalRetryDelay=0;const{request:request2}=args,isRequest=HttpRequest.isInstance(request2);if(isRequest)request2.headers[INVOCATION_ID_HEADER]=v4_default();for(;;)try{if(isRequest)request2.headers[REQUEST_HEADER]=`attempt=${attempts+1}; max=${maxAttempts}`;const{response,output}=await next(args);retryStrategy.recordSuccess(retryToken);output.$metadata.attempts=attempts+1;output.$metadata.totalRetryDelay=totalRetryDelay;return{response,output}}catch(e4){const retryErrorInfo=getRetryErrorInfo(e4);lastError=asSdkError(e4);if(isRequest&&isStreamingPayload(request2)){null==(_a5=context2.logger instanceof NoOpLogger?console:context2.logger)||_a5.warn("An error was encountered in a non-retryable streaming request.");throw lastError}try{retryToken=await retryStrategy.refreshRetryTokenForRetry(retryToken,retryErrorInfo)}catch(refreshError){if(!lastError.$metadata)lastError.$metadata={};lastError.$metadata.attempts=attempts+1;lastError.$metadata.totalRetryDelay=totalRetryDelay;throw lastError}attempts=retryToken.getRetryCount();const delay2=retryToken.getRetryDelay();totalRetryDelay+=delay2;await new Promise((resolve=>setTimeout(resolve,delay2)))}}else{if(null==retryStrategy?void 0:retryStrategy.mode)context2.userAgent=[...context2.userAgent||[],["cfg/retry-mode",retryStrategy.mode]];return retryStrategy.retry(next,args)}},isRetryStrategyV2=retryStrategy=>"undefined"!=typeof retryStrategy.acquireInitialRetryToken&&"undefined"!=typeof retryStrategy.refreshRetryTokenForRetry&&"undefined"!=typeof retryStrategy.recordSuccess,getRetryErrorInfo=error=>{const errorInfo={error,errorType:getRetryErrorType(error)},retryAfterHint=getRetryAfterHint(error.$response);if(retryAfterHint)errorInfo.retryAfterHint=retryAfterHint;return errorInfo},getRetryErrorType=error=>{if(isThrottlingError(error))return"THROTTLING";if(isTransientError(error))return"TRANSIENT";if(isServerError(error))return"SERVER_ERROR";else return"CLIENT_ERROR"},retryMiddlewareOptions={name:"retryMiddleware",tags:["RETRY"],step:"finalizeRequest",priority:"high",override:true},getRetryPlugin=options=>({applyToStack:clientStack=>{clientStack.add(retryMiddleware(options),retryMiddlewareOptions)}}),getRetryAfterHint=response=>{if(!HttpResponse.isInstance(response))return;const retryAfterHeaderName=Object.keys(response.headers).find((key2=>"retry-after"===key2.toLowerCase()));if(!retryAfterHeaderName)return;const retryAfter=response.headers[retryAfterHeaderName],retryAfterSeconds=Number(retryAfter);if(!Number.isNaN(retryAfterSeconds))return new Date(1e3*retryAfterSeconds);else return new Date(retryAfter)},httpSigningMiddlewareOptions={step:"finalizeRequest",tags:["HTTP_SIGNING"],name:"httpSigningMiddleware",aliases:["apiKeyMiddleware","tokenMiddleware","awsAuthMiddleware"],override:true,relation:"after",toMiddleware:retryMiddlewareOptions.name},getHttpSigningPlugin=config=>({applyToStack:clientStack=>{clientStack.addRelativeTo(httpSigningMiddleware(config),httpSigningMiddlewareOptions)}}),DefaultIdentityProviderConfig=class{constructor(config){this.authSchemes=new Map;for(const[key2,value]of Object.entries(config))if(void 0!==value)this.authSchemes.set(key2,value)}getIdentityProvider(schemeId){return this.authSchemes.get(schemeId)}},HttpApiKeyAuthSigner=class{async sign(httpRequest,identity2,signingProperties){if(!signingProperties)throw new Error("request could not be signed with `apiKey` since the `name` and `in` signer properties are missing");if(!signingProperties.name)throw new Error("request could not be signed with `apiKey` since the `name` signer property is missing");if(!signingProperties.in)throw new Error("request could not be signed with `apiKey` since the `in` signer property is missing");if(!identity2.apiKey)throw new Error("request could not be signed with `apiKey` since the `apiKey` is not defined");const clonedRequest=HttpRequest.clone(httpRequest);if(signingProperties.in===HttpApiKeyAuthLocation.QUERY)clonedRequest.query[signingProperties.name]=identity2.apiKey;else if(signingProperties.in===HttpApiKeyAuthLocation.HEADER)clonedRequest.headers[signingProperties.name]=signingProperties.scheme?`${signingProperties.scheme} ${identity2.apiKey}`:identity2.apiKey;else throw new Error("request can only be signed with `apiKey` locations `query` or `header`, but found: `"+signingProperties.in+"`");return clonedRequest}},HttpBearerAuthSigner=class{async sign(httpRequest,identity2,signingProperties){const clonedRequest=HttpRequest.clone(httpRequest);if(!identity2.token)throw new Error("request could not be signed with `token` since the `token` is not defined");clonedRequest.headers["Authorization"]=`Bearer ${identity2.token}`;return clonedRequest}},createIsIdentityExpiredFunction=expirationMs=>identity2=>doesIdentityRequireRefresh(identity2)&&identity2.expiration.getTime()-Date.now()<expirationMs,EXPIRATION_MS=3e5,isIdentityExpired=createIsIdentityExpiredFunction(EXPIRATION_MS),doesIdentityRequireRefresh=identity2=>void 0!==identity2.expiration,memoizeIdentityProvider=(provider,isExpired,requiresRefresh)=>{if(void 0===provider)return;const normalizedProvider="function"!=typeof provider?async()=>Promise.resolve(provider):provider;let resolved,pending,hasResult,isConstant=false;const coalesceProvider=async options=>{if(!pending)pending=normalizedProvider(options);try{resolved=await pending;hasResult=true;isConstant=false}finally{pending=void 0}return resolved};if(void 0===isExpired)return async options=>{if(!hasResult||(null==options?void 0:options.forceRefresh))resolved=await coalesceProvider(options);return resolved};else return async options=>{if(!hasResult||(null==options?void 0:options.forceRefresh))resolved=await coalesceProvider(options);if(isConstant)return resolved;if(!requiresRefresh(resolved)){isConstant=true;return resolved}if(isExpired(resolved)){await coalesceProvider(options);return resolved}return resolved}},getSmithyContext2=context2=>context2[SMITHY_CONTEXT_KEY]||(context2[SMITHY_CONTEXT_KEY]={}),normalizeProvider2=input=>{if("function"==typeof input)return input;const promisified=Promise.resolve(input);return()=>promisified};function requestBuilder(input,context2){return new RequestBuilder(input,context2)}var RequestBuilder=class{constructor(input,context2){this.input=input;this.context=context2;this.query={};this.method="";this.headers={};this.path="";this.body=null;this.hostname="";this.resolvePathStack=[]}async build(){const{hostname,protocol="https",port,path:basePath}=await this.context.endpoint();this.path=basePath;for(const resolvePath of this.resolvePathStack)resolvePath(this.path);return new HttpRequest({protocol,hostname:this.hostname||hostname,port,method:this.method,path:this.path,query:this.query,body:this.body,headers:this.headers})}hn(hostname){this.hostname=hostname;return this}bp(uriLabel){this.resolvePathStack.push((basePath=>{this.path=`${(null==basePath?void 0:basePath.endsWith("/"))?basePath.slice(0,-1):basePath||""}`+uriLabel}));return this}p(memberName,labelValueProvider,uriLabel,isGreedyLabel){this.resolvePathStack.push((path2=>{this.path=resolvedPath(path2,this.input,memberName,labelValueProvider,uriLabel,isGreedyLabel)}));return this}h(headers){this.headers=headers;return this}q(query3){this.query=query3;return this}b(body){this.body=body;return this}m(method){this.method=method;return this}},signS3Express=async(s3ExpressIdentity,signingOptions,request2,sigV4MultiRegionSigner)=>{const signedRequest=await sigV4MultiRegionSigner.signWithCredentials(request2,s3ExpressIdentity,{});if(signedRequest.headers["X-Amz-Security-Token"]||signedRequest.headers["x-amz-security-token"])throw new Error("X-Amz-Security-Token must not be set for s3-express requests.");return signedRequest},defaultErrorHandler2=signingProperties=>error=>{throw error},defaultSuccessHandler2=(httpResponse,signingProperties)=>{},s3ExpressHttpSigningMiddlewareOptions=httpSigningMiddlewareOptions,s3ExpressHttpSigningMiddleware=config=>(next,context2)=>async args=>{if(!HttpRequest.isInstance(args.request))return next(args);const scheme=getSmithyContext(context2).selectedHttpAuthScheme;if(!scheme)throw new Error("No HttpAuthScheme was selected: unable to sign request");const{httpAuthOption:{signingProperties={}},identity:identity2,signer}=scheme;let request2;if(context2.s3ExpressIdentity)request2=await signS3Express(context2.s3ExpressIdentity,signingProperties,args.request,await config.signer());else request2=await signer.sign(args.request,identity2,signingProperties);const output=await next({...args,request:request2}).catch((signer.errorHandler||defaultErrorHandler2)(signingProperties));(signer.successHandler||defaultSuccessHandler2)(output.response,signingProperties);return output},getS3ExpressHttpSigningPlugin=config=>({applyToStack:clientStack=>{clientStack.addRelativeTo(s3ExpressHttpSigningMiddleware(config),httpSigningMiddlewareOptions)}}),resolveS3Config=(input,{session})=>{var _a5,_b2,_c2,_d2,_e2,_f;const[s3ClientProvider,CreateSessionCommandCtor]=session;return{...input,forcePathStyle:null!=(_a5=input.forcePathStyle)?_a5:false,useAccelerateEndpoint:null!=(_b2=input.useAccelerateEndpoint)?_b2:false,disableMultiregionAccessPoints:null!=(_c2=input.disableMultiregionAccessPoints)?_c2:false,followRegionRedirects:null!=(_d2=input.followRegionRedirects)?_d2:false,s3ExpressIdentityProvider:null!=(_e2=input.s3ExpressIdentityProvider)?_e2:new S3ExpressIdentityProviderImpl((async key2=>s3ClientProvider().send(new CreateSessionCommandCtor({Bucket:key2,SessionMode:"ReadWrite"})))),bucketEndpoint:null!=(_f=input.bucketEndpoint)?_f:false}},THROW_IF_EMPTY_BODY={CopyObjectCommand:true,UploadPartCopyCommand:true,CompleteMultipartUploadCommand:true},MAX_BYTES_TO_INSPECT=3e3,throw200ExceptionsMiddleware=config=>(next,context2)=>async args=>{const result=await next(args),{response}=result;if(!HttpResponse.isInstance(response))return result;const{statusCode,body:sourceBody}=response;if(statusCode<200||statusCode>=300)return result;if(!("function"==typeof(null==sourceBody?void 0:sourceBody.stream)||"function"==typeof(null==sourceBody?void 0:sourceBody.pipe)||"function"==typeof(null==sourceBody?void 0:sourceBody.tee)))return result;let bodyCopy=sourceBody,body=sourceBody;if(sourceBody&&"object"==typeof sourceBody&&!(sourceBody instanceof Uint8Array))[bodyCopy,body]=await splitStream(sourceBody);response.body=body;const bodyBytes=await collectBody2(bodyCopy,{streamCollector:async stream=>headStream(stream,MAX_BYTES_TO_INSPECT)});if("function"==typeof(null==bodyCopy?void 0:bodyCopy.destroy))bodyCopy.destroy();const bodyStringTail=config.utf8Encoder(bodyBytes.subarray(bodyBytes.length-16));if(0===bodyBytes.length&&THROW_IF_EMPTY_BODY[context2.commandName]){const err2=new Error("S3 aborted request");err2.name="InternalError";throw err2}if(bodyStringTail&&bodyStringTail.endsWith("</Error>"))response.statusCode=400;return result},collectBody2=(streamBody=new Uint8Array,context2)=>{if(streamBody instanceof Uint8Array)return Promise.resolve(streamBody);else return context2.streamCollector(streamBody)||Promise.resolve(new Uint8Array)},throw200ExceptionsMiddlewareOptions={relation:"after",toMiddleware:"deserializerMiddleware",tags:["THROW_200_EXCEPTIONS","S3"],name:"throw200ExceptionsMiddleware",override:true},getThrow200ExceptionsPlugin=config=>({applyToStack:clientStack=>{clientStack.addRelativeTo(throw200ExceptionsMiddleware(config),throw200ExceptionsMiddlewareOptions)}}),validate2=str=>"string"==typeof str&&0===str.indexOf("arn:")&&str.split(":").length>=6,parse=arn=>{const segments=arn.split(":");if(segments.length<6||"arn"!==segments[0])throw new Error("Malformed ARN");const[,partition2,service,region,accountId,...resource]=segments;return{partition:partition2,service,region,accountId,resource:resource.join(":")}},build=arnObject=>{const{partition:partition2="aws",service,region,accountId,resource}=arnObject;if([service,region,accountId,resource].some((segment=>"string"!=typeof segment)))throw new Error("Input ARN object is invalid");return`arn:${partition2}:${service}:${region}:${accountId}:${resource}`};function bucketEndpointMiddleware(options){return(next,context2)=>async args=>{var _a5,_b2,_c2,_d2;if(options.bucketEndpoint){const endpoint=context2.endpointV2;if(endpoint){const bucket=args.input.Bucket;if("string"==typeof bucket)try{const bucketEndpointUrl=new URL(bucket);endpoint.url=bucketEndpointUrl}catch(e4){const warning=`@aws-sdk/middleware-sdk-s3: bucketEndpoint=true was set but Bucket=${bucket} could not be parsed as URL.`;if("NoOpLogger"===(null==(_b2=null==(_a5=context2.logger)?void 0:_a5.constructor)?void 0:_b2.name))console.warn(warning);else null==(_d2=null==(_c2=context2.logger)?void 0:_c2.warn)||_d2.call(_c2,warning);throw e4}}}return next(args)}}var bucketEndpointMiddlewareOptions={name:"bucketEndpointMiddleware",override:true,relation:"after",toMiddleware:"endpointV2Middleware"};function validateBucketNameMiddleware({bucketEndpoint}){return next=>async args=>{const{input:{Bucket}}=args;if(!bucketEndpoint&&"string"==typeof Bucket&&!validate2(Bucket)&&Bucket.indexOf("/")>=0){const err2=new Error(`Bucket name shouldn't contain '/', received '${Bucket}'`);err2.name="InvalidBucketName";throw err2}return next({...args})}}var validateBucketNameMiddlewareOptions={step:"initialize",tags:["VALIDATE_BUCKET_NAME"],name:"validateBucketNameMiddleware",override:true},getValidateBucketNamePlugin=options=>({applyToStack:clientStack=>{clientStack.add(validateBucketNameMiddleware(options),validateBucketNameMiddlewareOptions);clientStack.addRelativeTo(bucketEndpointMiddleware(options),bucketEndpointMiddlewareOptions)}});function resolveUserAgentConfig(input){return{...input,customUserAgent:"string"==typeof input.customUserAgent?[[input.customUserAgent]]:input.customUserAgent}}var IP_V4_REGEX=new RegExp("^(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}$"),isIpAddress=value=>IP_V4_REGEX.test(value)||value.startsWith("[")&&value.endsWith("]"),VALID_HOST_LABEL_REGEX=new RegExp("^(?!.*-$)(?!-)[a-zA-Z0-9-]{1,63}$"),isValidHostLabel=(value,allowSubDomains=false)=>{if(!allowSubDomains)return VALID_HOST_LABEL_REGEX.test(value);const labels=value.split(".");for(const label of labels)if(!isValidHostLabel(label))return false;return true},customEndpointFunctions={},debugId="endpoints";function toDebugString(input){if("object"!=typeof input||null==input)return input;if("ref"in input)return`$${toDebugString(input.ref)}`;if("fn"in input)return`${input.fn}(${(input.argv||[]).map(toDebugString).join(", ")})`;else return JSON.stringify(input,null,2)}var EndpointError=class extends Error{constructor(message){super(message);this.name="EndpointError"}},booleanEquals=(value1,value2)=>value1===value2,getAttrPathList=path2=>{const parts=path2.split("."),pathList=[];for(const part of parts){const squareBracketIndex=part.indexOf("[");if(-1!==squareBracketIndex){if(part.indexOf("]")!==part.length-1)throw new EndpointError(`Path: '${path2}' does not end with ']'`);const arrayIndex=part.slice(squareBracketIndex+1,-1);if(Number.isNaN(parseInt(arrayIndex)))throw new EndpointError(`Invalid array index: '${arrayIndex}' in path: '${path2}'`);if(0!==squareBracketIndex)pathList.push(part.slice(0,squareBracketIndex));pathList.push(arrayIndex)}else pathList.push(part)}return pathList},getAttr=(value,path2)=>getAttrPathList(path2).reduce(((acc,index5)=>{if("object"!=typeof acc)throw new EndpointError(`Index '${index5}' in '${path2}' not found in '${JSON.stringify(value)}'`);else if(Array.isArray(acc))return acc[parseInt(index5)];return acc[index5]}),value),isSet=value=>null!=value,not=value=>!value,DEFAULT_PORTS={[EndpointURLScheme.HTTP]:80,[EndpointURLScheme.HTTPS]:443},parseURL=value=>{const whatwgURL=(()=>{try{if(value instanceof URL)return value;if("object"==typeof value&&"hostname"in value){const{hostname:hostname2,port,protocol:protocol2="",path:path2="",query:query3={}}=value,url=new URL(`${protocol2}//${hostname2}${port?`:${port}`:""}${path2}`);url.search=Object.entries(query3).map((([k2,v2])=>`${k2}=${v2}`)).join("&");return url}return new URL(value)}catch(error){return null}})();if(!whatwgURL){console.error(`Unable to parse ${JSON.stringify(value)} as a whatwg URL.`);return null}const urlString=whatwgURL.href,{host,hostname,pathname,protocol,search}=whatwgURL;if(search)return null;const scheme=protocol.slice(0,-1);if(!Object.values(EndpointURLScheme).includes(scheme))return null;const isIp=isIpAddress(hostname);return{scheme,authority:`${host}${urlString.includes(`${host}:${DEFAULT_PORTS[scheme]}`)||"string"==typeof value&&value.includes(`${host}:${DEFAULT_PORTS[scheme]}`)?`:${DEFAULT_PORTS[scheme]}`:""}`,path:pathname,normalizedPath:pathname.endsWith("/")?pathname:`${pathname}/`,isIp}},stringEquals=(value1,value2)=>value1===value2,substring=(input,start,stop,reverse)=>{if(start>=stop||input.length<stop)return null;if(!reverse)return input.substring(start,stop);else return input.substring(input.length-stop,input.length-start)},uriEncode=value=>encodeURIComponent(value).replace(/[!*'()]/g,(c2=>`%${c2.charCodeAt(0).toString(16).toUpperCase()}`)),endpointFunctions={booleanEquals,getAttr,isSet,isValidHostLabel,not,parseURL,stringEquals,substring,uriEncode},evaluateTemplate=(template,options)=>{const evaluatedTemplateArr=[],templateContext={...options.endpointParams,...options.referenceRecord};let currentIndex=0;for(;currentIndex<template.length;){const openingBraceIndex=template.indexOf("{",currentIndex);if(-1===openingBraceIndex){evaluatedTemplateArr.push(template.slice(currentIndex));break}evaluatedTemplateArr.push(template.slice(currentIndex,openingBraceIndex));const closingBraceIndex=template.indexOf("}",openingBraceIndex);if(-1===closingBraceIndex){evaluatedTemplateArr.push(template.slice(openingBraceIndex));break}if("{"===template[openingBraceIndex+1]&&"}"===template[closingBraceIndex+1]){evaluatedTemplateArr.push(template.slice(openingBraceIndex+1,closingBraceIndex));currentIndex=closingBraceIndex+2}const parameterName=template.substring(openingBraceIndex+1,closingBraceIndex);if(parameterName.includes("#")){const[refName,attrName]=parameterName.split("#");evaluatedTemplateArr.push(getAttr(templateContext[refName],attrName))}else evaluatedTemplateArr.push(templateContext[parameterName]);currentIndex=closingBraceIndex+1}return evaluatedTemplateArr.join("")},getReferenceValue=({ref},options)=>({...options.endpointParams,...options.referenceRecord}[ref]),evaluateExpression=(obj,keyName,options)=>{if("string"==typeof obj)return evaluateTemplate(obj,options);else if(obj["fn"])return callFunction(obj,options);else if(obj["ref"])return getReferenceValue(obj,options);throw new EndpointError(`'${keyName}': ${String(obj)} is not a string, function or reference.`)},callFunction=({fn,argv},options)=>{const evaluatedArgs=argv.map((arg=>["boolean","number"].includes(typeof arg)?arg:evaluateExpression(arg,"arg",options))),fnSegments=fn.split(".");if(fnSegments[0]in customEndpointFunctions&&null!=fnSegments[1])return customEndpointFunctions[fnSegments[0]][fnSegments[1]](...evaluatedArgs);else return endpointFunctions[fn](...evaluatedArgs)},evaluateCondition=({assign:assign2,...fnArgs},options)=>{var _a5,_b2;if(assign2&&assign2 in options.referenceRecord)throw new EndpointError(`'${assign2}' is already defined in Reference Record.`);const value=callFunction(fnArgs,options);null==(_b2=null==(_a5=options.logger)?void 0:_a5.debug)||_b2.call(_a5,`${debugId} evaluateCondition: ${toDebugString(fnArgs)} = ${toDebugString(value)}`);return{result:""===value?true:!!value,...null!=assign2&&{toAssign:{name:assign2,value}}}},evaluateConditions=(conditions=[],options)=>{var _a5,_b2;const conditionsReferenceRecord={};for(const condition of conditions){const{result,toAssign}=evaluateCondition(condition,{...options,referenceRecord:{...options.referenceRecord,...conditionsReferenceRecord}});if(!result)return{result};if(toAssign){conditionsReferenceRecord[toAssign.name]=toAssign.value;null==(_b2=null==(_a5=options.logger)?void 0:_a5.debug)||_b2.call(_a5,`${debugId} assign: ${toAssign.name} := ${toDebugString(toAssign.value)}`)}}return{result:true,referenceRecord:conditionsReferenceRecord}},getEndpointHeaders=(headers,options)=>Object.entries(headers).reduce(((acc,[headerKey,headerVal])=>({...acc,[headerKey]:headerVal.map((headerValEntry=>{const processedExpr=evaluateExpression(headerValEntry,"Header value entry",options);if("string"!=typeof processedExpr)throw new EndpointError(`Header '${headerKey}' value '${processedExpr}' is not a string`);return processedExpr}))})),{}),getEndpointProperty=(property,options)=>{if(Array.isArray(property))return property.map((propertyEntry=>getEndpointProperty(propertyEntry,options)));switch(typeof property){case"string":return evaluateTemplate(property,options);case"object":if(null===property)throw new EndpointError(`Unexpected endpoint property: ${property}`);return getEndpointProperties(property,options);case"boolean":return property;default:throw new EndpointError("Unexpected endpoint property type: "+typeof property)}},getEndpointProperties=(properties,options)=>Object.entries(properties).reduce(((acc,[propertyKey,propertyVal])=>({...acc,[propertyKey]:getEndpointProperty(propertyVal,options)})),{}),getEndpointUrl=(endpointUrl,options)=>{const expression=evaluateExpression(endpointUrl,"Endpoint URL",options);if("string"==typeof expression)try{return new URL(expression)}catch(error){console.error(`Failed to construct URL with ${expression}`,error);throw error}throw new EndpointError("Endpoint URL must be a string, got "+typeof expression)},evaluateEndpointRule=(endpointRule,options)=>{var _a5,_b2;const{conditions,endpoint}=endpointRule,{result,referenceRecord}=evaluateConditions(conditions,options);if(!result)return;const endpointRuleOptions={...options,referenceRecord:{...options.referenceRecord,...referenceRecord}},{url,properties,headers}=endpoint;null==(_b2=null==(_a5=options.logger)?void 0:_a5.debug)||_b2.call(_a5,`${debugId} Resolving endpoint from template: ${toDebugString(endpoint)}`);return{...null!=headers&&{headers:getEndpointHeaders(headers,endpointRuleOptions)},...null!=properties&&{properties:getEndpointProperties(properties,endpointRuleOptions)},url:getEndpointUrl(url,endpointRuleOptions)}},evaluateErrorRule=(errorRule,options)=>{const{conditions,error}=errorRule,{result,referenceRecord}=evaluateConditions(conditions,options);if(result)throw new EndpointError(evaluateExpression(error,"Error",{...options,referenceRecord:{...options.referenceRecord,...referenceRecord}}))},evaluateTreeRule=(treeRule,options)=>{const{conditions,rules}=treeRule,{result,referenceRecord}=evaluateConditions(conditions,options);if(result)return evaluateRules(rules,{...options,referenceRecord:{...options.referenceRecord,...referenceRecord}})},evaluateRules=(rules,options)=>{for(const rule of rules)if("endpoint"===rule.type){const endpointOrUndefined=evaluateEndpointRule(rule,options);if(endpointOrUndefined)return endpointOrUndefined}else if("error"===rule.type)evaluateErrorRule(rule,options);else if("tree"===rule.type){const endpointOrUndefined=evaluateTreeRule(rule,options);if(endpointOrUndefined)return endpointOrUndefined}else throw new EndpointError(`Unknown endpoint rule: ${rule}`);throw new EndpointError("Rules evaluation failed")},resolveEndpoint=(ruleSetObject,options)=>{var _a5,_b2,_c2,_d2,_e2,_f;const{endpointParams,logger:logger2}=options,{parameters,rules}=ruleSetObject;null==(_b2=null==(_a5=options.logger)?void 0:_a5.debug)||_b2.call(_a5,`${debugId} Initial EndpointParams: ${toDebugString(endpointParams)}`);const paramsWithDefault=Object.entries(parameters).filter((([,v2])=>null!=v2.default)).map((([k2,v2])=>[k2,v2.default]));if(paramsWithDefault.length>0)for(const[paramKey,paramDefaultValue]of paramsWithDefault)endpointParams[paramKey]=null!=(_c2=endpointParams[paramKey])?_c2:paramDefaultValue;const requiredParams=Object.entries(parameters).filter((([,v2])=>v2.required)).map((([k2])=>k2));for(const requiredParam of requiredParams)if(null==endpointParams[requiredParam])throw new EndpointError(`Missing required parameter: '${requiredParam}'`);const endpoint=evaluateRules(rules,{endpointParams,logger:logger2,referenceRecord:{}});if(null==(_d2=options.endpointParams)?void 0:_d2.Endpoint)try{const givenEndpoint=new URL(options.endpointParams.Endpoint),{protocol,port}=givenEndpoint;endpoint.url.protocol=protocol;endpoint.url.port=port}catch(e4){}null==(_f=null==(_e2=options.logger)?void 0:_e2.debug)||_f.call(_e2,`${debugId} Resolved endpoint: ${toDebugString(endpoint)}`);return endpoint},isVirtualHostableS3Bucket=(value,allowSubDomains=false)=>{if(allowSubDomains){for(const label of value.split("."))if(!isVirtualHostableS3Bucket(label))return false;return true}if(!isValidHostLabel(value))return false;if(value.length<3||value.length>63)return false;if(value!==value.toLowerCase())return false;if(isIpAddress(value))return false;else return true},ARN_DELIMITER=":",RESOURCE_DELIMITER="/",parseArn=value=>{const segments=value.split(ARN_DELIMITER);if(segments.length<6)return null;const[arn,partition2,service,region,accountId,...resourcePath]=segments;if("arn"!==arn||""===partition2||""===service||""===resourcePath.join(ARN_DELIMITER))return null;else return{partition:partition2,service,region,accountId,resourceId:resourcePath.map((resource=>resource.split(RESOURCE_DELIMITER))).flat()}},partitions_default={partitions:[{id:"aws",outputs:{dnsSuffix:"amazonaws.com",dualStackDnsSuffix:"api.aws",implicitGlobalRegion:"us-east-1",name:"aws",supportsDualStack:true,supportsFIPS:true},regionRegex:"^(us|eu|ap|sa|ca|me|af|il|mx)\\-\\w+\\-\\d+$",regions:{"af-south-1":{description:"Africa (Cape Town)"},"ap-east-1":{description:"Asia Pacific (Hong Kong)"},"ap-northeast-1":{description:"Asia Pacific (Tokyo)"},"ap-northeast-2":{description:"Asia Pacific (Seoul)"},"ap-northeast-3":{description:"Asia Pacific (Osaka)"},"ap-south-1":{description:"Asia Pacific (Mumbai)"},"ap-south-2":{description:"Asia Pacific (Hyderabad)"},"ap-southeast-1":{description:"Asia Pacific (Singapore)"},"ap-southeast-2":{description:"Asia Pacific (Sydney)"},"ap-southeast-3":{description:"Asia Pacific (Jakarta)"},"ap-southeast-4":{description:"Asia Pacific (Melbourne)"},"ap-southeast-5":{description:"Asia Pacific (Malaysia)"},"aws-global":{description:"AWS Standard global region"},"ca-central-1":{description:"Canada (Central)"},"ca-west-1":{description:"Canada West (Calgary)"},"eu-central-1":{description:"Europe (Frankfurt)"},"eu-central-2":{description:"Europe (Zurich)"},"eu-north-1":{description:"Europe (Stockholm)"},"eu-south-1":{description:"Europe (Milan)"},"eu-south-2":{description:"Europe (Spain)"},"eu-west-1":{description:"Europe (Ireland)"},"eu-west-2":{description:"Europe (London)"},"eu-west-3":{description:"Europe (Paris)"},"il-central-1":{description:"Israel (Tel Aviv)"},"me-central-1":{description:"Middle East (UAE)"},"me-south-1":{description:"Middle East (Bahrain)"},"sa-east-1":{description:"South America (Sao Paulo)"},"us-east-1":{description:"US East (N. Virginia)"},"us-east-2":{description:"US East (Ohio)"},"us-west-1":{description:"US West (N. California)"},"us-west-2":{description:"US West (Oregon)"}}},{id:"aws-cn",outputs:{dnsSuffix:"amazonaws.com.cn",dualStackDnsSuffix:"api.amazonwebservices.com.cn",implicitGlobalRegion:"cn-northwest-1",name:"aws-cn",supportsDualStack:true,supportsFIPS:true},regionRegex:"^cn\\-\\w+\\-\\d+$",regions:{"aws-cn-global":{description:"AWS China global region"},"cn-north-1":{description:"China (Beijing)"},"cn-northwest-1":{description:"China (Ningxia)"}}},{id:"aws-us-gov",outputs:{dnsSuffix:"amazonaws.com",dualStackDnsSuffix:"api.aws",implicitGlobalRegion:"us-gov-west-1",name:"aws-us-gov",supportsDualStack:true,supportsFIPS:true},regionRegex:"^us\\-gov\\-\\w+\\-\\d+$",regions:{"aws-us-gov-global":{description:"AWS GovCloud (US) global region"},"us-gov-east-1":{description:"AWS GovCloud (US-East)"},"us-gov-west-1":{description:"AWS GovCloud (US-West)"}}},{id:"aws-iso",outputs:{dnsSuffix:"c2s.ic.gov",dualStackDnsSuffix:"c2s.ic.gov",implicitGlobalRegion:"us-iso-east-1",name:"aws-iso",supportsDualStack:false,supportsFIPS:true},regionRegex:"^us\\-iso\\-\\w+\\-\\d+$",regions:{"aws-iso-global":{description:"AWS ISO (US) global region"},"us-iso-east-1":{description:"US ISO East"},"us-iso-west-1":{description:"US ISO WEST"}}},{id:"aws-iso-b",outputs:{dnsSuffix:"sc2s.sgov.gov",dualStackDnsSuffix:"sc2s.sgov.gov",implicitGlobalRegion:"us-isob-east-1",name:"aws-iso-b",supportsDualStack:false,supportsFIPS:true},regionRegex:"^us\\-isob\\-\\w+\\-\\d+$",regions:{"aws-iso-b-global":{description:"AWS ISOB (US) global region"},"us-isob-east-1":{description:"US ISOB East (Ohio)"}}},{id:"aws-iso-e",outputs:{dnsSuffix:"cloud.adc-e.uk",dualStackDnsSuffix:"cloud.adc-e.uk",implicitGlobalRegion:"eu-isoe-west-1",name:"aws-iso-e",supportsDualStack:false,supportsFIPS:true},regionRegex:"^eu\\-isoe\\-\\w+\\-\\d+$",regions:{"eu-isoe-west-1":{description:"EU ISOE West"}}},{id:"aws-iso-f",outputs:{dnsSuffix:"csp.hci.ic.gov",dualStackDnsSuffix:"csp.hci.ic.gov",implicitGlobalRegion:"us-isof-south-1",name:"aws-iso-f",supportsDualStack:false,supportsFIPS:true},regionRegex:"^us\\-isof\\-\\w+\\-\\d+$",regions:{}}],version:"1.1"},selectedPartitionsInfo=partitions_default,selectedUserAgentPrefix="",partition=value=>{const{partitions}=selectedPartitionsInfo;for(const partition2 of partitions){const{regions,outputs}=partition2;for(const[region,regionData]of Object.entries(regions))if(region===value)return{...outputs,...regionData}}for(const partition2 of partitions){const{regionRegex,outputs}=partition2;if(new RegExp(regionRegex).test(value))return{...outputs}}const DEFAULT_PARTITION=partitions.find((partition2=>"aws"===partition2.id));if(!DEFAULT_PARTITION)throw new Error("Provided region was not found in the partition array or regex, and default partition with id 'aws' doesn't exist.");return{...DEFAULT_PARTITION.outputs}},setPartitionInfo=(partitionsInfo,userAgentPrefix="")=>{selectedPartitionsInfo=partitionsInfo;selectedUserAgentPrefix=userAgentPrefix},useDefaultPartitionInfo=()=>{setPartitionInfo(partitions_default,"")},getUserAgentPrefix=()=>selectedUserAgentPrefix,awsEndpointFunctions={isVirtualHostableS3Bucket,parseArn,partition};customEndpointFunctions.aws=awsEndpointFunctions;var USER_AGENT="user-agent",X_AMZ_USER_AGENT="x-amz-user-agent",SPACE=" ",UA_NAME_SEPARATOR="/",UA_NAME_ESCAPE_REGEX=/[^\!\$\%\&\'\*\+\-\.\^\_\`\|\~\d\w]/g,UA_VALUE_ESCAPE_REGEX=/[^\!\$\%\&\'\*\+\-\.\^\_\`\|\~\d\w\#]/g,UA_ESCAPE_CHAR="-",userAgentMiddleware=options=>(next,context2)=>async args=>{var _a5,_b2;const{request:request2}=args;if(!HttpRequest.isInstance(request2))return next(args);const{headers}=request2,userAgent=(null==(_a5=null==context2?void 0:context2.userAgent)?void 0:_a5.map(escapeUserAgent))||[],defaultUserAgent2=(await options.defaultUserAgentProvider()).map(escapeUserAgent),customUserAgent=(null==(_b2=null==options?void 0:options.customUserAgent)?void 0:_b2.map(escapeUserAgent))||[],prefix=getUserAgentPrefix(),sdkUserAgentValue=(prefix?[prefix]:[]).concat([...defaultUserAgent2,...userAgent,...customUserAgent]).join(SPACE),normalUAValue=[...defaultUserAgent2.filter((section=>section.startsWith("aws-sdk-"))),...customUserAgent].join(SPACE);if("browser"!==options.runtime){if(normalUAValue)headers[X_AMZ_USER_AGENT]=headers[X_AMZ_USER_AGENT]?`${headers[USER_AGENT]} ${normalUAValue}`:normalUAValue;headers[USER_AGENT]=sdkUserAgentValue}else headers[X_AMZ_USER_AGENT]=sdkUserAgentValue;return next({...args,request:request2})},escapeUserAgent=userAgentPair=>{var _a5;const name=userAgentPair[0].split(UA_NAME_SEPARATOR).map((part=>part.replace(UA_NAME_ESCAPE_REGEX,UA_ESCAPE_CHAR))).join(UA_NAME_SEPARATOR),version2=null==(_a5=userAgentPair[1])?void 0:_a5.replace(UA_VALUE_ESCAPE_REGEX,UA_ESCAPE_CHAR),prefixSeparatorIndex=name.indexOf(UA_NAME_SEPARATOR),prefix=name.substring(0,prefixSeparatorIndex);let uaName=name.substring(prefixSeparatorIndex+1);if("api"===prefix)uaName=uaName.toLowerCase();return[prefix,uaName,version2].filter((item=>item&&item.length>0)).reduce(((acc,item,index5)=>{switch(index5){case 0:return item;case 1:return`${acc}/${item}`;default:return`${acc}#${item}`}}),"")},getUserAgentMiddlewareOptions={name:"getUserAgentMiddleware",step:"build",priority:"low",tags:["SET_USER_AGENT","USER_AGENT"],override:true},getUserAgentPlugin=config=>({applyToStack:clientStack=>{clientStack.add(userAgentMiddleware(config),getUserAgentMiddlewareOptions)}}),ENV_USE_DUALSTACK_ENDPOINT="AWS_USE_DUALSTACK_ENDPOINT",CONFIG_USE_DUALSTACK_ENDPOINT="use_dualstack_endpoint",DEFAULT_USE_DUALSTACK_ENDPOINT=false,NODE_USE_DUALSTACK_ENDPOINT_CONFIG_OPTIONS={environmentVariableSelector:env=>booleanSelector(env,ENV_USE_DUALSTACK_ENDPOINT,SelectorType.ENV),configFileSelector:profile=>booleanSelector(profile,CONFIG_USE_DUALSTACK_ENDPOINT,SelectorType.CONFIG),default:false},ENV_USE_FIPS_ENDPOINT="AWS_USE_FIPS_ENDPOINT",CONFIG_USE_FIPS_ENDPOINT="use_fips_endpoint",DEFAULT_USE_FIPS_ENDPOINT=false,NODE_USE_FIPS_ENDPOINT_CONFIG_OPTIONS={environmentVariableSelector:env=>booleanSelector(env,ENV_USE_FIPS_ENDPOINT,SelectorType.ENV),configFileSelector:profile=>booleanSelector(profile,CONFIG_USE_FIPS_ENDPOINT,SelectorType.CONFIG),default:false},resolveCustomEndpointsConfig=input=>{var _a5,_b2;const{endpoint,urlParser}=input;return{...input,tls:null!=(_a5=input.tls)?_a5:true,endpoint:normalizeProvider("string"==typeof endpoint?urlParser(endpoint):endpoint),isCustomEndpoint:true,useDualstackEndpoint:normalizeProvider(null!=(_b2=input.useDualstackEndpoint)?_b2:false)}},getEndpointFromRegion=async input=>{var _a5;const{tls=true}=input,region=await input.region();if(!new RegExp(/^([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9])$/).test(region))throw new Error("Invalid region in client config");const useDualstackEndpoint=await input.useDualstackEndpoint(),useFipsEndpoint=await input.useFipsEndpoint(),{hostname}=null!=(_a5=await input.regionInfoProvider(region,{useDualstackEndpoint,useFipsEndpoint}))?_a5:{};if(!hostname)throw new Error("Cannot resolve hostname from client config");return input.urlParser(`${tls?"https:":"http:"}//${hostname}`)},resolveEndpointsConfig=input=>{var _a5,_b2;const useDualstackEndpoint=normalizeProvider(null!=(_a5=input.useDualstackEndpoint)?_a5:false),{endpoint,useFipsEndpoint,urlParser}=input;return{...input,tls:null!=(_b2=input.tls)?_b2:true,endpoint:endpoint?normalizeProvider("string"==typeof endpoint?urlParser(endpoint):endpoint):()=>getEndpointFromRegion({...input,useDualstackEndpoint,useFipsEndpoint}),isCustomEndpoint:!!endpoint,useDualstackEndpoint}},isFipsRegion=region=>"string"==typeof region&&(region.startsWith("fips-")||region.endsWith("-fips")),getRealRegion=region=>isFipsRegion(region)?["fips-aws-global","aws-fips"].includes(region)?"us-east-1":region.replace(/fips-(dkr-|prod-)?|-fips/,""):region,resolveRegionConfig=input=>{const{region,useFipsEndpoint}=input;if(!region)throw new Error("Region is missing");return{...input,region:async()=>{if("string"==typeof region)return getRealRegion(region);const providedRegion=await region();return getRealRegion(providedRegion)},useFipsEndpoint:async()=>{const providedRegion="string"==typeof region?region:await region();if(isFipsRegion(providedRegion))return true;else return"function"!=typeof useFipsEndpoint?Promise.resolve(!!useFipsEndpoint):useFipsEndpoint()}}},getHostnameFromVariants=(variants=[],{useFipsEndpoint,useDualstackEndpoint})=>{var _a5;return null==(_a5=variants.find((({tags})=>useFipsEndpoint===tags.includes("fips")&&useDualstackEndpoint===tags.includes("dualstack"))))?void 0:_a5.hostname},getResolvedHostname=(resolvedRegion,{regionHostname,partitionHostname})=>regionHostname?regionHostname:partitionHostname?partitionHostname.replace("{region}",resolvedRegion):void 0,getResolvedPartition=(region,{partitionHash})=>{var _a5;return null!=(_a5=Object.keys(partitionHash||{}).find((key2=>partitionHash[key2].regions.includes(region))))?_a5:"aws"},getResolvedSigningRegion=(hostname,{signingRegion,regionRegex,useFipsEndpoint})=>{if(signingRegion)return signingRegion;else if(useFipsEndpoint){const regionRegexJs=regionRegex.replace("\\\\","\\").replace(/^\^/g,"\\.").replace(/\$$/g,"\\."),regionRegexmatchArray=hostname.match(regionRegexJs);if(regionRegexmatchArray)return regionRegexmatchArray[0].slice(1,-1)}},getRegionInfo=(region,{useFipsEndpoint=false,useDualstackEndpoint=false,signingService,regionHash,partitionHash})=>{var _a5,_b2,_c2,_d2,_e2,_f;const partition2=getResolvedPartition(region,{partitionHash}),resolvedRegion=region in regionHash?region:null!=(_b2=null==(_a5=partitionHash[partition2])?void 0:_a5.endpoint)?_b2:region,hostnameOptions={useFipsEndpoint,useDualstackEndpoint},regionHostname=getHostnameFromVariants(null==(_c2=regionHash[resolvedRegion])?void 0:_c2.variants,hostnameOptions),partitionHostname=getHostnameFromVariants(null==(_d2=partitionHash[partition2])?void 0:_d2.variants,hostnameOptions),hostname=getResolvedHostname(resolvedRegion,{regionHostname,partitionHostname});if(void 0===hostname)throw new Error(`Endpoint resolution failed for: ${{resolvedRegion,useFipsEndpoint,useDualstackEndpoint}}`);const signingRegion=getResolvedSigningRegion(hostname,{signingRegion:null==(_e2=regionHash[resolvedRegion])?void 0:_e2.signingRegion,regionRegex:partitionHash[partition2].regionRegex,useFipsEndpoint});return{partition:partition2,signingService,hostname,...signingRegion&&{signingRegion},...(null==(_f=regionHash[resolvedRegion])?void 0:_f.signingService)&&{signingService:regionHash[resolvedRegion].signingService}}},resolveEventStreamSerdeConfig=input=>({...input,eventStreamMarshaller:input.eventStreamSerdeProvider(input)}),CONTENT_LENGTH_HEADER2="content-length";function contentLengthMiddleware(bodyLengthChecker){return next=>async args=>{const request2=args.request;if(HttpRequest.isInstance(request2)){const{body,headers}=request2;if(body&&-1===Object.keys(headers).map((str=>str.toLowerCase())).indexOf(CONTENT_LENGTH_HEADER2))try{const length=bodyLengthChecker(body);request2.headers={...request2.headers,[CONTENT_LENGTH_HEADER2]:String(length)}}catch(error){}}return next({...args,request:request2})}}var contentLengthMiddlewareOptions={step:"build",tags:["SET_CONTENT_LENGTH","CONTENT_LENGTH"],name:"contentLengthMiddleware",override:true},getContentLengthPlugin=options=>({applyToStack:clientStack=>{clientStack.add(contentLengthMiddleware(options.bodyLengthChecker),contentLengthMiddlewareOptions)}}),getDateHeader=response=>{var _a5,_b2,_c2;return HttpResponse.isInstance(response)?null!=(_c2=null==(_a5=response.headers)?void 0:_a5.date)?_c2:null==(_b2=response.headers)?void 0:_b2.Date:void 0},getSkewCorrectedDate=systemClockOffset=>new Date(Date.now()+systemClockOffset),isClockSkewed=(clockTime,systemClockOffset)=>Math.abs(getSkewCorrectedDate(systemClockOffset).getTime()-clockTime)>=3e5,getUpdatedSystemClockOffset=(clockTime,currentSystemClockOffset)=>{const clockTimeInMs=Date.parse(clockTime);if(isClockSkewed(clockTimeInMs,currentSystemClockOffset))return clockTimeInMs-Date.now();else return currentSystemClockOffset},throwSigningPropertyError=(name,property)=>{if(!property)throw new Error(`Property \`${name}\` is not resolved for AWS SDK SigV4Auth`);return property},validateSigningProperties=async signingProperties=>{var _a5,_b2,_c2;const context2=throwSigningPropertyError("context",signingProperties.context),config=throwSigningPropertyError("config",signingProperties.config),authScheme=null==(_c2=null==(_b2=null==(_a5=context2.endpointV2)?void 0:_a5.properties)?void 0:_b2.authSchemes)?void 0:_c2[0],signerFunction=throwSigningPropertyError("signer",config.signer);return{config,signer:await signerFunction(authScheme),signingRegion:null==signingProperties?void 0:signingProperties.signingRegion,signingRegionSet:null==signingProperties?void 0:signingProperties.signingRegionSet,signingName:null==signingProperties?void 0:signingProperties.signingName}},AwsSdkSigV4Signer=class{async sign(httpRequest,identity2,signingProperties){var _a5,_b2,_c2,_d2;if(!HttpRequest.isInstance(httpRequest))throw new Error("The request is not an instance of `HttpRequest` and cannot be signed");const validatedProps=await validateSigningProperties(signingProperties),{config,signer}=validatedProps;let{signingRegion,signingName}=validatedProps;const handlerExecutionContext=signingProperties.context;if(null!=(_b2=null==(_a5=null==handlerExecutionContext?void 0:handlerExecutionContext.authSchemes)?void 0:_a5.length)?_b2:0>1){const[first,second]=handlerExecutionContext.authSchemes;if("sigv4a"===(null==first?void 0:first.name)&&"sigv4"===(null==second?void 0:second.name)){signingRegion=null!=(_c2=null==second?void 0:second.signingRegion)?_c2:signingRegion;signingName=null!=(_d2=null==second?void 0:second.signingName)?_d2:signingName}}return await signer.sign(httpRequest,{signingDate:getSkewCorrectedDate(config.systemClockOffset),signingRegion,signingService:signingName})}errorHandler(signingProperties){return error=>{var _a5;const serverTime=null!=(_a5=error.ServerTime)?_a5:getDateHeader(error.$response);if(serverTime){const config=throwSigningPropertyError("config",signingProperties.config),initialSystemClockOffset=config.systemClockOffset;config.systemClockOffset=getUpdatedSystemClockOffset(serverTime,config.systemClockOffset);if(config.systemClockOffset!==initialSystemClockOffset&&error.$metadata)error.$metadata.clockSkewCorrected=true}throw error}}successHandler(httpResponse,signingProperties){const dateHeader=getDateHeader(httpResponse);if(dateHeader){const config=throwSigningPropertyError("config",signingProperties.config);config.systemClockOffset=getUpdatedSystemClockOffset(dateHeader,config.systemClockOffset)}}},AWSSDKSigV4Signer=AwsSdkSigV4Signer,AwsSdkSigV4ASigner=class extends AwsSdkSigV4Signer{async sign(httpRequest,identity2,signingProperties){var _a5,_b2;if(!HttpRequest.isInstance(httpRequest))throw new Error("The request is not an instance of `HttpRequest` and cannot be signed");const{config,signer,signingRegion,signingRegionSet,signingName}=await validateSigningProperties(signingProperties),configResolvedSigningRegionSet=await(null==(_a5=config.sigv4aSigningRegionSet)?void 0:_a5.call(config)),multiRegionOverride=(null!=(_b2=null!=configResolvedSigningRegionSet?configResolvedSigningRegionSet:signingRegionSet)?_b2:[signingRegion]).join(",");return await signer.sign(httpRequest,{signingDate:getSkewCorrectedDate(config.systemClockOffset),signingRegion:multiRegionOverride,signingService:signingName})}},ProviderError=class _ProviderError extends Error{constructor(message,options=true){var _a5,_b2;let logger2,tryNextLink=true;if("boolean"==typeof options){logger2=void 0;tryNextLink=options}else if(null!=options&&"object"==typeof options){logger2=options.logger;tryNextLink=null!=(_a5=options.tryNextLink)?_a5:true}super(message);this.name="ProviderError";this.tryNextLink=tryNextLink;Object.setPrototypeOf(this,_ProviderError.prototype);null==(_b2=null==logger2?void 0:logger2.debug)||_b2.call(logger2,`@smithy/property-provider ${tryNextLink?"->":"(!)"} ${message}`)}static from(error,options=true){return Object.assign(new this(error.message,options),error)}},CredentialsProviderError=class _CredentialsProviderError extends ProviderError{constructor(message,options=true){super(message,options);this.name="CredentialsProviderError";Object.setPrototypeOf(this,_CredentialsProviderError.prototype)}},TokenProviderError=class _TokenProviderError extends ProviderError{constructor(message,options=true){super(message,options);this.name="TokenProviderError";Object.setPrototypeOf(this,_TokenProviderError.prototype)}},chain=(...providers)=>async()=>{if(0===providers.length)throw new ProviderError("No providers in chain");let lastProviderError;for(const provider of providers)try{return await provider()}catch(err2){lastProviderError=err2;if(null==err2?void 0:err2.tryNextLink)continue;throw err2}throw lastProviderError},memoize=(provider,isExpired,requiresRefresh)=>{let resolved,pending,hasResult,isConstant=false;const coalesceProvider=async()=>{if(!pending)pending=provider();try{resolved=await pending;hasResult=true;isConstant=false}finally{pending=void 0}return resolved};if(void 0===isExpired)return async options=>{if(!hasResult||(null==options?void 0:options.forceRefresh))resolved=await coalesceProvider();return resolved};else return async options=>{if(!hasResult||(null==options?void 0:options.forceRefresh))resolved=await coalesceProvider();if(isConstant)return resolved;if(requiresRefresh&&!requiresRefresh(resolved)){isConstant=true;return resolved}if(isExpired(resolved)){await coalesceProvider();return resolved}return resolved}},resolveAwsSdkSigV4AConfig=config=>{config.sigv4aSigningRegionSet=normalizeProvider2(config.sigv4aSigningRegionSet);return config},NODE_SIGV4A_CONFIG_OPTIONS={environmentVariableSelector(env){if(env.AWS_SIGV4A_SIGNING_REGION_SET)return env.AWS_SIGV4A_SIGNING_REGION_SET.split(",").map((_=>_.trim()));throw new ProviderError("AWS_SIGV4A_SIGNING_REGION_SET not set in env.",{tryNextLink:true})},configFileSelector(profile){var _a5;if(profile.sigv4a_signing_region_set)return(null!=(_a5=profile.sigv4a_signing_region_set)?_a5:"").split(",").map((_=>_.trim()));throw new ProviderError("sigv4a_signing_region_set not set in profile.",{tryNextLink:true})},default:void 0},resolveAwsSdkSigV4Config=config=>{let normalizedCreds;if(config.credentials)normalizedCreds=memoizeIdentityProvider(config.credentials,isIdentityExpired,doesIdentityRequireRefresh);if(!normalizedCreds)if(config.credentialDefaultProvider)normalizedCreds=normalizeProvider2(config.credentialDefaultProvider(Object.assign({},config,{parentClientConfig:config})));else normalizedCreds=async()=>{throw new Error("`credentials` is missing")};const{signingEscapePath=true,systemClockOffset=config.systemClockOffset||0,sha256}=config;let signer;if(config.signer)signer=normalizeProvider2(config.signer);else if(config.regionInfoProvider)signer=()=>normalizeProvider2(config.region)().then((async region=>[await config.regionInfoProvider(region,{useFipsEndpoint:await config.useFipsEndpoint(),useDualstackEndpoint:await config.useDualstackEndpoint()})||{},region])).then((([regionInfo,region])=>{const{signingRegion,signingService}=regionInfo;config.signingRegion=config.signingRegion||signingRegion||region;config.signingName=config.signingName||signingService||config.serviceId;const params={...config,credentials:normalizedCreds,region:config.signingRegion,service:config.signingName,sha256,uriEscapePath:signingEscapePath};return new(config.signerConstructor||SignatureV4)(params)}));else signer=async authScheme=>{const signingRegion=(authScheme=Object.assign({},{name:"sigv4",signingName:config.signingName||config.defaultSigningName,signingRegion:await normalizeProvider2(config.region)(),properties:{}},authScheme)).signingRegion,signingService=authScheme.signingName;config.signingRegion=config.signingRegion||signingRegion;config.signingName=config.signingName||signingService||config.serviceId;const params={...config,credentials:normalizedCreds,region:config.signingRegion,service:config.signingName,sha256,uriEscapePath:signingEscapePath};return new(config.signerConstructor||SignatureV4)(params)};return{...config,systemClockOffset,signingEscapePath,credentials:normalizedCreds,signer}},resolveAWSSDKSigV4Config=resolveAwsSdkSigV4Config,collectBodyString=(streamBody,context2)=>collectBody(streamBody,context2).then((body=>context2.utf8Encoder(body))),import_fast_xml_parser=__toESM(require_fxp()),parseXmlBody=(streamBody,context2)=>collectBodyString(streamBody,context2).then((encoded=>{if(encoded.length){const parser2=new import_fast_xml_parser.XMLParser({attributeNamePrefix:"",htmlEntities:true,ignoreAttributes:false,ignoreDeclaration:true,parseTagValue:false,trimValues:false,tagValueProcessor:(_,val2)=>""===val2.trim()&&val2.includes("\n")?"":void 0});parser2.addEntity("#xD","\r");parser2.addEntity("#10","\n");let parsedObj;try{parsedObj=parser2.parse(encoded,true)}catch(e4){if(e4&&"object"==typeof e4)Object.defineProperty(e4,"$responseBodyText",{value:encoded});throw e4}const textNodeName="#text",key2=Object.keys(parsedObj)[0],parsedObjToReturn=parsedObj[key2];if(parsedObjToReturn[textNodeName]){parsedObjToReturn[key2]=parsedObjToReturn[textNodeName];delete parsedObjToReturn[textNodeName]}return getValueFromTextNode(parsedObjToReturn)}return{}})),parseXmlErrorBody=async(errorBody,context2)=>{var _a5;const value=await parseXmlBody(errorBody,context2);if(value.Error)value.Error.message=null!=(_a5=value.Error.message)?_a5:value.Error.Message;return value},loadRestXmlErrorCode=(output,data)=>{var _a5;if(void 0!==(null==(_a5=null==data?void 0:data.Error)?void 0:_a5.Code))return data.Error.Code;if(void 0!==(null==data?void 0:data.Code))return data.Code;if(404==output.statusCode)return"NotFound"},signatureV4CrtContainer={CrtSignerV4:null},SignatureV4MultiRegion=class{constructor(options){this.sigv4Signer=new SignatureV4S3Express(options);this.signerOptions=options}async sign(requestToSign,options={}){if("*"===options.signingRegion){if("node"!==this.signerOptions.runtime)throw new Error("This request requires signing with SigV4Asymmetric algorithm. It's only available in Node.js");return this.getSigv4aSigner().sign(requestToSign,options)}return this.sigv4Signer.sign(requestToSign,options)}async signWithCredentials(requestToSign,credentials,options={}){if("*"===options.signingRegion){if("node"!==this.signerOptions.runtime)throw new Error("This request requires signing with SigV4Asymmetric algorithm. It's only available in Node.js");return this.getSigv4aSigner().signWithCredentials(requestToSign,credentials,options)}return this.sigv4Signer.signWithCredentials(requestToSign,credentials,options)}async presign(originalRequest,options={}){if("*"===options.signingRegion){if("node"!==this.signerOptions.runtime)throw new Error("This request requires signing with SigV4Asymmetric algorithm. It's only available in Node.js");return this.getSigv4aSigner().presign(originalRequest,options)}return this.sigv4Signer.presign(originalRequest,options)}async presignWithCredentials(originalRequest,credentials,options={}){if("*"===options.signingRegion)throw new Error("Method presignWithCredentials is not supported for [signingRegion=*].");return this.sigv4Signer.presignWithCredentials(originalRequest,credentials,options)}getSigv4aSigner(){if(!this.sigv4aSigner){let CrtSignerV4=null;try{CrtSignerV4=signatureV4CrtContainer.CrtSignerV4;if("function"!=typeof CrtSignerV4)throw new Error}catch(e4){e4.message=`${e4.message}\nPlease check whether you have installed the "@aws-sdk/signature-v4-crt" package explicitly. \nYou must also register the package by calling [require("@aws-sdk/signature-v4-crt");] or an ESM equivalent such as [import "@aws-sdk/signature-v4-crt";]. \nFor more information please go to https://github.com/aws/aws-sdk-js-v3#functionality-requiring-aws-common-runtime-crt`;throw e4}this.sigv4aSigner=new CrtSignerV4({...this.signerOptions,signingAlgorithm:1})}return this.sigv4aSigner}},ce="required",cf="type",cg="conditions",ch3="fn",ci="argv",cj="ref",ck="assign",cl="url",cm="properties",cn="backend",co="authSchemes",cp="disableDoubleEncoding",cq="signingName",cr="signingRegion",cs="headers",ct="signingRegionSet",a=false,b=true,c="isSet",d3="booleanEquals",e3="error",f="aws.partition",g="stringEquals",h="getAttr",i="name",j="substring",k="bucketSuffix",l="parseURL",m="{url#scheme}://{url#authority}/{uri_encoded_bucket}{url#path}",n2="endpoint",o="tree",p="aws.isVirtualHostableS3Bucket",q="{url#scheme}://{Bucket}.{url#authority}{url#path}",r="not",s="{url#scheme}://{url#authority}{url#path}",t3="hardwareType",u="regionPrefix",v="bucketAliasSuffix",w="outpostId",x="isValidHostLabel",y="sigv4a",z="s3-outposts",A="s3",B="{url#scheme}://{url#authority}{url#normalizedPath}{Bucket}",C="https://{Bucket}.s3-accelerate.{partitionResult#dnsSuffix}",D="https://{Bucket}.s3.{partitionResult#dnsSuffix}",E="aws.parseArn",F="bucketArn",G="arnType",H="",I="s3-object-lambda",J="accesspoint",K="accessPointName",L="{url#scheme}://{accessPointName}-{bucketArn#accountId}.{url#authority}{url#path}",M="mrapPartition",N="outpostType",O="arnPrefix",P="{url#scheme}://{url#authority}{url#normalizedPath}{uri_encoded_bucket}",Q="https://s3.{partitionResult#dnsSuffix}/{uri_encoded_bucket}",R="https://s3.{partitionResult#dnsSuffix}",S={[ce]:false,[cf]:"String"},T={[ce]:true,default:false,[cf]:"Boolean"},U={[ce]:false,[cf]:"Boolean"},V={[ch3]:d3,[ci]:[{[cj]:"Accelerate"},true]},W={[ch3]:d3,[ci]:[{[cj]:"UseFIPS"},true]},X={[ch3]:d3,[ci]:[{[cj]:"UseDualStack"},true]},Y={[ch3]:c,[ci]:[{[cj]:"Endpoint"}]},Z={[ch3]:f,[ci]:[{[cj]:"Region"}],[ck]:"partitionResult"},aa={[ch3]:g,[ci]:[{[ch3]:h,[ci]:[{[cj]:"partitionResult"},i]},"aws-cn"]},ab={[ch3]:c,[ci]:[{[cj]:"Bucket"}]},ac={[cj]:"Bucket"},ad={[ch3]:l,[ci]:[{[cj]:"Endpoint"}],[ck]:"url"},ae={[ch3]:d3,[ci]:[{[ch3]:h,[ci]:[{[cj]:"url"},"isIp"]},true]},af={[cj]:"url"},ag={[ch3]:"uriEncode",[ci]:[ac],[ck]:"uri_encoded_bucket"},ah={[cn]:"S3Express",[co]:[{[cp]:true,[i]:"sigv4",[cq]:"s3express",[cr]:"{Region}"}]},ai={},aj={[ch3]:p,[ci]:[ac,false]},ak={[e3]:"S3Express bucket name is not a valid virtual hostable name.",[cf]:e3},al={[cn]:"S3Express",[co]:[{[cp]:true,[i]:"sigv4-s3express",[cq]:"s3express",[cr]:"{Region}"}]},am={[ch3]:c,[ci]:[{[cj]:"UseS3ExpressControlEndpoint"}]},an={[ch3]:d3,[ci]:[{[cj]:"UseS3ExpressControlEndpoint"},true]},ao={[ch3]:r,[ci]:[Y]},ap={[e3]:"Unrecognized S3Express bucket name format.",[cf]:e3},aq={[ch3]:r,[ci]:[ab]},ar={[cj]:t3},as={[cg]:[ao],[e3]:"Expected a endpoint to be specified but no endpoint was found",[cf]:e3},at={[co]:[{[cp]:true,[i]:y,[cq]:z,[ct]:["*"]},{[cp]:true,[i]:"sigv4",[cq]:z,[cr]:"{Region}"}]},au={[ch3]:d3,[ci]:[{[cj]:"ForcePathStyle"},false]},av={[cj]:"ForcePathStyle"},aw={[ch3]:d3,[ci]:[{[cj]:"Accelerate"},false]},ax={[ch3]:g,[ci]:[{[cj]:"Region"},"aws-global"]},ay={[co]:[{[cp]:true,[i]:"sigv4",[cq]:A,[cr]:"us-east-1"}]},az={[ch3]:r,[ci]:[ax]},aA={[ch3]:d3,[ci]:[{[cj]:"UseGlobalEndpoint"},true]},aB={[cl]:"https://{Bucket}.s3-fips.dualstack.{Region}.{partitionResult#dnsSuffix}",[cm]:{[co]:[{[cp]:true,[i]:"sigv4",[cq]:A,[cr]:"{Region}"}]},[cs]:{}},aC={[co]:[{[cp]:true,[i]:"sigv4",[cq]:A,[cr]:"{Region}"}]},aD={[ch3]:d3,[ci]:[{[cj]:"UseGlobalEndpoint"},false]},aE={[ch3]:d3,[ci]:[{[cj]:"UseDualStack"},false]},aF={[cl]:"https://{Bucket}.s3-fips.{Region}.{partitionResult#dnsSuffix}",[cm]:aC,[cs]:{}},aG={[ch3]:d3,[ci]:[{[cj]:"UseFIPS"},false]},aH={[cl]:"https://{Bucket}.s3-accelerate.dualstack.{partitionResult#dnsSuffix}",[cm]:aC,[cs]:{}},aI={[cl]:"https://{Bucket}.s3.dualstack.{Region}.{partitionResult#dnsSuffix}",[cm]:aC,[cs]:{}},aJ={[ch3]:d3,[ci]:[{[ch3]:h,[ci]:[af,"isIp"]},false]},aK={[cl]:B,[cm]:aC,[cs]:{}},aL={[cl]:q,[cm]:aC,[cs]:{}},aM={[n2]:aL,[cf]:n2},aN={[cl]:C,[cm]:aC,[cs]:{}},aO={[cl]:"https://{Bucket}.s3.{Region}.{partitionResult#dnsSuffix}",[cm]:aC,[cs]:{}},aP={[e3]:"Invalid region: region was not a valid DNS name.",[cf]:e3},aQ={[cj]:F},aR={[cj]:G},aS={[ch3]:h,[ci]:[aQ,"service"]},aT={[cj]:K},aU={[cg]:[X],[e3]:"S3 Object Lambda does not support Dual-stack",[cf]:e3},aV={[cg]:[V],[e3]:"S3 Object Lambda does not support S3 Accelerate",[cf]:e3},aW={[cg]:[{[ch3]:c,[ci]:[{[cj]:"DisableAccessPoints"}]},{[ch3]:d3,[ci]:[{[cj]:"DisableAccessPoints"},true]}],[e3]:"Access points are not supported for this operation",[cf]:e3},aX={[cg]:[{[ch3]:c,[ci]:[{[cj]:"UseArnRegion"}]},{[ch3]:d3,[ci]:[{[cj]:"UseArnRegion"},false]},{[ch3]:r,[ci]:[{[ch3]:g,[ci]:[{[ch3]:h,[ci]:[aQ,"region"]},"{Region}"]}]}],[e3]:"Invalid configuration: region from ARN `{bucketArn#region}` does not match client region `{Region}` and UseArnRegion is `false`",[cf]:e3},aY={[ch3]:h,[ci]:[{[cj]:"bucketPartition"},i]},aZ={[ch3]:h,[ci]:[aQ,"accountId"]},ba={[co]:[{[cp]:true,[i]:"sigv4",[cq]:I,[cr]:"{bucketArn#region}"}]},bb={[e3]:"Invalid ARN: The access point name may only contain a-z, A-Z, 0-9 and `-`. Found: `{accessPointName}`",[cf]:e3},bc={[e3]:"Invalid ARN: The account id may only contain a-z, A-Z, 0-9 and `-`. Found: `{bucketArn#accountId}`",[cf]:e3},bd={[e3]:"Invalid region in ARN: `{bucketArn#region}` (invalid DNS name)",[cf]:e3},be={[e3]:"Client was configured for partition `{partitionResult#name}` but ARN (`{Bucket}`) has `{bucketPartition#name}`",[cf]:e3},bf={[e3]:"Invalid ARN: The ARN may only contain a single resource component after `accesspoint`.",[cf]:e3},bg={[e3]:"Invalid ARN: Expected a resource of the format `accesspoint:<accesspoint name>` but no name was provided",[cf]:e3},bh={[co]:[{[cp]:true,[i]:"sigv4",[cq]:A,[cr]:"{bucketArn#region}"}]},bi={[co]:[{[cp]:true,[i]:y,[cq]:z,[ct]:["*"]},{[cp]:true,[i]:"sigv4",[cq]:z,[cr]:"{bucketArn#region}"}]},bj={[ch3]:E,[ci]:[ac]},bk={[cl]:"https://s3-fips.dualstack.{Region}.{partitionResult#dnsSuffix}/{uri_encoded_bucket}",[cm]:aC,[cs]:{}},bl={[cl]:"https://s3-fips.{Region}.{partitionResult#dnsSuffix}/{uri_encoded_bucket}",[cm]:aC,[cs]:{}},bm={[cl]:"https://s3.dualstack.{Region}.{partitionResult#dnsSuffix}/{uri_encoded_bucket}",[cm]:aC,[cs]:{}},bn={[cl]:P,[cm]:aC,[cs]:{}},bo={[cl]:"https://s3.{Region}.{partitionResult#dnsSuffix}/{uri_encoded_bucket}",[cm]:aC,[cs]:{}},bp={[cj]:"UseObjectLambdaEndpoint"},bq={[co]:[{[cp]:true,[i]:"sigv4",[cq]:I,[cr]:"{Region}"}]},br={[cl]:"https://s3-fips.dualstack.{Region}.{partitionResult#dnsSuffix}",[cm]:aC,[cs]:{}},bs={[cl]:"https://s3-fips.{Region}.{partitionResult#dnsSuffix}",[cm]:aC,[cs]:{}},bt={[cl]:"https://s3.dualstack.{Region}.{partitionResult#dnsSuffix}",[cm]:aC,[cs]:{}},bu={[cl]:s,[cm]:aC,[cs]:{}},bv={[cl]:"https://s3.{Region}.{partitionResult#dnsSuffix}",[cm]:aC,[cs]:{}},bw=[{[cj]:"Region"}],bx=[{[cj]:"Endpoint"}],by=[ac],bz=[X],bA=[V],bB=[Y,ad],bC=[{[ch3]:c,[ci]:[{[cj]:"DisableS3ExpressSessionAuth"}]},{[ch3]:d3,[ci]:[{[cj]:"DisableS3ExpressSessionAuth"},true]}],bD=[ae],bE=[ag],bF=[aj],bG=[W],bH=[{[ch3]:j,[ci]:[ac,6,14,true],[ck]:"s3expressAvailabilityZoneId"},{[ch3]:j,[ci]:[ac,14,16,true],[ck]:"s3expressAvailabilityZoneDelim"},{[ch3]:g,[ci]:[{[cj]:"s3expressAvailabilityZoneDelim"},"--"]}],bI=[{[cg]:[W],[n2]:{[cl]:"https://{Bucket}.s3express-fips-{s3expressAvailabilityZoneId}.{Region}.amazonaws.com",[cm]:ah,[cs]:{}},[cf]:n2},{[n2]:{[cl]:"https://{Bucket}.s3express-{s3expressAvailabilityZoneId}.{Region}.amazonaws.com",[cm]:ah,[cs]:{}},[cf]:n2}],bJ=[{[ch3]:j,[ci]:[ac,6,15,true],[ck]:"s3expressAvailabilityZoneId"},{[ch3]:j,[ci]:[ac,15,17,true],[ck]:"s3expressAvailabilityZoneDelim"},{[ch3]:g,[ci]:[{[cj]:"s3expressAvailabilityZoneDelim"},"--"]}],bK=[{[cg]:[W],[n2]:{[cl]:"https://{Bucket}.s3express-fips-{s3expressAvailabilityZoneId}.{Region}.amazonaws.com",[cm]:al,[cs]:{}},[cf]:n2},{[n2]:{[cl]:"https://{Bucket}.s3express-{s3expressAvailabilityZoneId}.{Region}.amazonaws.com",[cm]:al,[cs]:{}},[cf]:n2}],bL=[ab],bM=[{[ch3]:x,[ci]:[{[cj]:w},false]}],bN=[{[ch3]:g,[ci]:[{[cj]:u},"beta"]}],bO=["*"],bP=[Z],bQ=[{[ch3]:x,[ci]:[{[cj]:"Region"},false]}],bR=[{[ch3]:g,[ci]:[{[cj]:"Region"},"us-east-1"]}],bS=[{[ch3]:g,[ci]:[aR,J]}],bT=[{[ch3]:h,[ci]:[aQ,"resourceId[1]"],[ck]:K},{[ch3]:r,[ci]:[{[ch3]:g,[ci]:[aT,H]}]}],bU=[aQ,"resourceId[1]"],bV=[{[ch3]:r,[ci]:[{[ch3]:g,[ci]:[{[ch3]:h,[ci]:[aQ,"region"]},H]}]}],bW=[{[ch3]:r,[ci]:[{[ch3]:c,[ci]:[{[ch3]:h,[ci]:[aQ,"resourceId[2]"]}]}]}],bX=[aQ,"resourceId[2]"],bY=[{[ch3]:f,[ci]:[{[ch3]:h,[ci]:[aQ,"region"]}],[ck]:"bucketPartition"}],bZ=[{[ch3]:g,[ci]:[aY,{[ch3]:h,[ci]:[{[cj]:"partitionResult"},i]}]}],ca=[{[ch3]:x,[ci]:[{[ch3]:h,[ci]:[aQ,"region"]},true]}],cb=[{[ch3]:x,[ci]:[aZ,false]}],cc=[{[ch3]:x,[ci]:[aT,false]}],cd=[{[ch3]:x,[ci]:[{[cj]:"Region"},true]}],_data={version:"1.0",parameters:{Bucket:S,Region:S,UseFIPS:T,UseDualStack:T,Endpoint:S,ForcePathStyle:T,Accelerate:T,UseGlobalEndpoint:T,UseObjectLambdaEndpoint:U,Key:S,Prefix:S,CopySource:S,DisableAccessPoints:U,DisableMultiRegionAccessPoints:T,UseArnRegion:U,UseS3ExpressControlEndpoint:U,DisableS3ExpressSessionAuth:U},rules:[{[cg]:[{[ch3]:c,[ci]:bw}],rules:[{[cg]:[V,W],error:"Accelerate cannot be used with FIPS",[cf]:e3},{[cg]:[X,Y],error:"Cannot set dual-stack in combination with a custom endpoint.",[cf]:e3},{[cg]:[Y,W],error:"A custom endpoint cannot be combined with FIPS",[cf]:e3},{[cg]:[Y,V],error:"A custom endpoint cannot be combined with S3 Accelerate",[cf]:e3},{[cg]:[W,Z,aa],error:"Partition does not support FIPS",[cf]:e3},{[cg]:[ab,{[ch3]:j,[ci]:[ac,0,6,b],[ck]:k},{[ch3]:g,[ci]:[{[cj]:k},"--x-s3"]}],rules:[{[cg]:bz,error:"S3Express does not support Dual-stack.",[cf]:e3},{[cg]:bA,error:"S3Express does not support S3 Accelerate.",[cf]:e3},{[cg]:bB,rules:[{[cg]:bC,rules:[{[cg]:bD,rules:[{[cg]:bE,rules:[{endpoint:{[cl]:m,[cm]:ah,[cs]:ai},[cf]:n2}],[cf]:o}],[cf]:o},{[cg]:bF,rules:[{endpoint:{[cl]:q,[cm]:ah,[cs]:ai},[cf]:n2}],[cf]:o},ak],[cf]:o},{[cg]:bD,rules:[{[cg]:bE,rules:[{endpoint:{[cl]:m,[cm]:al,[cs]:ai},[cf]:n2}],[cf]:o}],[cf]:o},{[cg]:bF,rules:[{endpoint:{[cl]:q,[cm]:al,[cs]:ai},[cf]:n2}],[cf]:o},ak],[cf]:o},{[cg]:[am,an],rules:[{[cg]:[ag,ao],rules:[{[cg]:bG,endpoint:{[cl]:"https://s3express-control-fips.{Region}.amazonaws.com/{uri_encoded_bucket}",[cm]:ah,[cs]:ai},[cf]:n2},{endpoint:{[cl]:"https://s3express-control.{Region}.amazonaws.com/{uri_encoded_bucket}",[cm]:ah,[cs]:ai},[cf]:n2}],[cf]:o}],[cf]:o},{[cg]:bF,rules:[{[cg]:bC,rules:[{[cg]:bH,rules:bI,[cf]:o},{[cg]:bJ,rules:bI,[cf]:o},ap],[cf]:o},{[cg]:bH,rules:bK,[cf]:o},{[cg]:bJ,rules:bK,[cf]:o},ap],[cf]:o},ak],[cf]:o},{[cg]:[aq,am,an],rules:[{[cg]:bB,endpoint:{[cl]:s,[cm]:ah,[cs]:ai},[cf]:n2},{[cg]:bG,endpoint:{[cl]:"https://s3express-control-fips.{Region}.amazonaws.com",[cm]:ah,[cs]:ai},[cf]:n2},{endpoint:{[cl]:"https://s3express-control.{Region}.amazonaws.com",[cm]:ah,[cs]:ai},[cf]:n2}],[cf]:o},{[cg]:[ab,{[ch3]:j,[ci]:[ac,49,50,b],[ck]:t3},{[ch3]:j,[ci]:[ac,8,12,b],[ck]:u},{[ch3]:j,[ci]:[ac,0,7,b],[ck]:v},{[ch3]:j,[ci]:[ac,32,49,b],[ck]:w},{[ch3]:f,[ci]:bw,[ck]:"regionPartition"},{[ch3]:g,[ci]:[{[cj]:v},"--op-s3"]}],rules:[{[cg]:bM,rules:[{[cg]:[{[ch3]:g,[ci]:[ar,"e"]}],rules:[{[cg]:bN,rules:[as,{[cg]:bB,endpoint:{[cl]:"https://{Bucket}.ec2.{url#authority}",[cm]:at,[cs]:ai},[cf]:n2}],[cf]:o},{endpoint:{[cl]:"https://{Bucket}.ec2.s3-outposts.{Region}.{regionPartition#dnsSuffix}",[cm]:at,[cs]:ai},[cf]:n2}],[cf]:o},{[cg]:[{[ch3]:g,[ci]:[ar,"o"]}],rules:[{[cg]:bN,rules:[as,{[cg]:bB,endpoint:{[cl]:"https://{Bucket}.op-{outpostId}.{url#authority}",[cm]:at,[cs]:ai},[cf]:n2}],[cf]:o},{endpoint:{[cl]:"https://{Bucket}.op-{outpostId}.s3-outposts.{Region}.{regionPartition#dnsSuffix}",[cm]:at,[cs]:ai},[cf]:n2}],[cf]:o},{error:'Unrecognized hardware type: "Expected hardware type o or e but got {hardwareType}"',[cf]:e3}],[cf]:o},{error:"Invalid ARN: The outpost Id must only contain a-z, A-Z, 0-9 and `-`.",[cf]:e3}],[cf]:o},{[cg]:bL,rules:[{[cg]:[Y,{[ch3]:r,[ci]:[{[ch3]:c,[ci]:[{[ch3]:l,[ci]:bx}]}]}],error:"Custom endpoint `{Endpoint}` was not a valid URI",[cf]:e3},{[cg]:[au,aj],rules:[{[cg]:bP,rules:[{[cg]:bQ,rules:[{[cg]:[V,aa],error:"S3 Accelerate cannot be used in this region",[cf]:e3},{[cg]:[X,W,aw,ao,ax],endpoint:{[cl]:"https://{Bucket}.s3-fips.dualstack.us-east-1.{partitionResult#dnsSuffix}",[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[X,W,aw,ao,az,aA],rules:[{endpoint:aB,[cf]:n2}],[cf]:o},{[cg]:[X,W,aw,ao,az,aD],endpoint:aB,[cf]:n2},{[cg]:[aE,W,aw,ao,ax],endpoint:{[cl]:"https://{Bucket}.s3-fips.us-east-1.{partitionResult#dnsSuffix}",[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aE,W,aw,ao,az,aA],rules:[{endpoint:aF,[cf]:n2}],[cf]:o},{[cg]:[aE,W,aw,ao,az,aD],endpoint:aF,[cf]:n2},{[cg]:[X,aG,V,ao,ax],endpoint:{[cl]:"https://{Bucket}.s3-accelerate.dualstack.us-east-1.{partitionResult#dnsSuffix}",[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[X,aG,V,ao,az,aA],rules:[{endpoint:aH,[cf]:n2}],[cf]:o},{[cg]:[X,aG,V,ao,az,aD],endpoint:aH,[cf]:n2},{[cg]:[X,aG,aw,ao,ax],endpoint:{[cl]:"https://{Bucket}.s3.dualstack.us-east-1.{partitionResult#dnsSuffix}",[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[X,aG,aw,ao,az,aA],rules:[{endpoint:aI,[cf]:n2}],[cf]:o},{[cg]:[X,aG,aw,ao,az,aD],endpoint:aI,[cf]:n2},{[cg]:[aE,aG,aw,Y,ad,ae,ax],endpoint:{[cl]:B,[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aE,aG,aw,Y,ad,aJ,ax],endpoint:{[cl]:q,[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aE,aG,aw,Y,ad,ae,az,aA],rules:[{[cg]:bR,endpoint:aK,[cf]:n2},{endpoint:aK,[cf]:n2}],[cf]:o},{[cg]:[aE,aG,aw,Y,ad,aJ,az,aA],rules:[{[cg]:bR,endpoint:aL,[cf]:n2},aM],[cf]:o},{[cg]:[aE,aG,aw,Y,ad,ae,az,aD],endpoint:aK,[cf]:n2},{[cg]:[aE,aG,aw,Y,ad,aJ,az,aD],endpoint:aL,[cf]:n2},{[cg]:[aE,aG,V,ao,ax],endpoint:{[cl]:C,[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aE,aG,V,ao,az,aA],rules:[{[cg]:bR,endpoint:aN,[cf]:n2},{endpoint:aN,[cf]:n2}],[cf]:o},{[cg]:[aE,aG,V,ao,az,aD],endpoint:aN,[cf]:n2},{[cg]:[aE,aG,aw,ao,ax],endpoint:{[cl]:D,[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aE,aG,aw,ao,az,aA],rules:[{[cg]:bR,endpoint:{[cl]:D,[cm]:aC,[cs]:ai},[cf]:n2},{endpoint:aO,[cf]:n2}],[cf]:o},{[cg]:[aE,aG,aw,ao,az,aD],endpoint:aO,[cf]:n2}],[cf]:o},aP],[cf]:o}],[cf]:o},{[cg]:[Y,ad,{[ch3]:g,[ci]:[{[ch3]:h,[ci]:[af,"scheme"]},"http"]},{[ch3]:p,[ci]:[ac,b]},au,aG,aE,aw],rules:[{[cg]:bP,rules:[{[cg]:bQ,rules:[aM],[cf]:o},aP],[cf]:o}],[cf]:o},{[cg]:[au,{[ch3]:E,[ci]:by,[ck]:F}],rules:[{[cg]:[{[ch3]:h,[ci]:[aQ,"resourceId[0]"],[ck]:G},{[ch3]:r,[ci]:[{[ch3]:g,[ci]:[aR,H]}]}],rules:[{[cg]:[{[ch3]:g,[ci]:[aS,I]}],rules:[{[cg]:bS,rules:[{[cg]:bT,rules:[aU,aV,{[cg]:bV,rules:[aW,{[cg]:bW,rules:[aX,{[cg]:bY,rules:[{[cg]:bP,rules:[{[cg]:bZ,rules:[{[cg]:ca,rules:[{[cg]:[{[ch3]:g,[ci]:[aZ,H]}],error:"Invalid ARN: Missing account id",[cf]:e3},{[cg]:cb,rules:[{[cg]:cc,rules:[{[cg]:bB,endpoint:{[cl]:L,[cm]:ba,[cs]:ai},[cf]:n2},{[cg]:bG,endpoint:{[cl]:"https://{accessPointName}-{bucketArn#accountId}.s3-object-lambda-fips.{bucketArn#region}.{bucketPartition#dnsSuffix}",[cm]:ba,[cs]:ai},[cf]:n2},{endpoint:{[cl]:"https://{accessPointName}-{bucketArn#accountId}.s3-object-lambda.{bucketArn#region}.{bucketPartition#dnsSuffix}",[cm]:ba,[cs]:ai},[cf]:n2}],[cf]:o},bb],[cf]:o},bc],[cf]:o},bd],[cf]:o},be],[cf]:o}],[cf]:o}],[cf]:o},bf],[cf]:o},{error:"Invalid ARN: bucket ARN is missing a region",[cf]:e3}],[cf]:o},bg],[cf]:o},{error:"Invalid ARN: Object Lambda ARNs only support `accesspoint` arn types, but found: `{arnType}`",[cf]:e3}],[cf]:o},{[cg]:bS,rules:[{[cg]:bT,rules:[{[cg]:bV,rules:[{[cg]:bS,rules:[{[cg]:bV,rules:[aW,{[cg]:bW,rules:[aX,{[cg]:bY,rules:[{[cg]:bP,rules:[{[cg]:[{[ch3]:g,[ci]:[aY,"{partitionResult#name}"]}],rules:[{[cg]:ca,rules:[{[cg]:[{[ch3]:g,[ci]:[aS,A]}],rules:[{[cg]:cb,rules:[{[cg]:cc,rules:[{[cg]:bA,error:"Access Points do not support S3 Accelerate",[cf]:e3},{[cg]:[W,X],endpoint:{[cl]:"https://{accessPointName}-{bucketArn#accountId}.s3-accesspoint-fips.dualstack.{bucketArn#region}.{bucketPartition#dnsSuffix}",[cm]:bh,[cs]:ai},[cf]:n2},{[cg]:[W,aE],endpoint:{[cl]:"https://{accessPointName}-{bucketArn#accountId}.s3-accesspoint-fips.{bucketArn#region}.{bucketPartition#dnsSuffix}",[cm]:bh,[cs]:ai},[cf]:n2},{[cg]:[aG,X],endpoint:{[cl]:"https://{accessPointName}-{bucketArn#accountId}.s3-accesspoint.dualstack.{bucketArn#region}.{bucketPartition#dnsSuffix}",[cm]:bh,[cs]:ai},[cf]:n2},{[cg]:[aG,aE,Y,ad],endpoint:{[cl]:L,[cm]:bh,[cs]:ai},[cf]:n2},{[cg]:[aG,aE],endpoint:{[cl]:"https://{accessPointName}-{bucketArn#accountId}.s3-accesspoint.{bucketArn#region}.{bucketPartition#dnsSuffix}",[cm]:bh,[cs]:ai},[cf]:n2}],[cf]:o},bb],[cf]:o},bc],[cf]:o},{error:"Invalid ARN: The ARN was not for the S3 service, found: {bucketArn#service}",[cf]:e3}],[cf]:o},bd],[cf]:o},be],[cf]:o}],[cf]:o}],[cf]:o},bf],[cf]:o}],[cf]:o}],[cf]:o},{[cg]:[{[ch3]:x,[ci]:[aT,b]}],rules:[{[cg]:bz,error:"S3 MRAP does not support dual-stack",[cf]:e3},{[cg]:bG,error:"S3 MRAP does not support FIPS",[cf]:e3},{[cg]:bA,error:"S3 MRAP does not support S3 Accelerate",[cf]:e3},{[cg]:[{[ch3]:d3,[ci]:[{[cj]:"DisableMultiRegionAccessPoints"},b]}],error:"Invalid configuration: Multi-Region Access Point ARNs are disabled.",[cf]:e3},{[cg]:[{[ch3]:f,[ci]:bw,[ck]:M}],rules:[{[cg]:[{[ch3]:g,[ci]:[{[ch3]:h,[ci]:[{[cj]:M},i]},{[ch3]:h,[ci]:[aQ,"partition"]}]}],rules:[{endpoint:{[cl]:"https://{accessPointName}.accesspoint.s3-global.{mrapPartition#dnsSuffix}",[cm]:{[co]:[{[cp]:b,name:y,[cq]:A,[ct]:bO}]},[cs]:ai},[cf]:n2}],[cf]:o},{error:"Client was configured for partition `{mrapPartition#name}` but bucket referred to partition `{bucketArn#partition}`",[cf]:e3}],[cf]:o}],[cf]:o},{error:"Invalid Access Point Name",[cf]:e3}],[cf]:o},bg],[cf]:o},{[cg]:[{[ch3]:g,[ci]:[aS,z]}],rules:[{[cg]:bz,error:"S3 Outposts does not support Dual-stack",[cf]:e3},{[cg]:bG,error:"S3 Outposts does not support FIPS",[cf]:e3},{[cg]:bA,error:"S3 Outposts does not support S3 Accelerate",[cf]:e3},{[cg]:[{[ch3]:c,[ci]:[{[ch3]:h,[ci]:[aQ,"resourceId[4]"]}]}],error:"Invalid Arn: Outpost Access Point ARN contains sub resources",[cf]:e3},{[cg]:[{[ch3]:h,[ci]:bU,[ck]:w}],rules:[{[cg]:bM,rules:[aX,{[cg]:bY,rules:[{[cg]:bP,rules:[{[cg]:bZ,rules:[{[cg]:ca,rules:[{[cg]:cb,rules:[{[cg]:[{[ch3]:h,[ci]:bX,[ck]:N}],rules:[{[cg]:[{[ch3]:h,[ci]:[aQ,"resourceId[3]"],[ck]:K}],rules:[{[cg]:[{[ch3]:g,[ci]:[{[cj]:N},J]}],rules:[{[cg]:bB,endpoint:{[cl]:"https://{accessPointName}-{bucketArn#accountId}.{outpostId}.{url#authority}",[cm]:bi,[cs]:ai},[cf]:n2},{endpoint:{[cl]:"https://{accessPointName}-{bucketArn#accountId}.{outpostId}.s3-outposts.{bucketArn#region}.{bucketPartition#dnsSuffix}",[cm]:bi,[cs]:ai},[cf]:n2}],[cf]:o},{error:"Expected an outpost type `accesspoint`, found {outpostType}",[cf]:e3}],[cf]:o},{error:"Invalid ARN: expected an access point name",[cf]:e3}],[cf]:o},{error:"Invalid ARN: Expected a 4-component resource",[cf]:e3}],[cf]:o},bc],[cf]:o},bd],[cf]:o},be],[cf]:o}],[cf]:o}],[cf]:o},{error:"Invalid ARN: The outpost Id may only contain a-z, A-Z, 0-9 and `-`. Found: `{outpostId}`",[cf]:e3}],[cf]:o},{error:"Invalid ARN: The Outpost Id was not set",[cf]:e3}],[cf]:o},{error:"Invalid ARN: Unrecognized format: {Bucket} (type: {arnType})",[cf]:e3}],[cf]:o},{error:"Invalid ARN: No ARN type specified",[cf]:e3}],[cf]:o},{[cg]:[{[ch3]:j,[ci]:[ac,0,4,a],[ck]:O},{[ch3]:g,[ci]:[{[cj]:O},"arn:"]},{[ch3]:r,[ci]:[{[ch3]:c,[ci]:[bj]}]}],error:"Invalid ARN: `{Bucket}` was not a valid ARN",[cf]:e3},{[cg]:[{[ch3]:d3,[ci]:[av,b]},bj],error:"Path-style addressing cannot be used with ARN buckets",[cf]:e3},{[cg]:bE,rules:[{[cg]:bP,rules:[{[cg]:[aw],rules:[{[cg]:[X,ao,W,ax],endpoint:{[cl]:"https://s3-fips.dualstack.us-east-1.{partitionResult#dnsSuffix}/{uri_encoded_bucket}",[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[X,ao,W,az,aA],rules:[{endpoint:bk,[cf]:n2}],[cf]:o},{[cg]:[X,ao,W,az,aD],endpoint:bk,[cf]:n2},{[cg]:[aE,ao,W,ax],endpoint:{[cl]:"https://s3-fips.us-east-1.{partitionResult#dnsSuffix}/{uri_encoded_bucket}",[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aE,ao,W,az,aA],rules:[{endpoint:bl,[cf]:n2}],[cf]:o},{[cg]:[aE,ao,W,az,aD],endpoint:bl,[cf]:n2},{[cg]:[X,ao,aG,ax],endpoint:{[cl]:"https://s3.dualstack.us-east-1.{partitionResult#dnsSuffix}/{uri_encoded_bucket}",[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[X,ao,aG,az,aA],rules:[{endpoint:bm,[cf]:n2}],[cf]:o},{[cg]:[X,ao,aG,az,aD],endpoint:bm,[cf]:n2},{[cg]:[aE,Y,ad,aG,ax],endpoint:{[cl]:P,[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aE,Y,ad,aG,az,aA],rules:[{[cg]:bR,endpoint:bn,[cf]:n2},{endpoint:bn,[cf]:n2}],[cf]:o},{[cg]:[aE,Y,ad,aG,az,aD],endpoint:bn,[cf]:n2},{[cg]:[aE,ao,aG,ax],endpoint:{[cl]:Q,[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aE,ao,aG,az,aA],rules:[{[cg]:bR,endpoint:{[cl]:Q,[cm]:aC,[cs]:ai},[cf]:n2},{endpoint:bo,[cf]:n2}],[cf]:o},{[cg]:[aE,ao,aG,az,aD],endpoint:bo,[cf]:n2}],[cf]:o},{error:"Path-style addressing cannot be used with S3 Accelerate",[cf]:e3}],[cf]:o}],[cf]:o}],[cf]:o},{[cg]:[{[ch3]:c,[ci]:[bp]},{[ch3]:d3,[ci]:[bp,b]}],rules:[{[cg]:bP,rules:[{[cg]:cd,rules:[aU,aV,{[cg]:bB,endpoint:{[cl]:s,[cm]:bq,[cs]:ai},[cf]:n2},{[cg]:bG,endpoint:{[cl]:"https://s3-object-lambda-fips.{Region}.{partitionResult#dnsSuffix}",[cm]:bq,[cs]:ai},[cf]:n2},{endpoint:{[cl]:"https://s3-object-lambda.{Region}.{partitionResult#dnsSuffix}",[cm]:bq,[cs]:ai},[cf]:n2}],[cf]:o},aP],[cf]:o}],[cf]:o},{[cg]:[aq],rules:[{[cg]:bP,rules:[{[cg]:cd,rules:[{[cg]:[W,X,ao,ax],endpoint:{[cl]:"https://s3-fips.dualstack.us-east-1.{partitionResult#dnsSuffix}",[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[W,X,ao,az,aA],rules:[{endpoint:br,[cf]:n2}],[cf]:o},{[cg]:[W,X,ao,az,aD],endpoint:br,[cf]:n2},{[cg]:[W,aE,ao,ax],endpoint:{[cl]:"https://s3-fips.us-east-1.{partitionResult#dnsSuffix}",[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[W,aE,ao,az,aA],rules:[{endpoint:bs,[cf]:n2}],[cf]:o},{[cg]:[W,aE,ao,az,aD],endpoint:bs,[cf]:n2},{[cg]:[aG,X,ao,ax],endpoint:{[cl]:"https://s3.dualstack.us-east-1.{partitionResult#dnsSuffix}",[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aG,X,ao,az,aA],rules:[{endpoint:bt,[cf]:n2}],[cf]:o},{[cg]:[aG,X,ao,az,aD],endpoint:bt,[cf]:n2},{[cg]:[aG,aE,Y,ad,ax],endpoint:{[cl]:s,[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aG,aE,Y,ad,az,aA],rules:[{[cg]:bR,endpoint:bu,[cf]:n2},{endpoint:bu,[cf]:n2}],[cf]:o},{[cg]:[aG,aE,Y,ad,az,aD],endpoint:bu,[cf]:n2},{[cg]:[aG,aE,ao,ax],endpoint:{[cl]:R,[cm]:ay,[cs]:ai},[cf]:n2},{[cg]:[aG,aE,ao,az,aA],rules:[{[cg]:bR,endpoint:{[cl]:R,[cm]:aC,[cs]:ai},[cf]:n2},{endpoint:bv,[cf]:n2}],[cf]:o},{[cg]:[aG,aE,ao,az,aD],endpoint:bv,[cf]:n2}],[cf]:o},aP],[cf]:o}],[cf]:o}],[cf]:o},{error:"A region must be set when sending requests to S3.",[cf]:e3}]},ruleSet=_data,defaultEndpointResolver=(endpointParams,context2={})=>resolveEndpoint(ruleSet,{endpointParams,logger:context2.logger});customEndpointFunctions.aws=awsEndpointFunctions;var createEndpointRuleSetHttpAuthSchemeParametersProvider=defaultHttpAuthSchemeParametersProvider=>async(config,context2,input)=>{var _a5,_b2,_c2;if(!input)throw new Error("Could not find `input` for `defaultEndpointRuleSetHttpAuthSchemeParametersProvider`");const defaultParameters=await defaultHttpAuthSchemeParametersProvider(config,context2,input),instructionsFn=null==(_c2=null==(_b2=null==(_a5=getSmithyContext(context2))?void 0:_a5.commandInstance)?void 0:_b2.constructor)?void 0:_c2.getEndpointParameterInstructions;if(!instructionsFn)throw new Error(`getEndpointParameterInstructions() is not defined on \`${context2.commandName}\``);const endpointParameters=await resolveParams(input,{getEndpointParameterInstructions:instructionsFn},config);return Object.assign(defaultParameters,endpointParameters)},_defaultS3HttpAuthSchemeParametersProvider=async(config,context2,input)=>({operation:getSmithyContext(context2).operation,region:await normalizeProvider(config.region)()||(()=>{throw new Error("expected `region` to be configured for `aws.auth#sigv4`")})()}),defaultS3HttpAuthSchemeParametersProvider=createEndpointRuleSetHttpAuthSchemeParametersProvider(_defaultS3HttpAuthSchemeParametersProvider);function createAwsAuthSigv4HttpAuthOption(authParameters){return{schemeId:"aws.auth#sigv4",signingProperties:{name:"s3",region:authParameters.region},propertiesExtractor:(config,context2)=>({signingProperties:{config,context:context2}})}}function createAwsAuthSigv4aHttpAuthOption(authParameters){return{schemeId:"aws.auth#sigv4a",signingProperties:{name:"s3",region:authParameters.region},propertiesExtractor:(config,context2)=>({signingProperties:{config,context:context2}})}}var AnalyticsFilter,createEndpointRuleSetHttpAuthSchemeProvider=(defaultEndpointResolver2,defaultHttpAuthSchemeResolver,createHttpAuthOptionFunctions)=>authParameters=>{var _a5;const authSchemes=null==(_a5=defaultEndpointResolver2(authParameters).properties)?void 0:_a5.authSchemes;if(!authSchemes)return defaultHttpAuthSchemeResolver(authParameters);const options=[];for(const scheme of authSchemes){const{name:resolvedName,properties={},...rest}=scheme,name=resolvedName.toLowerCase();if(resolvedName!==name)console.warn(`HttpAuthScheme has been normalized with lowercasing: \`${resolvedName}\` to \`${name}\``);let schemeId;if("sigv4a"===name){schemeId="aws.auth#sigv4a";const sigv4Present=authSchemes.find((s2=>{const name2=s2.name.toLowerCase();return"sigv4a"!==name2&&name2.startsWith("sigv4")}));if(!signatureV4CrtContainer.CrtSignerV4&&sigv4Present)continue}else if(name.startsWith("sigv4"))schemeId="aws.auth#sigv4";else throw new Error(`Unknown HttpAuthScheme found in \`@smithy.rules#endpointRuleSet\`: \`${name}\``);const createOption=createHttpAuthOptionFunctions[schemeId];if(!createOption)throw new Error(`Could not find HttpAuthOption create function for \`${schemeId}\``);const option=createOption(authParameters);option.schemeId=schemeId;option.signingProperties={...option.signingProperties||{},...rest,...properties};options.push(option)}return options},_defaultS3HttpAuthSchemeProvider=authParameters=>{const options=[];switch(authParameters.operation){default:options.push(createAwsAuthSigv4HttpAuthOption(authParameters));options.push(createAwsAuthSigv4aHttpAuthOption(authParameters))}return options},defaultS3HttpAuthSchemeProvider=createEndpointRuleSetHttpAuthSchemeProvider(defaultEndpointResolver,_defaultS3HttpAuthSchemeProvider,{"aws.auth#sigv4":createAwsAuthSigv4HttpAuthOption,"aws.auth#sigv4a":createAwsAuthSigv4aHttpAuthOption}),resolveHttpAuthSchemeConfig=config=>{const config_0=resolveAwsSdkSigV4Config(config);return{...resolveAwsSdkSigV4AConfig(config_0)}},resolveClientEndpointParameters=options=>{var _a5,_b2,_c2,_d2,_e2,_f;return{...options,useFipsEndpoint:null!=(_a5=options.useFipsEndpoint)?_a5:false,useDualstackEndpoint:null!=(_b2=options.useDualstackEndpoint)?_b2:false,forcePathStyle:null!=(_c2=options.forcePathStyle)?_c2:false,useAccelerateEndpoint:null!=(_d2=options.useAccelerateEndpoint)?_d2:false,useGlobalEndpoint:null!=(_e2=options.useGlobalEndpoint)?_e2:false,disableMultiregionAccessPoints:null!=(_f=options.disableMultiregionAccessPoints)?_f:false,defaultSigningName:"s3"}},commonParams={ForcePathStyle:{type:"clientContextParams",name:"forcePathStyle"},UseArnRegion:{type:"clientContextParams",name:"useArnRegion"},DisableMultiRegionAccessPoints:{type:"clientContextParams",name:"disableMultiregionAccessPoints"},Accelerate:{type:"clientContextParams",name:"useAccelerateEndpoint"},DisableS3ExpressSessionAuth:{type:"clientContextParams",name:"disableS3ExpressSessionAuth"},UseGlobalEndpoint:{type:"builtInParams",name:"useGlobalEndpoint"},UseFIPS:{type:"builtInParams",name:"useFipsEndpoint"},Endpoint:{type:"builtInParams",name:"endpoint"},Region:{type:"builtInParams",name:"region"},UseDualStack:{type:"builtInParams",name:"useDualstackEndpoint"}},S3ServiceException=class _S3ServiceException extends ServiceException{constructor(options){super(options);Object.setPrototypeOf(this,_S3ServiceException.prototype)}},RequestCharged={requester:"requester"},RequestPayer={requester:"requester"},NoSuchUpload=class _NoSuchUpload extends S3ServiceException{constructor(opts){super({name:"NoSuchUpload",$fault:"client",...opts});this.name="NoSuchUpload";this.$fault="client";Object.setPrototypeOf(this,_NoSuchUpload.prototype)}},BucketAccelerateStatus={Enabled:"Enabled",Suspended:"Suspended"},Type={AmazonCustomerByEmail:"AmazonCustomerByEmail",CanonicalUser:"CanonicalUser",Group:"Group"},Permission={FULL_CONTROL:"FULL_CONTROL",READ:"READ",READ_ACP:"READ_ACP",WRITE:"WRITE",WRITE_ACP:"WRITE_ACP"},OwnerOverride={Destination:"Destination"},ServerSideEncryption={AES256:"AES256",aws_kms:"aws:kms",aws_kms_dsse:"aws:kms:dsse"},ObjectCannedACL={authenticated_read:"authenticated-read",aws_exec_read:"aws-exec-read",bucket_owner_full_control:"bucket-owner-full-control",bucket_owner_read:"bucket-owner-read",private:"private",public_read:"public-read",public_read_write:"public-read-write"},ChecksumAlgorithm={CRC32:"CRC32",CRC32C:"CRC32C",SHA1:"SHA1",SHA256:"SHA256"},MetadataDirective={COPY:"COPY",REPLACE:"REPLACE"},ObjectLockLegalHoldStatus={OFF:"OFF",ON:"ON"},ObjectLockMode={COMPLIANCE:"COMPLIANCE",GOVERNANCE:"GOVERNANCE"},StorageClass={DEEP_ARCHIVE:"DEEP_ARCHIVE",EXPRESS_ONEZONE:"EXPRESS_ONEZONE",GLACIER:"GLACIER",GLACIER_IR:"GLACIER_IR",INTELLIGENT_TIERING:"INTELLIGENT_TIERING",ONEZONE_IA:"ONEZONE_IA",OUTPOSTS:"OUTPOSTS",REDUCED_REDUNDANCY:"REDUCED_REDUNDANCY",SNOW:"SNOW",STANDARD:"STANDARD",STANDARD_IA:"STANDARD_IA"},TaggingDirective={COPY:"COPY",REPLACE:"REPLACE"},ObjectNotInActiveTierError=class _ObjectNotInActiveTierError extends S3ServiceException{constructor(opts){super({name:"ObjectNotInActiveTierError",$fault:"client",...opts});this.name="ObjectNotInActiveTierError";this.$fault="client";Object.setPrototypeOf(this,_ObjectNotInActiveTierError.prototype)}},BucketAlreadyExists=class _BucketAlreadyExists extends S3ServiceException{constructor(opts){super({name:"BucketAlreadyExists",$fault:"client",...opts});this.name="BucketAlreadyExists";this.$fault="client";Object.setPrototypeOf(this,_BucketAlreadyExists.prototype)}},BucketAlreadyOwnedByYou=class _BucketAlreadyOwnedByYou extends S3ServiceException{constructor(opts){super({name:"BucketAlreadyOwnedByYou",$fault:"client",...opts});this.name="BucketAlreadyOwnedByYou";this.$fault="client";Object.setPrototypeOf(this,_BucketAlreadyOwnedByYou.prototype)}},BucketCannedACL={authenticated_read:"authenticated-read",private:"private",public_read:"public-read",public_read_write:"public-read-write"},DataRedundancy={SingleAvailabilityZone:"SingleAvailabilityZone"},BucketType={Directory:"Directory"},LocationType={AvailabilityZone:"AvailabilityZone"},BucketLocationConstraint={EU:"EU",af_south_1:"af-south-1",ap_east_1:"ap-east-1",ap_northeast_1:"ap-northeast-1",ap_northeast_2:"ap-northeast-2",ap_northeast_3:"ap-northeast-3",ap_south_1:"ap-south-1",ap_south_2:"ap-south-2",ap_southeast_1:"ap-southeast-1",ap_southeast_2:"ap-southeast-2",ap_southeast_3:"ap-southeast-3",ca_central_1:"ca-central-1",cn_north_1:"cn-north-1",cn_northwest_1:"cn-northwest-1",eu_central_1:"eu-central-1",eu_north_1:"eu-north-1",eu_south_1:"eu-south-1",eu_south_2:"eu-south-2",eu_west_1:"eu-west-1",eu_west_2:"eu-west-2",eu_west_3:"eu-west-3",me_south_1:"me-south-1",sa_east_1:"sa-east-1",us_east_2:"us-east-2",us_gov_east_1:"us-gov-east-1",us_gov_west_1:"us-gov-west-1",us_west_1:"us-west-1",us_west_2:"us-west-2"},ObjectOwnership={BucketOwnerEnforced:"BucketOwnerEnforced",BucketOwnerPreferred:"BucketOwnerPreferred",ObjectWriter:"ObjectWriter"},SessionMode={ReadOnly:"ReadOnly",ReadWrite:"ReadWrite"},NoSuchBucket=class _NoSuchBucket extends S3ServiceException{constructor(opts){super({name:"NoSuchBucket",$fault:"client",...opts});this.name="NoSuchBucket";this.$fault="client";Object.setPrototypeOf(this,_NoSuchBucket.prototype)}};(AnalyticsFilter||(AnalyticsFilter={})).visit=(value,visitor)=>{if(void 0!==value.Prefix)return visitor.Prefix(value.Prefix);if(void 0!==value.Tag)return visitor.Tag(value.Tag);if(void 0!==value.And)return visitor.And(value.And);else return visitor._(value.$unknown[0],value.$unknown[1])};var LifecycleRuleFilter,AnalyticsS3ExportFileFormat={CSV:"CSV"},StorageClassAnalysisSchemaVersion={V_1:"V_1"},IntelligentTieringStatus={Disabled:"Disabled",Enabled:"Enabled"},IntelligentTieringAccessTier={ARCHIVE_ACCESS:"ARCHIVE_ACCESS",DEEP_ARCHIVE_ACCESS:"DEEP_ARCHIVE_ACCESS"},InventoryFormat={CSV:"CSV",ORC:"ORC",Parquet:"Parquet"},InventoryIncludedObjectVersions={All:"All",Current:"Current"},InventoryOptionalField={BucketKeyStatus:"BucketKeyStatus",ChecksumAlgorithm:"ChecksumAlgorithm",ETag:"ETag",EncryptionStatus:"EncryptionStatus",IntelligentTieringAccessTier:"IntelligentTieringAccessTier",IsMultipartUploaded:"IsMultipartUploaded",LastModifiedDate:"LastModifiedDate",ObjectAccessControlList:"ObjectAccessControlList",ObjectLockLegalHoldStatus:"ObjectLockLegalHoldStatus",ObjectLockMode:"ObjectLockMode",ObjectLockRetainUntilDate:"ObjectLockRetainUntilDate",ObjectOwner:"ObjectOwner",ReplicationStatus:"ReplicationStatus",Size:"Size",StorageClass:"StorageClass"},InventoryFrequency={Daily:"Daily",Weekly:"Weekly"};(LifecycleRuleFilter||(LifecycleRuleFilter={})).visit=(value,visitor)=>{if(void 0!==value.Prefix)return visitor.Prefix(value.Prefix);if(void 0!==value.Tag)return visitor.Tag(value.Tag);if(void 0!==value.ObjectSizeGreaterThan)return visitor.ObjectSizeGreaterThan(value.ObjectSizeGreaterThan);if(void 0!==value.ObjectSizeLessThan)return visitor.ObjectSizeLessThan(value.ObjectSizeLessThan);if(void 0!==value.And)return visitor.And(value.And);else return visitor._(value.$unknown[0],value.$unknown[1])};var MetricsFilter,TransitionStorageClass={DEEP_ARCHIVE:"DEEP_ARCHIVE",GLACIER:"GLACIER",GLACIER_IR:"GLACIER_IR",INTELLIGENT_TIERING:"INTELLIGENT_TIERING",ONEZONE_IA:"ONEZONE_IA",STANDARD_IA:"STANDARD_IA"},ExpirationStatus={Disabled:"Disabled",Enabled:"Enabled"},BucketLogsPermission={FULL_CONTROL:"FULL_CONTROL",READ:"READ",WRITE:"WRITE"},PartitionDateSource={DeliveryTime:"DeliveryTime",EventTime:"EventTime"};(MetricsFilter||(MetricsFilter={})).visit=(value,visitor)=>{if(void 0!==value.Prefix)return visitor.Prefix(value.Prefix);if(void 0!==value.Tag)return visitor.Tag(value.Tag);if(void 0!==value.AccessPointArn)return visitor.AccessPointArn(value.AccessPointArn);if(void 0!==value.And)return visitor.And(value.And);else return visitor._(value.$unknown[0],value.$unknown[1])};var ReplicationRuleFilter,Event={s3_IntelligentTiering:"s3:IntelligentTiering",s3_LifecycleExpiration_:"s3:LifecycleExpiration:*",s3_LifecycleExpiration_Delete:"s3:LifecycleExpiration:Delete",s3_LifecycleExpiration_DeleteMarkerCreated:"s3:LifecycleExpiration:DeleteMarkerCreated",s3_LifecycleTransition:"s3:LifecycleTransition",s3_ObjectAcl_Put:"s3:ObjectAcl:Put",s3_ObjectCreated_:"s3:ObjectCreated:*",s3_ObjectCreated_CompleteMultipartUpload:"s3:ObjectCreated:CompleteMultipartUpload",s3_ObjectCreated_Copy:"s3:ObjectCreated:Copy",s3_ObjectCreated_Post:"s3:ObjectCreated:Post",s3_ObjectCreated_Put:"s3:ObjectCreated:Put",s3_ObjectRemoved_:"s3:ObjectRemoved:*",s3_ObjectRemoved_Delete:"s3:ObjectRemoved:Delete",s3_ObjectRemoved_DeleteMarkerCreated:"s3:ObjectRemoved:DeleteMarkerCreated",s3_ObjectRestore_:"s3:ObjectRestore:*",s3_ObjectRestore_Completed:"s3:ObjectRestore:Completed",s3_ObjectRestore_Delete:"s3:ObjectRestore:Delete",s3_ObjectRestore_Post:"s3:ObjectRestore:Post",s3_ObjectTagging_:"s3:ObjectTagging:*",s3_ObjectTagging_Delete:"s3:ObjectTagging:Delete",s3_ObjectTagging_Put:"s3:ObjectTagging:Put",s3_ReducedRedundancyLostObject:"s3:ReducedRedundancyLostObject",s3_Replication_:"s3:Replication:*",s3_Replication_OperationFailedReplication:"s3:Replication:OperationFailedReplication",s3_Replication_OperationMissedThreshold:"s3:Replication:OperationMissedThreshold",s3_Replication_OperationNotTracked:"s3:Replication:OperationNotTracked",s3_Replication_OperationReplicatedAfterThreshold:"s3:Replication:OperationReplicatedAfterThreshold"},FilterRuleName={prefix:"prefix",suffix:"suffix"},DeleteMarkerReplicationStatus={Disabled:"Disabled",Enabled:"Enabled"},MetricsStatus={Disabled:"Disabled",Enabled:"Enabled"},ReplicationTimeStatus={Disabled:"Disabled",Enabled:"Enabled"},ExistingObjectReplicationStatus={Disabled:"Disabled",Enabled:"Enabled"};(ReplicationRuleFilter||(ReplicationRuleFilter={})).visit=(value,visitor)=>{if(void 0!==value.Prefix)return visitor.Prefix(value.Prefix);if(void 0!==value.Tag)return visitor.Tag(value.Tag);if(void 0!==value.And)return visitor.And(value.And);else return visitor._(value.$unknown[0],value.$unknown[1])};var ReplicaModificationsStatus={Disabled:"Disabled",Enabled:"Enabled"},SseKmsEncryptedObjectsStatus={Disabled:"Disabled",Enabled:"Enabled"},ReplicationRuleStatus={Disabled:"Disabled",Enabled:"Enabled"},Payer={BucketOwner:"BucketOwner",Requester:"Requester"},MFADeleteStatus={Disabled:"Disabled",Enabled:"Enabled"},BucketVersioningStatus={Enabled:"Enabled",Suspended:"Suspended"},Protocol={http:"http",https:"https"},ReplicationStatus={COMPLETE:"COMPLETE",COMPLETED:"COMPLETED",FAILED:"FAILED",PENDING:"PENDING",REPLICA:"REPLICA"},ChecksumMode={ENABLED:"ENABLED"},InvalidObjectState=class _InvalidObjectState extends S3ServiceException{constructor(opts){super({name:"InvalidObjectState",$fault:"client",...opts});this.name="InvalidObjectState";this.$fault="client";Object.setPrototypeOf(this,_InvalidObjectState.prototype);this.StorageClass=opts.StorageClass;this.AccessTier=opts.AccessTier}},NoSuchKey=class _NoSuchKey extends S3ServiceException{constructor(opts){super({name:"NoSuchKey",$fault:"client",...opts});this.name="NoSuchKey";this.$fault="client";Object.setPrototypeOf(this,_NoSuchKey.prototype)}},ObjectAttributes={CHECKSUM:"Checksum",ETAG:"ETag",OBJECT_PARTS:"ObjectParts",OBJECT_SIZE:"ObjectSize",STORAGE_CLASS:"StorageClass"},ObjectLockEnabled={Enabled:"Enabled"},ObjectLockRetentionMode={COMPLIANCE:"COMPLIANCE",GOVERNANCE:"GOVERNANCE"},NotFound=class _NotFound extends S3ServiceException{constructor(opts){super({name:"NotFound",$fault:"client",...opts});this.name="NotFound";this.$fault="client";Object.setPrototypeOf(this,_NotFound.prototype)}},ArchiveStatus={ARCHIVE_ACCESS:"ARCHIVE_ACCESS",DEEP_ARCHIVE_ACCESS:"DEEP_ARCHIVE_ACCESS"},EncodingType={url:"url"},ObjectStorageClass={DEEP_ARCHIVE:"DEEP_ARCHIVE",EXPRESS_ONEZONE:"EXPRESS_ONEZONE",GLACIER:"GLACIER",GLACIER_IR:"GLACIER_IR",INTELLIGENT_TIERING:"INTELLIGENT_TIERING",ONEZONE_IA:"ONEZONE_IA",OUTPOSTS:"OUTPOSTS",REDUCED_REDUNDANCY:"REDUCED_REDUNDANCY",SNOW:"SNOW",STANDARD:"STANDARD",STANDARD_IA:"STANDARD_IA"},OptionalObjectAttributes={RESTORE_STATUS:"RestoreStatus"},ObjectVersionStorageClass={STANDARD:"STANDARD"},CompleteMultipartUploadOutputFilterSensitiveLog=obj=>({...obj,...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING}}),CompleteMultipartUploadRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING}}),CopyObjectOutputFilterSensitiveLog=obj=>({...obj,...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING},...obj.SSEKMSEncryptionContext&&{SSEKMSEncryptionContext:SENSITIVE_STRING}}),CopyObjectRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING},...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING},...obj.SSEKMSEncryptionContext&&{SSEKMSEncryptionContext:SENSITIVE_STRING},...obj.CopySourceSSECustomerKey&&{CopySourceSSECustomerKey:SENSITIVE_STRING}}),CreateMultipartUploadOutputFilterSensitiveLog=obj=>({...obj,...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING},...obj.SSEKMSEncryptionContext&&{SSEKMSEncryptionContext:SENSITIVE_STRING}}),CreateMultipartUploadRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING},...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING},...obj.SSEKMSEncryptionContext&&{SSEKMSEncryptionContext:SENSITIVE_STRING}}),SessionCredentialsFilterSensitiveLog=obj=>({...obj,...obj.SecretAccessKey&&{SecretAccessKey:SENSITIVE_STRING},...obj.SessionToken&&{SessionToken:SENSITIVE_STRING}}),CreateSessionOutputFilterSensitiveLog=obj=>({...obj,...obj.Credentials&&{Credentials:SessionCredentialsFilterSensitiveLog(obj.Credentials)}}),ServerSideEncryptionByDefaultFilterSensitiveLog=obj=>({...obj,...obj.KMSMasterKeyID&&{KMSMasterKeyID:SENSITIVE_STRING}}),ServerSideEncryptionRuleFilterSensitiveLog=obj=>({...obj,...obj.ApplyServerSideEncryptionByDefault&&{ApplyServerSideEncryptionByDefault:ServerSideEncryptionByDefaultFilterSensitiveLog(obj.ApplyServerSideEncryptionByDefault)}}),ServerSideEncryptionConfigurationFilterSensitiveLog=obj=>({...obj,...obj.Rules&&{Rules:obj.Rules.map((item=>ServerSideEncryptionRuleFilterSensitiveLog(item)))}}),GetBucketEncryptionOutputFilterSensitiveLog=obj=>({...obj,...obj.ServerSideEncryptionConfiguration&&{ServerSideEncryptionConfiguration:ServerSideEncryptionConfigurationFilterSensitiveLog(obj.ServerSideEncryptionConfiguration)}}),SSEKMSFilterSensitiveLog=obj=>({...obj,...obj.KeyId&&{KeyId:SENSITIVE_STRING}}),InventoryEncryptionFilterSensitiveLog=obj=>({...obj,...obj.SSEKMS&&{SSEKMS:SSEKMSFilterSensitiveLog(obj.SSEKMS)}}),InventoryS3BucketDestinationFilterSensitiveLog=obj=>({...obj,...obj.Encryption&&{Encryption:InventoryEncryptionFilterSensitiveLog(obj.Encryption)}}),InventoryDestinationFilterSensitiveLog=obj=>({...obj,...obj.S3BucketDestination&&{S3BucketDestination:InventoryS3BucketDestinationFilterSensitiveLog(obj.S3BucketDestination)}}),InventoryConfigurationFilterSensitiveLog=obj=>({...obj,...obj.Destination&&{Destination:InventoryDestinationFilterSensitiveLog(obj.Destination)}}),GetBucketInventoryConfigurationOutputFilterSensitiveLog=obj=>({...obj,...obj.InventoryConfiguration&&{InventoryConfiguration:InventoryConfigurationFilterSensitiveLog(obj.InventoryConfiguration)}}),GetObjectOutputFilterSensitiveLog=obj=>({...obj,...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING}}),GetObjectRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING}}),GetObjectAttributesRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING}}),GetObjectTorrentOutputFilterSensitiveLog=obj=>({...obj}),HeadObjectOutputFilterSensitiveLog=obj=>({...obj,...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING}}),HeadObjectRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING}}),ListBucketInventoryConfigurationsOutputFilterSensitiveLog=obj=>({...obj,...obj.InventoryConfigurationList&&{InventoryConfigurationList:obj.InventoryConfigurationList.map((item=>InventoryConfigurationFilterSensitiveLog(item)))}}),ListPartsRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING}}),PutBucketEncryptionRequestFilterSensitiveLog=obj=>({...obj,...obj.ServerSideEncryptionConfiguration&&{ServerSideEncryptionConfiguration:ServerSideEncryptionConfigurationFilterSensitiveLog(obj.ServerSideEncryptionConfiguration)}}),PutBucketInventoryConfigurationRequestFilterSensitiveLog=obj=>({...obj,...obj.InventoryConfiguration&&{InventoryConfiguration:InventoryConfigurationFilterSensitiveLog(obj.InventoryConfiguration)}});function escapeAttribute(value){return value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function escapeElement(value){return value.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r/g,"&#x0D;").replace(/\n/g,"&#x0A;").replace(/\u0085/g,"&#x85;").replace(/\u2028/,"&#x2028;")}var SelectObjectContentEventStream,XmlText=class{constructor(value){this.value=value}toString(){return escapeElement(""+this.value)}},XmlNode=class _XmlNode{static of(name,childText,withName){const node=new _XmlNode(name);if(void 0!==childText)node.addChildNode(new XmlText(childText));if(void 0!==withName)node.withName(withName);return node}constructor(name,children2=[]){this.name=name;this.children=children2;this.attributes={}}withName(name){this.name=name;return this}addAttribute(name,value){this.attributes[name]=value;return this}addChildNode(child){this.children.push(child);return this}removeAttribute(name){delete this.attributes[name];return this}n(name){this.name=name;return this}c(child){this.children.push(child);return this}a(name,value){if(null!=value)this.attributes[name]=value;return this}cc(input,field,withName=field){if(null!=input[field]){const node=_XmlNode.of(field,input[field]).withName(withName);this.c(node)}}l(input,listName,memberName,valueProvider){if(null!=input[listName])valueProvider().map((node=>{node.withName(memberName);this.c(node)}))}lc(input,listName,memberName,valueProvider){if(null!=input[listName]){const nodes=valueProvider(),containerNode=new _XmlNode(memberName);nodes.map((node=>{containerNode.c(node)}));this.c(containerNode)}}toString(){const hasChildren=Boolean(this.children.length);let xmlText=`<${this.name}`;const attributes=this.attributes;for(const attributeName of Object.keys(attributes)){const attribute=attributes[attributeName];if(null!=attribute)xmlText+=` ${attributeName}="${escapeAttribute(""+attribute)}"`}return xmlText+(!hasChildren?"/>":`>${this.children.map((c2=>c2.toString())).join("")}</${this.name}>`)}},MFADelete={Disabled:"Disabled",Enabled:"Enabled"},ObjectAlreadyInActiveTierError=class _ObjectAlreadyInActiveTierError extends S3ServiceException{constructor(opts){super({name:"ObjectAlreadyInActiveTierError",$fault:"client",...opts});this.name="ObjectAlreadyInActiveTierError";this.$fault="client";Object.setPrototypeOf(this,_ObjectAlreadyInActiveTierError.prototype)}},Tier={Bulk:"Bulk",Expedited:"Expedited",Standard:"Standard"},ExpressionType={SQL:"SQL"},CompressionType={BZIP2:"BZIP2",GZIP:"GZIP",NONE:"NONE"},FileHeaderInfo={IGNORE:"IGNORE",NONE:"NONE",USE:"USE"},JSONType={DOCUMENT:"DOCUMENT",LINES:"LINES"},QuoteFields={ALWAYS:"ALWAYS",ASNEEDED:"ASNEEDED"},RestoreRequestType={SELECT:"SELECT"};(SelectObjectContentEventStream||(SelectObjectContentEventStream={})).visit=(value,visitor)=>{if(void 0!==value.Records)return visitor.Records(value.Records);if(void 0!==value.Stats)return visitor.Stats(value.Stats);if(void 0!==value.Progress)return visitor.Progress(value.Progress);if(void 0!==value.Cont)return visitor.Cont(value.Cont);if(void 0!==value.End)return visitor.End(value.End);else return visitor._(value.$unknown[0],value.$unknown[1])};var PutObjectOutputFilterSensitiveLog=obj=>({...obj,...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING},...obj.SSEKMSEncryptionContext&&{SSEKMSEncryptionContext:SENSITIVE_STRING}}),PutObjectRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING},...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING},...obj.SSEKMSEncryptionContext&&{SSEKMSEncryptionContext:SENSITIVE_STRING}}),EncryptionFilterSensitiveLog=obj=>({...obj,...obj.KMSKeyId&&{KMSKeyId:SENSITIVE_STRING}}),S3LocationFilterSensitiveLog=obj=>({...obj,...obj.Encryption&&{Encryption:EncryptionFilterSensitiveLog(obj.Encryption)}}),OutputLocationFilterSensitiveLog=obj=>({...obj,...obj.S3&&{S3:S3LocationFilterSensitiveLog(obj.S3)}}),RestoreRequestFilterSensitiveLog=obj=>({...obj,...obj.OutputLocation&&{OutputLocation:OutputLocationFilterSensitiveLog(obj.OutputLocation)}}),RestoreObjectRequestFilterSensitiveLog=obj=>({...obj,...obj.RestoreRequest&&{RestoreRequest:RestoreRequestFilterSensitiveLog(obj.RestoreRequest)}}),SelectObjectContentEventStreamFilterSensitiveLog=obj=>{if(void 0!==obj.Records)return{Records:obj.Records};if(void 0!==obj.Stats)return{Stats:obj.Stats};if(void 0!==obj.Progress)return{Progress:obj.Progress};if(void 0!==obj.Cont)return{Cont:obj.Cont};if(void 0!==obj.End)return{End:obj.End};if(void 0!==obj.$unknown)return{[obj.$unknown[0]]:"UNKNOWN"}},SelectObjectContentOutputFilterSensitiveLog=obj=>({...obj,...obj.Payload&&{Payload:"STREAMING_CONTENT"}}),SelectObjectContentRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING}}),UploadPartOutputFilterSensitiveLog=obj=>({...obj,...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING}}),UploadPartRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING}}),UploadPartCopyOutputFilterSensitiveLog=obj=>({...obj,...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING}}),UploadPartCopyRequestFilterSensitiveLog=obj=>({...obj,...obj.SSECustomerKey&&{SSECustomerKey:SENSITIVE_STRING},...obj.CopySourceSSECustomerKey&&{CopySourceSSECustomerKey:SENSITIVE_STRING}}),WriteGetObjectResponseRequestFilterSensitiveLog=obj=>({...obj,...obj.SSEKMSKeyId&&{SSEKMSKeyId:SENSITIVE_STRING}}),se_AbortMultipartUploadCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xarp]:input[_RP],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_xi]:[,"AbortMultipartUpload"],[_uI]:[,expectNonNull(input[_UI],"UploadId")]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_CompleteMultipartUploadCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xacc]:input[_CCRC],[_xacc_]:input[_CCRCC],[_xacs]:input[_CSHA],[_xacs_]:input[_CSHAh],[_xarp]:input[_RP],[_xaebo]:input[_EBO],[_inm]:input[_INM],[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_uI]:[,expectNonNull(input[_UI],"UploadId")]});let body,contents;if(void 0!==input.MultipartUpload){contents=se_CompletedMultipartUpload(input.MultipartUpload,context2);contents=contents.n("CompleteMultipartUpload");body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("POST").h(headers).q(query3).b(body);return b3.build()},se_CopyObjectCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaa]:input[_ACL],[_cc]:input[_CC],[_xaca]:input[_CA],[_cd]:input[_CD],[_ce]:input[_CE],[_cl]:input[_CL],[_ct]:input[_CT],[_xacs__]:input[_CS],[_xacsim]:input[_CSIM],[_xacsims]:[()=>isSerializableHeaderValue(input[_CSIMS]),()=>dateToUtcString(input[_CSIMS]).toString()],[_xacsinm]:input[_CSINM],[_xacsius]:[()=>isSerializableHeaderValue(input[_CSIUS]),()=>dateToUtcString(input[_CSIUS]).toString()],[_e]:[()=>isSerializableHeaderValue(input[_E]),()=>dateToUtcString(input[_E]).toString()],[_xagfc]:input[_GFC],[_xagr]:input[_GR],[_xagra]:input[_GRACP],[_xagwa]:input[_GWACP],[_xamd]:input[_MD],[_xatd]:input[_TD],[_xasse]:input[_SSE],[_xasc]:input[_SC],[_xawrl]:input[_WRL],[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD],[_xasseakki]:input[_SSEKMSKI],[_xassec]:input[_SSEKMSEC],[_xassebke]:[()=>isSerializableHeaderValue(input[_BKE]),()=>input[_BKE].toString()],[_xacssseca]:input[_CSSSECA],[_xacssseck]:input[_CSSSECK],[_xacssseckm]:input[_CSSSECKMD],[_xarp]:input[_RP],[_xat]:input[_T],[_xaolm]:input[_OLM],[_xaolrud]:[()=>isSerializableHeaderValue(input[_OLRUD]),()=>serializeDateTime(input[_OLRUD]).toString()],[_xaollh]:input[_OLLHS],[_xaebo]:input[_EBO],[_xasebo]:input[_ESBO],...void 0!==input.Metadata&&Object.keys(input.Metadata).reduce(((acc,suffix)=>{acc[`x-amz-meta-${suffix.toLowerCase()}`]=input.Metadata[suffix];return acc}),{})});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_xi]:[,"CopyObject"]});b3.m("PUT").h(headers).q(query3).b(void 0);return b3.build()},se_CreateBucketCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xaa]:input[_ACL],[_xagfc]:input[_GFC],[_xagr]:input[_GR],[_xagra]:input[_GRACP],[_xagw]:input[_GW],[_xagwa]:input[_GWACP],[_xabole]:[()=>isSerializableHeaderValue(input[_OLEFB]),()=>input[_OLEFB].toString()],[_xaoo]:input[_OO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);let body,contents;if(void 0!==input.CreateBucketConfiguration){contents=se_CreateBucketConfiguration(input.CreateBucketConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).b(body);return b3.build()},se_CreateMultipartUploadCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaa]:input[_ACL],[_cc]:input[_CC],[_cd]:input[_CD],[_ce]:input[_CE],[_cl]:input[_CL],[_ct]:input[_CT],[_e]:[()=>isSerializableHeaderValue(input[_E]),()=>dateToUtcString(input[_E]).toString()],[_xagfc]:input[_GFC],[_xagr]:input[_GR],[_xagra]:input[_GRACP],[_xagwa]:input[_GWACP],[_xasse]:input[_SSE],[_xasc]:input[_SC],[_xawrl]:input[_WRL],[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD],[_xasseakki]:input[_SSEKMSKI],[_xassec]:input[_SSEKMSEC],[_xassebke]:[()=>isSerializableHeaderValue(input[_BKE]),()=>input[_BKE].toString()],[_xarp]:input[_RP],[_xat]:input[_T],[_xaolm]:input[_OLM],[_xaolrud]:[()=>isSerializableHeaderValue(input[_OLRUD]),()=>serializeDateTime(input[_OLRUD]).toString()],[_xaollh]:input[_OLLHS],[_xaebo]:input[_EBO],[_xaca]:input[_CA],...void 0!==input.Metadata&&Object.keys(input.Metadata).reduce(((acc,suffix)=>{acc[`x-amz-meta-${suffix.toLowerCase()}`]=input.Metadata[suffix];return acc}),{})});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_u]:[,""]});b3.m("POST").h(headers).q(query3).b(void 0);return b3.build()},se_CreateSessionCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xacsm]:input[_SM]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_s]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.m("DELETE").h(headers).b(void 0);return b3.build()},se_DeleteBucketAnalyticsConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_a3]:[,""],[_i]:[,expectNonNull(input[_I],"Id")]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketCorsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_c]:[,""]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketEncryptionCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_en]:[,""]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketIntelligentTieringConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2);b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_it]:[,""],[_i]:[,expectNonNull(input[_I],"Id")]});b3.m("DELETE").h({}).q(query3).b(void 0);return b3.build()},se_DeleteBucketInventoryConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_in]:[,""],[_i]:[,expectNonNull(input[_I],"Id")]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketLifecycleCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_l]:[,""]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketMetricsConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_m]:[,""],[_i]:[,expectNonNull(input[_I],"Id")]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketOwnershipControlsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_oC]:[,""]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketPolicyCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_p]:[,""]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketReplicationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_r]:[,""]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketTaggingCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_t]:[,""]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteBucketWebsiteCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_w]:[,""]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteObjectCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xam]:input[_MFA],[_xarp]:input[_RP],[_xabgr]:[()=>isSerializableHeaderValue(input[_BGR]),()=>input[_BGR].toString()],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_xi]:[,"DeleteObject"],[_vI]:[,input[_VI]]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeleteObjectsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xam]:input[_MFA],[_xarp]:input[_RP],[_xabgr]:[()=>isSerializableHeaderValue(input[_BGR]),()=>input[_BGR].toString()],[_xaebo]:input[_EBO],[_xasca]:input[_CA]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_d]:[,""]});let body,contents;if(void 0!==input.Delete){contents=se_Delete(input.Delete,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("POST").h(headers).q(query3).b(body);return b3.build()},se_DeleteObjectTaggingCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_t]:[,""],[_vI]:[,input[_VI]]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_DeletePublicAccessBlockCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_pAB]:[,""]});b3.m("DELETE").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketAccelerateConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO],[_xarp]:input[_RP]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_ac]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketAclCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_acl]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketAnalyticsConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_a3]:[,""],[_xi]:[,"GetBucketAnalyticsConfiguration"],[_i]:[,expectNonNull(input[_I],"Id")]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketCorsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_c]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketEncryptionCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_en]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketIntelligentTieringConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2);b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_it]:[,""],[_xi]:[,"GetBucketIntelligentTieringConfiguration"],[_i]:[,expectNonNull(input[_I],"Id")]});b3.m("GET").h({}).q(query3).b(void 0);return b3.build()},se_GetBucketInventoryConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_in]:[,""],[_xi]:[,"GetBucketInventoryConfiguration"],[_i]:[,expectNonNull(input[_I],"Id")]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketLifecycleConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_l]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketLocationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_lo]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketLoggingCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_log]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketMetricsConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_m]:[,""],[_xi]:[,"GetBucketMetricsConfiguration"],[_i]:[,expectNonNull(input[_I],"Id")]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketNotificationConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_n]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketOwnershipControlsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_oC]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketPolicyCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_p]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketPolicyStatusCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_pS]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketReplicationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_r]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketRequestPaymentCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_rP]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketTaggingCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_t]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketVersioningCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_v]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetBucketWebsiteCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_w]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetObjectCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_im]:input[_IM],[_ims]:[()=>isSerializableHeaderValue(input[_IMS]),()=>dateToUtcString(input[_IMS]).toString()],[_inm]:input[_INM],[_ius]:[()=>isSerializableHeaderValue(input[_IUS]),()=>dateToUtcString(input[_IUS]).toString()],[_ra]:input[_R],[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD],[_xarp]:input[_RP],[_xaebo]:input[_EBO],[_xacm]:input[_CM]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_xi]:[,"GetObject"],[_rcc]:[,input[_RCC]],[_rcd]:[,input[_RCD]],[_rce]:[,input[_RCE]],[_rcl]:[,input[_RCL]],[_rct]:[,input[_RCT]],[_re]:[()=>void 0!==input.ResponseExpires,()=>dateToUtcString(input[_RE]).toString()],[_vI]:[,input[_VI]],[_pN]:[()=>void 0!==input.PartNumber,()=>input[_PN].toString()]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetObjectAclCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xarp]:input[_RP],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_acl]:[,""],[_vI]:[,input[_VI]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetObjectAttributesCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xamp]:[()=>isSerializableHeaderValue(input[_MP]),()=>input[_MP].toString()],[_xapnm]:input[_PNM],[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD],[_xarp]:input[_RP],[_xaebo]:input[_EBO],[_xaoa]:[()=>isSerializableHeaderValue(input[_OA]),()=>(input[_OA]||[]).map((_entry=>_entry)).join(", ")]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_at]:[,""],[_vI]:[,input[_VI]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetObjectLegalHoldCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xarp]:input[_RP],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_lh]:[,""],[_vI]:[,input[_VI]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetObjectLockConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_ol]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetObjectRetentionCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xarp]:input[_RP],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_ret]:[,""],[_vI]:[,input[_VI]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetObjectTaggingCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO],[_xarp]:input[_RP]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_t]:[,""],[_vI]:[,input[_VI]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetObjectTorrentCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xarp]:input[_RP],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_to]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_GetPublicAccessBlockCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_pAB]:[,""]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_HeadBucketCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.m("HEAD").h(headers).b(void 0);return b3.build()},se_HeadObjectCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_im]:input[_IM],[_ims]:[()=>isSerializableHeaderValue(input[_IMS]),()=>dateToUtcString(input[_IMS]).toString()],[_inm]:input[_INM],[_ius]:[()=>isSerializableHeaderValue(input[_IUS]),()=>dateToUtcString(input[_IUS]).toString()],[_ra]:input[_R],[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD],[_xarp]:input[_RP],[_xaebo]:input[_EBO],[_xacm]:input[_CM]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_rcc]:[,input[_RCC]],[_rcd]:[,input[_RCD]],[_rce]:[,input[_RCE]],[_rcl]:[,input[_RCL]],[_rct]:[,input[_RCT]],[_re]:[()=>void 0!==input.ResponseExpires,()=>dateToUtcString(input[_RE]).toString()],[_vI]:[,input[_VI]],[_pN]:[()=>void 0!==input.PartNumber,()=>input[_PN].toString()]});b3.m("HEAD").h(headers).q(query3).b(void 0);return b3.build()},se_ListBucketAnalyticsConfigurationsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_a3]:[,""],[_xi]:[,"ListBucketAnalyticsConfigurations"],[_ct_]:[,input[_CTo]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_ListBucketIntelligentTieringConfigurationsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2);b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_it]:[,""],[_xi]:[,"ListBucketIntelligentTieringConfigurations"],[_ct_]:[,input[_CTo]]});b3.m("GET").h({}).q(query3).b(void 0);return b3.build()},se_ListBucketInventoryConfigurationsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_in]:[,""],[_xi]:[,"ListBucketInventoryConfigurations"],[_ct_]:[,input[_CTo]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_ListBucketMetricsConfigurationsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_m]:[,""],[_xi]:[,"ListBucketMetricsConfigurations"],[_ct_]:[,input[_CTo]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_ListBucketsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2);b3.bp("/");const query3=map({[_xi]:[,"ListBuckets"],[_mb]:[()=>void 0!==input.MaxBuckets,()=>input[_MB].toString()],[_ct_]:[,input[_CTo]]});b3.m("GET").h({}).q(query3).b(void 0);return b3.build()},se_ListDirectoryBucketsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2);b3.bp("/");const query3=map({[_xi]:[,"ListDirectoryBuckets"],[_ct_]:[,input[_CTo]],[_mdb]:[()=>void 0!==input.MaxDirectoryBuckets,()=>input[_MDB].toString()]});b3.m("GET").h({}).q(query3).b(void 0);return b3.build()},se_ListMultipartUploadsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO],[_xarp]:input[_RP]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_u]:[,""],[_de]:[,input[_D]],[_et]:[,input[_ET]],[_km]:[,input[_KM]],[_mu]:[()=>void 0!==input.MaxUploads,()=>input[_MU].toString()],[_pr]:[,input[_P]],[_uim]:[,input[_UIM]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_ListObjectsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xarp]:input[_RP],[_xaebo]:input[_EBO],[_xaooa]:[()=>isSerializableHeaderValue(input[_OOA]),()=>(input[_OOA]||[]).map((_entry=>_entry)).join(", ")]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_de]:[,input[_D]],[_et]:[,input[_ET]],[_ma]:[,input[_M]],[_mk]:[()=>void 0!==input.MaxKeys,()=>input[_MK].toString()],[_pr]:[,input[_P]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_ListObjectsV2Command=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xarp]:input[_RP],[_xaebo]:input[_EBO],[_xaooa]:[()=>isSerializableHeaderValue(input[_OOA]),()=>(input[_OOA]||[]).map((_entry=>_entry)).join(", ")]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_lt]:[,"2"],[_de]:[,input[_D]],[_et]:[,input[_ET]],[_mk]:[()=>void 0!==input.MaxKeys,()=>input[_MK].toString()],[_pr]:[,input[_P]],[_ct_]:[,input[_CTo]],[_fo]:[()=>void 0!==input.FetchOwner,()=>input[_FO].toString()],[_sa]:[,input[_SA]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_ListObjectVersionsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xaebo]:input[_EBO],[_xarp]:input[_RP],[_xaooa]:[()=>isSerializableHeaderValue(input[_OOA]),()=>(input[_OOA]||[]).map((_entry=>_entry)).join(", ")]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_ver]:[,""],[_de]:[,input[_D]],[_et]:[,input[_ET]],[_km]:[,input[_KM]],[_mk]:[()=>void 0!==input.MaxKeys,()=>input[_MK].toString()],[_pr]:[,input[_P]],[_vim]:[,input[_VIM]]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_ListPartsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xarp]:input[_RP],[_xaebo]:input[_EBO],[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_xi]:[,"ListParts"],[_mp]:[()=>void 0!==input.MaxParts,()=>input[_MP].toString()],[_pnm]:[,input[_PNM]],[_uI]:[,expectNonNull(input[_UI],"UploadId")]});b3.m("GET").h(headers).q(query3).b(void 0);return b3.build()},se_PutBucketAccelerateConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xaebo]:input[_EBO],[_xasca]:input[_CA]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_ac]:[,""]});let body,contents;if(void 0!==input.AccelerateConfiguration){contents=se_AccelerateConfiguration(input.AccelerateConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketAclCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xaa]:input[_ACL],[_cm]:input[_CMD],[_xasca]:input[_CA],[_xagfc]:input[_GFC],[_xagr]:input[_GR],[_xagra]:input[_GRACP],[_xagw]:input[_GW],[_xagwa]:input[_GWACP],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_acl]:[,""]});let body,contents;if(void 0!==input.AccessControlPolicy){contents=se_AccessControlPolicy(input.AccessControlPolicy,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketAnalyticsConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_a3]:[,""],[_i]:[,expectNonNull(input[_I],"Id")]});let body,contents;if(void 0!==input.AnalyticsConfiguration){contents=se_AnalyticsConfiguration(input.AnalyticsConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketCorsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_c]:[,""]});let body,contents;if(void 0!==input.CORSConfiguration){contents=se_CORSConfiguration(input.CORSConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketEncryptionCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_en]:[,""]});let body,contents;if(void 0!==input.ServerSideEncryptionConfiguration){contents=se_ServerSideEncryptionConfiguration(input.ServerSideEncryptionConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketIntelligentTieringConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2);b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_it]:[,""],[_i]:[,expectNonNull(input[_I],"Id")]});let body,contents;if(void 0!==input.IntelligentTieringConfiguration){contents=se_IntelligentTieringConfiguration(input.IntelligentTieringConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h({"content-type":"application/xml"}).q(query3).b(body);return b3.build()},se_PutBucketInventoryConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_in]:[,""],[_i]:[,expectNonNull(input[_I],"Id")]});let body,contents;if(void 0!==input.InventoryConfiguration){contents=se_InventoryConfiguration(input.InventoryConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketLifecycleConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_l]:[,""]});let body,contents;if(void 0!==input.LifecycleConfiguration){contents=se_BucketLifecycleConfiguration(input.LifecycleConfiguration,context2);contents=contents.n("LifecycleConfiguration");body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketLoggingCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_log]:[,""]});let body,contents;if(void 0!==input.BucketLoggingStatus){contents=se_BucketLoggingStatus(input.BucketLoggingStatus,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketMetricsConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_m]:[,""],[_i]:[,expectNonNull(input[_I],"Id")]});let body,contents;if(void 0!==input.MetricsConfiguration){contents=se_MetricsConfiguration(input.MetricsConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketNotificationConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xaebo]:input[_EBO],[_xasdv]:[()=>isSerializableHeaderValue(input[_SDV]),()=>input[_SDV].toString()]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_n]:[,""]});let body,contents;if(void 0!==input.NotificationConfiguration){contents=se_NotificationConfiguration(input.NotificationConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketOwnershipControlsCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_oC]:[,""]});let body,contents;if(void 0!==input.OwnershipControls){contents=se_OwnershipControls(input.OwnershipControls,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketPolicyCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"text/plain",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xacrsba]:[()=>isSerializableHeaderValue(input[_CRSBA]),()=>input[_CRSBA].toString()],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_p]:[,""]});let body,contents;if(void 0!==input.Policy){contents=input.Policy;body=contents}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketReplicationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xabolt]:input[_To],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_r]:[,""]});let body,contents;if(void 0!==input.ReplicationConfiguration){contents=se_ReplicationConfiguration(input.ReplicationConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketRequestPaymentCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_rP]:[,""]});let body,contents;if(void 0!==input.RequestPaymentConfiguration){contents=se_RequestPaymentConfiguration(input.RequestPaymentConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketTaggingCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_t]:[,""]});let body,contents;if(void 0!==input.Tagging){contents=se_Tagging(input.Tagging,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketVersioningCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xam]:input[_MFA],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_v]:[,""]});let body,contents;if(void 0!==input.VersioningConfiguration){contents=se_VersioningConfiguration(input.VersioningConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutBucketWebsiteCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_w]:[,""]});let body,contents;if(void 0!==input.WebsiteConfiguration){contents=se_WebsiteConfiguration(input.WebsiteConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutObjectCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_ct]:input[_CT]||"application/octet-stream",[_xaa]:input[_ACL],[_cc]:input[_CC],[_cd]:input[_CD],[_ce]:input[_CE],[_cl]:input[_CL],[_cl_]:[()=>isSerializableHeaderValue(input[_CLo]),()=>input[_CLo].toString()],[_cm]:input[_CMD],[_xasca]:input[_CA],[_xacc]:input[_CCRC],[_xacc_]:input[_CCRCC],[_xacs]:input[_CSHA],[_xacs_]:input[_CSHAh],[_e]:[()=>isSerializableHeaderValue(input[_E]),()=>dateToUtcString(input[_E]).toString()],[_inm]:input[_INM],[_xagfc]:input[_GFC],[_xagr]:input[_GR],[_xagra]:input[_GRACP],[_xagwa]:input[_GWACP],[_xasse]:input[_SSE],[_xasc]:input[_SC],[_xawrl]:input[_WRL],[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD],[_xasseakki]:input[_SSEKMSKI],[_xassec]:input[_SSEKMSEC],[_xassebke]:[()=>isSerializableHeaderValue(input[_BKE]),()=>input[_BKE].toString()],[_xarp]:input[_RP],[_xat]:input[_T],[_xaolm]:input[_OLM],[_xaolrud]:[()=>isSerializableHeaderValue(input[_OLRUD]),()=>serializeDateTime(input[_OLRUD]).toString()],[_xaollh]:input[_OLLHS],[_xaebo]:input[_EBO],...void 0!==input.Metadata&&Object.keys(input.Metadata).reduce(((acc,suffix)=>{acc[`x-amz-meta-${suffix.toLowerCase()}`]=input.Metadata[suffix];return acc}),{})});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_xi]:[,"PutObject"]});let body,contents;if(void 0!==input.Body){contents=input.Body;body=contents}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutObjectAclCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xaa]:input[_ACL],[_cm]:input[_CMD],[_xasca]:input[_CA],[_xagfc]:input[_GFC],[_xagr]:input[_GR],[_xagra]:input[_GRACP],[_xagw]:input[_GW],[_xagwa]:input[_GWACP],[_xarp]:input[_RP],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_acl]:[,""],[_vI]:[,input[_VI]]});let body,contents;if(void 0!==input.AccessControlPolicy){contents=se_AccessControlPolicy(input.AccessControlPolicy,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutObjectLegalHoldCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xarp]:input[_RP],[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_lh]:[,""],[_vI]:[,input[_VI]]});let body,contents;if(void 0!==input.LegalHold){contents=se_ObjectLockLegalHold(input.LegalHold,context2);contents=contents.n("LegalHold");body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutObjectLockConfigurationCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xarp]:input[_RP],[_xabolt]:input[_To],[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_ol]:[,""]});let body,contents;if(void 0!==input.ObjectLockConfiguration){contents=se_ObjectLockConfiguration(input.ObjectLockConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutObjectRetentionCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xarp]:input[_RP],[_xabgr]:[()=>isSerializableHeaderValue(input[_BGR]),()=>input[_BGR].toString()],[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_ret]:[,""],[_vI]:[,input[_VI]]});let body,contents;if(void 0!==input.Retention){contents=se_ObjectLockRetention(input.Retention,context2);contents=contents.n("Retention");body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutObjectTaggingCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO],[_xarp]:input[_RP]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_t]:[,""],[_vI]:[,input[_VI]]});let body,contents;if(void 0!==input.Tagging){contents=se_Tagging(input.Tagging,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_PutPublicAccessBlockCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_cm]:input[_CMD],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);const query3=map({[_pAB]:[,""]});let body,contents;if(void 0!==input.PublicAccessBlockConfiguration){contents=se_PublicAccessBlockConfiguration(input.PublicAccessBlockConfiguration,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_RestoreObjectCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xarp]:input[_RP],[_xasca]:input[_CA],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_res]:[,""],[_vI]:[,input[_VI]]});let body,contents;if(void 0!==input.RestoreRequest){contents=se_RestoreRequest(input.RestoreRequest,context2);body=_ve;contents.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");body+=contents.toString()}b3.m("POST").h(headers).q(query3).b(body);return b3.build()},se_SelectObjectContentCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/xml",[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_se]:[,""],[_st]:[,"2"]});let body;body=_ve;const bn2=new XmlNode(_SOCR);bn2.a("xmlns","http://s3.amazonaws.com/doc/2006-03-01/");bn2.cc(input,_Ex);bn2.cc(input,_ETx);if(null!=input[_IS])bn2.c(se_InputSerialization(input[_IS],context2).n(_IS));if(null!=input[_OS])bn2.c(se_OutputSerialization(input[_OS],context2).n(_OS));if(null!=input[_RPe])bn2.c(se_RequestProgress(input[_RPe],context2).n(_RPe));if(null!=input[_SR])bn2.c(se_ScanRange(input[_SR],context2).n(_SR));body+=bn2.toString();b3.m("POST").h(headers).q(query3).b(body);return b3.build()},se_UploadPartCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"content-type":"application/octet-stream",[_cl_]:[()=>isSerializableHeaderValue(input[_CLo]),()=>input[_CLo].toString()],[_cm]:input[_CMD],[_xasca]:input[_CA],[_xacc]:input[_CCRC],[_xacc_]:input[_CCRCC],[_xacs]:input[_CSHA],[_xacs_]:input[_CSHAh],[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD],[_xarp]:input[_RP],[_xaebo]:input[_EBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_xi]:[,"UploadPart"],[_pN]:[null!=expectNonNull(input.PartNumber,"PartNumber"),()=>input[_PN].toString()],[_uI]:[,expectNonNull(input[_UI],"UploadId")]});let body,contents;if(void 0!==input.Body){contents=input.Body;body=contents}b3.m("PUT").h(headers).q(query3).b(body);return b3.build()},se_UploadPartCopyCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{[_xacs__]:input[_CS],[_xacsim]:input[_CSIM],[_xacsims]:[()=>isSerializableHeaderValue(input[_CSIMS]),()=>dateToUtcString(input[_CSIMS]).toString()],[_xacsinm]:input[_CSINM],[_xacsius]:[()=>isSerializableHeaderValue(input[_CSIUS]),()=>dateToUtcString(input[_CSIUS]).toString()],[_xacsr]:input[_CSR],[_xasseca]:input[_SSECA],[_xasseck]:input[_SSECK],[_xasseckm]:input[_SSECKMD],[_xacssseca]:input[_CSSSECA],[_xacssseck]:input[_CSSSECK],[_xacssseckm]:input[_CSSSECKMD],[_xarp]:input[_RP],[_xaebo]:input[_EBO],[_xasebo]:input[_ESBO]});b3.bp("/{Key+}");b3.p("Bucket",(()=>input.Bucket),"{Bucket}",false);b3.p("Key",(()=>input.Key),"{Key+}",true);const query3=map({[_xi]:[,"UploadPartCopy"],[_pN]:[null!=expectNonNull(input.PartNumber,"PartNumber"),()=>input[_PN].toString()],[_uI]:[,expectNonNull(input[_UI],"UploadId")]});b3.m("PUT").h(headers).q(query3).b(void 0);return b3.build()},se_WriteGetObjectResponseCommand=async(input,context2)=>{const b3=requestBuilder(input,context2),headers=map({},isSerializableHeaderValue,{"x-amz-content-sha256":"UNSIGNED-PAYLOAD","content-type":"application/octet-stream",[_xarr]:input[_RR],[_xart]:input[_RT],[_xafs]:[()=>isSerializableHeaderValue(input[_SCt]),()=>input[_SCt].toString()],[_xafec]:input[_EC],[_xafem]:input[_EM],[_xafhar]:input[_AR],[_xafhcc]:input[_CC],[_xafhcd]:input[_CD],[_xafhce]:input[_CE],[_xafhcl]:input[_CL],[_cl_]:[()=>isSerializableHeaderValue(input[_CLo]),()=>input[_CLo].toString()],[_xafhcr]:input[_CR],[_xafhct]:input[_CT],[_xafhxacc]:input[_CCRC],[_xafhxacc_]:input[_CCRCC],[_xafhxacs]:input[_CSHA],[_xafhxacs_]:input[_CSHAh],[_xafhxadm]:[()=>isSerializableHeaderValue(input[_DM]),()=>input[_DM].toString()],[_xafhe]:input[_ETa],[_xafhe_]:[()=>isSerializableHeaderValue(input[_E]),()=>dateToUtcString(input[_E]).toString()],[_xafhxae]:input[_Exp],[_xafhlm]:[()=>isSerializableHeaderValue(input[_LM]),()=>dateToUtcString(input[_LM]).toString()],[_xafhxamm]:[()=>isSerializableHeaderValue(input[_MM]),()=>input[_MM].toString()],[_xafhxaolm]:input[_OLM],[_xafhxaollh]:input[_OLLHS],[_xafhxaolrud]:[()=>isSerializableHeaderValue(input[_OLRUD]),()=>serializeDateTime(input[_OLRUD]).toString()],[_xafhxampc]:[()=>isSerializableHeaderValue(input[_PC]),()=>input[_PC].toString()],[_xafhxars]:input[_RS],[_xafhxarc]:input[_RC],[_xafhxar]:input[_Re],[_xafhxasse]:input[_SSE],[_xafhxasseca]:input[_SSECA],[_xafhxasseakki]:input[_SSEKMSKI],[_xafhxasseckm]:input[_SSECKMD],[_xafhxasc]:input[_SC],[_xafhxatc]:[()=>isSerializableHeaderValue(input[_TC]),()=>input[_TC].toString()],[_xafhxavi]:input[_VI],[_xafhxassebke]:[()=>isSerializableHeaderValue(input[_BKE]),()=>input[_BKE].toString()],...void 0!==input.Metadata&&Object.keys(input.Metadata).reduce(((acc,suffix)=>{acc[`x-amz-meta-${suffix.toLowerCase()}`]=input.Metadata[suffix];return acc}),{})});b3.bp("/WriteGetObjectResponse");let body,contents;if(void 0!==input.Body){contents=input.Body;body=contents}let{hostname:resolvedHostname}=await context2.endpoint();if(true!==context2.disableHostPrefix){resolvedHostname="{RequestRoute}."+resolvedHostname;if(void 0===input.RequestRoute)throw new Error("Empty value provided for input host prefix: RequestRoute.");resolvedHostname=resolvedHostname.replace("{RequestRoute}",input.RequestRoute);if(!isValidHostname(resolvedHostname))throw new Error("ValidationError: prefixed hostname must be hostname compatible.")}b3.hn(resolvedHostname);b3.m("POST").h(headers).b(body);return b3.build()},de_AbortMultipartUploadCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]});await collectBody(output.body,context2);return contents},de_CompleteMultipartUploadCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_Exp]:[,output.headers[_xae]],[_SSE]:[,output.headers[_xasse]],[_VI]:[,output.headers[_xavi]],[_SSEKMSKI]:[,output.headers[_xasseakki]],[_BKE]:[()=>void 0!==output.headers[_xassebke],()=>parseBoolean(output.headers[_xassebke])],[_RC]:[,output.headers[_xarc]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_B])contents[_B]=expectString(data[_B]);if(null!=data[_CCRC])contents[_CCRC]=expectString(data[_CCRC]);if(null!=data[_CCRCC])contents[_CCRCC]=expectString(data[_CCRCC]);if(null!=data[_CSHA])contents[_CSHA]=expectString(data[_CSHA]);if(null!=data[_CSHAh])contents[_CSHAh]=expectString(data[_CSHAh]);if(null!=data[_ETa])contents[_ETa]=expectString(data[_ETa]);if(null!=data[_K])contents[_K]=expectString(data[_K]);if(null!=data[_L])contents[_L]=expectString(data[_L]);return contents},de_CopyObjectCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_Exp]:[,output.headers[_xae]],[_CSVI]:[,output.headers[_xacsvi]],[_VI]:[,output.headers[_xavi]],[_SSE]:[,output.headers[_xasse]],[_SSECA]:[,output.headers[_xasseca]],[_SSECKMD]:[,output.headers[_xasseckm]],[_SSEKMSKI]:[,output.headers[_xasseakki]],[_SSEKMSEC]:[,output.headers[_xassec]],[_BKE]:[()=>void 0!==output.headers[_xassebke],()=>parseBoolean(output.headers[_xassebke])],[_RC]:[,output.headers[_xarc]]}),data=expectObject(await parseXmlBody(output.body,context2));contents.CopyObjectResult=de_CopyObjectResult(data,context2);return contents},de_CreateBucketCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_L]:[,output.headers[_lo]]});await collectBody(output.body,context2);return contents},de_CreateMultipartUploadCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_AD]:[()=>void 0!==output.headers[_xaad],()=>expectNonNull(parseRfc7231DateTime(output.headers[_xaad]))],[_ARI]:[,output.headers[_xaari]],[_SSE]:[,output.headers[_xasse]],[_SSECA]:[,output.headers[_xasseca]],[_SSECKMD]:[,output.headers[_xasseckm]],[_SSEKMSKI]:[,output.headers[_xasseakki]],[_SSEKMSEC]:[,output.headers[_xassec]],[_BKE]:[()=>void 0!==output.headers[_xassebke],()=>parseBoolean(output.headers[_xassebke])],[_RC]:[,output.headers[_xarc]],[_CA]:[,output.headers[_xaca]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_B])contents[_B]=expectString(data[_B]);if(null!=data[_K])contents[_K]=expectString(data[_K]);if(null!=data[_UI])contents[_UI]=expectString(data[_UI]);return contents},de_CreateSessionCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_C])contents[_C]=de_SessionCredentials(data[_C],context2);return contents},de_DeleteBucketCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketAnalyticsConfigurationCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketCorsCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketEncryptionCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketIntelligentTieringConfigurationCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketInventoryConfigurationCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketLifecycleCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketMetricsConfigurationCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketOwnershipControlsCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketPolicyCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketReplicationCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketTaggingCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteBucketWebsiteCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_DeleteObjectCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_DM]:[()=>void 0!==output.headers[_xadm],()=>parseBoolean(output.headers[_xadm])],[_VI]:[,output.headers[_xavi]],[_RC]:[,output.headers[_xarc]]});await collectBody(output.body,context2);return contents},de_DeleteObjectsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.Deleted)contents[_De]=[];else if(null!=data[_De])contents[_De]=de_DeletedObjects(getArrayIfSingleItem(data[_De]),context2);if(""===data.Error)contents[_Err]=[];else if(null!=data[_Er])contents[_Err]=de_Errors(getArrayIfSingleItem(data[_Er]),context2);return contents},de_DeleteObjectTaggingCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_VI]:[,output.headers[_xavi]]});await collectBody(output.body,context2);return contents},de_DeletePublicAccessBlockCommand=async(output,context2)=>{if(204!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_GetBucketAccelerateConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_S])contents[_S]=expectString(data[_S]);return contents},de_GetBucketAclCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.AccessControlList)contents[_Gr]=[];else if(null!=data[_ACLc]&&null!=data[_ACLc][_G])contents[_Gr]=de_Grants(getArrayIfSingleItem(data[_ACLc][_G]),context2);if(null!=data[_O])contents[_O]=de_Owner(data[_O],context2);return contents},de_GetBucketAnalyticsConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.AnalyticsConfiguration=de_AnalyticsConfiguration(data,context2);return contents},de_GetBucketCorsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.CORSRule)contents[_CORSRu]=[];else if(null!=data[_CORSR])contents[_CORSRu]=de_CORSRules(getArrayIfSingleItem(data[_CORSR]),context2);return contents},de_GetBucketEncryptionCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.ServerSideEncryptionConfiguration=de_ServerSideEncryptionConfiguration(data,context2);return contents},de_GetBucketIntelligentTieringConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.IntelligentTieringConfiguration=de_IntelligentTieringConfiguration(data,context2);return contents},de_GetBucketInventoryConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.InventoryConfiguration=de_InventoryConfiguration(data,context2);return contents},de_GetBucketLifecycleConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.Rule)contents[_Rul]=[];else if(null!=data[_Ru])contents[_Rul]=de_LifecycleRules(getArrayIfSingleItem(data[_Ru]),context2);return contents},de_GetBucketLocationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_LC])contents[_LC]=expectString(data[_LC]);return contents},de_GetBucketLoggingCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_LE])contents[_LE]=de_LoggingEnabled(data[_LE],context2);return contents},de_GetBucketMetricsConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.MetricsConfiguration=de_MetricsConfiguration(data,context2);return contents},de_GetBucketNotificationConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_EBC])contents[_EBC]=de_EventBridgeConfiguration(data[_EBC],context2);if(""===data.CloudFunctionConfiguration)contents[_LFC]=[];else if(null!=data[_CFC])contents[_LFC]=de_LambdaFunctionConfigurationList(getArrayIfSingleItem(data[_CFC]),context2);if(""===data.QueueConfiguration)contents[_QCu]=[];else if(null!=data[_QC])contents[_QCu]=de_QueueConfigurationList(getArrayIfSingleItem(data[_QC]),context2);if(""===data.TopicConfiguration)contents[_TCop]=[];else if(null!=data[_TCo])contents[_TCop]=de_TopicConfigurationList(getArrayIfSingleItem(data[_TCo]),context2);return contents},de_GetBucketOwnershipControlsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.OwnershipControls=de_OwnershipControls(data,context2);return contents},de_GetBucketPolicyCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=await collectBodyString2(output.body,context2);contents.Policy=expectString(data);return contents},de_GetBucketPolicyStatusCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.PolicyStatus=de_PolicyStatus(data,context2);return contents},de_GetBucketReplicationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.ReplicationConfiguration=de_ReplicationConfiguration(data,context2);return contents},de_GetBucketRequestPaymentCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_Pa])contents[_Pa]=expectString(data[_Pa]);return contents},de_GetBucketTaggingCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.TagSet)contents[_TS]=[];else if(null!=data[_TS]&&null!=data[_TS][_Ta])contents[_TS]=de_TagSet(getArrayIfSingleItem(data[_TS][_Ta]),context2);return contents},de_GetBucketVersioningCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_MDf])contents[_MFAD]=expectString(data[_MDf]);if(null!=data[_S])contents[_S]=expectString(data[_S]);return contents},de_GetBucketWebsiteCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_ED])contents[_ED]=de_ErrorDocument(data[_ED],context2);if(null!=data[_ID])contents[_ID]=de_IndexDocument(data[_ID],context2);if(null!=data[_RART])contents[_RART]=de_RedirectAllRequestsTo(data[_RART],context2);if(""===data.RoutingRules)contents[_RRo]=[];else if(null!=data[_RRo]&&null!=data[_RRo][_RRou])contents[_RRo]=de_RoutingRules(getArrayIfSingleItem(data[_RRo][_RRou]),context2);return contents},de_GetObjectCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_DM]:[()=>void 0!==output.headers[_xadm],()=>parseBoolean(output.headers[_xadm])],[_AR]:[,output.headers[_ar]],[_Exp]:[,output.headers[_xae]],[_Re]:[,output.headers[_xar]],[_LM]:[()=>void 0!==output.headers[_lm],()=>expectNonNull(parseRfc7231DateTime(output.headers[_lm]))],[_CLo]:[()=>void 0!==output.headers[_cl_],()=>strictParseLong(output.headers[_cl_])],[_ETa]:[,output.headers[_eta]],[_CCRC]:[,output.headers[_xacc]],[_CCRCC]:[,output.headers[_xacc_]],[_CSHA]:[,output.headers[_xacs]],[_CSHAh]:[,output.headers[_xacs_]],[_MM]:[()=>void 0!==output.headers[_xamm],()=>strictParseInt32(output.headers[_xamm])],[_VI]:[,output.headers[_xavi]],[_CC]:[,output.headers[_cc]],[_CD]:[,output.headers[_cd]],[_CE]:[,output.headers[_ce]],[_CL]:[,output.headers[_cl]],[_CR]:[,output.headers[_cr]],[_CT]:[,output.headers[_ct]],[_E]:[()=>void 0!==output.headers[_e],()=>expectNonNull(parseRfc7231DateTime(output.headers[_e]))],[_ES]:[,output.headers[_ex]],[_WRL]:[,output.headers[_xawrl]],[_SSE]:[,output.headers[_xasse]],[_SSECA]:[,output.headers[_xasseca]],[_SSECKMD]:[,output.headers[_xasseckm]],[_SSEKMSKI]:[,output.headers[_xasseakki]],[_BKE]:[()=>void 0!==output.headers[_xassebke],()=>parseBoolean(output.headers[_xassebke])],[_SC]:[,output.headers[_xasc]],[_RC]:[,output.headers[_xarc]],[_RS]:[,output.headers[_xars]],[_PC]:[()=>void 0!==output.headers[_xampc],()=>strictParseInt32(output.headers[_xampc])],[_TC]:[()=>void 0!==output.headers[_xatc],()=>strictParseInt32(output.headers[_xatc])],[_OLM]:[,output.headers[_xaolm]],[_OLRUD]:[()=>void 0!==output.headers[_xaolrud],()=>expectNonNull(parseRfc3339DateTimeWithOffset(output.headers[_xaolrud]))],[_OLLHS]:[,output.headers[_xaollh]],Metadata:[,Object.keys(output.headers).filter((header=>header.startsWith("x-amz-meta-"))).reduce(((acc,header)=>{acc[header.substring(11)]=output.headers[header];return acc}),{})]}),data=output.body;context2.sdkStreamMixin(data);contents.Body=data;return contents},de_GetObjectAclCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.AccessControlList)contents[_Gr]=[];else if(null!=data[_ACLc]&&null!=data[_ACLc][_G])contents[_Gr]=de_Grants(getArrayIfSingleItem(data[_ACLc][_G]),context2);if(null!=data[_O])contents[_O]=de_Owner(data[_O],context2);return contents},de_GetObjectAttributesCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_DM]:[()=>void 0!==output.headers[_xadm],()=>parseBoolean(output.headers[_xadm])],[_LM]:[()=>void 0!==output.headers[_lm],()=>expectNonNull(parseRfc7231DateTime(output.headers[_lm]))],[_VI]:[,output.headers[_xavi]],[_RC]:[,output.headers[_xarc]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_Ch])contents[_Ch]=de_Checksum(data[_Ch],context2);if(null!=data[_ETa])contents[_ETa]=expectString(data[_ETa]);if(null!=data[_OP])contents[_OP]=de_GetObjectAttributesParts(data[_OP],context2);if(null!=data[_OSb])contents[_OSb]=strictParseLong(data[_OSb]);if(null!=data[_SC])contents[_SC]=expectString(data[_SC]);return contents},de_GetObjectLegalHoldCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.LegalHold=de_ObjectLockLegalHold(data,context2);return contents},de_GetObjectLockConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.ObjectLockConfiguration=de_ObjectLockConfiguration(data,context2);return contents},de_GetObjectRetentionCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.Retention=de_ObjectLockRetention(data,context2);return contents},de_GetObjectTaggingCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_VI]:[,output.headers[_xavi]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.TagSet)contents[_TS]=[];else if(null!=data[_TS]&&null!=data[_TS][_Ta])contents[_TS]=de_TagSet(getArrayIfSingleItem(data[_TS][_Ta]),context2);return contents},de_GetObjectTorrentCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]}),data=output.body;context2.sdkStreamMixin(data);contents.Body=data;return contents},de_GetPublicAccessBlockCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectObject(await parseXmlBody(output.body,context2));contents.PublicAccessBlockConfiguration=de_PublicAccessBlockConfiguration(data,context2);return contents},de_HeadBucketCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_BLT]:[,output.headers[_xablt]],[_BLN]:[,output.headers[_xabln]],[_BR]:[,output.headers[_xabr]],[_APA]:[()=>void 0!==output.headers[_xaapa],()=>parseBoolean(output.headers[_xaapa])]});await collectBody(output.body,context2);return contents},de_HeadObjectCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_DM]:[()=>void 0!==output.headers[_xadm],()=>parseBoolean(output.headers[_xadm])],[_AR]:[,output.headers[_ar]],[_Exp]:[,output.headers[_xae]],[_Re]:[,output.headers[_xar]],[_AS]:[,output.headers[_xaas]],[_LM]:[()=>void 0!==output.headers[_lm],()=>expectNonNull(parseRfc7231DateTime(output.headers[_lm]))],[_CLo]:[()=>void 0!==output.headers[_cl_],()=>strictParseLong(output.headers[_cl_])],[_CCRC]:[,output.headers[_xacc]],[_CCRCC]:[,output.headers[_xacc_]],[_CSHA]:[,output.headers[_xacs]],[_CSHAh]:[,output.headers[_xacs_]],[_ETa]:[,output.headers[_eta]],[_MM]:[()=>void 0!==output.headers[_xamm],()=>strictParseInt32(output.headers[_xamm])],[_VI]:[,output.headers[_xavi]],[_CC]:[,output.headers[_cc]],[_CD]:[,output.headers[_cd]],[_CE]:[,output.headers[_ce]],[_CL]:[,output.headers[_cl]],[_CT]:[,output.headers[_ct]],[_E]:[()=>void 0!==output.headers[_e],()=>expectNonNull(parseRfc7231DateTime(output.headers[_e]))],[_ES]:[,output.headers[_ex]],[_WRL]:[,output.headers[_xawrl]],[_SSE]:[,output.headers[_xasse]],[_SSECA]:[,output.headers[_xasseca]],[_SSECKMD]:[,output.headers[_xasseckm]],[_SSEKMSKI]:[,output.headers[_xasseakki]],[_BKE]:[()=>void 0!==output.headers[_xassebke],()=>parseBoolean(output.headers[_xassebke])],[_SC]:[,output.headers[_xasc]],[_RC]:[,output.headers[_xarc]],[_RS]:[,output.headers[_xars]],[_PC]:[()=>void 0!==output.headers[_xampc],()=>strictParseInt32(output.headers[_xampc])],[_OLM]:[,output.headers[_xaolm]],[_OLRUD]:[()=>void 0!==output.headers[_xaolrud],()=>expectNonNull(parseRfc3339DateTimeWithOffset(output.headers[_xaolrud]))],[_OLLHS]:[,output.headers[_xaollh]],Metadata:[,Object.keys(output.headers).filter((header=>header.startsWith("x-amz-meta-"))).reduce(((acc,header)=>{acc[header.substring(11)]=output.headers[header];return acc}),{})]});await collectBody(output.body,context2);return contents},de_ListBucketAnalyticsConfigurationsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.AnalyticsConfiguration)contents[_ACLn]=[];else if(null!=data[_AC])contents[_ACLn]=de_AnalyticsConfigurationList(getArrayIfSingleItem(data[_AC]),context2);if(null!=data[_CTo])contents[_CTo]=expectString(data[_CTo]);if(null!=data[_IT])contents[_IT]=parseBoolean(data[_IT]);if(null!=data[_NCT])contents[_NCT]=expectString(data[_NCT]);return contents},de_ListBucketIntelligentTieringConfigurationsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_CTo])contents[_CTo]=expectString(data[_CTo]);if(""===data.IntelligentTieringConfiguration)contents[_ITCL]=[];else if(null!=data[_ITC])contents[_ITCL]=de_IntelligentTieringConfigurationList(getArrayIfSingleItem(data[_ITC]),context2);if(null!=data[_IT])contents[_IT]=parseBoolean(data[_IT]);if(null!=data[_NCT])contents[_NCT]=expectString(data[_NCT]);return contents},de_ListBucketInventoryConfigurationsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_CTo])contents[_CTo]=expectString(data[_CTo]);if(""===data.InventoryConfiguration)contents[_ICL]=[];else if(null!=data[_IC])contents[_ICL]=de_InventoryConfigurationList(getArrayIfSingleItem(data[_IC]),context2);if(null!=data[_IT])contents[_IT]=parseBoolean(data[_IT]);if(null!=data[_NCT])contents[_NCT]=expectString(data[_NCT]);return contents},de_ListBucketMetricsConfigurationsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_CTo])contents[_CTo]=expectString(data[_CTo]);if(null!=data[_IT])contents[_IT]=parseBoolean(data[_IT]);if(""===data.MetricsConfiguration)contents[_MCL]=[];else if(null!=data[_MC])contents[_MCL]=de_MetricsConfigurationList(getArrayIfSingleItem(data[_MC]),context2);if(null!=data[_NCT])contents[_NCT]=expectString(data[_NCT]);return contents},de_ListBucketsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.Buckets)contents[_Bu]=[];else if(null!=data[_Bu]&&null!=data[_Bu][_B])contents[_Bu]=de_Buckets(getArrayIfSingleItem(data[_Bu][_B]),context2);if(null!=data[_CTo])contents[_CTo]=expectString(data[_CTo]);if(null!=data[_O])contents[_O]=de_Owner(data[_O],context2);return contents},de_ListDirectoryBucketsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.Buckets)contents[_Bu]=[];else if(null!=data[_Bu]&&null!=data[_Bu][_B])contents[_Bu]=de_Buckets(getArrayIfSingleItem(data[_Bu][_B]),context2);if(null!=data[_CTo])contents[_CTo]=expectString(data[_CTo]);return contents},de_ListMultipartUploadsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_B])contents[_B]=expectString(data[_B]);if(""===data.CommonPrefixes)contents[_CP]=[];else if(null!=data[_CP])contents[_CP]=de_CommonPrefixList(getArrayIfSingleItem(data[_CP]),context2);if(null!=data[_D])contents[_D]=expectString(data[_D]);if(null!=data[_ET])contents[_ET]=expectString(data[_ET]);if(null!=data[_IT])contents[_IT]=parseBoolean(data[_IT]);if(null!=data[_KM])contents[_KM]=expectString(data[_KM]);if(null!=data[_MU])contents[_MU]=strictParseInt32(data[_MU]);if(null!=data[_NKM])contents[_NKM]=expectString(data[_NKM]);if(null!=data[_NUIM])contents[_NUIM]=expectString(data[_NUIM]);if(null!=data[_P])contents[_P]=expectString(data[_P]);if(null!=data[_UIM])contents[_UIM]=expectString(data[_UIM]);if(""===data.Upload)contents[_Up]=[];else if(null!=data[_U])contents[_Up]=de_MultipartUploadList(getArrayIfSingleItem(data[_U]),context2);return contents},de_ListObjectsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.CommonPrefixes)contents[_CP]=[];else if(null!=data[_CP])contents[_CP]=de_CommonPrefixList(getArrayIfSingleItem(data[_CP]),context2);if(""===data.Contents)contents[_Co]=[];else if(null!=data[_Co])contents[_Co]=de_ObjectList(getArrayIfSingleItem(data[_Co]),context2);if(null!=data[_D])contents[_D]=expectString(data[_D]);if(null!=data[_ET])contents[_ET]=expectString(data[_ET]);if(null!=data[_IT])contents[_IT]=parseBoolean(data[_IT]);if(null!=data[_M])contents[_M]=expectString(data[_M]);if(null!=data[_MK])contents[_MK]=strictParseInt32(data[_MK]);if(null!=data[_N])contents[_N]=expectString(data[_N]);if(null!=data[_NM])contents[_NM]=expectString(data[_NM]);if(null!=data[_P])contents[_P]=expectString(data[_P]);return contents},de_ListObjectsV2Command=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.CommonPrefixes)contents[_CP]=[];else if(null!=data[_CP])contents[_CP]=de_CommonPrefixList(getArrayIfSingleItem(data[_CP]),context2);if(""===data.Contents)contents[_Co]=[];else if(null!=data[_Co])contents[_Co]=de_ObjectList(getArrayIfSingleItem(data[_Co]),context2);if(null!=data[_CTo])contents[_CTo]=expectString(data[_CTo]);if(null!=data[_D])contents[_D]=expectString(data[_D]);if(null!=data[_ET])contents[_ET]=expectString(data[_ET]);if(null!=data[_IT])contents[_IT]=parseBoolean(data[_IT]);if(null!=data[_KC])contents[_KC]=strictParseInt32(data[_KC]);if(null!=data[_MK])contents[_MK]=strictParseInt32(data[_MK]);if(null!=data[_N])contents[_N]=expectString(data[_N]);if(null!=data[_NCT])contents[_NCT]=expectString(data[_NCT]);if(null!=data[_P])contents[_P]=expectString(data[_P]);if(null!=data[_SA])contents[_SA]=expectString(data[_SA]);return contents},de_ListObjectVersionsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(""===data.CommonPrefixes)contents[_CP]=[];else if(null!=data[_CP])contents[_CP]=de_CommonPrefixList(getArrayIfSingleItem(data[_CP]),context2);if(""===data.DeleteMarker)contents[_DMe]=[];else if(null!=data[_DM])contents[_DMe]=de_DeleteMarkers(getArrayIfSingleItem(data[_DM]),context2);if(null!=data[_D])contents[_D]=expectString(data[_D]);if(null!=data[_ET])contents[_ET]=expectString(data[_ET]);if(null!=data[_IT])contents[_IT]=parseBoolean(data[_IT]);if(null!=data[_KM])contents[_KM]=expectString(data[_KM]);if(null!=data[_MK])contents[_MK]=strictParseInt32(data[_MK]);if(null!=data[_N])contents[_N]=expectString(data[_N]);if(null!=data[_NKM])contents[_NKM]=expectString(data[_NKM]);if(null!=data[_NVIM])contents[_NVIM]=expectString(data[_NVIM]);if(null!=data[_P])contents[_P]=expectString(data[_P]);if(null!=data[_VIM])contents[_VIM]=expectString(data[_VIM]);if(""===data.Version)contents[_Ve]=[];else if(null!=data[_V])contents[_Ve]=de_ObjectVersionList(getArrayIfSingleItem(data[_V]),context2);return contents},de_ListPartsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_AD]:[()=>void 0!==output.headers[_xaad],()=>expectNonNull(parseRfc7231DateTime(output.headers[_xaad]))],[_ARI]:[,output.headers[_xaari]],[_RC]:[,output.headers[_xarc]]}),data=expectNonNull(expectObject(await parseXmlBody(output.body,context2)),"body");if(null!=data[_B])contents[_B]=expectString(data[_B]);if(null!=data[_CA])contents[_CA]=expectString(data[_CA]);if(null!=data[_In])contents[_In]=de_Initiator(data[_In],context2);if(null!=data[_IT])contents[_IT]=parseBoolean(data[_IT]);if(null!=data[_K])contents[_K]=expectString(data[_K]);if(null!=data[_MP])contents[_MP]=strictParseInt32(data[_MP]);if(null!=data[_NPNM])contents[_NPNM]=expectString(data[_NPNM]);if(null!=data[_O])contents[_O]=de_Owner(data[_O],context2);if(null!=data[_PNM])contents[_PNM]=expectString(data[_PNM]);if(""===data.Part)contents[_Part]=[];else if(null!=data[_Par])contents[_Part]=de_Parts(getArrayIfSingleItem(data[_Par]),context2);if(null!=data[_SC])contents[_SC]=expectString(data[_SC]);if(null!=data[_UI])contents[_UI]=expectString(data[_UI]);return contents},de_PutBucketAccelerateConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketAclCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketAnalyticsConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketCorsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketEncryptionCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketIntelligentTieringConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketInventoryConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketLifecycleConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketLoggingCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketMetricsConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketNotificationConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketOwnershipControlsCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketPolicyCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketReplicationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketRequestPaymentCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketTaggingCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketVersioningCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutBucketWebsiteCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_PutObjectCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_Exp]:[,output.headers[_xae]],[_ETa]:[,output.headers[_eta]],[_CCRC]:[,output.headers[_xacc]],[_CCRCC]:[,output.headers[_xacc_]],[_CSHA]:[,output.headers[_xacs]],[_CSHAh]:[,output.headers[_xacs_]],[_SSE]:[,output.headers[_xasse]],[_VI]:[,output.headers[_xavi]],[_SSECA]:[,output.headers[_xasseca]],[_SSECKMD]:[,output.headers[_xasseckm]],[_SSEKMSKI]:[,output.headers[_xasseakki]],[_SSEKMSEC]:[,output.headers[_xassec]],[_BKE]:[()=>void 0!==output.headers[_xassebke],()=>parseBoolean(output.headers[_xassebke])],[_RC]:[,output.headers[_xarc]]});await collectBody(output.body,context2);return contents},de_PutObjectAclCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]});await collectBody(output.body,context2);return contents},de_PutObjectLegalHoldCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]});await collectBody(output.body,context2);return contents},de_PutObjectLockConfigurationCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]});await collectBody(output.body,context2);return contents},de_PutObjectRetentionCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]]});await collectBody(output.body,context2);return contents},de_PutObjectTaggingCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_VI]:[,output.headers[_xavi]]});await collectBody(output.body,context2);return contents},de_PutPublicAccessBlockCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_RestoreObjectCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_RC]:[,output.headers[_xarc]],[_ROP]:[,output.headers[_xarop]]});await collectBody(output.body,context2);return contents},de_SelectObjectContentCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)}),data=output.body;contents.Payload=de_SelectObjectContentEventStream(data,context2);return contents},de_UploadPartCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_SSE]:[,output.headers[_xasse]],[_ETa]:[,output.headers[_eta]],[_CCRC]:[,output.headers[_xacc]],[_CCRCC]:[,output.headers[_xacc_]],[_CSHA]:[,output.headers[_xacs]],[_CSHAh]:[,output.headers[_xacs_]],[_SSECA]:[,output.headers[_xasseca]],[_SSECKMD]:[,output.headers[_xasseckm]],[_SSEKMSKI]:[,output.headers[_xasseakki]],[_BKE]:[()=>void 0!==output.headers[_xassebke],()=>parseBoolean(output.headers[_xassebke])],[_RC]:[,output.headers[_xarc]]});await collectBody(output.body,context2);return contents},de_UploadPartCopyCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output),[_CSVI]:[,output.headers[_xacsvi]],[_SSE]:[,output.headers[_xasse]],[_SSECA]:[,output.headers[_xasseca]],[_SSECKMD]:[,output.headers[_xasseckm]],[_SSEKMSKI]:[,output.headers[_xasseakki]],[_BKE]:[()=>void 0!==output.headers[_xassebke],()=>parseBoolean(output.headers[_xassebke])],[_RC]:[,output.headers[_xarc]]}),data=expectObject(await parseXmlBody(output.body,context2));contents.CopyPartResult=de_CopyPartResult(data,context2);return contents},de_WriteGetObjectResponseCommand=async(output,context2)=>{if(200!==output.statusCode&&output.statusCode>=300)return de_CommandError(output,context2);const contents=map({$metadata:deserializeMetadata2(output)});await collectBody(output.body,context2);return contents},de_CommandError=async(output,context2)=>{const parsedOutput={...output,body:await parseXmlErrorBody(output.body,context2)},errorCode=loadRestXmlErrorCode(output,parsedOutput.body);switch(errorCode){case"NoSuchUpload":case"com.amazonaws.s3#NoSuchUpload":throw await de_NoSuchUploadRes(parsedOutput,context2);case"ObjectNotInActiveTierError":case"com.amazonaws.s3#ObjectNotInActiveTierError":throw await de_ObjectNotInActiveTierErrorRes(parsedOutput,context2);case"BucketAlreadyExists":case"com.amazonaws.s3#BucketAlreadyExists":throw await de_BucketAlreadyExistsRes(parsedOutput,context2);case"BucketAlreadyOwnedByYou":case"com.amazonaws.s3#BucketAlreadyOwnedByYou":throw await de_BucketAlreadyOwnedByYouRes(parsedOutput,context2);case"NoSuchBucket":case"com.amazonaws.s3#NoSuchBucket":throw await de_NoSuchBucketRes(parsedOutput,context2);case"InvalidObjectState":case"com.amazonaws.s3#InvalidObjectState":throw await de_InvalidObjectStateRes(parsedOutput,context2);case"NoSuchKey":case"com.amazonaws.s3#NoSuchKey":throw await de_NoSuchKeyRes(parsedOutput,context2);case"NotFound":case"com.amazonaws.s3#NotFound":throw await de_NotFoundRes(parsedOutput,context2);case"ObjectAlreadyInActiveTierError":case"com.amazonaws.s3#ObjectAlreadyInActiveTierError":throw await de_ObjectAlreadyInActiveTierErrorRes(parsedOutput,context2);default:const parsedBody=parsedOutput.body;return throwDefaultError2({output,parsedBody,errorCode})}},throwDefaultError2=withBaseException(S3ServiceException),de_BucketAlreadyExistsRes=async(parsedOutput,context2)=>{const contents=map({}),exception=(parsedOutput.body,new BucketAlreadyExists({$metadata:deserializeMetadata2(parsedOutput),...contents}));return decorateServiceException(exception,parsedOutput.body)},de_BucketAlreadyOwnedByYouRes=async(parsedOutput,context2)=>{const contents=map({}),exception=(parsedOutput.body,new BucketAlreadyOwnedByYou({$metadata:deserializeMetadata2(parsedOutput),...contents}));return decorateServiceException(exception,parsedOutput.body)},de_InvalidObjectStateRes=async(parsedOutput,context2)=>{const contents=map({}),data=parsedOutput.body;if(null!=data[_AT])contents[_AT]=expectString(data[_AT]);if(null!=data[_SC])contents[_SC]=expectString(data[_SC]);const exception=new InvalidObjectState({$metadata:deserializeMetadata2(parsedOutput),...contents});return decorateServiceException(exception,parsedOutput.body)},de_NoSuchBucketRes=async(parsedOutput,context2)=>{const contents=map({}),exception=(parsedOutput.body,new NoSuchBucket({$metadata:deserializeMetadata2(parsedOutput),...contents}));return decorateServiceException(exception,parsedOutput.body)},de_NoSuchKeyRes=async(parsedOutput,context2)=>{const contents=map({}),exception=(parsedOutput.body,new NoSuchKey({$metadata:deserializeMetadata2(parsedOutput),...contents}));return decorateServiceException(exception,parsedOutput.body)},de_NoSuchUploadRes=async(parsedOutput,context2)=>{const contents=map({}),exception=(parsedOutput.body,new NoSuchUpload({$metadata:deserializeMetadata2(parsedOutput),...contents}));return decorateServiceException(exception,parsedOutput.body)},de_NotFoundRes=async(parsedOutput,context2)=>{const contents=map({}),exception=(parsedOutput.body,new NotFound({$metadata:deserializeMetadata2(parsedOutput),...contents}));return decorateServiceException(exception,parsedOutput.body)},de_ObjectAlreadyInActiveTierErrorRes=async(parsedOutput,context2)=>{const contents=map({}),exception=(parsedOutput.body,new ObjectAlreadyInActiveTierError({$metadata:deserializeMetadata2(parsedOutput),...contents}));return decorateServiceException(exception,parsedOutput.body)},de_ObjectNotInActiveTierErrorRes=async(parsedOutput,context2)=>{const contents=map({}),exception=(parsedOutput.body,new ObjectNotInActiveTierError({$metadata:deserializeMetadata2(parsedOutput),...contents}));return decorateServiceException(exception,parsedOutput.body)},de_SelectObjectContentEventStream=(output,context2)=>context2.eventStreamMarshaller.deserialize(output,(async event=>{if(null!=event["Records"])return{Records:await de_RecordsEvent_event(event["Records"],context2)};if(null!=event["Stats"])return{Stats:await de_StatsEvent_event(event["Stats"],context2)};if(null!=event["Progress"])return{Progress:await de_ProgressEvent_event(event["Progress"],context2)};if(null!=event["Cont"])return{Cont:await de_ContinuationEvent_event(event["Cont"],context2)};if(null!=event["End"])return{End:await de_EndEvent_event(event["End"],context2)};else return{$unknown:output}})),de_ContinuationEvent_event=async(output,context2)=>{const contents={},data=await parseXmlBody(output.body,context2);Object.assign(contents,de_ContinuationEvent(data,context2));return contents},de_EndEvent_event=async(output,context2)=>{const contents={},data=await parseXmlBody(output.body,context2);Object.assign(contents,de_EndEvent(data,context2));return contents},de_ProgressEvent_event=async(output,context2)=>{const contents={},data=await parseXmlBody(output.body,context2);contents.Details=de_Progress(data,context2);return contents},de_RecordsEvent_event=async(output,context2)=>{const contents={};contents.Payload=output.body;return contents},de_StatsEvent_event=async(output,context2)=>{const contents={},data=await parseXmlBody(output.body,context2);contents.Details=de_Stats(data,context2);return contents},se_AbortIncompleteMultipartUpload=(input,context2)=>{const bn2=new XmlNode(_AIMU);if(null!=input[_DAI])bn2.c(XmlNode.of(_DAI,String(input[_DAI])).n(_DAI));return bn2},se_AccelerateConfiguration=(input,context2)=>{const bn2=new XmlNode(_ACc);if(null!=input[_S])bn2.c(XmlNode.of(_BAS,input[_S]).n(_S));return bn2},se_AccessControlPolicy=(input,context2)=>{const bn2=new XmlNode(_ACP);bn2.lc(input,"Grants","AccessControlList",(()=>se_Grants(input[_Gr],context2)));if(null!=input[_O])bn2.c(se_Owner(input[_O],context2).n(_O));return bn2},se_AccessControlTranslation=(input,context2)=>{const bn2=new XmlNode(_ACT);if(null!=input[_O])bn2.c(XmlNode.of(_OOw,input[_O]).n(_O));return bn2},se_AllowedHeaders=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>XmlNode.of(_AH,entry).n(_me))),se_AllowedMethods=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>XmlNode.of(_AM,entry).n(_me))),se_AllowedOrigins=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>XmlNode.of(_AO,entry).n(_me))),se_AnalyticsAndOperator=(input,context2)=>{const bn2=new XmlNode(_AAO);bn2.cc(input,_P);bn2.l(input,"Tags","Tag",(()=>se_TagSet(input[_Tag],context2)));return bn2},se_AnalyticsConfiguration=(input,context2)=>{const bn2=new XmlNode(_AC);if(null!=input[_I])bn2.c(XmlNode.of(_AI,input[_I]).n(_I));if(null!=input[_F])bn2.c(se_AnalyticsFilter(input[_F],context2).n(_F));if(null!=input[_SCA])bn2.c(se_StorageClassAnalysis(input[_SCA],context2).n(_SCA));return bn2},se_AnalyticsExportDestination=(input,context2)=>{const bn2=new XmlNode(_AED);if(null!=input[_SBD])bn2.c(se_AnalyticsS3BucketDestination(input[_SBD],context2).n(_SBD));return bn2},se_AnalyticsFilter=(input,context2)=>{const bn2=new XmlNode(_AF);AnalyticsFilter.visit(input,{Prefix:value=>{if(null!=input[_P])bn2.c(XmlNode.of(_P,value).n(_P))},Tag:value=>{if(null!=input[_Ta])bn2.c(se_Tag(value,context2).n(_Ta))},And:value=>{if(null!=input[_A])bn2.c(se_AnalyticsAndOperator(value,context2).n(_A))},_:(name,value)=>{if(!(value instanceof XmlNode||value instanceof XmlText))throw new Error("Unable to serialize unknown union members in XML.");bn2.c(new XmlNode(name).c(value))}});return bn2},se_AnalyticsS3BucketDestination=(input,context2)=>{const bn2=new XmlNode(_ASBD);if(null!=input[_Fo])bn2.c(XmlNode.of(_ASEFF,input[_Fo]).n(_Fo));if(null!=input[_BAI])bn2.c(XmlNode.of(_AIc,input[_BAI]).n(_BAI));if(null!=input[_B])bn2.c(XmlNode.of(_BN,input[_B]).n(_B));bn2.cc(input,_P);return bn2},se_BucketInfo=(input,context2)=>{const bn2=new XmlNode(_BI);bn2.cc(input,_DR);if(null!=input[_Ty])bn2.c(XmlNode.of(_BT,input[_Ty]).n(_Ty));return bn2},se_BucketLifecycleConfiguration=(input,context2)=>{const bn2=new XmlNode(_BLC);bn2.l(input,"Rules","Rule",(()=>se_LifecycleRules(input[_Rul],context2)));return bn2},se_BucketLoggingStatus=(input,context2)=>{const bn2=new XmlNode(_BLS);if(null!=input[_LE])bn2.c(se_LoggingEnabled(input[_LE],context2).n(_LE));return bn2},se_CompletedMultipartUpload=(input,context2)=>{const bn2=new XmlNode(_CMU);bn2.l(input,"Parts","Part",(()=>se_CompletedPartList(input[_Part],context2)));return bn2},se_CompletedPart=(input,context2)=>{const bn2=new XmlNode(_CPo);bn2.cc(input,_ETa);bn2.cc(input,_CCRC);bn2.cc(input,_CCRCC);bn2.cc(input,_CSHA);bn2.cc(input,_CSHAh);if(null!=input[_PN])bn2.c(XmlNode.of(_PN,String(input[_PN])).n(_PN));return bn2},se_CompletedPartList=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_CompletedPart(entry,context2).n(_me))),se_Condition=(input,context2)=>{const bn2=new XmlNode(_Con);bn2.cc(input,_HECRE);bn2.cc(input,_KPE);return bn2},se_CORSConfiguration=(input,context2)=>{const bn2=new XmlNode(_CORSC);bn2.l(input,"CORSRules","CORSRule",(()=>se_CORSRules(input[_CORSRu],context2)));return bn2},se_CORSRule=(input,context2)=>{const bn2=new XmlNode(_CORSR);bn2.cc(input,_ID_);bn2.l(input,"AllowedHeaders","AllowedHeader",(()=>se_AllowedHeaders(input[_AHl],context2)));bn2.l(input,"AllowedMethods","AllowedMethod",(()=>se_AllowedMethods(input[_AMl],context2)));bn2.l(input,"AllowedOrigins","AllowedOrigin",(()=>se_AllowedOrigins(input[_AOl],context2)));bn2.l(input,"ExposeHeaders","ExposeHeader",(()=>se_ExposeHeaders(input[_EH],context2)));if(null!=input[_MAS])bn2.c(XmlNode.of(_MAS,String(input[_MAS])).n(_MAS));return bn2},se_CORSRules=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_CORSRule(entry,context2).n(_me))),se_CreateBucketConfiguration=(input,context2)=>{const bn2=new XmlNode(_CBC);if(null!=input[_LC])bn2.c(XmlNode.of(_BLCu,input[_LC]).n(_LC));if(null!=input[_L])bn2.c(se_LocationInfo(input[_L],context2).n(_L));if(null!=input[_B])bn2.c(se_BucketInfo(input[_B],context2).n(_B));return bn2},se_CSVInput=(input,context2)=>{const bn2=new XmlNode(_CSVIn);bn2.cc(input,_FHI);bn2.cc(input,_Com);bn2.cc(input,_QEC);bn2.cc(input,_RD);bn2.cc(input,_FD);bn2.cc(input,_QCuo);if(null!=input[_AQRD])bn2.c(XmlNode.of(_AQRD,String(input[_AQRD])).n(_AQRD));return bn2},se_CSVOutput=(input,context2)=>{const bn2=new XmlNode(_CSVO);bn2.cc(input,_QF);bn2.cc(input,_QEC);bn2.cc(input,_RD);bn2.cc(input,_FD);bn2.cc(input,_QCuo);return bn2},se_DefaultRetention=(input,context2)=>{const bn2=new XmlNode(_DRe);if(null!=input[_Mo])bn2.c(XmlNode.of(_OLRM,input[_Mo]).n(_Mo));if(null!=input[_Da])bn2.c(XmlNode.of(_Da,String(input[_Da])).n(_Da));if(null!=input[_Y])bn2.c(XmlNode.of(_Y,String(input[_Y])).n(_Y));return bn2},se_Delete=(input,context2)=>{const bn2=new XmlNode(_Del);bn2.l(input,"Objects","Object",(()=>se_ObjectIdentifierList(input[_Ob],context2)));if(null!=input[_Q])bn2.c(XmlNode.of(_Q,String(input[_Q])).n(_Q));return bn2},se_DeleteMarkerReplication=(input,context2)=>{const bn2=new XmlNode(_DMR);if(null!=input[_S])bn2.c(XmlNode.of(_DMRS,input[_S]).n(_S));return bn2},se_Destination=(input,context2)=>{const bn2=new XmlNode(_Des);if(null!=input[_B])bn2.c(XmlNode.of(_BN,input[_B]).n(_B));if(null!=input[_Ac])bn2.c(XmlNode.of(_AIc,input[_Ac]).n(_Ac));bn2.cc(input,_SC);if(null!=input[_ACT])bn2.c(se_AccessControlTranslation(input[_ACT],context2).n(_ACT));if(null!=input[_ECn])bn2.c(se_EncryptionConfiguration(input[_ECn],context2).n(_ECn));if(null!=input[_RTe])bn2.c(se_ReplicationTime(input[_RTe],context2).n(_RTe));if(null!=input[_Me])bn2.c(se_Metrics(input[_Me],context2).n(_Me));return bn2},se_Encryption=(input,context2)=>{const bn2=new XmlNode(_En);if(null!=input[_ETn])bn2.c(XmlNode.of(_SSE,input[_ETn]).n(_ETn));if(null!=input[_KMSKI])bn2.c(XmlNode.of(_SSEKMSKI,input[_KMSKI]).n(_KMSKI));bn2.cc(input,_KMSC);return bn2},se_EncryptionConfiguration=(input,context2)=>{const bn2=new XmlNode(_ECn);bn2.cc(input,_RKKID);return bn2},se_ErrorDocument=(input,context2)=>{const bn2=new XmlNode(_ED);if(null!=input[_K])bn2.c(XmlNode.of(_OK,input[_K]).n(_K));return bn2},se_EventBridgeConfiguration=(input,context2)=>new XmlNode(_EBC),se_EventList=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>XmlNode.of(_Ev,entry).n(_me))),se_ExistingObjectReplication=(input,context2)=>{const bn2=new XmlNode(_EOR);if(null!=input[_S])bn2.c(XmlNode.of(_EORS,input[_S]).n(_S));return bn2},se_ExposeHeaders=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>XmlNode.of(_EHx,entry).n(_me))),se_FilterRule=(input,context2)=>{const bn2=new XmlNode(_FR);if(null!=input[_N])bn2.c(XmlNode.of(_FRN,input[_N]).n(_N));if(null!=input[_Va])bn2.c(XmlNode.of(_FRV,input[_Va]).n(_Va));return bn2},se_FilterRuleList=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_FilterRule(entry,context2).n(_me))),se_GlacierJobParameters=(input,context2)=>{const bn2=new XmlNode(_GJP);bn2.cc(input,_Ti);return bn2},se_Grant=(input,context2)=>{const bn2=new XmlNode(_G);if(null!=input[_Gra]){const n3=se_Grantee(input[_Gra],context2).n(_Gra);n3.a("xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance");bn2.c(n3)}bn2.cc(input,_Pe);return bn2},se_Grantee=(input,context2)=>{const bn2=new XmlNode(_Gra);bn2.cc(input,_DN);bn2.cc(input,_EA);bn2.cc(input,_ID_);bn2.cc(input,_URI);bn2.a("xsi:type",input[_Ty]);return bn2},se_Grants=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_Grant(entry,context2).n(_G))),se_IndexDocument=(input,context2)=>{const bn2=new XmlNode(_ID);bn2.cc(input,_Su);return bn2},se_InputSerialization=(input,context2)=>{const bn2=new XmlNode(_IS);if(null!=input[_CSV])bn2.c(se_CSVInput(input[_CSV],context2).n(_CSV));bn2.cc(input,_CTom);if(null!=input[_JSON])bn2.c(se_JSONInput(input[_JSON],context2).n(_JSON));if(null!=input[_Parq])bn2.c(se_ParquetInput(input[_Parq],context2).n(_Parq));return bn2},se_IntelligentTieringAndOperator=(input,context2)=>{const bn2=new XmlNode(_ITAO);bn2.cc(input,_P);bn2.l(input,"Tags","Tag",(()=>se_TagSet(input[_Tag],context2)));return bn2},se_IntelligentTieringConfiguration=(input,context2)=>{const bn2=new XmlNode(_ITC);if(null!=input[_I])bn2.c(XmlNode.of(_ITI,input[_I]).n(_I));if(null!=input[_F])bn2.c(se_IntelligentTieringFilter(input[_F],context2).n(_F));if(null!=input[_S])bn2.c(XmlNode.of(_ITS,input[_S]).n(_S));bn2.l(input,"Tierings","Tiering",(()=>se_TieringList(input[_Tie],context2)));return bn2},se_IntelligentTieringFilter=(input,context2)=>{const bn2=new XmlNode(_ITF);bn2.cc(input,_P);if(null!=input[_Ta])bn2.c(se_Tag(input[_Ta],context2).n(_Ta));if(null!=input[_A])bn2.c(se_IntelligentTieringAndOperator(input[_A],context2).n(_A));return bn2},se_InventoryConfiguration=(input,context2)=>{const bn2=new XmlNode(_IC);if(null!=input[_Des])bn2.c(se_InventoryDestination(input[_Des],context2).n(_Des));if(null!=input[_IE])bn2.c(XmlNode.of(_IE,String(input[_IE])).n(_IE));if(null!=input[_F])bn2.c(se_InventoryFilter(input[_F],context2).n(_F));if(null!=input[_I])bn2.c(XmlNode.of(_II,input[_I]).n(_I));if(null!=input[_IOV])bn2.c(XmlNode.of(_IIOV,input[_IOV]).n(_IOV));bn2.lc(input,"OptionalFields","OptionalFields",(()=>se_InventoryOptionalFields(input[_OF],context2)));if(null!=input[_Sc])bn2.c(se_InventorySchedule(input[_Sc],context2).n(_Sc));return bn2},se_InventoryDestination=(input,context2)=>{const bn2=new XmlNode(_IDn);if(null!=input[_SBD])bn2.c(se_InventoryS3BucketDestination(input[_SBD],context2).n(_SBD));return bn2},se_InventoryEncryption=(input,context2)=>{const bn2=new XmlNode(_IEn);if(null!=input[_SSES])bn2.c(se_SSES3(input[_SSES],context2).n(_SS));if(null!=input[_SSEKMS])bn2.c(se_SSEKMS(input[_SSEKMS],context2).n(_SK));return bn2},se_InventoryFilter=(input,context2)=>{const bn2=new XmlNode(_IF);bn2.cc(input,_P);return bn2},se_InventoryOptionalFields=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>XmlNode.of(_IOF,entry).n(_Fi))),se_InventoryS3BucketDestination=(input,context2)=>{const bn2=new XmlNode(_ISBD);bn2.cc(input,_AIc);if(null!=input[_B])bn2.c(XmlNode.of(_BN,input[_B]).n(_B));if(null!=input[_Fo])bn2.c(XmlNode.of(_IFn,input[_Fo]).n(_Fo));bn2.cc(input,_P);if(null!=input[_En])bn2.c(se_InventoryEncryption(input[_En],context2).n(_En));return bn2},se_InventorySchedule=(input,context2)=>{const bn2=new XmlNode(_ISn);if(null!=input[_Fr])bn2.c(XmlNode.of(_IFnv,input[_Fr]).n(_Fr));return bn2},se_JSONInput=(input,context2)=>{const bn2=new XmlNode(_JSONI);if(null!=input[_Ty])bn2.c(XmlNode.of(_JSONT,input[_Ty]).n(_Ty));return bn2},se_JSONOutput=(input,context2)=>{const bn2=new XmlNode(_JSONO);bn2.cc(input,_RD);return bn2},se_LambdaFunctionConfiguration=(input,context2)=>{const bn2=new XmlNode(_LFCa);if(null!=input[_I])bn2.c(XmlNode.of(_NI,input[_I]).n(_I));if(null!=input[_LFA])bn2.c(XmlNode.of(_LFA,input[_LFA]).n(_CF));bn2.l(input,"Events","Event",(()=>se_EventList(input[_Eve],context2)));if(null!=input[_F])bn2.c(se_NotificationConfigurationFilter(input[_F],context2).n(_F));return bn2},se_LambdaFunctionConfigurationList=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_LambdaFunctionConfiguration(entry,context2).n(_me))),se_LifecycleExpiration=(input,context2)=>{const bn2=new XmlNode(_LEi);if(null!=input[_Dat])bn2.c(XmlNode.of(_Dat,serializeDateTime(input[_Dat]).toString()).n(_Dat));if(null!=input[_Da])bn2.c(XmlNode.of(_Da,String(input[_Da])).n(_Da));if(null!=input[_EODM])bn2.c(XmlNode.of(_EODM,String(input[_EODM])).n(_EODM));return bn2},se_LifecycleRule=(input,context2)=>{const bn2=new XmlNode(_LR);if(null!=input[_Exp])bn2.c(se_LifecycleExpiration(input[_Exp],context2).n(_Exp));bn2.cc(input,_ID_);bn2.cc(input,_P);if(null!=input[_F])bn2.c(se_LifecycleRuleFilter(input[_F],context2).n(_F));if(null!=input[_S])bn2.c(XmlNode.of(_ESx,input[_S]).n(_S));bn2.l(input,"Transitions","Transition",(()=>se_TransitionList(input[_Tr],context2)));bn2.l(input,"NoncurrentVersionTransitions","NoncurrentVersionTransition",(()=>se_NoncurrentVersionTransitionList(input[_NVT],context2)));if(null!=input[_NVE])bn2.c(se_NoncurrentVersionExpiration(input[_NVE],context2).n(_NVE));if(null!=input[_AIMU])bn2.c(se_AbortIncompleteMultipartUpload(input[_AIMU],context2).n(_AIMU));return bn2},se_LifecycleRuleAndOperator=(input,context2)=>{const bn2=new XmlNode(_LRAO);bn2.cc(input,_P);bn2.l(input,"Tags","Tag",(()=>se_TagSet(input[_Tag],context2)));if(null!=input[_OSGT])bn2.c(XmlNode.of(_OSGTB,String(input[_OSGT])).n(_OSGT));if(null!=input[_OSLT])bn2.c(XmlNode.of(_OSLTB,String(input[_OSLT])).n(_OSLT));return bn2},se_LifecycleRuleFilter=(input,context2)=>{const bn2=new XmlNode(_LRF);LifecycleRuleFilter.visit(input,{Prefix:value=>{if(null!=input[_P])bn2.c(XmlNode.of(_P,value).n(_P))},Tag:value=>{if(null!=input[_Ta])bn2.c(se_Tag(value,context2).n(_Ta))},ObjectSizeGreaterThan:value=>{if(null!=input[_OSGT])bn2.c(XmlNode.of(_OSGTB,String(value)).n(_OSGT))},ObjectSizeLessThan:value=>{if(null!=input[_OSLT])bn2.c(XmlNode.of(_OSLTB,String(value)).n(_OSLT))},And:value=>{if(null!=input[_A])bn2.c(se_LifecycleRuleAndOperator(value,context2).n(_A))},_:(name,value)=>{if(!(value instanceof XmlNode||value instanceof XmlText))throw new Error("Unable to serialize unknown union members in XML.");bn2.c(new XmlNode(name).c(value))}});return bn2},se_LifecycleRules=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_LifecycleRule(entry,context2).n(_me))),se_LocationInfo=(input,context2)=>{const bn2=new XmlNode(_LI);if(null!=input[_Ty])bn2.c(XmlNode.of(_LT,input[_Ty]).n(_Ty));if(null!=input[_N])bn2.c(XmlNode.of(_LNAS,input[_N]).n(_N));return bn2},se_LoggingEnabled=(input,context2)=>{const bn2=new XmlNode(_LE);bn2.cc(input,_TB);bn2.lc(input,"TargetGrants","TargetGrants",(()=>se_TargetGrants(input[_TG],context2)));bn2.cc(input,_TP);if(null!=input[_TOKF])bn2.c(se_TargetObjectKeyFormat(input[_TOKF],context2).n(_TOKF));return bn2},se_MetadataEntry=(input,context2)=>{const bn2=new XmlNode(_ME);if(null!=input[_N])bn2.c(XmlNode.of(_MKe,input[_N]).n(_N));if(null!=input[_Va])bn2.c(XmlNode.of(_MV,input[_Va]).n(_Va));return bn2},se_Metrics=(input,context2)=>{const bn2=new XmlNode(_Me);if(null!=input[_S])bn2.c(XmlNode.of(_MS,input[_S]).n(_S));if(null!=input[_ETv])bn2.c(se_ReplicationTimeValue(input[_ETv],context2).n(_ETv));return bn2},se_MetricsAndOperator=(input,context2)=>{const bn2=new XmlNode(_MAO);bn2.cc(input,_P);bn2.l(input,"Tags","Tag",(()=>se_TagSet(input[_Tag],context2)));bn2.cc(input,_APAc);return bn2},se_MetricsConfiguration=(input,context2)=>{const bn2=new XmlNode(_MC);if(null!=input[_I])bn2.c(XmlNode.of(_MI,input[_I]).n(_I));if(null!=input[_F])bn2.c(se_MetricsFilter(input[_F],context2).n(_F));return bn2},se_MetricsFilter=(input,context2)=>{const bn2=new XmlNode(_MF);MetricsFilter.visit(input,{Prefix:value=>{if(null!=input[_P])bn2.c(XmlNode.of(_P,value).n(_P))},Tag:value=>{if(null!=input[_Ta])bn2.c(se_Tag(value,context2).n(_Ta))},AccessPointArn:value=>{if(null!=input[_APAc])bn2.c(XmlNode.of(_APAc,value).n(_APAc))},And:value=>{if(null!=input[_A])bn2.c(se_MetricsAndOperator(value,context2).n(_A))},_:(name,value)=>{if(!(value instanceof XmlNode||value instanceof XmlText))throw new Error("Unable to serialize unknown union members in XML.");bn2.c(new XmlNode(name).c(value))}});return bn2},se_NoncurrentVersionExpiration=(input,context2)=>{const bn2=new XmlNode(_NVE);if(null!=input[_ND])bn2.c(XmlNode.of(_Da,String(input[_ND])).n(_ND));if(null!=input[_NNV])bn2.c(XmlNode.of(_VC,String(input[_NNV])).n(_NNV));return bn2},se_NoncurrentVersionTransition=(input,context2)=>{const bn2=new XmlNode(_NVTo);if(null!=input[_ND])bn2.c(XmlNode.of(_Da,String(input[_ND])).n(_ND));if(null!=input[_SC])bn2.c(XmlNode.of(_TSC,input[_SC]).n(_SC));if(null!=input[_NNV])bn2.c(XmlNode.of(_VC,String(input[_NNV])).n(_NNV));return bn2},se_NoncurrentVersionTransitionList=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_NoncurrentVersionTransition(entry,context2).n(_me))),se_NotificationConfiguration=(input,context2)=>{const bn2=new XmlNode(_NC);bn2.l(input,"TopicConfigurations","TopicConfiguration",(()=>se_TopicConfigurationList(input[_TCop],context2)));bn2.l(input,"QueueConfigurations","QueueConfiguration",(()=>se_QueueConfigurationList(input[_QCu],context2)));bn2.l(input,"LambdaFunctionConfigurations","CloudFunctionConfiguration",(()=>se_LambdaFunctionConfigurationList(input[_LFC],context2)));if(null!=input[_EBC])bn2.c(se_EventBridgeConfiguration(input[_EBC],context2).n(_EBC));return bn2},se_NotificationConfigurationFilter=(input,context2)=>{const bn2=new XmlNode(_NCF);if(null!=input[_K])bn2.c(se_S3KeyFilter(input[_K],context2).n(_SKe));return bn2},se_ObjectIdentifier=(input,context2)=>{const bn2=new XmlNode(_OI);if(null!=input[_K])bn2.c(XmlNode.of(_OK,input[_K]).n(_K));if(null!=input[_VI])bn2.c(XmlNode.of(_OVI,input[_VI]).n(_VI));return bn2},se_ObjectIdentifierList=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_ObjectIdentifier(entry,context2).n(_me))),se_ObjectLockConfiguration=(input,context2)=>{const bn2=new XmlNode(_OLC);bn2.cc(input,_OLE);if(null!=input[_Ru])bn2.c(se_ObjectLockRule(input[_Ru],context2).n(_Ru));return bn2},se_ObjectLockLegalHold=(input,context2)=>{const bn2=new XmlNode(_OLLH);if(null!=input[_S])bn2.c(XmlNode.of(_OLLHS,input[_S]).n(_S));return bn2},se_ObjectLockRetention=(input,context2)=>{const bn2=new XmlNode(_OLR);if(null!=input[_Mo])bn2.c(XmlNode.of(_OLRM,input[_Mo]).n(_Mo));if(null!=input[_RUD])bn2.c(XmlNode.of(_Dat,serializeDateTime(input[_RUD]).toString()).n(_RUD));return bn2},se_ObjectLockRule=(input,context2)=>{const bn2=new XmlNode(_OLRb);if(null!=input[_DRe])bn2.c(se_DefaultRetention(input[_DRe],context2).n(_DRe));return bn2},se_OutputLocation=(input,context2)=>{const bn2=new XmlNode(_OL);if(null!=input[_S_])bn2.c(se_S3Location(input[_S_],context2).n(_S_));return bn2},se_OutputSerialization=(input,context2)=>{const bn2=new XmlNode(_OS);if(null!=input[_CSV])bn2.c(se_CSVOutput(input[_CSV],context2).n(_CSV));if(null!=input[_JSON])bn2.c(se_JSONOutput(input[_JSON],context2).n(_JSON));return bn2},se_Owner=(input,context2)=>{const bn2=new XmlNode(_O);bn2.cc(input,_DN);bn2.cc(input,_ID_);return bn2},se_OwnershipControls=(input,context2)=>{const bn2=new XmlNode(_OC);bn2.l(input,"Rules","Rule",(()=>se_OwnershipControlsRules(input[_Rul],context2)));return bn2},se_OwnershipControlsRule=(input,context2)=>{const bn2=new XmlNode(_OCR);bn2.cc(input,_OO);return bn2},se_OwnershipControlsRules=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_OwnershipControlsRule(entry,context2).n(_me))),se_ParquetInput=(input,context2)=>new XmlNode(_PI),se_PartitionedPrefix=(input,context2)=>{const bn2=new XmlNode(_PP);bn2.cc(input,_PDS);return bn2},se_PublicAccessBlockConfiguration=(input,context2)=>{const bn2=new XmlNode(_PABC);if(null!=input[_BPA])bn2.c(XmlNode.of(_Se,String(input[_BPA])).n(_BPA));if(null!=input[_IPA])bn2.c(XmlNode.of(_Se,String(input[_IPA])).n(_IPA));if(null!=input[_BPP])bn2.c(XmlNode.of(_Se,String(input[_BPP])).n(_BPP));if(null!=input[_RPB])bn2.c(XmlNode.of(_Se,String(input[_RPB])).n(_RPB));return bn2},se_QueueConfiguration=(input,context2)=>{const bn2=new XmlNode(_QC);if(null!=input[_I])bn2.c(XmlNode.of(_NI,input[_I]).n(_I));if(null!=input[_QA])bn2.c(XmlNode.of(_QA,input[_QA]).n(_Qu));bn2.l(input,"Events","Event",(()=>se_EventList(input[_Eve],context2)));if(null!=input[_F])bn2.c(se_NotificationConfigurationFilter(input[_F],context2).n(_F));return bn2},se_QueueConfigurationList=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_QueueConfiguration(entry,context2).n(_me))),se_Redirect=(input,context2)=>{const bn2=new XmlNode(_Red);bn2.cc(input,_HN);bn2.cc(input,_HRC);bn2.cc(input,_Pr);bn2.cc(input,_RKPW);bn2.cc(input,_RKW);return bn2},se_RedirectAllRequestsTo=(input,context2)=>{const bn2=new XmlNode(_RART);bn2.cc(input,_HN);bn2.cc(input,_Pr);return bn2},se_ReplicaModifications=(input,context2)=>{const bn2=new XmlNode(_RM);if(null!=input[_S])bn2.c(XmlNode.of(_RMS,input[_S]).n(_S));return bn2},se_ReplicationConfiguration=(input,context2)=>{const bn2=new XmlNode(_RCe);bn2.cc(input,_Ro);bn2.l(input,"Rules","Rule",(()=>se_ReplicationRules(input[_Rul],context2)));return bn2},se_ReplicationRule=(input,context2)=>{const bn2=new XmlNode(_RRe);bn2.cc(input,_ID_);if(null!=input[_Pri])bn2.c(XmlNode.of(_Pri,String(input[_Pri])).n(_Pri));bn2.cc(input,_P);if(null!=input[_F])bn2.c(se_ReplicationRuleFilter(input[_F],context2).n(_F));if(null!=input[_S])bn2.c(XmlNode.of(_RRS,input[_S]).n(_S));if(null!=input[_SSC])bn2.c(se_SourceSelectionCriteria(input[_SSC],context2).n(_SSC));if(null!=input[_EOR])bn2.c(se_ExistingObjectReplication(input[_EOR],context2).n(_EOR));if(null!=input[_Des])bn2.c(se_Destination(input[_Des],context2).n(_Des));if(null!=input[_DMR])bn2.c(se_DeleteMarkerReplication(input[_DMR],context2).n(_DMR));return bn2},se_ReplicationRuleAndOperator=(input,context2)=>{const bn2=new XmlNode(_RRAO);bn2.cc(input,_P);bn2.l(input,"Tags","Tag",(()=>se_TagSet(input[_Tag],context2)));return bn2},se_ReplicationRuleFilter=(input,context2)=>{const bn2=new XmlNode(_RRF);ReplicationRuleFilter.visit(input,{Prefix:value=>{if(null!=input[_P])bn2.c(XmlNode.of(_P,value).n(_P))},Tag:value=>{if(null!=input[_Ta])bn2.c(se_Tag(value,context2).n(_Ta))},And:value=>{if(null!=input[_A])bn2.c(se_ReplicationRuleAndOperator(value,context2).n(_A))},_:(name,value)=>{if(!(value instanceof XmlNode||value instanceof XmlText))throw new Error("Unable to serialize unknown union members in XML.");bn2.c(new XmlNode(name).c(value))}});return bn2},se_ReplicationRules=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_ReplicationRule(entry,context2).n(_me))),se_ReplicationTime=(input,context2)=>{const bn2=new XmlNode(_RTe);if(null!=input[_S])bn2.c(XmlNode.of(_RTS,input[_S]).n(_S));if(null!=input[_Tim])bn2.c(se_ReplicationTimeValue(input[_Tim],context2).n(_Tim));return bn2},se_ReplicationTimeValue=(input,context2)=>{const bn2=new XmlNode(_RTV);if(null!=input[_Mi])bn2.c(XmlNode.of(_Mi,String(input[_Mi])).n(_Mi));return bn2},se_RequestPaymentConfiguration=(input,context2)=>{const bn2=new XmlNode(_RPC);bn2.cc(input,_Pa);return bn2},se_RequestProgress=(input,context2)=>{const bn2=new XmlNode(_RPe);if(null!=input[_Ena])bn2.c(XmlNode.of(_ERP,String(input[_Ena])).n(_Ena));return bn2},se_RestoreRequest=(input,context2)=>{const bn2=new XmlNode(_RRes);if(null!=input[_Da])bn2.c(XmlNode.of(_Da,String(input[_Da])).n(_Da));if(null!=input[_GJP])bn2.c(se_GlacierJobParameters(input[_GJP],context2).n(_GJP));if(null!=input[_Ty])bn2.c(XmlNode.of(_RRT,input[_Ty]).n(_Ty));bn2.cc(input,_Ti);bn2.cc(input,_Desc);if(null!=input[_SP])bn2.c(se_SelectParameters(input[_SP],context2).n(_SP));if(null!=input[_OL])bn2.c(se_OutputLocation(input[_OL],context2).n(_OL));return bn2},se_RoutingRule=(input,context2)=>{const bn2=new XmlNode(_RRou);if(null!=input[_Con])bn2.c(se_Condition(input[_Con],context2).n(_Con));if(null!=input[_Red])bn2.c(se_Redirect(input[_Red],context2).n(_Red));return bn2},se_RoutingRules=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_RoutingRule(entry,context2).n(_RRou))),se_S3KeyFilter=(input,context2)=>{const bn2=new XmlNode(_SKF);bn2.l(input,"FilterRules","FilterRule",(()=>se_FilterRuleList(input[_FRi],context2)));return bn2},se_S3Location=(input,context2)=>{const bn2=new XmlNode(_SL);bn2.cc(input,_BN);if(null!=input[_P])bn2.c(XmlNode.of(_LP,input[_P]).n(_P));if(null!=input[_En])bn2.c(se_Encryption(input[_En],context2).n(_En));if(null!=input[_CACL])bn2.c(XmlNode.of(_OCACL,input[_CACL]).n(_CACL));bn2.lc(input,"AccessControlList","AccessControlList",(()=>se_Grants(input[_ACLc],context2)));if(null!=input[_T])bn2.c(se_Tagging(input[_T],context2).n(_T));bn2.lc(input,"UserMetadata","UserMetadata",(()=>se_UserMetadata(input[_UM],context2)));bn2.cc(input,_SC);return bn2},se_ScanRange=(input,context2)=>{const bn2=new XmlNode(_SR);if(null!=input[_St])bn2.c(XmlNode.of(_St,String(input[_St])).n(_St));if(null!=input[_End])bn2.c(XmlNode.of(_End,String(input[_End])).n(_End));return bn2},se_SelectParameters=(input,context2)=>{const bn2=new XmlNode(_SP);if(null!=input[_IS])bn2.c(se_InputSerialization(input[_IS],context2).n(_IS));bn2.cc(input,_ETx);bn2.cc(input,_Ex);if(null!=input[_OS])bn2.c(se_OutputSerialization(input[_OS],context2).n(_OS));return bn2},se_ServerSideEncryptionByDefault=(input,context2)=>{const bn2=new XmlNode(_SSEBD);if(null!=input[_SSEA])bn2.c(XmlNode.of(_SSE,input[_SSEA]).n(_SSEA));if(null!=input[_KMSMKID])bn2.c(XmlNode.of(_SSEKMSKI,input[_KMSMKID]).n(_KMSMKID));return bn2},se_ServerSideEncryptionConfiguration=(input,context2)=>{const bn2=new XmlNode(_SSEC);bn2.l(input,"Rules","Rule",(()=>se_ServerSideEncryptionRules(input[_Rul],context2)));return bn2},se_ServerSideEncryptionRule=(input,context2)=>{const bn2=new XmlNode(_SSER);if(null!=input[_ASSEBD])bn2.c(se_ServerSideEncryptionByDefault(input[_ASSEBD],context2).n(_ASSEBD));if(null!=input[_BKE])bn2.c(XmlNode.of(_BKE,String(input[_BKE])).n(_BKE));return bn2},se_ServerSideEncryptionRules=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_ServerSideEncryptionRule(entry,context2).n(_me))),se_SimplePrefix=(input,context2)=>new XmlNode(_SPi),se_SourceSelectionCriteria=(input,context2)=>{const bn2=new XmlNode(_SSC);if(null!=input[_SKEO])bn2.c(se_SseKmsEncryptedObjects(input[_SKEO],context2).n(_SKEO));if(null!=input[_RM])bn2.c(se_ReplicaModifications(input[_RM],context2).n(_RM));return bn2},se_SSEKMS=(input,context2)=>{const bn2=new XmlNode(_SK);if(null!=input[_KI])bn2.c(XmlNode.of(_SSEKMSKI,input[_KI]).n(_KI));return bn2},se_SseKmsEncryptedObjects=(input,context2)=>{const bn2=new XmlNode(_SKEO);if(null!=input[_S])bn2.c(XmlNode.of(_SKEOS,input[_S]).n(_S));return bn2},se_SSES3=(input,context2)=>new XmlNode(_SS),se_StorageClassAnalysis=(input,context2)=>{const bn2=new XmlNode(_SCA);if(null!=input[_DE])bn2.c(se_StorageClassAnalysisDataExport(input[_DE],context2).n(_DE));return bn2},se_StorageClassAnalysisDataExport=(input,context2)=>{const bn2=new XmlNode(_SCADE);if(null!=input[_OSV])bn2.c(XmlNode.of(_SCASV,input[_OSV]).n(_OSV));if(null!=input[_Des])bn2.c(se_AnalyticsExportDestination(input[_Des],context2).n(_Des));return bn2},se_Tag=(input,context2)=>{const bn2=new XmlNode(_Ta);if(null!=input[_K])bn2.c(XmlNode.of(_OK,input[_K]).n(_K));bn2.cc(input,_Va);return bn2},se_Tagging=(input,context2)=>{const bn2=new XmlNode(_T);bn2.lc(input,"TagSet","TagSet",(()=>se_TagSet(input[_TS],context2)));return bn2},se_TagSet=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_Tag(entry,context2).n(_Ta))),se_TargetGrant=(input,context2)=>{const bn2=new XmlNode(_TGa);if(null!=input[_Gra]){const n3=se_Grantee(input[_Gra],context2).n(_Gra);n3.a("xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance");bn2.c(n3)}if(null!=input[_Pe])bn2.c(XmlNode.of(_BLP,input[_Pe]).n(_Pe));return bn2},se_TargetGrants=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_TargetGrant(entry,context2).n(_G))),se_TargetObjectKeyFormat=(input,context2)=>{const bn2=new XmlNode(_TOKF);if(null!=input[_SPi])bn2.c(se_SimplePrefix(input[_SPi],context2).n(_SPi));if(null!=input[_PP])bn2.c(se_PartitionedPrefix(input[_PP],context2).n(_PP));return bn2},se_Tiering=(input,context2)=>{const bn2=new XmlNode(_Tier);if(null!=input[_Da])bn2.c(XmlNode.of(_ITD,String(input[_Da])).n(_Da));if(null!=input[_AT])bn2.c(XmlNode.of(_ITAT,input[_AT]).n(_AT));return bn2},se_TieringList=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_Tiering(entry,context2).n(_me))),se_TopicConfiguration=(input,context2)=>{const bn2=new XmlNode(_TCo);if(null!=input[_I])bn2.c(XmlNode.of(_NI,input[_I]).n(_I));if(null!=input[_TA])bn2.c(XmlNode.of(_TA,input[_TA]).n(_Top));bn2.l(input,"Events","Event",(()=>se_EventList(input[_Eve],context2)));if(null!=input[_F])bn2.c(se_NotificationConfigurationFilter(input[_F],context2).n(_F));return bn2},se_TopicConfigurationList=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_TopicConfiguration(entry,context2).n(_me))),se_Transition=(input,context2)=>{const bn2=new XmlNode(_Tra);if(null!=input[_Dat])bn2.c(XmlNode.of(_Dat,serializeDateTime(input[_Dat]).toString()).n(_Dat));if(null!=input[_Da])bn2.c(XmlNode.of(_Da,String(input[_Da])).n(_Da));if(null!=input[_SC])bn2.c(XmlNode.of(_TSC,input[_SC]).n(_SC));return bn2},se_TransitionList=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_Transition(entry,context2).n(_me))),se_UserMetadata=(input,context2)=>input.filter((e4=>null!=e4)).map((entry=>se_MetadataEntry(entry,context2).n(_ME))),se_VersioningConfiguration=(input,context2)=>{const bn2=new XmlNode(_VCe);if(null!=input[_MFAD])bn2.c(XmlNode.of(_MFAD,input[_MFAD]).n(_MDf));if(null!=input[_S])bn2.c(XmlNode.of(_BVS,input[_S]).n(_S));return bn2},se_WebsiteConfiguration=(input,context2)=>{const bn2=new XmlNode(_WC);if(null!=input[_ED])bn2.c(se_ErrorDocument(input[_ED],context2).n(_ED));if(null!=input[_ID])bn2.c(se_IndexDocument(input[_ID],context2).n(_ID));if(null!=input[_RART])bn2.c(se_RedirectAllRequestsTo(input[_RART],context2).n(_RART));bn2.lc(input,"RoutingRules","RoutingRules",(()=>se_RoutingRules(input[_RRo],context2)));return bn2},de_AbortIncompleteMultipartUpload=(output,context2)=>{const contents={};if(null!=output[_DAI])contents[_DAI]=strictParseInt32(output[_DAI]);return contents},de_AccessControlTranslation=(output,context2)=>{const contents={};if(null!=output[_O])contents[_O]=expectString(output[_O]);return contents},de_AllowedHeaders=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>expectString(entry))),de_AllowedMethods=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>expectString(entry))),de_AllowedOrigins=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>expectString(entry))),de_AnalyticsAndOperator=(output,context2)=>{const contents={};if(null!=output[_P])contents[_P]=expectString(output[_P]);if(""===output.Tag)contents[_Tag]=[];else if(null!=output[_Ta])contents[_Tag]=de_TagSet(getArrayIfSingleItem(output[_Ta]),context2);return contents},de_AnalyticsConfiguration=(output,context2)=>{const contents={};if(null!=output[_I])contents[_I]=expectString(output[_I]);if(""===output.Filter);else if(null!=output[_F])contents[_F]=de_AnalyticsFilter(expectUnion(output[_F]),context2);if(null!=output[_SCA])contents[_SCA]=de_StorageClassAnalysis(output[_SCA],context2);return contents},de_AnalyticsConfigurationList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_AnalyticsConfiguration(entry,context2))),de_AnalyticsExportDestination=(output,context2)=>{const contents={};if(null!=output[_SBD])contents[_SBD]=de_AnalyticsS3BucketDestination(output[_SBD],context2);return contents},de_AnalyticsFilter=(output,context2)=>{if(null!=output[_P])return{Prefix:expectString(output[_P])};if(null!=output[_Ta])return{Tag:de_Tag(output[_Ta],context2)};if(null!=output[_A])return{And:de_AnalyticsAndOperator(output[_A],context2)};else return{$unknown:Object.entries(output)[0]}},de_AnalyticsS3BucketDestination=(output,context2)=>{const contents={};if(null!=output[_Fo])contents[_Fo]=expectString(output[_Fo]);if(null!=output[_BAI])contents[_BAI]=expectString(output[_BAI]);if(null!=output[_B])contents[_B]=expectString(output[_B]);if(null!=output[_P])contents[_P]=expectString(output[_P]);return contents},de_Bucket=(output,context2)=>{const contents={};if(null!=output[_N])contents[_N]=expectString(output[_N]);if(null!=output[_CDr])contents[_CDr]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_CDr]));return contents},de_Buckets=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_Bucket(entry,context2))),de_Checksum=(output,context2)=>{const contents={};if(null!=output[_CCRC])contents[_CCRC]=expectString(output[_CCRC]);if(null!=output[_CCRCC])contents[_CCRCC]=expectString(output[_CCRCC]);if(null!=output[_CSHA])contents[_CSHA]=expectString(output[_CSHA]);if(null!=output[_CSHAh])contents[_CSHAh]=expectString(output[_CSHAh]);return contents},de_ChecksumAlgorithmList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>expectString(entry))),de_CommonPrefix=(output,context2)=>{const contents={};if(null!=output[_P])contents[_P]=expectString(output[_P]);return contents},de_CommonPrefixList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_CommonPrefix(entry,context2))),de_Condition=(output,context2)=>{const contents={};if(null!=output[_HECRE])contents[_HECRE]=expectString(output[_HECRE]);if(null!=output[_KPE])contents[_KPE]=expectString(output[_KPE]);return contents},de_ContinuationEvent=(output,context2)=>({}),de_CopyObjectResult=(output,context2)=>{const contents={};if(null!=output[_ETa])contents[_ETa]=expectString(output[_ETa]);if(null!=output[_LM])contents[_LM]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_LM]));if(null!=output[_CCRC])contents[_CCRC]=expectString(output[_CCRC]);if(null!=output[_CCRCC])contents[_CCRCC]=expectString(output[_CCRCC]);if(null!=output[_CSHA])contents[_CSHA]=expectString(output[_CSHA]);if(null!=output[_CSHAh])contents[_CSHAh]=expectString(output[_CSHAh]);return contents},de_CopyPartResult=(output,context2)=>{const contents={};if(null!=output[_ETa])contents[_ETa]=expectString(output[_ETa]);if(null!=output[_LM])contents[_LM]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_LM]));if(null!=output[_CCRC])contents[_CCRC]=expectString(output[_CCRC]);if(null!=output[_CCRCC])contents[_CCRCC]=expectString(output[_CCRCC]);if(null!=output[_CSHA])contents[_CSHA]=expectString(output[_CSHA]);if(null!=output[_CSHAh])contents[_CSHAh]=expectString(output[_CSHAh]);return contents},de_CORSRule=(output,context2)=>{const contents={};if(null!=output[_ID_])contents[_ID_]=expectString(output[_ID_]);if(""===output.AllowedHeader)contents[_AHl]=[];else if(null!=output[_AH])contents[_AHl]=de_AllowedHeaders(getArrayIfSingleItem(output[_AH]),context2);if(""===output.AllowedMethod)contents[_AMl]=[];else if(null!=output[_AM])contents[_AMl]=de_AllowedMethods(getArrayIfSingleItem(output[_AM]),context2);if(""===output.AllowedOrigin)contents[_AOl]=[];else if(null!=output[_AO])contents[_AOl]=de_AllowedOrigins(getArrayIfSingleItem(output[_AO]),context2);if(""===output.ExposeHeader)contents[_EH]=[];else if(null!=output[_EHx])contents[_EH]=de_ExposeHeaders(getArrayIfSingleItem(output[_EHx]),context2);if(null!=output[_MAS])contents[_MAS]=strictParseInt32(output[_MAS]);return contents},de_CORSRules=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_CORSRule(entry,context2))),de_DefaultRetention=(output,context2)=>{const contents={};if(null!=output[_Mo])contents[_Mo]=expectString(output[_Mo]);if(null!=output[_Da])contents[_Da]=strictParseInt32(output[_Da]);if(null!=output[_Y])contents[_Y]=strictParseInt32(output[_Y]);return contents},de_DeletedObject=(output,context2)=>{const contents={};if(null!=output[_K])contents[_K]=expectString(output[_K]);if(null!=output[_VI])contents[_VI]=expectString(output[_VI]);if(null!=output[_DM])contents[_DM]=parseBoolean(output[_DM]);if(null!=output[_DMVI])contents[_DMVI]=expectString(output[_DMVI]);return contents},de_DeletedObjects=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_DeletedObject(entry,context2))),de_DeleteMarkerEntry=(output,context2)=>{const contents={};if(null!=output[_O])contents[_O]=de_Owner(output[_O],context2);if(null!=output[_K])contents[_K]=expectString(output[_K]);if(null!=output[_VI])contents[_VI]=expectString(output[_VI]);if(null!=output[_IL])contents[_IL]=parseBoolean(output[_IL]);if(null!=output[_LM])contents[_LM]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_LM]));return contents},de_DeleteMarkerReplication=(output,context2)=>{const contents={};if(null!=output[_S])contents[_S]=expectString(output[_S]);return contents},de_DeleteMarkers=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_DeleteMarkerEntry(entry,context2))),de_Destination=(output,context2)=>{const contents={};if(null!=output[_B])contents[_B]=expectString(output[_B]);if(null!=output[_Ac])contents[_Ac]=expectString(output[_Ac]);if(null!=output[_SC])contents[_SC]=expectString(output[_SC]);if(null!=output[_ACT])contents[_ACT]=de_AccessControlTranslation(output[_ACT],context2);if(null!=output[_ECn])contents[_ECn]=de_EncryptionConfiguration(output[_ECn],context2);if(null!=output[_RTe])contents[_RTe]=de_ReplicationTime(output[_RTe],context2);if(null!=output[_Me])contents[_Me]=de_Metrics(output[_Me],context2);return contents},de_EncryptionConfiguration=(output,context2)=>{const contents={};if(null!=output[_RKKID])contents[_RKKID]=expectString(output[_RKKID]);return contents},de_EndEvent=(output,context2)=>({}),de__Error=(output,context2)=>{const contents={};if(null!=output[_K])contents[_K]=expectString(output[_K]);if(null!=output[_VI])contents[_VI]=expectString(output[_VI]);if(null!=output[_Cod])contents[_Cod]=expectString(output[_Cod]);if(null!=output[_Mes])contents[_Mes]=expectString(output[_Mes]);return contents},de_ErrorDocument=(output,context2)=>{const contents={};if(null!=output[_K])contents[_K]=expectString(output[_K]);return contents},de_Errors=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de__Error(entry,context2))),de_EventBridgeConfiguration=(output,context2)=>({}),de_EventList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>expectString(entry))),de_ExistingObjectReplication=(output,context2)=>{const contents={};if(null!=output[_S])contents[_S]=expectString(output[_S]);return contents},de_ExposeHeaders=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>expectString(entry))),de_FilterRule=(output,context2)=>{const contents={};if(null!=output[_N])contents[_N]=expectString(output[_N]);if(null!=output[_Va])contents[_Va]=expectString(output[_Va]);return contents},de_FilterRuleList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_FilterRule(entry,context2))),de_GetObjectAttributesParts=(output,context2)=>{const contents={};if(null!=output[_PC])contents[_TPC]=strictParseInt32(output[_PC]);if(null!=output[_PNM])contents[_PNM]=expectString(output[_PNM]);if(null!=output[_NPNM])contents[_NPNM]=expectString(output[_NPNM]);if(null!=output[_MP])contents[_MP]=strictParseInt32(output[_MP]);if(null!=output[_IT])contents[_IT]=parseBoolean(output[_IT]);if(""===output.Part)contents[_Part]=[];else if(null!=output[_Par])contents[_Part]=de_PartsList(getArrayIfSingleItem(output[_Par]),context2);return contents},de_Grant=(output,context2)=>{const contents={};if(null!=output[_Gra])contents[_Gra]=de_Grantee(output[_Gra],context2);if(null!=output[_Pe])contents[_Pe]=expectString(output[_Pe]);return contents},de_Grantee=(output,context2)=>{const contents={};if(null!=output[_DN])contents[_DN]=expectString(output[_DN]);if(null!=output[_EA])contents[_EA]=expectString(output[_EA]);if(null!=output[_ID_])contents[_ID_]=expectString(output[_ID_]);if(null!=output[_URI])contents[_URI]=expectString(output[_URI]);if(null!=output[_x])contents[_Ty]=expectString(output[_x]);return contents},de_Grants=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_Grant(entry,context2))),de_IndexDocument=(output,context2)=>{const contents={};if(null!=output[_Su])contents[_Su]=expectString(output[_Su]);return contents},de_Initiator=(output,context2)=>{const contents={};if(null!=output[_ID_])contents[_ID_]=expectString(output[_ID_]);if(null!=output[_DN])contents[_DN]=expectString(output[_DN]);return contents},de_IntelligentTieringAndOperator=(output,context2)=>{const contents={};if(null!=output[_P])contents[_P]=expectString(output[_P]);if(""===output.Tag)contents[_Tag]=[];else if(null!=output[_Ta])contents[_Tag]=de_TagSet(getArrayIfSingleItem(output[_Ta]),context2);return contents},de_IntelligentTieringConfiguration=(output,context2)=>{const contents={};if(null!=output[_I])contents[_I]=expectString(output[_I]);if(null!=output[_F])contents[_F]=de_IntelligentTieringFilter(output[_F],context2);if(null!=output[_S])contents[_S]=expectString(output[_S]);if(""===output.Tiering)contents[_Tie]=[];else if(null!=output[_Tier])contents[_Tie]=de_TieringList(getArrayIfSingleItem(output[_Tier]),context2);return contents},de_IntelligentTieringConfigurationList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_IntelligentTieringConfiguration(entry,context2))),de_IntelligentTieringFilter=(output,context2)=>{const contents={};if(null!=output[_P])contents[_P]=expectString(output[_P]);if(null!=output[_Ta])contents[_Ta]=de_Tag(output[_Ta],context2);if(null!=output[_A])contents[_A]=de_IntelligentTieringAndOperator(output[_A],context2);return contents},de_InventoryConfiguration=(output,context2)=>{const contents={};if(null!=output[_Des])contents[_Des]=de_InventoryDestination(output[_Des],context2);if(null!=output[_IE])contents[_IE]=parseBoolean(output[_IE]);if(null!=output[_F])contents[_F]=de_InventoryFilter(output[_F],context2);if(null!=output[_I])contents[_I]=expectString(output[_I]);if(null!=output[_IOV])contents[_IOV]=expectString(output[_IOV]);if(""===output.OptionalFields)contents[_OF]=[];else if(null!=output[_OF]&&null!=output[_OF][_Fi])contents[_OF]=de_InventoryOptionalFields(getArrayIfSingleItem(output[_OF][_Fi]),context2);if(null!=output[_Sc])contents[_Sc]=de_InventorySchedule(output[_Sc],context2);return contents},de_InventoryConfigurationList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_InventoryConfiguration(entry,context2))),de_InventoryDestination=(output,context2)=>{const contents={};if(null!=output[_SBD])contents[_SBD]=de_InventoryS3BucketDestination(output[_SBD],context2);return contents},de_InventoryEncryption=(output,context2)=>{const contents={};if(null!=output[_SS])contents[_SSES]=de_SSES3(output[_SS],context2);if(null!=output[_SK])contents[_SSEKMS]=de_SSEKMS(output[_SK],context2);return contents},de_InventoryFilter=(output,context2)=>{const contents={};if(null!=output[_P])contents[_P]=expectString(output[_P]);return contents},de_InventoryOptionalFields=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>expectString(entry))),de_InventoryS3BucketDestination=(output,context2)=>{const contents={};if(null!=output[_AIc])contents[_AIc]=expectString(output[_AIc]);if(null!=output[_B])contents[_B]=expectString(output[_B]);if(null!=output[_Fo])contents[_Fo]=expectString(output[_Fo]);if(null!=output[_P])contents[_P]=expectString(output[_P]);if(null!=output[_En])contents[_En]=de_InventoryEncryption(output[_En],context2);return contents},de_InventorySchedule=(output,context2)=>{const contents={};if(null!=output[_Fr])contents[_Fr]=expectString(output[_Fr]);return contents},de_LambdaFunctionConfiguration=(output,context2)=>{const contents={};if(null!=output[_I])contents[_I]=expectString(output[_I]);if(null!=output[_CF])contents[_LFA]=expectString(output[_CF]);if(""===output.Event)contents[_Eve]=[];else if(null!=output[_Ev])contents[_Eve]=de_EventList(getArrayIfSingleItem(output[_Ev]),context2);if(null!=output[_F])contents[_F]=de_NotificationConfigurationFilter(output[_F],context2);return contents},de_LambdaFunctionConfigurationList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_LambdaFunctionConfiguration(entry,context2))),de_LifecycleExpiration=(output,context2)=>{const contents={};if(null!=output[_Dat])contents[_Dat]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_Dat]));if(null!=output[_Da])contents[_Da]=strictParseInt32(output[_Da]);if(null!=output[_EODM])contents[_EODM]=parseBoolean(output[_EODM]);return contents},de_LifecycleRule=(output,context2)=>{const contents={};if(null!=output[_Exp])contents[_Exp]=de_LifecycleExpiration(output[_Exp],context2);if(null!=output[_ID_])contents[_ID_]=expectString(output[_ID_]);if(null!=output[_P])contents[_P]=expectString(output[_P]);if(""===output.Filter);else if(null!=output[_F])contents[_F]=de_LifecycleRuleFilter(expectUnion(output[_F]),context2);if(null!=output[_S])contents[_S]=expectString(output[_S]);if(""===output.Transition)contents[_Tr]=[];else if(null!=output[_Tra])contents[_Tr]=de_TransitionList(getArrayIfSingleItem(output[_Tra]),context2);if(""===output.NoncurrentVersionTransition)contents[_NVT]=[];else if(null!=output[_NVTo])contents[_NVT]=de_NoncurrentVersionTransitionList(getArrayIfSingleItem(output[_NVTo]),context2);if(null!=output[_NVE])contents[_NVE]=de_NoncurrentVersionExpiration(output[_NVE],context2);if(null!=output[_AIMU])contents[_AIMU]=de_AbortIncompleteMultipartUpload(output[_AIMU],context2);return contents},de_LifecycleRuleAndOperator=(output,context2)=>{const contents={};if(null!=output[_P])contents[_P]=expectString(output[_P]);if(""===output.Tag)contents[_Tag]=[];else if(null!=output[_Ta])contents[_Tag]=de_TagSet(getArrayIfSingleItem(output[_Ta]),context2);if(null!=output[_OSGT])contents[_OSGT]=strictParseLong(output[_OSGT]);if(null!=output[_OSLT])contents[_OSLT]=strictParseLong(output[_OSLT]);return contents},de_LifecycleRuleFilter=(output,context2)=>{if(null!=output[_P])return{Prefix:expectString(output[_P])};if(null!=output[_Ta])return{Tag:de_Tag(output[_Ta],context2)};if(null!=output[_OSGT])return{ObjectSizeGreaterThan:strictParseLong(output[_OSGT])};if(null!=output[_OSLT])return{ObjectSizeLessThan:strictParseLong(output[_OSLT])};if(null!=output[_A])return{And:de_LifecycleRuleAndOperator(output[_A],context2)};else return{$unknown:Object.entries(output)[0]}},de_LifecycleRules=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_LifecycleRule(entry,context2))),de_LoggingEnabled=(output,context2)=>{const contents={};if(null!=output[_TB])contents[_TB]=expectString(output[_TB]);if(""===output.TargetGrants)contents[_TG]=[];else if(null!=output[_TG]&&null!=output[_TG][_G])contents[_TG]=de_TargetGrants(getArrayIfSingleItem(output[_TG][_G]),context2);if(null!=output[_TP])contents[_TP]=expectString(output[_TP]);if(null!=output[_TOKF])contents[_TOKF]=de_TargetObjectKeyFormat(output[_TOKF],context2);return contents},de_Metrics=(output,context2)=>{const contents={};if(null!=output[_S])contents[_S]=expectString(output[_S]);if(null!=output[_ETv])contents[_ETv]=de_ReplicationTimeValue(output[_ETv],context2);return contents},de_MetricsAndOperator=(output,context2)=>{const contents={};if(null!=output[_P])contents[_P]=expectString(output[_P]);if(""===output.Tag)contents[_Tag]=[];else if(null!=output[_Ta])contents[_Tag]=de_TagSet(getArrayIfSingleItem(output[_Ta]),context2);if(null!=output[_APAc])contents[_APAc]=expectString(output[_APAc]);return contents},de_MetricsConfiguration=(output,context2)=>{const contents={};if(null!=output[_I])contents[_I]=expectString(output[_I]);if(""===output.Filter);else if(null!=output[_F])contents[_F]=de_MetricsFilter(expectUnion(output[_F]),context2);return contents},de_MetricsConfigurationList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_MetricsConfiguration(entry,context2))),de_MetricsFilter=(output,context2)=>{if(null!=output[_P])return{Prefix:expectString(output[_P])};if(null!=output[_Ta])return{Tag:de_Tag(output[_Ta],context2)};if(null!=output[_APAc])return{AccessPointArn:expectString(output[_APAc])};if(null!=output[_A])return{And:de_MetricsAndOperator(output[_A],context2)};else return{$unknown:Object.entries(output)[0]}},de_MultipartUpload=(output,context2)=>{const contents={};if(null!=output[_UI])contents[_UI]=expectString(output[_UI]);if(null!=output[_K])contents[_K]=expectString(output[_K]);if(null!=output[_Ini])contents[_Ini]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_Ini]));if(null!=output[_SC])contents[_SC]=expectString(output[_SC]);if(null!=output[_O])contents[_O]=de_Owner(output[_O],context2);if(null!=output[_In])contents[_In]=de_Initiator(output[_In],context2);if(null!=output[_CA])contents[_CA]=expectString(output[_CA]);return contents},de_MultipartUploadList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_MultipartUpload(entry,context2))),de_NoncurrentVersionExpiration=(output,context2)=>{const contents={};if(null!=output[_ND])contents[_ND]=strictParseInt32(output[_ND]);if(null!=output[_NNV])contents[_NNV]=strictParseInt32(output[_NNV]);return contents},de_NoncurrentVersionTransition=(output,context2)=>{const contents={};if(null!=output[_ND])contents[_ND]=strictParseInt32(output[_ND]);if(null!=output[_SC])contents[_SC]=expectString(output[_SC]);if(null!=output[_NNV])contents[_NNV]=strictParseInt32(output[_NNV]);return contents},de_NoncurrentVersionTransitionList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_NoncurrentVersionTransition(entry,context2))),de_NotificationConfigurationFilter=(output,context2)=>{const contents={};if(null!=output[_SKe])contents[_K]=de_S3KeyFilter(output[_SKe],context2);return contents},de__Object=(output,context2)=>{const contents={};if(null!=output[_K])contents[_K]=expectString(output[_K]);if(null!=output[_LM])contents[_LM]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_LM]));if(null!=output[_ETa])contents[_ETa]=expectString(output[_ETa]);if(""===output.ChecksumAlgorithm)contents[_CA]=[];else if(null!=output[_CA])contents[_CA]=de_ChecksumAlgorithmList(getArrayIfSingleItem(output[_CA]),context2);if(null!=output[_Si])contents[_Si]=strictParseLong(output[_Si]);if(null!=output[_SC])contents[_SC]=expectString(output[_SC]);if(null!=output[_O])contents[_O]=de_Owner(output[_O],context2);if(null!=output[_RSe])contents[_RSe]=de_RestoreStatus(output[_RSe],context2);return contents},de_ObjectList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de__Object(entry,context2))),de_ObjectLockConfiguration=(output,context2)=>{const contents={};if(null!=output[_OLE])contents[_OLE]=expectString(output[_OLE]);if(null!=output[_Ru])contents[_Ru]=de_ObjectLockRule(output[_Ru],context2);return contents},de_ObjectLockLegalHold=(output,context2)=>{const contents={};if(null!=output[_S])contents[_S]=expectString(output[_S]);return contents},de_ObjectLockRetention=(output,context2)=>{const contents={};if(null!=output[_Mo])contents[_Mo]=expectString(output[_Mo]);if(null!=output[_RUD])contents[_RUD]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_RUD]));return contents},de_ObjectLockRule=(output,context2)=>{const contents={};if(null!=output[_DRe])contents[_DRe]=de_DefaultRetention(output[_DRe],context2);return contents},de_ObjectPart=(output,context2)=>{const contents={};if(null!=output[_PN])contents[_PN]=strictParseInt32(output[_PN]);if(null!=output[_Si])contents[_Si]=strictParseLong(output[_Si]);if(null!=output[_CCRC])contents[_CCRC]=expectString(output[_CCRC]);if(null!=output[_CCRCC])contents[_CCRCC]=expectString(output[_CCRCC]);if(null!=output[_CSHA])contents[_CSHA]=expectString(output[_CSHA]);if(null!=output[_CSHAh])contents[_CSHAh]=expectString(output[_CSHAh]);return contents},de_ObjectVersion=(output,context2)=>{const contents={};if(null!=output[_ETa])contents[_ETa]=expectString(output[_ETa]);if(""===output.ChecksumAlgorithm)contents[_CA]=[];else if(null!=output[_CA])contents[_CA]=de_ChecksumAlgorithmList(getArrayIfSingleItem(output[_CA]),context2);if(null!=output[_Si])contents[_Si]=strictParseLong(output[_Si]);if(null!=output[_SC])contents[_SC]=expectString(output[_SC]);if(null!=output[_K])contents[_K]=expectString(output[_K]);if(null!=output[_VI])contents[_VI]=expectString(output[_VI]);if(null!=output[_IL])contents[_IL]=parseBoolean(output[_IL]);if(null!=output[_LM])contents[_LM]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_LM]));if(null!=output[_O])contents[_O]=de_Owner(output[_O],context2);if(null!=output[_RSe])contents[_RSe]=de_RestoreStatus(output[_RSe],context2);return contents},de_ObjectVersionList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_ObjectVersion(entry,context2))),de_Owner=(output,context2)=>{const contents={};if(null!=output[_DN])contents[_DN]=expectString(output[_DN]);if(null!=output[_ID_])contents[_ID_]=expectString(output[_ID_]);return contents},de_OwnershipControls=(output,context2)=>{const contents={};if(""===output.Rule)contents[_Rul]=[];else if(null!=output[_Ru])contents[_Rul]=de_OwnershipControlsRules(getArrayIfSingleItem(output[_Ru]),context2);return contents},de_OwnershipControlsRule=(output,context2)=>{const contents={};if(null!=output[_OO])contents[_OO]=expectString(output[_OO]);return contents},de_OwnershipControlsRules=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_OwnershipControlsRule(entry,context2))),de_Part=(output,context2)=>{const contents={};if(null!=output[_PN])contents[_PN]=strictParseInt32(output[_PN]);if(null!=output[_LM])contents[_LM]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_LM]));if(null!=output[_ETa])contents[_ETa]=expectString(output[_ETa]);if(null!=output[_Si])contents[_Si]=strictParseLong(output[_Si]);if(null!=output[_CCRC])contents[_CCRC]=expectString(output[_CCRC]);if(null!=output[_CCRCC])contents[_CCRCC]=expectString(output[_CCRCC]);if(null!=output[_CSHA])contents[_CSHA]=expectString(output[_CSHA]);if(null!=output[_CSHAh])contents[_CSHAh]=expectString(output[_CSHAh]);return contents},de_PartitionedPrefix=(output,context2)=>{const contents={};if(null!=output[_PDS])contents[_PDS]=expectString(output[_PDS]);return contents},de_Parts=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_Part(entry,context2))),de_PartsList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_ObjectPart(entry,context2))),de_PolicyStatus=(output,context2)=>{const contents={};if(null!=output[_IP])contents[_IP]=parseBoolean(output[_IP]);return contents},de_Progress=(output,context2)=>{const contents={};if(null!=output[_BS])contents[_BS]=strictParseLong(output[_BS]);if(null!=output[_BP])contents[_BP]=strictParseLong(output[_BP]);if(null!=output[_BRy])contents[_BRy]=strictParseLong(output[_BRy]);return contents},de_PublicAccessBlockConfiguration=(output,context2)=>{const contents={};if(null!=output[_BPA])contents[_BPA]=parseBoolean(output[_BPA]);if(null!=output[_IPA])contents[_IPA]=parseBoolean(output[_IPA]);if(null!=output[_BPP])contents[_BPP]=parseBoolean(output[_BPP]);if(null!=output[_RPB])contents[_RPB]=parseBoolean(output[_RPB]);return contents},de_QueueConfiguration=(output,context2)=>{const contents={};if(null!=output[_I])contents[_I]=expectString(output[_I]);if(null!=output[_Qu])contents[_QA]=expectString(output[_Qu]);if(""===output.Event)contents[_Eve]=[];else if(null!=output[_Ev])contents[_Eve]=de_EventList(getArrayIfSingleItem(output[_Ev]),context2);if(null!=output[_F])contents[_F]=de_NotificationConfigurationFilter(output[_F],context2);return contents},de_QueueConfigurationList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_QueueConfiguration(entry,context2))),de_Redirect=(output,context2)=>{const contents={};if(null!=output[_HN])contents[_HN]=expectString(output[_HN]);if(null!=output[_HRC])contents[_HRC]=expectString(output[_HRC]);if(null!=output[_Pr])contents[_Pr]=expectString(output[_Pr]);if(null!=output[_RKPW])contents[_RKPW]=expectString(output[_RKPW]);if(null!=output[_RKW])contents[_RKW]=expectString(output[_RKW]);return contents},de_RedirectAllRequestsTo=(output,context2)=>{const contents={};if(null!=output[_HN])contents[_HN]=expectString(output[_HN]);if(null!=output[_Pr])contents[_Pr]=expectString(output[_Pr]);return contents},de_ReplicaModifications=(output,context2)=>{const contents={};if(null!=output[_S])contents[_S]=expectString(output[_S]);return contents},de_ReplicationConfiguration=(output,context2)=>{const contents={};if(null!=output[_Ro])contents[_Ro]=expectString(output[_Ro]);if(""===output.Rule)contents[_Rul]=[];else if(null!=output[_Ru])contents[_Rul]=de_ReplicationRules(getArrayIfSingleItem(output[_Ru]),context2);return contents},de_ReplicationRule=(output,context2)=>{const contents={};if(null!=output[_ID_])contents[_ID_]=expectString(output[_ID_]);if(null!=output[_Pri])contents[_Pri]=strictParseInt32(output[_Pri]);if(null!=output[_P])contents[_P]=expectString(output[_P]);if(""===output.Filter);else if(null!=output[_F])contents[_F]=de_ReplicationRuleFilter(expectUnion(output[_F]),context2);if(null!=output[_S])contents[_S]=expectString(output[_S]);if(null!=output[_SSC])contents[_SSC]=de_SourceSelectionCriteria(output[_SSC],context2);if(null!=output[_EOR])contents[_EOR]=de_ExistingObjectReplication(output[_EOR],context2);if(null!=output[_Des])contents[_Des]=de_Destination(output[_Des],context2);if(null!=output[_DMR])contents[_DMR]=de_DeleteMarkerReplication(output[_DMR],context2);return contents},de_ReplicationRuleAndOperator=(output,context2)=>{const contents={};if(null!=output[_P])contents[_P]=expectString(output[_P]);if(""===output.Tag)contents[_Tag]=[];else if(null!=output[_Ta])contents[_Tag]=de_TagSet(getArrayIfSingleItem(output[_Ta]),context2);return contents},de_ReplicationRuleFilter=(output,context2)=>{if(null!=output[_P])return{Prefix:expectString(output[_P])};if(null!=output[_Ta])return{Tag:de_Tag(output[_Ta],context2)};if(null!=output[_A])return{And:de_ReplicationRuleAndOperator(output[_A],context2)};else return{$unknown:Object.entries(output)[0]}},de_ReplicationRules=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_ReplicationRule(entry,context2))),de_ReplicationTime=(output,context2)=>{const contents={};if(null!=output[_S])contents[_S]=expectString(output[_S]);if(null!=output[_Tim])contents[_Tim]=de_ReplicationTimeValue(output[_Tim],context2);return contents},de_ReplicationTimeValue=(output,context2)=>{const contents={};if(null!=output[_Mi])contents[_Mi]=strictParseInt32(output[_Mi]);return contents},de_RestoreStatus=(output,context2)=>{const contents={};if(null!=output[_IRIP])contents[_IRIP]=parseBoolean(output[_IRIP]);if(null!=output[_RED])contents[_RED]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_RED]));return contents},de_RoutingRule=(output,context2)=>{const contents={};if(null!=output[_Con])contents[_Con]=de_Condition(output[_Con],context2);if(null!=output[_Red])contents[_Red]=de_Redirect(output[_Red],context2);return contents},de_RoutingRules=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_RoutingRule(entry,context2))),de_S3KeyFilter=(output,context2)=>{const contents={};if(""===output.FilterRule)contents[_FRi]=[];else if(null!=output[_FR])contents[_FRi]=de_FilterRuleList(getArrayIfSingleItem(output[_FR]),context2);return contents},de_ServerSideEncryptionByDefault=(output,context2)=>{const contents={};if(null!=output[_SSEA])contents[_SSEA]=expectString(output[_SSEA]);if(null!=output[_KMSMKID])contents[_KMSMKID]=expectString(output[_KMSMKID]);return contents},de_ServerSideEncryptionConfiguration=(output,context2)=>{const contents={};if(""===output.Rule)contents[_Rul]=[];else if(null!=output[_Ru])contents[_Rul]=de_ServerSideEncryptionRules(getArrayIfSingleItem(output[_Ru]),context2);return contents},de_ServerSideEncryptionRule=(output,context2)=>{const contents={};if(null!=output[_ASSEBD])contents[_ASSEBD]=de_ServerSideEncryptionByDefault(output[_ASSEBD],context2);if(null!=output[_BKE])contents[_BKE]=parseBoolean(output[_BKE]);return contents},de_ServerSideEncryptionRules=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_ServerSideEncryptionRule(entry,context2))),de_SessionCredentials=(output,context2)=>{const contents={};if(null!=output[_AKI])contents[_AKI]=expectString(output[_AKI]);if(null!=output[_SAK])contents[_SAK]=expectString(output[_SAK]);if(null!=output[_ST])contents[_ST]=expectString(output[_ST]);if(null!=output[_Exp])contents[_Exp]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_Exp]));return contents},de_SimplePrefix=(output,context2)=>({}),de_SourceSelectionCriteria=(output,context2)=>{const contents={};if(null!=output[_SKEO])contents[_SKEO]=de_SseKmsEncryptedObjects(output[_SKEO],context2);if(null!=output[_RM])contents[_RM]=de_ReplicaModifications(output[_RM],context2);return contents},de_SSEKMS=(output,context2)=>{const contents={};if(null!=output[_KI])contents[_KI]=expectString(output[_KI]);return contents},de_SseKmsEncryptedObjects=(output,context2)=>{const contents={};if(null!=output[_S])contents[_S]=expectString(output[_S]);return contents},de_SSES3=(output,context2)=>({}),de_Stats=(output,context2)=>{const contents={};if(null!=output[_BS])contents[_BS]=strictParseLong(output[_BS]);if(null!=output[_BP])contents[_BP]=strictParseLong(output[_BP]);if(null!=output[_BRy])contents[_BRy]=strictParseLong(output[_BRy]);return contents},de_StorageClassAnalysis=(output,context2)=>{const contents={};if(null!=output[_DE])contents[_DE]=de_StorageClassAnalysisDataExport(output[_DE],context2);return contents},de_StorageClassAnalysisDataExport=(output,context2)=>{const contents={};if(null!=output[_OSV])contents[_OSV]=expectString(output[_OSV]);if(null!=output[_Des])contents[_Des]=de_AnalyticsExportDestination(output[_Des],context2);return contents},de_Tag=(output,context2)=>{const contents={};if(null!=output[_K])contents[_K]=expectString(output[_K]);if(null!=output[_Va])contents[_Va]=expectString(output[_Va]);return contents},de_TagSet=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_Tag(entry,context2))),de_TargetGrant=(output,context2)=>{const contents={};if(null!=output[_Gra])contents[_Gra]=de_Grantee(output[_Gra],context2);if(null!=output[_Pe])contents[_Pe]=expectString(output[_Pe]);return contents},de_TargetGrants=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_TargetGrant(entry,context2))),de_TargetObjectKeyFormat=(output,context2)=>{const contents={};if(null!=output[_SPi])contents[_SPi]=de_SimplePrefix(output[_SPi],context2);if(null!=output[_PP])contents[_PP]=de_PartitionedPrefix(output[_PP],context2);return contents},de_Tiering=(output,context2)=>{const contents={};if(null!=output[_Da])contents[_Da]=strictParseInt32(output[_Da]);if(null!=output[_AT])contents[_AT]=expectString(output[_AT]);return contents},de_TieringList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_Tiering(entry,context2))),de_TopicConfiguration=(output,context2)=>{const contents={};if(null!=output[_I])contents[_I]=expectString(output[_I]);if(null!=output[_Top])contents[_TA]=expectString(output[_Top]);if(""===output.Event)contents[_Eve]=[];else if(null!=output[_Ev])contents[_Eve]=de_EventList(getArrayIfSingleItem(output[_Ev]),context2);if(null!=output[_F])contents[_F]=de_NotificationConfigurationFilter(output[_F],context2);return contents},de_TopicConfigurationList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_TopicConfiguration(entry,context2))),de_Transition=(output,context2)=>{const contents={};if(null!=output[_Dat])contents[_Dat]=expectNonNull(parseRfc3339DateTimeWithOffset(output[_Dat]));if(null!=output[_Da])contents[_Da]=strictParseInt32(output[_Da]);if(null!=output[_SC])contents[_SC]=expectString(output[_SC]);return contents},de_TransitionList=(output,context2)=>(output||[]).filter((e4=>null!=e4)).map((entry=>de_Transition(entry,context2))),deserializeMetadata2=output=>{var _a5,_b2;return{httpStatusCode:output.statusCode,requestId:null!=(_b2=null!=(_a5=output.headers["x-amzn-requestid"])?_a5:output.headers["x-amzn-request-id"])?_b2:output.headers["x-amz-request-id"],extendedRequestId:output.headers["x-amz-id-2"],cfId:output.headers["x-amz-cf-id"]}},collectBodyString2=(streamBody,context2)=>collectBody(streamBody,context2).then((body=>context2.utf8Encoder(body))),isSerializableHeaderValue=value=>!(null==value||""===value||Object.getOwnPropertyNames(value).includes("length")&&0==value.length||Object.getOwnPropertyNames(value).includes("size")&&0==value.size),_A="And",_AAO="AnalyticsAndOperator",_AC="AnalyticsConfiguration",_ACL="ACL",_ACLc="AccessControlList",_ACLn="AnalyticsConfigurationList",_ACP="AccessControlPolicy",_ACT="AccessControlTranslation",_ACc="AccelerateConfiguration",_AD="AbortDate",_AED="AnalyticsExportDestination",_AF="AnalyticsFilter",_AH="AllowedHeader",_AHl="AllowedHeaders",_AI="AnalyticsId",_AIMU="AbortIncompleteMultipartUpload",_AIc="AccountId",_AKI="AccessKeyId",_AM="AllowedMethod",_AMl="AllowedMethods",_AO="AllowedOrigin",_AOl="AllowedOrigins",_APA="AccessPointAlias",_APAc="AccessPointArn",_AQRD="AllowQuotedRecordDelimiter",_AR="AcceptRanges",_ARI="AbortRuleId",_AS="ArchiveStatus",_ASBD="AnalyticsS3BucketDestination",_ASEFF="AnalyticsS3ExportFileFormat",_ASSEBD="ApplyServerSideEncryptionByDefault",_AT="AccessTier",_Ac="Account",_B="Bucket",_BAI="BucketAccountId",_BAS="BucketAccelerateStatus",_BGR="BypassGovernanceRetention",_BI="BucketInfo",_BKE="BucketKeyEnabled",_BLC="BucketLifecycleConfiguration",_BLCu="BucketLocationConstraint",_BLN="BucketLocationName",_BLP="BucketLogsPermission",_BLS="BucketLoggingStatus",_BLT="BucketLocationType",_BN="BucketName",_BP="BytesProcessed",_BPA="BlockPublicAcls",_BPP="BlockPublicPolicy",_BR="BucketRegion",_BRy="BytesReturned",_BS="BytesScanned",_BT="BucketType",_BVS="BucketVersioningStatus",_Bu="Buckets",_C="Credentials",_CA="ChecksumAlgorithm",_CACL="CannedACL",_CBC="CreateBucketConfiguration",_CC="CacheControl",_CCRC="ChecksumCRC32",_CCRCC="ChecksumCRC32C",_CD="ContentDisposition",_CDr="CreationDate",_CE="ContentEncoding",_CF="CloudFunction",_CFC="CloudFunctionConfiguration",_CL="ContentLanguage",_CLo="ContentLength",_CM="ChecksumMode",_CMD="ContentMD5",_CMU="CompletedMultipartUpload",_CORSC="CORSConfiguration",_CORSR="CORSRule",_CORSRu="CORSRules",_CP="CommonPrefixes",_CPo="CompletedPart",_CR="ContentRange",_CRSBA="ConfirmRemoveSelfBucketAccess",_CS="CopySource",_CSHA="ChecksumSHA1",_CSHAh="ChecksumSHA256",_CSIM="CopySourceIfMatch",_CSIMS="CopySourceIfModifiedSince",_CSINM="CopySourceIfNoneMatch",_CSIUS="CopySourceIfUnmodifiedSince",_CSR="CopySourceRange",_CSSSECA="CopySourceSSECustomerAlgorithm",_CSSSECK="CopySourceSSECustomerKey",_CSSSECKMD="CopySourceSSECustomerKeyMD5",_CSV="CSV",_CSVI="CopySourceVersionId",_CSVIn="CSVInput",_CSVO="CSVOutput",_CT="ContentType",_CTo="ContinuationToken",_CTom="CompressionType",_Ch="Checksum",_Co="Contents",_Cod="Code",_Com="Comments",_Con="Condition",_D="Delimiter",_DAI="DaysAfterInitiation",_DE="DataExport",_DM="DeleteMarker",_DMR="DeleteMarkerReplication",_DMRS="DeleteMarkerReplicationStatus",_DMVI="DeleteMarkerVersionId",_DMe="DeleteMarkers",_DN="DisplayName",_DR="DataRedundancy",_DRe="DefaultRetention",_Da="Days",_Dat="Date",_De="Deleted",_Del="Delete",_Des="Destination",_Desc="Description",_E="Expires",_EA="EmailAddress",_EBC="EventBridgeConfiguration",_EBO="ExpectedBucketOwner",_EC="ErrorCode",_ECn="EncryptionConfiguration",_ED="ErrorDocument",_EH="ExposeHeaders",_EHx="ExposeHeader",_EM="ErrorMessage",_EODM="ExpiredObjectDeleteMarker",_EOR="ExistingObjectReplication",_EORS="ExistingObjectReplicationStatus",_ERP="EnableRequestProgress",_ES="ExpiresString",_ESBO="ExpectedSourceBucketOwner",_ESx="ExpirationStatus",_ET="EncodingType",_ETa="ETag",_ETn="EncryptionType",_ETv="EventThreshold",_ETx="ExpressionType",_En="Encryption",_Ena="Enabled",_End="End",_Er="Error",_Err="Errors",_Ev="Event",_Eve="Events",_Ex="Expression",_Exp="Expiration",_F="Filter",_FD="FieldDelimiter",_FHI="FileHeaderInfo",_FO="FetchOwner",_FR="FilterRule",_FRN="FilterRuleName",_FRV="FilterRuleValue",_FRi="FilterRules",_Fi="Field",_Fo="Format",_Fr="Frequency",_G="Grant",_GFC="GrantFullControl",_GJP="GlacierJobParameters",_GR="GrantRead",_GRACP="GrantReadACP",_GW="GrantWrite",_GWACP="GrantWriteACP",_Gr="Grants",_Gra="Grantee",_HECRE="HttpErrorCodeReturnedEquals",_HN="HostName",_HRC="HttpRedirectCode",_I="Id",_IC="InventoryConfiguration",_ICL="InventoryConfigurationList",_ID="IndexDocument",_ID_="ID",_IDn="InventoryDestination",_IE="IsEnabled",_IEn="InventoryEncryption",_IF="InventoryFilter",_IFn="InventoryFormat",_IFnv="InventoryFrequency",_II="InventoryId",_IIOV="InventoryIncludedObjectVersions",_IL="IsLatest",_IM="IfMatch",_IMS="IfModifiedSince",_INM="IfNoneMatch",_IOF="InventoryOptionalField",_IOV="IncludedObjectVersions",_IP="IsPublic",_IPA="IgnorePublicAcls",_IRIP="IsRestoreInProgress",_IS="InputSerialization",_ISBD="InventoryS3BucketDestination",_ISn="InventorySchedule",_IT="IsTruncated",_ITAO="IntelligentTieringAndOperator",_ITAT="IntelligentTieringAccessTier",_ITC="IntelligentTieringConfiguration",_ITCL="IntelligentTieringConfigurationList",_ITD="IntelligentTieringDays",_ITF="IntelligentTieringFilter",_ITI="IntelligentTieringId",_ITS="IntelligentTieringStatus",_IUS="IfUnmodifiedSince",_In="Initiator",_Ini="Initiated",_JSON="JSON",_JSONI="JSONInput",_JSONO="JSONOutput",_JSONT="JSONType",_K="Key",_KC="KeyCount",_KI="KeyId",_KM="KeyMarker",_KMSC="KMSContext",_KMSKI="KMSKeyId",_KMSMKID="KMSMasterKeyID",_KPE="KeyPrefixEquals",_L="Location",_LC="LocationConstraint",_LE="LoggingEnabled",_LEi="LifecycleExpiration",_LFA="LambdaFunctionArn",_LFC="LambdaFunctionConfigurations",_LFCa="LambdaFunctionConfiguration",_LI="LocationInfo",_LM="LastModified",_LNAS="LocationNameAsString",_LP="LocationPrefix",_LR="LifecycleRule",_LRAO="LifecycleRuleAndOperator",_LRF="LifecycleRuleFilter",_LT="LocationType",_M="Marker",_MAO="MetricsAndOperator",_MAS="MaxAgeSeconds",_MB="MaxBuckets",_MC="MetricsConfiguration",_MCL="MetricsConfigurationList",_MD="MetadataDirective",_MDB="MaxDirectoryBuckets",_MDf="MfaDelete",_ME="MetadataEntry",_MF="MetricsFilter",_MFA="MFA",_MFAD="MFADelete",_MI="MetricsId",_MK="MaxKeys",_MKe="MetadataKey",_MM="MissingMeta",_MP="MaxParts",_MS="MetricsStatus",_MU="MaxUploads",_MV="MetadataValue",_Me="Metrics",_Mes="Message",_Mi="Minutes",_Mo="Mode",_N="Name",_NC="NotificationConfiguration",_NCF="NotificationConfigurationFilter",_NCT="NextContinuationToken",_ND="NoncurrentDays",_NI="NotificationId",_NKM="NextKeyMarker",_NM="NextMarker",_NNV="NewerNoncurrentVersions",_NPNM="NextPartNumberMarker",_NUIM="NextUploadIdMarker",_NVE="NoncurrentVersionExpiration",_NVIM="NextVersionIdMarker",_NVT="NoncurrentVersionTransitions",_NVTo="NoncurrentVersionTransition",_O="Owner",_OA="ObjectAttributes",_OC="OwnershipControls",_OCACL="ObjectCannedACL",_OCR="OwnershipControlsRule",_OF="OptionalFields",_OI="ObjectIdentifier",_OK="ObjectKey",_OL="OutputLocation",_OLC="ObjectLockConfiguration",_OLE="ObjectLockEnabled",_OLEFB="ObjectLockEnabledForBucket",_OLLH="ObjectLockLegalHold",_OLLHS="ObjectLockLegalHoldStatus",_OLM="ObjectLockMode",_OLR="ObjectLockRetention",_OLRM="ObjectLockRetentionMode",_OLRUD="ObjectLockRetainUntilDate",_OLRb="ObjectLockRule",_OO="ObjectOwnership",_OOA="OptionalObjectAttributes",_OOw="OwnerOverride",_OP="ObjectParts",_OS="OutputSerialization",_OSGT="ObjectSizeGreaterThan",_OSGTB="ObjectSizeGreaterThanBytes",_OSLT="ObjectSizeLessThan",_OSLTB="ObjectSizeLessThanBytes",_OSV="OutputSchemaVersion",_OSb="ObjectSize",_OVI="ObjectVersionId",_Ob="Objects",_P="Prefix",_PABC="PublicAccessBlockConfiguration",_PC="PartsCount",_PDS="PartitionDateSource",_PI="ParquetInput",_PN="PartNumber",_PNM="PartNumberMarker",_PP="PartitionedPrefix",_Pa="Payer",_Par="Part",_Parq="Parquet",_Part="Parts",_Pe="Permission",_Pr="Protocol",_Pri="Priority",_Q="Quiet",_QA="QueueArn",_QC="QueueConfiguration",_QCu="QueueConfigurations",_QCuo="QuoteCharacter",_QEC="QuoteEscapeCharacter",_QF="QuoteFields",_Qu="Queue",_R="Range",_RART="RedirectAllRequestsTo",_RC="RequestCharged",_RCC="ResponseCacheControl",_RCD="ResponseContentDisposition",_RCE="ResponseContentEncoding",_RCL="ResponseContentLanguage",_RCT="ResponseContentType",_RCe="ReplicationConfiguration",_RD="RecordDelimiter",_RE="ResponseExpires",_RED="RestoreExpiryDate",_RKKID="ReplicaKmsKeyID",_RKPW="ReplaceKeyPrefixWith",_RKW="ReplaceKeyWith",_RM="ReplicaModifications",_RMS="ReplicaModificationsStatus",_ROP="RestoreOutputPath",_RP="RequestPayer",_RPB="RestrictPublicBuckets",_RPC="RequestPaymentConfiguration",_RPe="RequestProgress",_RR="RequestRoute",_RRAO="ReplicationRuleAndOperator",_RRF="ReplicationRuleFilter",_RRS="ReplicationRuleStatus",_RRT="RestoreRequestType",_RRe="ReplicationRule",_RRes="RestoreRequest",_RRo="RoutingRules",_RRou="RoutingRule",_RS="ReplicationStatus",_RSe="RestoreStatus",_RT="RequestToken",_RTS="ReplicationTimeStatus",_RTV="ReplicationTimeValue",_RTe="ReplicationTime",_RUD="RetainUntilDate",_Re="Restore",_Red="Redirect",_Ro="Role",_Ru="Rule",_Rul="Rules",_S="Status",_SA="StartAfter",_SAK="SecretAccessKey",_SBD="S3BucketDestination",_SC="StorageClass",_SCA="StorageClassAnalysis",_SCADE="StorageClassAnalysisDataExport",_SCASV="StorageClassAnalysisSchemaVersion",_SCt="StatusCode",_SDV="SkipDestinationValidation",_SK="SSE-KMS",_SKEO="SseKmsEncryptedObjects",_SKEOS="SseKmsEncryptedObjectsStatus",_SKF="S3KeyFilter",_SKe="S3Key",_SL="S3Location",_SM="SessionMode",_SOCR="SelectObjectContentRequest",_SP="SelectParameters",_SPi="SimplePrefix",_SR="ScanRange",_SS="SSE-S3",_SSC="SourceSelectionCriteria",_SSE="ServerSideEncryption",_SSEA="SSEAlgorithm",_SSEBD="ServerSideEncryptionByDefault",_SSEC="ServerSideEncryptionConfiguration",_SSECA="SSECustomerAlgorithm",_SSECK="SSECustomerKey",_SSECKMD="SSECustomerKeyMD5",_SSEKMS="SSEKMS",_SSEKMSEC="SSEKMSEncryptionContext",_SSEKMSKI="SSEKMSKeyId",_SSER="ServerSideEncryptionRule",_SSES="SSES3",_ST="SessionToken",_S_="S3",_Sc="Schedule",_Se="Setting",_Si="Size",_St="Start",_Su="Suffix",_T="Tagging",_TA="TopicArn",_TB="TargetBucket",_TC="TagCount",_TCo="TopicConfiguration",_TCop="TopicConfigurations",_TD="TaggingDirective",_TG="TargetGrants",_TGa="TargetGrant",_TOKF="TargetObjectKeyFormat",_TP="TargetPrefix",_TPC="TotalPartsCount",_TS="TagSet",_TSC="TransitionStorageClass",_Ta="Tag",_Tag="Tags",_Ti="Tier",_Tie="Tierings",_Tier="Tiering",_Tim="Time",_To="Token",_Top="Topic",_Tr="Transitions",_Tra="Transition",_Ty="Type",_U="Upload",_UI="UploadId",_UIM="UploadIdMarker",_UM="UserMetadata",_URI="URI",_Up="Uploads",_V="Version",_VC="VersionCount",_VCe="VersioningConfiguration",_VI="VersionId",_VIM="VersionIdMarker",_Va="Value",_Ve="Versions",_WC="WebsiteConfiguration",_WRL="WebsiteRedirectLocation",_Y="Years",_a3="analytics",_ac="accelerate",_acl="acl",_ar="accept-ranges",_at="attributes",_c="cors",_cc="cache-control",_cd="content-disposition",_ce="content-encoding",_cl="content-language",_cl_="content-length",_cm="content-md5",_cr="content-range",_ct="content-type",_ct_="continuation-token",_d="delete",_de="delimiter",_e="expires",_en="encryption",_et="encoding-type",_eta="etag",_ex="expiresstring",_fo="fetch-owner",_i="id",_im="if-match",_ims="if-modified-since",_in="inventory",_inm="if-none-match",_it="intelligent-tiering",_ius="if-unmodified-since",_km="key-marker",_l="lifecycle",_lh="legal-hold",_lm="last-modified",_lo="location",_log="logging",_lt="list-type",_m="metrics",_ma="marker",_mb="max-buckets",_mdb="max-directory-buckets",_me="member",_mk="max-keys",_mp="max-parts",_mu="max-uploads",_n="notification",_oC="ownershipControls",_ol="object-lock",_p="policy",_pAB="publicAccessBlock",_pN="partNumber",_pS="policyStatus",_pnm="part-number-marker",_pr="prefix",_r="replication",_rP="requestPayment",_ra="range",_rcc="response-cache-control",_rcd="response-content-disposition",_rce="response-content-encoding",_rcl="response-content-language",_rct="response-content-type",_re="response-expires",_res="restore",_ret="retention",_s="session",_sa="start-after",_se="select",_st="select-type",_t="tagging",_to="torrent",_u="uploads",_uI="uploadId",_uim="upload-id-marker",_v="versioning",_vI="versionId",_ve='<?xml version="1.0" encoding="UTF-8"?>',_ver="versions",_vim="version-id-marker",_w="website",_x="xsi:type",_xaa="x-amz-acl",_xaad="x-amz-abort-date",_xaapa="x-amz-access-point-alias",_xaari="x-amz-abort-rule-id",_xaas="x-amz-archive-status",_xabgr="x-amz-bypass-governance-retention",_xabln="x-amz-bucket-location-name",_xablt="x-amz-bucket-location-type",_xabole="x-amz-bucket-object-lock-enabled",_xabolt="x-amz-bucket-object-lock-token",_xabr="x-amz-bucket-region",_xaca="x-amz-checksum-algorithm",_xacc="x-amz-checksum-crc32",_xacc_="x-amz-checksum-crc32c",_xacm="x-amz-checksum-mode",_xacrsba="x-amz-confirm-remove-self-bucket-access",_xacs="x-amz-checksum-sha1",_xacs_="x-amz-checksum-sha256",_xacs__="x-amz-copy-source",_xacsim="x-amz-copy-source-if-match",_xacsims="x-amz-copy-source-if-modified-since",_xacsinm="x-amz-copy-source-if-none-match",_xacsius="x-amz-copy-source-if-unmodified-since",_xacsm="x-amz-create-session-mode",_xacsr="x-amz-copy-source-range",_xacssseca="x-amz-copy-source-server-side-encryption-customer-algorithm",_xacssseck="x-amz-copy-source-server-side-encryption-customer-key",_xacssseckm="x-amz-copy-source-server-side-encryption-customer-key-md5",_xacsvi="x-amz-copy-source-version-id",_xadm="x-amz-delete-marker",_xae="x-amz-expiration",_xaebo="x-amz-expected-bucket-owner",_xafec="x-amz-fwd-error-code",_xafem="x-amz-fwd-error-message",_xafhar="x-amz-fwd-header-accept-ranges",_xafhcc="x-amz-fwd-header-cache-control",_xafhcd="x-amz-fwd-header-content-disposition",_xafhce="x-amz-fwd-header-content-encoding",_xafhcl="x-amz-fwd-header-content-language",_xafhcr="x-amz-fwd-header-content-range",_xafhct="x-amz-fwd-header-content-type",_xafhe="x-amz-fwd-header-etag",_xafhe_="x-amz-fwd-header-expires",_xafhlm="x-amz-fwd-header-last-modified",_xafhxacc="x-amz-fwd-header-x-amz-checksum-crc32",_xafhxacc_="x-amz-fwd-header-x-amz-checksum-crc32c",_xafhxacs="x-amz-fwd-header-x-amz-checksum-sha1",_xafhxacs_="x-amz-fwd-header-x-amz-checksum-sha256",_xafhxadm="x-amz-fwd-header-x-amz-delete-marker",_xafhxae="x-amz-fwd-header-x-amz-expiration",_xafhxamm="x-amz-fwd-header-x-amz-missing-meta",_xafhxampc="x-amz-fwd-header-x-amz-mp-parts-count",_xafhxaollh="x-amz-fwd-header-x-amz-object-lock-legal-hold",_xafhxaolm="x-amz-fwd-header-x-amz-object-lock-mode",_xafhxaolrud="x-amz-fwd-header-x-amz-object-lock-retain-until-date",_xafhxar="x-amz-fwd-header-x-amz-restore",_xafhxarc="x-amz-fwd-header-x-amz-request-charged",_xafhxars="x-amz-fwd-header-x-amz-replication-status",_xafhxasc="x-amz-fwd-header-x-amz-storage-class",_xafhxasse="x-amz-fwd-header-x-amz-server-side-encryption",_xafhxasseakki="x-amz-fwd-header-x-amz-server-side-encryption-aws-kms-key-id",_xafhxassebke="x-amz-fwd-header-x-amz-server-side-encryption-bucket-key-enabled",_xafhxasseca="x-amz-fwd-header-x-amz-server-side-encryption-customer-algorithm",_xafhxasseckm="x-amz-fwd-header-x-amz-server-side-encryption-customer-key-md5",_xafhxatc="x-amz-fwd-header-x-amz-tagging-count",_xafhxavi="x-amz-fwd-header-x-amz-version-id",_xafs="x-amz-fwd-status",_xagfc="x-amz-grant-full-control",_xagr="x-amz-grant-read",_xagra="x-amz-grant-read-acp",_xagw="x-amz-grant-write",_xagwa="x-amz-grant-write-acp",_xam="x-amz-mfa",_xamd="x-amz-metadata-directive",_xamm="x-amz-missing-meta",_xamp="x-amz-max-parts",_xampc="x-amz-mp-parts-count",_xaoa="x-amz-object-attributes",_xaollh="x-amz-object-lock-legal-hold",_xaolm="x-amz-object-lock-mode",_xaolrud="x-amz-object-lock-retain-until-date",_xaoo="x-amz-object-ownership",_xaooa="x-amz-optional-object-attributes",_xapnm="x-amz-part-number-marker",_xar="x-amz-restore",_xarc="x-amz-request-charged",_xarop="x-amz-restore-output-path",_xarp="x-amz-request-payer",_xarr="x-amz-request-route",_xars="x-amz-replication-status",_xart="x-amz-request-token",_xasc="x-amz-storage-class",_xasca="x-amz-sdk-checksum-algorithm",_xasdv="x-amz-skip-destination-validation",_xasebo="x-amz-source-expected-bucket-owner",_xasse="x-amz-server-side-encryption",_xasseakki="x-amz-server-side-encryption-aws-kms-key-id",_xassebke="x-amz-server-side-encryption-bucket-key-enabled",_xassec="x-amz-server-side-encryption-context",_xasseca="x-amz-server-side-encryption-customer-algorithm",_xasseck="x-amz-server-side-encryption-customer-key",_xasseckm="x-amz-server-side-encryption-customer-key-md5",_xat="x-amz-tagging",_xatc="x-amz-tagging-count",_xatd="x-amz-tagging-directive",_xavi="x-amz-version-id",_xawrl="x-amz-website-redirect-location",_xi="x-id",CreateSessionCommand=class extends(Command.classBuilder().ep({...commonParams,DisableS3ExpressSessionAuth:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","CreateSession",{}).n("S3Client","CreateSessionCommand").f(void 0,CreateSessionOutputFilterSensitiveLog).ser(se_CreateSessionCommand).de(de_CreateSessionCommand).build()){},package_default={name:"@aws-sdk/client-s3",description:"AWS SDK for JavaScript S3 Client for Node.js, Browser and React Native",version:"3.645.0",scripts:{build:"concurrently 'yarn:build:cjs' 'yarn:build:es' 'yarn:build:types'","build:cjs":"node ../../scripts/compilation/inline client-s3","build:es":"tsc -p tsconfig.es.json","build:include:deps":"lerna run --scope $npm_package_name --include-dependencies build","build:types":"tsc -p tsconfig.types.json","build:types:downlevel":"downlevel-dts dist-types dist-types/ts3.4",clean:"rimraf ./dist-* && rimraf *.tsbuildinfo","extract:docs":"api-extractor run --local","generate:client":"node ../../scripts/generate-clients/single-service --solo s3",test:"yarn test:unit","test:e2e":"yarn test:e2e:node && yarn test:e2e:browser","test:e2e:browser":"ts-mocha test/**/*.browser.ispec.ts && karma start karma.conf.js","test:e2e:node":"jest --c jest.config.e2e.js","test:unit":"ts-mocha test/unit/**/*.spec.ts"},main:"./dist-cjs/index.js",types:"./dist-types/index.d.ts",module:"./dist-es/index.js",sideEffects:false,dependencies:{"@aws-crypto/sha1-browser":"5.2.0","@aws-crypto/sha256-browser":"5.2.0","@aws-crypto/sha256-js":"5.2.0","@aws-sdk/client-sso-oidc":"3.645.0","@aws-sdk/client-sts":"3.645.0","@aws-sdk/core":"3.635.0","@aws-sdk/credential-provider-node":"3.645.0","@aws-sdk/middleware-bucket-endpoint":"3.620.0","@aws-sdk/middleware-expect-continue":"3.620.0","@aws-sdk/middleware-flexible-checksums":"3.620.0","@aws-sdk/middleware-host-header":"3.620.0","@aws-sdk/middleware-location-constraint":"3.609.0","@aws-sdk/middleware-logger":"3.609.0","@aws-sdk/middleware-recursion-detection":"3.620.0","@aws-sdk/middleware-sdk-s3":"3.635.0","@aws-sdk/middleware-ssec":"3.609.0","@aws-sdk/middleware-user-agent":"3.645.0","@aws-sdk/region-config-resolver":"3.614.0","@aws-sdk/signature-v4-multi-region":"3.635.0","@aws-sdk/types":"3.609.0","@aws-sdk/util-endpoints":"3.645.0","@aws-sdk/util-user-agent-browser":"3.609.0","@aws-sdk/util-user-agent-node":"3.614.0","@aws-sdk/xml-builder":"3.609.0","@smithy/config-resolver":"^3.0.5","@smithy/core":"^2.4.0","@smithy/eventstream-serde-browser":"^3.0.6","@smithy/eventstream-serde-config-resolver":"^3.0.3","@smithy/eventstream-serde-node":"^3.0.5","@smithy/fetch-http-handler":"^3.2.4","@smithy/hash-blob-browser":"^3.1.2","@smithy/hash-node":"^3.0.3","@smithy/hash-stream-node":"^3.1.2","@smithy/invalid-dependency":"^3.0.3","@smithy/md5-js":"^3.0.3","@smithy/middleware-content-length":"^3.0.5","@smithy/middleware-endpoint":"^3.1.0","@smithy/middleware-retry":"^3.0.15","@smithy/middleware-serde":"^3.0.3","@smithy/middleware-stack":"^3.0.3","@smithy/node-config-provider":"^3.1.4","@smithy/node-http-handler":"^3.1.4","@smithy/protocol-http":"^4.1.0","@smithy/smithy-client":"^3.2.0","@smithy/types":"^3.3.0","@smithy/url-parser":"^3.0.3","@smithy/util-base64":"^3.0.0","@smithy/util-body-length-browser":"^3.0.0","@smithy/util-body-length-node":"^3.0.0","@smithy/util-defaults-mode-browser":"^3.0.15","@smithy/util-defaults-mode-node":"^3.0.15","@smithy/util-endpoints":"^2.0.5","@smithy/util-middleware":"^3.0.3","@smithy/util-retry":"^3.0.3","@smithy/util-stream":"^3.1.3","@smithy/util-utf8":"^3.0.0","@smithy/util-waiter":"^3.1.2",tslib:"^2.6.2"},devDependencies:{"@aws-sdk/signature-v4-crt":"3.635.0","@tsconfig/node16":"16.1.3","@types/chai":"^4.2.11","@types/mocha":"^8.0.4","@types/node":"^16.18.96",concurrently:"7.0.0","downlevel-dts":"0.10.1",rimraf:"3.0.2",typescript:"~4.9.5"},engines:{node:">=16.0.0"},typesVersions:{"<4.0":{"dist-types/*":["dist-types/ts3.4/*"]}},files:["dist-*/**"],author:{name:"AWS SDK for JavaScript Team",url:"https://aws.amazon.com/javascript/"},license:"Apache-2.0",browser:{"./dist-es/runtimeConfig":"./dist-es/runtimeConfig.browser"},"react-native":{"./dist-es/runtimeConfig":"./dist-es/runtimeConfig.native"},homepage:"https://github.com/aws/aws-sdk-js-v3/tree/main/clients/client-s3",repository:{type:"git",url:"https://github.com/aws/aws-sdk-js-v3.git",directory:"clients/client-s3"}},fromUtf82=input=>(new TextEncoder).encode(input),toUint8Array2=data=>{if("string"==typeof data)return fromUtf82(data);if(ArrayBuffer.isView(data))return new Uint8Array(data.buffer,data.byteOffset,data.byteLength/Uint8Array.BYTES_PER_ELEMENT);else return new Uint8Array(data)};function isEmptyData(data){if("string"==typeof data)return 0===data.length;else return 0===data.byteLength}var SHA_1_HASH={name:"SHA-1"},SHA_1_HMAC_ALGO={name:"HMAC",hash:SHA_1_HASH},EMPTY_DATA_SHA_1=new Uint8Array([218,57,163,238,94,107,75,13,50,85,191,239,149,96,24,144,175,216,7,9]),fallbackWindow={};function locateWindow(){if("undefined"!=typeof window)return window;else if("undefined"!=typeof self)return self;return fallbackWindow}var Sha1=function(){function Sha13(secret){this.toHash=new Uint8Array(0);if(void 0!==secret){this.key=new Promise((function(resolve,reject){locateWindow().crypto.subtle.importKey("raw",convertToBuffer(secret),SHA_1_HMAC_ALGO,false,["sign"]).then(resolve,reject)}));this.key.catch((function(){}))}}Sha13.prototype.update=function(data){if(!isEmptyData(data)){var update2=convertToBuffer(data),typedArray=new Uint8Array(this.toHash.byteLength+update2.byteLength);typedArray.set(this.toHash,0);typedArray.set(update2,this.toHash.byteLength);this.toHash=typedArray}};Sha13.prototype.digest=function(){var _this=this;if(this.key)return this.key.then((function(key2){return locateWindow().crypto.subtle.sign(SHA_1_HMAC_ALGO,key2,_this.toHash).then((function(data){return new Uint8Array(data)}))}));if(isEmptyData(this.toHash))return Promise.resolve(EMPTY_DATA_SHA_1);else return Promise.resolve().then((function(){return locateWindow().crypto.subtle.digest(SHA_1_HASH,_this.toHash)})).then((function(data){return Promise.resolve(new Uint8Array(data))}))};Sha13.prototype.reset=function(){this.toHash=new Uint8Array(0)};return Sha13}();function convertToBuffer(data){if("string"==typeof data)return fromUtf82(data);if(ArrayBuffer.isView(data))return new Uint8Array(data.buffer,data.byteOffset,data.byteLength/Uint8Array.BYTES_PER_ELEMENT);else return new Uint8Array(data)}var extendStatics=function(d4,b3){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d5,b5){d5.__proto__=b5}||function(d5,b5){for(var p2 in b5)if(Object.prototype.hasOwnProperty.call(b5,p2))d5[p2]=b5[p2]})(d4,b3)};function __extends(d4,b3){if("function"!=typeof b3&&null!==b3)throw new TypeError("Class extends value "+String(b3)+" is not a constructor or null");extendStatics(d4,b3);function __(){this.constructor=d4}d4.prototype=null===b3?Object.create(b3):(__.prototype=b3.prototype,new __)}var __assign=function(){__assign=Object.assign||function __assign2(t4){for(var s2,i2=1,n3=arguments.length;i2<n3;i2++){s2=arguments[i2];for(var p2 in s2)if(Object.prototype.hasOwnProperty.call(s2,p2))t4[p2]=s2[p2]}return t4};return __assign.apply(this,arguments)};function __rest(s2,e4){var t4={};for(var p2 in s2)if(Object.prototype.hasOwnProperty.call(s2,p2)&&e4.indexOf(p2)<0)t4[p2]=s2[p2];if(null!=s2&&"function"==typeof Object.getOwnPropertySymbols){var i2=0;for(p2=Object.getOwnPropertySymbols(s2);i2<p2.length;i2++)if(e4.indexOf(p2[i2])<0&&Object.prototype.propertyIsEnumerable.call(s2,p2[i2]))t4[p2[i2]]=s2[p2[i2]]}return t4}function __decorate(decorators,target,key2,desc){var d4,c2=arguments.length,r2=c2<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key2):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r2=Reflect.decorate(decorators,target,key2,desc);else for(var i2=decorators.length-1;i2>=0;i2--)if(d4=decorators[i2])r2=(c2<3?d4(r2):c2>3?d4(target,key2,r2):d4(target,key2))||r2;return c2>3&&r2&&Object.defineProperty(target,key2,r2),r2}function __param(paramIndex,decorator){return function(target,key2){decorator(target,key2,paramIndex)}}function __esDecorate(ctor,descriptorIn,decorators,contextIn,initializers,extraInitializers){function accept(f4){if(void 0!==f4&&"function"!=typeof f4)throw new TypeError("Function expected");return f4}for(var _,kind=contextIn.kind,key2="getter"===kind?"get":"setter"===kind?"set":"value",target=!descriptorIn&&ctor?contextIn["static"]?ctor:ctor.prototype:null,descriptor=descriptorIn||(target?Object.getOwnPropertyDescriptor(target,contextIn.name):{}),done=false,i2=decorators.length-1;i2>=0;i2--){var context2={};for(var p2 in contextIn)context2[p2]="access"===p2?{}:contextIn[p2];for(var p2 in contextIn.access)context2.access[p2]=contextIn.access[p2];context2.addInitializer=function(f4){if(done)throw new TypeError("Cannot add initializers after decoration has completed");extraInitializers.push(accept(f4||null))};var result=(0,decorators[i2])("accessor"===kind?{get:descriptor.get,set:descriptor.set}:descriptor[key2],context2);if("accessor"===kind){if(void 0===result)continue;if(null===result||"object"!=typeof result)throw new TypeError("Object expected");if(_=accept(result.get))descriptor.get=_;if(_=accept(result.set))descriptor.set=_;if(_=accept(result.init))initializers.unshift(_)}else if(_=accept(result))if("field"===kind)initializers.unshift(_);else descriptor[key2]=_}if(target)Object.defineProperty(target,contextIn.name,descriptor);done=true}function __runInitializers(thisArg,initializers,value){for(var useValue=arguments.length>2,i2=0;i2<initializers.length;i2++)value=useValue?initializers[i2].call(thisArg,value):initializers[i2].call(thisArg);return useValue?value:void 0}function __propKey(x2){return"symbol"==typeof x2?x2:"".concat(x2)}function __setFunctionName(f4,name,prefix){if("symbol"==typeof name)name=name.description?"[".concat(name.description,"]"):"";return Object.defineProperty(f4,"name",{configurable:true,value:prefix?"".concat(prefix," ",name):name})}function __metadata(metadataKey,metadataValue){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(metadataKey,metadataValue)}function __awaiter(thisArg,_arguments,P2,generator){return new(P2||(P2=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e4){reject(e4)}}function rejected(value){try{step(generator["throw"](value))}catch(e4){reject(e4)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P2?value:new P2((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))}function __generator(thisArg,body){var f4,y2,t4,_={label:0,sent:function(){if(1&t4[0])throw t4[1];return t4[1]},trys:[],ops:[]},g2=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return g2.next=verb(0),g2["throw"]=verb(1),g2["return"]=verb(2),"function"==typeof Symbol&&(g2[Symbol.iterator]=function(){return this}),g2;function verb(n3){return function(v2){return function step(op){if(f4)throw new TypeError("Generator is already executing.");for(;g2&&(g2=0,op[0]&&(_=0)),_;)try{if(f4=1,y2&&(t4=2&op[0]?y2["return"]:op[0]?y2["throw"]||((t4=y2["return"])&&t4.call(y2),0):y2.next)&&!(t4=t4.call(y2,op[1])).done)return t4;if(y2=0,t4)op=[2&op[0],t4.value];switch(op[0]){case 0:case 1:t4=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y2=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t4=_.trys,t4=t4.length>0&&t4[t4.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t4||op[1]>t4[0]&&op[1]<t4[3])){_.label=op[1];break}if(6===op[0]&&_.label<t4[1]){_.label=t4[1];t4=op;break}if(t4&&_.label<t4[2]){_.label=t4[2];_.ops.push(op);break}if(t4[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e4){op=[6,e4];y2=0}finally{f4=t4=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:true}}([n3,v2])}}}var __createBinding=Object.create?function(o2,m2,k2,k22){if(void 0===k22)k22=k2;var desc=Object.getOwnPropertyDescriptor(m2,k2);if(!desc||("get"in desc?!m2.__esModule:desc.writable||desc.configurable))desc={enumerable:true,get:function(){return m2[k2]}};Object.defineProperty(o2,k22,desc)}:function(o2,m2,k2,k22){if(void 0===k22)k22=k2;o2[k22]=m2[k2]};function __exportStar(m2,o2){for(var p2 in m2)if("default"!==p2&&!Object.prototype.hasOwnProperty.call(o2,p2))__createBinding(o2,m2,p2)}function __values(o2){var s2="function"==typeof Symbol&&Symbol.iterator,m2=s2&&o2[s2],i2=0;if(m2)return m2.call(o2);if(o2&&"number"==typeof o2.length)return{next:function(){if(o2&&i2>=o2.length)o2=void 0;return{value:o2&&o2[i2++],done:!o2}}};throw new TypeError(s2?"Object is not iterable.":"Symbol.iterator is not defined.")}function __read(o2,n3){var m2="function"==typeof Symbol&&o2[Symbol.iterator];if(!m2)return o2;var r2,e4,i2=m2.call(o2),ar2=[];try{for(;(void 0===n3||n3-- >0)&&!(r2=i2.next()).done;)ar2.push(r2.value)}catch(error){e4={error}}finally{try{if(r2&&!r2.done&&(m2=i2["return"]))m2.call(i2)}finally{if(e4)throw e4.error}}return ar2}function __spread(){for(var ar2=[],i2=0;i2<arguments.length;i2++)ar2=ar2.concat(__read(arguments[i2]));return ar2}function __spreadArrays(){for(var s2=0,i2=0,il=arguments.length;i2<il;i2++)s2+=arguments[i2].length;var r2=Array(s2),k2=0;for(i2=0;i2<il;i2++)for(var a2=arguments[i2],j2=0,jl=a2.length;j2<jl;j2++,k2++)r2[k2]=a2[j2];return r2}function __spreadArray(to,from,pack){if(pack||2===arguments.length)for(var ar2,i2=0,l2=from.length;i2<l2;i2++)if(ar2||!(i2 in from)){if(!ar2)ar2=Array.prototype.slice.call(from,0,i2);ar2[i2]=from[i2]}return to.concat(ar2||Array.prototype.slice.call(from))}function __await(v2){return this instanceof __await?(this.v=v2,this):new __await(v2)}function __asyncGenerator(thisArg,_arguments,generator){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i2,g2=generator.apply(thisArg,_arguments||[]),q2=[];return i2=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),verb("next"),verb("throw"),verb("return",(function awaitReturn(f4){return function(v2){return Promise.resolve(v2).then(f4,reject)}})),i2[Symbol.asyncIterator]=function(){return this},i2;function verb(n3,f4){if(g2[n3]){i2[n3]=function(v2){return new Promise((function(a2,b3){q2.push([n3,v2,a2,b3])>1||resume(n3,v2)}))};if(f4)i2[n3]=f4(i2[n3])}}function resume(n3,v2){try{(function step(r2){r2.value instanceof __await?Promise.resolve(r2.value.v).then(fulfill,reject):settle(q2[0][2],r2)})(g2[n3](v2))}catch(e4){settle(q2[0][3],e4)}}function fulfill(value){resume("next",value)}function reject(value){resume("throw",value)}function settle(f4,v2){if(f4(v2),q2.shift(),q2.length)resume(q2[0][0],q2[0][1])}}function __asyncDelegator(o2){var i2,p2;return i2={},verb("next"),verb("throw",(function(e4){throw e4})),verb("return"),i2[Symbol.iterator]=function(){return this},i2;function verb(n3,f4){i2[n3]=o2[n3]?function(v2){return(p2=!p2)?{value:__await(o2[n3](v2)),done:false}:f4?f4(v2):v2}:f4}}function __asyncValues(o2){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i2,m2=o2[Symbol.asyncIterator];return m2?m2.call(o2):(o2="function"==typeof __values?__values(o2):o2[Symbol.iterator](),i2={},verb("next"),verb("throw"),verb("return"),i2[Symbol.asyncIterator]=function(){return this},i2);function verb(n3){i2[n3]=o2[n3]&&function(v2){return new Promise((function(resolve,reject){(function settle(resolve,reject,d4,v2){Promise.resolve(v2).then((function(v3){resolve({value:v3,done:d4})}),reject)})(resolve,reject,(v2=o2[n3](v2)).done,v2.value)}))}}}function __makeTemplateObject(cooked,raw){if(Object.defineProperty)Object.defineProperty(cooked,"raw",{value:raw});else cooked.raw=raw;return cooked}var __setModuleDefault=Object.create?function(o2,v2){Object.defineProperty(o2,"default",{enumerable:true,value:v2})}:function(o2,v2){o2["default"]=v2};function __importStar(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k2 in mod)if("default"!==k2&&Object.prototype.hasOwnProperty.call(mod,k2))__createBinding(result,mod,k2);__setModuleDefault(result,mod);return result}function __importDefault(mod){return mod&&mod.__esModule?mod:{default:mod}}function __classPrivateFieldGet(receiver,state,kind,f4){if("a"===kind&&!f4)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f4:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f4:"a"===kind?f4.call(receiver):f4?f4.value:state.get(receiver)}function __classPrivateFieldSet(receiver,state,value,kind,f4){if("m"===kind)throw new TypeError("Private method is not writable");if("a"===kind&&!f4)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof state?receiver!==state||!f4:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===kind?f4.call(receiver,value):f4?f4.value=value:state.set(receiver,value),value}function __classPrivateFieldIn(state,receiver){if(null===receiver||"object"!=typeof receiver&&"function"!=typeof receiver)throw new TypeError("Cannot use 'in' operator on non-object");return"function"==typeof state?receiver===state:state.has(receiver)}function __addDisposableResource(env,value,async){if(null!=value){if("object"!=typeof value&&"function"!=typeof value)throw new TypeError("Object expected.");var dispose,inner;if(async){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");dispose=value[Symbol.asyncDispose]}if(void 0===dispose){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");dispose=value[Symbol.dispose];if(async)inner=dispose}if("function"!=typeof dispose)throw new TypeError("Object not disposable.");if(inner)dispose=function(){try{inner.call(this)}catch(e4){return Promise.reject(e4)}};env.stack.push({value,dispose,async})}else if(async)env.stack.push({async:true});return value}var _SuppressedError="function"==typeof SuppressedError?SuppressedError:function(error,suppressed,message){var e4=new Error(message);return e4.name="SuppressedError",e4.error=error,e4.suppressed=suppressed,e4};function __disposeResources(env){function fail(e4){env.error=env.hasError?new _SuppressedError(e4,env.error,"An error was suppressed during disposal."):e4;env.hasError=true}var r2,s2=0;return function next(){for(;r2=env.stack.pop();)try{if(!r2.async&&1===s2)return s2=0,env.stack.push(r2),Promise.resolve().then(next);if(r2.dispose){var result=r2.dispose.call(r2.value);if(r2.async)return s2|=2,Promise.resolve(result).then(next,(function(e4){fail(e4);return next()}))}else s2|=1}catch(e4){fail(e4)}if(1===s2)return env.hasError?Promise.reject(env.error):Promise.resolve();if(env.hasError)throw env.error}()}var tslib_es6_default={__extends,__assign,__rest,__decorate,__param,__metadata,__awaiter,__generator,__createBinding,__exportStar,__values,__read,__spread,__spreadArrays,__spreadArray,__await,__asyncGenerator,__asyncDelegator,__asyncValues,__makeTemplateObject,__importStar,__importDefault,__classPrivateFieldGet,__classPrivateFieldSet,__classPrivateFieldIn,__addDisposableResource,__disposeResources},subtleCryptoMethods=["decrypt","digest","encrypt","exportKey","generateKey","importKey","sign","verify"];function supportsWebCrypto(window2){if(supportsSecureRandom(window2)&&"object"==typeof window2.crypto.subtle)return supportsSubtleCrypto(window2.crypto.subtle);else return false}function supportsSecureRandom(window2){if("object"==typeof window2&&"object"==typeof window2.crypto)return"function"==typeof window2.crypto.getRandomValues;else return false}function supportsSubtleCrypto(subtle){return subtle&&subtleCryptoMethods.every((function(methodName){return"function"==typeof subtle[methodName]}))}function supportsZeroByteGCM(subtle){return __awaiter(this,void 0,void 0,(function(){var key2;return __generator(this,(function(_b2){switch(_b2.label){case 0:if(!supportsSubtleCrypto(subtle))return[2,false];_b2.label=1;case 1:_b2.trys.push([1,4,,5]);return[4,subtle.generateKey({name:"AES-GCM",length:128},false,["encrypt"])];case 2:key2=_b2.sent();return[4,subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(Array(12)),additionalData:new Uint8Array(Array(16)),tagLength:128},key2,new Uint8Array(0))];case 3:return[2,16===_b2.sent().byteLength];case 4:_b2.sent();return[2,false];case 5:return[2]}}))}))}var fromUtf83=input=>(new TextEncoder).encode(input),toUint8Array3=data=>{if("string"==typeof data)return fromUtf83(data);if(ArrayBuffer.isView(data))return new Uint8Array(data.buffer,data.byteOffset,data.byteLength/Uint8Array.BYTES_PER_ELEMENT);else return new Uint8Array(data)},fromUtf84="undefined"!=typeof Buffer&&Buffer.from?function(input){return Buffer.from(input,"utf8")}:fromUtf83;function convertToBuffer2(data){if(data instanceof Uint8Array)return data;if("string"==typeof data)return fromUtf84(data);if(ArrayBuffer.isView(data))return new Uint8Array(data.buffer,data.byteOffset,data.byteLength/Uint8Array.BYTES_PER_ELEMENT);else return new Uint8Array(data)}function isEmptyData2(data){if("string"==typeof data)return 0===data.length;else return 0===data.byteLength}function numToUint8(num){return new Uint8Array([(4278190080&num)>>24,(16711680&num)>>16,(65280&num)>>8,255&num])}function uint32ArrayFrom(a_lookUpTable2){if(!Uint32Array.from){for(var return_array=new Uint32Array(a_lookUpTable2.length),a_index=0;a_index<a_lookUpTable2.length;){return_array[a_index]=a_lookUpTable2[a_index];a_index+=1}return return_array}return Uint32Array.from(a_lookUpTable2)}var Sha12=function(){function Sha13(secret){if(supportsWebCrypto(locateWindow()))this.hash=new Sha1(secret);else throw new Error("SHA1 not supported")}Sha13.prototype.update=function(data,encoding){this.hash.update(convertToBuffer2(data))};Sha13.prototype.digest=function(){return this.hash.digest()};Sha13.prototype.reset=function(){this.hash.reset()};return Sha13}(),SHA_256_HASH={name:"SHA-256"},SHA_256_HMAC_ALGO={name:"HMAC",hash:SHA_256_HASH},EMPTY_DATA_SHA_256=new Uint8Array([227,176,196,66,152,252,28,20,154,251,244,200,153,111,185,36,39,174,65,228,100,155,147,76,164,149,153,27,120,82,184,85]),Sha256=function(){function Sha2564(secret){this.toHash=new Uint8Array(0);this.secret=secret;this.reset()}Sha2564.prototype.update=function(data){if(!isEmptyData2(data)){var update2=convertToBuffer2(data),typedArray=new Uint8Array(this.toHash.byteLength+update2.byteLength);typedArray.set(this.toHash,0);typedArray.set(update2,this.toHash.byteLength);this.toHash=typedArray}};Sha2564.prototype.digest=function(){var _this=this;if(this.key)return this.key.then((function(key2){return locateWindow().crypto.subtle.sign(SHA_256_HMAC_ALGO,key2,_this.toHash).then((function(data){return new Uint8Array(data)}))}));if(isEmptyData2(this.toHash))return Promise.resolve(EMPTY_DATA_SHA_256);else return Promise.resolve().then((function(){return locateWindow().crypto.subtle.digest(SHA_256_HASH,_this.toHash)})).then((function(data){return Promise.resolve(new Uint8Array(data))}))};Sha2564.prototype.reset=function(){var _this=this;this.toHash=new Uint8Array(0);if(this.secret&&void 0!==this.secret){this.key=new Promise((function(resolve,reject){locateWindow().crypto.subtle.importKey("raw",convertToBuffer2(_this.secret),SHA_256_HMAC_ALGO,false,["sign"]).then(resolve,reject)}));this.key.catch((function(){}))}};return Sha2564}(),BLOCK_SIZE=64,DIGEST_LENGTH=32,KEY=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),INIT=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],MAX_HASHABLE_LENGTH=Math.pow(2,53)-1,RawSha256=function(){function RawSha2562(){this.state=Int32Array.from(INIT);this.temp=new Int32Array(64);this.buffer=new Uint8Array(64);this.bufferLength=0;this.bytesHashed=0;this.finished=false}RawSha2562.prototype.update=function(data){if(this.finished)throw new Error("Attempted to update an already finished hash.");var position=0,byteLength=data.byteLength;this.bytesHashed+=byteLength;if(8*this.bytesHashed>MAX_HASHABLE_LENGTH)throw new Error("Cannot hash more than 2^53 - 1 bits");for(;byteLength>0;){this.buffer[this.bufferLength++]=data[position++];byteLength--;if(this.bufferLength===BLOCK_SIZE){this.hashBuffer();this.bufferLength=0}}};RawSha2562.prototype.digest=function(){if(!this.finished){var bitsHashed=8*this.bytesHashed,bufferView=new DataView(this.buffer.buffer,this.buffer.byteOffset,this.buffer.byteLength),undecoratedLength=this.bufferLength;bufferView.setUint8(this.bufferLength++,128);if(undecoratedLength%BLOCK_SIZE>=BLOCK_SIZE-8){for(var i2=this.bufferLength;i2<BLOCK_SIZE;i2++)bufferView.setUint8(i2,0);this.hashBuffer();this.bufferLength=0}for(i2=this.bufferLength;i2<BLOCK_SIZE-8;i2++)bufferView.setUint8(i2,0);bufferView.setUint32(BLOCK_SIZE-8,Math.floor(bitsHashed/4294967296),true);bufferView.setUint32(BLOCK_SIZE-4,bitsHashed);this.hashBuffer();this.finished=true}var out=new Uint8Array(DIGEST_LENGTH);for(i2=0;i2<8;i2++){out[4*i2]=this.state[i2]>>>24&255;out[4*i2+1]=this.state[i2]>>>16&255;out[4*i2+2]=this.state[i2]>>>8&255;out[4*i2+3]=this.state[i2]>>>0&255}return out};RawSha2562.prototype.hashBuffer=function(){for(var buffer=this.buffer,state=this.state,state0=state[0],state1=state[1],state2=state[2],state3=state[3],state4=state[4],state5=state[5],state6=state[6],state7=state[7],i2=0;i2<BLOCK_SIZE;i2++){if(i2<16)this.temp[i2]=(255&buffer[4*i2])<<24|(255&buffer[4*i2+1])<<16|(255&buffer[4*i2+2])<<8|255&buffer[4*i2+3];else{var u2=this.temp[i2-2],t1_1=(u2>>>17|u2<<15)^(u2>>>19|u2<<13)^u2>>>10,t2_1=((u2=this.temp[i2-15])>>>7|u2<<25)^(u2>>>18|u2<<14)^u2>>>3;this.temp[i2]=(t1_1+this.temp[i2-7]|0)+(t2_1+this.temp[i2-16]|0)}var t1=(((state4>>>6|state4<<26)^(state4>>>11|state4<<21)^(state4>>>25|state4<<7))+(state4&state5^~state4&state6)|0)+(state7+(KEY[i2]+this.temp[i2]|0)|0)|0,t22=((state0>>>2|state0<<30)^(state0>>>13|state0<<19)^(state0>>>22|state0<<10))+(state0&state1^state0&state2^state1&state2)|0;state7=state6;state6=state5;state5=state4;state4=state3+t1|0;state3=state2;state2=state1;state1=state0;state0=t1+t22|0}state[0]+=state0;state[1]+=state1;state[2]+=state2;state[3]+=state3;state[4]+=state4;state[5]+=state5;state[6]+=state6;state[7]+=state7};return RawSha2562}(),Sha2562=function(){function Sha2564(secret){this.secret=secret;this.hash=new RawSha256;this.reset()}Sha2564.prototype.update=function(toHash){if(!isEmptyData2(toHash)&&!this.error)try{this.hash.update(convertToBuffer2(toHash))}catch(e4){this.error=e4}};Sha2564.prototype.digestSync=function(){if(this.error)throw this.error;if(this.outer){if(!this.outer.finished)this.outer.update(this.hash.digest());return this.outer.digest()}return this.hash.digest()};Sha2564.prototype.digest=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a5){return[2,this.digestSync()]}))}))};Sha2564.prototype.reset=function(){this.hash=new RawSha256;if(this.secret){this.outer=new RawSha256;var inner=bufferFromSecret(this.secret),outer=new Uint8Array(BLOCK_SIZE);outer.set(inner);for(var i2=0;i2<BLOCK_SIZE;i2++){inner[i2]^=54;outer[i2]^=92}this.hash.update(inner);this.outer.update(outer);for(i2=0;i2<inner.byteLength;i2++)inner[i2]=0}};return Sha2564}();function bufferFromSecret(secret){var input=convertToBuffer2(secret);if(input.byteLength>BLOCK_SIZE){var bufferHash=new RawSha256;bufferHash.update(input);input=bufferHash.digest()}var buffer=new Uint8Array(BLOCK_SIZE);buffer.set(input);return buffer}var Sha2563=function(){function Sha2564(secret){if(supportsWebCrypto(locateWindow()))this.hash=new Sha256(secret);else this.hash=new Sha2562(secret)}Sha2564.prototype.update=function(data,encoding){this.hash.update(convertToBuffer2(data))};Sha2564.prototype.digest=function(){return this.hash.digest()};Sha2564.prototype.reset=function(){this.hash.reset()};return Sha2564}(),import_bowser=__toESM(require_es5()),defaultUserAgent=({serviceId,clientVersion})=>async()=>{var _a5,_b2,_c2,_d2,_e2,_f,_g;const parsedUA="undefined"!=typeof window&&(null==(_a5=null==window?void 0:window.navigator)?void 0:_a5.userAgent)?import_bowser.default.parse(window.navigator.userAgent):void 0,sections=[["aws-sdk-js",clientVersion],["ua","2.0"],[`os/${(null==(_b2=null==parsedUA?void 0:parsedUA.os)?void 0:_b2.name)||"other"}`,null==(_c2=null==parsedUA?void 0:parsedUA.os)?void 0:_c2.version],["lang/js"],["md/browser",`${null!=(_e2=null==(_d2=null==parsedUA?void 0:parsedUA.browser)?void 0:_d2.name)?_e2:"unknown"}_${null!=(_g=null==(_f=null==parsedUA?void 0:parsedUA.browser)?void 0:_f.version)?_g:"unknown"}`]];if(serviceId)sections.push([`api/${serviceId}`,clientVersion]);return sections},AwsCrc32=function(){function AwsCrc322(){this.crc32=new Crc32}AwsCrc322.prototype.update=function(toHash){if(!isEmptyData2(toHash))this.crc32.update(convertToBuffer2(toHash))};AwsCrc322.prototype.digest=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a5){return[2,numToUint8(this.crc32.digest())]}))}))};AwsCrc322.prototype.reset=function(){this.crc32=new Crc32};return AwsCrc322}();function crc32(data){return(new Crc32).update(data).digest()}var Crc32=function(){function Crc322(){this.checksum=4294967295}Crc322.prototype.update=function(data){var e_1,_a5;try{for(var data_1=__values(data),data_1_1=data_1.next();!data_1_1.done;data_1_1=data_1.next()){var byte=data_1_1.value;this.checksum=this.checksum>>>8^lookupTable[255&(this.checksum^byte)]}}catch(e_1_1){e_1={error:e_1_1}}finally{try{if(data_1_1&&!data_1_1.done&&(_a5=data_1.return))_a5.call(data_1)}finally{if(e_1)throw e_1.error}}return this};Crc322.prototype.digest=function(){return(4294967295^this.checksum)>>>0};return Crc322}(),a_lookUpTable=[0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117],lookupTable=uint32ArrayFrom(a_lookUpTable),Int642=class _Int64{constructor(bytes){this.bytes=bytes;if(8!==bytes.byteLength)throw new Error("Int64 buffers must be exactly 8 bytes")}static fromNumber(number){if(number>0x8000000000000000||number<-0x8000000000000000)throw new Error(`${number} is too large (or, if negative, too small) to represent as an Int64`);const bytes=new Uint8Array(8);for(let i2=7,remaining=Math.abs(Math.round(number));i2>-1&&remaining>0;i2--,remaining/=256)bytes[i2]=remaining;if(number<0)negate2(bytes);return new _Int64(bytes)}valueOf(){const bytes=this.bytes.slice(0),negative=128&bytes[0];if(negative)negate2(bytes);return parseInt(toHex(bytes),16)*(negative?-1:1)}toString(){return String(this.valueOf())}};function negate2(bytes){for(let i2=0;i2<8;i2++)bytes[i2]^=255;for(let i2=7;i2>-1;i2--){bytes[i2]++;if(0!==bytes[i2])break}}var HEADER_VALUE_TYPE2,HeaderMarshaller=class{constructor(toUtf82,fromUtf85){this.toUtf8=toUtf82;this.fromUtf8=fromUtf85}format(headers){const chunks=[];for(const headerName of Object.keys(headers)){const bytes=this.fromUtf8(headerName);chunks.push(Uint8Array.from([bytes.byteLength]),bytes,this.formatHeaderValue(headers[headerName]))}const out=new Uint8Array(chunks.reduce(((carry,bytes)=>carry+bytes.byteLength),0));let position=0;for(const chunk of chunks){out.set(chunk,position);position+=chunk.byteLength}return out}formatHeaderValue(header){switch(header.type){case"boolean":return Uint8Array.from([header.value?0:1]);case"byte":return Uint8Array.from([2,header.value]);case"short":const shortView=new DataView(new ArrayBuffer(3));shortView.setUint8(0,3);shortView.setInt16(1,header.value,false);return new Uint8Array(shortView.buffer);case"integer":const intView=new DataView(new ArrayBuffer(5));intView.setUint8(0,4);intView.setInt32(1,header.value,false);return new Uint8Array(intView.buffer);case"long":const longBytes=new Uint8Array(9);longBytes[0]=5;longBytes.set(header.value.bytes,1);return longBytes;case"binary":const binView=new DataView(new ArrayBuffer(3+header.value.byteLength));binView.setUint8(0,6);binView.setUint16(1,header.value.byteLength,false);const binBytes=new Uint8Array(binView.buffer);binBytes.set(header.value,3);return binBytes;case"string":const utf8Bytes=this.fromUtf8(header.value),strView=new DataView(new ArrayBuffer(3+utf8Bytes.byteLength));strView.setUint8(0,7);strView.setUint16(1,utf8Bytes.byteLength,false);const strBytes=new Uint8Array(strView.buffer);strBytes.set(utf8Bytes,3);return strBytes;case"timestamp":const tsBytes=new Uint8Array(9);tsBytes[0]=8;tsBytes.set(Int642.fromNumber(header.value.valueOf()).bytes,1);return tsBytes;case"uuid":if(!UUID_PATTERN2.test(header.value))throw new Error(`Invalid UUID received: ${header.value}`);const uuidBytes=new Uint8Array(17);uuidBytes[0]=9;uuidBytes.set(fromHex(header.value.replace(/\-/g,"")),1);return uuidBytes}}parse(headers){const out={};let position=0;for(;position<headers.byteLength;){const nameLength=headers.getUint8(position++),name=this.toUtf8(new Uint8Array(headers.buffer,headers.byteOffset+position,nameLength));position+=nameLength;switch(headers.getUint8(position++)){case 0:out[name]={type:BOOLEAN_TAG,value:true};break;case 1:out[name]={type:BOOLEAN_TAG,value:false};break;case 2:out[name]={type:BYTE_TAG,value:headers.getInt8(position++)};break;case 3:out[name]={type:SHORT_TAG,value:headers.getInt16(position,false)};position+=2;break;case 4:out[name]={type:INT_TAG,value:headers.getInt32(position,false)};position+=4;break;case 5:out[name]={type:LONG_TAG,value:new Int642(new Uint8Array(headers.buffer,headers.byteOffset+position,8))};position+=8;break;case 6:const binaryLength=headers.getUint16(position,false);position+=2;out[name]={type:BINARY_TAG,value:new Uint8Array(headers.buffer,headers.byteOffset+position,binaryLength)};position+=binaryLength;break;case 7:const stringLength=headers.getUint16(position,false);position+=2;out[name]={type:STRING_TAG,value:this.toUtf8(new Uint8Array(headers.buffer,headers.byteOffset+position,stringLength))};position+=stringLength;break;case 8:out[name]={type:TIMESTAMP_TAG,value:new Date(new Int642(new Uint8Array(headers.buffer,headers.byteOffset+position,8)).valueOf())};position+=8;break;case 9:const uuidBytes=new Uint8Array(headers.buffer,headers.byteOffset+position,16);position+=16;out[name]={type:UUID_TAG,value:`${toHex(uuidBytes.subarray(0,4))}-${toHex(uuidBytes.subarray(4,6))}-${toHex(uuidBytes.subarray(6,8))}-${toHex(uuidBytes.subarray(8,10))}-${toHex(uuidBytes.subarray(10))}`};break;default:throw new Error("Unrecognized header type tag")}}return out}};(function(HEADER_VALUE_TYPE3){HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["boolTrue"]=0]="boolTrue";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["boolFalse"]=1]="boolFalse";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["byte"]=2]="byte";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["short"]=3]="short";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["integer"]=4]="integer";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["long"]=5]="long";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["byteArray"]=6]="byteArray";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["string"]=7]="string";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["timestamp"]=8]="timestamp";HEADER_VALUE_TYPE3[HEADER_VALUE_TYPE3["uuid"]=9]="uuid"})(HEADER_VALUE_TYPE2||(HEADER_VALUE_TYPE2={}));var BOOLEAN_TAG="boolean",BYTE_TAG="byte",SHORT_TAG="short",INT_TAG="integer",LONG_TAG="long",BINARY_TAG="binary",STRING_TAG="string",TIMESTAMP_TAG="timestamp",UUID_TAG="uuid",UUID_PATTERN2=/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/,PRELUDE_MEMBER_LENGTH=4,PRELUDE_LENGTH=2*PRELUDE_MEMBER_LENGTH,CHECKSUM_LENGTH=4,MINIMUM_MESSAGE_LENGTH=PRELUDE_LENGTH+2*CHECKSUM_LENGTH;function splitMessage({byteLength,byteOffset,buffer}){if(byteLength<MINIMUM_MESSAGE_LENGTH)throw new Error("Provided message too short to accommodate event stream message overhead");const view=new DataView(buffer,byteOffset,byteLength),messageLength=view.getUint32(0,false);if(byteLength!==messageLength)throw new Error("Reported message length does not match received message length");const headerLength=view.getUint32(PRELUDE_MEMBER_LENGTH,false),expectedPreludeChecksum=view.getUint32(PRELUDE_LENGTH,false),expectedMessageChecksum=view.getUint32(byteLength-CHECKSUM_LENGTH,false),checksummer=(new Crc32).update(new Uint8Array(buffer,byteOffset,PRELUDE_LENGTH));if(expectedPreludeChecksum!==checksummer.digest())throw new Error(`The prelude checksum specified in the message (${expectedPreludeChecksum}) does not match the calculated CRC32 checksum (${checksummer.digest()})`);checksummer.update(new Uint8Array(buffer,byteOffset+PRELUDE_LENGTH,byteLength-(PRELUDE_LENGTH+CHECKSUM_LENGTH)));if(expectedMessageChecksum!==checksummer.digest())throw new Error(`The message checksum (${checksummer.digest()}) did not match the expected value of ${expectedMessageChecksum}`);return{headers:new DataView(buffer,byteOffset+PRELUDE_LENGTH+CHECKSUM_LENGTH,headerLength),body:new Uint8Array(buffer,byteOffset+PRELUDE_LENGTH+CHECKSUM_LENGTH+headerLength,messageLength-headerLength-(PRELUDE_LENGTH+CHECKSUM_LENGTH+CHECKSUM_LENGTH))}}var EventStreamCodec=class{constructor(toUtf82,fromUtf85){this.headerMarshaller=new HeaderMarshaller(toUtf82,fromUtf85);this.messageBuffer=[];this.isEndOfStream=false}feed(message){this.messageBuffer.push(this.decode(message))}endOfStream(){this.isEndOfStream=true}getMessage(){const message=this.messageBuffer.pop(),isEndOfStream=this.isEndOfStream;return{getMessage:()=>message,isEndOfStream:()=>isEndOfStream}}getAvailableMessages(){const messages=this.messageBuffer;this.messageBuffer=[];const isEndOfStream=this.isEndOfStream;return{getMessages:()=>messages,isEndOfStream:()=>isEndOfStream}}encode({headers:rawHeaders,body}){const headers=this.headerMarshaller.format(rawHeaders),length=headers.byteLength+body.byteLength+16,out=new Uint8Array(length),view=new DataView(out.buffer,out.byteOffset,out.byteLength),checksum=new Crc32;view.setUint32(0,length,false);view.setUint32(4,headers.byteLength,false);view.setUint32(8,checksum.update(out.subarray(0,8)).digest(),false);out.set(headers,12);out.set(body,headers.byteLength+12);view.setUint32(length-4,checksum.update(out.subarray(8,length-4)).digest(),false);return out}decode(message){const{headers,body}=splitMessage(message);return{headers:this.headerMarshaller.parse(headers),body}}formatHeaders(rawHeaders){return this.headerMarshaller.format(rawHeaders)}},MessageDecoderStream=class{constructor(options){this.options=options}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const bytes of this.options.inputStream){const decoded=this.options.decoder.decode(bytes);yield decoded}}},MessageEncoderStream=class{constructor(options){this.options=options}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const msg of this.options.messageStream){const encoded=this.options.encoder.encode(msg);yield encoded}if(this.options.includeEndFrame)yield new Uint8Array(0)}},SmithyMessageDecoderStream=class{constructor(options){this.options=options}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const message of this.options.messageStream){const deserialized=await this.options.deserializer(message);if(void 0!==deserialized)yield deserialized}}},SmithyMessageEncoderStream=class{constructor(options){this.options=options}[Symbol.asyncIterator](){return this.asyncIterator()}async*asyncIterator(){for await(const chunk of this.options.inputStream){const payloadBuf=this.options.serializer(chunk);yield payloadBuf}}};function getChunkedStream(source){let currentMessageTotalLength=0,currentMessagePendingLength=0,currentMessage=null,messageLengthBuffer=null;const allocateMessage=size=>{if("number"!=typeof size)throw new Error("Attempted to allocate an event message where size was not a number: "+size);currentMessageTotalLength=size;currentMessagePendingLength=4;currentMessage=new Uint8Array(size);new DataView(currentMessage.buffer).setUint32(0,size,false)};return{[Symbol.asyncIterator]:async function*(){const sourceIterator=source[Symbol.asyncIterator]();for(;;){const{value,done}=await sourceIterator.next();if(done){if(!currentMessageTotalLength)return;else if(currentMessageTotalLength===currentMessagePendingLength)yield currentMessage;else throw new Error("Truncated event message received.");return}const chunkLength=value.length;let currentOffset=0;for(;currentOffset<chunkLength;){if(!currentMessage){const bytesRemaining=chunkLength-currentOffset;if(!messageLengthBuffer)messageLengthBuffer=new Uint8Array(4);const numBytesForTotal=Math.min(4-currentMessagePendingLength,bytesRemaining);messageLengthBuffer.set(value.slice(currentOffset,currentOffset+numBytesForTotal),currentMessagePendingLength);currentMessagePendingLength+=numBytesForTotal;currentOffset+=numBytesForTotal;if(currentMessagePendingLength<4)break;allocateMessage(new DataView(messageLengthBuffer.buffer).getUint32(0,false));messageLengthBuffer=null}const numBytesToWrite=Math.min(currentMessageTotalLength-currentMessagePendingLength,chunkLength-currentOffset);currentMessage.set(value.slice(currentOffset,currentOffset+numBytesToWrite),currentMessagePendingLength);currentMessagePendingLength+=numBytesToWrite;currentOffset+=numBytesToWrite;if(currentMessageTotalLength&&currentMessageTotalLength===currentMessagePendingLength){yield currentMessage;currentMessage=null;currentMessageTotalLength=0;currentMessagePendingLength=0}}}}}}function getUnmarshalledStream(source,options){const messageUnmarshaller=getMessageUnmarshaller(options.deserializer,options.toUtf8);return{[Symbol.asyncIterator]:async function*(){for await(const chunk of source){const message=options.eventStreamCodec.decode(chunk),type=await messageUnmarshaller(message);if(void 0!==type)yield type}}}}function getMessageUnmarshaller(deserializer,toUtf82){return async function(message){const{value:messageType}=message.headers[":message-type"];if("error"===messageType){const unmodeledError=new Error(message.headers[":error-message"].value||"UnknownError");unmodeledError.name=message.headers[":error-code"].value;throw unmodeledError}else if("exception"===messageType){const code=message.headers[":exception-type"].value,exception={[code]:message},deserializedException=await deserializer(exception);if(deserializedException.$unknown){const error=new Error(toUtf82(message.body));error.name=code;throw error}throw deserializedException[code]}else if("event"===messageType){const event={[message.headers[":event-type"].value]:message},deserialized=await deserializer(event);if(deserialized.$unknown)return;return deserialized}else throw Error(`Unrecognizable event type: ${message.headers[":event-type"].value}`)}}var EventStreamMarshaller=class{constructor({utf8Encoder,utf8Decoder}){this.eventStreamCodec=new EventStreamCodec(utf8Encoder,utf8Decoder);this.utfEncoder=utf8Encoder}deserialize(body,deserializer){const inputStream=getChunkedStream(body);return new SmithyMessageDecoderStream({messageStream:new MessageDecoderStream({inputStream,decoder:this.eventStreamCodec}),deserializer:getMessageUnmarshaller(deserializer,this.utfEncoder)})}serialize(inputStream,serializer){return new MessageEncoderStream({messageStream:new SmithyMessageEncoderStream({inputStream,serializer}),encoder:this.eventStreamCodec,includeEndFrame:true})}},eventStreamSerdeProvider=options=>new EventStreamMarshaller(options),readableStreamtoIterable=readableStream=>({[Symbol.asyncIterator]:async function*(){const reader=readableStream.getReader();try{for(;;){const{done,value}=await reader.read();if(done)return;yield value}}finally{reader.releaseLock()}}}),iterableToReadableStream=asyncIterable=>{const iterator=asyncIterable[Symbol.asyncIterator]();return new ReadableStream({async pull(controller){const{done,value}=await iterator.next();if(done)return controller.close();controller.enqueue(value)}})},EventStreamMarshaller2=class{constructor({utf8Encoder,utf8Decoder}){this.universalMarshaller=new EventStreamMarshaller({utf8Decoder,utf8Encoder})}deserialize(body,deserializer){const bodyIterable=isReadableStream2(body)?readableStreamtoIterable(body):body;return this.universalMarshaller.deserialize(bodyIterable,deserializer)}serialize(input,serializer){const serialziedIterable=this.universalMarshaller.serialize(input,serializer);return"function"==typeof ReadableStream?iterableToReadableStream(serialziedIterable):serialziedIterable}},isReadableStream2=body=>"function"==typeof ReadableStream&&body instanceof ReadableStream,eventStreamSerdeProvider2=options=>new EventStreamMarshaller2(options);function blobReader(blob,onChunk,chunkSize=1048576){return new Promise(((resolve,reject)=>{const fileReader=new FileReader;fileReader.addEventListener("error",reject);fileReader.addEventListener("abort",reject);const size=blob.size;let totalBytesRead=0;function read(){if(!(totalBytesRead>=size))fileReader.readAsArrayBuffer(blob.slice(totalBytesRead,Math.min(size,totalBytesRead+chunkSize)));else resolve()}fileReader.addEventListener("load",(event=>{const result=event.target.result;onChunk(new Uint8Array(result));totalBytesRead+=result.byteLength;read()}));read()}))}var blobHasher=async function blobHasher2(hashCtor,blob){const hash2=new hashCtor;await blobReader(blob,(chunk=>{hash2.update(chunk)}));return hash2.digest()},invalidProvider=message=>()=>Promise.reject(message),BLOCK_SIZE2=64,DIGEST_LENGTH2=16,INIT2=[1732584193,4023233417,2562383102,271733878],Md5=class{constructor(){this.reset()}update(sourceData){if(isEmptyData3(sourceData))return;else if(this.finished)throw new Error("Attempted to update an already finished hash.");const data=convertToBuffer3(sourceData);let position=0,{byteLength}=data;this.bytesHashed+=byteLength;for(;byteLength>0;){this.buffer.setUint8(this.bufferLength++,data[position++]);byteLength--;if(this.bufferLength===BLOCK_SIZE2){this.hashBuffer();this.bufferLength=0}}}async digest(){if(!this.finished){const{buffer,bufferLength:undecoratedLength,bytesHashed}=this,bitsHashed=8*bytesHashed;buffer.setUint8(this.bufferLength++,128);if(undecoratedLength%BLOCK_SIZE2>=BLOCK_SIZE2-8){for(let i2=this.bufferLength;i2<BLOCK_SIZE2;i2++)buffer.setUint8(i2,0);this.hashBuffer();this.bufferLength=0}for(let i2=this.bufferLength;i2<BLOCK_SIZE2-8;i2++)buffer.setUint8(i2,0);buffer.setUint32(BLOCK_SIZE2-8,bitsHashed>>>0,true);buffer.setUint32(BLOCK_SIZE2-4,Math.floor(bitsHashed/4294967296),true);this.hashBuffer();this.finished=true}const out=new DataView(new ArrayBuffer(DIGEST_LENGTH2));for(let i2=0;i2<4;i2++)out.setUint32(4*i2,this.state[i2],true);return new Uint8Array(out.buffer,out.byteOffset,out.byteLength)}hashBuffer(){const{buffer,state}=this;let a2=state[0],b3=state[1],c2=state[2],d4=state[3];a2=ff(a2,b3,c2,d4,buffer.getUint32(0,true),7,3614090360);d4=ff(d4,a2,b3,c2,buffer.getUint32(4,true),12,3905402710);c2=ff(c2,d4,a2,b3,buffer.getUint32(8,true),17,606105819);b3=ff(b3,c2,d4,a2,buffer.getUint32(12,true),22,3250441966);a2=ff(a2,b3,c2,d4,buffer.getUint32(16,true),7,4118548399);d4=ff(d4,a2,b3,c2,buffer.getUint32(20,true),12,1200080426);c2=ff(c2,d4,a2,b3,buffer.getUint32(24,true),17,2821735955);b3=ff(b3,c2,d4,a2,buffer.getUint32(28,true),22,4249261313);a2=ff(a2,b3,c2,d4,buffer.getUint32(32,true),7,1770035416);d4=ff(d4,a2,b3,c2,buffer.getUint32(36,true),12,2336552879);c2=ff(c2,d4,a2,b3,buffer.getUint32(40,true),17,4294925233);b3=ff(b3,c2,d4,a2,buffer.getUint32(44,true),22,2304563134);a2=ff(a2,b3,c2,d4,buffer.getUint32(48,true),7,1804603682);d4=ff(d4,a2,b3,c2,buffer.getUint32(52,true),12,4254626195);c2=ff(c2,d4,a2,b3,buffer.getUint32(56,true),17,2792965006);b3=ff(b3,c2,d4,a2,buffer.getUint32(60,true),22,1236535329);a2=gg(a2,b3,c2,d4,buffer.getUint32(4,true),5,4129170786);d4=gg(d4,a2,b3,c2,buffer.getUint32(24,true),9,3225465664);c2=gg(c2,d4,a2,b3,buffer.getUint32(44,true),14,643717713);b3=gg(b3,c2,d4,a2,buffer.getUint32(0,true),20,3921069994);a2=gg(a2,b3,c2,d4,buffer.getUint32(20,true),5,3593408605);d4=gg(d4,a2,b3,c2,buffer.getUint32(40,true),9,38016083);c2=gg(c2,d4,a2,b3,buffer.getUint32(60,true),14,3634488961);b3=gg(b3,c2,d4,a2,buffer.getUint32(16,true),20,3889429448);a2=gg(a2,b3,c2,d4,buffer.getUint32(36,true),5,568446438);d4=gg(d4,a2,b3,c2,buffer.getUint32(56,true),9,3275163606);c2=gg(c2,d4,a2,b3,buffer.getUint32(12,true),14,4107603335);b3=gg(b3,c2,d4,a2,buffer.getUint32(32,true),20,1163531501);a2=gg(a2,b3,c2,d4,buffer.getUint32(52,true),5,2850285829);d4=gg(d4,a2,b3,c2,buffer.getUint32(8,true),9,4243563512);c2=gg(c2,d4,a2,b3,buffer.getUint32(28,true),14,1735328473);b3=gg(b3,c2,d4,a2,buffer.getUint32(48,true),20,2368359562);a2=hh(a2,b3,c2,d4,buffer.getUint32(20,true),4,4294588738);d4=hh(d4,a2,b3,c2,buffer.getUint32(32,true),11,2272392833);c2=hh(c2,d4,a2,b3,buffer.getUint32(44,true),16,1839030562);b3=hh(b3,c2,d4,a2,buffer.getUint32(56,true),23,4259657740);a2=hh(a2,b3,c2,d4,buffer.getUint32(4,true),4,2763975236);d4=hh(d4,a2,b3,c2,buffer.getUint32(16,true),11,1272893353);c2=hh(c2,d4,a2,b3,buffer.getUint32(28,true),16,4139469664);b3=hh(b3,c2,d4,a2,buffer.getUint32(40,true),23,3200236656);a2=hh(a2,b3,c2,d4,buffer.getUint32(52,true),4,681279174);d4=hh(d4,a2,b3,c2,buffer.getUint32(0,true),11,3936430074);c2=hh(c2,d4,a2,b3,buffer.getUint32(12,true),16,3572445317);b3=hh(b3,c2,d4,a2,buffer.getUint32(24,true),23,76029189);a2=hh(a2,b3,c2,d4,buffer.getUint32(36,true),4,3654602809);d4=hh(d4,a2,b3,c2,buffer.getUint32(48,true),11,3873151461);c2=hh(c2,d4,a2,b3,buffer.getUint32(60,true),16,530742520);b3=hh(b3,c2,d4,a2,buffer.getUint32(8,true),23,3299628645);a2=ii(a2,b3,c2,d4,buffer.getUint32(0,true),6,4096336452);d4=ii(d4,a2,b3,c2,buffer.getUint32(28,true),10,1126891415);c2=ii(c2,d4,a2,b3,buffer.getUint32(56,true),15,2878612391);b3=ii(b3,c2,d4,a2,buffer.getUint32(20,true),21,4237533241);a2=ii(a2,b3,c2,d4,buffer.getUint32(48,true),6,1700485571);d4=ii(d4,a2,b3,c2,buffer.getUint32(12,true),10,2399980690);c2=ii(c2,d4,a2,b3,buffer.getUint32(40,true),15,4293915773);b3=ii(b3,c2,d4,a2,buffer.getUint32(4,true),21,2240044497);a2=ii(a2,b3,c2,d4,buffer.getUint32(32,true),6,1873313359);d4=ii(d4,a2,b3,c2,buffer.getUint32(60,true),10,4264355552);c2=ii(c2,d4,a2,b3,buffer.getUint32(24,true),15,2734768916);b3=ii(b3,c2,d4,a2,buffer.getUint32(52,true),21,1309151649);a2=ii(a2,b3,c2,d4,buffer.getUint32(16,true),6,4149444226);d4=ii(d4,a2,b3,c2,buffer.getUint32(44,true),10,3174756917);c2=ii(c2,d4,a2,b3,buffer.getUint32(8,true),15,718787259);b3=ii(b3,c2,d4,a2,buffer.getUint32(36,true),21,3951481745);state[0]=a2+state[0]&4294967295;state[1]=b3+state[1]&4294967295;state[2]=c2+state[2]&4294967295;state[3]=d4+state[3]&4294967295}reset(){this.state=Uint32Array.from(INIT2);this.buffer=new DataView(new ArrayBuffer(BLOCK_SIZE2));this.bufferLength=0;this.bytesHashed=0;this.finished=false}};function cmn(q2,a2,b3,x2,s2,t4){return((a2=(a2+q2&4294967295)+(x2+t4&4294967295)&4294967295)<<s2|a2>>>32-s2)+b3&4294967295}function ff(a2,b3,c2,d4,x2,s2,t4){return cmn(b3&c2|~b3&d4,a2,b3,x2,s2,t4)}function gg(a2,b3,c2,d4,x2,s2,t4){return cmn(b3&d4|c2&~d4,a2,b3,x2,s2,t4)}function hh(a2,b3,c2,d4,x2,s2,t4){return cmn(b3^c2^d4,a2,b3,x2,s2,t4)}function ii(a2,b3,c2,d4,x2,s2,t4){return cmn(c2^(b3|~d4),a2,b3,x2,s2,t4)}function isEmptyData3(data){if("string"==typeof data)return 0===data.length;else return 0===data.byteLength}function convertToBuffer3(data){if("string"==typeof data)return fromUtf8(data);if(ArrayBuffer.isView(data))return new Uint8Array(data.buffer,data.byteOffset,data.byteLength/Uint8Array.BYTES_PER_ELEMENT);else return new Uint8Array(data)}var TEXT_ENCODER="function"==typeof TextEncoder?new TextEncoder:null,calculateBodyLength=body=>{if("string"==typeof body){if(TEXT_ENCODER)return TEXT_ENCODER.encode(body).byteLength;let len=body.length;for(let i2=len-1;i2>=0;i2--){const code=body.charCodeAt(i2);if(code>127&&code<=2047)len++;else if(code>2047&&code<=65535)len+=2;if(code>=56320&&code<=57343)i2--}return len}else if("number"==typeof body.byteLength)return body.byteLength;else if("number"==typeof body.size)return body.size;throw new Error(`Body Length computation failed for ${body}`)},getRuntimeConfig=config=>{var _a5,_b2,_c2,_d2,_e2,_f,_g,_h,_i2,_j,_k,_l2,_m2,_n2,_o,_p2,_q;return{apiVersion:"2006-03-01",base64Decoder:null!=(_a5=null==config?void 0:config.base64Decoder)?_a5:fromBase64,base64Encoder:null!=(_b2=null==config?void 0:config.base64Encoder)?_b2:toBase64,disableHostPrefix:null!=(_c2=null==config?void 0:config.disableHostPrefix)?_c2:false,endpointProvider:null!=(_d2=null==config?void 0:config.endpointProvider)?_d2:defaultEndpointResolver,extensions:null!=(_e2=null==config?void 0:config.extensions)?_e2:[],getAwsChunkedEncodingStream:null!=(_f=null==config?void 0:config.getAwsChunkedEncodingStream)?_f:getAwsChunkedEncodingStream,httpAuthSchemeProvider:null!=(_g=null==config?void 0:config.httpAuthSchemeProvider)?_g:defaultS3HttpAuthSchemeProvider,httpAuthSchemes:null!=(_h=null==config?void 0:config.httpAuthSchemes)?_h:[{schemeId:"aws.auth#sigv4",identityProvider:ipc=>ipc.getIdentityProvider("aws.auth#sigv4"),signer:new AwsSdkSigV4Signer},{schemeId:"aws.auth#sigv4a",identityProvider:ipc=>ipc.getIdentityProvider("aws.auth#sigv4a"),signer:new AwsSdkSigV4ASigner}],logger:null!=(_i2=null==config?void 0:config.logger)?_i2:new NoOpLogger,sdkStreamMixin:null!=(_j=null==config?void 0:config.sdkStreamMixin)?_j:sdkStreamMixin,serviceId:null!=(_k=null==config?void 0:config.serviceId)?_k:"S3",signerConstructor:null!=(_l2=null==config?void 0:config.signerConstructor)?_l2:SignatureV4MultiRegion,signingEscapePath:null!=(_m2=null==config?void 0:config.signingEscapePath)?_m2:false,urlParser:null!=(_n2=null==config?void 0:config.urlParser)?_n2:parseUrl,useArnRegion:null!=(_o=null==config?void 0:config.useArnRegion)?_o:false,utf8Decoder:null!=(_p2=null==config?void 0:config.utf8Decoder)?_p2:fromUtf8,utf8Encoder:null!=(_q=null==config?void 0:config.utf8Encoder)?_q:toUtf8}},DEFAULTS_MODE_OPTIONS=["in-region","cross-region","mobile","standard","legacy"],import_bowser2=__toESM(require_es5()),resolveDefaultsModeConfig=({defaultsMode}={})=>memoize((async()=>{const mode="function"==typeof defaultsMode?await defaultsMode():defaultsMode;switch(null==mode?void 0:mode.toLowerCase()){case"auto":return Promise.resolve(isMobileBrowser()?"mobile":"standard");case"mobile":case"in-region":case"cross-region":case"standard":case"legacy":return Promise.resolve(null==mode?void 0:mode.toLocaleLowerCase());case void 0:return Promise.resolve("legacy");default:throw new Error(`Invalid parameter for "defaultsMode", expect ${DEFAULTS_MODE_OPTIONS.join(", ")}, got ${mode}`)}})),isMobileBrowser=()=>{var _a5,_b2;const parsedUA="undefined"!=typeof window&&(null==(_a5=null==window?void 0:window.navigator)?void 0:_a5.userAgent)?import_bowser2.default.parse(window.navigator.userAgent):void 0,platform=null==(_b2=null==parsedUA?void 0:parsedUA.platform)?void 0:_b2.type;return"tablet"===platform||"mobile"===platform},getRuntimeConfig2=config=>{var _a5,_b2,_c2,_d2,_e2,_f,_g,_h,_i2,_j,_k,_l2,_m2,_n2,_o;const defaultsMode=resolveDefaultsModeConfig(config),defaultConfigProvider=()=>defaultsMode().then(loadConfigsForDefaultMode),clientSharedValues=getRuntimeConfig(config);return{...clientSharedValues,...config,runtime:"browser",defaultsMode,bodyLengthChecker:null!=(_a5=null==config?void 0:config.bodyLengthChecker)?_a5:calculateBodyLength,credentialDefaultProvider:null!=(_b2=null==config?void 0:config.credentialDefaultProvider)?_b2:_=>()=>Promise.reject(new Error("Credential is missing")),defaultUserAgentProvider:null!=(_c2=null==config?void 0:config.defaultUserAgentProvider)?_c2:defaultUserAgent({serviceId:clientSharedValues.serviceId,clientVersion:package_default.version}),eventStreamSerdeProvider:null!=(_d2=null==config?void 0:config.eventStreamSerdeProvider)?_d2:eventStreamSerdeProvider2,maxAttempts:null!=(_e2=null==config?void 0:config.maxAttempts)?_e2:DEFAULT_MAX_ATTEMPTS,md5:null!=(_f=null==config?void 0:config.md5)?_f:Md5,region:null!=(_g=null==config?void 0:config.region)?_g:invalidProvider("Region is missing"),requestHandler:FetchHttpHandler.create(null!=(_h=null==config?void 0:config.requestHandler)?_h:defaultConfigProvider),retryMode:null!=(_i2=null==config?void 0:config.retryMode)?_i2:async()=>(await defaultConfigProvider()).retryMode||DEFAULT_RETRY_MODE,sha1:null!=(_j=null==config?void 0:config.sha1)?_j:Sha12,sha256:null!=(_k=null==config?void 0:config.sha256)?_k:Sha2563,streamCollector:null!=(_l2=null==config?void 0:config.streamCollector)?_l2:streamCollector,streamHasher:null!=(_m2=null==config?void 0:config.streamHasher)?_m2:blobHasher,useDualstackEndpoint:null!=(_n2=null==config?void 0:config.useDualstackEndpoint)?_n2:()=>Promise.resolve(DEFAULT_USE_DUALSTACK_ENDPOINT),useFipsEndpoint:null!=(_o=null==config?void 0:config.useFipsEndpoint)?_o:()=>Promise.resolve(DEFAULT_USE_FIPS_ENDPOINT)}},getAwsRegionExtensionConfiguration=runtimeConfig=>{let runtimeConfigRegion=async()=>{if(void 0===runtimeConfig.region)throw new Error("Region is missing from runtimeConfig");const region=runtimeConfig.region;if("string"==typeof region)return region;else return region()};return{setRegion(region){runtimeConfigRegion=region},region:()=>runtimeConfigRegion}},resolveAwsRegionExtensionConfiguration=awsRegionExtensionConfiguration=>({region:awsRegionExtensionConfiguration.region()}),isFipsRegion2=region=>"string"==typeof region&&(region.startsWith("fips-")||region.endsWith("-fips")),getRealRegion2=region=>isFipsRegion2(region)?["fips-aws-global","aws-fips"].includes(region)?"us-east-1":region.replace(/fips-(dkr-|prod-)?|-fips/,""):region,resolveRegionConfig2=input=>{const{region,useFipsEndpoint}=input;if(!region)throw new Error("Region is missing");return{...input,region:async()=>{if("string"==typeof region)return getRealRegion2(region);const providedRegion=await region();return getRealRegion2(providedRegion)},useFipsEndpoint:async()=>{const providedRegion="string"==typeof region?region:await region();if(isFipsRegion2(providedRegion))return true;else return"function"!=typeof useFipsEndpoint?Promise.resolve(!!useFipsEndpoint):useFipsEndpoint()}}},getHttpAuthExtensionConfiguration=runtimeConfig=>{const _httpAuthSchemes=runtimeConfig.httpAuthSchemes;let _httpAuthSchemeProvider=runtimeConfig.httpAuthSchemeProvider,_credentials=runtimeConfig.credentials;return{setHttpAuthScheme(httpAuthScheme){const index5=_httpAuthSchemes.findIndex((scheme=>scheme.schemeId===httpAuthScheme.schemeId));if(-1===index5)_httpAuthSchemes.push(httpAuthScheme);else _httpAuthSchemes.splice(index5,1,httpAuthScheme)},httpAuthSchemes:()=>_httpAuthSchemes,setHttpAuthSchemeProvider(httpAuthSchemeProvider){_httpAuthSchemeProvider=httpAuthSchemeProvider},httpAuthSchemeProvider:()=>_httpAuthSchemeProvider,setCredentials(credentials){_credentials=credentials},credentials:()=>_credentials}},resolveHttpAuthRuntimeConfig=config=>({httpAuthSchemes:config.httpAuthSchemes(),httpAuthSchemeProvider:config.httpAuthSchemeProvider(),credentials:config.credentials()}),asPartial=t4=>t4,resolveRuntimeExtensions=(runtimeConfig,extensions)=>{const extensionConfiguration={...asPartial(getAwsRegionExtensionConfiguration(runtimeConfig)),...asPartial(getDefaultExtensionConfiguration(runtimeConfig)),...asPartial(getHttpHandlerExtensionConfiguration(runtimeConfig)),...asPartial(getHttpAuthExtensionConfiguration(runtimeConfig))};extensions.forEach((extension=>extension.configure(extensionConfiguration)));return{...runtimeConfig,...resolveAwsRegionExtensionConfiguration(extensionConfiguration),...resolveDefaultRuntimeConfig2(extensionConfiguration),...resolveHttpHandlerRuntimeConfig(extensionConfiguration),...resolveHttpAuthRuntimeConfig(extensionConfiguration)}},S3Client=class extends Client{constructor(...[configuration]){const _config_0=getRuntimeConfig2(configuration||{}),_config_2=resolveUserAgentConfig(resolveClientEndpointParameters(_config_0)),_config_3=resolveRetryConfig(_config_2),_config_5=resolveHostHeaderConfig(resolveRegionConfig(_config_3)),_config_6=resolveEndpointConfig(_config_5),_config_7=resolveEventStreamSerdeConfig(_config_6),_config_8=resolveHttpAuthSchemeConfig(_config_7),_config_9=resolveS3Config(_config_8,{session:[()=>this,CreateSessionCommand]}),_config_10=resolveRuntimeExtensions(_config_9,(null==configuration?void 0:configuration.extensions)||[]);super(_config_10);this.config=_config_10;this.middlewareStack.use(getUserAgentPlugin(this.config));this.middlewareStack.use(getRetryPlugin(this.config));this.middlewareStack.use(getContentLengthPlugin(this.config));this.middlewareStack.use(getHostHeaderPlugin(this.config));this.middlewareStack.use(getLoggerPlugin(this.config));this.middlewareStack.use(getRecursionDetectionPlugin(this.config));this.middlewareStack.use(getHttpAuthSchemeEndpointRuleSetPlugin(this.config,{httpAuthSchemeParametersProvider:defaultS3HttpAuthSchemeParametersProvider,identityProviderConfigProvider:async config=>new DefaultIdentityProviderConfig({"aws.auth#sigv4":config.credentials,"aws.auth#sigv4a":config.credentials})}));this.middlewareStack.use(getHttpSigningPlugin(this.config));this.middlewareStack.use(getValidateBucketNamePlugin(this.config));this.middlewareStack.use(getAddExpectContinuePlugin(this.config));this.middlewareStack.use(getRegionRedirectMiddlewarePlugin(this.config));this.middlewareStack.use(getS3ExpressPlugin(this.config));this.middlewareStack.use(getS3ExpressHttpSigningPlugin(this.config))}destroy(){super.destroy()}},AbortMultipartUploadCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","AbortMultipartUpload",{}).n("S3Client","AbortMultipartUploadCommand").f(void 0,void 0).ser(se_AbortMultipartUploadCommand).de(de_AbortMultipartUploadCommand).build()){};function ssecMiddleware(options){return next=>async args=>{const input={...args.input},properties=[{target:"SSECustomerKey",hash:"SSECustomerKeyMD5"},{target:"CopySourceSSECustomerKey",hash:"CopySourceSSECustomerKeyMD5"}];for(const prop of properties){const value=input[prop.target];if(value){let valueForHash;if("string"==typeof value)if(isValidBase64EncodedSSECustomerKey(value,options))valueForHash=options.base64Decoder(value);else{valueForHash=options.utf8Decoder(value);input[prop.target]=options.base64Encoder(valueForHash)}else{valueForHash=ArrayBuffer.isView(value)?new Uint8Array(value.buffer,value.byteOffset,value.byteLength):new Uint8Array(value);input[prop.target]=options.base64Encoder(valueForHash)}const hash2=new options.md5;hash2.update(valueForHash);input[prop.hash]=options.base64Encoder(await hash2.digest())}}return next({...args,input})}}var ssecMiddlewareOptions={name:"ssecMiddleware",step:"initialize",tags:["SSE"],override:true},getSsecPlugin=config=>({applyToStack:clientStack=>{clientStack.add(ssecMiddleware(config),ssecMiddlewareOptions)}});function isValidBase64EncodedSSECustomerKey(str,options){if(!/^(?:[A-Za-z0-9+/]{4})*([A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(str))return false;try{return 32===options.base64Decoder(str).length}catch(e4){return false}}var CompleteMultipartUploadCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config),getSsecPlugin(config)]})).s("AmazonS3","CompleteMultipartUpload",{}).n("S3Client","CompleteMultipartUploadCommand").f(CompleteMultipartUploadRequestFilterSensitiveLog,CompleteMultipartUploadOutputFilterSensitiveLog).ser(se_CompleteMultipartUploadCommand).de(de_CompleteMultipartUploadCommand).build()){},CopyObjectCommand=class extends(Command.classBuilder().ep({...commonParams,DisableS3ExpressSessionAuth:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"},CopySource:{type:"contextParams",name:"CopySource"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config),getSsecPlugin(config)]})).s("AmazonS3","CopyObject",{}).n("S3Client","CopyObjectCommand").f(CopyObjectRequestFilterSensitiveLog,CopyObjectOutputFilterSensitiveLog).ser(se_CopyObjectCommand).de(de_CopyObjectCommand).build()){};function locationConstraintMiddleware(options){return next=>async args=>{const{CreateBucketConfiguration}=args.input,region=await options.region();if(!(null==CreateBucketConfiguration?void 0:CreateBucketConfiguration.LocationConstraint)&&!(null==CreateBucketConfiguration?void 0:CreateBucketConfiguration.Location))args={...args,input:{...args.input,CreateBucketConfiguration:"us-east-1"===region?void 0:{LocationConstraint:region}}};return next(args)}}var ChecksumAlgorithm2,ChecksumLocation,locationConstraintMiddlewareOptions={step:"initialize",tags:["LOCATION_CONSTRAINT","CREATE_BUCKET_CONFIGURATION"],name:"locationConstraintMiddleware",override:true},getLocationConstraintPlugin=config=>({applyToStack:clientStack=>{clientStack.add(locationConstraintMiddleware(config),locationConstraintMiddlewareOptions)}}),CreateBucketCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},DisableAccessPoints:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config),getLocationConstraintPlugin(config)]})).s("AmazonS3","CreateBucket",{}).n("S3Client","CreateBucketCommand").f(void 0,void 0).ser(se_CreateBucketCommand).de(de_CreateBucketCommand).build()){},CreateMultipartUploadCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config),getSsecPlugin(config)]})).s("AmazonS3","CreateMultipartUpload",{}).n("S3Client","CreateMultipartUploadCommand").f(CreateMultipartUploadRequestFilterSensitiveLog,CreateMultipartUploadOutputFilterSensitiveLog).ser(se_CreateMultipartUploadCommand).de(de_CreateMultipartUploadCommand).build()){},DeleteBucketAnalyticsConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketAnalyticsConfiguration",{}).n("S3Client","DeleteBucketAnalyticsConfigurationCommand").f(void 0,void 0).ser(se_DeleteBucketAnalyticsConfigurationCommand).de(de_DeleteBucketAnalyticsConfigurationCommand).build()){},DeleteBucketCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucket",{}).n("S3Client","DeleteBucketCommand").f(void 0,void 0).ser(se_DeleteBucketCommand).de(de_DeleteBucketCommand).build()){},DeleteBucketCorsCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketCors",{}).n("S3Client","DeleteBucketCorsCommand").f(void 0,void 0).ser(se_DeleteBucketCorsCommand).de(de_DeleteBucketCorsCommand).build()){},DeleteBucketEncryptionCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketEncryption",{}).n("S3Client","DeleteBucketEncryptionCommand").f(void 0,void 0).ser(se_DeleteBucketEncryptionCommand).de(de_DeleteBucketEncryptionCommand).build()){},DeleteBucketIntelligentTieringConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketIntelligentTieringConfiguration",{}).n("S3Client","DeleteBucketIntelligentTieringConfigurationCommand").f(void 0,void 0).ser(se_DeleteBucketIntelligentTieringConfigurationCommand).de(de_DeleteBucketIntelligentTieringConfigurationCommand).build()){},DeleteBucketInventoryConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketInventoryConfiguration",{}).n("S3Client","DeleteBucketInventoryConfigurationCommand").f(void 0,void 0).ser(se_DeleteBucketInventoryConfigurationCommand).de(de_DeleteBucketInventoryConfigurationCommand).build()){},DeleteBucketLifecycleCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketLifecycle",{}).n("S3Client","DeleteBucketLifecycleCommand").f(void 0,void 0).ser(se_DeleteBucketLifecycleCommand).de(de_DeleteBucketLifecycleCommand).build()){},DeleteBucketMetricsConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketMetricsConfiguration",{}).n("S3Client","DeleteBucketMetricsConfigurationCommand").f(void 0,void 0).ser(se_DeleteBucketMetricsConfigurationCommand).de(de_DeleteBucketMetricsConfigurationCommand).build()){},DeleteBucketOwnershipControlsCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketOwnershipControls",{}).n("S3Client","DeleteBucketOwnershipControlsCommand").f(void 0,void 0).ser(se_DeleteBucketOwnershipControlsCommand).de(de_DeleteBucketOwnershipControlsCommand).build()){},DeleteBucketPolicyCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketPolicy",{}).n("S3Client","DeleteBucketPolicyCommand").f(void 0,void 0).ser(se_DeleteBucketPolicyCommand).de(de_DeleteBucketPolicyCommand).build()){},DeleteBucketReplicationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketReplication",{}).n("S3Client","DeleteBucketReplicationCommand").f(void 0,void 0).ser(se_DeleteBucketReplicationCommand).de(de_DeleteBucketReplicationCommand).build()){},DeleteBucketTaggingCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketTagging",{}).n("S3Client","DeleteBucketTaggingCommand").f(void 0,void 0).ser(se_DeleteBucketTaggingCommand).de(de_DeleteBucketTaggingCommand).build()){},DeleteBucketWebsiteCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeleteBucketWebsite",{}).n("S3Client","DeleteBucketWebsiteCommand").f(void 0,void 0).ser(se_DeleteBucketWebsiteCommand).de(de_DeleteBucketWebsiteCommand).build()){},DeleteObjectCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","DeleteObject",{}).n("S3Client","DeleteObjectCommand").f(void 0,void 0).ser(se_DeleteObjectCommand).de(de_DeleteObjectCommand).build()){};(function(ChecksumAlgorithm3){ChecksumAlgorithm3["MD5"]="MD5";ChecksumAlgorithm3["CRC32"]="CRC32";ChecksumAlgorithm3["CRC32C"]="CRC32C";ChecksumAlgorithm3["SHA1"]="SHA1";ChecksumAlgorithm3["SHA256"]="SHA256"})(ChecksumAlgorithm2||(ChecksumAlgorithm2={}));(function(ChecksumLocation2){ChecksumLocation2["HEADER"]="header";ChecksumLocation2["TRAILER"]="trailer"})(ChecksumLocation||(ChecksumLocation={}));var DEFAULT_CHECKSUM_ALGORITHM=ChecksumAlgorithm2.MD5,S3_EXPRESS_DEFAULT_CHECKSUM_ALGORITHM=ChecksumAlgorithm2.CRC32,CLIENT_SUPPORTED_ALGORITHMS=[ChecksumAlgorithm2.CRC32,ChecksumAlgorithm2.CRC32C,ChecksumAlgorithm2.SHA1,ChecksumAlgorithm2.SHA256],PRIORITY_ORDER_ALGORITHMS=[ChecksumAlgorithm2.CRC32,ChecksumAlgorithm2.CRC32C,ChecksumAlgorithm2.SHA1,ChecksumAlgorithm2.SHA256],getChecksumAlgorithmForRequest=(input,{requestChecksumRequired,requestAlgorithmMember},isS3Express)=>{const defaultAlgorithm=isS3Express?S3_EXPRESS_DEFAULT_CHECKSUM_ALGORITHM:DEFAULT_CHECKSUM_ALGORITHM;if(!requestAlgorithmMember||!input[requestAlgorithmMember])return requestChecksumRequired?defaultAlgorithm:void 0;const checksumAlgorithm=input[requestAlgorithmMember];if(!CLIENT_SUPPORTED_ALGORITHMS.includes(checksumAlgorithm))throw new Error(`The checksum algorithm "${checksumAlgorithm}" is not supported by the client. Select one of ${CLIENT_SUPPORTED_ALGORITHMS}.`);return checksumAlgorithm},getChecksumLocationName=algorithm=>algorithm===ChecksumAlgorithm2.MD5?"content-md5":`x-amz-checksum-${algorithm.toLowerCase()}`,hasHeader2=(header,headers)=>{const soughtHeader=header.toLowerCase();for(const headerName of Object.keys(headers))if(soughtHeader===headerName.toLowerCase())return true;return false},isStreaming=body=>void 0!==body&&"string"!=typeof body&&!ArrayBuffer.isView(body)&&!isArrayBuffer(body),AwsCrc32c=function(){function AwsCrc32c2(){this.crc32c=new Crc32c}AwsCrc32c2.prototype.update=function(toHash){if(!isEmptyData2(toHash))this.crc32c.update(convertToBuffer2(toHash))};AwsCrc32c2.prototype.digest=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a5){return[2,numToUint8(this.crc32c.digest())]}))}))};AwsCrc32c2.prototype.reset=function(){this.crc32c=new Crc32c};return AwsCrc32c2}();function crc32c(data){return(new Crc32c).update(data).digest()}var Crc32c=function(){function Crc32c2(){this.checksum=4294967295}Crc32c2.prototype.update=function(data){var e_1,_a5;try{for(var data_1=__values(data),data_1_1=data_1.next();!data_1_1.done;data_1_1=data_1.next()){var byte=data_1_1.value;this.checksum=this.checksum>>>8^lookupTable2[255&(this.checksum^byte)]}}catch(e_1_1){e_1={error:e_1_1}}finally{try{if(data_1_1&&!data_1_1.done&&(_a5=data_1.return))_a5.call(data_1)}finally{if(e_1)throw e_1.error}}return this};Crc32c2.prototype.digest=function(){return(4294967295^this.checksum)>>>0};return Crc32c2}(),a_lookupTable=[0,4067132163,3778769143,324072436,3348797215,904991772,648144872,3570033899,2329499855,2024987596,1809983544,2575936315,1296289744,3207089363,2893594407,1578318884,274646895,3795141740,4049975192,51262619,3619967088,632279923,922689671,3298075524,2592579488,1760304291,2075979607,2312596564,1562183871,2943781820,3156637768,1313733451,549293790,3537243613,3246849577,871202090,3878099393,357341890,102525238,4101499445,2858735121,1477399826,1264559846,3107202533,1845379342,2677391885,2361733625,2125378298,820201905,3263744690,3520608582,598981189,4151959214,85089709,373468761,3827903834,3124367742,1213305469,1526817161,2842354314,2107672161,2412447074,2627466902,1861252501,1098587580,3004210879,2688576843,1378610760,2262928035,1955203488,1742404180,2511436119,3416409459,969524848,714683780,3639785095,205050476,4266873199,3976438427,526918040,1361435347,2739821008,2954799652,1114974503,2529119692,1691668175,2005155131,2247081528,3690758684,697762079,986182379,3366744552,476452099,3993867776,4250756596,255256311,1640403810,2477592673,2164122517,1922457750,2791048317,1412925310,1197962378,3037525897,3944729517,427051182,170179418,4165941337,746937522,3740196785,3451792453,1070968646,1905808397,2213795598,2426610938,1657317369,3053634322,1147748369,1463399397,2773627110,4215344322,153784257,444234805,3893493558,1021025245,3467647198,3722505002,797665321,2197175160,1889384571,1674398607,2443626636,1164749927,3070701412,2757221520,1446797203,137323447,4198817972,3910406976,461344835,3484808360,1037989803,781091935,3705997148,2460548119,1623424788,1939049696,2180517859,1429367560,2807687179,3020495871,1180866812,410100952,3927582683,4182430767,186734380,3756733383,763408580,1053836080,3434856499,2722870694,1344288421,1131464017,2971354706,1708204729,2545590714,2229949006,1988219213,680717673,3673779818,3383336350,1002577565,4010310262,493091189,238226049,4233660802,2987750089,1082061258,1395524158,2705686845,1972364758,2279892693,2494862625,1725896226,952904198,3399985413,3656866545,731699698,4283874585,222117402,510512622,3959836397,3280807620,837199303,582374963,3504198960,68661723,4135334616,3844915500,390545967,1230274059,3141532936,2825850620,1510247935,2395924756,2091215383,1878366691,2644384480,3553878443,565732008,854102364,3229815391,340358836,3861050807,4117890627,119113024,1493875044,2875275879,3090270611,1247431312,2660249211,1828433272,2141937292,2378227087,3811616794,291187481,34330861,4032846830,615137029,3603020806,3314634738,939183345,1776939221,2609017814,2295496738,2058945313,2926798794,1545135305,1330124605,3173225534,4084100981,17165430,307568514,3762199681,888469610,3332340585,3587147933,665062302,2042050490,2346497209,2559330125,1793573966,3190661285,1279665062,1595330642,2910671697],lookupTable2=uint32ArrayFrom(a_lookupTable),selectChecksumAlgorithmFunction=(checksumAlgorithm,config)=>({[ChecksumAlgorithm2.MD5]:config.md5,[ChecksumAlgorithm2.CRC32]:AwsCrc32,[ChecksumAlgorithm2.CRC32C]:AwsCrc32c,[ChecksumAlgorithm2.SHA1]:config.sha1,[ChecksumAlgorithm2.SHA256]:config.sha256}[checksumAlgorithm]),stringHasher=(checksumAlgorithmFn,body)=>{const hash2=new checksumAlgorithmFn;hash2.update(toUint8Array(body||""));return hash2.digest()},flexibleChecksumsMiddlewareOptions={name:"flexibleChecksumsMiddleware",step:"build",tags:["BODY_CHECKSUM"],override:true},flexibleChecksumsMiddleware=(config,middlewareConfig)=>(next,context2)=>async args=>{if(!HttpRequest.isInstance(args.request))return next(args);const{request:request2}=args,{body:requestBody,headers}=request2,{base64Encoder,streamHasher}=config,{input,requestChecksumRequired,requestAlgorithmMember}=middlewareConfig,checksumAlgorithm=getChecksumAlgorithmForRequest(input,{requestChecksumRequired,requestAlgorithmMember},!!context2.isS3ExpressBucket);let updatedBody=requestBody,updatedHeaders=headers;if(checksumAlgorithm){const checksumLocationName=getChecksumLocationName(checksumAlgorithm),checksumAlgorithmFn=selectChecksumAlgorithmFunction(checksumAlgorithm,config);if(isStreaming(requestBody)){const{getAwsChunkedEncodingStream:getAwsChunkedEncodingStream2,bodyLengthChecker}=config;updatedBody=getAwsChunkedEncodingStream2(requestBody,{base64Encoder,bodyLengthChecker,checksumLocationName,checksumAlgorithmFn,streamHasher});updatedHeaders={...headers,"content-encoding":headers["content-encoding"]?`${headers["content-encoding"]},aws-chunked`:"aws-chunked","transfer-encoding":"chunked","x-amz-decoded-content-length":headers["content-length"],"x-amz-content-sha256":"STREAMING-UNSIGNED-PAYLOAD-TRAILER","x-amz-trailer":checksumLocationName};delete updatedHeaders["content-length"]}else if(!hasHeader2(checksumLocationName,headers)){const rawChecksum=await stringHasher(checksumAlgorithmFn,requestBody);updatedHeaders={...headers,[checksumLocationName]:base64Encoder(rawChecksum)}}}return await next({...args,request:{...request2,headers:updatedHeaders,body:updatedBody}})},getChecksumAlgorithmListForResponse=(responseAlgorithms=[])=>{const validChecksumAlgorithms=[];for(const algorithm of PRIORITY_ORDER_ALGORITHMS)if(responseAlgorithms.includes(algorithm)&&CLIENT_SUPPORTED_ALGORITHMS.includes(algorithm))validChecksumAlgorithms.push(algorithm);return validChecksumAlgorithms},isChecksumWithPartNumber=checksum=>{const lastHyphenIndex=checksum.lastIndexOf("-");if(-1!==lastHyphenIndex){const numberPart=checksum.slice(lastHyphenIndex+1);if(!numberPart.startsWith("0")){const number=parseInt(numberPart,10);if(!isNaN(number)&&number>=1&&number<=1e4)return true}}return false};function createReadStreamOnBuffer(buffer){return new Blob([buffer]).stream()}var getChecksum=async(body,{streamHasher,checksumAlgorithmFn,base64Encoder})=>{const digest=isStreaming(body)?streamHasher(checksumAlgorithmFn,body):stringHasher(checksumAlgorithmFn,body);return base64Encoder(await digest)},validateChecksumFromResponse=async(response,{config,responseAlgorithms})=>{const checksumAlgorithms=getChecksumAlgorithmListForResponse(responseAlgorithms),{body:responseBody,headers:responseHeaders}=response;for(const algorithm of checksumAlgorithms){const responseHeader=getChecksumLocationName(algorithm),checksumFromResponse=responseHeaders[responseHeader];if(checksumFromResponse){const checksumAlgorithmFn=selectChecksumAlgorithmFunction(algorithm,config),{streamHasher,base64Encoder}=config,checksum=await getChecksum(responseBody,{streamHasher,checksumAlgorithmFn,base64Encoder});if(checksum===checksumFromResponse)break;throw new Error(`Checksum mismatch: expected "${checksum}" but received "${checksumFromResponse}" in response header "${responseHeader}".`)}}},flexibleChecksumsResponseMiddlewareOptions={name:"flexibleChecksumsResponseMiddleware",toMiddleware:"deserializerMiddleware",relation:"after",tags:["BODY_CHECKSUM"],override:true},flexibleChecksumsResponseMiddleware=(config,middlewareConfig)=>(next,context2)=>async args=>{if(!HttpRequest.isInstance(args.request))return next(args);const input=args.input,result=await next(args),response=result.response;let collectedStream;const{requestValidationModeMember,responseAlgorithms}=middlewareConfig;if(requestValidationModeMember&&"ENABLED"===input[requestValidationModeMember]){const{clientName,commandName}=context2;if("S3Client"===clientName&&"GetObjectCommand"===commandName&&getChecksumAlgorithmListForResponse(responseAlgorithms).every((algorithm=>{const responseHeader=getChecksumLocationName(algorithm),checksumFromResponse=response.headers[responseHeader];return!checksumFromResponse||isChecksumWithPartNumber(checksumFromResponse)})))return result;const isStreamingBody=isStreaming(response.body);if(isStreamingBody){collectedStream=await config.streamCollector(response.body);response.body=createReadStreamOnBuffer(collectedStream)}await validateChecksumFromResponse(result.response,{config,responseAlgorithms});if(isStreamingBody&&collectedStream)response.body=createReadStreamOnBuffer(collectedStream)}return result},getFlexibleChecksumsPlugin=(config,middlewareConfig)=>({applyToStack:clientStack=>{clientStack.add(flexibleChecksumsMiddleware(config,middlewareConfig),flexibleChecksumsMiddlewareOptions);clientStack.addRelativeTo(flexibleChecksumsResponseMiddleware(config,middlewareConfig),flexibleChecksumsResponseMiddlewareOptions)}}),DeleteObjectsCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true}),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","DeleteObjects",{}).n("S3Client","DeleteObjectsCommand").f(void 0,void 0).ser(se_DeleteObjectsCommand).de(de_DeleteObjectsCommand).build()){},DeleteObjectTaggingCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","DeleteObjectTagging",{}).n("S3Client","DeleteObjectTaggingCommand").f(void 0,void 0).ser(se_DeleteObjectTaggingCommand).de(de_DeleteObjectTaggingCommand).build()){},DeletePublicAccessBlockCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","DeletePublicAccessBlock",{}).n("S3Client","DeletePublicAccessBlockCommand").f(void 0,void 0).ser(se_DeletePublicAccessBlockCommand).de(de_DeletePublicAccessBlockCommand).build()){},GetBucketAccelerateConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketAccelerateConfiguration",{}).n("S3Client","GetBucketAccelerateConfigurationCommand").f(void 0,void 0).ser(se_GetBucketAccelerateConfigurationCommand).de(de_GetBucketAccelerateConfigurationCommand).build()){},GetBucketAclCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketAcl",{}).n("S3Client","GetBucketAclCommand").f(void 0,void 0).ser(se_GetBucketAclCommand).de(de_GetBucketAclCommand).build()){},GetBucketAnalyticsConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketAnalyticsConfiguration",{}).n("S3Client","GetBucketAnalyticsConfigurationCommand").f(void 0,void 0).ser(se_GetBucketAnalyticsConfigurationCommand).de(de_GetBucketAnalyticsConfigurationCommand).build()){},GetBucketCorsCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketCors",{}).n("S3Client","GetBucketCorsCommand").f(void 0,void 0).ser(se_GetBucketCorsCommand).de(de_GetBucketCorsCommand).build()){},GetBucketEncryptionCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketEncryption",{}).n("S3Client","GetBucketEncryptionCommand").f(void 0,GetBucketEncryptionOutputFilterSensitiveLog).ser(se_GetBucketEncryptionCommand).de(de_GetBucketEncryptionCommand).build()){},GetBucketIntelligentTieringConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketIntelligentTieringConfiguration",{}).n("S3Client","GetBucketIntelligentTieringConfigurationCommand").f(void 0,void 0).ser(se_GetBucketIntelligentTieringConfigurationCommand).de(de_GetBucketIntelligentTieringConfigurationCommand).build()){},GetBucketInventoryConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketInventoryConfiguration",{}).n("S3Client","GetBucketInventoryConfigurationCommand").f(void 0,GetBucketInventoryConfigurationOutputFilterSensitiveLog).ser(se_GetBucketInventoryConfigurationCommand).de(de_GetBucketInventoryConfigurationCommand).build()){},GetBucketLifecycleConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketLifecycleConfiguration",{}).n("S3Client","GetBucketLifecycleConfigurationCommand").f(void 0,void 0).ser(se_GetBucketLifecycleConfigurationCommand).de(de_GetBucketLifecycleConfigurationCommand).build()){},GetBucketLocationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketLocation",{}).n("S3Client","GetBucketLocationCommand").f(void 0,void 0).ser(se_GetBucketLocationCommand).de(de_GetBucketLocationCommand).build()){},GetBucketLoggingCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketLogging",{}).n("S3Client","GetBucketLoggingCommand").f(void 0,void 0).ser(se_GetBucketLoggingCommand).de(de_GetBucketLoggingCommand).build()){},GetBucketMetricsConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketMetricsConfiguration",{}).n("S3Client","GetBucketMetricsConfigurationCommand").f(void 0,void 0).ser(se_GetBucketMetricsConfigurationCommand).de(de_GetBucketMetricsConfigurationCommand).build()){},GetBucketNotificationConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketNotificationConfiguration",{}).n("S3Client","GetBucketNotificationConfigurationCommand").f(void 0,void 0).ser(se_GetBucketNotificationConfigurationCommand).de(de_GetBucketNotificationConfigurationCommand).build()){},GetBucketOwnershipControlsCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketOwnershipControls",{}).n("S3Client","GetBucketOwnershipControlsCommand").f(void 0,void 0).ser(se_GetBucketOwnershipControlsCommand).de(de_GetBucketOwnershipControlsCommand).build()){},GetBucketPolicyCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketPolicy",{}).n("S3Client","GetBucketPolicyCommand").f(void 0,void 0).ser(se_GetBucketPolicyCommand).de(de_GetBucketPolicyCommand).build()){},GetBucketPolicyStatusCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketPolicyStatus",{}).n("S3Client","GetBucketPolicyStatusCommand").f(void 0,void 0).ser(se_GetBucketPolicyStatusCommand).de(de_GetBucketPolicyStatusCommand).build()){},GetBucketReplicationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketReplication",{}).n("S3Client","GetBucketReplicationCommand").f(void 0,void 0).ser(se_GetBucketReplicationCommand).de(de_GetBucketReplicationCommand).build()){},GetBucketRequestPaymentCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketRequestPayment",{}).n("S3Client","GetBucketRequestPaymentCommand").f(void 0,void 0).ser(se_GetBucketRequestPaymentCommand).de(de_GetBucketRequestPaymentCommand).build()){},GetBucketTaggingCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketTagging",{}).n("S3Client","GetBucketTaggingCommand").f(void 0,void 0).ser(se_GetBucketTaggingCommand).de(de_GetBucketTaggingCommand).build()){},GetBucketVersioningCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketVersioning",{}).n("S3Client","GetBucketVersioningCommand").f(void 0,void 0).ser(se_GetBucketVersioningCommand).de(de_GetBucketVersioningCommand).build()){},GetBucketWebsiteCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetBucketWebsite",{}).n("S3Client","GetBucketWebsiteCommand").f(void 0,void 0).ser(se_GetBucketWebsiteCommand).de(de_GetBucketWebsiteCommand).build()){},GetObjectAclCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetObjectAcl",{}).n("S3Client","GetObjectAclCommand").f(void 0,void 0).ser(se_GetObjectAclCommand).de(de_GetObjectAclCommand).build()){},GetObjectAttributesCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config),getSsecPlugin(config)]})).s("AmazonS3","GetObjectAttributes",{}).n("S3Client","GetObjectAttributesCommand").f(GetObjectAttributesRequestFilterSensitiveLog,void 0).ser(se_GetObjectAttributesCommand).de(de_GetObjectAttributesCommand).build()){},GetObjectCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestChecksumRequired:false,requestValidationModeMember:"ChecksumMode",responseAlgorithms:["CRC32","CRC32C","SHA256","SHA1"]}),getSsecPlugin(config),getS3ExpiresMiddlewarePlugin(config)]})).s("AmazonS3","GetObject",{}).n("S3Client","GetObjectCommand").f(GetObjectRequestFilterSensitiveLog,GetObjectOutputFilterSensitiveLog).ser(se_GetObjectCommand).de(de_GetObjectCommand).build()){},GetObjectLegalHoldCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetObjectLegalHold",{}).n("S3Client","GetObjectLegalHoldCommand").f(void 0,void 0).ser(se_GetObjectLegalHoldCommand).de(de_GetObjectLegalHoldCommand).build()){},GetObjectLockConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetObjectLockConfiguration",{}).n("S3Client","GetObjectLockConfigurationCommand").f(void 0,void 0).ser(se_GetObjectLockConfigurationCommand).de(de_GetObjectLockConfigurationCommand).build()){},GetObjectRetentionCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetObjectRetention",{}).n("S3Client","GetObjectRetentionCommand").f(void 0,void 0).ser(se_GetObjectRetentionCommand).de(de_GetObjectRetentionCommand).build()){},GetObjectTaggingCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetObjectTagging",{}).n("S3Client","GetObjectTaggingCommand").f(void 0,void 0).ser(se_GetObjectTaggingCommand).de(de_GetObjectTaggingCommand).build()){},GetObjectTorrentCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","GetObjectTorrent",{}).n("S3Client","GetObjectTorrentCommand").f(void 0,GetObjectTorrentOutputFilterSensitiveLog).ser(se_GetObjectTorrentCommand).de(de_GetObjectTorrentCommand).build()){},GetPublicAccessBlockCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","GetPublicAccessBlock",{}).n("S3Client","GetPublicAccessBlockCommand").f(void 0,void 0).ser(se_GetPublicAccessBlockCommand).de(de_GetPublicAccessBlockCommand).build()){},HeadBucketCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","HeadBucket",{}).n("S3Client","HeadBucketCommand").f(void 0,void 0).ser(se_HeadBucketCommand).de(de_HeadBucketCommand).build()){},HeadObjectCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config),getSsecPlugin(config),getS3ExpiresMiddlewarePlugin(config)]})).s("AmazonS3","HeadObject",{}).n("S3Client","HeadObjectCommand").f(HeadObjectRequestFilterSensitiveLog,HeadObjectOutputFilterSensitiveLog).ser(se_HeadObjectCommand).de(de_HeadObjectCommand).build()){},ListBucketAnalyticsConfigurationsCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","ListBucketAnalyticsConfigurations",{}).n("S3Client","ListBucketAnalyticsConfigurationsCommand").f(void 0,void 0).ser(se_ListBucketAnalyticsConfigurationsCommand).de(de_ListBucketAnalyticsConfigurationsCommand).build()){},ListBucketIntelligentTieringConfigurationsCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","ListBucketIntelligentTieringConfigurations",{}).n("S3Client","ListBucketIntelligentTieringConfigurationsCommand").f(void 0,void 0).ser(se_ListBucketIntelligentTieringConfigurationsCommand).de(de_ListBucketIntelligentTieringConfigurationsCommand).build()){},ListBucketInventoryConfigurationsCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","ListBucketInventoryConfigurations",{}).n("S3Client","ListBucketInventoryConfigurationsCommand").f(void 0,ListBucketInventoryConfigurationsOutputFilterSensitiveLog).ser(se_ListBucketInventoryConfigurationsCommand).de(de_ListBucketInventoryConfigurationsCommand).build()){},ListBucketMetricsConfigurationsCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","ListBucketMetricsConfigurations",{}).n("S3Client","ListBucketMetricsConfigurationsCommand").f(void 0,void 0).ser(se_ListBucketMetricsConfigurationsCommand).de(de_ListBucketMetricsConfigurationsCommand).build()){},ListBucketsCommand=class extends(Command.classBuilder().ep({...commonParams}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","ListBuckets",{}).n("S3Client","ListBucketsCommand").f(void 0,void 0).ser(se_ListBucketsCommand).de(de_ListBucketsCommand).build()){},ListDirectoryBucketsCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","ListDirectoryBuckets",{}).n("S3Client","ListDirectoryBucketsCommand").f(void 0,void 0).ser(se_ListDirectoryBucketsCommand).de(de_ListDirectoryBucketsCommand).build()){},ListMultipartUploadsCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Prefix:{type:"contextParams",name:"Prefix"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","ListMultipartUploads",{}).n("S3Client","ListMultipartUploadsCommand").f(void 0,void 0).ser(se_ListMultipartUploadsCommand).de(de_ListMultipartUploadsCommand).build()){},ListObjectsCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Prefix:{type:"contextParams",name:"Prefix"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","ListObjects",{}).n("S3Client","ListObjectsCommand").f(void 0,void 0).ser(se_ListObjectsCommand).de(de_ListObjectsCommand).build()){},ListObjectsV2Command=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Prefix:{type:"contextParams",name:"Prefix"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","ListObjectsV2",{}).n("S3Client","ListObjectsV2Command").f(void 0,void 0).ser(se_ListObjectsV2Command).de(de_ListObjectsV2Command).build()){},ListObjectVersionsCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Prefix:{type:"contextParams",name:"Prefix"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","ListObjectVersions",{}).n("S3Client","ListObjectVersionsCommand").f(void 0,void 0).ser(se_ListObjectVersionsCommand).de(de_ListObjectVersionsCommand).build()){},ListPartsCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config),getSsecPlugin(config)]})).s("AmazonS3","ListParts",{}).n("S3Client","ListPartsCommand").f(ListPartsRequestFilterSensitiveLog,void 0).ser(se_ListPartsCommand).de(de_ListPartsCommand).build()){},PutBucketAccelerateConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:false})]})).s("AmazonS3","PutBucketAccelerateConfiguration",{}).n("S3Client","PutBucketAccelerateConfigurationCommand").f(void 0,void 0).ser(se_PutBucketAccelerateConfigurationCommand).de(de_PutBucketAccelerateConfigurationCommand).build()){},PutBucketAclCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketAcl",{}).n("S3Client","PutBucketAclCommand").f(void 0,void 0).ser(se_PutBucketAclCommand).de(de_PutBucketAclCommand).build()){},PutBucketAnalyticsConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","PutBucketAnalyticsConfiguration",{}).n("S3Client","PutBucketAnalyticsConfigurationCommand").f(void 0,void 0).ser(se_PutBucketAnalyticsConfigurationCommand).de(de_PutBucketAnalyticsConfigurationCommand).build()){},PutBucketCorsCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketCors",{}).n("S3Client","PutBucketCorsCommand").f(void 0,void 0).ser(se_PutBucketCorsCommand).de(de_PutBucketCorsCommand).build()){},PutBucketEncryptionCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketEncryption",{}).n("S3Client","PutBucketEncryptionCommand").f(PutBucketEncryptionRequestFilterSensitiveLog,void 0).ser(se_PutBucketEncryptionCommand).de(de_PutBucketEncryptionCommand).build()){},PutBucketIntelligentTieringConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","PutBucketIntelligentTieringConfiguration",{}).n("S3Client","PutBucketIntelligentTieringConfigurationCommand").f(void 0,void 0).ser(se_PutBucketIntelligentTieringConfigurationCommand).de(de_PutBucketIntelligentTieringConfigurationCommand).build()){},PutBucketInventoryConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","PutBucketInventoryConfiguration",{}).n("S3Client","PutBucketInventoryConfigurationCommand").f(PutBucketInventoryConfigurationRequestFilterSensitiveLog,void 0).ser(se_PutBucketInventoryConfigurationCommand).de(de_PutBucketInventoryConfigurationCommand).build()){},PutBucketLifecycleConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketLifecycleConfiguration",{}).n("S3Client","PutBucketLifecycleConfigurationCommand").f(void 0,void 0).ser(se_PutBucketLifecycleConfigurationCommand).de(de_PutBucketLifecycleConfigurationCommand).build()){},PutBucketLoggingCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketLogging",{}).n("S3Client","PutBucketLoggingCommand").f(void 0,void 0).ser(se_PutBucketLoggingCommand).de(de_PutBucketLoggingCommand).build()){},PutBucketMetricsConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","PutBucketMetricsConfiguration",{}).n("S3Client","PutBucketMetricsConfigurationCommand").f(void 0,void 0).ser(se_PutBucketMetricsConfigurationCommand).de(de_PutBucketMetricsConfigurationCommand).build()){},PutBucketNotificationConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","PutBucketNotificationConfiguration",{}).n("S3Client","PutBucketNotificationConfigurationCommand").f(void 0,void 0).ser(se_PutBucketNotificationConfigurationCommand).de(de_PutBucketNotificationConfigurationCommand).build()){},PutBucketOwnershipControlsCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestChecksumRequired:true})]})).s("AmazonS3","PutBucketOwnershipControls",{}).n("S3Client","PutBucketOwnershipControlsCommand").f(void 0,void 0).ser(se_PutBucketOwnershipControlsCommand).de(de_PutBucketOwnershipControlsCommand).build()){},PutBucketPolicyCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketPolicy",{}).n("S3Client","PutBucketPolicyCommand").f(void 0,void 0).ser(se_PutBucketPolicyCommand).de(de_PutBucketPolicyCommand).build()){},PutBucketReplicationCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketReplication",{}).n("S3Client","PutBucketReplicationCommand").f(void 0,void 0).ser(se_PutBucketReplicationCommand).de(de_PutBucketReplicationCommand).build()){},PutBucketRequestPaymentCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketRequestPayment",{}).n("S3Client","PutBucketRequestPaymentCommand").f(void 0,void 0).ser(se_PutBucketRequestPaymentCommand).de(de_PutBucketRequestPaymentCommand).build()){},PutBucketTaggingCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketTagging",{}).n("S3Client","PutBucketTaggingCommand").f(void 0,void 0).ser(se_PutBucketTaggingCommand).de(de_PutBucketTaggingCommand).build()){},PutBucketVersioningCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketVersioning",{}).n("S3Client","PutBucketVersioningCommand").f(void 0,void 0).ser(se_PutBucketVersioningCommand).de(de_PutBucketVersioningCommand).build()){},PutBucketWebsiteCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutBucketWebsite",{}).n("S3Client","PutBucketWebsiteCommand").f(void 0,void 0).ser(se_PutBucketWebsiteCommand).de(de_PutBucketWebsiteCommand).build()){},PutObjectAclCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true}),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","PutObjectAcl",{}).n("S3Client","PutObjectAclCommand").f(void 0,void 0).ser(se_PutObjectAclCommand).de(de_PutObjectAclCommand).build()){},PutObjectCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:false}),getCheckContentLengthHeaderPlugin(config),getThrow200ExceptionsPlugin(config),getSsecPlugin(config)]})).s("AmazonS3","PutObject",{}).n("S3Client","PutObjectCommand").f(PutObjectRequestFilterSensitiveLog,PutObjectOutputFilterSensitiveLog).ser(se_PutObjectCommand).de(de_PutObjectCommand).build()){},PutObjectLegalHoldCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true}),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","PutObjectLegalHold",{}).n("S3Client","PutObjectLegalHoldCommand").f(void 0,void 0).ser(se_PutObjectLegalHoldCommand).de(de_PutObjectLegalHoldCommand).build()){},PutObjectLockConfigurationCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true}),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","PutObjectLockConfiguration",{}).n("S3Client","PutObjectLockConfigurationCommand").f(void 0,void 0).ser(se_PutObjectLockConfigurationCommand).de(de_PutObjectLockConfigurationCommand).build()){},PutObjectRetentionCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true}),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","PutObjectRetention",{}).n("S3Client","PutObjectRetentionCommand").f(void 0,void 0).ser(se_PutObjectRetentionCommand).de(de_PutObjectRetentionCommand).build()){},PutObjectTaggingCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true}),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","PutObjectTagging",{}).n("S3Client","PutObjectTaggingCommand").f(void 0,void 0).ser(se_PutObjectTaggingCommand).de(de_PutObjectTaggingCommand).build()){},PutPublicAccessBlockCommand=class extends(Command.classBuilder().ep({...commonParams,UseS3ExpressControlEndpoint:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:true})]})).s("AmazonS3","PutPublicAccessBlock",{}).n("S3Client","PutPublicAccessBlockCommand").f(void 0,void 0).ser(se_PutPublicAccessBlockCommand).de(de_PutPublicAccessBlockCommand).build()){},RestoreObjectCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:false}),getThrow200ExceptionsPlugin(config)]})).s("AmazonS3","RestoreObject",{}).n("S3Client","RestoreObjectCommand").f(RestoreObjectRequestFilterSensitiveLog,void 0).ser(se_RestoreObjectCommand).de(de_RestoreObjectCommand).build()){},SelectObjectContentCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config),getSsecPlugin(config)]})).s("AmazonS3","SelectObjectContent",{eventStream:{output:true}}).n("S3Client","SelectObjectContentCommand").f(SelectObjectContentRequestFilterSensitiveLog,SelectObjectContentOutputFilterSensitiveLog).ser(se_SelectObjectContentCommand).de(de_SelectObjectContentCommand).build()){},UploadPartCommand=class extends(Command.classBuilder().ep({...commonParams,Bucket:{type:"contextParams",name:"Bucket"},Key:{type:"contextParams",name:"Key"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getFlexibleChecksumsPlugin(config,{input:this.input,requestAlgorithmMember:"ChecksumAlgorithm",requestChecksumRequired:false}),getThrow200ExceptionsPlugin(config),getSsecPlugin(config)]})).s("AmazonS3","UploadPart",{}).n("S3Client","UploadPartCommand").f(UploadPartRequestFilterSensitiveLog,UploadPartOutputFilterSensitiveLog).ser(se_UploadPartCommand).de(de_UploadPartCommand).build()){},UploadPartCopyCommand=class extends(Command.classBuilder().ep({...commonParams,DisableS3ExpressSessionAuth:{type:"staticContextParams",value:true},Bucket:{type:"contextParams",name:"Bucket"}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions()),getThrow200ExceptionsPlugin(config),getSsecPlugin(config)]})).s("AmazonS3","UploadPartCopy",{}).n("S3Client","UploadPartCopyCommand").f(UploadPartCopyRequestFilterSensitiveLog,UploadPartCopyOutputFilterSensitiveLog).ser(se_UploadPartCopyCommand).de(de_UploadPartCopyCommand).build()){},WriteGetObjectResponseCommand=class extends(Command.classBuilder().ep({...commonParams,UseObjectLambdaEndpoint:{type:"staticContextParams",value:true}}).m((function(Command2,cs2,config,o2){return[getSerdePlugin(config,this.serialize,this.deserialize),getEndpointPlugin(config,Command2.getEndpointParameterInstructions())]})).s("AmazonS3","WriteGetObjectResponse",{}).n("S3Client","WriteGetObjectResponseCommand").f(WriteGetObjectResponseRequestFilterSensitiveLog,void 0).ser(se_WriteGetObjectResponseCommand).de(de_WriteGetObjectResponseCommand).build()){},commands={AbortMultipartUploadCommand,CompleteMultipartUploadCommand,CopyObjectCommand,CreateBucketCommand,CreateMultipartUploadCommand,CreateSessionCommand,DeleteBucketCommand,DeleteBucketAnalyticsConfigurationCommand,DeleteBucketCorsCommand,DeleteBucketEncryptionCommand,DeleteBucketIntelligentTieringConfigurationCommand,DeleteBucketInventoryConfigurationCommand,DeleteBucketLifecycleCommand,DeleteBucketMetricsConfigurationCommand,DeleteBucketOwnershipControlsCommand,DeleteBucketPolicyCommand,DeleteBucketReplicationCommand,DeleteBucketTaggingCommand,DeleteBucketWebsiteCommand,DeleteObjectCommand,DeleteObjectsCommand,DeleteObjectTaggingCommand,DeletePublicAccessBlockCommand,GetBucketAccelerateConfigurationCommand,GetBucketAclCommand,GetBucketAnalyticsConfigurationCommand,GetBucketCorsCommand,GetBucketEncryptionCommand,GetBucketIntelligentTieringConfigurationCommand,GetBucketInventoryConfigurationCommand,GetBucketLifecycleConfigurationCommand,GetBucketLocationCommand,GetBucketLoggingCommand,GetBucketMetricsConfigurationCommand,GetBucketNotificationConfigurationCommand,GetBucketOwnershipControlsCommand,GetBucketPolicyCommand,GetBucketPolicyStatusCommand,GetBucketReplicationCommand,GetBucketRequestPaymentCommand,GetBucketTaggingCommand,GetBucketVersioningCommand,GetBucketWebsiteCommand,GetObjectCommand,GetObjectAclCommand,GetObjectAttributesCommand,GetObjectLegalHoldCommand,GetObjectLockConfigurationCommand,GetObjectRetentionCommand,GetObjectTaggingCommand,GetObjectTorrentCommand,GetPublicAccessBlockCommand,HeadBucketCommand,HeadObjectCommand,ListBucketAnalyticsConfigurationsCommand,ListBucketIntelligentTieringConfigurationsCommand,ListBucketInventoryConfigurationsCommand,ListBucketMetricsConfigurationsCommand,ListBucketsCommand,ListDirectoryBucketsCommand,ListMultipartUploadsCommand,ListObjectsCommand,ListObjectsV2Command,ListObjectVersionsCommand,ListPartsCommand,PutBucketAccelerateConfigurationCommand,PutBucketAclCommand,PutBucketAnalyticsConfigurationCommand,PutBucketCorsCommand,PutBucketEncryptionCommand,PutBucketIntelligentTieringConfigurationCommand,PutBucketInventoryConfigurationCommand,PutBucketLifecycleConfigurationCommand,PutBucketLoggingCommand,PutBucketMetricsConfigurationCommand,PutBucketNotificationConfigurationCommand,PutBucketOwnershipControlsCommand,PutBucketPolicyCommand,PutBucketReplicationCommand,PutBucketRequestPaymentCommand,PutBucketTaggingCommand,PutBucketVersioningCommand,PutBucketWebsiteCommand,PutObjectCommand,PutObjectAclCommand,PutObjectLegalHoldCommand,PutObjectLockConfigurationCommand,PutObjectRetentionCommand,PutObjectTaggingCommand,PutPublicAccessBlockCommand,RestoreObjectCommand,SelectObjectContentCommand,UploadPartCommand,UploadPartCopyCommand,WriteGetObjectResponseCommand},S3=class extends S3Client{};createAggregatedClient(commands,S3);var CheckPointInfoDefault={lastLocalSeq:0,knownIDs:new Set,sentIDs:new Set,receivedFiles:new Set,sentFiles:new Set},PREFIX_TRENCH="trench",PREFIX_EPHEMERAL="ephemeral",PREFIX_PERMANENT="permanent",idx=0,series=`${Date.now()}`;function generateId(prefix){if(++idx>1e4){series=`${Date.now()}`;idx=0}return`${PREFIX_TRENCH}-${prefix}-${series}-${idx+1e7}`}function createRange(prefix,series2){return[`${PREFIX_TRENCH}-${prefix}-${series2}-`,`${PREFIX_TRENCH}-${prefix}-${series2}.`]}function createId(prefix,series2,idx2){return`${PREFIX_TRENCH}-${prefix}-${series2}-${idx2+1e7}`}var indexes=new Map,inProgress=new Set,failed=new Map,Trench=class{constructor(db,flushExistItems=true){Object.defineProperty(this,"_db",{enumerable:true,configurable:true,writable:true,value:void 0});Object.defineProperty(this,"_flushTask",{enumerable:true,configurable:true,writable:true,value:void 0});Object.defineProperty(this,"concealing",{enumerable:true,configurable:true,writable:true,value:new Map});this._db=db;if(flushExistItems)this._flushTask=(async()=>{const keys2=await db.keys(`${PREFIX_TRENCH}-${PREFIX_EPHEMERAL}`,`${PREFIX_TRENCH}-${PREFIX_EPHEMERAL}.`);for(const key2 of keys2)await db.delete(key2)})()}async eraseAllEphemerals(){const keys2=await this._db.keys(`${PREFIX_TRENCH}-${PREFIX_EPHEMERAL}`,`${PREFIX_TRENCH}-${PREFIX_EPHEMERAL}.`);for(const key2 of keys2)await this._db.delete(key2)}async eraseAllPermanences(){const keys2=await this._db.keys(`${PREFIX_TRENCH}-${PREFIX_PERMANENT}`,`${PREFIX_TRENCH}-${PREFIX_PERMANENT}.`);for(const key2 of keys2)await this._db.delete(key2)}conceal(obj){const key2=generateId(PREFIX_EPHEMERAL);this.concealing.set(key2,obj);this._db.set(key2,obj).then((async e4=>{if(this.concealing.has(key2))this.concealing.delete(key2);else await this._db.delete(key2)}));return key2}async bury(key2){if(this.concealing.has(key2))this.concealing.delete(key2);await this._db.delete(key2)}async expose(key2){if(this.concealing.has(key2)){const value=this.concealing.get(key2);this.concealing.delete(key2);return value}const obj=await this._db.get(key2);await this._db.delete(key2);return obj}_evacuate(storeTask,key2){return async()=>{if(this._flushTask){await this._flushTask;this._flushTask=void 0}await storeTask;const item=await this._db.get(key2);await this._db.delete(key2);return item}}evacuatePromise(task){const key2=generateId(PREFIX_EPHEMERAL),storeTask=(async()=>{const data=await task;await this._db.set(key2,data)})();return this._evacuate(storeTask,key2)}evacuate(obj){if(obj instanceof Promise)return this.evacuatePromise(obj);const key2=generateId(PREFIX_EPHEMERAL),storeTask=this._db.set(key2,obj);return this._evacuate(storeTask,key2)}async _queue(type,key2,obj,index5){var _a5;if(void 0===index5){index5=null!=(_a5=indexes.get(key2))?_a5:0;indexes.set(key2,index5+1)}const storeKey=createId(type,key2,index5);await this._db.set(storeKey,obj)}async _dequeue(type,key2){const range2=createRange(type,key2),keys2=(await this._db.keys(range2[0],range2[1])).filter((e4=>!inProgress.has(e4)));if(0!==keys2.length)return await this.expose(keys2[0])}async _dequeueWithCommit(type,key2){const range2=createRange(type,key2),keysAll=await this._db.keys(range2[0],range2[1]),keys2=keysAll.filter((e4=>!inProgress.has(e4)));if(0===keys2.length)return;const storeKey=keys2[0];inProgress.add(storeKey);const previousFailed=failed.get(storeKey)||0,value=await this._db.get(storeKey);return{key:storeKey,value,cancelCount:previousFailed,pendingItems:keysAll.length-1,commit:async()=>{await this._db.delete(storeKey);failed.delete(storeKey);inProgress.delete(storeKey)},cancel:()=>{failed.set(storeKey,(failed.get(storeKey)||0)+1);inProgress.delete(storeKey)}}}queue(key2,obj,index5){return this._queue(PREFIX_EPHEMERAL,key2,obj,index5)}dequeue(key2){return this._dequeue(PREFIX_EPHEMERAL,key2)}dequeueWithCommit(key2){return this._dequeueWithCommit(PREFIX_EPHEMERAL,key2)}queuePermanent(key2,obj,index5){return this._queue(PREFIX_PERMANENT,key2,obj,index5)}dequeuePermanent(key2){return this._dequeue(PREFIX_PERMANENT,key2)}dequeuePermanentWithCommit(key2){return this._dequeueWithCommit(PREFIX_PERMANENT,key2)}},RECORD_SPLIT="\n",UNIT_SPLIT="",te3=new TextEncoder;function serializeDoc(doc){if(doc._id.startsWith("h:")){const writeData=escapeNewLineFromString(doc.data);return te3.encode(`~${doc._id}${UNIT_SPLIT}${writeData}${RECORD_SPLIT}`)}return te3.encode(JSON.stringify(doc)+RECORD_SPLIT)}var JournalSyncAbstract=class{constructor(id,key2,endpoint,bucket,store,env,useCustomRequestHandler,region=""){this.id="";this.key="";this.bucket="";this.endpoint="";this.region="auto";this.hash="";this.batchSize=100;this.requestedStop=false;this.notifier=new Notifier;this._currentCheckPointInfo={...CheckPointInfoDefault};this.isPacking=false;this.isDownloading=false;this.id=id;this.key=key2;this.bucket=bucket;this.endpoint=endpoint;this.region=region;this.db=env.getDatabase();this.env=env;this.useCustomRequestHandler=useCustomRequestHandler;this.processReplication=async docs=>await env.$$parseReplicationResult(docs);this.store=store;this.hash=this.getHash(endpoint,bucket,region);this.trench=new Trench(store)}getHash(endpoint,bucket,region){return btoa(encodeURI([endpoint,bucket,region].join()))}applyNewConfig(id,key2,endpoint,bucket,store,env,useCustomRequestHandler,region=""){this.id=id;this.key=key2;this.bucket=bucket;this.endpoint=endpoint;this.region=region;this.db=env.getDatabase();this.env=env;this.useCustomRequestHandler=useCustomRequestHandler;this.processReplication=async docs=>await env.$$parseReplicationResult(docs);this.store=store;this.hash=this.getHash(endpoint,bucket,region)}updateInfo(info3){var _a5,_b2,_c2,_d2,_e2,_f,_g;const old=this.env.replicationStat.value;this.env.replicationStat.value={sent:null!=(_a5=info3.sent)?_a5:old.sent,arrived:null!=(_b2=info3.arrived)?_b2:old.arrived,maxPullSeq:null!=(_c2=info3.maxPullSeq)?_c2:old.maxPullSeq,maxPushSeq:null!=(_d2=info3.maxPushSeq)?_d2:old.maxPushSeq,lastSyncPullSeq:null!=(_e2=info3.lastSyncPullSeq)?_e2:old.lastSyncPullSeq,lastSyncPushSeq:null!=(_f=info3.lastSyncPushSeq)?_f:old.lastSyncPushSeq,syncStatus:null!=(_g=info3.syncStatus)?_g:old.syncStatus}}async updateCheckPointInfo(func){const checkPointKey=`bucketsync-checkpoint-${this.hash}`,newInfo=func(await this.getCheckpointInfo());this._currentCheckPointInfo=newInfo;await this.store.set(checkPointKey,newInfo);return newInfo}async getCheckpointInfo(){const checkPointKey=`bucketsync-checkpoint-${this.hash}`,old=await this.store.get(checkPointKey)||{},items=["knownIDs","sentIDs","receivedFiles","sentFiles"];for(const key2 of items)if(key2 in old&&typeof Array.isArray(old[key2]))old[key2]=new Set(old[key2]);this._currentCheckPointInfo={...CheckPointInfoDefault,...old};return this._currentCheckPointInfo}async resetAllCaches(){await this.trench.eraseAllPermanences()}async resetCheckpointInfo(){await this.updateCheckPointInfo((info3=>({...CheckPointInfoDefault})))}async _createJournalPack(override){const checkPointInfo=await this.getCheckpointInfo(),from=override||checkPointInfo.lastLocalSeq;Logger(`Journal reading from seq:${from}`,LOG_LEVEL_VERBOSE);let knownKeyCount=0,sendKeyCount=0;const allChangesTask=this.db.changes({live:false,since:override||from,conflicts:true,limit:this.batchSize,return_docs:true,attachments:false,style:"all_docs",filter:doc=>{const key2=this.getDocKey(doc);if(this._currentCheckPointInfo.knownIDs.has(key2)){knownKeyCount++;return false}if(this._currentCheckPointInfo.sentIDs.has(key2)){knownKeyCount++;return false}sendKeyCount++;return true}}),allChanges=await allChangesTask;if(0==allChanges.results.length)return{changes:[],hasNext:false,packLastSeq:allChanges.last_seq};Logger(`${sendKeyCount} items possibly needs to be sent (${knownKeyCount} keys has been received before)`,LOG_LEVEL_DEBUG);const bd2=await this.db.bulkGet({docs:allChanges.results.map((e4=>e4.changes.map((change=>({id:e4.id,rev:change.rev}))))).flat(),revs:true}),packLastSeq=allChanges.last_seq,hasNext=packLastSeq<(await this.db.info()).update_seq;return{changes:bd2.results.map((e4=>e4.docs)).flat().filter((e4=>"ok"in e4)).map((e4=>e4.ok)),hasNext,packLastSeq}}getDocKey(doc){if(doc&&doc._id.startsWith("h:"))return doc._id;else return doc._id+"-"+doc._rev}async uploadQueued(showMessage=false,wrapUp=false){return await shareRunningResult("upload_queue",(async()=>{const TASK_TITLE="Uploading journal:",logLevel=showMessage?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO;let uploaded=0;do{const queued=await this.trench.dequeuePermanentWithCommit("upload_queue");if(!queued){if(this.isPacking){Logger(`${TASK_TITLE} Queue run out, but process is running. wait for the next.`,LOG_LEVEL_VERBOSE);await Promise.race([this.notifier.nextNotify,delay(3e3)]);continue}if(uploaded)Logger(`${TASK_TITLE}: ${uploaded} files have been uploaded!`,logLevel,"send_journal");else if(!wrapUp)Logger("No files needs to be uploaded!",logLevel,"send_journal");return true}const{key:key2,value,commit,cancel,cancelCount,pendingItems}=queued;this.updateInfo({sent:uploaded,maxPushSeq:pendingItems+uploaded,lastSyncPushSeq:1});Logger(`${TASK_TITLE} ${uploaded} / ${pendingItems+uploaded}${0!=cancelCount?`\nRETRY:${cancelCount}`:""}`,logLevel,"send_journal");Logger(`${TASK_TITLE} ${key2} ${0!=cancelCount?`TRY:${cancelCount}`:""} ${pendingItems} left`,LOG_LEVEL_VERBOSE);if(cancelCount>3){Logger(`${TASK_TITLE} Something went wrong on processing queue ${key2}.`,LOG_LEVEL_NOTICE);return false}const filename=`${Date.now()}-docs.jsonl.gz`,mime="application/octet-stream",blob=new Blob([value],{type:mime});try{if(!await this.uploadFile(filename,blob,mime))throw new Error("Could not send journalPack to the bucket");await commit();uploaded++;await this.updateCheckPointInfo((info3=>({...info3,sentFiles:info3.sentFiles.add(filename)})));Logger(`${TASK_TITLE}: Uploaded ${key2} as ${filename}`,LOG_LEVEL_INFO)}catch(ex){Logger(`${TASK_TITLE} Could not send journalPack to the bucket (${key2} as ${filename})`,LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE);Logger(`${TASK_TITLE} Uploading ${key2} cancelled for retry`,LOG_LEVEL_VERBOSE);cancel();await delay(1e3);continue}}while(false==this.requestedStop)}))}async packAndCompress(showMessage=false){return await shareRunningResult("create_send_data",(async()=>{try{this.isPacking=true;const MSG_KEY="pack_journal",logLevel=showMessage?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO;this.requestedStop=false;const checkPointInfo=await this.getCheckpointInfo(),max3=(await this.db.info()).update_seq,sentIDs=checkPointInfo.sentIDs,maxOutBufLength=250,maxBinarySize=10485760;let currentLastSeq=checkPointInfo.lastLocalSeq,binarySize=0;const outBuf=[];let isFinished=false;const startSeq=checkPointInfo.lastLocalSeq,seqToProcess=max3-startSeq;Logger("Packing Journal: Start sending",logLevel,MSG_KEY);do{if(this.requestedStop){Logger("Packing Journal : Stop requested",logLevel,MSG_KEY);isFinished=true;break}const{changes:changes3,hasNext,packLastSeq}=await this._createJournalPack(currentLastSeq),currentSeq=packLastSeq-startSeq;if(0==changes3.length)isFinished=true;else{Logger(`Packing Journal: ${currentSeq} / ${seqToProcess}`,logLevel,MSG_KEY);for(const row of changes3){const serialized2=serializeDoc(row);sentIDs.add(this.getDocKey(row));binarySize+=serialized2.length;outBuf.push(serialized2);if(outBuf.length>maxOutBufLength||binarySize>maxBinarySize){const sendBuf=concatUInt8Array(outBuf),orgLen=sendBuf.byteLength,bin=await wrappedDeflate(sendBuf,{consume:true,level:8});Logger(`Packing Journal: Compressed ${orgLen} bytes to ${bin.byteLength} bytes (${0!=orgLen?Math.ceil(bin.byteLength/orgLen*100):"--"}%)`,LOG_LEVEL_VERBOSE);await this.trench.queuePermanent("upload_queue",bin);this.notifier.notify();outBuf.length=0;binarySize=0}}}if(outBuf.length>0){const sendBuf=concatUInt8Array(outBuf),orgLen=sendBuf.byteLength,bin=await wrappedDeflate(sendBuf,{consume:true,level:8});Logger(`Packing Journal: Compressed ${orgLen} bytes to ${bin.byteLength} bytes (${0!=orgLen?Math.ceil(bin.byteLength/orgLen*100):"--"}%)`,LOG_LEVEL_VERBOSE);await this.trench.queuePermanent("upload_queue",bin);this.notifier.notify()}await this.updateCheckPointInfo((info3=>({...info3,lastLocalSeq:packLastSeq,sentIDs})));currentLastSeq=packLastSeq;if(!hasNext){isFinished=true;break}}while(false==this.requestedStop&&!isFinished);if(0!=seqToProcess)Logger(`Packing Journal: Packaging ${seqToProcess}`,logLevel,MSG_KEY);else Logger("Packing Journal: No journals to be packed!",logLevel,MSG_KEY);this.notifier.notify();return true}finally{this.isPacking=false;this.notifier.notify()}}))}async sendLocalJournal(showMessage=false){this.updateInfo({syncStatus:"JOURNAL_SEND"});if((await Promise.all([this.packAndCompress(showMessage),this.uploadQueued(showMessage)])).every((e4=>e4)))if(await this.uploadQueued(showMessage,true)){this.updateInfo({syncStatus:"COMPLETED"});return true}this.updateInfo({syncStatus:"ERRORED"});return false}async _getRemoteJournals(){const StartAfter=[...(await this.getCheckpointInfo()).receivedFiles.keys()].sort(((a2,b3)=>b3.localeCompare(a2,void 0,{numeric:true})))[0],files=(await this.listFiles(StartAfter)).filter((e4=>!e4.startsWith("_")));if(!files)return[];else return files.sort(((a2,b3)=>a2.localeCompare(b3,void 0,{numeric:true})))}async processDocuments(allDocs2){let applyTotal=0,wholeItems=0;try{const chunks=[],docs=[];allDocs2.forEach((e4=>{if(e4._id.startsWith("h:"))chunks.push(e4);else docs.push(e4)}));try{const e22=(await this.db.allDocs({include_docs:true,keys:[...chunks.map((e4=>e4._id))]})).rows.map((e4=>{var _a5;return null!=(_a5=e4.id)?_a5:void 0})),existChunks=new Set(e22.filter((e4=>void 0!==e4))),saveChunks=chunks.filter((e4=>!existChunks.has(e4._id))).map((e4=>({...e4,_rev:void 0}))),ret=await this.db.bulkDocs(saveChunks,{new_edits:true}),saveError=ret.filter((e4=>"error"in e4)).map((e4=>e4.id));saveChunks.filter((e4=>-1===saveError.indexOf(e4._id))).forEach((doc=>sendValue(`leaf-${doc._id}`,doc)));await this.updateCheckPointInfo((info3=>({...info3,knownIDs:setAllItems(info3.knownIDs,chunks.map((e4=>this.getDocKey(e4))))})));Logger(`Saved ${ret.length} chunks in transferred ${chunks.length} chunks (Error:${saveError.length})`,LOG_LEVEL_VERBOSE)}catch(ex){Logger("Applying chunks failed",LOG_LEVEL_INFO);Logger(ex,LOG_LEVEL_VERBOSE)}const docsRevs=docs.map((e4=>({[e4._id]:e4._revisions.ids.map(((rev3,i2)=>`${e4._revisions.start-i2}-${rev3}`))}))).reduce(((a2,b3)=>({...a2,...b3})),{}),diffRevs=await this.db.revsDiff(docsRevs),saveDocs=docs.filter((e4=>{var _a5;return e4._id in diffRevs&&"missing"in diffRevs[e4._id]&&((null==(_a5=diffRevs[e4._id].missing)?void 0:_a5.length)||0)>0}));Logger(`Applying ${saveDocs.length} docs (Total transferred:${docs.length}, docs:${allDocs2.length})`,LOG_LEVEL_VERBOSE);await this.db.bulkDocs(saveDocs,{new_edits:false});await this.processReplication(saveDocs);await this.updateCheckPointInfo((info3=>({...info3,knownIDs:setAllItems(info3.knownIDs,docs.map((e4=>this.getDocKey(e4))))})));applyTotal+=saveDocs.length;wholeItems+=docs.length;Logger(`Applied ${applyTotal} of ${wholeItems} docs (${wholeItems-applyTotal} skipped)`,LOG_LEVEL_VERBOSE);return true}catch(ex){Logger("Applying journal failed",LOG_LEVEL_INFO);Logger(ex,LOG_LEVEL_VERBOSE);return false}}async processDownloadedJournals(showMessage=false,wrapUp=false){return await shareRunningResult("process_downloaded_journals",(async()=>{const logLevel=showMessage?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,TASK_TITLE="Processing journal:";let downloaded=0;do{const queued=await this.trench.dequeuePermanentWithCommit("parse_file");if(!queued){if(this.isDownloading){Logger(`${TASK_TITLE} Queue run out, but process is running. wait for the next.`,LOG_LEVEL_VERBOSE);await Promise.race([this.notifier.nextNotify,delay(3e3)]);continue}if(downloaded)Logger(`${TASK_TITLE} ${downloaded} files have been uploaded!`,logLevel,"send_journal");else if(!wrapUp)Logger(`${TASK_TITLE} No files needs to be processed!`,logLevel,"send_journal");return true}const{key:key2,value,commit,cancel,cancelCount,pendingItems}=queued;this.updateInfo({arrived:downloaded,maxPullSeq:pendingItems+downloaded,lastSyncPullSeq:1});Logger(`${TASK_TITLE} ${downloaded} / ${pendingItems+downloaded}${0!=cancelCount?`\nRETRY:${cancelCount}`:""}`,logLevel,"processjournal");if(cancelCount>3){Logger(`${TASK_TITLE} Something went wrong on processing queue ${key2}.`,LOG_LEVEL_NOTICE);return false}const decompressed=await wrappedInflate(value,{consume:true});if(0==decompressed.length){await commit();downloaded++;Logger(`${TASK_TITLE}: ${key2} has been processed`,LOG_LEVEL_INFO);continue}let idxFrom=0,idxTo=0;const d4=new TextDecoder,result=[];do{idxTo=decompressed.indexOf(10,idxFrom);if(-1==idxTo)break;const piece=decompressed.slice(idxFrom,idxTo),strPiece=d4.decode(piece);if(strPiece.startsWith("~")){const[key3,data]=strPiece.substring(1).split(UNIT_SPLIT);result.push({_id:key3,data:unescapeNewLineFromString(data),type:"leaf",_rev:""})}else result.push(JSON.parse(strPiece));idxFrom=idxTo+1}while(idxTo>0);try{if(await this.processDocuments(result)){await commit();downloaded++;Logger(`${TASK_TITLE}: ${key2} has been processed`,LOG_LEVEL_INFO)}else throw new Error("Could not process downloaded journals")}catch(ex){Logger(`${TASK_TITLE}: Could not process downloaded journals`,LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE);Logger(`${TASK_TITLE}: ${key2} cancelled for retry`,LOG_LEVEL_VERBOSE);cancel();await delay(1e3);continue}}while(false==this.requestedStop);return true}))}async downloadRemoteJournals(showMessage=false){return await shareRunningResult("downloadRemoteJournals",(async()=>{try{this.isDownloading=true;const logLevel=showMessage?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO;Logger("Receiving Journal: Getting list of remote journal",logLevel,"receivejournal");const files=await this._getRemoteJournals();if(0==files.length){Logger("Receiving Journal: No journals needs to be downloaded",logLevel,"receivejournal");return true}let count=0;for(const key2 of files){count++;Logger(`Receiving Journal: ${count} / ${files.length}`,logLevel,"receivejournal");if(this.requestedStop){Logger(`Receiving canceled: ${key2}`,logLevel);return false}if(!this._currentCheckPointInfo.sentFiles.has(key2))try{const data=await this.downloadFile(key2);if(false===data)throw new Error("Download Error");await this.trench.queuePermanent("parse_file",data);await this.updateCheckPointInfo((info3=>({...info3,receivedFiles:info3.receivedFiles.add(key2)})));this.notifier.notify()}catch(ex){Logger(`Could not download ${key2}`,logLevel);Logger(ex,LOG_LEVEL_DEBUG);return false}else{Logger(`Receiving Journal: ${key2} is own sent file`,LOG_LEVEL_VERBOSE);await this.updateCheckPointInfo((info3=>({...info3,receivedFiles:info3.receivedFiles.add(key2)})))}}}finally{this.isDownloading=false;this.notifier.notify()}this.notifier.notify();return true}))}async receiveRemoteJournal(showMessage=false){this.updateInfo({syncStatus:"JOURNAL_RECEIVE"});this.requestedStop=false;if((await Promise.all([this.downloadRemoteJournals(showMessage),this.processDownloadedJournals(showMessage)])).every((e4=>e4)))if(await this.processDownloadedJournals(showMessage,true)){this.updateInfo({syncStatus:"COMPLETED"});return true}this.updateInfo({syncStatus:"ERRORED"});return false}async sync(showResult=false){var _a5;return null!=(_a5=await shareRunningResult("replicate",(async()=>{this.requestedStop=false;const receiveResult=await this.receiveRemoteJournal(showResult);if(!this.requestedStop)if(receiveResult)return await this.sendLocalJournal(showResult);else Logger("Could not receive remote journal, so we prevent sending local journals to prevent unwanted mass transfers",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO)})))?_a5:false}requestStop(){this.requestedStop=true}},JournalSyncMinio=class extends JournalSyncAbstract{_getClient(){if(this._instance)return this._instance;const ep=this.endpoint?{endpoint:this.endpoint,forcePathStyle:true}:{};this._instance=new S3({region:this.region,...ep,credentials:{accessKeyId:this.id,secretAccessKey:this.key},maxAttempts:4,retryStrategy:new ConfiguredRetryStrategy(4,(attempt=>100+1e3*attempt)),requestHandler:this.useCustomRequestHandler?this.env.$$customFetchHandler():void 0});return this._instance}async resetBucket(){var _a5;const client=this._getClient();let files=[],deleteCount=0,errorCount=0;try{do{files=await this.listFiles("");if(0==files.length)break;const cmd2=new DeleteObjectsCommand({Bucket:this.bucket,Delete:{Objects:files.map((e4=>({Key:e4})))}}),r3=await client.send(cmd2),{Deleted,Errors}=r3;deleteCount+=(null==Deleted?void 0:Deleted.length)||0;errorCount+=(null==Errors?void 0:Errors.length)||0;Logger(`${deleteCount} items has been deleted!${0!=errorCount?` (${errorCount} items failed to delete)`:""}`,LOG_LEVEL_NOTICE,"reset-bucket")}while(0==files.length)}catch(ex){Logger("WARNING! Could not delete files. you should try it once or remake the bucket manually",LOG_LEVEL_NOTICE,"reset-bucket");Logger(ex,LOG_LEVEL_VERBOSE)}const journals=await this._getRemoteJournals();if(0==journals.length){Logger("Nothing to delete!",LOG_LEVEL_NOTICE);return true}const cmd=new DeleteObjectsCommand({Bucket:this.bucket,Delete:{Objects:journals.map((e4=>({Key:e4})))}}),r2=await client.send(cmd);Logger(`${(null==(_a5=null==r2?void 0:r2.Deleted)?void 0:_a5.length)||0} items has been deleted!`,LOG_LEVEL_NOTICE);await this.resetCheckpointInfo();return true}async uploadJson(key2,body){try{return await this.uploadFile(key2,new Blob([JSON.stringify(body)]),"application/json")}catch(ex){Logger(`Could not upload json ${key2}`);Logger(ex,LOG_LEVEL_VERBOSE);return false}}async downloadJson(key2){try{const ret=await this.downloadFile(key2,true);if(!ret)return false;else return JSON.parse((new TextDecoder).decode(ret))}catch(ex){Logger(`Could not download json ${key2}`);Logger(ex,LOG_LEVEL_VERBOSE);return false}}async uploadFile(key2,blob,mime){try{let u2=new Uint8Array(await blob.arrayBuffer());const set=this.env.getSettings();if(set.encrypt&&""!=set.passphrase)u2=await encryptBinary(u2,set.passphrase,set.useDynamicIterationCount);const client=this._getClient(),cmd=new PutObjectCommand({Bucket:this.bucket,Key:key2,Body:u2,ContentType:mime});if(await client.send(cmd))return true}catch(ex){Logger(`Could not upload ${key2}`);Logger(ex,LOG_LEVEL_VERBOSE)}return false}async downloadFile(key2,ignoreCache=false){const client=this._getClient(),cmd=new GetObjectCommand({Bucket:this.bucket,Key:key2,...ignoreCache?{ResponseCacheControl:"no-cache"}:{}}),r2=await client.send(cmd),set=this.env.getSettings();try{if(r2.Body){let u2=await r2.Body.transformToByteArray();if(set.encrypt&&""!=set.passphrase)u2=await decryptBinary(u2,set.passphrase,set.useDynamicIterationCount);return u2}}catch(ex){Logger(`Could not download ${key2}`);Logger(ex,LOG_LEVEL_VERBOSE)}return false}async listFiles(from,limit){const client=this._getClient(),objects=await client.listObjectsV2({Bucket:this.bucket,StartAfter:from,...limit?{MaxKeys:limit}:{}});if(!objects.Contents)return[];else return objects.Contents.map((e4=>e4.Key))}async isAvailable(){const client=this._getClient(),cmd=new HeadBucketCommand({Bucket:this.bucket});try{await client.send(cmd);return true}catch(ex){Logger("Could not connected to the remote bucket",LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE);return false}}async getUsage(){const client=this._getClient();try{const objects=await client.listObjectsV2({Bucket:this.bucket});if(!objects.Contents)return{};else return{estimatedSize:objects.Contents.reduce(((acc,e4)=>acc+(e4.Size||0)),0)}}catch(ex){Logger("Could not get status of the remote bucket",LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE);return false}}};async function ensureRemoteIsCompatible(infoSrc,setting,deviceNodeID,currentVersionRange3,updateCallback){var _a5,_b2,_c2,_d2;const baseMilestone={_id:MILESTONE_DOCID,type:"milestoneinfo",created:new Date/1,locked:false,accepted_nodes:[deviceNodeID],node_chunk_info:{[deviceNodeID]:currentVersionRange3},tweak_values:{}};let remoteMilestone=infoSrc;if(!remoteMilestone)remoteMilestone=baseMilestone;const currentTweakValues=extractObject(TweakValuesTemplate,setting);remoteMilestone.node_chunk_info={...baseMilestone.node_chunk_info,...remoteMilestone.node_chunk_info};if(remoteMilestone.node_chunk_info[deviceNodeID].min!=currentVersionRange3.min||remoteMilestone.node_chunk_info[deviceNodeID].max!=currentVersionRange3.max||isObjectDifferent(null==(_a5=remoteMilestone.tweak_values)?void 0:_a5[deviceNodeID],currentTweakValues)||"undefined"==typeof remoteMilestone._rev||!(DEVICE_ID_PREFERRED in remoteMilestone.tweak_values)){remoteMilestone.node_chunk_info[deviceNodeID].min=currentVersionRange3.min;remoteMilestone.node_chunk_info[deviceNodeID].max=currentVersionRange3.max;remoteMilestone.tweak_values={...null!=(_b2=remoteMilestone.tweak_values)?_b2:{},[deviceNodeID]:currentTweakValues};if(!(DEVICE_ID_PREFERRED in remoteMilestone.tweak_values))remoteMilestone.tweak_values[DEVICE_ID_PREFERRED]=currentTweakValues;await updateCallback(remoteMilestone)}let globalMin=currentVersionRange3.min,globalMax=currentVersionRange3.max;for(const nodeId of remoteMilestone.accepted_nodes)if(nodeId!=deviceNodeID)if(nodeId in remoteMilestone.node_chunk_info){const nodeInfo=remoteMilestone.node_chunk_info[nodeId];globalMin=Math.max(nodeInfo.min,globalMin);globalMax=Math.min(nodeInfo.max,globalMax)}else{globalMin=0;globalMax=0}if(globalMax<globalMin)if(!setting.ignoreVersionCheck)return"INCOMPATIBLE";if(!setting.disableCheckingConfigMismatch){const preferred_tweak=null!=(_d2=null==(_c2=remoteMilestone.tweak_values)?void 0:_c2[DEVICE_ID_PREFERRED])?_d2:currentTweakValues,current_tweak=currentTweakValues;if(isObjectDifferent(extractObject(TweakValuesShouldMatchedTemplate,{...TweakValuesDefault,...preferred_tweak}),extractObject(TweakValuesShouldMatchedTemplate,{...TweakValuesDefault,...current_tweak}),true))return["MISMATCHED",preferred_tweak]}if(remoteMilestone.locked){if(-1==remoteMilestone.accepted_nodes.indexOf(deviceNodeID))if(remoteMilestone.cleaned)return"NODE_CLEANED";else return"NODE_LOCKED";return"LOCKED"}return"OK"}async function ensureDatabaseIsCompatible(db,setting,deviceNodeID,currentVersionRange3){const remoteMilestone=await resolveWithIgnoreKnownError(db.get(MILESTONE_DOCID),false);return await ensureRemoteIsCompatible(remoteMilestone,setting,deviceNodeID,currentVersionRange3,(async info3=>{await db.put(info3)}))}var MILSTONE_DOCID="_00000000-milestone.json",currentVersionRange={min:0,max:2,current:2},LiveSyncJournalReplicator=class extends LiveSyncAbstractReplicator{constructor(env){super(env);this.syncStatus="NOT_CONNECTED";this.docArrived=0;this.docSent=0;this.lastSyncPullSeq=0;this.maxPullSeq=0;this.lastSyncPushSeq=0;this.maxPushSeq=0;this.nodeid="";this.remoteLocked=false;this.remoteCleaned=false;this.remoteLockedAndDeviceNotAccepted=false;this.updateInfo=()=>{this.env.replicationStat.value={sent:this.docSent,arrived:this.docArrived,maxPullSeq:this.maxPullSeq,maxPushSeq:this.maxPushSeq,lastSyncPullSeq:this.lastSyncPullSeq,lastSyncPushSeq:this.lastSyncPushSeq,syncStatus:this.syncStatus}};this.env=env;fireAndForget((()=>this.initializeDatabaseForReplication()));this.env.getDatabase().on("close",(()=>{this.closeReplication()}))}get client(){return this.setupJournalSyncClient()}setupJournalSyncClient(){const settings=this.env.getSettings(),id=settings.accessKey,key2=settings.secretKey,bucket=settings.bucket,region=settings.region,endpoint=settings.endpoint,useCustomRequestHandler=settings.useCustomRequestHandler;if(this._client)this._client.applyNewConfig(id,key2,endpoint,bucket,this.env.simpleStore,this.env,useCustomRequestHandler,region);else this._client=new JournalSyncMinio(id,key2,endpoint,bucket,this.env.simpleStore,this.env,useCustomRequestHandler,region);return this._client}async ensureBucketIsCompatible(deviceNodeID,currentVersionRange3){const downloadedMilestone=await this.client.downloadJson(MILSTONE_DOCID);return await ensureRemoteIsCompatible(downloadedMilestone,this.env.getSettings(),deviceNodeID,currentVersionRange3,(async info3=>{await this.client.uploadJson(MILSTONE_DOCID,info3)}))}async migrate(from,to){Logger(`Database updated from ${from} to ${to}`,LOG_LEVEL_NOTICE);return Promise.resolve(true)}terminateSync(){this.client.requestStop()}async openReplication(setting,_,showResult,ignoreCleanLock=false){if(!await this.checkReplicationConnectivity(false,ignoreCleanLock))return false;await this.client.sync(showResult)}async replicateAllToServer(setting,showingNotice){if(!await this.checkReplicationConnectivity(false))return false;else return await this.client.sendLocalJournal(showingNotice)}async replicateAllFromServer(setting,showingNotice){if(!await this.checkReplicationConnectivity(false))return false;else return await this.client.receiveRemoteJournal(showingNotice)}async checkReplicationConnectivity(skipCheck,ignoreCleanLock=false){if(!await this.client.isAvailable())return false;if(!skipCheck){this.remoteCleaned=false;this.remoteLocked=false;this.remoteLockedAndDeviceNotAccepted=false;this.tweakSettingsMismatched=false;const ensure=await this.ensureBucketIsCompatible(this.nodeid,currentVersionRange);if("INCOMPATIBLE"==ensure){Logger("The remote database has no compatibility with the running version. Please upgrade the plugin.",LOG_LEVEL_NOTICE);return false}else if("NODE_LOCKED"==ensure){Logger("The remote database has been rebuilt or corrupted since we have synchronized last time. Fetch rebuilt DB, explicit unlocking or chunk clean-up is required.",LOG_LEVEL_NOTICE);this.remoteLockedAndDeviceNotAccepted=true;this.remoteLocked=true;return false}else if("LOCKED"==ensure)this.remoteLocked=true;else if("NODE_CLEANED"==ensure)if(ignoreCleanLock)this.remoteLocked=true;else{Logger("The remote database has been cleaned up. Fetch rebuilt DB, explicit unlocking or chunk clean-up is required.",LOG_LEVEL_NOTICE);this.remoteLockedAndDeviceNotAccepted=true;this.remoteLocked=true;this.remoteCleaned=true;return false}else if("OK"==ensure);else if("MISMATCHED"==ensure[0]){Logger("Configuration mismatching between the clients has been detected. This can be harmful or extra capacity consumption. We have to make these value unified.",LOG_LEVEL_NOTICE);this.tweakSettingsMismatched=true;this.preferredTweakValue=ensure[1];return false}}return true}async fetchRemoteChunks(missingChunks,showResult){return Promise.resolve([])}closeReplication(){this.client.requestStop();this.syncStatus="CLOSED";Logger("Replication closed");this.updateInfo()}async tryResetRemoteDatabase(setting){this.closeReplication();try{await this.client.resetBucket();Logger("Remote Bucket Cleared",LOG_LEVEL_NOTICE);await this.tryCreateRemoteDatabase(setting)}catch(ex){Logger("Something happened on Remote Bucket Clear",LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_NOTICE)}}async tryCreateRemoteDatabase(setting){this.closeReplication();Logger("Remote Database Created or Connected",LOG_LEVEL_NOTICE);return await Promise.resolve()}async markRemoteLocked(setting,locked,lockByClean){const defInitPoint={_id:MILSTONE_DOCID,type:"milestoneinfo",created:new Date/1,locked,cleaned:lockByClean,accepted_nodes:[this.nodeid],node_chunk_info:{[this.nodeid]:currentVersionRange},tweak_values:{}},remoteMilestone={...defInitPoint,...await this.client.downloadJson(MILSTONE_DOCID)||{}};remoteMilestone.node_chunk_info={...defInitPoint.node_chunk_info,...remoteMilestone.node_chunk_info};remoteMilestone.accepted_nodes=[this.nodeid];remoteMilestone.locked=locked;remoteMilestone.cleaned=remoteMilestone.cleaned||lockByClean;if(locked)Logger("Lock remote bucket to prevent data corruption",LOG_LEVEL_NOTICE);else Logger("Unlock remote bucket to prevent data corruption",LOG_LEVEL_NOTICE);await this.client.uploadJson(MILSTONE_DOCID,remoteMilestone)}async markRemoteResolved(setting){const defInitPoint={_id:MILSTONE_DOCID,type:"milestoneinfo",created:new Date/1,locked:false,accepted_nodes:[this.nodeid],node_chunk_info:{[this.nodeid]:currentVersionRange},tweak_values:{}},remoteMilestone={...defInitPoint,...await this.client.downloadJson(MILSTONE_DOCID)||{}};remoteMilestone.node_chunk_info={...defInitPoint.node_chunk_info,...remoteMilestone.node_chunk_info};remoteMilestone.accepted_nodes=Array.from(new Set([...remoteMilestone.accepted_nodes,this.nodeid]));Logger("Mark this device as 'resolved'.",LOG_LEVEL_NOTICE);await this.client.uploadJson(MILSTONE_DOCID,remoteMilestone)}async tryConnectRemote(setting,showResult=true){const id=setting.accessKey,key2=setting.secretKey,bucket=setting.bucket,region=setting.region,endpoint=setting.endpoint,useCustomRequestHandler=setting.useCustomRequestHandler,testClient=new JournalSyncMinio(id,key2,endpoint,bucket,this.env.simpleStore,this.env,useCustomRequestHandler,region);try{await testClient.listFiles("",1);Logger(`Connected to ${endpoint} successfully!`,LOG_LEVEL_NOTICE);return true}catch(ex){Logger(`Error! Could not connected to ${endpoint}\n${ex.message}`,LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_NOTICE);return false}}async resetRemoteTweakSettings(setting){try{const remoteMilestone=await this.client.downloadJson(MILSTONE_DOCID);if(!remoteMilestone)throw new Error("Missing remote milestone");remoteMilestone.tweak_values={};Logger("tweak values on the remote database have been cleared",LOG_LEVEL_VERBOSE);await this.client.uploadJson(MILSTONE_DOCID,remoteMilestone)}catch(ex){Logger("Could not retrieve remote milestone",LOG_LEVEL_NOTICE);throw ex}}async setPreferredRemoteTweakSettings(setting){try{const remoteMilestone=await this.client.downloadJson(MILSTONE_DOCID);if(!remoteMilestone)throw new Error("Missing remote milestone");remoteMilestone.tweak_values[DEVICE_ID_PREFERRED]=extractObject(TweakValuesTemplate,{...setting});Logger("tweak values on the remote database have been cleared",LOG_LEVEL_VERBOSE);await this.client.uploadJson(MILSTONE_DOCID,remoteMilestone)}catch(ex){Logger("Could not retrieve remote milestone",LOG_LEVEL_NOTICE);throw ex}}async getRemotePreferredTweakValues(setting){try{const remoteMilestone=await this.client.downloadJson(MILSTONE_DOCID);if(!remoteMilestone)throw new Error("Missing remote milestone");return remoteMilestone.tweak_values[DEVICE_ID_PREFERRED]||false}catch(ex){Logger("Could not retrieve remote milestone",LOG_LEVEL_NOTICE);throw ex}}async getRemoteStatus(setting){const id=setting.accessKey,key2=setting.secretKey,bucket=setting.bucket,region=setting.region,endpoint=setting.endpoint,useCustomRequestHandler=setting.useCustomRequestHandler,testClient=new JournalSyncMinio(id,key2,endpoint,bucket,this.env.simpleStore,this.env,useCustomRequestHandler,region);return await testClient.getUsage()}},currentVersionRange2={min:0,max:2400,current:2},selectorOnDemandPull={selector:{type:{$ne:"leaf"}}};async function*genReplication(s2,signal){const p2=[];let locker=()=>Promise.resolve(),unlock=()=>{locker=()=>new Promise((res2=>unlock=res2))};unlock();const push=function(e4){p2.push(e4);unlock()};s2.on("complete",(result=>push(["complete",result])));s2.on("change",(result=>push(["change",result])));s2.on("active",(()=>push(["active"])));s2.on("denied",(err2=>push(["denied",err2])));s2.on("error",(err2=>push(["error",err2])));s2.on("paused",(err2=>push(["paused",err2])));s2.then((()=>push(["finally"]))).catch((()=>push(["finally"])));try{L1:for(;;){const r2=p2.shift();if(!r2){const dx=async()=>{await locker();return true};for(;;){const timeout=async()=>{await delay(100);return false};if(await Promise.race([dx(),timeout()]))continue L1;if(signal.aborted)break L1}}else{yield r2;if("finally"==r2[0])break}}}finally{s2.cancel()}}var LiveSyncCouchDBReplicator=class extends LiveSyncAbstractReplicator{constructor(env){super(env);this.syncStatus="NOT_CONNECTED";this.docArrived=0;this.docSent=0;this.lastSyncPullSeq=0;this.maxPullSeq=0;this.lastSyncPushSeq=0;this.maxPushSeq=0;this.nodeid="";this.remoteLocked=false;this.remoteCleaned=false;this.remoteLockedAndDeviceNotAccepted=false;this.updateInfo=()=>{this.env.replicationStat.value={sent:this.docSent,arrived:this.docArrived,maxPullSeq:this.maxPullSeq,maxPushSeq:this.maxPushSeq,lastSyncPullSeq:this.lastSyncPullSeq,lastSyncPushSeq:this.lastSyncPushSeq,syncStatus:this.syncStatus}};this.env=env;this.initializeDatabaseForReplication();this.env.getDatabase().on("close",(()=>{this.closeReplication()}))}async migrate(from,to){Logger(`Database updated from ${from} to ${to}`,LOG_LEVEL_NOTICE);return Promise.resolve(true)}terminateSync(){if(this.controller){this.controller.abort();this.controller=void 0}}async openReplication(setting,keepAlive,showResult,ignoreCleanLock){await this.initializeDatabaseForReplication();if(keepAlive)this.openContinuousReplication(setting,showResult,false);else return this.openOneShotReplication(setting,showResult,false,"sync",ignoreCleanLock)}replicationActivated(showResult){this.syncStatus="CONNECTED";this.updateInfo();Logger("Replication activated",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"sync")}async replicationChangeDetected(e4,showResult,docSentOnStart,docArrivedOnStart){try{if("pull"==e4.direction){await this.env.$$parseReplicationResult(e4.change.docs);this.docArrived+=e4.change.docs.length}else this.docSent+=e4.change.docs.length;if(showResult){const maxPullSeq=this.maxPullSeq,maxPushSeq=this.maxPushSeq,lastSyncPullSeq=this.lastSyncPullSeq,lastSyncPushSeq=this.lastSyncPushSeq,pushLast=0==lastSyncPushSeq?"":lastSyncPushSeq>=maxPushSeq?" (LIVE)":` (${maxPushSeq-lastSyncPushSeq})`,pullLast=0==lastSyncPullSeq?"":lastSyncPullSeq>=maxPullSeq?" (LIVE)":` (${maxPullSeq-lastSyncPullSeq})`;Logger(`${this.docSent-docSentOnStart}${pushLast} ${this.docArrived-docArrivedOnStart}${pullLast}`,LOG_LEVEL_NOTICE,"sync")}this.updateInfo()}catch(ex){Logger("Replication callback error",LOG_LEVEL_NOTICE,"sync");Logger(ex,LOG_LEVEL_VERBOSE)}}replicationCompleted(showResult){this.syncStatus="COMPLETED";this.updateInfo();Logger("Replication completed",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,showResult?"sync":"");this.terminateSync()}replicationDenied(e4){this.syncStatus="ERRORED";this.updateInfo();this.terminateSync();Logger("Replication denied",LOG_LEVEL_NOTICE,"sync");Logger(e4,LOG_LEVEL_VERBOSE)}replicationErrored(e4){this.syncStatus="ERRORED";this.terminateSync();this.updateInfo();Logger("Replication error",LOG_LEVEL_NOTICE,"sync");Logger(e4,LOG_LEVEL_VERBOSE)}replicationPaused(){this.syncStatus="PAUSED";this.updateInfo();Logger("Replication paused",LOG_LEVEL_VERBOSE,"sync")}async processSync(syncHandler,showResult,docSentOnStart,docArrivedOnStart,syncMode,retrying,reportCancelledAsDone=true){const controller=new AbortController;if(this.controller)this.controller.abort();this.controller=controller;const gen=genReplication(syncHandler,controller.signal);try{for await(const[type,e4]of gen){const releaser=await globalConcurrencyController.tryAcquire(1,REPLICATION_BUSY_TIMEOUT);if(false===releaser){Logger("Replication stopped for busy.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"sync");return"FAILED"}releaser();switch(type){case"change":if("direction"in e4){if("pull"==e4.direction)this.lastSyncPullSeq=Number(`${e4.change.last_seq}`.split("-")[0]);else this.lastSyncPushSeq=Number(`${e4.change.last_seq}`.split("-")[0]);await this.replicationChangeDetected(e4,showResult,docSentOnStart,docArrivedOnStart)}else if("pullOnly"==syncMode){this.lastSyncPullSeq=Number(`${e4.last_seq}`.split("-")[0]);await this.replicationChangeDetected({direction:"pull",change:e4},showResult,docSentOnStart,docArrivedOnStart)}else if("pushOnly"==syncMode){this.lastSyncPushSeq=Number(`${e4.last_seq}`.split("-")[0]);this.updateInfo();await this.replicationChangeDetected({direction:"push",change:e4},showResult,docSentOnStart,docArrivedOnStart)}if(retrying)if(this.docSent-docSentOnStart+(this.docArrived-docArrivedOnStart)>2*this.originalSetting.batch_size)return"NEED_RESURRECT";break;case"complete":this.replicationCompleted(showResult);return"DONE";case"active":this.replicationActivated(showResult);break;case"denied":this.replicationDenied(e4);return"FAILED";case"error":this.replicationErrored(e4);Logger("Replication stopped.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"sync");if(this.env.$$getLastPostFailedBySize()){if(e4&&413==(null==e4?void 0:e4.status)){Logger("Something went wrong during synchronisation. Please check the log!",LOG_LEVEL_NOTICE);return"FAILED"}return"NEED_RETRY"}else{Logger("Replication error",LOG_LEVEL_NOTICE,"sync");Logger(e4)}return"FAILED";case"paused":this.replicationPaused();break;case"finally":break;default:Logger(`Unexpected synchronization status:${JSON.stringify(e4)}`)}}if(reportCancelledAsDone)return"DONE";else return"CANCELLED"}catch(ex){Logger("Unexpected synchronization exception");Logger(ex,LOG_LEVEL_VERBOSE);return"FAILED"}finally{this.terminateSync();this.controller=void 0}}getEmptyMaxEntry(remoteID){return{_id:`_local/max_seq_on_chunk-${remoteID}`,maxSeq:0,remoteID,seqStatusMap:{},_rev:void 0}}async getLastTransferredSeqOfChunks(localDB,remoteID){const prevMax={_id:`_local/max_seq_on_chunk-${remoteID}`,maxSeq:0,remoteID,seqStatusMap:{},_rev:void 0},previous_max_seq_on_chunk=await wrapException((()=>localDB.get(prevMax._id)));if(previous_max_seq_on_chunk instanceof Error)return prevMax;else return previous_max_seq_on_chunk}async updateMaxTransferredSeqOnChunks(localDB,remoteID,seqStatusMap){const newMax={_id:"_local/max_seq_on_chunk",maxSeq:0,remoteID,seqStatusMap,_rev:void 0},seqs=Object.keys(seqStatusMap).map((e4=>Number(e4)));let maxSeq=0;for(const seq of seqs){if(!seqStatusMap[seq])break;maxSeq=seq}Logger(`Updating max seq on chunk to ${maxSeq}`,LOG_LEVEL_VERBOSE);newMax.maxSeq=maxSeq;const previous_max_seq_on_chunk=await wrapException((()=>localDB.get(newMax._id)));if(previous_max_seq_on_chunk instanceof Error)delete newMax._rev;else{newMax._rev=previous_max_seq_on_chunk._rev;newMax.seqStatusMap={...previous_max_seq_on_chunk.seqStatusMap,...seqStatusMap}}await wrapException((()=>localDB.put(newMax)));return newMax}async sendChunks(setting,remoteDB,showResult,fromSeq){const trench=new Trench(this.env.$$getSimpleStore("sc-"),false);await trench.eraseAllEphemerals();if(!remoteDB){const d4=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"==typeof d4){Logger(`Could not connect to remote database: ${d4}`,showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"fetch");return false}remoteDB=d4.db}Logger("Bulk sending chunks to remote database...",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"fetch");const remoteMilestone=await remoteDB.get(MILESTONE_DOCID),remoteID=null==remoteMilestone?void 0:remoteMilestone.created,localDB=this.env.getDatabase(),te4=new TextEncoder;Logger("Looking for the point last synchronized point.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"fetch");this.syncStatus="CONNECTED";const prev=await this.getLastTransferredSeqOfChunks(localDB,remoteID),seq=null!=fromSeq?fromSeq:prev.maxSeq,localScannedDocs=[],sentMap={},diffChunks=localDB.changes({since:seq,live:false,include_docs:true,return_docs:false,selector:{type:"leaf"}}).on("change",(e4=>{const numSeq=Number(e4.seq);if(!prev.seqStatusMap[numSeq])localScannedDocs.push({id:e4.id,seq:Number(e4.seq)})}));await diffChunks;localScannedDocs.sort(((a2,b3)=>a2.seq-b3.seq));const idSeqMap=Object.fromEntries(localScannedDocs.map((e4=>[e4.id,e4.seq])));for(const checkDocs of arrayToChunkedArray(localScannedDocs,250)){const remoteDocs=await remoteDB.allDocs({keys:checkDocs.map((e4=>e4.id)),include_docs:false}),remoteDocMap=Object.fromEntries(remoteDocs.rows.map((e4=>[e4.key,"error"in e4?e4.error:e4.value]))),sendDocs=checkDocs.filter((e4=>"not_found"==remoteDocMap[e4.id])),sentDocs=checkDocs.filter((e4=>"not_found"!=remoteDocMap[e4.id]));sendDocs.forEach((e4=>sentMap[e4.seq]=false));sentDocs.forEach((e4=>sentMap[e4.seq]=true));const sendDocsMap=Object.fromEntries(sendDocs.map((e4=>[e4.id,e4.seq])));if(sendDocs.length>0){const localDocs=await localDB.allDocs({keys:sendDocs.map((e4=>e4.id)),include_docs:true});await trench.queue("send-chunks",localDocs.rows.filter((e4=>"id"in e4)).map((e4=>({seq:sendDocsMap[e4.id],doc:e4.doc,id:e4.id}))))}}let bulkDocs2=[],bulkDocsSizeBytes=0,bulkDocsSizeCount=0,maxSeq=0;const maxBatchSizeBytes=1024*setting.sendChunksBulkMaxSize*1024,semaphore=Semaphore(4);let sendingDocs=0,sentDocsCount=0;const sendChunks=async(bulkDocs3,bulkDocsSize,seq2)=>{Logger(`Sending ${bulkDocs3.length} (${bulkDocsSize} => ${sizeToHumanReadable2(bulkDocsSize)} in plain) chunks to remote database...`,LOG_LEVEL_VERBOSE);const releaser=await semaphore.acquire(1);sendingDocs+=bulkDocs3.length;Logger(` Uploading chunks \n${sendingDocs}/(${sentDocsCount} done)`,showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"send");try{const uploadBulkDocTasks=bulkDocs3.map((e4=>preprocessOutgoing(e4))),uploadBulkDocs=await Promise.all(uploadBulkDocTasks);await remoteDB.bulkDocs(uploadBulkDocs,{new_edits:false});uploadBulkDocs.forEach((e4=>sentMap[idSeqMap[e4._id]]=true));await this.updateMaxTransferredSeqOnChunks(localDB,remoteID,sentMap);sentDocsCount+=bulkDocs3.length;Logger(` Uploading chunks \n${sendingDocs}/(${sentDocsCount} done)`,showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"send")}catch(ex){Logger("Bulk sending failed.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"send");Logger(ex,LOG_LEVEL_VERBOSE);return false}finally{releaser()}return true},tasks4=[];for(;;){const nowSendChunks=await trench.dequeue("send-chunks");if(!nowSendChunks||0==nowSendChunks.length)break;for(const chunk of nowSendChunks){const jsonLength=te4.encode(JSON.stringify(chunk.doc)).byteLength+32;if((bulkDocsSizeBytes+jsonLength>maxBatchSizeBytes||bulkDocsSizeCount+1>200)&&bulkDocs2.length>0){tasks4.push(sendChunks([...bulkDocs2],bulkDocsSizeBytes));bulkDocs2=[];bulkDocsSizeBytes=0;bulkDocsSizeCount=0}bulkDocs2.push(chunk.doc);maxSeq=chunk.seq;bulkDocsSizeBytes+=jsonLength;bulkDocsSizeCount+=1}if(bulkDocs2.length>0)tasks4.push(sendChunks([...bulkDocs2],bulkDocsSizeBytes));if((await Promise.all(tasks4.map((async e4=>{try{await e4}catch(ex){Logger("Bulk sending failed.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"send");Logger(ex,LOG_LEVEL_VERBOSE);return false}})))).some((e4=>false===e4)))return false}return true}async openOneShotReplication(setting,showResult,retrying,syncMode,ignoreCleanLock=false){const next=await shareRunningResult("oneShotReplication",(async()=>{if(this.controller){Logger("Replication is already in progress.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"sync");return false}const localDB=this.env.getDatabase();Logger(`OneShot Sync begin... (${syncMode})`);const ret=await this.checkReplicationConnectivity(setting,false,retrying,showResult,ignoreCleanLock);if(false===ret){Logger("Could not connect to server.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"sync");return false}this.maxPullSeq=Number(`${ret.info.update_seq}`.split("-")[0]);this.maxPushSeq=Number(`${(await localDB.info()).update_seq}`.split("-")[0]);if(showResult)Logger("Looking for the point last synchronized point.",LOG_LEVEL_NOTICE,"sync");const{db,syncOptionBase}=ret;this.syncStatus="STARTED";this.updateInfo();const docArrivedOnStart=this.docArrived,docSentOnStart=this.docSent;if(!retrying)this.originalSetting=setting;this.terminateSync();const syncHandler="sync"==syncMode?localDB.sync(db,{...syncOptionBase}):"pullOnly"==syncMode?localDB.replicate.from(db,{...syncOptionBase,...setting.readChunksOnline?selectorOnDemandPull:{}}):"pushOnly"==syncMode?localDB.replicate.to(db,{...syncOptionBase}):void 0,syncResult=await this.processSync(syncHandler,showResult,docSentOnStart,docArrivedOnStart,syncMode,retrying,false);if("DONE"==syncResult)return true;if("CANCELLED"==syncResult)return false;if("FAILED"==syncResult)return false;if("NEED_RESURRECT"==syncResult){this.terminateSync();return async()=>await this.openOneShotReplication(this.originalSetting,showResult,false,syncMode,ignoreCleanLock)}if("NEED_RETRY"==syncResult){const tempSetting=JSON.parse(JSON.stringify(setting));tempSetting.batch_size=Math.ceil(tempSetting.batch_size/2)+2;tempSetting.batches_limit=Math.ceil(tempSetting.batches_limit/2)+2;if(tempSetting.batch_size<=5&&tempSetting.batches_limit<=5){Logger("We can't replicate more lower value.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO);return false}else{Logger(`Retry with lower batch size:${tempSetting.batch_size}/${tempSetting.batches_limit}`,showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO);return async()=>await this.openOneShotReplication(tempSetting,showResult,true,syncMode,ignoreCleanLock)}}return false}));if("boolean"==typeof next)return next;else return await next()}replicateAllToServer(setting,showingNotice){return this.openOneShotReplication(setting,null!=showingNotice?showingNotice:false,false,"pushOnly")}replicateAllFromServer(setting,showingNotice){return this.openOneShotReplication(setting,null!=showingNotice?showingNotice:false,false,"pullOnly")}async checkReplicationConnectivity(setting,keepAlive,skipCheck,showResult,ignoreCleanLock=false){if(""!=setting.versionUpFlash){Logger("Open settings and check message, please.",LOG_LEVEL_NOTICE);return false}const uri=setting.couchDB_URI+(""==setting.couchDB_DBNAME?"":"/"+setting.couchDB_DBNAME);if(this.controller){Logger("Another replication running.");return false}const dbRet=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"==typeof dbRet){Logger(`Could not connect to ${uri}: ${dbRet}`,showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO);return false}if(!skipCheck){if(!await checkRemoteVersion(dbRet.db,this.migrate.bind(this),VER)){Logger("Remote database is newer or corrupted, make sure to latest version of self-hosted-livesync installed",LOG_LEVEL_NOTICE);return false}this.remoteCleaned=false;this.remoteLocked=false;this.remoteLockedAndDeviceNotAccepted=false;this.tweakSettingsMismatched=false;this.preferredTweakValue=void 0;const ensure=await ensureDatabaseIsCompatible(dbRet.db,setting,this.nodeid,currentVersionRange2);if("INCOMPATIBLE"==ensure){Logger("The remote database has no compatibility with the running version. Please upgrade the plugin.",LOG_LEVEL_NOTICE);return false}else if("NODE_LOCKED"==ensure){Logger("The remote database has been rebuilt or corrupted since we have synchronized last time. Fetch rebuilt DB, explicit unlocking or chunk clean-up is required.",LOG_LEVEL_NOTICE);this.remoteLockedAndDeviceNotAccepted=true;this.remoteLocked=true;return false}else if("LOCKED"==ensure)this.remoteLocked=true;else if("NODE_CLEANED"==ensure)if(ignoreCleanLock)this.remoteLocked=true;else{Logger("The remote database has been cleaned up. Fetch rebuilt DB, explicit unlocking or chunk clean-up is required.",LOG_LEVEL_NOTICE);this.remoteLockedAndDeviceNotAccepted=true;this.remoteLocked=true;this.remoteCleaned=true;return false}else if("OK"==ensure);else if("MISMATCHED"==ensure[0]){Logger("Configuration mismatching between the clients has been detected. This can be harmful or extra capacity consumption. We have to make these value unified.",LOG_LEVEL_NOTICE);this.tweakSettingsMismatched=true;this.preferredTweakValue=ensure[1];return false}}const syncOptionBase={batches_limit:setting.batches_limit,batch_size:setting.batch_size,push:{}};if(setting.readChunksOnline)syncOptionBase.pull={...selectorOnDemandPull};const syncOption=keepAlive?{live:true,retry:true,heartbeat:setting.useTimeouts?false:3e4,...syncOptionBase}:{...syncOptionBase};return{db:dbRet.db,info:dbRet.info,syncOptionBase,syncOption}}async openContinuousReplication(setting,showResult,retrying){const next=await shareRunningResult("continuousReplication",(async()=>{if(this.controller){Logger("Replication is already in progress.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO);return false}const localDB=this.env.getDatabase();Logger("Before LiveSync, start OneShot once...");if(await this.openOneShotReplication(setting,showResult,false,"pullOnly")){Logger("LiveSync begin...");const ret=await this.checkReplicationConnectivity(setting,true,true,showResult);if(false===ret){Logger("Could not connect to server.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO);return false}if(showResult)Logger("Looking for the point last synchronized point.",LOG_LEVEL_NOTICE,"sync");const{db,syncOption}=ret;this.syncStatus="STARTED";this.maxPullSeq=Number(`${ret.info.update_seq}`.split("-")[0]);this.maxPushSeq=Number(`${(await localDB.info()).update_seq}`.split("-")[0]);this.updateInfo();const docArrivedOnStart=this.docArrived,docSentOnStart=this.docSent;if(!retrying)this.originalSetting=setting;this.terminateSync();const syncHandler=localDB.sync(db,{...syncOption}),syncMode="sync",syncResult=await this.processSync(syncHandler,showResult,docSentOnStart,docArrivedOnStart,syncMode,retrying);if("DONE"==syncResult)return true;if("FAILED"==syncResult)return false;if("NEED_RESURRECT"==syncResult){this.terminateSync();return async()=>await this.openContinuousReplication(this.originalSetting,showResult,false)}if("NEED_RETRY"==syncResult){const tempSetting=JSON.parse(JSON.stringify(setting));tempSetting.batch_size=Math.ceil(tempSetting.batch_size/2)+2;tempSetting.batches_limit=Math.ceil(tempSetting.batches_limit/2)+2;if(tempSetting.batch_size<=5&&tempSetting.batches_limit<=5){Logger("We can't replicate more lower value.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO);return false}else{Logger(`Retry with lower batch size:${tempSetting.batch_size}/${tempSetting.batches_limit}`,showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO);return async()=>await this.openContinuousReplication(tempSetting,showResult,true)}}}return false}));if("boolean"==typeof next)return next;else return await next()}closeReplication(){if(this.controller){this.controller.abort();this.controller=void 0;this.syncStatus="CLOSED";Logger("Replication closed");this.updateInfo()}}async tryResetRemoteDatabase(setting){this.closeReplication();const con=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"!=typeof con)try{await con.db.destroy();Logger("Remote Database Destroyed",LOG_LEVEL_NOTICE);await this.tryCreateRemoteDatabase(setting)}catch(ex){Logger("Something happened on Remote Database Destroy:",LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_NOTICE)}}async tryCreateRemoteDatabase(setting){this.closeReplication();if("string"!=typeof await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true))Logger("Remote Database Created or Connected",LOG_LEVEL_NOTICE)}async markRemoteLocked(setting,locked,lockByClean){const uri=setting.couchDB_URI+(""==setting.couchDB_DBNAME?"":"/"+setting.couchDB_DBNAME),dbRet=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"==typeof dbRet){Logger(`could not connect to ${uri}:${dbRet}`,LOG_LEVEL_NOTICE);return}if(!await checkRemoteVersion(dbRet.db,this.migrate.bind(this),VER)){Logger("Remote database is newer or corrupted, make sure to latest version of self-hosted-livesync installed",LOG_LEVEL_NOTICE);return}const defInitPoint={_id:MILESTONE_DOCID,type:"milestoneinfo",created:new Date/1,locked,cleaned:lockByClean,accepted_nodes:[this.nodeid],node_chunk_info:{[this.nodeid]:currentVersionRange2},tweak_values:{}},remoteMilestone={...defInitPoint,...await resolveWithIgnoreKnownError(dbRet.db.get(MILESTONE_DOCID),defInitPoint)};remoteMilestone.node_chunk_info={...defInitPoint.node_chunk_info,...remoteMilestone.node_chunk_info};remoteMilestone.accepted_nodes=[this.nodeid];remoteMilestone.locked=locked;remoteMilestone.cleaned=remoteMilestone.cleaned||lockByClean;if(locked)Logger("Lock remote database to prevent data corruption",LOG_LEVEL_NOTICE);else Logger("Unlock remote database to prevent data corruption",LOG_LEVEL_NOTICE);await dbRet.db.put(remoteMilestone)}async markRemoteResolved(setting){const uri=setting.couchDB_URI+(""==setting.couchDB_DBNAME?"":"/"+setting.couchDB_DBNAME),dbRet=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"==typeof dbRet){Logger(`could not connect to ${uri}:${dbRet}`,LOG_LEVEL_NOTICE);return}if(!await checkRemoteVersion(dbRet.db,this.migrate.bind(this),VER)){Logger("Remote database is newer or corrupted, make sure to latest version of self-hosted-livesync installed",LOG_LEVEL_NOTICE);return}const defInitPoint={_id:MILESTONE_DOCID,type:"milestoneinfo",created:new Date/1,locked:false,accepted_nodes:[this.nodeid],node_chunk_info:{[this.nodeid]:currentVersionRange2},tweak_values:{}},remoteMilestone={...defInitPoint,...await resolveWithIgnoreKnownError(dbRet.db.get(MILESTONE_DOCID),defInitPoint)};remoteMilestone.node_chunk_info={...defInitPoint.node_chunk_info,...remoteMilestone.node_chunk_info};remoteMilestone.accepted_nodes=Array.from(new Set([...remoteMilestone.accepted_nodes,this.nodeid]));Logger("Mark this device as 'resolved'.",LOG_LEVEL_NOTICE);if((await dbRet.db.put(remoteMilestone)).ok)Logger("Remote database has been marked resolved.",LOG_LEVEL_VERBOSE);else Logger("Could not mark resolve remote database.",LOG_LEVEL_NOTICE)}connectRemoteCouchDBWithSetting(settings,isMobile,performSetup=false,skipInfo=false){if(settings.encrypt&&""==settings.passphrase&&!settings.permitEmptyPassphrase)return"Empty passphrases cannot be used without explicit permission";else return this.env.$$connectRemoteCouchDB(settings.couchDB_URI+(""==settings.couchDB_DBNAME?"":"/"+settings.couchDB_DBNAME),{username:settings.couchDB_USER,password:settings.couchDB_PASSWORD},settings.disableRequestURI||isMobile,settings.encrypt?settings.passphrase:settings.encrypt,settings.useDynamicIterationCount,performSetup,skipInfo,settings.enableCompression)}async fetchRemoteChunks(missingChunks,showResult){const ret=await this.connectRemoteCouchDBWithSetting(this.env.getSettings(),this.env.$$isMobile(),false,true);if("string"==typeof ret){Logger(`Could not connect to server.${ret} `,showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"fetch");return false}const remoteChunks=await ret.db.allDocs({keys:missingChunks,include_docs:true});if(remoteChunks.rows.some((e4=>"error"in e4))){Logger("Some chunks are not exists both on remote and local database.",showResult?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"fetch");Logger(`Missing chunks: ${missingChunks.join(",")}`,LOG_LEVEL_VERBOSE);Logger(`Error chunks: ${remoteChunks.rows.filter((e4=>"error"in e4)).map((e4=>e4.key)).join(",")}`,LOG_LEVEL_VERBOSE);return false}return remoteChunks.rows.map((e4=>e4.doc))}async tryConnectRemote(setting,showResult=true){const db=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"==typeof db){Logger(`ERROR!: could not connect to ${setting.couchDB_URI} : ${setting.couchDB_DBNAME} \n(${db})`,LOG_LEVEL_NOTICE);return false}Logger(`Connected to ${db.info.db_name} successfully`,LOG_LEVEL_NOTICE);return true}async resetRemoteTweakSettings(setting){const uri=setting.couchDB_URI+(""==setting.couchDB_DBNAME?"":"/"+setting.couchDB_DBNAME),dbRet=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"!=typeof dbRet)if(await checkRemoteVersion(dbRet.db,this.migrate.bind(this),VER))try{const remoteMilestone=await dbRet.db.get(MILESTONE_DOCID);remoteMilestone.tweak_values={};await dbRet.db.put(remoteMilestone);Logger("tweak values on the remote database have been cleared",LOG_LEVEL_VERBOSE)}catch(ex){Logger("Could not retrieve remote milestone",LOG_LEVEL_NOTICE);throw ex}else Logger("Remote database is newer or corrupted, make sure to latest version of self-hosted-livesync installed",LOG_LEVEL_NOTICE);else Logger(`could not connect to ${uri}:${dbRet}`,LOG_LEVEL_NOTICE)}async setPreferredRemoteTweakSettings(setting){const uri=setting.couchDB_URI+(""==setting.couchDB_DBNAME?"":"/"+setting.couchDB_DBNAME),dbRet=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"!=typeof dbRet)if(await checkRemoteVersion(dbRet.db,this.migrate.bind(this),VER))try{const remoteMilestone=await dbRet.db.get(MILESTONE_DOCID);remoteMilestone.tweak_values[DEVICE_ID_PREFERRED]=extractObject(TweakValuesTemplate,{...setting});await dbRet.db.put(remoteMilestone);Logger("Preferred tweak values has been registered",LOG_LEVEL_VERBOSE)}catch(ex){Logger("Could not retrieve remote milestone",LOG_LEVEL_NOTICE);throw ex}else Logger("Remote database is newer or corrupted, make sure to latest version of self-hosted-livesync installed",LOG_LEVEL_NOTICE);else Logger(`could not connect to ${uri}:${dbRet}`,LOG_LEVEL_NOTICE)}async getRemotePreferredTweakValues(setting){const uri=setting.couchDB_URI+(""==setting.couchDB_DBNAME?"":"/"+setting.couchDB_DBNAME),dbRet=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"==typeof dbRet){Logger(`could not connect to ${uri}:${dbRet}`,LOG_LEVEL_NOTICE);return false}if(!await checkRemoteVersion(dbRet.db,this.migrate.bind(this),VER)){Logger("Remote database is newer or corrupted, make sure to latest version of self-hosted-livesync installed",LOG_LEVEL_NOTICE);return false}try{return(await dbRet.db.get(MILESTONE_DOCID)).tweak_values[DEVICE_ID_PREFERRED]}catch(ex){Logger("Could not retrieve remote milestone",LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE);return false}}async compactRemote(setting){const uri=setting.couchDB_URI+(""==setting.couchDB_DBNAME?"":"/"+setting.couchDB_DBNAME),dbRet=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"==typeof dbRet){Logger(`could not connect to ${uri}:${dbRet}`,LOG_LEVEL_NOTICE);return false}return(await dbRet.db.compact({interval:1e3})).ok}async getRemoteStatus(setting){var _a5;const dbRet=await this.connectRemoteCouchDBWithSetting(setting,this.env.$$isMobile(),true);if("string"==typeof dbRet){Logger(`could not connect to ${setting.couchDB_URI+(""==setting.couchDB_DBNAME?"":"/"+setting.couchDB_DBNAME)}:${dbRet}`,LOG_LEVEL_NOTICE);return false}const info3=await dbRet.db.info();return{...info3,estimatedSize:(null==(_a5=null==info3?void 0:info3.sizes)?void 0:_a5.file)||0}}},ObsHttpHandler=class extends FetchHttpHandler{constructor(options,reverseProxyNoSignUrl){super(options);this.requestTimeoutInMs=void 0===options?void 0:options.requestTimeout;this.reverseProxyNoSignUrl=reverseProxyNoSignUrl}async handle(request2,{abortSignal}={}){if(null==abortSignal?void 0:abortSignal.aborted){const abortError=new Error("Request aborted");abortError.name="AbortError";return Promise.reject(abortError)}let path2=request2.path;if(request2.query){const queryString=buildQueryString(request2.query);if(queryString)path2+=`?${queryString}`}const{port,method}=request2;let url=`${request2.protocol}//${request2.hostname}${port?`:${port}`:""}${path2}`;if(void 0!==this.reverseProxyNoSignUrl&&""!==this.reverseProxyNoSignUrl){const urlObj=new URL(url);urlObj.host=this.reverseProxyNoSignUrl;url=urlObj.href}const body="GET"===method||"HEAD"===method?void 0:request2.body,transformedHeaders={};for(const key2 of Object.keys(request2.headers)){const keyLower=key2.toLowerCase();if("host"!==keyLower&&"content-length"!==keyLower)transformedHeaders[keyLower]=request2.headers[key2]}let contentType;if(void 0!==transformedHeaders["content-type"])contentType=transformedHeaders["content-type"];let transformedBody=body;if(ArrayBuffer.isView(body))transformedBody=new Uint8Array(body.buffer).buffer;const param={body:transformedBody,headers:transformedHeaders,method,url,contentType},raceOfPromises=[(0,import_obsidian.requestUrl)(param).then((rsp=>{const headers=rsp.headers,headersLower={};for(const key2 of Object.keys(headers))headersLower[key2.toLowerCase()]=headers[key2];const stream=new ReadableStream({start(controller){controller.enqueue(new Uint8Array(rsp.arrayBuffer));controller.close()}});return{response:new HttpResponse({headers:headersLower,statusCode:rsp.status,body:stream})}})),requestTimeout(this.requestTimeoutInMs)];if(abortSignal)raceOfPromises.push(new Promise(((resolve,reject)=>{abortSignal.onabort=()=>{const abortError=new Error("Request aborted");abortError.name="AbortError";reject(abortError)}})));return Promise.race(raceOfPromises)}},LANG_DE="de",LANG_JA="ja",LANG_RU="ru",LANG_ZH="zh",LANG_ZH_TW="zh-tw",SUPPORTED_I18N_LANGS=[LANG_DE,LANG_JA,LANG_RU,LANG_ZH,LANG_ZH_TW],allMessages={"Self-hosted LiveSync has undergone a major upgrade. Please open the setting dialog, and check the information pane.":{ja:"Self-hosted LiveSyncInformation pane",zh:"Self-hosted LiveSync "},"lang-de":{def:"Deutsche"},"lang-ja":{def:""},"lang-ru":{def:""},"lang-zh":{def:""},"lang-zh-tw":{def:""},"Self-hosted LiveSync":{zh:" LiveSync"},"Remote Type":{zh:""},"Remote server type":{zh:""},"Endpoint URL":{zh:""},"Access Key":{zh:"ID"},"Secret Key":{zh:""},Region:{zh:""},"Bucket Name":{zh:""},"Use Custom HTTP Handler":{zh:"HTTP"},"If your Object Storage could not configured accepting CORS, enable this.":{zh:"CORS"},URI:{zh:"URI"},Username:{zh:""},username:{zh:""},Password:{zh:""},password:{zh:""},"Database name":{zh:""},"Incubate Chunks in Document":{zh:""},"If enabled, newly created chunks are temporarily kept within the document, and graduated to become independent chunks once stabilised.":{zh:""},"Maximum Incubating Chunks":{zh:""},"The maximum number of chunks that can be incubated within the document. Chunks exceeding this number will immediately graduate to independent chunks.":{zh:""},"Maximum Incubating Chunk Size":{zh:""},"The maximum total size of chunks that can be incubated within the document. Chunks exceeding this size will immediately graduate to independent chunks.":{zh:""},"Maximum Incubation Period":{zh:""},"The maximum duration for which chunks can be incubated within the document. Chunks exceeding this period will graduate to independent chunks.":{zh:""},"Data Compression":{zh:""},"End-to-End Encryption":{zh:""},"Encrypt contents on the remote database. If you use the plugin's synchronization feature, enabling this is recommended.":{zh:""},Passphrase:{zh:""},"Encrypting passphrase. If you change the passphrase of an existing database, overwriting the remote database is strongly recommended.":{zh:""},"Path Obfuscation":{zh:""},"Use dynamic iteration count":{zh:""},"Display Language":{zh:""},'Not all messages have been translated. And, please revert to "Default" when reporting errors.':{ja:'Issue"Default"',zh:'"Default"'},"Show status inside the editor":{zh:""},"Reflected after reboot":{zh:""},"Show status as icons only":{zh:""},"Show status on the status bar":{zh:""},"Reflected after reboot.":{zh:""},"Show only notifications":{zh:""},"Prevent logging and show only notification":{zh:""},"Verbose Log":{zh:""},"Show verbose log":{zh:""},"Memory cache size (by total items)":{zh:""},"Memory cache size (by total characters)":{zh:""},"(Mega chars)":{zh:""},Filename:{zh:""},"If you set this, all settings are saved in a markdown file. You will be notified when new settings arrive. You can set different files by the platform.":{zh:"Markdown"},"Write credentials in the file":{zh:""},"(Not recommended) If set, credentials will be stored in the file.":{zh:""},"Notify all setting files":{zh:""},"Encrypting sensitive configuration items":{zh:""},"Passphrase of sensitive configuration items":{zh:""},"This passphrase will not be copied to another device. It will be set to `Default` until you configure it again.":{zh:"`Default`"},Presets:{zh:""},"Apply preset configuration":{zh:""},"Sync Mode":{zh:""},"Periodic Sync interval":{zh:""},"Interval (sec)":{zh:""},"Sync on Save":{zh:""},"When you save a file, sync automatically":{zh:""},"Sync on Editor Save":{zh:""},"When you save a file in the editor, sync automatically":{zh:""},"Sync on File Open":{zh:""},"When you open a file, sync automatically":{zh:""},"Sync on Start":{zh:""},"Start synchronization after launching Obsidian.":{zh:"Obsidian"},"Sync after merging file":{zh:""},"Sync automatically after merging files":{zh:""},"Use the trash bin":{zh:""},"Do not delete files that are deleted in remote, just move to trash.":{zh:""},"Keep empty folder":{zh:""},"Normally, a folder is deleted when it becomes empty after a synchronization. Enabling this will prevent it from getting deleted":{zh:""},"Always overwrite with a newer file (beta)":{zh:""},"(Def off) Resolve conflicts by newer files automatically.":{zh:""},"Postpone resolution of inactive files":{zh:""},"Postpone manual resolution of inactive files":{zh:""},"Always resolve conflicts manually":{zh:""},"If this switch is turned on, a merge dialog will be displayed, even if the sensible-merge is possible automatically. (Turn on to previous behavior)":{zh:""},"Always reflect synchronized changes even if the note has a conflict":{zh:""},"Turn on to previous behavior":{zh:""},"Scan for hidden files before replication":{zh:""},"Scan hidden files periodically":{zh:""},"Seconds, 0 to disable":{zh:"0"},"Batch database update":{zh:""},"Reducing the frequency with which on-disk changes are reflected into the DB":{zh:""},"Enhance chunk size":{zh:""},"Fetch chunks on demand":{zh:""},"(ex. Read chunks online) If this option is enabled, LiveSync reads chunks online directly instead of replicating them locally. Increasing Custom chunk size is recommended.":{zh:"LiveSync"},"Maximum file size":{zh:""},"(MB) If this is set, changes to local and remote files that are larger than this will be skipped. If the file becomes smaller again, a newer one will be used.":{zh:"MB"},"(Beta) Use ignore files":{zh:""},"If this is set, changes to local files which are matched by the ignore files will be skipped. Remote changes are determined using local ignore files.":{zh:""},"Ignore files":{zh:""},"We can use multiple ignore files, e.g.) `.gitignore, .dockerignore`":{zh:"`.gitignore, .dockerignore`"},"Batch size":{zh:""},"Number of change feed items to process at a time. Defaults to 50. Minimum is 2.":{zh:"502"},"Batch limit":{zh:""},"Number of batches to process at a time. Defaults to 40. Minimum is 2. This along with batch size controls how many docs are kept in memory at a time.":{zh:"402"},"Use timeouts instead of heartbeats":{zh:""},"If this option is enabled, PouchDB will hold the connection open for 60 seconds, and if no change arrives in that time, close and reopen the socket, instead of holding it open indefinitely. Useful when a proxy limits request duration but can increase resource usage.":{zh:"PouchDB60"},"Batch size of on-demand fetching":{zh:""},"The delay for consecutive on-demand fetches":{zh:""},"Suspend file watching":{zh:""},"Stop watching for file change.":{zh:""},"Suspend database reflecting":{zh:""},"Stop reflecting database changes to storage files.":{zh:""},"Write logs into the file":{zh:""},"Warning! This will have a serious impact on performance. And the logs will not be synchronised under the default name. Please be careful with logs; they often contain your confidential information.":{zh:""},"Do not keep metadata of deleted files.":{zh:""},"Delete old metadata of deleted files on start-up":{zh:""},"(Days passed, 0 to disable automatic-deletion)":{zh:"0"},"Use an old adapter for compatibility":{zh:""},"Before v0.17.16, we used an old adapter for the local database. Now the new adapter is preferred. However, it needs local database rebuilding. Please disable this toggle when you have enough time. If leave it enabled, also while fetching from the remote database, you will be asked to disable this.":{zh:"v0.17.16"},"Scan changes on customization sync":{zh:""},"Do not use internal API":{zh:"API"},"Database suffix":{zh:""},"LiveSync could not handle multiple vaults which have same name without different prefix, This should be automatically configured.":{zh:"LiveSync"},"The Hash algorithm for chunk IDs":{zh:"ID"},"Fetch database with previous behaviour":{zh:""},"Do not check configuration mismatch before replication":{zh:""},"Device name":{zh:""},"Unique name between all synchronized devices. To edit this setting, please disable customization sync once.":{zh:""},"Enable customization sync":{zh:""},"Scan customization automatically":{zh:""},"Scan customization before replicating.":{zh:""},"Scan customization periodically":{zh:""},"Scan customization every 1 minute.":{zh:"1"},"Notify customized":{zh:""},"Notify when other device has newly customized.":{zh:""},"Waiting for ready...":{zh:"..."}},currentLang="",missingTranslations=[];function __getMissingTranslations(){return missingTranslations}var __onMissingTranslations=key2=>console.warn(key2);function __onMissingTranslation(callback){__onMissingTranslations=callback}var plugin,msgCache=new Map;function setLang(lang){if(lang!=currentLang){currentLang=lang;msgCache.clear()}}function _getMessage(key2,lang){var _a5,_b2,_c2;if(""==key2.trim())return key2;const msgs=null!=(_a5=allMessages[key2])?_a5:void 0;if(""==lang)lang="def";let msg=null!=(_b2=null==msgs?void 0:msgs[lang])?_b2:void 0;if(!msg)msg=null!=(_c2=null==msgs?void 0:msgs.def)?_c2:void 0;if(!msg){if(!missingTranslations.contains(key2)){__onMissingTranslations(key2);missingTranslations.push(key2)}return key2}return msg}function getMessage(key2){if(msgCache.has(key2))return msgCache.get(key2);const msg=_getMessage(key2,currentLang);msgCache.set(key2,msg);return msg}function $t(message,lang){if(void 0!==lang)return _getMessage(message,lang);else return getMessage(message)}function $f(strings,...values){let result="";for(let i2=0;i2<values.length;i2++)result+=getMessage(strings[i2])+values[i2];result+=getMessage(strings[strings.length-1]);return result}function enableTestFunction(plugin_){plugin=plugin_}function addDebugFileLog(message,stackLog=false){fireAndForget(serialized("debug-log",(async()=>{const now2=new Date,outFile=`debug-log${now2.toISOString().split("T")[0]}.jsonl`;let out={timestamp:now2.toLocaleString(),epoch:now2};if(message instanceof Error)out={...out,message};else if(stackLog)if(stackLog){const stack=(new Error).stack;out={...out,stack}}if("object"==typeof message)out={...out,...message};else out={result:message};try{await plugin.storageAccess.appendHiddenFile(plugin.app.vault.configDir+"/ls-debug/"+outFile,JSON.stringify(out)+"\n")}catch(e4){}})))}var measures=new Map;function clearResult(name){measures.set(name,[0,0])}async function measureEach(name,proc){var _a5;const[times,spent]=null!=(_a5=measures.get(name))?_a5:[0,0],start=performance.now(),result=proc();if(result instanceof Promise)await result;const end=performance.now();measures.set(name,[times+1,spent+(end-start)])}function formatNumber(num){return num.toLocaleString("en-US",{maximumFractionDigits:2})}async function measure(name,proc,times=1e4,duration=1e3){const from=Date.now();let last=times;clearResult(name);do{await measureEach(name,proc)}while(last-- >0&&Date.now()-from<duration);return[name,measures.get(name)]}async function formatPerfResults(items){return"| Name | Runs | Each | Total |\n| --- | --- | --- | --- | \n"+items.map((e4=>`| ${e4[0]} | ${e4[1][0]} | ${0!=e4[1][0]?formatNumber(e4[1][1]/e4[1][0]):"-"} | ${formatNumber(e4[1][0])} |`)).join("\n")}async function perf_trench(plugin3){clearResult("trench");const trench=new Trench(plugin3.simpleStore),result=[];result.push(await measure("trench-short-string",(async()=>{const p2=trench.evacuate("string");await p2()})));{const testBinary=await plugin3.storageAccess.readHiddenFileBinary("testdata/10kb.png"),uint8Array=new Uint8Array(testBinary);result.push(await measure("trench-binary-10kb",(async()=>{const p2=trench.evacuate(uint8Array);await p2()})))}{const testBinary=await plugin3.storageAccess.readHiddenFileBinary("testdata/100kb.jpeg"),uint8Array=new Uint8Array(testBinary);result.push(await measure("trench-binary-100kb",(async()=>{const p2=trench.evacuate(uint8Array);await p2()})))}{const testBinary=await plugin3.storageAccess.readHiddenFileBinary("testdata/1mb.png"),uint8Array=new Uint8Array(testBinary);result.push(await measure("trench-binary-1mb",(async()=>{const p2=trench.evacuate(uint8Array);await p2()})))}return formatPerfResults(result)}function add_css5(target){append_styles(target,"svelte-qc8xos",".svelte-qc8xos{box-sizing:border-box}")}function get_each_context5(ctx,list,i2){const child_ctx=ctx.slice();child_ctx[24]=list[i2][0];child_ctx[25]=list[i2][1];child_ctx[26]=list[i2][2];return child_ctx}function create_each_block5(ctx){let details,summary,t0,t1,t22,t32,t4,pre,t5,details_open_value,t1_value=ctx[24]?"PASS":"FAILED",t3_value=ctx[25]+"",t5_value=ctx[26]+"";return{c(){details=element("details");summary=element("summary");t0=text("[");t1=text(t1_value);t22=text("] ");t32=text(t3_value);t4=space();pre=element("pre");t5=text(t5_value);attr(summary,"class","svelte-qc8xos");attr(pre,"class","svelte-qc8xos");details.open=details_open_value=!ctx[24];attr(details,"class","svelte-qc8xos")},m(target,anchor){insert(target,details,anchor);append(details,summary);append(summary,t0);append(summary,t1);append(summary,t22);append(summary,t32);append(details,t4);append(details,pre);append(pre,t5)},p(ctx2,dirty){if(16&dirty&&t1_value!==(t1_value=ctx2[24]?"PASS":"FAILED"))set_data(t1,t1_value);if(16&dirty&&t3_value!==(t3_value=ctx2[25]+""))set_data(t32,t3_value);if(16&dirty&&t5_value!==(t5_value=ctx2[26]+""))set_data(t5,t5_value);if(16&dirty&&details_open_value!==(details_open_value=!ctx2[24]))details.open=details_open_value},d(detaching){if(detaching)detach(details)}}}function create_fragment5(ctx){let h22,t1,h30,t32,button0,t4,t5,button1,t6,t7,button2,t8,t9,button3,t11,t12,h31,t14,pre,t15,t16,h32,t18,button4,t19,t20,button5,t22,div,mounted,dispose,t15_value=ctx[3].join("\n")+"",each_value=ensure_array_like(ctx[4]),each_blocks=[];for(let i2=0;i2<each_value.length;i2+=1)each_blocks[i2]=create_each_block5(get_each_context5(ctx,each_value,i2));return{c(){h22=element("h2");h22.textContent="TESTING BENCH: Self-hosted LiveSync";t1=space();h30=element("h3");h30.textContent="Module Checks";t32=space();button0=element("button");t4=text("MultiDevice Test");t5=space();button1=element("button");t6=text("SingleDevice Test");t7=space();button2=element("button");t8=text("All Test");t9=space();button3=element("button");button3.textContent="Clear";t11=space();for(let i2=0;i2<each_blocks.length;i2+=1)each_blocks[i2].c();t12=space();h31=element("h3");h31.textContent="Synchronisation Result Status";t14=space();pre=element("pre");t15=text(t15_value);t16=space();h32=element("h3");h32.textContent="Performance test";t18=space();button4=element("button");t19=text("Test!");t20=space();button5=element("button");button5.textContent="Clear";t22=space();div=element("div");attr(h22,"class","svelte-qc8xos");attr(h30,"class","svelte-qc8xos");button0.disabled=ctx[2];attr(button0,"class","svelte-qc8xos");button1.disabled=ctx[2];attr(button1,"class","svelte-qc8xos");button2.disabled=ctx[2];attr(button2,"class","svelte-qc8xos");attr(button3,"class","svelte-qc8xos");attr(h31,"class","svelte-qc8xos");attr(pre,"class","svelte-qc8xos");attr(h32,"class","svelte-qc8xos");button4.disabled=ctx[1];attr(button4,"class","svelte-qc8xos");attr(button5,"class","svelte-qc8xos");attr(div,"class","svelte-qc8xos")},m(target,anchor){insert(target,h22,anchor);insert(target,t1,anchor);insert(target,h30,anchor);insert(target,t32,anchor);insert(target,button0,anchor);append(button0,t4);insert(target,t5,anchor);insert(target,button1,anchor);append(button1,t6);insert(target,t7,anchor);insert(target,button2,anchor);append(button2,t8);insert(target,t9,anchor);insert(target,button3,anchor);insert(target,t11,anchor);for(let i2=0;i2<each_blocks.length;i2+=1)if(each_blocks[i2])each_blocks[i2].m(target,anchor);insert(target,t12,anchor);insert(target,h31,anchor);insert(target,t14,anchor);insert(target,pre,anchor);append(pre,t15);insert(target,t16,anchor);insert(target,h32,anchor);insert(target,t18,anchor);insert(target,button4,anchor);append(button4,t19);insert(target,t20,anchor);insert(target,button5,anchor);insert(target,t22,anchor);insert(target,div,anchor);ctx[23](div);if(!mounted){dispose=[listen(button0,"click",ctx[17]),listen(button1,"click",ctx[18]),listen(button2,"click",ctx[19]),listen(button3,"click",ctx[20]),listen(button4,"click",ctx[21]),listen(button5,"click",ctx[22])];mounted=true}},p(ctx2,[dirty]){if(4&dirty)button0.disabled=ctx2[2];if(4&dirty)button1.disabled=ctx2[2];if(4&dirty)button2.disabled=ctx2[2];if(16&dirty){each_value=ensure_array_like(ctx2[4]);let i2;for(i2=0;i2<each_value.length;i2+=1){const child_ctx=get_each_context5(ctx2,each_value,i2);if(each_blocks[i2])each_blocks[i2].p(child_ctx,dirty);else{each_blocks[i2]=create_each_block5(child_ctx);each_blocks[i2].c();each_blocks[i2].m(t12.parentNode,t12)}}for(;i2<each_blocks.length;i2+=1)each_blocks[i2].d(1);each_blocks.length=each_value.length}if(8&dirty&&t15_value!==(t15_value=ctx2[3].join("\n")+""))set_data(t15,t15_value);if(2&dirty)button4.disabled=ctx2[1]},i:noop2,o:noop2,d(detaching){if(detaching){detach(h22);detach(t1);detach(h30);detach(t32);detach(button0);detach(t5);detach(button1);detach(t7);detach(button2);detach(t9);detach(button3);detach(t11);detach(t12);detach(h31);detach(t14);detach(pre);detach(t16);detach(h32);detach(t18);detach(button4);detach(t20);detach(button5);detach(t22);detach(div)}destroy_each(each_blocks,detaching);ctx[23](null);mounted=false;run_all(dispose)}}}var functionCheckResult="";function instance5($$self,$$props,$$invalidate){let resultLines,$results,prefTestResultEl,{plugin:plugin3}=$$props,{moduleDev}=$$props,performanceTestResult="",testRunning=false,isReady=false;async function performTest(){try{$$invalidate(1,testRunning=true);$$invalidate(14,performanceTestResult=await perf_trench(plugin3))}finally{$$invalidate(1,testRunning=false)}}function clearResult2(){moduleDev.testResults.update((v2=>[]))}function clearPerfTestResult(){prefTestResultEl.empty()}onMount((async()=>{$$invalidate(15,isReady=true);eventHub.onceEvent(EVENT_LAYOUT_READY,(async()=>{if(await plugin3.storageAccess.isExistsIncludeHidden("_AUTO_TEST.md")){new import_obsidian.Notice("Auto test file found, running tests...");fireAndForget((async()=>{await allTest()}))}}))}));let moduleTesting=false;function moduleMultiDeviceTest(){if(!moduleTesting){$$invalidate(2,moduleTesting=true);plugin3.$everyModuleTestMultiDevice().finally((()=>{$$invalidate(2,moduleTesting=false)}))}}function moduleSingleDeviceTest(){if(!moduleTesting){$$invalidate(2,moduleTesting=true);plugin3.$everyModuleTest().finally((()=>{$$invalidate(2,moduleTesting=false)}))}}async function allTest(){if(!moduleTesting){$$invalidate(2,moduleTesting=true);try{await plugin3.$everyModuleTest();await plugin3.$everyModuleTestMultiDevice()}finally{$$invalidate(2,moduleTesting=false)}}}const results=moduleDev.testResults;component_subscribe($$self,results,(value=>$$invalidate(16,$results=value)));let syncStatus=[];eventHub.onEvent("debug-sync-status",(status=>{$$invalidate(3,syncStatus=[...status])}));$$self.$$set=$$props2=>{if("plugin"in $$props2)$$invalidate(12,plugin3=$$props2.plugin);if("moduleDev"in $$props2)$$invalidate(13,moduleDev=$$props2.moduleDev)};$$self.$$.update=()=>{if(53249&$$self.$$.dirty)if(""!=performanceTestResult&&isReady)import_obsidian.MarkdownRenderer.render(plugin3.app,performanceTestResult,prefTestResultEl,"/",plugin3);if(65536&$$self.$$.dirty)$$invalidate(4,resultLines=$results)};return[prefTestResultEl,testRunning,moduleTesting,syncStatus,resultLines,performTest,clearResult2,clearPerfTestResult,moduleMultiDeviceTest,moduleSingleDeviceTest,allTest,results,plugin3,moduleDev,performanceTestResult,isReady,$results,()=>moduleMultiDeviceTest(),()=>moduleSingleDeviceTest(),()=>allTest(),()=>clearResult2(),()=>performTest(),()=>clearPerfTestResult(),function div_binding($$value){binding_callbacks[$$value?"unshift":"push"]((()=>{prefTestResultEl=$$value;$$invalidate(0,prefTestResultEl)}))}]}var TestPane=class extends SvelteComponent{constructor(options){super();init(this,options,instance5,create_fragment5,safe_not_equal,{plugin:12,moduleDev:13},add_css5)}},TestPane_default=TestPane,import_obsidian6=require("obsidian"),VIEW_TYPE_TEST="ols-pane-test",TestPaneView=class extends import_obsidian6.ItemView{constructor(leaf,plugin3,moduleDev){super(leaf);this.icon="view-log";this.title="Self-hosted LiveSync Test and Results";this.navigation=true;this.plugin=plugin3;this.moduleDev=moduleDev}getIcon(){return"view-log"}getViewType(){return VIEW_TYPE_TEST}getDisplayText(){return"Self-hosted LiveSync Test and Results"}async onOpen(){this.component=new TestPane_default({target:this.contentEl,props:{plugin:this.plugin,moduleDev:this.moduleDev}});await Promise.resolve()}async onClose(){var _a5;null==(_a5=this.component)||_a5.$destroy();await Promise.resolve()}},ModuleDev=class extends AbstractObsidianModule{constructor(){super(...arguments);this.testResults=writable([])}$everyOnloadStart(){__onMissingTranslation((()=>{}));return Promise.resolve(true)}async onMissingTranslation(key2){const outFile=`missing-translation-${(new Date).toISOString().split("T")[0]}.jsonl`,piece=JSON.stringify({[key2]:{}}),writePiece=piece.substring(1,piece.length-1)+",";try{await this.core.storageAccess.ensureDir(this.app.vault.configDir+"/ls-debug/");await this.core.storageAccess.appendHiddenFile(this.app.vault.configDir+"/ls-debug/"+outFile,writePiece+"\n")}catch(ex){this._log(`Could not write ${outFile}`,LOG_LEVEL_VERBOSE);this._log(`Missing translation: ${writePiece}`,LOG_LEVEL_VERBOSE);this._log(ex,LOG_LEVEL_VERBOSE)}}$everyOnloadAfterLoadSettings(){if(!this.settings.enableDebugTools)return Promise.resolve(true);this.onMissingTranslation=this.onMissingTranslation.bind(this);__onMissingTranslation((key2=>{this.onMissingTranslation(key2)}));eventHub.onEvent("document-stub-created",(detail=>{fireAndForget((async()=>{const stub=detail.stub,toc2=detail.toc,stubDocX=Object.entries(stub).map((([key2,value])=>[`## ${key2}`,Object.entries(value).map((([key22,value2])=>[`### ${key22}`,[...value2.entries()].map((([key3,value3])=>{var _a5;const isObsolete=value3["is_obsolete"]?" (obsolete)":"",desc=null!=(_a5=value3["desc"])?_a5:"";return`#### ${key3}${isObsolete}\n${value3["key"]?"Setting key: "+value3["key"]+"\n":""}${desc}\n`}))].flat())).flat()].flat())).flat(),stubDocMD="\n| Icon  | Description                                                       |\n| :---: | ----------------------------------------------------------------- |\n"+[...toc2.values()].map((e4=>`${e4}`)).join("\n")+"\n\n"+stubDocX.join("\n");await this.core.storageAccess.writeHiddenFileAuto(this.app.vault.configDir+"/ls-debug/stub-doc.md",stubDocMD)}))}));enableTestFunction(this.plugin);this.registerView(VIEW_TYPE_TEST,(leaf=>new TestPaneView(leaf,this.plugin,this)));this.addCommand({id:"view-test",name:"Open Test dialogue",callback:()=>{this.core.$$showView(VIEW_TYPE_TEST)}});return Promise.resolve(true)}async $everyOnLayoutReady(){if(!this.settings.enableDebugTools)return Promise.resolve(true);if(await this.core.storageAccess.isExistsIncludeHidden("_SHOWDIALOGAUTO.md"))this.core.$$showView(VIEW_TYPE_TEST);return true}$$addTestResult(name,key2,result,summary,message){const logLine=`${name}: ${key2} ${null!=summary?summary:""}`;this.testResults.update((results=>{results.push([result,logLine,null!=message?message:""]);return results}))}$everyModuleTest(){if(!this.settings.enableDebugTools)return Promise.resolve(true);else return this.testDone()}};function getFileLockKey(file){return`fl:${"string"==typeof file?file:file.path}`}function toArrayBuffer(arr){if(arr instanceof Uint8Array)return arr.buffer;if(arr instanceof DataView)return arr.buffer;else return arr}async function processReadFile(file,proc){return await serialized(getFileLockKey(file),(()=>proc()))}async function processWriteFile(file,proc){return await serialized(getFileLockKey(file),(()=>proc()))}var SerializedFileAccess=class{constructor(app2,plugin3){this.touchedFiles=[];this.app=app2;this.plugin=plugin3}async tryAdapterStat(file){const path2=file instanceof import_obsidian.TFile?file.path:file;return await processReadFile(file,(async()=>{if(!await this.app.vault.adapter.exists(path2))return null;else return this.app.vault.adapter.stat(path2)}))}async adapterStat(file){const path2=file instanceof import_obsidian.TFile?file.path:file;return await processReadFile(file,(()=>this.app.vault.adapter.stat(path2)))}async adapterExists(file){const path2=file instanceof import_obsidian.TFile?file.path:file;return await processReadFile(file,(()=>this.app.vault.adapter.exists(path2)))}async adapterRemove(file){const path2=file instanceof import_obsidian.TFile?file.path:file;return await processReadFile(file,(()=>this.app.vault.adapter.remove(path2)))}async adapterRead(file){const path2=file instanceof import_obsidian.TFile?file.path:file;return await processReadFile(file,(()=>this.app.vault.adapter.read(path2)))}async adapterReadBinary(file){const path2=file instanceof import_obsidian.TFile?file.path:file;return await processReadFile(file,(()=>this.app.vault.adapter.readBinary(path2)))}async adapterReadAuto(file){const path2=file instanceof import_obsidian.TFile?file.path:file;if(isPlainText(path2))return await processReadFile(file,(()=>this.app.vault.adapter.read(path2)));else return await processReadFile(file,(()=>this.app.vault.adapter.readBinary(path2)))}async adapterWrite(file,data,options){const path2=file instanceof import_obsidian.TFile?file.path:file;if("string"==typeof data)return await processWriteFile(file,(()=>this.app.vault.adapter.write(path2,data,options)));else return await processWriteFile(file,(()=>this.app.vault.adapter.writeBinary(path2,toArrayBuffer(data),options)))}async vaultCacheRead(file){return await processReadFile(file,(()=>this.app.vault.cachedRead(file)))}async vaultRead(file){return await processReadFile(file,(()=>this.app.vault.read(file)))}async vaultReadBinary(file){return await processReadFile(file,(()=>this.app.vault.readBinary(file)))}async vaultReadAuto(file){if(isPlainText(file.path))return await processReadFile(file,(()=>this.app.vault.read(file)));else return await processReadFile(file,(()=>this.app.vault.readBinary(file)))}async vaultModify(file,data,options){if("string"==typeof data)return await processWriteFile(file,(async()=>{const oldData=await this.app.vault.read(file);if(data===oldData){if(options&&options.mtime)markChangesAreSame(file.path,file.stat.mtime,options.mtime);return true}await this.app.vault.modify(file,data,options);return true}));else return await processWriteFile(file,(async()=>{const oldData=await this.app.vault.readBinary(file);if(await isDocContentSame(createBinaryBlob(oldData),createBinaryBlob(data))){if(options&&options.mtime)markChangesAreSame(file.path,file.stat.mtime,options.mtime);return true}await this.app.vault.modifyBinary(file,toArrayBuffer(data),options);return true}))}async vaultCreate(path2,data,options){if("string"==typeof data)return await processWriteFile(path2,(()=>this.app.vault.create(path2,data,options)));else return await processWriteFile(path2,(()=>this.app.vault.createBinary(path2,toArrayBuffer(data),options)))}trigger(name,...data){return this.app.vault.trigger(name,...data)}async adapterAppend(normalizedPath,data,options){return await this.app.vault.adapter.append(normalizedPath,data,options)}async delete(file,force=false){return await processWriteFile(file,(()=>this.app.vault.delete(file,force)))}async trash(file,force=false){return await processWriteFile(file,(()=>this.app.vault.trash(file,force)))}isStorageInsensitive(){var _a5;return null!=(_a5=this.app.vault.adapter.insensitive)?_a5:true}getAbstractFileByPathInsensitive(path2){return app.vault.getAbstractFileByPathInsensitive(path2)}getAbstractFileByPath(path2){if(!this.plugin.settings.handleFilenameCaseSensitive||this.isStorageInsensitive())return this.getAbstractFileByPathInsensitive(path2);else return this.app.vault.getAbstractFileByPath(path2)}getFiles(){return this.app.vault.getFiles()}async ensureDirectory(fullPath){const pathElements=fullPath.split("/");pathElements.pop();let c2="";for(const v2 of pathElements){c2+=v2;try{await this.app.vault.adapter.mkdir(c2)}catch(ex){if("Folder already exists."==(null==ex?void 0:ex.message));else{Logger("Folder Create Error");Logger(ex)}}c2+="/"}}touch(file){const f4=file instanceof import_obsidian.TFile?file:this.getAbstractFileByPath(file),key2=`${f4.path}-${f4.stat.mtime}-${f4.stat.size}`;this.touchedFiles.unshift(key2);this.touchedFiles=this.touchedFiles.slice(0,100)}recentlyTouched(file){const key2="stat"in file?`${file.path}-${file.stat.mtime}-${file.stat.size}`:`${file.path}-${file.mtime}-${file.size}`;if(-1==this.touchedFiles.indexOf(key2))return false;else return true}clearTouched(){this.touchedFiles=[]}};async function TFileToUXFileInfo(core,file,prefix,deleted){const possiblyLarge=!isPlainText(file.name);let content;if(deleted)content=new Blob;else{if(possiblyLarge)Logger(`Reading   : ${file.path}`,LOG_LEVEL_VERBOSE);content=createBlob(await core.storageAccess.readFileAuto(file.path));if(possiblyLarge)Logger(`Processing: ${file.path}`,LOG_LEVEL_VERBOSE)}const bareFullPath=file.path,fullPath=prefix?addPrefix(bareFullPath,prefix):bareFullPath;return{name:file.name,path:fullPath,stat:{size:content.size,ctime:file.stat.ctime,mtime:file.stat.mtime,type:"file"},body:content}}async function InternalFileToUXFileInfo(fullPath,vaultAccess,prefix=ICHeader){const name=fullPath.split("/").pop(),stat=await vaultAccess.tryAdapterStat(fullPath);if(null==stat)throw new Error(`File not found: ${fullPath}`);if("folder"==stat.type)throw new Error(`File not found: ${fullPath}`);const file=await vaultAccess.adapterReadAuto(fullPath),possiblyLarge=!isPlainText(name);if(possiblyLarge)Logger(`Reading   : ${fullPath}`,LOG_LEVEL_VERBOSE);const content=createBlob(file);if(possiblyLarge)Logger(`Processing: ${fullPath}`,LOG_LEVEL_VERBOSE);const bareFullPath=fullPath;return{name,path:prefix?addPrefix(bareFullPath,prefix):bareFullPath,stat:{size:content.size,ctime:stat.ctime,mtime:stat.mtime,type:"file"},body:content}}function TFileToUXFileInfoStub(file,deleted){if(!(file instanceof import_obsidian.TFile))throw new Error("Invalid file type");return{name:file.name,path:file.path,isFolder:false,stat:{size:file.stat.size,mtime:file.stat.mtime,ctime:file.stat.ctime,type:"file"},deleted}}function InternalFileToUXFileInfoStub(filename,deleted){return{name:filename.split("/").pop(),path:filename,isFolder:false,stat:void 0,isInternal:true,deleted}}function TFolderToUXFileInfoStub(file){var _a5;return{name:file.name,path:file.path,parent:null==(_a5=file.parent)?void 0:_a5.path,isFolder:true,children:file.children.map((e4=>TFileToUXFileInfoStub(e4)))}}var StorageEventManager=class{},StorageEventManagerObsidian=class extends StorageEventManager{constructor(plugin3,core){super();this.bufferedQueuedItems=[];this.concurrentProcessing=Semaphore(5);this.waitedSince=new Map;this.processingCount=0;this.plugin=plugin3;this.core=core}get shouldBatchSave(){var _a5,_b2;return(null==(_a5=this.core.settings)?void 0:_a5.batchSave)&&true!=(null==(_b2=this.core.settings)?void 0:_b2.liveSync)}get batchSaveMinimumDelay(){var _a5,_b2;return null!=(_b2=null==(_a5=this.core.settings)?void 0:_a5.batchSaveMinimumDelay)?_b2:DEFAULT_SETTINGS.batchSaveMinimumDelay}get batchSaveMaximumDelay(){var _a5,_b2;return null!=(_b2=null==(_a5=this.core.settings)?void 0:_a5.batchSaveMaximumDelay)?_b2:DEFAULT_SETTINGS.batchSaveMaximumDelay}beginWatch(){const plugin3=this.plugin;this.watchVaultChange=this.watchVaultChange.bind(this);this.watchVaultCreate=this.watchVaultCreate.bind(this);this.watchVaultDelete=this.watchVaultDelete.bind(this);this.watchVaultRename=this.watchVaultRename.bind(this);this.watchVaultRawEvents=this.watchVaultRawEvents.bind(this);this.watchEditorChange=this.watchEditorChange.bind(this);plugin3.registerEvent(plugin3.app.vault.on("modify",this.watchVaultChange));plugin3.registerEvent(plugin3.app.vault.on("delete",this.watchVaultDelete));plugin3.registerEvent(plugin3.app.vault.on("rename",this.watchVaultRename));plugin3.registerEvent(plugin3.app.vault.on("create",this.watchVaultCreate));plugin3.registerEvent(plugin3.app.vault.on("raw",this.watchVaultRawEvents));plugin3.registerEvent(plugin3.app.workspace.on("editor-change",this.watchEditorChange))}watchEditorChange(editor,info3){if(!("path"in info3))return;if(!this.shouldBatchSave)return;const file=null==info3?void 0:info3.file;if(!file)return;if(!this.isWaiting(file.path))return;const data=null==info3?void 0:info3.data,fi={type:"CHANGED",file:TFileToUXFileInfoStub(file),cachedData:data};this.appendQueue([fi])}watchVaultCreate(file,ctx){if(file instanceof import_obsidian.TFolder)return;const fileInfo=TFileToUXFileInfoStub(file);this.appendQueue([{type:"CREATE",file:fileInfo}],ctx)}watchVaultChange(file,ctx){if(file instanceof import_obsidian.TFolder)return;const fileInfo=TFileToUXFileInfoStub(file);this.appendQueue([{type:"CHANGED",file:fileInfo}],ctx)}watchVaultDelete(file,ctx){if(file instanceof import_obsidian.TFolder)return;const fileInfo=TFileToUXFileInfoStub(file,true);this.appendQueue([{type:"DELETE",file:fileInfo}],ctx)}watchVaultRename(file,oldFile,ctx){if(file instanceof import_obsidian.TFile){const fileInfo=TFileToUXFileInfoStub(file);this.appendQueue([{type:"DELETE",file:{path:oldFile,name:file.name,stat:{mtime:file.stat.mtime,ctime:file.stat.ctime,size:file.stat.size,type:"file"},deleted:true},skipBatchWait:true},{type:"CREATE",file:fileInfo,skipBatchWait:true}],ctx)}}watchVaultRawEvents(path2){if(this.plugin.settings)if(this.plugin.settings.useIgnoreFiles)this.plugin.$$isTargetFile(path2).then((()=>this._watchVaultRawEvents(path2)));else this._watchVaultRawEvents(path2)}_watchVaultRawEvents(path2){if(this.plugin.settings.syncInternalFiles||this.plugin.settings.usePluginSync)if(this.plugin.settings.watchInternalFileChanges)if(path2.startsWith(this.plugin.app.vault.configDir))if(!this.plugin.settings.syncInternalFilesIgnorePatterns.replace(/\n| /g,"").split(",").filter((e4=>e4)).map((e4=>new RegExp(e4,"i"))).some((e4=>path2.match(e4))))if(!path2.endsWith("/"))this.appendQueue([{type:"INTERNAL",file:InternalFileToUXFileInfoStub(path2),skipBatchWait:true}],null)}async appendQueue(params,ctx){if(!this.core.settings.isConfigured)return;if(this.core.settings.suspendFileWatching)return;this.core.$$markFileListPossiblyChanged();const processFiles=new Set;for(const param of params){if(shouldBeIgnored(param.file.path))continue;const atomicKey=[0,0,0,0,0,0].map((e4=>`${Math.floor(1e5*Math.random())}`)).join("-"),type=param.type,file=param.file,oldPath=param.oldPath;if("INTERNAL"!==type){const size=file.stat.size;if(this.core.$$isFileSizeExceeded(size)&&("CREATE"==type||"CHANGED"==type)){Logger(`The storage file has been changed but exceeds the maximum size. Skipping: ${param.file.path}`,LOG_LEVEL_NOTICE);continue}}if(file instanceof import_obsidian.TFolder)continue;if(!await this.core.$$isTargetFile(file.path))continue;if(file instanceof import_obsidian.TFile||!file.isFolder)if("CREATE"==type||"CHANGED"==type){await delay(10);if(this.core.storageAccess.recentlyTouched(file.path))continue}let cache;if(param.cachedData)cache=param.cachedData;this.enqueue({type,args:{file,oldPath,cache,ctx},skipBatchWait:param.skipBatchWait,key:atomicKey});processFiles.add(file.path);if(oldPath)processFiles.add(oldPath)}for(const path2 of processFiles)fireAndForget((()=>this.startStandingBy(path2)))}enqueue(newItem){const filename=newItem.args.file.path;if(this.shouldBatchSave){Logger(`Request cancel for waiting of previous ${filename}`,LOG_LEVEL_DEBUG);finishWaitingForTimeout(`storage-event-manager-batchsave-${filename}`)}this.bufferedQueuedItems.push(newItem);if("DELETE"==newItem.type)return this.flushQueue()}async startStandingBy(filename){await skipIfDuplicated(`storage-event-manager-${filename}`,(async()=>{Logger(`Processing ${filename}: Starting`,LOG_LEVEL_DEBUG);const release=await this.concurrentProcessing.acquire();try{Logger(`Processing ${filename}: Started`,LOG_LEVEL_DEBUG);let noMoreFiles=false;do{const target=this.bufferedQueuedItems.find((e4=>e4.args.file.path==filename));if(void 0===target){noMoreFiles=true;break}const operationType=target.type,type=target.type;if(!target.cancelled){if(!target.skipBatchWait){if(this.shouldBatchSave&&("CREATE"==type||"CHANGED"==type)){const waitedSince=this.waitedSince.get(filename);let canWait=true;const now2=Date.now();if(void 0!==waitedSince)if(waitedSince+1e3*this.batchSaveMaximumDelay<now2){Logger(`Processing ${filename}: Could not wait no more: ${operationType}`,LOG_LEVEL_INFO);canWait=false}if(canWait){if(void 0===waitedSince)this.waitedSince.set(filename,now2);target.batched=true;Logger(`Processing ${filename}: Waiting for batch save delay: ${operationType}`,LOG_LEVEL_DEBUG);this.updateStatus();if(!await waitForTimeout(`storage-event-manager-batchsave-${filename}`,1e3*this.batchSaveMinimumDelay)){Logger(`Processing ${filename}: Cancelled by new queue: ${operationType}`,LOG_LEVEL_DEBUG);this.cancelStandingBy(target);continue}}}}else Logger(`Processing ${filename}:Requested to perform immediately ${filename}: ${operationType}`,LOG_LEVEL_DEBUG);Logger(`Processing ${filename}: Request main to process: ${operationType}`,LOG_LEVEL_DEBUG);await this.requestProcessQueue(target)}else{Logger(`Processing ${filename}: Cancelled (scheduled): ${operationType}`,LOG_LEVEL_DEBUG);this.cancelStandingBy(target)}}while(!noMoreFiles)}finally{release()}Logger(`Processing ${filename}: Finished`,LOG_LEVEL_DEBUG)}))}cancelStandingBy(fei){this.bufferedQueuedItems.remove(fei);this.updateStatus()}async requestProcessQueue(fei){try{this.processingCount++;this.bufferedQueuedItems.remove(fei);this.updateStatus();this.waitedSince.delete(fei.args.file.path);await this.handleFileEvent(fei)}finally{this.processingCount--;this.updateStatus()}}isWaiting(filename){return isWaitingForTimeout(`storage-event-manager-batchsave-${filename}`)}flushQueue(){this.bufferedQueuedItems.forEach((e4=>e4.skipBatchWait=true));finishAllWaitingForTimeout("storage-event-manager-batchsave-",true)}cancelQueue(key2){this.bufferedQueuedItems.forEach((e4=>{if(e4.key===key2)e4.skipBatchWait=true}))}updateStatus(){const allItems=this.bufferedQueuedItems.filter((e4=>!e4.cancelled)),batchedCount=allItems.filter((e4=>e4.batched&&!e4.skipBatchWait)).length;this.core.batched.value=batchedCount;this.core.processing.value=this.processingCount;this.core.totalQueued.value=allItems.length-batchedCount}async handleFileEvent(queue2){const file=queue2.args.file,lockKey=`handleFile:${file.path}`;return await serialized(lockKey,(async()=>{if("INTERNAL"==queue2.type||file.isInternal)await this.core.$anyProcessOptionalFileEvent(file.path);else{const key2=`file-last-proc-${queue2.type}-${file.path}`,last=Number(await this.core.kvDB.get(key2)||0);if("DELETE"==queue2.type)await this.core.$anyHandlerProcessesFileEvent(queue2);else{if(file.stat.mtime==last){Logger(`File has been already scanned on ${queue2.type}, skip: ${file.path}`,LOG_LEVEL_VERBOSE);return}if(!await this.core.$anyHandlerProcessesFileEvent(queue2)){Logger(`STORAGE -> DB: Handler failed, cancel the relative operations: ${file.path}`,LOG_LEVEL_INFO);this.cancelRelativeEvent(queue2);return}}}}))}cancelRelativeEvent(item){this.cancelQueue(item.key)}},import_obsidian7=require("obsidian"),ModuleFileAccessObsidian=class extends AbstractObsidianModule{constructor(){super(...arguments);this.vaultManager=new StorageEventManagerObsidian(this.plugin,this.core)}$everyOnload(){this.core.storageAccess=this;return Promise.resolve(true)}$everyOnFirstInitialize(){this.vaultManager.beginWatch();return Promise.resolve(true)}$allOnUnload(){return Promise.resolve(true)}$everyCommitPendingFileEvent(){this.vaultManager.flushQueue();return Promise.resolve(true)}$everyOnloadStart(){this.vaultAccess=new SerializedFileAccess(this.app,this.plugin);return Promise.resolve(true)}$$isStorageInsensitive(){return this.vaultAccess.isStorageInsensitive()}$$shouldCheckCaseInsensitive(){if(this.$$isStorageInsensitive())return false;else return!this.settings.handleFilenameCaseSensitive}async writeFileAuto(path2,data,opt){const file=this.vaultAccess.getAbstractFileByPath(path2);if(file instanceof import_obsidian7.TFile)return this.vaultAccess.vaultModify(file,data,opt);else if(null===file)return await this.vaultAccess.vaultCreate(path2,data,opt)instanceof import_obsidian7.TFile;else{this._log(`Could not write file (Possibly already exists as a folder): ${path2}`,LOG_LEVEL_VERBOSE);return false}}readFileAuto(path2){const file=this.vaultAccess.getAbstractFileByPath(path2);if(file instanceof import_obsidian7.TFile)return this.vaultAccess.vaultRead(file);else throw new Error(`Could not read file (Possibly does not exist): ${path2}`)}readFileText(path2){const file=this.vaultAccess.getAbstractFileByPath(path2);if(file instanceof import_obsidian7.TFile)return this.vaultAccess.vaultRead(file);else throw new Error(`Could not read file (Possibly does not exist): ${path2}`)}isExists(path2){return Promise.resolve(this.vaultAccess.getAbstractFileByPath(path2)instanceof import_obsidian7.TFile)}async writeHiddenFileAuto(path2,data,opt){try{await this.vaultAccess.adapterWrite(path2,data,opt);return true}catch(e4){this._log(`Could not write hidden file: ${path2}`,LOG_LEVEL_VERBOSE);this._log(e4,LOG_LEVEL_VERBOSE);return false}}async appendHiddenFile(path2,data,opt){try{await this.vaultAccess.adapterAppend(path2,data,opt);return true}catch(e4){this._log(`Could not append hidden file: ${path2}`,LOG_LEVEL_VERBOSE);this._log(e4,LOG_LEVEL_VERBOSE);return false}}stat(path2){const file=this.vaultAccess.getAbstractFileByPath(path2);if(null===file)return Promise.resolve(null);if(file instanceof import_obsidian7.TFile)return Promise.resolve({ctime:file.stat.ctime,mtime:file.stat.mtime,size:file.stat.size,type:"file"});else throw new Error(`Could not stat file (Possibly does not exist): ${path2}`)}statHidden(path2){return this.vaultAccess.tryAdapterStat(path2)}async removeHidden(path2){try{await this.vaultAccess.adapterRemove(path2);if(null!==this.vaultAccess.tryAdapterStat(path2))return false;else return true}catch(e4){this._log(`Could not remove hidden file: ${path2}`,LOG_LEVEL_VERBOSE);this._log(e4,LOG_LEVEL_VERBOSE);return false}}async readHiddenFileAuto(path2){return await this.vaultAccess.adapterReadAuto(path2)}async readHiddenFileText(path2){return await this.vaultAccess.adapterRead(path2)}async readHiddenFileBinary(path2){return await this.vaultAccess.adapterReadBinary(path2)}async isExistsIncludeHidden(path2){return null!==await this.vaultAccess.tryAdapterStat(path2)}async ensureDir(path2){try{await this.vaultAccess.ensureDirectory(path2);return true}catch(e4){this._log(`Could not ensure directory: ${path2}`,LOG_LEVEL_VERBOSE);this._log(e4,LOG_LEVEL_VERBOSE);return false}}triggerFileEvent(event,path2){this.vaultAccess.trigger(event,this.vaultAccess.getAbstractFileByPath((0,import_obsidian7.normalizePath)(path2)))}async triggerHiddenFile(path2){await this.app.vault.adapter.reconcileInternalFile(path2)}getFileStub(path2){const file=this.vaultAccess.getAbstractFileByPath(path2);if(file instanceof import_obsidian7.TFile)return TFileToUXFileInfoStub(file);else return null}async readStubContent(stub){const file=this.vaultAccess.getAbstractFileByPath(stub.path);if(!(file instanceof import_obsidian7.TFile)){this._log(`Could not read file (Possibly does not exist or a folder): ${stub.path}`,LOG_LEVEL_VERBOSE);return false}const data=await this.vaultAccess.vaultReadAuto(file);return{...stub,body:createBlob(data)}}getStub(path2){const file=this.vaultAccess.getAbstractFileByPath(path2);if(file instanceof import_obsidian7.TFile)return TFileToUXFileInfoStub(file);else if(file instanceof import_obsidian7.TFolder)return TFolderToUXFileInfoStub(file);return null}getFiles(){return this.vaultAccess.getFiles().map((f4=>TFileToUXFileInfoStub(f4)))}getFileNames(){return this.vaultAccess.getFiles().map((f4=>f4.path))}async getFilesIncludeHidden(basePath,includeFilter,excludeFilter,skipFolder=[".git",".trash","node_modules"]){var _a5;let w2;try{w2=await this.app.vault.adapter.list(basePath)}catch(ex){this._log(`Could not traverse(getFilesIncludeHidden):${basePath}`,LOG_LEVEL_INFO);this._log(ex,LOG_LEVEL_VERBOSE);return[]}skipFolder=skipFolder.map((e4=>e4.toLowerCase()));let files=[];for(const file of w2.files){if(excludeFilter&&excludeFilter.some((ee=>file.match(ee))))if(includeFilter){if(!includeFilter.some((e4=>file.match(e4))))continue}else continue;if(includeFilter)if(!includeFilter.some((e4=>file.match(e4))))continue;if(!await this.plugin.$$isIgnoredByIgnoreFiles(file))files.push(file)}for(const v2 of w2.folders){const folderName=(null!=(_a5=v2.split("/").pop())?_a5:"").toLowerCase();if(!skipFolder.some((e4=>folderName===e4))){if(excludeFilter&&excludeFilter.some((e4=>v2.match(e4))))if(includeFilter)if(!includeFilter.some((e4=>v2.match(e4))))continue;if(includeFilter)if(!includeFilter.some((e4=>v2.match(e4))))continue;files=files.concat(await this.getFilesIncludeHidden(v2,includeFilter,excludeFilter,skipFolder))}}return files}touched(file){const path2="string"==typeof file?file:file.path;this.vaultAccess.touch(path2)}recentlyTouched(file){const xFile="string"==typeof file?this.vaultAccess.getAbstractFileByPath(file):file;if(null===xFile)return false;if(xFile instanceof import_obsidian7.TFolder)return false;else return this.vaultAccess.recentlyTouched(xFile)}clearTouched(){this.vaultAccess.clearTouched()}delete(file,force){const xPath="string"==typeof file?file:file.path,xFile=this.vaultAccess.getAbstractFileByPath(xPath);if(null===xFile)return Promise.resolve();if(!(xFile instanceof import_obsidian7.TFile||xFile instanceof import_obsidian7.TFolder))return Promise.resolve();else return this.vaultAccess.delete(xFile,force)}trash(file,system){const xPath="string"==typeof file?file:file.path,xFile=this.vaultAccess.getAbstractFileByPath(xPath);if(null===xFile)return Promise.resolve();if(!(xFile instanceof import_obsidian7.TFile||xFile instanceof import_obsidian7.TFolder))return Promise.resolve();else return this.vaultAccess.trash(xFile,system)}async _deleteVaultItem(file){if(file instanceof import_obsidian7.TFile)if(!await this.core.$$isTargetFile(file.path))return;const dir=file.parent;if(this.settings.trashInsteadDelete)await this.vaultAccess.trash(file,false);else await this.vaultAccess.delete(file,true);this._log(`xxx <- STORAGE (deleted) ${file.path}`);if(dir){this._log(`files: ${dir.children.length}`);if(0==dir.children.length)if(!this.settings.doNotDeleteFolder){this._log(`All files under the parent directory (${dir.path}) have been deleted, so delete this one.`);await this._deleteVaultItem(dir)}}}async deleteVaultItem(fileSrc){const path2="string"==typeof fileSrc?fileSrc:fileSrc.path,file=this.vaultAccess.getAbstractFileByPath(path2);if(null!==file)if(file instanceof import_obsidian7.TFile||file instanceof import_obsidian7.TFolder)return await this._deleteVaultItem(file);else return}},import_obsidian8=require("obsidian"),AutoClosableModal=class extends import_obsidian.Modal{constructor(app2){super(app2);this.removeEvent=eventHub.onEvent(EVENT_PLUGIN_UNLOADED,(async()=>{await delay(100);if(this.removeEvent){this.close();this.removeEvent=void 0}}))}onClose(){if(this.removeEvent){this.removeEvent();this.removeEvent=void 0}}},InputStringDialog=class extends AutoClosableModal{constructor(app2,title,key2,placeholder,isPassword,onSubmit){super(app2);this.result=false;this.isManuallyClosed=false;this.isPassword=false;this.onSubmit=onSubmit;this.title=title;this.placeholder=placeholder;this.key=key2;this.isPassword=isPassword}onOpen(){const{contentEl}=this;this.titleEl.setText(this.title);const formEl=contentEl.createDiv();new import_obsidian.Setting(formEl).setName(this.key).setClass(this.isPassword?"password-input":"normal-input").addText((text2=>text2.onChange((value=>{this.result=value}))));new import_obsidian.Setting(formEl).addButton((btn=>btn.setButtonText("Ok").setCta().onClick((()=>{this.isManuallyClosed=true;this.close()})))).addButton((btn=>btn.setButtonText("Cancel").setCta().onClick((()=>{this.close()}))))}onClose(){super.onClose();const{contentEl}=this;contentEl.empty();if(this.isManuallyClosed)this.onSubmit(this.result);else this.onSubmit(false)}},PopoverSelectString=class extends import_obsidian.FuzzySuggestModal{constructor(app2,note,placeholder,getItemsFun,callback){super(app2);this.callback=()=>{};this.getItemsFun=()=>["yes","no"];this.app=app2;this.setPlaceholder((null!=placeholder?placeholder:"y/n) ")+note);if(getItemsFun)this.getItemsFun=getItemsFun;this.callback=callback}getItems(){return this.getItemsFun()}getItemText(item){return item}onChooseItem(item,evt){var _a5;null==(_a5=this.callback)||_a5.call(this,item);this.callback=void 0}onClose(){setTimeout((()=>{if(this.callback){this.callback("");this.callback=void 0}}),100)}},MessageBox=class extends AutoClosableModal{constructor(plugin3,title,contentMd,buttons,defaultAction,timeout,wideButton,onSubmit){super(plugin3.app);this.result=false;this.isManuallyClosed=false;this.timer=void 0;this.plugin=plugin3;this.title=title;this.contentMd=contentMd;this.buttons=buttons;this.onSubmit=onSubmit;this.defaultAction=defaultAction;this.timeout=timeout;this.wideButton=wideButton;if(this.timeout)this.timer=setInterval((()=>{var _a5,_b2;if(void 0!==this.timeout){this.timeout--;if(this.timeout<0){if(this.timer){clearInterval(this.timer);null==(_a5=this.defaultButtonComponent)||_a5.setButtonText(`${defaultAction}`);this.timer=void 0}this.result=defaultAction;this.isManuallyClosed=true;this.close()}else null==(_b2=this.defaultButtonComponent)||_b2.setButtonText(`( ${this.timeout} ) ${defaultAction}`)}}),1e3)}onOpen(){const{contentEl}=this;this.titleEl.setText(this.title);const div=contentEl.createDiv();div.style.userSelect="text";import_obsidian.MarkdownRenderer.render(this.plugin.app,this.contentMd,div,"/",this.plugin);const buttonSetting=new import_obsidian.Setting(contentEl),labelWrapper=contentEl.createDiv();labelWrapper.addClass("sls-dialogue-note-wrapper");labelWrapper.createEl("label",{text:"To stop the countdown, tap anywhere on the dialogue"}).addClass("sls-dialogue-note-countdown");if(!this.timeout||!this.timer){labelWrapper.empty();labelWrapper.style.display="none"}buttonSetting.infoEl.style.display="none";buttonSetting.controlEl.style.flexWrap="wrap";if(this.wideButton){buttonSetting.controlEl.style.flexDirection="column";buttonSetting.controlEl.style.alignItems="center";buttonSetting.controlEl.style.justifyContent="center";buttonSetting.controlEl.style.flexGrow="1"}contentEl.addEventListener("click",(()=>{var _a5;if(this.timer){labelWrapper.empty();labelWrapper.style.display="none";clearInterval(this.timer);this.timer=void 0;null==(_a5=this.defaultButtonComponent)||_a5.setButtonText(`${this.defaultAction}`)}}));for(const button of this.buttons)buttonSetting.addButton((btn=>{btn.setButtonText(button).onClick((()=>{this.isManuallyClosed=true;this.result=button;if(this.timer){clearInterval(this.timer);this.timer=void 0}this.close()}));if(button==this.defaultAction){this.defaultButtonComponent=btn;btn.setCta()}if(this.wideButton){btn.buttonEl.style.flexGrow="1";btn.buttonEl.style.width="100%"}return btn}))}onClose(){super.onClose();const{contentEl}=this;contentEl.empty();if(this.timer){clearInterval(this.timer);this.timer=void 0}if(this.isManuallyClosed)this.onSubmit(this.result);else this.onSubmit(false)}};function confirmWithMessage(plugin3,title,contentMd,buttons,defaultAction,timeout){return new Promise((res2=>{new MessageBox(plugin3,title,contentMd,buttons,defaultAction,timeout,false,(result=>res2(result))).open()}))}function confirmWithMessageWithWideButton(plugin3,title,contentMd,buttons,defaultAction,timeout){return new Promise((res2=>{new MessageBox(plugin3,title,contentMd,buttons,defaultAction,timeout,true,(result=>res2(result))).open()}))}var askYesNo=(app2,message)=>new Promise((res2=>{new PopoverSelectString(app2,message,void 0,void 0,(result=>res2(result))).open()})),askSelectString=(app2,message,items)=>{const getItemsFun=()=>items;return new Promise((res2=>{new PopoverSelectString(app2,message,"",getItemsFun,(result=>res2(result))).open()}))},askString=(app2,title,key2,placeholder,isPassword=false)=>new Promise((res2=>{new InputStringDialog(app2,title,key2,placeholder,isPassword,(result=>res2(result))).open()})),ModuleInputUIObsidian=class extends AbstractObsidianModule{$everyOnload(){this.core.confirm=this;return Promise.resolve(true)}askYesNo(message){return askYesNo(this.app,message)}askString(title,key2,placeholder,isPassword=false){return askString(this.app,title,key2,placeholder,isPassword)}async askYesNoDialog(message,opt={title:"Confirmation"}){var _a5;return"Yes"==await confirmWithMessageWithWideButton(this.plugin,opt.title||"Confirmation",message,["Yes","No"],null!=(_a5=opt.defaultOption)?_a5:"No",opt.timeout)?"yes":"no"}askSelectString(message,items){return askSelectString(this.app,message,items)}askSelectStringDialogue(message,buttons,opt){return confirmWithMessageWithWideButton(this.plugin,opt.title||"Select",message,buttons,opt.defaultAction,opt.timeout)}askInPopup(key2,dialogText,anchorCallback){const fragment=createFragment((doc=>{const[beforeText,afterText]=dialogText.split("{HERE}",2);doc.createEl("span",void 0,(a2=>{a2.appendText(beforeText);a2.appendChild(a2.createEl("a",void 0,(anchor=>{anchorCallback(anchor)})));a2.appendText(afterText)}))})),popupKey="popup-"+key2;scheduleTask(popupKey,1e3,(async()=>{var _a5;const popup=await memoIfNotExist(popupKey,(()=>new import_obsidian.Notice(fragment,0)));if(!(null==(_a5=null==popup?void 0:popup.noticeEl)?void 0:_a5.isShown()))memoObject(popupKey,new import_obsidian.Notice(fragment,0));scheduleTask(popupKey+"-close",2e4,(()=>{var _a6;const popup2=retrieveMemoObject(popupKey);if(popup2){if(null==(_a6=null==popup2?void 0:popup2.noticeEl)?void 0:_a6.isShown())popup2.hide();disposeMemoObject(popupKey)}}))}))}confirmWithMessage(title,contentMd,buttons,defaultAction,timeout){return confirmWithMessage(this.plugin,title,contentMd,buttons,defaultAction,timeout)}},URI_DOC="https://github.com/vrtmrz/obsidian-livesync/blob/main/README.md#how-to-use",ModuleMigration=class extends AbstractModule{async migrateDisableBulkSend(){if(this.settings.sendChunksBulk){this._log("Send chunks in bulk has been enabled, however, this feature had been corrupted. Sorry for your inconvenience. Automatically disabled.",LOG_LEVEL_NOTICE);this.settings.sendChunksBulk=false;this.settings.sendChunksBulkMaxSize=1;await this.saveSettings()}}async migrationCheck(){const old=this.settings.settingVersion,current=SETTING_VERSION_SUPPORT_CASE_INSENSITIVE;if(await this.migrateToCaseInsensitive(old,current));else this._log(`Migration failed or cancelled from ${old} to ${current}`,LOG_LEVEL_NOTICE)}async migrateToCaseInsensitive(old,current){if(void 0!==this.settings.handleFilenameCaseSensitive&&void 0!==this.settings.doNotUseFixedRevisionForChunks){if(current<SETTING_VERSION_SUPPORT_CASE_INSENSITIVE){this.settings.settingVersion=SETTING_VERSION_SUPPORT_CASE_INSENSITIVE;await this.saveSettings()}return true}if(old>=SETTING_VERSION_SUPPORT_CASE_INSENSITIVE&&void 0!==this.settings.handleFilenameCaseSensitive&&void 0!==this.settings.doNotUseFixedRevisionForChunks)return true;let remoteHandleFilenameCaseSensitive,remoteDoNotUseFixedRevisionForChunks,remoteChecked=false;try{const remoteInfo=await this.core.replicator.getRemotePreferredTweakValues(this.settings);if(remoteInfo){remoteHandleFilenameCaseSensitive="handleFilenameCaseSensitive"in remoteInfo?remoteInfo.handleFilenameCaseSensitive:false;remoteDoNotUseFixedRevisionForChunks="doNotUseFixedRevisionForChunks"in remoteInfo?remoteInfo.doNotUseFixedRevisionForChunks:false;if(void 0!==remoteHandleFilenameCaseSensitive||void 0!==remoteDoNotUseFixedRevisionForChunks)remoteChecked=true}else this._log("Failed to fetch remote tweak values",LOG_LEVEL_INFO)}catch(ex){this._log("Could not get remote tweak values",LOG_LEVEL_INFO);this._log(ex,LOG_LEVEL_VERBOSE)}if(remoteChecked){if(remoteHandleFilenameCaseSensitive&&remoteDoNotUseFixedRevisionForChunks){this.settings.handleFilenameCaseSensitive=true;this.settings.doNotUseFixedRevisionForChunks=true;this.settings.settingVersion=SETTING_VERSION_SUPPORT_CASE_INSENSITIVE;this._log(`Migrated to db:${current} with the same behaviour as before`,LOG_LEVEL_INFO);await this.saveSettings();return true}const message2="As you may already know, the self-hosted LiveSync has changed its default behaviour and database structure.\n\nAnd thankfully, with your time and efforts, the remote database appears to have already been migrated. Congratulations!\n\nHowever, we need a bit more. The configuration of this device is not compatible with the remote database. We will need to fetch the remote database again. Should we fetch from the remote again now?\n\n___Note: We cannot synchronise until the configuration has been changed and the database has been fetched again.___\n___Note2: The chunks are completely immutable, we can fetch only the metadata and difference.___\n",OPTION_FETCH="Yes, fetch again",options2=[OPTION_FETCH,"No, please ask again"];if(await this.core.confirm.confirmWithMessage("Case Sensitivity",message2,options2,"No, please ask again",40)==OPTION_FETCH){this.settings.handleFilenameCaseSensitive=remoteHandleFilenameCaseSensitive||false;this.settings.doNotUseFixedRevisionForChunks=remoteDoNotUseFixedRevisionForChunks||false;this.settings.settingVersion=SETTING_VERSION_SUPPORT_CASE_INSENSITIVE;await this.saveSettings();try{await this.core.rebuilder.scheduleFetch();return}catch(ex){this._log("Failed to create redflag2",LOG_LEVEL_VERBOSE);this._log(ex,LOG_LEVEL_VERBOSE)}return false}else return false}const DISMISS="Decide it later",KEEP="Keep previous behaviour",message=`Since v0.23.21, the self-hosted LiveSync has changed the default behaviour and database structure. The following changes have been made:\n\n1. **Case sensitivity of filenames** \n   The handling of filenames is now case-insensitive. This is a beneficial change for most platforms, other than Linux and iOS, which do not manage filename case sensitivity effectively.\n   (On These, a warning will be displayed for files with the same name but different cases).\n\n2. **Revision handling of the chunks** \n   Chunks are immutable, which allows their revisions to be fixed. This change will enhance the performance of file saving.\n\n___However, to enable either of these changes, both remote and local databases need to be rebuilt. This process takes a few minutes, and we recommend doing it when you have ample time.___\n\n- If you wish to maintain the previous behaviour, you can skip this process by using \`${KEEP}\`.\n- If you do not have enough time, please choose \`${DISMISS}\`. You will be prompted again later.\n- If you have rebuilt the database on another device, please select \`${DISMISS}\` and try synchronizing again. Since a difference has been detected, you will be prompted again.\n`,options=["Enable both","Enable only #1","Enable only #2"];if(remoteChecked)options.push("Adjust to remote");options.push(KEEP,DISMISS);const ret=await this.core.confirm.confirmWithMessage("Case Sensitivity",message,options,DISMISS,40);console.dir(ret);switch(ret){case"Enable both":this.settings.handleFilenameCaseSensitive=false;this.settings.doNotUseFixedRevisionForChunks=false;break;case"Enable only #1":this.settings.handleFilenameCaseSensitive=false;this.settings.doNotUseFixedRevisionForChunks=true;break;case"Enable only #2":this.settings.doNotUseFixedRevisionForChunks=false;this.settings.handleFilenameCaseSensitive=true;break;case KEEP:this.settings.handleFilenameCaseSensitive=true;this.settings.doNotUseFixedRevisionForChunks=true;this.settings.settingVersion=SETTING_VERSION_SUPPORT_CASE_INSENSITIVE;await this.saveSettings();return true;case DISMISS:default:return false}this.settings.settingVersion=SETTING_VERSION_SUPPORT_CASE_INSENSITIVE;await this.saveSettings();await this.core.rebuilder.scheduleRebuild();await this.core.$$performRestart()}async initialMessage(){const message=`Your device has **not been set up yet**. Let me guide you through the setup process.\n\nPlease keep in mind that every dialogue content can be copied to the clipboard. If you need to refer to it later, you can paste it into a note in Obsidian. You can also translate it into your language using a translation tool.\n\nFirst, do you have **Setup URI**?\n\nNote: If you do not know what it is, please refer to the [documentation](${URI_DOC}).\n`,NEXT="No, I do not have",ret=await this.core.confirm.askSelectStringDialogue(message,["Yes, I have",NEXT],{title:"Welcome to Self-hosted LiveSync",defaultAction:"Yes, I have"});if("Yes, I have"===ret){eventHub.emitEvent(EVENT_REQUEST_OPEN_SETUP_URI);return false}else if(ret==NEXT)return true;return false}async askAgainForSetupURI(){const message=`We strongly recommend that you generate a set-up URI and use it.\nIf you do not have knowledge about it, please refer to the [documentation](${URI_DOC}) (Sorry again, but it is important).\n\nHow do you want to set it up manually?`,USE_MINIMAL="Take me into the setup wizard",NEXT="Remind me at the next launch",ret=await this.core.confirm.askSelectStringDialogue(message,[USE_MINIMAL,"Set it up all manually",NEXT],{title:"Recommendation to use Setup URI",defaultAction:USE_MINIMAL});if(ret===USE_MINIMAL){eventHub.emitEvent(EVENT_REQUEST_OPEN_SETTING_WIZARD);return false}if("Set it up all manually"===ret){eventHub.emitEvent(EVENT_REQUEST_OPEN_SETTINGS);return false}else if(ret==NEXT)return false;return false}async $everyOnFirstInitialize(){if(!this.localDatabase.isReady){this._log("Something went wrong! The local database is not ready",LOG_LEVEL_NOTICE);return false}if(this.settings.isConfigured){await this.migrationCheck();await this.migrateDisableBulkSend()}if(!this.settings.isConfigured)if(!await this.initialMessage()||!await this.askAgainForSetupURI()){this._log("The setup has been cancelled, Self-hosted LiveSync waiting for your setup!",LOG_LEVEL_NOTICE);return false}return true}},ModuleCheckRemoteSize=class extends AbstractModule{async $allScanStat(){var _a5;this._log("Checking storage sizes",LOG_LEVEL_VERBOSE);if(this.settings.notifyThresholdOfRemoteStorageSize<0){const message="We can set a maximum database capacity warning, **to take action before running out of space on the remote storage**.\nDo you want to enable this?\n\n> [!MORE]-\n> - 0: Do not warn about storage size.\n>   This is recommended if you have enough space on the remote storage especially you have self-hosted. And you can check the storage size and rebuild manually.\n> - 800: Warn if the remote storage size exceeds 800MB.\n>   This is recommended if you are using fly.io with 1GB limit or IBM Cloudant.\n> - 2000: Warn if the remote storage size exceeds 2GB.\n\nIf we have reached the limit, we will be asked to enlarge the limit step by step.\n",ANSWER_0="No, never warn please",ANSWER_800="800MB (Cloudant, fly.io)",ANSWER_2000="2GB (Standard)",ASK_ME_NEXT_TIME="Ask me later",ret=await this.core.confirm.askSelectStringDialogue(message,[ANSWER_0,ANSWER_800,ANSWER_2000,ASK_ME_NEXT_TIME],{defaultAction:ASK_ME_NEXT_TIME,title:"Setting up database size notification",timeout:40});if(ret==ANSWER_0){this.settings.notifyThresholdOfRemoteStorageSize=0;await this.core.saveSettings()}else if(ret==ANSWER_800){this.settings.notifyThresholdOfRemoteStorageSize=800;await this.core.saveSettings()}else if(ret==ANSWER_2000){this.settings.notifyThresholdOfRemoteStorageSize=2e3;await this.core.saveSettings()}}if(this.settings.notifyThresholdOfRemoteStorageSize>0){const remoteStat=await(null==(_a5=this.core.replicator)?void 0:_a5.getRemoteStatus(this.settings));if(remoteStat){const estimatedSize=remoteStat.estimatedSize;if(estimatedSize){const maxSize=1024*this.settings.notifyThresholdOfRemoteStorageSize*1024;if(estimatedSize>maxSize){const message=`**Your database is getting larger!** But do not worry, we can address it now. The time before running out of space on the remote storage.\n\n| Measured size | Configured size |\n| --- | --- |\n| ${sizeToHumanReadable2(estimatedSize)} | ${sizeToHumanReadable2(maxSize)} |\n\n> [!MORE]-\n> If you have been using it for many years, there may be unreferenced chunks - that is, garbage - accumulating in the database. Therefore, we recommend rebuilding everything. It will probably become much smaller.\n> \n> If the volume of your vault is simply increasing, it is better to rebuild everything after organizing the files. Self-hosted LiveSync does not delete the actual data even if you delete it to speed up the process. It is roughly [documented](https://github.com/vrtmrz/obsidian-livesync/blob/main/docs/tech_info.md).\n> \n> If you don't mind the increase, you can increase the notification limit by 100MB. This is the case if you are running it on your own server. However, it is better to rebuild everything from time to time.\n> \n\n> [!WARNING]\n> If you perform rebuild everything, make sure all devices are synchronised. The plug-in will merge as much as possible, though.\n\n\n`,ANSWER_ENLARGE_LIMIT=`increase to ${100+~~(estimatedSize/1024/1024)}MB`,ANSWER_REBUILD="Rebuild Everything Now",ANSWER_IGNORE="Dismiss",ret=await this.core.confirm.askSelectStringDialogue(message,[ANSWER_ENLARGE_LIMIT,ANSWER_REBUILD,ANSWER_IGNORE],{defaultAction:ANSWER_IGNORE,title:"Remote storage size exceeded the limit",timeout:60});if(ret==ANSWER_REBUILD){if("yes"==await this.core.confirm.askYesNoDialog("This may take a bit of a long time. Do you really want to rebuild everything now?",{defaultOption:"No"})){this.core.settings.notifyThresholdOfRemoteStorageSize=-1;await this.saveSettings();await this.core.rebuilder.scheduleRebuild()}}else if(ret==ANSWER_ENLARGE_LIMIT){this.settings.notifyThresholdOfRemoteStorageSize=100+~~(estimatedSize/1024/1024);this._log(`Threshold has been enlarged to ${this.settings.notifyThresholdOfRemoteStorageSize}MB`,LOG_LEVEL_NOTICE);await this.core.saveSettings()}this._log(`Remote storage size: ${sizeToHumanReadable2(estimatedSize)} exceeded ${sizeToHumanReadable2(1024*this.settings.notifyThresholdOfRemoteStorageSize*1024)} `,LOG_LEVEL_INFO)}else this._log(`Remote storage size: ${sizeToHumanReadable2(estimatedSize)}`,LOG_LEVEL_INFO)}}}return true}},import_diff_match_patch4=__toESM(require_diff_match_patch(),1),ModuleConflictResolver=class extends AbstractModule{async $$resolveConflictByDeletingRev(path2,deleteRevision,subTitle=""){const title=`Resolving ${subTitle?`[${subTitle}]`:""}:`;if(!await this.core.fileHandler.deleteRevisionFromDB(path2,deleteRevision)){this._log(`${title} Could not delete conflicted revision ${displayRev(deleteRevision)} of ${path2}`,LOG_LEVEL_NOTICE);return MISSING_OR_ERROR}this._log(`${title} Conflicted revision deleted ${displayRev(deleteRevision)} ${path2}`,LOG_LEVEL_INFO);if(0!=(await this.core.databaseFileAccess.getConflictedRevs(path2)).length){this._log(`${title} some conflicts are left in ${path2}`,LOG_LEVEL_INFO);return AUTO_MERGED}if(!await this.core.fileHandler.dbToStorage(path2,stripAllPrefixes(path2),true)){this._log(`Could not write the resolved content to the storage: ${path2}`,LOG_LEVEL_NOTICE);return MISSING_OR_ERROR}this._log(`${path2} Has been merged automatically`,LOG_LEVEL_NOTICE);return AUTO_MERGED}async checkConflictAndPerformAutoMerge(path2){const ret=await this.localDatabase.tryAutoMerge(path2,!this.settings.disableMarkdownAutoMerge);if("ok"in ret)return ret.ok;if("result"in ret){const p2=ret.result;if(!await this.core.databaseFileAccess.storeContent(path2,p2)){this._log(`Merged content cannot be stored:${path2}`,LOG_LEVEL_NOTICE);return MISSING_OR_ERROR}return await this.core.$$resolveConflictByDeletingRev(path2,ret.conflictedRev,"Sensible")}const{rightRev,leftLeaf,rightLeaf}=ret;if(false==leftLeaf){this._log(`could not get current revisions:${path2}`,LOG_LEVEL_NOTICE);return MISSING_OR_ERROR}if(false==rightLeaf)return await this.core.$$resolveConflictByDeletingRev(path2,rightRev,"MISSING OLD REV");const isSame=leftLeaf.data==rightLeaf.data&&leftLeaf.deleted==rightLeaf.deleted,isBinary=!isPlainText(path2),alwaysNewer=this.settings.resolveConflictsByNewerFile;if(isSame||isBinary||alwaysNewer){let loser=leftLeaf;if(compareMTime(leftLeaf.mtime,rightLeaf.mtime)!=TARGET_IS_NEW)loser=rightLeaf;const subTitle=[isSame?"same":"",isBinary?"binary":"",alwaysNewer?"alwaysNewer":""].join(",");return await this.core.$$resolveConflictByDeletingRev(path2,loser.rev,subTitle)}const dmp=new import_diff_match_patch4.default,diff=dmp.diff_main(leftLeaf.data,rightLeaf.data);dmp.diff_cleanupSemantic(diff);this._log(`conflict(s) found:${path2}`);return{left:leftLeaf,right:rightLeaf,diff}}async $$resolveConflict(filename){return await serialized(`conflict-resolve:${filename}`,(async()=>{const conflictCheckResult=await this.checkConflictAndPerformAutoMerge(filename);if(conflictCheckResult!==MISSING_OR_ERROR&&conflictCheckResult!==NOT_CONFLICTED&&conflictCheckResult!==CANCELLED)if(conflictCheckResult!==AUTO_MERGED){if(this.settings.showMergeDialogOnlyOnActive){const af2=this.core.$$getActiveFilePath();if(af2&&af2!=filename){this._log(`[conflict] ${filename} is conflicted. Merging process has been postponed to the file have got opened.`,LOG_LEVEL_NOTICE);return}}this._log("[conflict] Manual merge required!");await this.core.$anyResolveConflictByUI(filename,conflictCheckResult)}else{if(this.settings.syncAfterMerge&&!this.core.$$isSuspended())await this.core.$$waitForReplicationOnce();this._log("[conflict] Automatically merged, but we have to check it again");await this.core.$$queueConflictCheck(filename)}else this._log(`[conflict] Not conflicted or cancelled: ${filename}`,LOG_LEVEL_VERBOSE)}))}async $anyResolveConflictByNewest(filename){const revs=await this.core.databaseFileAccess.getConflictedRevs(filename);if(0==revs.length)return Promise.resolve(true);const mTimeAndRev=(await Promise.all(revs.map((async rev3=>{const leaf=await this.core.databaseFileAccess.fetchEntryMeta(filename,rev3);if(false==leaf)return[0,rev3];else return[leaf.mtime,rev3]})))).sort(((a2,b3)=>b3[0]-a2[0]));this._log(`Resolving conflict by newest: ${filename} (Newest: ${new Date(mTimeAndRev[0][0]).toLocaleString()}) (${mTimeAndRev.length} revisions exists)`);for(let i2=1;i2<mTimeAndRev.length;i2++){this._log(`conflict: Deleting the older revision ${mTimeAndRev[i2][1]} (${new Date(mTimeAndRev[i2][0]).toLocaleString()}) of ${filename}`);await this.core.$$resolveConflictByDeletingRev(filename,mTimeAndRev[i2][1],"NEWEST")}return true}},ModuleInteractiveConflictResolver=class extends AbstractObsidianModule{$everyOnloadStart(){this.addCommand({id:"livesync-conflictcheck",name:"Pick a file to resolve conflict",callback:async()=>{await this.pickFileForResolve()}});this.addCommand({id:"livesync-all-conflictcheck",name:"Resolve all conflicted files",callback:async()=>{await this.allConflictCheck()}});return Promise.resolve(true)}async $anyResolveConflictByUI(filename,conflictCheckResult){this._log("Merge:open conflict dialog",LOG_LEVEL_VERBOSE);const dialog=new ConflictResolveModal(this.app,filename,conflictCheckResult);dialog.open();const selected=await dialog.waitForResult();if(selected===CANCELLED){this._log(`Merge: Cancelled ${filename}`,LOG_LEVEL_INFO);return false}const testDoc=await this.localDatabase.getDBEntry(filename,{conflicts:true},false,true,true);if(false===testDoc){this._log(`Merge: Could not read ${filename} from the local database`,LOG_LEVEL_VERBOSE);return false}if(!testDoc._conflicts){this._log(`Merge: Nothing to do ${filename}`,LOG_LEVEL_VERBOSE);return false}const toDelete=selected;if(toDelete===LEAVE_TO_SUBSEQUENT){const p2=conflictCheckResult.diff.map((e4=>e4[1])).join(""),delRev=testDoc._conflicts[0];if(!await this.core.databaseFileAccess.storeContent(filename,p2)){this._log(`Concatenated content cannot be stored:${filename}`,LOG_LEVEL_NOTICE);return false}if(await this.core.$$resolveConflictByDeletingRev(filename,delRev,"UI Concatenated")==MISSING_OR_ERROR){this._log(`Concatenated saved, but cannot delete conflicted revisions: ${filename}, (${displayRev(delRev)})`,LOG_LEVEL_NOTICE);return false}}else if("string"==typeof toDelete){if(await this.core.$$resolveConflictByDeletingRev(filename,toDelete,"UI Selected")==MISSING_OR_ERROR){this._log(`Merge: Something went wrong: ${filename}, (${toDelete})`,LOG_LEVEL_NOTICE);return false}}else{this._log(`Merge: Something went wrong: ${filename}, (${toDelete})`,LOG_LEVEL_NOTICE);return false}if(this.settings.syncAfterMerge&&!this.core.$$isSuspended())await this.core.$$waitForReplicationOnce();await this.core.$$queueConflictCheck(filename);return false}async allConflictCheck(){for(;await this.pickFileForResolve(););}async pickFileForResolve(){const notes=[];for await(const doc of this.localDatabase.findAllDocs({conflicts:true}))if("_conflicts"in doc)notes.push({id:doc._id,path:getPath2(doc),dispPath:getPathWithoutPrefix2(doc),mtime:doc.mtime});notes.sort(((a2,b3)=>b3.mtime-a2.mtime));const notesList=notes.map((e4=>e4.dispPath));if(0==notesList.length){this._log("There are no conflicted documents",LOG_LEVEL_NOTICE);return false}const target=await this.core.confirm.askSelectString("File to resolve conflict",notesList);if(target){const targetItem=notes.find((e4=>e4.dispPath==target));await this.core.$$queueConflictCheck(targetItem.path);await this.core.$$waitForAllConflictProcessed();return true}return false}async $allScanStat(){const notes=[];this._log("Checking conflicted files",LOG_LEVEL_VERBOSE);for await(const doc of this.localDatabase.findAllDocs({conflicts:true}))if("_conflicts"in doc)notes.push({path:getPath2(doc),mtime:doc.mtime});if(notes.length>0){this.core.confirm.askInPopup("conflicting-detected-on-safety",'Some files have been left conflicted! Press {HERE} to resolve them, or you can do it later by "Pick a file to resolve conflict',(anchor=>{anchor.text="HERE";anchor.addEventListener("click",(()=>{fireAndForget((()=>this.allConflictCheck()))}))}));this._log('Some files have been left conflicted! Please resolve them by "Pick a file to resolve conflict". The list is written in the log.',LOG_LEVEL_VERBOSE);for(const note of notes)this._log(`Conflicted: ${note.path}`)}else this._log("There are no conflicting files",LOG_LEVEL_VERBOSE);return true}},ModuleObsidianSettings=class extends AbstractObsidianModule{constructor(){super(...arguments);this.usedPassphrase=""}getPassphrase(settings){const methods={"":()=>Promise.resolve("*"),LOCALSTORAGE:()=>{var _a5;return Promise.resolve(null!=(_a5=localStorage.getItem("ls-setting-passphrase"))?_a5:false)},ASK_AT_LAUNCH:()=>this.core.confirm.askString("Passphrase","passphrase","")},method=settings.configPassphraseStore;return(method in methods?methods[method]:methods[""])()}$$saveDeviceAndVaultName(){const lsKey="obsidian-live-sync-vaultanddevicename-"+this.core.$$getVaultName();localStorage.setItem(lsKey,this.core.$$getDeviceAndVaultName()||"")}$$clearUsedPassphrase(){this.usedPassphrase=""}async decryptConfigurationItem(encrypted,passphrase){const dec=await tryDecrypt(encrypted,passphrase+SALT_OF_PASSPHRASE,false);if(dec){this.usedPassphrase=passphrase;return dec}return false}async encryptConfigurationItem(src,settings){if(""!=this.usedPassphrase)return await encrypt(src,this.usedPassphrase+SALT_OF_PASSPHRASE,false);const passphrase=await this.getPassphrase(settings);if(false===passphrase){this._log("Failed to obtain passphrase when saving data.json! Please verify the configuration.",LOG_LEVEL_URGENT);return""}const dec=await encrypt(src,passphrase+SALT_OF_PASSPHRASE,false);if(dec){this.usedPassphrase=passphrase;return dec}return""}get appId(){return`${"appId"in this.app?this.app.appId:""}`}async $$saveSettingData(){this.core.$$saveDeviceAndVaultName();const settings={...this.settings};settings.deviceAndVaultName="";if(""==this.usedPassphrase&&!await this.getPassphrase(settings))this._log("Failed to retrieve passphrase. data.json contains unencrypted items!",LOG_LEVEL_NOTICE);else{if(""!=settings.couchDB_PASSWORD||""!=settings.couchDB_URI||""!=settings.couchDB_USER||settings.couchDB_DBNAME){const connectionSetting={couchDB_DBNAME:settings.couchDB_DBNAME,couchDB_PASSWORD:settings.couchDB_PASSWORD,couchDB_URI:settings.couchDB_URI,couchDB_USER:settings.couchDB_USER,accessKey:settings.accessKey,bucket:settings.bucket,endpoint:settings.endpoint,region:settings.region,secretKey:settings.secretKey,useCustomRequestHandler:settings.useCustomRequestHandler};settings.encryptedCouchDBConnection=await this.encryptConfigurationItem(JSON.stringify(connectionSetting),settings);settings.couchDB_PASSWORD="";settings.couchDB_DBNAME="";settings.couchDB_URI="";settings.couchDB_USER="";settings.accessKey="";settings.bucket="";settings.region="";settings.secretKey="";settings.endpoint=""}if(settings.encrypt&&""!=settings.passphrase){settings.encryptedPassphrase=await this.encryptConfigurationItem(settings.passphrase,settings);settings.passphrase=""}}await this.core.saveData(settings);eventHub.emitEvent(EVENT_SETTING_SAVED,settings)}tryDecodeJson(encoded){try{if(!encoded)return false;else return JSON.parse(encoded)}catch(e4){return false}}async $$loadSettings(){const settings=Object.assign({},DEFAULT_SETTINGS,await this.core.loadData());if("undefined"==typeof settings.isConfigured)if(JSON.stringify(settings)!==JSON.stringify(DEFAULT_SETTINGS))settings.isConfigured=true;else{settings.additionalSuffixOfDatabaseName=this.appId;settings.isConfigured=false}const passphrase=await this.getPassphrase(settings);if(false===passphrase)this._log("No passphrase found for data.json! Verify configuration before syncing.",LOG_LEVEL_URGENT);else{if(settings.encryptedCouchDBConnection){const keys2=["couchDB_URI","couchDB_USER","couchDB_PASSWORD","couchDB_DBNAME","accessKey","bucket","endpoint","region","secretKey"],decrypted=this.tryDecodeJson(await this.decryptConfigurationItem(settings.encryptedCouchDBConnection,passphrase));if(decrypted){for(const key2 of keys2)if(key2 in decrypted)settings[key2]=decrypted[key2]}else{this._log("Failed to decrypt passphrase from data.json! Ensure configuration is correct before syncing with remote.",LOG_LEVEL_URGENT);for(const key2 of keys2)settings[key2]=""}}if(settings.encrypt&&settings.encryptedPassphrase){const encrypted=settings.encryptedPassphrase,decrypted=await this.decryptConfigurationItem(encrypted,passphrase);if(decrypted)settings.passphrase=decrypted;else{this._log("Failed to decrypt passphrase from data.json! Ensure configuration is correct before syncing with remote.",LOG_LEVEL_URGENT);settings.passphrase=""}}}this.settings=settings;setLang(this.settings.displayLanguage);if("workingEncrypt"in this.settings)delete this.settings.workingEncrypt;if("workingPassphrase"in this.settings)delete this.settings.workingPassphrase;this.settings.disableRequestURI=true;this.settings.gcDelay=0;this.settings.useHistory=true;const lsKey="obsidian-live-sync-vaultanddevicename-"+this.core.$$getVaultName();if(""!=this.settings.deviceAndVaultName)if(!localStorage.getItem(lsKey)){this.core.$$setDeviceAndVaultName(this.settings.deviceAndVaultName);this.$$saveDeviceAndVaultName();this.settings.deviceAndVaultName=""}if(isCloudantURI(this.settings.couchDB_URI)&&0!=this.settings.customChunkSize){this._log("Configuration issues detected and automatically resolved. However, unsynchronized data may exist. Consider rebuilding if necessary.",LOG_LEVEL_NOTICE);this.settings.customChunkSize=0}this.core.$$setDeviceAndVaultName(localStorage.getItem(lsKey)||"");if(""==this.core.$$getDeviceAndVaultName())if(this.settings.usePluginSync){this._log("Device name missing. Disabling plug-in sync.",LOG_LEVEL_NOTICE);this.settings.usePluginSync=false}eventHub.emitEvent(EVENT_REQUEST_RELOAD_SETTING_TAB)}},ModuleRedFlag=class extends AbstractModule{constructor(){super(...arguments);this.isRedFlagRaised=async()=>await this.isFlagFileExist(FLAGMD_REDFLAG);this.isRedFlag2Raised=async()=>await this.isFlagFileExist(FLAGMD_REDFLAG2)||await this.isFlagFileExist(FLAGMD_REDFLAG2_HR);this.isRedFlag3Raised=async()=>await this.isFlagFileExist(FLAGMD_REDFLAG3)||await this.isFlagFileExist(FLAGMD_REDFLAG3_HR)}async isFlagFileExist(path2){if(await this.core.storageAccess.isExists(normalizePath(path2)))return true;else return false}async deleteFlagFile(path2){try{if(await this.core.storageAccess.isExists(normalizePath(path2)))await this.core.storageAccess.delete(path2,true)}catch(ex){this._log(`Could not delete ${path2}`);this._log(ex,LOG_LEVEL_VERBOSE)}}async deleteRedFlag2(){await this.deleteFlagFile(FLAGMD_REDFLAG2);await this.deleteFlagFile(FLAGMD_REDFLAG2_HR)}async deleteRedFlag3(){await this.deleteFlagFile(FLAGMD_REDFLAG3);await this.deleteFlagFile(FLAGMD_REDFLAG3_HR)}async $everyOnLayoutReady(){try{const isRedFlagRaised=await this.isRedFlagRaised(),isRedFlag2Raised=await this.isRedFlag2Raised(),isRedFlag3Raised=await this.isRedFlag3Raised();if(isRedFlagRaised||isRedFlag2Raised||isRedFlag3Raised){if(isRedFlag2Raised)if("yes"!==await this.core.confirm.askYesNoDialog("Rebuild everything has been scheduled! Are you sure to rebuild everything?",{defaultOption:"Yes",timeout:0})){await this.deleteRedFlag2();await this.core.$$performRestart();return false}if(isRedFlag3Raised)if("yes"!==await this.core.confirm.askYesNoDialog("Fetch again has been scheduled! Are you sure?",{defaultOption:"Yes",timeout:0})){await this.deleteRedFlag3();await this.core.$$performRestart();return false}this.settings.batchSave=false;await this.core.$allSuspendAllSync();await this.core.$allSuspendExtraSync();this.settings.suspendFileWatching=true;await this.saveSettings();if(isRedFlag2Raised){this._log(`${FLAGMD_REDFLAG2} or ${FLAGMD_REDFLAG2_HR} has been detected! Self-hosted LiveSync suspends all sync and rebuild everything.`,LOG_LEVEL_NOTICE);await this.core.rebuilder.$rebuildEverything();await this.deleteRedFlag2();if("yes"==await this.core.confirm.askYesNoDialog("Do you want to resume file and database processing, and restart obsidian now?",{defaultOption:"Yes",timeout:15})){this.settings.suspendFileWatching=false;await this.saveSettings();this.core.$$performRestart();return false}}else if(isRedFlag3Raised){this._log(`${FLAGMD_REDFLAG3} or ${FLAGMD_REDFLAG3_HR} has been detected! Self-hosted LiveSync will discard the local database and fetch everything from the remote once again.`,LOG_LEVEL_NOTICE);const makeLocalChunkBeforeSync="yes"==await this.core.confirm.askYesNoDialog("Do you want to create local chunks before fetching? \n> [!MORE]-\n> If creating local chunks before fetching, only the difference between the local and remote will be fetched.\n\n",{defaultOption:"Yes",title:"Trick to transfer efficiently"});await this.core.rebuilder.$fetchLocal(makeLocalChunkBeforeSync);await this.deleteRedFlag3();if(this.settings.suspendFileWatching){if("yes"==await this.core.confirm.askYesNoDialog("Do you want to resume file and database processing, and restart obsidian now?",{defaultOption:"Yes",timeout:15})){this.settings.suspendFileWatching=false;await this.saveSettings();this.core.$$performRestart();return false}}else this._log("Your content of files will be synchronised gradually. Please wait for the completion.",LOG_LEVEL_NOTICE)}else{this.settings.writeLogToTheFile=true;const warningMessage="The red flag is raised! The whole initialize steps are skipped, and any file changes are not captured.";this._log(warningMessage,LOG_LEVEL_NOTICE)}}}catch(ex){this._log("Something went wrong on FlagFile Handling",LOG_LEVEL_NOTICE);this._log(ex,LOG_LEVEL_VERBOSE)}return true}},ModuleObsidianMenu=class extends AbstractObsidianModule{$everyOnloadStart(){(0,import_obsidian.addIcon)("replicate",'<g transform="matrix(1.15 0 0 1.15 -8.31 -9.52)" fill="currentColor" fill-rule="evenodd">\n            <path d="m85 22.2c-0.799-4.74-4.99-8.37-9.88-8.37-0.499 0-1.1 0.101-1.6 0.101-2.4-3.03-6.09-4.94-10.3-4.94-6.09 0-11.2 4.14-12.8 9.79-5.59 1.11-9.78 6.05-9.78 12 0 6.76 5.39 12.2 12 12.2h29.9c5.79 0 10.1-4.74 10.1-10.6 0-4.84-3.29-8.88-7.68-10.2zm-2.99 14.7h-29.5c-2.3-0.202-4.29-1.51-5.29-3.53-0.899-2.12-0.699-4.54 0.698-6.46 1.2-1.61 2.99-2.52 4.89-2.52 0.299 0 0.698 0 0.998 0.101l1.8 0.303v-2.02c0-3.63 2.4-6.76 5.89-7.57 0.599-0.101 1.2-0.202 1.8-0.202 2.89 0 5.49 1.62 6.79 4.24l0.598 1.21 1.3-0.504c0.599-0.202 1.3-0.303 2-0.303 1.3 0 2.5 0.404 3.59 1.11 1.6 1.21 2.6 3.13 2.6 5.15v1.61h2c2.6 0 4.69 2.12 4.69 4.74-0.099 2.52-2.2 4.64-4.79 4.64z"/>\n            <path d="m53.2 49.2h-41.6c-1.8 0-3.2 1.4-3.2 3.2v28.6c0 1.8 1.4 3.2 3.2 3.2h15.8v4h-7v6h24v-6h-7v-4h15.8c1.8 0 3.2-1.4 3.2-3.2v-28.6c0-1.8-1.4-3.2-3.2-3.2zm-2.8 29h-36v-23h36z"/>\n            <path d="m73 49.2c1.02 1.29 1.53 2.97 1.53 4.56 0 2.97-1.74 5.65-4.39 7.04v-4.06l-7.46 7.33 7.46 7.14v-4.06c7.66-1.98 12.2-9.61 10-17-0.102-0.297-0.205-0.595-0.307-0.892z"/>\n            <path d="m24.1 43c-0.817-0.991-1.53-2.97-1.53-4.56 0-2.97 1.74-5.65 4.39-7.04v4.06l7.46-7.33-7.46-7.14v4.06c-7.66 1.98-12.2 9.61-10 17 0.102 0.297 0.205 0.595 0.307 0.892z"/>\n           </g>');this.addRibbonIcon("replicate","Replicate",(async()=>{await this.core.$$replicate(true)})).addClass("livesync-ribbon-replicate");this.addCommand({id:"livesync-replicate",name:"Replicate now",callback:async()=>{await this.core.$$replicate()}});this.addCommand({id:"livesync-dump",name:"Dump information of this doc ",callback:()=>{const file=this.core.$$getActiveFilePath();if(file)fireAndForget((()=>this.localDatabase.getDBEntry(file,{},true,false)))}});this.addCommand({id:"livesync-checkdoc-conflicted",name:"Resolve if conflicted.",editorCallback:(editor,view)=>{const file=view.file;if(file)this.core.$$queueConflictCheckIfOpen(file.path)}});this.addCommand({id:"livesync-toggle",name:"Toggle LiveSync",callback:async()=>{if(this.settings.liveSync){this.settings.liveSync=false;this._log("LiveSync Disabled.",LOG_LEVEL_NOTICE)}else{this.settings.liveSync=true;this._log("LiveSync Enabled.",LOG_LEVEL_NOTICE)}await this.core.$$realizeSettingSyncMode();await this.core.$$saveSettingData()}});this.addCommand({id:"livesync-suspendall",name:"Toggle All Sync.",callback:async()=>{if(this.core.$$isSuspended()){this.core.$$setSuspended(false);this._log("Self-hosted LiveSync resumed",LOG_LEVEL_NOTICE)}else{this.core.$$setSuspended(true);this._log("Self-hosted LiveSync suspended",LOG_LEVEL_NOTICE)}await this.core.$$realizeSettingSyncMode();await this.core.$$saveSettingData()}});this.addCommand({id:"livesync-scan-files",name:"Scan storage and database again",callback:async()=>{await this.core.$$performFullScan(true)}});this.addCommand({id:"livesync-runbatch",name:"Run pended batch processes",callback:async()=>{await this.core.$everyCommitPendingFileEvent()}});this.addCommand({id:"livesync-abortsync",name:"Abort synchronization immediately",callback:()=>{this.core.replicator.terminateSync()}});return Promise.resolve(true)}$everyOnload(){this.app.workspace.onLayoutReady(this.core.$$onLiveSyncReady.bind(this.core));return Promise.resolve(true)}async $$showView(viewType){const leaves=this.app.workspace.getLeavesOfType(viewType);if(0==leaves.length)await this.app.workspace.getLeaf(true).setViewState({type:viewType,active:true});else await leaves[0].setViewState({type:viewType,active:true});if(leaves.length>0)this.app.workspace.revealLeaf(leaves[0])}},ModuleSetupObsidian=class extends AbstractObsidianModule{$everyOnload(){this.registerObsidianProtocolHandler("setuplivesync",(async conf=>await this.setupWizard(conf.settings)));this.addCommand({id:"livesync-copysetupuri",name:"Copy settings as a new setup URI",callback:()=>fireAndForget(this.command_copySetupURI())});this.addCommand({id:"livesync-copysetupuri-short",name:"Copy settings as a new setup URI (With customization sync)",callback:()=>fireAndForget(this.command_copySetupURIWithSync())});this.addCommand({id:"livesync-copysetupurifull",name:"Copy settings as a new setup URI (Full)",callback:()=>fireAndForget(this.command_copySetupURIFull())});this.addCommand({id:"livesync-opensetupuri",name:"Use the copied setup URI (Formerly Open setup URI)",callback:()=>fireAndForget(this.command_openSetupURI())});eventHub.onEvent(EVENT_REQUEST_OPEN_SETUP_URI,(()=>fireAndForget((()=>this.command_openSetupURI()))));eventHub.onEvent(EVENT_REQUEST_COPY_SETUP_URI,(()=>fireAndForget((()=>this.command_copySetupURI()))));return Promise.resolve(true)}async command_copySetupURI(stripExtra=true){const encryptingPassphrase=await this.core.confirm.askString("Encrypt your settings","The passphrase to encrypt the setup URI","",true);if(false===encryptingPassphrase)return;const setting={...this.settings,configPassphraseStore:"",encryptedCouchDBConnection:"",encryptedPassphrase:""};if(stripExtra)delete setting.pluginSyncExtendedSetting;const keys2=Object.keys(setting);for(const k2 of keys2)if(JSON.stringify(k2 in setting?setting[k2]:"")==JSON.stringify(k2 in DEFAULT_SETTINGS?DEFAULT_SETTINGS[k2]:"*"))delete setting[k2];const encryptedSetting=encodeURIComponent(await encrypt(JSON.stringify(setting),encryptingPassphrase,false)),uri=`${configURIBase}${encryptedSetting}`;await navigator.clipboard.writeText(uri);this._log("Setup URI copied to clipboard",LOG_LEVEL_NOTICE)}async command_copySetupURIFull(){const encryptingPassphrase=await this.core.confirm.askString("Encrypt your settings","The passphrase to encrypt the setup URI","",true);if(false===encryptingPassphrase)return;const setting={...this.settings,configPassphraseStore:"",encryptedCouchDBConnection:"",encryptedPassphrase:""},encryptedSetting=encodeURIComponent(await encrypt(JSON.stringify(setting),encryptingPassphrase,false)),uri=`${configURIBase}${encryptedSetting}`;await navigator.clipboard.writeText(uri);this._log("Setup URI copied to clipboard",LOG_LEVEL_NOTICE)}async command_copySetupURIWithSync(){await this.command_copySetupURI(false)}async command_openSetupURI(){const setupURI=await this.core.confirm.askString("Easy setup","Set up URI",`${configURIBase}aaaaa`);if(false===setupURI)return;if(!setupURI.startsWith(`${configURIBase}`)){this._log("Set up URI looks wrong.",LOG_LEVEL_NOTICE);return}const config=decodeURIComponent(setupURI.substring(configURIBase.length));console.dir(config);await this.setupWizard(config)}async setupWizard(confString){try{const oldConf=JSON.parse(JSON.stringify(this.settings)),encryptingPassphrase=await this.core.confirm.askString("Passphrase","The passphrase to decrypt your setup URI","",true);if(false===encryptingPassphrase)return;const newConf=await JSON.parse(await decrypt(confString,encryptingPassphrase,false));if(newConf){if("yes"==await this.core.confirm.askYesNoDialog("Importing Configuration from the Setup-URI. Are you sure to proceed?",{})){const newSettingW=Object.assign({},DEFAULT_SETTINGS,newConf);this.core.replicator.closeReplication();this.settings.suspendFileWatching=true;console.dir(newSettingW);newSettingW.configPassphraseStore="";newSettingW.encryptedPassphrase="";newSettingW.encryptedCouchDBConnection="";newSettingW.additionalSuffixOfDatabaseName=`${"appId"in this.app?this.app.appId:""}`;const setupJustImport="Don't sync anything, just apply the settings.",setupAsNew="This is a new client - sync everything from the remote server.",setupAsMerge="This is an existing client - merge existing files with the server.",setupAgain="Initialise new server data - ideal for new or broken servers.",setupManually="Continue and configure manually.";newSettingW.syncInternalFiles=false;newSettingW.usePluginSync=false;newSettingW.isConfigured=true;if(!newSettingW.useIndexedDBAdapter)newSettingW.useIndexedDBAdapter=true;const setupType=await this.core.confirm.askSelectStringDialogue("How would you like to set it up?",[setupAsNew,setupAgain,setupAsMerge,setupJustImport,setupManually],{defaultAction:setupAsNew});if(setupType==setupJustImport){this.core.settings=newSettingW;this.core.$$clearUsedPassphrase();await this.core.saveSettings()}else if(setupType==setupAsNew){this.core.settings=newSettingW;this.core.$$clearUsedPassphrase();await this.core.rebuilder.$fetchLocal()}else if(setupType==setupAsMerge){this.core.settings=newSettingW;this.core.$$clearUsedPassphrase();await this.core.rebuilder.$fetchLocal(true)}else if(setupType==setupAgain){const confirm="This operation will rebuild all databases with files on this device. Any files on the remote database not synced here will be lost.";if(await this.core.confirm.askSelectStringDialogue("Are you sure you want to do this?",["Cancel",confirm],{defaultAction:"Cancel"})!=confirm)return;this.core.settings=newSettingW;this.core.$$clearUsedPassphrase();await this.core.rebuilder.$rebuildEverything()}else if(setupType==setupManually){const keepLocalDB=await this.core.confirm.askYesNoDialog("Keep local DB?",{defaultOption:"No"}),keepRemoteDB=await this.core.confirm.askYesNoDialog("Keep remote DB?",{defaultOption:"No"});if("yes"==keepLocalDB&&"yes"==keepRemoteDB){this.core.settings=newSettingW;this.core.$$clearUsedPassphrase();await this.core.$allSuspendAllSync();await this.core.$allSuspendExtraSync();await this.core.saveSettings();if("yes"==await this.core.confirm.askYesNoDialog("Unlock and replicate?",{defaultOption:"Yes"})){await this.core.$$replicate(true);await this.core.$$markRemoteUnlocked()}this._log("Configuration loaded.",LOG_LEVEL_NOTICE);return}if("no"==keepLocalDB&&"no"==keepRemoteDB)if("yes"!=await this.core.confirm.askYesNoDialog("Drop everything?",{defaultOption:"No"})){this._log("Cancelled",LOG_LEVEL_NOTICE);this.core.settings=oldConf;return}let initDB;this.core.settings=newSettingW;this.core.$$clearUsedPassphrase();await this.core.saveSettings();if("no"==keepLocalDB){await this.core.$$resetLocalDatabase();await this.core.localDatabase.initializeDatabase();if("yes"==await this.core.confirm.askYesNoDialog("Rebuild the database?",{defaultOption:"Yes"}))initDB=this.core.$$initializeDatabase(true);else await this.core.$$markRemoteResolved()}if("no"==keepRemoteDB){await this.core.$$tryResetRemoteDatabase();await this.core.$$markRemoteLocked()}if("no"==keepLocalDB||"no"==keepRemoteDB)if("yes"==await this.core.confirm.askYesNoDialog("Replicate once?",{defaultOption:"Yes"})){if(null!=initDB)await initDB;await this.core.$$replicate(true)}}}this._log("Configuration loaded.",LOG_LEVEL_NOTICE)}else this._log("Cancelled.",LOG_LEVEL_NOTICE)}catch(ex){this._log("Couldn't parse or decrypt configuration uri.",LOG_LEVEL_NOTICE);this._log(ex,LOG_LEVEL_VERBOSE)}}},ModuleDatabaseFileAccess=class extends AbstractModule{$everyOnload(){this.core.databaseFileAccess=this;return Promise.resolve(true)}async $everyModuleTest(){if(!this.settings.enableDebugTools)return Promise.resolve(true);const testString="Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam nec purus nec nunc",conflicts=await this.getConflictedRevs("autoTest.md");for(const rev3 of conflicts)await this.delete("autoTest.md",rev3);await this.delete("autoTest.md");await this._test("storeContent",(async()=>await this.storeContent("autoTest.md",testString)));await this.localDatabase.hashCaches.clear();await this._test("readContent",(async()=>{const content=await this.fetch("autoTest.md");if(!content)return"File not found";if(content.deleted)return"File is deleted";else return await content.body.text()==testString?true:`Content is not same ${await content.body.text()}`}));await this._test("delete",(async()=>await this.delete("autoTest.md")));await this._test("read deleted content",(async()=>{const content=await this.fetch("autoTest.md");if(!content)return true;if(content.deleted)return true;else return`Still exist !:${await content.body.text()},${JSON.stringify(content,void 0,2)}`}));await delay(100);return this.testDone()}async checkIsTargetFile(file){const path2=getStoragePathFromUXFileInfo(file);if(!await this.core.$$isTargetFile(path2)){this._log("File is not target",LOG_LEVEL_VERBOSE);return false}if(shouldBeIgnored(path2)){this._log("File should be ignored",LOG_LEVEL_VERBOSE);return false}return true}async delete(file,rev3){if(!await this.checkIsTargetFile(file))return true;const fullPath=getDatabasePathFromUXFileInfo(file);try{this._log(`deleteDB By path:${fullPath}`);return await this.deleteFromDBbyPath(fullPath,rev3)}catch(ex){this._log(`Failed to delete ${fullPath}`);this._log(ex,LOG_LEVEL_VERBOSE);return false}}async createChunks(file,force=false,skipCheck){return await this._store(file,force,skipCheck,true)}async store(file,force=false,skipCheck){return await this._store(file,force,skipCheck,false)}async storeContent(path2,content){const blob=createTextBlob(content),bytes=(await blob.arrayBuffer()).byteLength,isInternal=path2.startsWith(".")?true:void 0,dummyUXFileInfo={name:path2.split("/").pop(),path:path2,stat:{size:bytes,ctime:Date.now(),mtime:Date.now(),type:"file"},body:blob,isInternal};return await this._store(dummyUXFileInfo,true,false,false)}async _store(file,force=false,skipCheck,onlyChunks){if(!skipCheck)if(!await this.checkIsTargetFile(file))return true;if(!file){this._log("File seems bad",LOG_LEVEL_VERBOSE);return false}const possiblyLarge=!isPlainText(file.name),content=file.body,datatype=determineTypeFromBlob(content),idPrefix=file.isInternal?ICHeader:"",fullPath=getStoragePathFromUXFileInfo(file),fullPathOnDB=getDatabasePathFromUXFileInfo(file);if(possiblyLarge)this._log(`Processing: ${fullPath}`,LOG_LEVEL_VERBOSE);if(file.isInternal)if(file.deleted)file.stat={size:0,ctime:Date.now(),mtime:Date.now(),type:"file"};else if(null==file.stat){const stat=await this.core.storageAccess.statHidden(file.path);if(!stat){this._log(`Internal file not found: ${fullPath}`,LOG_LEVEL_VERBOSE);return false}file.stat=stat}const d4={_id:idPrefix+await this.core.$$path2id(fullPath),path:fullPathOnDB,data:content,ctime:file.stat.ctime,mtime:file.stat.mtime,size:file.stat.size,children:[],datatype,type:datatype,eden:{}},msg=`STORAGE -> DB (${datatype}) `;if(await serialized("file-"+fullPath,(async()=>{if(force){this._log(msg+"Force writing "+fullPath,LOG_LEVEL_VERBOSE);return false}try{const old=await this.localDatabase.getDBEntry(d4.path,void 0,false,true,false);if(false!==old){const oldData={data:old.data,deleted:old._deleted||old.deleted},newData={data:d4.data,deleted:d4._deleted||d4.deleted};if(oldData.deleted!=newData.deleted)return false;if(!await isDocContentSame(old.data,newData.data))return false;this._log(msg+"Skipped (not changed) "+fullPath+(d4._deleted||d4.deleted?" (deleted)":""),LOG_LEVEL_VERBOSE);markChangesAreSame(old,d4.mtime,old.mtime);return true}}catch(ex){this._log(msg+"Error, Could not check the diff for the old one."+(force?"force writing.":"")+fullPath+(d4._deleted||d4.deleted?" (deleted)":""),LOG_LEVEL_VERBOSE);this._log(ex,LOG_LEVEL_VERBOSE);return!force}return false}))){this._log(msg+" Skip "+fullPath,LOG_LEVEL_VERBOSE);return true}const ret=await this.localDatabase.putDBEntry(d4,onlyChunks);if(false!==ret){this._log(msg+fullPath);eventHub.emitEvent(EVENT_FILE_SAVED)}return false!=ret}async getConflictedRevs(file){if(!await this.checkIsTargetFile(file))return[];const filename=getDatabasePathFromUXFileInfo(file),doc=await this.localDatabase.getDBEntryMeta(filename,{conflicts:true},true);if(false===doc)return[];else return doc._conflicts||[]}async fetch(file,rev3,waitForReady,skipCheck=false){if(skipCheck&&!await this.checkIsTargetFile(file))return false;const entry=await this.fetchEntry(file,rev3,waitForReady,true);if(false===entry)return false;const data=createBlob(readContent(entry)),path2=stripAllPrefixes(entry.path),fileInfo={name:path2.split("/").pop(),path:path2,stat:{size:entry.size,ctime:entry.ctime,mtime:entry.mtime,type:"file"},body:data,deleted:entry.deleted||entry._deleted};if(isInternalMetadata(entry.path))fileInfo.isInternal=true;return fileInfo}async fetchEntryMeta(file,rev3,skipCheck=false){const dbFileName=getDatabasePathFromUXFileInfo(file);if(skipCheck&&!await this.checkIsTargetFile(file))return false;const doc=await this.localDatabase.getDBEntryMeta(dbFileName,rev3?{rev:rev3}:void 0,true);if(false===doc)return false;else return doc}async fetchEntryFromMeta(meta,waitForReady=true,skipCheck=false){if(skipCheck&&!await this.checkIsTargetFile(meta.path))return false;const doc=await this.localDatabase.getDBEntryFromMeta(meta,void 0,false,waitForReady,true);if(false===doc)return false;else return doc}async fetchEntry(file,rev3,waitForReady=true,skipCheck=false){if(skipCheck&&!await this.checkIsTargetFile(file))return false;const entry=await this.fetchEntryMeta(file,rev3,true);if(false===entry)return false;else return await this.fetchEntryFromMeta(entry,waitForReady,true)}async deleteFromDBbyPath(fullPath,rev3){if(!await this.checkIsTargetFile(fullPath)){this._log(`storeFromStorage: File is not target: ${fullPath}`);return true}const opt=rev3?{rev:rev3}:void 0,ret=await this.localDatabase.deleteDBEntry(fullPath,opt);eventHub.emitEvent(EVENT_FILE_SAVED);return ret}},ModuleFileHandler=class extends AbstractModule{get db(){return this.core.databaseFileAccess}get storage(){return this.core.storageAccess}$everyOnloadStart(){this.core.fileHandler=this;return Promise.resolve(true)}async readFileFromStub(file){if("body"in file&&file.body)return file;const readFile=await this.storage.readStubContent(file);if(!readFile)throw new Error(`File ${file.path} is not exist on the storage`);return readFile}async storeFileToDB(info3,force=false,onlyChunks=false){const file="string"==typeof info3?this.storage.getFileStub(info3):info3;if(null==file){this._log(`File ${info3} is not exist on the storage`,LOG_LEVEL_VERBOSE);return false}if(file.isInternal){this._log(`Internal file ${file.path} is not allowed to be processed on processFileEvent`,LOG_LEVEL_VERBOSE);return false}const entry=await this.db.fetchEntry(file,void 0,true,true);if(!entry||entry.deleted||entry._deleted){const readFile=await this.readFileFromStub(file);if(!onlyChunks)return await this.db.store(readFile);else return await this.db.createChunks(readFile,false,true)}let shouldApplied=false;if(!force&&!onlyChunks){if(compareFileFreshness(file,entry)!==EVEN)shouldApplied=true;let readFile;if(!shouldApplied){readFile=await this.readFileFromStub(file);if(await isDocContentSame(getDocDataAsArray(entry.data),readFile.body))markChangesAreSame(file,file.stat.mtime,entry.mtime);else shouldApplied=true}if(!shouldApplied){this._log(`File ${file.path} is not changed`,LOG_LEVEL_VERBOSE);return true}if(!readFile)readFile=await this.readFileFromStub(file);if(onlyChunks)return await this.db.createChunks(readFile,false,true);else return await this.db.store(readFile,false,true)}else{const readFile=await this.readFileFromStub(file);if(onlyChunks)return await this.db.createChunks(readFile,true,true);else return await this.db.store(readFile,true,true)}}async deleteFileFromDB(info3){const file="string"==typeof info3?this.storage.getFileStub(info3):info3;if(null==file){this._log(`File ${info3} is not exist on the storage`,LOG_LEVEL_VERBOSE);return false}if(file.isInternal){this._log(`Internal file ${file.path} is not allowed to be processed on processFileEvent`,LOG_LEVEL_VERBOSE);return false}const entry=await this.db.fetchEntry(file,void 0,true,true);if(!entry||entry.deleted||entry._deleted){this._log(`File ${file.path} is not exist or already deleted on the database`,LOG_LEVEL_VERBOSE);return false}if((await this.db.getConflictedRevs(file)).length>0)return await this.db.delete(file,entry._rev);else return await this.db.delete(file)}async deleteRevisionFromDB(info3,rev3){return await this.db.delete(info3,rev3)}async resolveConflictedByDeletingRevision(info3,rev3){const path2=getStoragePathFromUXFileInfo(info3);if(!await this.deleteRevisionFromDB(info3,rev3)){this._log(`Failed to delete the conflicted revision ${rev3} of ${path2}`,LOG_LEVEL_VERBOSE);return false}if(!await this.dbToStorageWithSpecificRev(info3,rev3,true)){this._log(`Failed to apply the resolved revision ${rev3} of ${path2} to the storage`,LOG_LEVEL_VERBOSE);return false}}async dbToStorageWithSpecificRev(info3,rev3,force){const file="string"==typeof info3?this.storage.getFileStub(info3):info3;if(null==file){this._log(`File ${info3} is not exist on the storage`,LOG_LEVEL_VERBOSE);return false}const docEntry=await this.db.fetchEntryMeta(file,rev3,true);if(!docEntry){this._log(`File ${file.path} is not exist on the database`,LOG_LEVEL_VERBOSE);return false}return await this.dbToStorage(docEntry,file,force)}async dbToStorage(entryInfo,info3,force){const mode=null==("string"==typeof info3?this.storage.getFileStub(info3):info3)?"create":"modify",docEntry="string"==typeof entryInfo?await this.db.fetchEntryMeta(entryInfo,void 0,true):await this.db.fetchEntryMeta(entryInfo.path,void 0,true);if(!docEntry){this._log(`File ${entryInfo} is not exist on the database`,LOG_LEVEL_VERBOSE);return false}const path2=getPath2(docEntry);if((await this.db.getConflictedRevs(path2)).length>0)if(this.settings.writeDocumentsIfConflicted);else{await this.core.$$queueConflictCheckIfOpen(path2);return true}const existDoc=this.storage.getStub(path2);if(existDoc&&existDoc.isFolder){this._log(`Folder ${path2} is already exist on the storage as a folder`,LOG_LEVEL_VERBOSE);return true}const existOnDB=!(docEntry._deleted||docEntry.deleted||false),existOnStorage=null!=existDoc;if(!existOnDB&&!existOnStorage){this._log(`File ${path2} seems to be deleted, but already not on storage`,LOG_LEVEL_VERBOSE);return true}if(!existOnDB&&existOnStorage){await this.storage.deleteVaultItem(path2);return true}const docRead=await this.db.fetchEntryFromMeta(docEntry);if(!docRead){this._log(`File ${path2} is not exist on the database`,LOG_LEVEL_VERBOSE);return false}const docData=readContent(docRead);if(existOnStorage&&!force){let shouldApplied=false;if(compareFileFreshness(existDoc,docEntry)!==EVEN)shouldApplied=true;if(shouldApplied){const readFile=await this.readFileFromStub(existDoc);if(await isDocContentSame(docData,readFile.body)){shouldApplied=false;markChangesAreSame(docRead,docRead.mtime,existDoc.stat.mtime)}else shouldApplied=true}if(!shouldApplied){this._log(`File ${docRead.path} is not changed`,LOG_LEVEL_VERBOSE);return true}}else this._log(`File ${docRead.path} ${existOnStorage?"(new) ":""} ${force?" (forced)":""}`,LOG_LEVEL_VERBOSE);await this.storage.ensureDir(path2);const ret=await this.storage.writeFileAuto(path2,docData,{ctime:docRead.ctime,mtime:docRead.mtime});this.storage.touched(path2);this.storage.triggerFileEvent(mode,path2);return ret}async $anyHandlerProcessesFileEvent(item){const eventItem=item.args,type=item.type,path2=eventItem.file.path;if(!await this.core.$$isTargetFile(path2)){this._log(`File ${path2} is not the target file`,LOG_LEVEL_VERBOSE);return false}if(shouldBeIgnored(path2)){this._log(`File ${path2} should be ignored`,LOG_LEVEL_VERBOSE);return false}const lockKey=`processFileEvent-${path2}`;return await serialized(lockKey,(async()=>{switch(type){case"CREATE":case"CHANGED":return await this.storeFileToDB(item.args.file);case"DELETE":return await this.deleteFileFromDB(item.args.file);case"INTERNAL":return false;default:this._log(`Unsupported event type: ${type}`,LOG_LEVEL_VERBOSE);return false}}))}async $anyProcessReplicatedDoc(entry){return await serialized(entry.path,(async()=>{var _a5,_b2;if(!await this.core.$$isTargetFile(entry.path)){this._log(`File ${entry.path} is not the target file`,LOG_LEVEL_VERBOSE);return false}if(shouldBeIgnored(entry.path)){this._log(`File ${entry.path} should be ignored`,LOG_LEVEL_VERBOSE);return false}const path2=getPath2(entry),targetFile=this.storage.getStub(getPathWithoutPrefix2(entry));if(targetFile&&targetFile.isFolder){this._log(`${getPath2(entry)} is already exist as the folder`);return true}else{this._log(`Processing ${path2} (${entry._id.substring(0,8)}: ${null==(_a5=entry._rev)?void 0:_a5.substring(0,5)}) :Started...`,LOG_LEVEL_VERBOSE);const ret=await this.dbToStorage(entry,targetFile);this._log(`Processing ${path2} (${entry._id.substring(0,8)} :${null==(_b2=entry._rev)?void 0:_b2.substring(0,5)}) : Done`);return ret}}))}async createAllChunks(showingNotice){this._log("Collecting local files on the storage",LOG_LEVEL_VERBOSE);const semaphore=Semaphore(10);let processed=0;const filesStorageSrc=this.storage.getFiles(),incProcessed=()=>{processed++;if(processed%25==0)this._log(`Creating missing chunks: ${processed} of ${total} files`,showingNotice?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"chunkCreation")},total=filesStorageSrc.length,procAllChunks=filesStorageSrc.map((async file=>{if(!await this.core.$$isTargetFile(file)){incProcessed();return true}if(shouldBeIgnored(file.path)){incProcessed();return true}const release=await semaphore.acquire();incProcessed();try{await this.storeFileToDB(file,false,true)}catch(ex){this._log(ex,LOG_LEVEL_VERBOSE)}finally{release()}}));await Promise.all(procAllChunks);this._log(`Creating chunks Done: ${processed} of ${total} files`,showingNotice?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"chunkCreation")}},WrappedNotice=class{constructor(message,timeout){var _a5;let strMessage="";if(message instanceof DocumentFragment)strMessage=null!=(_a5=message.textContent)?_a5:"";else strMessage=message;Logger(strMessage,LOG_LEVEL_NOTICE)}setMessage(message){var _a5;let strMessage="";if(message instanceof DocumentFragment)strMessage=null!=(_a5=message.textContent)?_a5:"";else strMessage=message;Logger(strMessage,LOG_LEVEL_NOTICE);return this}hide(){}},_notice=WrappedNotice;function setNoticeClass(notice2){_notice=notice2}function NewNotice(message,timeout){return new _notice(message,timeout)}var getRandomValues2,PouchError=class extends Error{constructor(status,error,reason){super();this.status=status;this.name=error;this.message=reason;this.error=true}toString(){return JSON.stringify({status:this.status,name:this.name,message:this.message,reason:this.reason})}},UNAUTHORIZED=new PouchError(401,"unauthorized","Name or password is incorrect."),MISSING_BULK_DOCS=new PouchError(400,"bad_request","Missing JSON list of 'docs'"),MISSING_DOC=new PouchError(404,"not_found","missing"),REV_CONFLICT=new PouchError(409,"conflict","Document update conflict"),INVALID_ID=new PouchError(400,"bad_request","_id field must contain a string"),MISSING_ID=new PouchError(412,"missing_id","_id is required for puts"),RESERVED_ID=new PouchError(400,"bad_request","Only reserved document ids may start with underscore."),NOT_OPEN=new PouchError(412,"precondition_failed","Database not open"),UNKNOWN_ERROR=new PouchError(500,"unknown_error","Database encountered an unknown error"),BAD_ARG=new PouchError(500,"badarg","Some query argument is invalid"),INVALID_REQUEST=new PouchError(400,"invalid_request","Request was invalid"),QUERY_PARSE_ERROR=new PouchError(400,"query_parse_error","Some query parameter is invalid"),DOC_VALIDATION=new PouchError(500,"doc_validation","Bad special document member"),BAD_REQUEST=new PouchError(400,"bad_request","Something wrong with the request"),NOT_AN_OBJECT=new PouchError(400,"bad_request","Document must be a JSON object"),DB_MISSING=new PouchError(404,"not_found","Database not found"),IDB_ERROR=new PouchError(500,"indexed_db_went_bad","unknown"),WSQ_ERROR=new PouchError(500,"web_sql_went_bad","unknown"),LDB_ERROR=new PouchError(500,"levelDB_went_went_bad","unknown"),FORBIDDEN=new PouchError(403,"forbidden","Forbidden by design doc validate_doc_update function"),INVALID_REV=new PouchError(400,"bad_request","Invalid rev format"),FILE_EXISTS=new PouchError(412,"file_exists","The database could not be created, the file already exists."),MISSING_STUB=new PouchError(412,"missing_stub","A pre-existing attachment stub wasn't found"),INVALID_URL=new PouchError(413,"invalid_url","Provided URL is invalid");function createError(error,reason){function CustomPouchError(reason2){for(var names=Object.getOwnPropertyNames(error),i2=0,len=names.length;i2<len;i2++)if("function"!=typeof error[names[i2]])this[names[i2]]=error[names[i2]];if(void 0===this.stack)this.stack=(new Error).stack;if(void 0!==reason2)this.reason=reason2}CustomPouchError.prototype=PouchError.prototype;return new CustomPouchError(reason)}function generateErrorFromResponse(err2){if("object"!=typeof err2){var data=err2;(err2=UNKNOWN_ERROR).data=data}if("error"in err2&&"conflict"===err2.error){err2.name="conflict";err2.status=409}if(!("name"in err2))err2.name=err2.error||"unknown";if(!("status"in err2))err2.status=500;if(!("message"in err2))err2.message=err2.message||err2.reason;if(!("stack"in err2))err2.stack=(new Error).stack;return err2}var rnds82=new Uint8Array(16);function rng2(){if(!getRandomValues2)if(!(getRandomValues2="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues2(rnds82)}var regex_default2=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate3(uuid2){return"string"==typeof uuid2&&regex_default2.test(uuid2)}var validate_default2=validate3,byteToHex2=[];for(i2=0;i2<256;++i2)byteToHex2.push((i2+256).toString(16).substr(1));function stringify2(arr){var offset=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,uuid2=(byteToHex2[arr[offset+0]]+byteToHex2[arr[offset+1]]+byteToHex2[arr[offset+2]]+byteToHex2[arr[offset+3]]+"-"+byteToHex2[arr[offset+4]]+byteToHex2[arr[offset+5]]+"-"+byteToHex2[arr[offset+6]]+byteToHex2[arr[offset+7]]+"-"+byteToHex2[arr[offset+8]]+byteToHex2[arr[offset+9]]+"-"+byteToHex2[arr[offset+10]]+byteToHex2[arr[offset+11]]+byteToHex2[arr[offset+12]]+byteToHex2[arr[offset+13]]+byteToHex2[arr[offset+14]]+byteToHex2[arr[offset+15]]).toLowerCase();if(!validate_default2(uuid2))throw TypeError("Stringified UUID is invalid");return uuid2}var i2,stringify_default2=stringify2;function v42(options,buf,offset){var rnds=(options=options||{}).random||(options.rng||rng2)();rnds[6]=15&rnds[6]|64;rnds[8]=63&rnds[8]|128;if(buf){offset=offset||0;for(var i2=0;i2<16;++i2)buf[offset+i2]=rnds[i2];return buf}return stringify_default2(rnds)}var v4_default2=v42,thisAtob=function(str){return atob(str)},thisBtoa=function(str){return btoa(str)};function createBlob2(parts,properties){parts=parts||[];properties=properties||{};try{return new Blob(parts,properties)}catch(e4){if("TypeError"!==e4.name)throw e4;for(var builder=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),i2=0;i2<parts.length;i2+=1)builder.append(parts[i2]);return builder.getBlob(properties.type)}}function binaryStringToArrayBuffer(bin){for(var length=bin.length,buf=new ArrayBuffer(length),arr=new Uint8Array(buf),i2=0;i2<length;i2++)arr[i2]=bin.charCodeAt(i2);return buf}function binStringToBluffer(binString,type){return createBlob2([binaryStringToArrayBuffer(binString)],{type})}function b64ToBluffer(b64,type){return binStringToBluffer(thisAtob(b64),type)}function arrayBufferToBinaryString(buffer){for(var binary="",bytes=new Uint8Array(buffer),length=bytes.byteLength,i2=0;i2<length;i2++)binary+=String.fromCharCode(bytes[i2]);return binary}function readAsBinaryString(blob,callback){var reader=new FileReader,hasBinaryString="function"==typeof reader.readAsBinaryString;reader.onloadend=function(e4){var result=e4.target.result||"";if(hasBinaryString)return callback(result);callback(arrayBufferToBinaryString(result))};if(hasBinaryString)reader.readAsBinaryString(blob);else reader.readAsArrayBuffer(blob)}function blobToBinaryString(blobOrBuffer,callback){readAsBinaryString(blobOrBuffer,(function(bin){callback(bin)}))}function blobToBase64(blobOrBuffer,callback){blobToBinaryString(blobOrBuffer,(function(base64){callback(thisBtoa(base64))}))}function readAsArrayBuffer(blob,callback){var reader=new FileReader;reader.onloadend=function(e4){var result=e4.target.result||new ArrayBuffer(0);callback(result)};reader.readAsArrayBuffer(blob)}function typedBuffer(){}var import_spark_md5=__toESM(require_spark_md5()),setImmediateShim=self.setImmediate||self.setTimeout,MD5_CHUNK_SIZE=32768;function rawToBase64(raw){return thisBtoa(raw)}function appendBlob(buffer,blob,start,end,callback){if(start>0||end<blob.size)blob=blob.slice(start,end);readAsArrayBuffer(blob,(function(arrayBuffer){buffer.append(arrayBuffer);callback()}))}function appendString(buffer,string,start,end,callback){if(start>0||end<string.length)string=string.substring(start,end);buffer.appendBinary(string);callback()}function binaryMd5(data,callback){var inputIsString="string"==typeof data,len=inputIsString?data.length:data.size,chunkSize=Math.min(MD5_CHUNK_SIZE,len),chunks=Math.ceil(len/chunkSize),currentChunk=0,buffer=inputIsString?new import_spark_md5.default:new import_spark_md5.default.ArrayBuffer,append2=inputIsString?appendString:appendBlob;function next(){setImmediateShim(loadNextChunk)}function done(){var base64=rawToBase64(buffer.end(true));callback(base64);buffer.destroy()}function loadNextChunk(){var start=currentChunk*chunkSize,end=start+chunkSize;if(++currentChunk<chunks)append2(buffer,data,start,end,next);else append2(buffer,data,start,end,done)}loadNextChunk()}function stringMd5(string){return import_spark_md5.default.hash(string)}var import_events13=__toESM(require_events());function isBinaryObject(object){return"undefined"!=typeof ArrayBuffer&&object instanceof ArrayBuffer||"undefined"!=typeof Blob&&object instanceof Blob}function cloneBinaryObject(object){return object instanceof ArrayBuffer?object.slice(0):object.slice(0,object.size,object.type)}var funcToString=Function.prototype.toString,objectCtorString=funcToString.call(Object);function isPlainObject(value){var proto=Object.getPrototypeOf(value);if(null===proto)return true;var Ctor=proto.constructor;return"function"==typeof Ctor&&Ctor instanceof Ctor&&funcToString.call(Ctor)==objectCtorString}function clone(object){var newObject,i2,len;if(!object||"object"!=typeof object)return object;if(Array.isArray(object)){newObject=[];for(i2=0,len=object.length;i2<len;i2++)newObject[i2]=clone(object[i2]);return newObject}if(object instanceof Date&&isFinite(object))return object.toISOString();if(isBinaryObject(object))return cloneBinaryObject(object);if(!isPlainObject(object))return object;newObject={};for(i2 in object)if(Object.prototype.hasOwnProperty.call(object,i2)){var value=clone(object[i2]);if("undefined"!=typeof value)newObject[i2]=value}return newObject}function once2(fun){var called=false;return function(...args){if(called)throw new Error("once called more than once");else{called=true;fun.apply(this,args)}}}function toPromise(func){return function(...args){args=clone(args);var self3=this,usedCB="function"==typeof args[args.length-1]?args.pop():false,promise2=new Promise((function(fulfill,reject){var resp;try{var callback=once2((function(err2,mesg){if(err2)reject(err2);else fulfill(mesg)}));args.push(callback);if((resp=func.apply(self3,args))&&"function"==typeof resp.then)fulfill(resp)}catch(e4){reject(e4)}}));if(usedCB)promise2.then((function(result){usedCB(null,result)}),usedCB);return promise2}}function logApiCall(self3,name,args){if(self3.constructor.listeners("debug").length){for(var logArgs=["api",self3.name,name],i2=0;i2<args.length-1;i2++)logArgs.push(args[i2]);self3.constructor.emit("debug",logArgs);var origCallback=args[args.length-1];args[args.length-1]=function(err2,res2){var responseArgs=["api",self3.name,name];responseArgs=responseArgs.concat(err2?["error",err2]:["success",res2]);self3.constructor.emit("debug",responseArgs);origCallback(err2,res2)}}}function adapterFun(name,callback){return toPromise((function(...args){if(this._closed)return Promise.reject(new Error("database is closed"));if(this._destroyed)return Promise.reject(new Error("database is destroyed"));var self3=this;logApiCall(self3,name,args);if(!this.taskqueue.isReady)return new Promise((function(fulfill,reject){self3.taskqueue.addTask((function(failed2){if(failed2)reject(failed2);else fulfill(self3[name].apply(self3,args))}))}));else return callback.apply(this,args)}))}function pick(obj,arr){for(var res2={},i2=0,len=arr.length;i2<len;i2++){var prop=arr[i2];if(prop in obj)res2[prop]=obj[prop]}return res2}var hasLocal,MAX_NUM_CONCURRENT_REQUESTS=6;function identityFunction(x2){return x2}function formatResultForOpenRevsGet(result){return[{ok:result}]}function bulkGet(db,opts,callback){var requests=opts.docs,requestsById=new Map;requests.forEach((function(request2){if(requestsById.has(request2.id))requestsById.get(request2.id).push(request2);else requestsById.set(request2.id,[request2])}));var numDocs=requestsById.size,numDone=0,perDocResults=new Array(numDocs),allRequests=[];requestsById.forEach((function(value,key2){allRequests.push(key2)}));var i2=0;(function nextBatch(){if(!(i2>=allRequests.length)){var upTo=Math.min(i2+MAX_NUM_CONCURRENT_REQUESTS,allRequests.length),batch=allRequests.slice(i2,upTo);(function processBatch(batch,offset){batch.forEach((function(docId,j2){var docIdx=offset+j2,docRequests=requestsById.get(docId),docOpts=pick(docRequests[0],["atts_since","attachments"]);docOpts.open_revs=docRequests.map((function(request2){return request2.rev}));docOpts.open_revs=docOpts.open_revs.filter(identityFunction);var formatResult=identityFunction;if(0===docOpts.open_revs.length){delete docOpts.open_revs;formatResult=formatResultForOpenRevsGet}["revs","attachments","binary","ajax","latest"].forEach((function(param){if(param in opts)docOpts[param]=opts[param]}));db.get(docId,docOpts,(function(err2,res2){var result;if(err2)result=[{error:err2}];else result=formatResult(res2);(function gotResult(docIndex,id,docs){perDocResults[docIndex]={id,docs};(function checkDone(){if(++numDone===numDocs)(function collapseResultsAndFinish(){var results=[];perDocResults.forEach((function(res2){res2.docs.forEach((function(info3){results.push({id:res2.id,docs:[info3]})}))}));callback(null,{results})})()})()})(docIdx,docId,result);nextBatch()}))}))})(batch,i2);i2+=batch.length}})()}try{localStorage.setItem("_pouch_check_localstorage",1);hasLocal=!!localStorage.getItem("_pouch_check_localstorage")}catch(e4){hasLocal=false}function hasLocalStorage(){return hasLocal}var nextTick="function"==typeof queueMicrotask?queueMicrotask:function nextTick2(fn){Promise.resolve().then(fn)},Changes=class extends import_events13.default{constructor(){super();this._listeners={};if(hasLocalStorage())addEventListener("storage",(e4=>{this.emit(e4.key)}))}addListener(dbName,id,db,opts){if(!this._listeners[id]){var inprogress=false,self3=this;this._listeners[id]=eventFunction;this.on(dbName,eventFunction)}function eventFunction(){if(self3._listeners[id])if(!inprogress){inprogress=true;var changesOpts=pick(opts,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary","return_docs"]);db.changes(changesOpts).on("change",(function(c2){if(c2.seq>opts.since&&!opts.cancelled){opts.since=c2.seq;opts.onChange(c2)}})).on("complete",(function(){if("waiting"===inprogress)nextTick(eventFunction);inprogress=false})).on("error",(function onError(){inprogress=false}))}else inprogress="waiting"}}removeListener(dbName,id){if(id in this._listeners){super.removeListener(dbName,this._listeners[id]);delete this._listeners[id]}}notifyLocalWindows(dbName){if(hasLocalStorage())localStorage[dbName]="a"===localStorage[dbName]?"b":"a"}notify(dbName){this.emit(dbName);this.notifyLocalWindows(dbName)}};function guardedConsole(method){if("undefined"!=typeof console&&"function"==typeof console[method]){var args=Array.prototype.slice.call(arguments,1);console[method].apply(console,args)}}function randomNumber(min,max3){min=parseInt(min,10)||0;if((max3=parseInt(max3,10))!=max3||max3<=min)max3=(min||1)<<1;else max3+=1;if(max3>6e5){min=3e5;max3=6e5}return~~((max3-min)*Math.random()+min)}function defaultBackOff(min){var max3=0;if(!min)max3=2e3;return randomNumber(min,max3)}function explainError(status,str){guardedConsole("info","The above "+status+" is totally normal. "+str)}function tryFilter(filter3,doc,req){try{return!filter3(doc,req)}catch(err2){var msg="Filter function threw: "+err2.toString();return createError(BAD_REQUEST,msg)}}function filterChange(opts){var req={},hasFilter=opts.filter&&"function"==typeof opts.filter;req.query=opts.query_params;return function filter3(change){if(!change.doc)change.doc={};var filterReturn=hasFilter&&tryFilter(opts.filter,change.doc,req);if("object"==typeof filterReturn)return filterReturn;if(filterReturn)return false;if(!opts.include_docs)delete change.doc;else if(!opts.attachments)for(var att in change.doc._attachments)if(Object.prototype.hasOwnProperty.call(change.doc._attachments,att))change.doc._attachments[att].stub=true;return true}}function f2(){}var res,hasName=f2.name;if(hasName)res=function(fun){return fun.name};else res=function(fun){var match3=fun.toString().match(/^\s*function\s*(?:(\S+)\s*)?\(/);if(match3&&match3[1])return match3[1];else return""};var res$1=res;function invalidIdError(id){var err2;if(!id)err2=createError(MISSING_ID);else if("string"!=typeof id)err2=createError(INVALID_ID);else if(/^_/.test(id)&&!/^_(design|local)/.test(id))err2=createError(RESERVED_ID);if(err2)throw err2}function isRemote(db){if("boolean"==typeof db._remote)return db._remote;if("function"==typeof db.type){guardedConsole("warn","db.type() is deprecated and will be removed in a future version of PouchDB");return"http"===db.type()}return false}function listenerCount(ee,type){return"listenerCount"in ee?ee.listenerCount(type):import_events13.default.listenerCount(ee,type)}function parseDesignDocFunctionName(s2){if(!s2)return null;var parts=s2.split("/");if(2===parts.length)return parts;if(1===parts.length)return[s2,s2];else return null}function normalizeDesignDocFunctionName(s2){var normalized=parseDesignDocFunctionName(s2);return normalized?normalized.join("/"):null}var keys=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],qName="queryKey",qParser=/(?:^|&)([^&=]*)=?([^&]*)/g,parser=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;function parseUri(str){for(var m2=parser.exec(str),uri={},i2=14;i2--;){var key2=keys[i2],value=m2[i2]||"",encoded=-1!==["user","password"].indexOf(key2);uri[key2]=encoded?decodeURIComponent(value):value}uri[qName]={};uri[keys[12]].replace(qParser,(function($0,$1,$2){if($1)uri[qName][$1]=$2}));return uri}function scopeEval(source,scope){var keys2=[],values=[];for(var key2 in scope)if(Object.prototype.hasOwnProperty.call(scope,key2)){keys2.push(key2);values.push(scope[key2])}keys2.push(source);return Function.apply(null,keys2).apply(null,values)}function upsert(db,docId,diffFun){return db.get(docId).catch((function(err2){if(404!==err2.status)throw err2;return{}})).then((function(doc){var docRev=doc._rev,newDoc=diffFun(doc);if(!newDoc)return{updated:false,rev:docRev};newDoc._id=docId;newDoc._rev=docRev;return tryAndPut(db,newDoc,diffFun)}))}function tryAndPut(db,doc,diffFun){return db.put(doc).then((function(res2){return{updated:true,rev:res2.rev}}),(function(err2){if(409!==err2.status)throw err2;return upsert(db,doc._id,diffFun)}))}function rev2(doc,deterministic_revs){if(!deterministic_revs)return v4_default2().replace(/-/g,"").toLowerCase();var mutateableDoc=Object.assign({},doc);delete mutateableDoc._rev_tree;return stringMd5(JSON.stringify(mutateableDoc))}var uuid=v4_default2;function winningRev(metadata){for(var winningId,winningPos,winningDeleted,node,toVisit=metadata.rev_tree.slice();node=toVisit.pop();){var tree=node.ids,branches=tree[2],pos=node.pos;if(!branches.length){var deleted=!!tree[1].deleted,id=tree[0];if(!winningId||(winningDeleted!==deleted?winningDeleted:winningPos!==pos?winningPos<pos:winningId<id)){winningId=id;winningPos=pos;winningDeleted=deleted}}else for(var i2=0,len=branches.length;i2<len;i2++)toVisit.push({pos:pos+1,ids:branches[i2]})}return winningPos+"-"+winningId}function traverseRevTree(revs,callback){for(var node,toVisit=revs.slice();node=toVisit.pop();)for(var pos=node.pos,tree=node.ids,branches=tree[2],newCtx=callback(0===branches.length,pos,tree[0],node.ctx,tree[1]),i2=0,len=branches.length;i2<len;i2++)toVisit.push({pos:pos+1,ids:branches[i2],ctx:newCtx})}function sortByPos(a2,b3){return a2.pos-b3.pos}function collectLeaves(revs){var leaves=[];traverseRevTree(revs,(function(isLeaf,pos,id,acc,opts){if(isLeaf)leaves.push({rev:pos+"-"+id,pos,opts})}));leaves.sort(sortByPos).reverse();for(var i2=0,len=leaves.length;i2<len;i2++)delete leaves[i2].pos;return leaves}function collectConflicts(metadata){for(var win=winningRev(metadata),leaves=collectLeaves(metadata.rev_tree),conflicts=[],i2=0,len=leaves.length;i2<len;i2++){var leaf=leaves[i2];if(leaf.rev!==win&&!leaf.opts.deleted)conflicts.push(leaf.rev)}return conflicts}function compactTree(metadata){var revs=[];traverseRevTree(metadata.rev_tree,(function(isLeaf,pos,revHash,ctx,opts){if("available"===opts.status&&!isLeaf){revs.push(pos+"-"+revHash);opts.status="missing"}}));return revs}function findPathToLeaf(revs,targetRev){let path2=[];const toVisit=revs.slice();let node;for(;node=toVisit.pop();){const{pos,ids:tree}=node,rev3=`${pos}-${tree[0]}`,branches=tree[2];path2.push(rev3);if(rev3===targetRev){if(0!==branches.length)throw new Error("The requested revision is not a leaf");return path2.reverse()}if(0===branches.length||branches.length>1)path2=[];for(let i2=0,len=branches.length;i2<len;i2++)toVisit.push({pos:pos+1,ids:branches[i2]})}if(0===path2.length)throw new Error("The requested revision does not exist");return path2.reverse()}function rootToLeaf(revs){for(var node,paths=[],toVisit=revs.slice();node=toVisit.pop();){var pos=node.pos,tree=node.ids,id=tree[0],opts=tree[1],branches=tree[2],isLeaf=0===branches.length,history=node.history?node.history.slice():[];history.push({id,opts});if(isLeaf)paths.push({pos:pos+1-history.length,ids:history});for(var i2=0,len=branches.length;i2<len;i2++)toVisit.push({pos:pos+1,ids:branches[i2],history})}return paths.reverse()}function sortByPos$1(a2,b3){return a2.pos-b3.pos}function binarySearch(arr,item,comparator){for(var mid,low=0,high=arr.length;low<high;)if(comparator(arr[mid=low+high>>>1],item)<0)low=mid+1;else high=mid;return low}function insertSorted(arr,item,comparator){var idx2=binarySearch(arr,item,comparator);arr.splice(idx2,0,item)}function pathToTree(path2,numStemmed){for(var root,leaf,i2=numStemmed,len=path2.length;i2<len;i2++){var node=path2[i2],currentLeaf=[node.id,node.opts,[]];if(leaf){leaf[2].push(currentLeaf);leaf=currentLeaf}else root=leaf=currentLeaf}return root}function compareTree(a2,b3){return a2[0]<b3[0]?-1:1}function mergeTree(in_tree1,in_tree2){for(var queue2=[{tree1:in_tree1,tree2:in_tree2}],conflicts=false;queue2.length>0;){var item=queue2.pop(),tree1=item.tree1,tree2=item.tree2;if(tree1[1].status||tree2[1].status)tree1[1].status="available"===tree1[1].status||"available"===tree2[1].status?"available":"missing";for(var i2=0;i2<tree2[2].length;i2++)if(tree1[2][0]){for(var merged=false,j2=0;j2<tree1[2].length;j2++)if(tree1[2][j2][0]===tree2[2][i2][0]){queue2.push({tree1:tree1[2][j2],tree2:tree2[2][i2]});merged=true}if(!merged){conflicts="new_branch";insertSorted(tree1[2],tree2[2][i2],compareTree)}}else{conflicts="new_leaf";tree1[2][0]=tree2[2][i2]}}return{conflicts,tree:in_tree1}}function doMerge(tree,path2,dontExpand){var res2,restree=[],conflicts=false,merged=false;if(!tree.length)return{tree:[path2],conflicts:"new_leaf"};for(var i2=0,len=tree.length;i2<len;i2++){var branch=tree[i2];if(branch.pos===path2.pos&&branch.ids[0]===path2.ids[0]){res2=mergeTree(branch.ids,path2.ids);restree.push({pos:branch.pos,ids:res2.tree});conflicts=conflicts||res2.conflicts;merged=true}else if(true!==dontExpand){var t1=branch.pos<path2.pos?branch:path2,t22=branch.pos<path2.pos?path2:branch,diff=t22.pos-t1.pos,candidateParents=[],trees=[];trees.push({ids:t1.ids,diff,parent:null,parentIdx:null});for(;trees.length>0;){var item=trees.pop();if(0!==item.diff)for(var elements=item.ids[2],j2=0,elementsLen=elements.length;j2<elementsLen;j2++)trees.push({ids:elements[j2],diff:item.diff-1,parent:item.ids,parentIdx:j2});else if(item.ids[0]===t22.ids[0])candidateParents.push(item)}var el=candidateParents[0];if(!el)restree.push(branch);else{res2=mergeTree(el.ids,t22.ids);el.parent[2][el.parentIdx]=res2.tree;restree.push({pos:t1.pos,ids:t1.ids});conflicts=conflicts||res2.conflicts;merged=true}}else restree.push(branch)}if(!merged)restree.push(path2);restree.sort(sortByPos$1);return{tree:restree,conflicts:conflicts||"internal_node"}}function stem(tree,depth){for(var stemmedRevs,result,paths=rootToLeaf(tree),i2=0,len=paths.length;i2<len;i2++){var node,path2=paths[i2],stemmed=path2.ids;if(stemmed.length>depth){if(!stemmedRevs)stemmedRevs={};var numStemmed=stemmed.length-depth;node={pos:path2.pos+numStemmed,ids:pathToTree(stemmed,numStemmed)};for(var s2=0;s2<numStemmed;s2++){var rev3=path2.pos+s2+"-"+stemmed[s2].id;stemmedRevs[rev3]=true}}else node={pos:path2.pos,ids:pathToTree(stemmed,0)};if(result)result=doMerge(result,node,true).tree;else result=[node]}if(stemmedRevs)traverseRevTree(result,(function(isLeaf,pos,revHash){delete stemmedRevs[pos+"-"+revHash]}));return{tree:result,revs:stemmedRevs?Object.keys(stemmedRevs):[]}}function merge(tree,path2,depth){var newTree=doMerge(tree,path2),stemmed=stem(newTree.tree,depth);return{tree:stemmed.tree,stemmedRevs:stemmed.revs,conflicts:newTree.conflicts}}function removeLeafFromRevTree(tree,leafRev){return tree.flatMap((path2=>(path2=removeLeafFromPath(path2,leafRev))?[path2]:[]))}function removeLeafFromPath(path2,leafRev){const tree=clone(path2),toVisit=[tree];let node;for(;node=toVisit.pop();){const{pos,ids:[id,,branches],parent}=node;if(0===branches.length&&`${pos}-${id}`===leafRev){if(!parent)return null;parent.ids[2]=parent.ids[2].filter((function(branchNode){return branchNode[0]!==id}));return tree}for(let i2=0,len=branches.length;i2<len;i2++)toVisit.push({pos:pos+1,ids:branches[i2],parent:node})}return tree}function revExists(revs,rev3){for(var node,toVisit=revs.slice(),splitRev=rev3.split("-"),targetPos=parseInt(splitRev[0],10),targetId=splitRev[1];node=toVisit.pop();){if(node.pos===targetPos&&node.ids[0]===targetId)return true;for(var branches=node.ids[2],i2=0,len=branches.length;i2<len;i2++)toVisit.push({pos:node.pos+1,ids:branches[i2]})}return false}function getTrees(node){return node.ids}function isDeleted(metadata,rev3){if(!rev3)rev3=winningRev(metadata);for(var tree,id=rev3.substring(rev3.indexOf("-")+1),toVisit=metadata.rev_tree.map(getTrees);tree=toVisit.pop();){if(tree[0]===id)return!!tree[1].deleted;toVisit=toVisit.concat(tree[2])}}function isLocalId(id){return"string"==typeof id&&id.startsWith("_local/")}function latest(rev3,metadata){for(var node,toVisit=metadata.rev_tree.slice();node=toVisit.pop();){var pos=node.pos,tree=node.ids,id=tree[0],opts=tree[1],branches=tree[2],isLeaf=0===branches.length,history=node.history?node.history.slice():[];history.push({id,pos,opts});if(isLeaf)for(var i2=0,len=history.length;i2<len;i2++){var historyNode=history[i2];if(historyNode.pos+"-"+historyNode.id===rev3)return pos+"-"+id}for(var j2=0,l2=branches.length;j2<l2;j2++)toVisit.push({pos:pos+1,ids:branches[j2],history})}throw new Error("Unable to resolve latest revision for id "+metadata.id+", rev "+rev3)}var f3=fetch,h2=Headers;function pad(str,padWith,upToLength){for(var padding="",targetLength=upToLength-str.length;padding.length<targetLength;)padding+=padWith;return padding}function padLeft(str,padWith,upToLength){return pad(str,padWith,upToLength)+str}var MIN_MAGNITUDE=-324,MAGNITUDE_DIGITS=3,SEP="";function collate(a2,b3){if(a2===b3)return 0;a2=normalizeKey(a2);b3=normalizeKey(b3);var ai2=collationIndex(a2),bi2=collationIndex(b3);if(ai2-bi2!=0)return ai2-bi2;switch(typeof a2){case"number":return a2-b3;case"boolean":return a2<b3?-1:1;case"string":return stringCollate(a2,b3)}return Array.isArray(a2)?arrayCollate(a2,b3):objectCollate(a2,b3)}function normalizeKey(key2){switch(typeof key2){case"undefined":return null;case"number":if(key2===1/0||key2===-1/0||isNaN(key2))return null;else return key2;case"object":var origKey=key2;if(Array.isArray(key2)){var len=key2.length;key2=new Array(len);for(var i2=0;i2<len;i2++)key2[i2]=normalizeKey(origKey[i2])}else if(key2 instanceof Date)return key2.toJSON();else if(null!==key2){key2={};for(var k2 in origKey)if(Object.prototype.hasOwnProperty.call(origKey,k2)){var val2=origKey[k2];if("undefined"!=typeof val2)key2[k2]=normalizeKey(val2)}}}return key2}function indexify(key2){if(null!==key2)switch(typeof key2){case"boolean":return key2?1:0;case"number":return numToIndexableString(key2);case"string":return key2.replace(/\u0002/g,"").replace(/\u0001/g,"").replace(/\u0000/g,"");case"object":var isArray2=Array.isArray(key2),arr=isArray2?key2:Object.keys(key2),i2=-1,len=arr.length,result="";if(isArray2)for(;++i2<len;)result+=toIndexableString(arr[i2]);else for(;++i2<len;){var objKey=arr[i2];result+=toIndexableString(objKey)+toIndexableString(key2[objKey])}return result}return""}function toIndexableString(key2){return collationIndex(key2=normalizeKey(key2))+SEP+indexify(key2)+"\0"}function parseNumber2(str,i2){var num,originalIdx=i2;if("1"===str[i2]){num=0;i2++}else{var neg="0"===str[i2];i2++;var numAsString="",magAsString=str.substring(i2,i2+MAGNITUDE_DIGITS),magnitude=parseInt(magAsString,10)+MIN_MAGNITUDE;if(neg)magnitude=-magnitude;i2+=MAGNITUDE_DIGITS;for(;;){var ch4=str[i2];if("\0"===ch4)break;else numAsString+=ch4;i2++}if(1===(numAsString=numAsString.split(".")).length)num=parseInt(numAsString,10);else num=parseFloat(numAsString[0]+"."+numAsString[1]);if(neg)num-=10;if(0!==magnitude)num=parseFloat(num+"e"+magnitude)}return{num,length:i2-originalIdx}}function pop(stack,metaStack){var obj=stack.pop();if(metaStack.length){var lastMetaElement=metaStack[metaStack.length-1];if(obj===lastMetaElement.element){metaStack.pop();lastMetaElement=metaStack[metaStack.length-1]}var element2=lastMetaElement.element,lastElementIndex=lastMetaElement.index;if(Array.isArray(element2))element2.push(obj);else if(lastElementIndex===stack.length-2)element2[stack.pop()]=obj;else stack.push(obj)}}function parseIndexableString(str){for(var stack=[],metaStack=[],i2=0;;){var collationIndex2=str[i2++];if("\0"===collationIndex2)if(1===stack.length)return stack.pop();else{pop(stack,metaStack);continue}switch(collationIndex2){case"1":stack.push(null);break;case"2":stack.push("1"===str[i2]);i2++;break;case"3":var parsedNum=parseNumber2(str,i2);stack.push(parsedNum.num);i2+=parsedNum.length;break;case"4":for(var parsedStr="";;){var ch4=str[i2];if("\0"===ch4)break;parsedStr+=ch4;i2++}parsedStr=parsedStr.replace(/\u0001\u0001/g,"\0").replace(/\u0001\u0002/g,"").replace(/\u0002\u0002/g,"");stack.push(parsedStr);break;case"5":var arrayElement={element:[],index:stack.length};stack.push(arrayElement.element);metaStack.push(arrayElement);break;case"6":var objElement={element:{},index:stack.length};stack.push(objElement.element);metaStack.push(objElement);break;default:throw new Error("bad collationIndex or unexpectedly reached end of input: "+collationIndex2)}}}function arrayCollate(a2,b3){for(var len=Math.min(a2.length,b3.length),i2=0;i2<len;i2++){var sort=collate(a2[i2],b3[i2]);if(0!==sort)return sort}return a2.length===b3.length?0:a2.length>b3.length?1:-1}function stringCollate(a2,b3){return a2===b3?0:a2>b3?1:-1}function objectCollate(a2,b3){for(var ak2=Object.keys(a2),bk2=Object.keys(b3),len=Math.min(ak2.length,bk2.length),i2=0;i2<len;i2++){var sort=collate(ak2[i2],bk2[i2]);if(0!==sort)return sort;if(0!==(sort=collate(a2[ak2[i2]],b3[bk2[i2]])))return sort}return ak2.length===bk2.length?0:ak2.length>bk2.length?1:-1}function collationIndex(x2){var idx2=["boolean","number","string","object"].indexOf(typeof x2);if(~idx2){if(null===x2)return 1;if(Array.isArray(x2))return 5;else return idx2<3?idx2+2:idx2+3}if(Array.isArray(x2))return 5}function numToIndexableString(num){if(0===num)return"1";var expFormat=num.toExponential().split(/e\+?/),magnitude=parseInt(expFormat[1],10),neg=num<0,result=neg?"0":"2",magString=padLeft(((neg?-magnitude:magnitude)-MIN_MAGNITUDE).toString(),"0",MAGNITUDE_DIGITS);result+=SEP+magString;var factor=Math.abs(parseFloat(expFormat[0]));if(neg)factor=10-factor;var factorStr=factor.toFixed(20);factorStr=factorStr.replace(/\.?0+$/,"");return result+(SEP+factorStr)}function getFieldFromDoc(doc,parsedField){for(var value=doc,i2=0,len=parsedField.length;i2<len&&(value=value[parsedField[i2]]);i2++);return value}function setFieldInDoc(doc,parsedField,value){for(var i2=0,len=parsedField.length;i2<len-1;i2++){var elem=parsedField[i2];doc=doc[elem]=doc[elem]||{}}doc[parsedField[len-1]]=value}function compare(left,right){return left<right?-1:left>right?1:0}function parseField(fieldName){for(var fields=[],current="",i2=0,len=fieldName.length;i2<len;i2++){var ch4=fieldName[i2];if(i2>0&&"\\"===fieldName[i2-1]&&("$"===ch4||"."===ch4))current=current.substring(0,current.length-1)+ch4;else if("."===ch4){fields.push(current);current=""}else current+=ch4}fields.push(current);return fields}var combinationFields=["$or","$nor","$not"];function isCombinationalField(field){return combinationFields.indexOf(field)>-1}function getKey2(obj){return Object.keys(obj)[0]}function getValue(obj){return obj[getKey2(obj)]}function mergeAndedSelectors(selectors){var res2={},first={$or:true,$nor:true};selectors.forEach((function(selector){Object.keys(selector).forEach((function(field){var matcher=selector[field];if("object"!=typeof matcher)matcher={$eq:matcher};if(isCombinationalField(field))if(matcher instanceof Array){if(first[field]){first[field]=false;res2[field]=matcher;return}var entries=[];res2[field].forEach((function(existing){Object.keys(matcher).forEach((function(key2){var m2=matcher[key2],longest=Math.max(Object.keys(existing).length,Object.keys(m2).length),merged=mergeAndedSelectors([existing,m2]);if(!(Object.keys(merged).length<=longest))entries.push(merged)}))}));res2[field]=entries}else res2[field]=mergeAndedSelectors([matcher]);else{var fieldMatchers=res2[field]=res2[field]||{};Object.keys(matcher).forEach((function(operator){var value=matcher[operator];if("$gt"===operator||"$gte"===operator)return mergeGtGte(operator,value,fieldMatchers);else if("$lt"===operator||"$lte"===operator)return mergeLtLte(operator,value,fieldMatchers);else if("$ne"===operator)return mergeNe(value,fieldMatchers);else if("$eq"===operator)return mergeEq(value,fieldMatchers);else if("$regex"===operator)return mergeRegex(value,fieldMatchers);fieldMatchers[operator]=value}))}}))}));return res2}function mergeGtGte(operator,value,fieldMatchers){if("undefined"==typeof fieldMatchers.$eq)if("undefined"!=typeof fieldMatchers.$gte){if("$gte"===operator){if(value>fieldMatchers.$gte)fieldMatchers.$gte=value}else if(value>=fieldMatchers.$gte){delete fieldMatchers.$gte;fieldMatchers.$gt=value}}else if("undefined"!=typeof fieldMatchers.$gt){if("$gte"===operator){if(value>fieldMatchers.$gt){delete fieldMatchers.$gt;fieldMatchers.$gte=value}}else if(value>fieldMatchers.$gt)fieldMatchers.$gt=value}else fieldMatchers[operator]=value}function mergeLtLte(operator,value,fieldMatchers){if("undefined"==typeof fieldMatchers.$eq)if("undefined"!=typeof fieldMatchers.$lte){if("$lte"===operator){if(value<fieldMatchers.$lte)fieldMatchers.$lte=value}else if(value<=fieldMatchers.$lte){delete fieldMatchers.$lte;fieldMatchers.$lt=value}}else if("undefined"!=typeof fieldMatchers.$lt){if("$lte"===operator){if(value<fieldMatchers.$lt){delete fieldMatchers.$lt;fieldMatchers.$lte=value}}else if(value<fieldMatchers.$lt)fieldMatchers.$lt=value}else fieldMatchers[operator]=value}function mergeNe(value,fieldMatchers){if("$ne"in fieldMatchers)fieldMatchers.$ne.push(value);else fieldMatchers.$ne=[value]}function mergeEq(value,fieldMatchers){delete fieldMatchers.$gt;delete fieldMatchers.$gte;delete fieldMatchers.$lt;delete fieldMatchers.$lte;delete fieldMatchers.$ne;fieldMatchers.$eq=value}function mergeRegex(value,fieldMatchers){if("$regex"in fieldMatchers)fieldMatchers.$regex.push(value);else fieldMatchers.$regex=[value]}function mergeAndedSelectorsNested(obj){for(var prop in obj){if(Array.isArray(obj))for(var i2 in obj)if(obj[i2]["$and"])obj[i2]=mergeAndedSelectors(obj[i2]["$and"]);var value=obj[prop];if("object"==typeof value)mergeAndedSelectorsNested(value)}return obj}function isAndInSelector(obj,isAnd){for(var prop in obj){if("$and"===prop)isAnd=true;var value=obj[prop];if("object"==typeof value)isAnd=isAndInSelector(value,isAnd)}return isAnd}function massageSelector(input){var result=clone(input);if(isAndInSelector(result,false))if("$and"in(result=mergeAndedSelectorsNested(result)))result=mergeAndedSelectors(result["$and"]);["$or","$nor"].forEach((function(orOrNor){if(orOrNor in result)result[orOrNor].forEach((function(subSelector){for(var fields2=Object.keys(subSelector),i3=0;i3<fields2.length;i3++){var field2=fields2[i3],matcher2=subSelector[field2];if("object"!=typeof matcher2||null===matcher2)subSelector[field2]={$eq:matcher2}}}))}));if("$not"in result)result["$not"]=mergeAndedSelectors([result["$not"]]);for(var fields=Object.keys(result),i2=0;i2<fields.length;i2++){var field=fields[i2],matcher=result[field];if("object"!=typeof matcher||null===matcher)matcher={$eq:matcher};result[field]=matcher}normalizeArrayOperators(result);return result}function normalizeArrayOperators(selector){Object.keys(selector).forEach((function(field){var matcher=selector[field];if(Array.isArray(matcher))matcher.forEach((function(matcherItem){if(matcherItem&&"object"==typeof matcherItem)normalizeArrayOperators(matcherItem)}));else if("$ne"===field)selector.$ne=[matcher];else if("$regex"===field)selector.$regex=[matcher];else if(matcher&&"object"==typeof matcher)normalizeArrayOperators(matcher)}))}function createFieldSorter(sort){function getFieldValuesAsArray(doc){return sort.map((function(sorting){var parsedField=parseField(getKey2(sorting));return getFieldFromDoc(doc,parsedField)}))}return function(aRow,bRow){var collation=collate(getFieldValuesAsArray(aRow.doc),getFieldValuesAsArray(bRow.doc));if(0!==collation)return collation;else return compare(aRow.doc._id,bRow.doc._id)}}function filterInMemoryFields(rows,requestDef,inMemoryFields){rows=rows.filter((function(row){return rowFilter(row.doc,requestDef.selector,inMemoryFields)}));if(requestDef.sort){var fieldSorter=createFieldSorter(requestDef.sort);rows=rows.sort(fieldSorter);if("string"!=typeof requestDef.sort[0]&&"desc"===getValue(requestDef.sort[0]))rows=rows.reverse()}if("limit"in requestDef||"skip"in requestDef){var skip=requestDef.skip||0,limit=("limit"in requestDef?requestDef.limit:rows.length)+skip;rows=rows.slice(skip,limit)}return rows}function rowFilter(doc,selector,inMemoryFields){return inMemoryFields.every((function(field){var matcher=selector[field],parsedField=parseField(field),docFieldValue=getFieldFromDoc(doc,parsedField);if(isCombinationalField(field))return matchCominationalSelector(field,matcher,doc);else return matchSelector(matcher,doc,parsedField,docFieldValue)}))}function matchSelector(matcher,doc,parsedField,docFieldValue){if(!matcher)return true;if("object"==typeof matcher)return Object.keys(matcher).every((function(maybeUserOperator){var userValue=matcher[maybeUserOperator];if(0===maybeUserOperator.indexOf("$"))return match2(maybeUserOperator,doc,userValue,parsedField,docFieldValue);else{var subParsedField=parseField(maybeUserOperator);if(void 0===docFieldValue&&"object"!=typeof userValue&&subParsedField.length>0)return false;var subDocFieldValue=getFieldFromDoc(docFieldValue,subParsedField);if("object"==typeof userValue)return matchSelector(userValue,doc,parsedField,subDocFieldValue);else return match2("$eq",doc,userValue,subParsedField,subDocFieldValue)}}));else return matcher===docFieldValue}function matchCominationalSelector(field,matcher,doc){if("$or"===field)return matcher.some((function(orMatchers){return rowFilter(doc,orMatchers,Object.keys(orMatchers))}));if("$not"===field)return!rowFilter(doc,matcher,Object.keys(matcher));else return!matcher.find((function(orMatchers){return rowFilter(doc,orMatchers,Object.keys(orMatchers))}))}function match2(userOperator,doc,userValue,parsedField,docFieldValue){if(!matchers[userOperator])throw new Error('unknown operator "'+userOperator+'" - should be one of $eq, $lte, $lt, $gt, $gte, $exists, $ne, $in, $nin, $size, $mod, $regex, $elemMatch, $type, $allMatch or $all');return matchers[userOperator](doc,userValue,parsedField,docFieldValue)}function fieldExists(docFieldValue){return"undefined"!=typeof docFieldValue&&null!==docFieldValue}function fieldIsNotUndefined(docFieldValue){return"undefined"!=typeof docFieldValue}function modField(docFieldValue,userValue){if("number"!=typeof docFieldValue||parseInt(docFieldValue,10)!==docFieldValue)return false;else return docFieldValue%userValue[0]===userValue[1]}function arrayContainsValue(docFieldValue,userValue){return userValue.some((function(val2){if(docFieldValue instanceof Array)return docFieldValue.some((function(docFieldValueItem){return 0===collate(val2,docFieldValueItem)}));else return 0===collate(val2,docFieldValue)}))}function arrayContainsAllValues(docFieldValue,userValue){return userValue.every((function(val2){return docFieldValue.some((function(docFieldValueItem){return 0===collate(val2,docFieldValueItem)}))}))}function arraySize(docFieldValue,userValue){return docFieldValue.length===userValue}function regexMatch(docFieldValue,userValue){return new RegExp(userValue).test(docFieldValue)}function typeMatch(docFieldValue,userValue){switch(userValue){case"null":return null===docFieldValue;case"boolean":return"boolean"==typeof docFieldValue;case"number":return"number"==typeof docFieldValue;case"string":return"string"==typeof docFieldValue;case"array":return docFieldValue instanceof Array;case"object":return"[object Object]"==={}.toString.call(docFieldValue)}}var matchers={$elemMatch:function(doc,userValue,parsedField,docFieldValue){if(!Array.isArray(docFieldValue))return false;if(0===docFieldValue.length)return false;if("object"==typeof docFieldValue[0]&&null!==docFieldValue[0])return docFieldValue.some((function(val2){return rowFilter(val2,userValue,Object.keys(userValue))}));else return docFieldValue.some((function(val2){return matchSelector(userValue,doc,parsedField,val2)}))},$allMatch:function(doc,userValue,parsedField,docFieldValue){if(!Array.isArray(docFieldValue))return false;if(0===docFieldValue.length)return false;if("object"==typeof docFieldValue[0]&&null!==docFieldValue[0])return docFieldValue.every((function(val2){return rowFilter(val2,userValue,Object.keys(userValue))}));else return docFieldValue.every((function(val2){return matchSelector(userValue,doc,parsedField,val2)}))},$eq:function(doc,userValue,parsedField,docFieldValue){return fieldIsNotUndefined(docFieldValue)&&0===collate(docFieldValue,userValue)},$gte:function(doc,userValue,parsedField,docFieldValue){return fieldIsNotUndefined(docFieldValue)&&collate(docFieldValue,userValue)>=0},$gt:function(doc,userValue,parsedField,docFieldValue){return fieldIsNotUndefined(docFieldValue)&&collate(docFieldValue,userValue)>0},$lte:function(doc,userValue,parsedField,docFieldValue){return fieldIsNotUndefined(docFieldValue)&&collate(docFieldValue,userValue)<=0},$lt:function(doc,userValue,parsedField,docFieldValue){return fieldIsNotUndefined(docFieldValue)&&collate(docFieldValue,userValue)<0},$exists:function(doc,userValue,parsedField,docFieldValue){if(userValue)return fieldIsNotUndefined(docFieldValue);else return!fieldIsNotUndefined(docFieldValue)},$mod:function(doc,userValue,parsedField,docFieldValue){return fieldExists(docFieldValue)&&modField(docFieldValue,userValue)},$ne:function(doc,userValue,parsedField,docFieldValue){return userValue.every((function(neValue){return 0!==collate(docFieldValue,neValue)}))},$in:function(doc,userValue,parsedField,docFieldValue){return fieldExists(docFieldValue)&&arrayContainsValue(docFieldValue,userValue)},$nin:function(doc,userValue,parsedField,docFieldValue){return fieldExists(docFieldValue)&&!arrayContainsValue(docFieldValue,userValue)},$size:function(doc,userValue,parsedField,docFieldValue){return fieldExists(docFieldValue)&&Array.isArray(docFieldValue)&&arraySize(docFieldValue,userValue)},$all:function(doc,userValue,parsedField,docFieldValue){return Array.isArray(docFieldValue)&&arrayContainsAllValues(docFieldValue,userValue)},$regex:function(doc,userValue,parsedField,docFieldValue){return fieldExists(docFieldValue)&&"string"==typeof docFieldValue&&userValue.every((function(regexValue){return regexMatch(docFieldValue,regexValue)}))},$type:function(doc,userValue,parsedField,docFieldValue){return typeMatch(docFieldValue,userValue)}};function matchesSelector(doc,selector){if("object"!=typeof selector)throw new Error("Selector error: expected a JSON object");var rowsMatched=filterInMemoryFields([{doc}],{selector:selector=massageSelector(selector)},Object.keys(selector));return rowsMatched&&1===rowsMatched.length}function evalFilter(input){return scopeEval('"use strict";\nreturn '+input+";",{})}function evalView(input){return scopeEval(["return function(doc) {",'  "use strict";',"  var emitted = false;","  var emit = function (a, b) {","    emitted = true;","  };","  var view = "+input+";","  view(doc);","  if (emitted) {","    return true;","  }","};"].join("\n"),{})}function validate4(opts,callback){if(opts.selector)if(opts.filter&&"_selector"!==opts.filter){var filterName="string"==typeof opts.filter?opts.filter:"function";return callback(new Error('selector invalid for filter "'+filterName+'"'))}callback()}function normalize(opts){if(opts.view&&!opts.filter)opts.filter="_view";if(opts.selector&&!opts.filter)opts.filter="_selector";if(opts.filter&&"string"==typeof opts.filter)if("_view"===opts.filter)opts.view=normalizeDesignDocFunctionName(opts.view);else opts.filter=normalizeDesignDocFunctionName(opts.filter)}function shouldFilter(changesHandler,opts){return opts.filter&&"string"==typeof opts.filter&&!opts.doc_ids&&!isRemote(changesHandler.db)}function filter2(changesHandler,opts){var callback=opts.complete;if("_view"===opts.filter){if(!opts.view||"string"!=typeof opts.view){var err2=createError(BAD_REQUEST,"`view` filter parameter not found or invalid.");return callback(err2)}var viewName=parseDesignDocFunctionName(opts.view);changesHandler.db.get("_design/"+viewName[0],(function(err3,ddoc){if(changesHandler.isCancelled)return callback(null,{status:"cancelled"});if(err3)return callback(generateErrorFromResponse(err3));var mapFun=ddoc&&ddoc.views&&ddoc.views[viewName[1]]&&ddoc.views[viewName[1]].map;if(!mapFun)return callback(createError(MISSING_DOC,ddoc.views?"missing json key: "+viewName[1]:"missing json key: views"));opts.filter=evalView(mapFun);changesHandler.doChanges(opts)}))}else if(opts.selector){opts.filter=function(doc){return matchesSelector(doc,opts.selector)};changesHandler.doChanges(opts)}else{var filterName=parseDesignDocFunctionName(opts.filter);changesHandler.db.get("_design/"+filterName[0],(function(err3,ddoc){if(changesHandler.isCancelled)return callback(null,{status:"cancelled"});if(err3)return callback(generateErrorFromResponse(err3));var filterFun=ddoc&&ddoc.filters&&ddoc.filters[filterName[1]];if(!filterFun)return callback(createError(MISSING_DOC,ddoc&&ddoc.filters?"missing json key: "+filterName[1]:"missing json key: filters"));opts.filter=evalFilter(filterFun);changesHandler.doChanges(opts)}))}}function applyChangesFilterPlugin(PouchDB2){PouchDB2._changesFilterPlugin={validate:validate4,normalize,shouldFilter,filter:filter2}}var index_browser_es_default=applyChangesFilterPlugin,import_events14=__toESM(require_events());function tryCatchInChangeListener(self3,change,pending,lastSeq){try{self3.emit("change",change,pending,lastSeq)}catch(e4){guardedConsole("error",'Error in .on("change", function):',e4)}}function processChange(doc,metadata,opts){var changeList=[{rev:doc._rev}];if("all_docs"===opts.style)changeList=collectLeaves(metadata.rev_tree).map((function(x2){return{rev:x2.rev}}));var change={id:metadata.id,changes:changeList,doc};if(isDeleted(metadata,doc._rev))change.deleted=true;if(opts.conflicts){change.doc._conflicts=collectConflicts(metadata);if(!change.doc._conflicts.length)delete change.doc._conflicts}return change}var Changes2=class extends import_events14.default{constructor(db,opts,callback){super();this.db=db;var complete=(opts=opts?clone(opts):{}).complete=once2(((err2,resp)=>{if(err2){if(listenerCount(this,"error")>0)this.emit("error",err2)}else this.emit("complete",resp);this.removeAllListeners();db.removeListener("destroyed",onDestroy2)}));if(callback){this.on("complete",(function(resp){callback(null,resp)}));this.on("error",callback)}const onDestroy2=()=>{this.cancel()};db.once("destroyed",onDestroy2);opts.onChange=(change,pending,lastSeq)=>{if(!this.isCancelled)tryCatchInChangeListener(this,change,pending,lastSeq)};var promise2=new Promise((function(fulfill,reject){opts.complete=function(err2,res2){if(err2)reject(err2);else fulfill(res2)}}));this.once("cancel",(function(){db.removeListener("destroyed",onDestroy2);opts.complete(null,{status:"cancelled"})}));this.then=promise2.then.bind(promise2);this["catch"]=promise2["catch"].bind(promise2);this.then((function(result){complete(null,result)}),complete);if(!db.taskqueue.isReady)db.taskqueue.addTask((failed2=>{if(failed2)opts.complete(failed2);else if(this.isCancelled)this.emit("cancel");else this.validateChanges(opts)}));else this.validateChanges(opts)}cancel(){this.isCancelled=true;if(this.db.taskqueue.isReady)this.emit("cancel")}validateChanges(opts){var callback=opts.complete;if(PouchDB._changesFilterPlugin)PouchDB._changesFilterPlugin.validate(opts,(err2=>{if(err2)return callback(err2);this.doChanges(opts)}));else this.doChanges(opts)}doChanges(opts){var callback=opts.complete;if("live"in(opts=clone(opts))&&!("continuous"in opts))opts.continuous=opts.live;opts.processChange=processChange;if("latest"===opts.since)opts.since="now";if(!opts.since)opts.since=0;if("now"!==opts.since){if(PouchDB._changesFilterPlugin){PouchDB._changesFilterPlugin.normalize(opts);if(PouchDB._changesFilterPlugin.shouldFilter(this,opts))return PouchDB._changesFilterPlugin.filter(this,opts)}else["doc_ids","filter","selector","view"].forEach((function(key2){if(key2 in opts)guardedConsole("warn",'The "'+key2+'" option was passed in to changes/replicate, but pouchdb-changes-filter plugin is not installed, so it was ignored. Please install the plugin to enable filtering.')}));if(!("descending"in opts))opts.descending=false;opts.limit=0===opts.limit?1:opts.limit;opts.complete=callback;var newPromise=this.db._changes(opts);if(newPromise&&"function"==typeof newPromise.cancel){const cancel=this.cancel;this.cancel=(...args)=>{newPromise.cancel();cancel.apply(this,args)}}}else this.db.info().then((info3=>{if(!this.isCancelled){opts.since=info3.update_seq;this.doChanges(opts)}else callback(null,{status:"cancelled"})}),callback)}};function yankError(callback,docId){return function(err2,results){if(err2||results[0]&&results[0].error){(err2=err2||results[0]).docId=docId;callback(err2)}else callback(null,results.length?results[0]:results)}}function cleanDocs(docs){for(var i2=0;i2<docs.length;i2++){var doc=docs[i2];if(doc._deleted)delete doc._attachments;else if(doc._attachments)for(var atts=Object.keys(doc._attachments),j2=0;j2<atts.length;j2++){var att=atts[j2];doc._attachments[att]=pick(doc._attachments[att],["data","digest","content_type","length","revpos","stub"])}}}function compareByIdThenRev(a2,b3){if(a2._id===b3._id)return(a2._revisions?a2._revisions.start:0)-(b3._revisions?b3._revisions.start:0);else return a2._id<b3._id?-1:1}function computeHeight(revs){var height={},edges=[];traverseRevTree(revs,(function(isLeaf,pos,id,prnt){var rev$$1=pos+"-"+id;if(isLeaf)height[rev$$1]=0;if(void 0!==prnt)edges.push({from:prnt,to:rev$$1});return rev$$1}));edges.reverse();edges.forEach((function(edge){if(void 0===height[edge.from])height[edge.from]=1+height[edge.to];else height[edge.from]=Math.min(height[edge.from],1+height[edge.to])}));return height}function allDocsKeysParse(opts){var keys2="limit"in opts?opts.keys.slice(opts.skip,opts.limit+opts.skip):opts.skip>0?opts.keys.slice(opts.skip):opts.keys;opts.keys=keys2;opts.skip=0;delete opts.limit;if(opts.descending){keys2.reverse();opts.descending=false}}function doNextCompaction(self3){var task=self3._compactionQueue[0],opts=task.opts,callback=task.callback;self3.get("_local/compaction").catch((function(){return false})).then((function(doc){if(doc&&doc.last_seq)opts.last_seq=doc.last_seq;self3._compact(opts,(function(err2,res2){if(err2)callback(err2);else callback(null,res2);nextTick((function(){self3._compactionQueue.shift();if(self3._compactionQueue.length)doNextCompaction(self3)}))}))}))}function appendPurgeSeq(db,docId,rev$$1){return db.get("_local/purges").then((function(doc){const purgeSeq=doc.purgeSeq+1;doc.purges.push({docId,rev:rev$$1,purgeSeq});if(doc.purges.length>self.purged_infos_limit)doc.purges.splice(0,doc.purges.length-self.purged_infos_limit);doc.purgeSeq=purgeSeq;return doc})).catch((function(err2){if(404!==err2.status)throw err2;return{_id:"_local/purges",purges:[{docId,rev:rev$$1,purgeSeq:0}],purgeSeq:0}})).then((function(doc){return db.put(doc)}))}function attachmentNameError(name){if("_"===name.charAt(0))return name+" is not a valid attachment name, attachment names cannot start with '_'";else return false}function isNotSingleDoc(doc){return null===doc||"object"!=typeof doc||Array.isArray(doc)}var validRevRegex=/^\d+-[^-]*$/;function isValidRev(rev$$1){return"string"==typeof rev$$1&&validRevRegex.test(rev$$1)}var AbstractPouchDB=class extends import_events14.default{_setup(){this.post=adapterFun("post",(function(doc,opts,callback){if("function"==typeof opts){callback=opts;opts={}}if(isNotSingleDoc(doc))return callback(createError(NOT_AN_OBJECT));this.bulkDocs({docs:[doc]},opts,yankError(callback,doc._id))})).bind(this);this.put=adapterFun("put",(function(doc,opts,cb2){if("function"==typeof opts){cb2=opts;opts={}}if(isNotSingleDoc(doc))return cb2(createError(NOT_AN_OBJECT));invalidIdError(doc._id);if("_rev"in doc&&!isValidRev(doc._rev))return cb2(createError(INVALID_REV));if(isLocalId(doc._id)&&"function"==typeof this._putLocal)if(doc._deleted)return this._removeLocal(doc,cb2);else return this._putLocal(doc,cb2);const putDoc=next=>{if("function"==typeof this._put&&false!==opts.new_edits)this._put(doc,opts,next);else this.bulkDocs({docs:[doc]},opts,yankError(next,doc._id))};if(opts.force&&doc._rev){(function transformForceOptionToNewEditsOption(){var parts=doc._rev.split("-"),oldRevId=parts[1],newRevNum=parseInt(parts[0],10)+1,newRevId=rev2();doc._revisions={start:newRevNum,ids:[newRevId,oldRevId]};doc._rev=newRevNum+"-"+newRevId;opts.new_edits=false})();putDoc((function(err2){var result=err2?null:{ok:true,id:doc._id,rev:doc._rev};cb2(err2,result)}))}else putDoc(cb2)})).bind(this);this.putAttachment=adapterFun("putAttachment",(function(docId,attachmentId,rev$$1,blob,type){var api=this;if("function"==typeof type){type=blob;blob=rev$$1;rev$$1=null}if("undefined"==typeof type){type=blob;blob=rev$$1;rev$$1=null}if(!type)guardedConsole("warn","Attachment",attachmentId,"on document",docId,"is missing content_type");function createAttachment(doc){var prevrevpos="_rev"in doc?parseInt(doc._rev,10):0;doc._attachments=doc._attachments||{};doc._attachments[attachmentId]={content_type:type,data:blob,revpos:++prevrevpos};return api.put(doc)}return api.get(docId).then((function(doc){if(doc._rev!==rev$$1)throw createError(REV_CONFLICT);return createAttachment(doc)}),(function(err2){if(err2.reason===MISSING_DOC.message)return createAttachment({_id:docId});else throw err2}))})).bind(this);this.removeAttachment=adapterFun("removeAttachment",(function(docId,attachmentId,rev$$1,callback){this.get(docId,((err2,obj)=>{if(!err2)if(obj._rev===rev$$1){if(!obj._attachments)return callback();delete obj._attachments[attachmentId];if(0===Object.keys(obj._attachments).length)delete obj._attachments;this.put(obj,callback)}else callback(createError(REV_CONFLICT));else callback(err2)}))})).bind(this);this.remove=adapterFun("remove",(function(docOrId,optsOrRev,opts,callback){var doc;if("string"==typeof optsOrRev){doc={_id:docOrId,_rev:optsOrRev};if("function"==typeof opts){callback=opts;opts={}}}else{doc=docOrId;if("function"==typeof optsOrRev){callback=optsOrRev;opts={}}else{callback=opts;opts=optsOrRev}}(opts=opts||{}).was_delete=true;var newDoc={_id:doc._id,_rev:doc._rev||opts.rev,_deleted:true};if(isLocalId(newDoc._id)&&"function"==typeof this._removeLocal)return this._removeLocal(doc,callback);this.bulkDocs({docs:[newDoc]},opts,yankError(callback,newDoc._id))})).bind(this);this.revsDiff=adapterFun("revsDiff",(function(req,opts,callback){if("function"==typeof opts){callback=opts;opts={}}var ids=Object.keys(req);if(!ids.length)return callback(null,{});var count=0,missing=new Map;function addToMissing(id,revId){if(!missing.has(id))missing.set(id,{missing:[]});missing.get(id).missing.push(revId)}ids.forEach((function(id){this._getRevisionTree(id,(function(err2,rev_tree){if(err2&&404===err2.status&&"missing"===err2.message)missing.set(id,{missing:req[id]});else if(err2)return callback(err2);else(function processDoc(id,rev_tree){var missingForId=req[id].slice(0);traverseRevTree(rev_tree,(function(isLeaf,pos,revHash,ctx,opts2){var rev$$1=pos+"-"+revHash,idx2=missingForId.indexOf(rev$$1);if(-1!==idx2){missingForId.splice(idx2,1);if("available"!==opts2.status)addToMissing(id,rev$$1)}}));missingForId.forEach((function(rev$$1){addToMissing(id,rev$$1)}))})(id,rev_tree);if(++count===ids.length){var missingObj={};missing.forEach((function(value,key2){missingObj[key2]=value}));return callback(null,missingObj)}}))}),this)})).bind(this);this.bulkGet=adapterFun("bulkGet",(function(opts,callback){bulkGet(this,opts,callback)})).bind(this);this.compactDocument=adapterFun("compactDocument",(function(docId,maxHeight,callback){this._getRevisionTree(docId,((err2,revTree)=>{if(err2)return callback(err2);var height=computeHeight(revTree),candidates=[],revs=[];Object.keys(height).forEach((function(rev$$1){if(height[rev$$1]>maxHeight)candidates.push(rev$$1)}));traverseRevTree(revTree,(function(isLeaf,pos,revHash,ctx,opts){var rev$$1=pos+"-"+revHash;if("available"===opts.status&&-1!==candidates.indexOf(rev$$1))revs.push(rev$$1)}));this._doCompaction(docId,revs,callback)}))})).bind(this);this.compact=adapterFun("compact",(function(opts,callback){if("function"==typeof opts){callback=opts;opts={}}opts=opts||{};this._compactionQueue=this._compactionQueue||[];this._compactionQueue.push({opts,callback});if(1===this._compactionQueue.length)doNextCompaction(this)})).bind(this);this.get=adapterFun("get",(function(id,opts,cb2){if("function"==typeof opts){cb2=opts;opts={}}opts=opts||{};if("string"!=typeof id)return cb2(createError(INVALID_ID));if(isLocalId(id)&&"function"==typeof this._getLocal)return this._getLocal(id,cb2);var leaves=[];const finishOpenRevs=()=>{var result=[],count=leaves.length;if(!count)return cb2(null,result);leaves.forEach((leaf=>{this.get(id,{rev:leaf,revs:opts.revs,latest:opts.latest,attachments:opts.attachments,binary:opts.binary},(function(err2,doc){if(!err2){for(var existing,i3=0,l3=result.length;i3<l3;i3++)if(result[i3].ok&&result[i3].ok._rev===doc._rev){existing=true;break}if(!existing)result.push({ok:doc})}else result.push({missing:leaf});if(! --count)cb2(null,result)}))}))};if(!opts.open_revs)return this._get(id,opts,((err2,result)=>{if(err2){err2.docId=id;return cb2(err2)}var doc=result.doc,metadata=result.metadata,ctx=result.ctx;if(opts.conflicts){var conflicts=collectConflicts(metadata);if(conflicts.length)doc._conflicts=conflicts}if(isDeleted(metadata,doc._rev))doc._deleted=true;if(opts.revs||opts.revs_info){for(var splittedRev=doc._rev.split("-"),revNo=parseInt(splittedRev[0],10),revHash=splittedRev[1],paths=rootToLeaf(metadata.rev_tree),path2=null,i3=0;i3<paths.length;i3++){var currentPath=paths[i3];const hashIndex=currentPath.ids.findIndex((x2=>x2.id===revHash));if(hashIndex===revNo-1||!path2&&-1!==hashIndex)path2=currentPath}if(!path2){(err2=new Error("invalid rev tree")).docId=id;return cb2(err2)}const pathId=doc._rev.split("-")[1],indexOfRev=path2.ids.findIndex((x2=>x2.id===pathId))+1;var howMany=path2.ids.length-indexOfRev;path2.ids.splice(indexOfRev,howMany);path2.ids.reverse();if(opts.revs)doc._revisions={start:path2.pos+path2.ids.length-1,ids:path2.ids.map((function(rev$$1){return rev$$1.id}))};if(opts.revs_info){var pos=path2.pos+path2.ids.length;doc._revs_info=path2.ids.map((function(rev$$1){return{rev:--pos+"-"+rev$$1.id,status:rev$$1.opts.status}}))}}if(opts.attachments&&doc._attachments){var attachments=doc._attachments,count=Object.keys(attachments).length;if(0===count)return cb2(null,doc);Object.keys(attachments).forEach((key3=>{this._getAttachment(doc._id,key3,attachments[key3],{binary:opts.binary,metadata,ctx},(function(err3,data){var att=doc._attachments[key3];att.data=data;delete att.stub;delete att.length;if(! --count)cb2(null,doc)}))}))}else{if(doc._attachments)for(var key2 in doc._attachments)if(Object.prototype.hasOwnProperty.call(doc._attachments,key2))doc._attachments[key2].stub=true;cb2(null,doc)}}));else if("all"===opts.open_revs)this._getRevisionTree(id,(function(err2,rev_tree){if(err2)return cb2(err2);leaves=collectLeaves(rev_tree).map((function(leaf){return leaf.rev}));finishOpenRevs()}));else if(Array.isArray(opts.open_revs)){leaves=opts.open_revs;for(var i2=0;i2<leaves.length;i2++)if(!isValidRev(leaves[i2]))return cb2(createError(INVALID_REV));finishOpenRevs()}else return cb2(createError(UNKNOWN_ERROR,"function_clause"))})).bind(this);this.getAttachment=adapterFun("getAttachment",(function(docId,attachmentId,opts,callback){if(opts instanceof Function){callback=opts;opts={}}this._get(docId,opts,((err2,res2)=>{if(err2)return callback(err2);if(res2.doc._attachments&&res2.doc._attachments[attachmentId]){opts.ctx=res2.ctx;opts.binary=true;opts.metadata=res2.metadata;this._getAttachment(docId,attachmentId,res2.doc._attachments[attachmentId],opts,callback)}else return callback(createError(MISSING_DOC))}))})).bind(this);this.allDocs=adapterFun("allDocs",(function(opts,callback){if("function"==typeof opts){callback=opts;opts={}}opts.skip="undefined"!=typeof opts.skip?opts.skip:0;if(opts.start_key)opts.startkey=opts.start_key;if(opts.end_key)opts.endkey=opts.end_key;if("keys"in opts){if(!Array.isArray(opts.keys))return callback(new TypeError("options.keys must be an array"));var incompatibleOpt=["startkey","endkey","key"].filter((function(incompatibleOpt2){return incompatibleOpt2 in opts}))[0];if(incompatibleOpt){callback(createError(QUERY_PARSE_ERROR,"Query parameter `"+incompatibleOpt+"` is not compatible with multi-get"));return}if(!isRemote(this)){allDocsKeysParse(opts);if(0===opts.keys.length)return this._allDocs({limit:0},callback)}}return this._allDocs(opts,callback)})).bind(this);this.close=adapterFun("close",(function(callback){this._closed=true;this.emit("closed");return this._close(callback)})).bind(this);this.info=adapterFun("info",(function(callback){this._info(((err2,info3)=>{if(err2)return callback(err2);info3.db_name=info3.db_name||this.name;info3.auto_compaction=!!(this.auto_compaction&&!isRemote(this));info3.adapter=this.adapter;callback(null,info3)}))})).bind(this);this.id=adapterFun("id",(function(callback){return this._id(callback)})).bind(this);this.bulkDocs=adapterFun("bulkDocs",(function(req,opts,callback){if("function"==typeof opts){callback=opts;opts={}}opts=opts||{};if(Array.isArray(req))req={docs:req};if(!req||!req.docs||!Array.isArray(req.docs))return callback(createError(MISSING_BULK_DOCS));for(var i2=0;i2<req.docs.length;++i2){const doc=req.docs[i2];if(isNotSingleDoc(doc))return callback(createError(NOT_AN_OBJECT));if("_rev"in doc&&!isValidRev(doc._rev))return callback(createError(INVALID_REV))}var attachmentError;req.docs.forEach((function(doc){if(doc._attachments)Object.keys(doc._attachments).forEach((function(name){attachmentError=attachmentError||attachmentNameError(name);if(!doc._attachments[name].content_type)guardedConsole("warn","Attachment",name,"on document",doc._id,"is missing content_type")}))}));if(attachmentError)return callback(createError(BAD_REQUEST,attachmentError));if(!("new_edits"in opts))if("new_edits"in req)opts.new_edits=req.new_edits;else opts.new_edits=true;var adapter=this;if(!opts.new_edits&&!isRemote(adapter))req.docs.sort(compareByIdThenRev);cleanDocs(req.docs);var ids=req.docs.map((function(doc){return doc._id}));this._bulkDocs(req,opts,(function(err2,res2){if(err2)return callback(err2);if(!opts.new_edits)res2=res2.filter((function(x2){return x2.error}));if(!isRemote(adapter))for(var i3=0,l2=res2.length;i3<l2;i3++)res2[i3].id=res2[i3].id||ids[i3];callback(null,res2)}))})).bind(this);this.registerDependentDatabase=adapterFun("registerDependentDatabase",(function(dependentDb,callback){var dbOptions=clone(this.__opts);if(this.__opts.view_adapter)dbOptions.adapter=this.__opts.view_adapter;var depDB=new this.constructor(dependentDb,dbOptions);upsert(this,"_local/_pouch_dependentDbs",(function diffFun(doc){doc.dependentDbs=doc.dependentDbs||{};if(doc.dependentDbs[dependentDb])return false;doc.dependentDbs[dependentDb]=true;return doc})).then((function(){callback(null,{db:depDB})})).catch(callback)})).bind(this);this.destroy=adapterFun("destroy",(function(opts,callback){if("function"==typeof opts){callback=opts;opts={}}var usePrefix="use_prefix"in this?this.use_prefix:true;const destroyDb=()=>{this._destroy(opts,((err2,resp)=>{if(err2)return callback(err2);this._destroyed=true;this.emit("destroyed");callback(null,resp||{ok:true})}))};if(isRemote(this))return destroyDb();this.get("_local/_pouch_dependentDbs",((err2,localDoc)=>{if(err2)if(404!==err2.status)return callback(err2);else return destroyDb();var dependentDbs=localDoc.dependentDbs,PouchDB2=this.constructor,deletedMap=Object.keys(dependentDbs).map((name=>{var trueName=usePrefix?name.replace(new RegExp("^"+PouchDB2.prefix),""):name;return new PouchDB2(trueName,this.__opts).destroy()}));Promise.all(deletedMap).then(destroyDb,callback)}))})).bind(this)}_compact(opts,callback){var taskId,changesOpts={return_docs:false,last_seq:opts.last_seq||0,since:opts.last_seq||0},promises=[],compactedDocs=0;const onChange=row=>{this.activeTasks.update(taskId,{completed_items:++compactedDocs});promises.push(this.compactDocument(row.id,0))},onError=err2=>{this.activeTasks.remove(taskId,err2);callback(err2)},onComplete=resp=>{var lastSeq=resp.last_seq;Promise.all(promises).then((()=>upsert(this,"_local/compaction",(doc=>{if(!doc.last_seq||doc.last_seq<lastSeq){doc.last_seq=lastSeq;return doc}return false})))).then((()=>{this.activeTasks.remove(taskId);callback(null,{ok:true})})).catch(onError)};this.info().then((info3=>{taskId=this.activeTasks.add({name:"database_compaction",total_items:info3.update_seq-changesOpts.last_seq});this.changes(changesOpts).on("change",onChange).on("complete",onComplete).on("error",onError)}))}changes(opts,callback){if("function"==typeof opts){callback=opts;opts={}}(opts=opts||{}).return_docs="return_docs"in opts?opts.return_docs:!opts.live;return new Changes2(this,opts,callback)}type(){return"function"==typeof this._type?this._type():this.adapter}};AbstractPouchDB.prototype.purge=adapterFun("_purge",(function(docId,rev$$1,callback){if("undefined"==typeof this._purge)return callback(createError(UNKNOWN_ERROR,"Purge is not implemented in the "+this.adapter+" adapter."));var self3=this;self3._getRevisionTree(docId,((error,revs)=>{if(error)return callback(error);if(!revs)return callback(createError(MISSING_DOC));let path2;try{path2=findPathToLeaf(revs,rev$$1)}catch(error2){return callback(error2.message||error2)}self3._purge(docId,path2,((error2,result)=>{if(error2)return callback(error2);else appendPurgeSeq(self3,docId,rev$$1).then((function(){return callback(null,result)}))}))}))}));var TaskQueue=class{constructor(){this.isReady=false;this.failed=false;this.queue=[]}execute(){var fun;if(this.failed)for(;fun=this.queue.shift();)fun(this.failed);else for(;fun=this.queue.shift();)fun()}fail(err2){this.failed=err2;this.execute()}ready(db){this.isReady=true;this.db=db;this.execute()}addTask(fun){this.queue.push(fun);if(this.failed)this.execute()}};function parseAdapter(name,opts){var match3=name.match(/([a-z-]*):\/\/(.*)/);if(match3)return{name:/https?/.test(match3[1])?match3[1]+"://"+match3[2]:match3[2],adapter:match3[1]};var adapters=PouchDB.adapters,preferredAdapters=PouchDB.preferredAdapters,prefix=PouchDB.prefix,adapterName=opts.adapter;if(!adapterName)for(var i2=0;i2<preferredAdapters.length&&"idb"===(adapterName=preferredAdapters[i2])&&"websql"in adapters&&hasLocalStorage()&&localStorage["_pouch__websqldb_"+prefix+name];++i2)guardedConsole("log",'PouchDB is downgrading "'+name+'" to WebSQL to avoid data loss, because it was already opened with WebSQL.');var adapter=adapters[adapterName];return{name:(adapter&&"use_prefix"in adapter?adapter.use_prefix:true)?prefix+name:name,adapter:adapterName}}function inherits(A2,B2){A2.prototype=Object.create(B2.prototype,{constructor:{value:A2}})}function createClass(parent,init3){let klass=function(...args){if(!(this instanceof klass))return new klass(...args);init3.apply(this,args)};inherits(klass,parent);return klass}function prepareForDestruction(self3){function onDestroyed(from_constructor){self3.removeListener("closed",onClosed);if(!from_constructor)self3.constructor.emit("destroyed",self3.name)}function onClosed(){self3.removeListener("destroyed",onDestroyed);self3.constructor.emit("unref",self3)}self3.once("destroyed",onDestroyed);self3.once("closed",onClosed);self3.constructor.emit("ref",self3)}var PouchInternal=class extends AbstractPouchDB{constructor(name,opts){super();this._setup(name,opts)}_setup(name,opts){super._setup();opts=opts||{};if(name&&"object"==typeof name){name=(opts=name).name;delete opts.name}if(void 0===opts.deterministic_revs)opts.deterministic_revs=true;this.__opts=opts=clone(opts);this.auto_compaction=opts.auto_compaction;this.purged_infos_limit=opts.purged_infos_limit||1e3;this.prefix=PouchDB.prefix;if("string"!=typeof name)throw new Error("Missing/invalid DB name");var backend=parseAdapter((opts.prefix||"")+name,opts);opts.name=backend.name;opts.adapter=opts.adapter||backend.adapter;this.name=name;this._adapter=opts.adapter;PouchDB.emit("debug",["adapter","Picked adapter: ",opts.adapter]);if(!PouchDB.adapters[opts.adapter]||!PouchDB.adapters[opts.adapter].valid())throw new Error("Invalid Adapter: "+opts.adapter);if(opts.view_adapter)if(!PouchDB.adapters[opts.view_adapter]||!PouchDB.adapters[opts.view_adapter].valid())throw new Error("Invalid View Adapter: "+opts.view_adapter);this.taskqueue=new TaskQueue;this.adapter=opts.adapter;PouchDB.adapters[opts.adapter].call(this,opts,(err2=>{if(err2)return this.taskqueue.fail(err2);prepareForDestruction(this);this.emit("created",this);PouchDB.emit("created",this.name);this.taskqueue.ready(this)}))}},PouchDB=createClass(PouchInternal,(function(name,opts){PouchInternal.prototype._setup.call(this,name,opts)})),ActiveTasks=class{constructor(){this.tasks={}}list(){return Object.values(this.tasks)}add(task){const id=v4_default2();this.tasks[id]={id,name:task.name,total_items:task.total_items,created_at:(new Date).toJSON()};return id}get(id){return this.tasks[id]}remove(id,reason){delete this.tasks[id];return this.tasks}update(id,updatedTask){const task=this.tasks[id];if("undefined"!=typeof task){const mergedTask={id:task.id,name:task.name,created_at:task.created_at,total_items:updatedTask.total_items||task.total_items,completed_items:updatedTask.completed_items||task.completed_items,updated_at:(new Date).toJSON()};this.tasks[id]=mergedTask}return this.tasks}};PouchDB.adapters={};PouchDB.preferredAdapters=[];PouchDB.prefix="_pouch_";var eventEmitter=new import_events14.default;function setUpEventEmitter(Pouch){Object.keys(import_events14.default.prototype).forEach((function(key2){if("function"==typeof import_events14.default.prototype[key2])Pouch[key2]=eventEmitter[key2].bind(eventEmitter)}));var destructListeners=Pouch._destructionListeners=new Map;Pouch.on("ref",(function onConstructorRef(db){if(!destructListeners.has(db.name))destructListeners.set(db.name,[]);destructListeners.get(db.name).push(db)}));Pouch.on("unref",(function onConstructorUnref(db){if(destructListeners.has(db.name)){var dbList=destructListeners.get(db.name),pos=dbList.indexOf(db);if(!(pos<0)){dbList.splice(pos,1);if(dbList.length>1)destructListeners.set(db.name,dbList);else destructListeners.delete(db.name)}}}));Pouch.on("destroyed",(function onConstructorDestroyed(name){if(destructListeners.has(name)){var dbList=destructListeners.get(name);destructListeners.delete(name);dbList.forEach((function(db){db.emit("destroyed",true)}))}}))}setUpEventEmitter(PouchDB);PouchDB.adapter=function(id,obj,addToPreferredAdapters){if(obj.valid()){PouchDB.adapters[id]=obj;if(addToPreferredAdapters)PouchDB.preferredAdapters.push(id)}};PouchDB.plugin=function(obj){if("function"==typeof obj)obj(PouchDB);else if("object"!=typeof obj||0===Object.keys(obj).length)throw new Error('Invalid plugin: got "'+obj+'", expected an object or a function');else Object.keys(obj).forEach((function(id){PouchDB.prototype[id]=obj[id]}));if(this.__defaults)PouchDB.__defaults=Object.assign({},this.__defaults);return PouchDB};PouchDB.defaults=function(defaultOpts){let PouchWithDefaults=createClass(PouchDB,(function(name,opts){opts=opts||{};if(name&&"object"==typeof name){name=(opts=name).name;delete opts.name}opts=Object.assign({},PouchWithDefaults.__defaults,opts);PouchDB.call(this,name,opts)}));PouchWithDefaults.preferredAdapters=PouchDB.preferredAdapters.slice();Object.keys(PouchDB).forEach((function(key2){if(!(key2 in PouchWithDefaults))PouchWithDefaults[key2]=PouchDB[key2]}));PouchWithDefaults.__defaults=Object.assign({},this.__defaults,defaultOpts);return PouchWithDefaults};PouchDB.fetch=function(url,opts){return f3(url,opts)};PouchDB.prototype.activeTasks=PouchDB.activeTasks=new ActiveTasks;var version="9.0.0";PouchDB.plugin(index_browser_es_default);PouchDB.version=version;var index_es_default=PouchDB,import_vuvuzela=__toESM(require_vuvuzela());function safeJsonParse(str){try{return JSON.parse(str)}catch(e4){return import_vuvuzela.default.parse(str)}}function safeJsonStringify(json){try{return JSON.stringify(json)}catch(e4){return import_vuvuzela.default.stringify(json)}}var import_spark_md52=__toESM(require_spark_md5()),setImmediateShim2=self.setImmediate||self.setTimeout,MD5_CHUNK_SIZE2=32768;function rawToBase642(raw){return thisBtoa(raw)}function appendBlob2(buffer,blob,start,end,callback){if(start>0||end<blob.size)blob=blob.slice(start,end);readAsArrayBuffer(blob,(function(arrayBuffer){buffer.append(arrayBuffer);callback()}))}function appendString2(buffer,string,start,end,callback){if(start>0||end<string.length)string=string.substring(start,end);buffer.appendBinary(string);callback()}function binaryMd52(data,callback){var inputIsString="string"==typeof data,len=inputIsString?data.length:data.size,chunkSize=Math.min(MD5_CHUNK_SIZE2,len),chunks=Math.ceil(len/chunkSize),currentChunk=0,buffer=inputIsString?new import_spark_md52.default:new import_spark_md52.default.ArrayBuffer,append2=inputIsString?appendString2:appendBlob2;function next(){setImmediateShim2(loadNextChunk)}function done(){var base64=rawToBase642(buffer.end(true));callback(base64);buffer.destroy()}function loadNextChunk(){var start=currentChunk*chunkSize,end=start+chunkSize;if(++currentChunk<chunks)append2(buffer,data,start,end,next);else append2(buffer,data,start,end,done)}loadNextChunk()}function stringMd52(string){return import_spark_md52.default.hash(string)}function allDocsKeysQuery(api,opts){var keys2=opts.keys,finalResults={offset:opts.skip};return Promise.all(keys2.map((function(key2){var subOpts=Object.assign({key:key2,deleted:"ok"},opts);["limit","skip","keys"].forEach((function(optKey){delete subOpts[optKey]}));return new Promise((function(resolve,reject){api._allDocs(subOpts,(function(err2,res2){if(err2)return reject(err2);if(opts.update_seq&&void 0!==res2.update_seq)finalResults.update_seq=res2.update_seq;finalResults.total_rows=res2.total_rows;resolve(res2.rows[0]||{key:key2,error:"not_found"})}))}))}))).then((function(results){finalResults.rows=results;return finalResults}))}function checkBlobSupport(txn,store,docIdOrCreateDoc){return new Promise((function(resolve){var blob$$1=createBlob2([""]);let req;if("function"==typeof docIdOrCreateDoc){const doc=docIdOrCreateDoc(blob$$1);req=txn.objectStore(store).put(doc)}else{const docId=docIdOrCreateDoc;req=txn.objectStore(store).put(blob$$1,docId)}req.onsuccess=function(){var matchedChrome=navigator.userAgent.match(/Chrome\/(\d+)/),matchedEdge=navigator.userAgent.match(/Edge\//);resolve(matchedEdge||!matchedChrome||parseInt(matchedChrome[1],10)>=43)};req.onerror=txn.onabort=function(e4){e4.preventDefault();e4.stopPropagation();resolve(false)}})).catch((function(){return false}))}function toObject(array){return array.reduce((function(obj,item){obj[item]=true;return obj}),{})}var reservedWords=toObject(["_id","_rev","_access","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats","_removed"]),dataWords=toObject(["_access","_attachments","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats"]);function parseRevisionInfo(rev$$1){if(!/^\d+-/.test(rev$$1))return createError(INVALID_REV);var idx2=rev$$1.indexOf("-"),left=rev$$1.substring(0,idx2),right=rev$$1.substring(idx2+1);return{prefix:parseInt(left,10),id:right}}function makeRevTreeFromRevisions(revisions,opts){for(var pos=revisions.start-revisions.ids.length+1,revisionIds=revisions.ids,ids=[revisionIds[0],opts,[]],i2=1,len=revisionIds.length;i2<len;i2++)ids=[revisionIds[i2],{status:"missing"},[ids]];return[{pos,ids}]}function parseDoc(doc,newEdits,dbOpts){if(!dbOpts)dbOpts={deterministic_revs:true};var nRevNum,newRevId,revInfo,opts={status:"available"};if(doc._deleted)opts.deleted=true;if(newEdits){if(!doc._id)doc._id=uuid();newRevId=rev2(doc,dbOpts.deterministic_revs);if(doc._rev){if((revInfo=parseRevisionInfo(doc._rev)).error)return revInfo;doc._rev_tree=[{pos:revInfo.prefix,ids:[revInfo.id,{status:"missing"},[[newRevId,opts,[]]]]}];nRevNum=revInfo.prefix+1}else{doc._rev_tree=[{pos:1,ids:[newRevId,opts,[]]}];nRevNum=1}}else{if(doc._revisions){doc._rev_tree=makeRevTreeFromRevisions(doc._revisions,opts);nRevNum=doc._revisions.start;newRevId=doc._revisions.ids[0]}if(!doc._rev_tree){if((revInfo=parseRevisionInfo(doc._rev)).error)return revInfo;nRevNum=revInfo.prefix;newRevId=revInfo.id;doc._rev_tree=[{pos:nRevNum,ids:[newRevId,opts,[]]}]}}invalidIdError(doc._id);doc._rev=nRevNum+"-"+newRevId;var result={metadata:{},data:{}};for(var key2 in doc)if(Object.prototype.hasOwnProperty.call(doc,key2)){var specialKey="_"===key2[0];if(specialKey&&!reservedWords[key2]){var error=createError(DOC_VALIDATION,key2);error.message=DOC_VALIDATION.message+": "+key2;throw error}else if(specialKey&&!dataWords[key2])result.metadata[key2.slice(1)]=doc[key2];else result.data[key2]=doc[key2]}return result}function parseBase64(data){try{return thisAtob(data)}catch(e4){return{error:createError(BAD_ARG,"Attachment is not a valid base64 string")}}}function preprocessString(att,blobType,callback){var asBinary=parseBase64(att.data);if(asBinary.error)return callback(asBinary.error);att.length=asBinary.length;if("blob"===blobType)att.data=binStringToBluffer(asBinary,att.content_type);else if("base64"===blobType)att.data=thisBtoa(asBinary);else att.data=asBinary;binaryMd52(asBinary,(function(result){att.digest="md5-"+result;callback()}))}function preprocessBlob(att,blobType,callback){binaryMd52(att.data,(function(md5){att.digest="md5-"+md5;att.length=att.data.size||att.data.length||0;if("binary"===blobType)blobToBinaryString(att.data,(function(binString){att.data=binString;callback()}));else if("base64"===blobType)blobToBase64(att.data,(function(b64){att.data=b64;callback()}));else callback()}))}function preprocessAttachment(att,blobType,callback){if(att.stub)return callback();if("string"==typeof att.data)preprocessString(att,blobType,callback);else preprocessBlob(att,blobType,callback)}function preprocessAttachments(docInfos,blobType,callback){if(!docInfos.length)return callback();var overallErr,docv=0;docInfos.forEach((function(docInfo){var attachments=docInfo.data&&docInfo.data._attachments?Object.keys(docInfo.data._attachments):[],recv=0;if(!attachments.length)return done();function processedAttachment(err2){overallErr=err2;if(++recv===attachments.length)done()}for(var key2 in docInfo.data._attachments)if(Object.prototype.hasOwnProperty.call(docInfo.data._attachments,key2))preprocessAttachment(docInfo.data._attachments[key2],blobType,processedAttachment)}));function done(){docv++;if(docInfos.length===docv)if(overallErr)callback(overallErr);else callback()}}function updateDoc(revLimit,prev,docInfo,results,i2,cb2,writeDoc,newEdits){if(revExists(prev.rev_tree,docInfo.metadata.rev)&&!newEdits){results[i2]=docInfo;return cb2()}var previousWinningRev=prev.winningRev||winningRev(prev),previouslyDeleted="deleted"in prev?prev.deleted:isDeleted(prev,previousWinningRev),deleted="deleted"in docInfo.metadata?docInfo.metadata.deleted:isDeleted(docInfo.metadata),isRoot=/^1-/.test(docInfo.metadata.rev);if(previouslyDeleted&&!deleted&&newEdits&&isRoot){var newDoc=docInfo.data;newDoc._rev=previousWinningRev;newDoc._id=docInfo.metadata.id;docInfo=parseDoc(newDoc,newEdits)}var merged=merge(prev.rev_tree,docInfo.metadata.rev_tree[0],revLimit);if(newEdits&&(previouslyDeleted&&deleted&&"new_leaf"!==merged.conflicts||!previouslyDeleted&&"new_leaf"!==merged.conflicts||previouslyDeleted&&!deleted&&"new_branch"===merged.conflicts)){var err2=createError(REV_CONFLICT);results[i2]=err2;return cb2()}var newRev=docInfo.metadata.rev;docInfo.metadata.rev_tree=merged.tree;docInfo.stemmedRevs=merged.stemmedRevs||[];if(prev.rev_map)docInfo.metadata.rev_map=prev.rev_map;var newRevIsDeleted,winningRev$$1=winningRev(docInfo.metadata),winningRevIsDeleted=isDeleted(docInfo.metadata,winningRev$$1),delta=previouslyDeleted===winningRevIsDeleted?0:previouslyDeleted<winningRevIsDeleted?-1:1;if(newRev===winningRev$$1)newRevIsDeleted=winningRevIsDeleted;else newRevIsDeleted=isDeleted(docInfo.metadata,newRev);writeDoc(docInfo,winningRev$$1,winningRevIsDeleted,newRevIsDeleted,true,delta,i2,cb2)}function rootIsMissing(docInfo){return"missing"===docInfo.metadata.rev_tree[0].ids[1].status}function processDocs(revLimit,docInfos,api,fetchedDocs,tx,results,writeDoc,opts,overallCallback){revLimit=revLimit||1e3;var newEdits=opts.new_edits,idsToDocs=new Map,docsDone=0,docsToDo=docInfos.length;function checkAllDocsDone(){if(++docsDone===docsToDo&&overallCallback)overallCallback()}docInfos.forEach((function(currentDoc,resultsIdx){if(!currentDoc._id||!isLocalId(currentDoc._id)){var id=currentDoc.metadata.id;if(idsToDocs.has(id)){docsToDo--;idsToDocs.get(id).push([currentDoc,resultsIdx])}else idsToDocs.set(id,[[currentDoc,resultsIdx]])}else{var fun=currentDoc._deleted?"_removeLocal":"_putLocal";api[fun](currentDoc,{ctx:tx},(function(err2,res2){results[resultsIdx]=err2||res2;checkAllDocsDone()}))}}));idsToDocs.forEach((function(docs,id){var numDone=0;function docWritten(){if(++numDone<docs.length)nextDoc();else checkAllDocsDone()}function nextDoc(){var value=docs[numDone],currentDoc=value[0],resultsIdx=value[1];if(fetchedDocs.has(id))updateDoc(revLimit,fetchedDocs.get(id),currentDoc,results,resultsIdx,docWritten,writeDoc,newEdits);else{var merged=merge([],currentDoc.metadata.rev_tree[0],revLimit);currentDoc.metadata.rev_tree=merged.tree;currentDoc.stemmedRevs=merged.stemmedRevs||[];(function insertDoc(docInfo,resultsIdx,callback){var winningRev$$1=winningRev(docInfo.metadata),deleted=isDeleted(docInfo.metadata,winningRev$$1);if("was_delete"in opts&&deleted){results[resultsIdx]=createError(MISSING_DOC,"deleted");return callback()}if(newEdits&&rootIsMissing(docInfo)){var err2=createError(REV_CONFLICT);results[resultsIdx]=err2;return callback()}writeDoc(docInfo,winningRev$$1,deleted,deleted,false,deleted?0:1,resultsIdx,callback)})(currentDoc,resultsIdx,docWritten)}}nextDoc()}))}var ADAPTER_VERSION=5,DOC_STORE="document-store",BY_SEQ_STORE="by-sequence",ATTACH_STORE="attach-store",ATTACH_AND_SEQ_STORE="attach-seq-store",META_STORE="meta-store",LOCAL_STORE="local-store",DETECT_BLOB_SUPPORT_STORE="detect-blob-support";function idbError(callback){return function(evt){var message="unknown_error";if(evt.target&&evt.target.error)message=evt.target.error.name||evt.target.error.message;callback(createError(IDB_ERROR,message,evt.type))}}function encodeMetadata(metadata,winningRev$$1,deleted){return{data:safeJsonStringify(metadata),winningRev:winningRev$$1,deletedOrLocal:deleted?"1":"0",seq:metadata.seq,id:metadata.id}}function decodeMetadata(storedObject){if(!storedObject)return null;var metadata=safeJsonParse(storedObject.data);metadata.winningRev=storedObject.winningRev;metadata.deleted="1"===storedObject.deletedOrLocal;metadata.seq=storedObject.seq;return metadata}function decodeDoc(doc){if(!doc)return doc;var idx2=doc._doc_id_rev.lastIndexOf(":");doc._id=doc._doc_id_rev.substring(0,idx2-1);doc._rev=doc._doc_id_rev.substring(idx2+1);delete doc._doc_id_rev;return doc}function readBlobData(body,type,asBlob,callback){if(asBlob)if(!body)callback(createBlob2([""],{type}));else if("string"!=typeof body)callback(body);else callback(b64ToBluffer(body,type));else if(!body)callback("");else if("string"!=typeof body)readAsBinaryString(body,(function(binary){callback(thisBtoa(binary))}));else callback(body)}function fetchAttachmentsIfNecessary(doc,opts,txn,cb2){var attachments=Object.keys(doc._attachments||{});if(!attachments.length)return cb2&&cb2();var numDone=0;function checkDone(){if(++numDone===attachments.length&&cb2)cb2()}attachments.forEach((function(att){if(opts.attachments&&opts.include_docs)(function fetchAttachment(doc2,att){var attObj=doc2._attachments[att],digest=attObj.digest;txn.objectStore(ATTACH_STORE).get(digest).onsuccess=function(e4){attObj.body=e4.target.result.body;checkDone()}})(doc,att);else{doc._attachments[att].stub=true;checkDone()}}))}function postProcessAttachments(results,asBlob){return Promise.all(results.map((function(row){if(row.doc&&row.doc._attachments){var attNames=Object.keys(row.doc._attachments);return Promise.all(attNames.map((function(att){var attObj=row.doc._attachments[att];if("body"in attObj){var body=attObj.body,type=attObj.content_type;return new Promise((function(resolve){readBlobData(body,type,asBlob,(function(data){row.doc._attachments[att]=Object.assign(pick(attObj,["digest","content_type"]),{data});resolve()}))}))}})))}})))}function compactRevs(revs,docId,txn){var possiblyOrphanedDigests=[],seqStore=txn.objectStore(BY_SEQ_STORE),attStore=txn.objectStore(ATTACH_STORE),attAndSeqStore=txn.objectStore(ATTACH_AND_SEQ_STORE),count=revs.length;function checkDone(){if(! --count)(function deleteOrphanedAttachments(){if(possiblyOrphanedDigests.length)possiblyOrphanedDigests.forEach((function(digest){attAndSeqStore.index("digestSeq").count(IDBKeyRange.bound(digest+"::",digest+"::",false,false)).onsuccess=function(e4){if(!e4.target.result)attStore.delete(digest)}}))})()}revs.forEach((function(rev3){var index5=seqStore.index("_doc_id_rev"),key2=docId+"::"+rev3;index5.getKey(key2).onsuccess=function(e4){var seq=e4.target.result;if("number"!=typeof seq)return checkDone();seqStore.delete(seq);attAndSeqStore.index("seq").openCursor(IDBKeyRange.only(seq)).onsuccess=function(event){var cursor2=event.target.result;if(cursor2){var digest=cursor2.value.digestSeq.split("::")[0];possiblyOrphanedDigests.push(digest);attAndSeqStore.delete(cursor2.primaryKey);cursor2.continue()}else checkDone()}}}))}function openTransactionSafely(idb,stores,mode){try{return{txn:idb.transaction(stores,mode)}}catch(err2){return{error:err2}}}var changesHandler$1=new Changes;function idbBulkDocs(dbOpts,req,opts,api,idb,callback){for(var txn,docStore,bySeqStore,attachStore,attachAndSeqStore,metaStore,docInfoError,metaDoc,docInfos=req.docs,i2=0,len=docInfos.length;i2<len;i2++){var doc=docInfos[i2];if(!doc._id||!isLocalId(doc._id))if((doc=docInfos[i2]=parseDoc(doc,opts.new_edits,dbOpts)).error&&!docInfoError)docInfoError=doc}if(docInfoError)return callback(docInfoError);var allDocsProcessed=false,docCountDelta=0,results=new Array(docInfos.length),fetchedDocs=new Map,preconditionErrored=false,blobType=api._meta.blobSupport?"blob":"base64";preprocessAttachments(docInfos,blobType,(function(err2){if(err2)return callback(err2);(function startTransaction(){var txnResult=openTransactionSafely(idb,[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,LOCAL_STORE,ATTACH_AND_SEQ_STORE,META_STORE],"readwrite");if(txnResult.error)return callback(txnResult.error);(txn=txnResult.txn).onabort=idbError(callback);txn.ontimeout=idbError(callback);txn.oncomplete=complete;docStore=txn.objectStore(DOC_STORE);bySeqStore=txn.objectStore(BY_SEQ_STORE);attachStore=txn.objectStore(ATTACH_STORE);attachAndSeqStore=txn.objectStore(ATTACH_AND_SEQ_STORE);(metaStore=txn.objectStore(META_STORE)).get(META_STORE).onsuccess=function(e4){metaDoc=e4.target.result;updateDocCountIfReady()};(function verifyAttachments(finish){var digests=[];docInfos.forEach((function(docInfo){if(docInfo.data&&docInfo.data._attachments)Object.keys(docInfo.data._attachments).forEach((function(filename){var att=docInfo.data._attachments[filename];if(att.stub)digests.push(att.digest)}))}));if(!digests.length)return finish();var err2,numDone=0;digests.forEach((function(digest){(function verifyAttachment(digest,callback2){attachStore.get(digest).onsuccess=function(e4){if(!e4.target.result){var err2=createError(MISSING_STUB,"unknown stub attachment with digest "+digest);err2.status=412;callback2(err2)}else callback2()}})(digest,(function(attErr){if(attErr&&!err2)err2=attErr;(function checkDone(){if(++numDone===digests.length)finish(err2)})()}))}))})((function(err2){if(err2){preconditionErrored=true;return callback(err2)}(function fetchExistingDocs(){if(docInfos.length)for(var numFetched=0,i3=0,len2=docInfos.length;i3<len2;i3++){var docInfo=docInfos[i3];if(!docInfo._id||!isLocalId(docInfo._id))docStore.get(docInfo.metadata.id).onsuccess=readMetadata;else checkDone()}function checkDone(){if(++numFetched===docInfos.length)(function idbProcessDocs(){processDocs(dbOpts.revs_limit,docInfos,api,fetchedDocs,txn,results,writeDoc,opts,onAllDocsProcessed)})()}function readMetadata(event){var metadata=decodeMetadata(event.target.result);if(metadata)fetchedDocs.set(metadata.id,metadata);checkDone()}})()}))})()}));function onAllDocsProcessed(){allDocsProcessed=true;updateDocCountIfReady()}function updateDocCountIfReady(){if(metaDoc&&allDocsProcessed){metaDoc.docCount+=docCountDelta;metaStore.put(metaDoc)}}function complete(){if(!preconditionErrored){changesHandler$1.notify(api._meta.name);callback(null,results)}}function writeDoc(docInfo,winningRev$$1,winningRevIsDeleted,newRevIsDeleted,isUpdate,delta,resultsIdx,callback2){docInfo.metadata.winningRev=winningRev$$1;docInfo.metadata.deleted=winningRevIsDeleted;var doc2=docInfo.data;doc2._id=docInfo.metadata.id;doc2._rev=docInfo.metadata.rev;if(newRevIsDeleted)doc2._deleted=true;if(doc2._attachments&&Object.keys(doc2._attachments).length)return function writeAttachments(docInfo,winningRev$$1,winningRevIsDeleted,isUpdate,resultsIdx,callback2){var doc2=docInfo.data,numDone=0,attachments=Object.keys(doc2._attachments);function collectResults(){if(numDone===attachments.length)finishDoc(docInfo,winningRev$$1,winningRevIsDeleted,isUpdate,resultsIdx,callback2)}function attachmentSaved(){numDone++;collectResults()}attachments.forEach((function(key2){var att=docInfo.data._attachments[key2];if(!att.stub){var data=att.data;delete att.data;att.revpos=parseInt(winningRev$$1,10);(function saveAttachment(digest,data,callback2){attachStore.count(digest).onsuccess=function(e4){if(e4.target.result)return callback2();var newAtt={digest,body:data};attachStore.put(newAtt).onsuccess=callback2}})(att.digest,data,attachmentSaved)}else{numDone++;collectResults()}}))}(docInfo,winningRev$$1,winningRevIsDeleted,isUpdate,resultsIdx,callback2);docCountDelta+=delta;updateDocCountIfReady();finishDoc(docInfo,winningRev$$1,winningRevIsDeleted,isUpdate,resultsIdx,callback2)}function finishDoc(docInfo,winningRev$$1,winningRevIsDeleted,isUpdate,resultsIdx,callback2){var doc2=docInfo.data,metadata=docInfo.metadata;doc2._doc_id_rev=metadata.id+"::"+metadata.rev;delete doc2._id;delete doc2._rev;function afterPutDoc(e4){var revsToDelete=docInfo.stemmedRevs||[];if(isUpdate&&api.auto_compaction)revsToDelete=revsToDelete.concat(compactTree(docInfo.metadata));if(revsToDelete&&revsToDelete.length)compactRevs(revsToDelete,docInfo.metadata.id,txn);metadata.seq=e4.target.result;var metadataToStore=encodeMetadata(metadata,winningRev$$1,winningRevIsDeleted);docStore.put(metadataToStore).onsuccess=afterPutMetadata}function afterPutMetadata(){results[resultsIdx]={ok:true,id:metadata.id,rev:metadata.rev};fetchedDocs.set(docInfo.metadata.id,docInfo.metadata);(function insertAttachmentMappings(docInfo,seq,callback2){var attsAdded=0,attsToAdd=Object.keys(docInfo.data._attachments||{});if(!attsToAdd.length)return callback2();function checkDone(){if(++attsAdded===attsToAdd.length)callback2()}function add(att){var digest=docInfo.data._attachments[att].digest,req2=attachAndSeqStore.put({seq,digestSeq:digest+"::"+seq});req2.onsuccess=checkDone;req2.onerror=function(e4){e4.preventDefault();e4.stopPropagation();checkDone()}}for(var i3=0;i3<attsToAdd.length;i3++)add(attsToAdd[i3])})(docInfo,metadata.seq,callback2)}var putReq=bySeqStore.put(doc2);putReq.onsuccess=afterPutDoc;putReq.onerror=function afterPutDocError(e4){e4.preventDefault();e4.stopPropagation();bySeqStore.index("_doc_id_rev").getKey(doc2._doc_id_rev).onsuccess=function(e5){bySeqStore.put(doc2,e5.target.result).onsuccess=afterPutDoc}}}}function runBatchedCursor(objectStore,keyRange,descending,batchSize,onBatch){if(-1===batchSize)batchSize=1e3;var keysBatch,valuesBatch,pseudoCursor;function onGetAll(e4){valuesBatch=e4.target.result;if(keysBatch)onBatch(keysBatch,valuesBatch,pseudoCursor)}function onGetAllKeys(e4){keysBatch=e4.target.result;if(valuesBatch)onBatch(keysBatch,valuesBatch,pseudoCursor)}function onCursor(e4){var cursor=e4.target.result;if(!cursor)return onBatch();onBatch([cursor.key],[cursor.value],cursor)}if("function"==typeof objectStore.getAll&&"function"==typeof objectStore.getAllKeys&&batchSize>1&&!descending){pseudoCursor={continue:function continuePseudoCursor(){if(!keysBatch.length)return onBatch();var newKeyRange,lastKey=keysBatch[keysBatch.length-1];if(keyRange&&keyRange.upper)try{newKeyRange=IDBKeyRange.bound(lastKey,keyRange.upper,true,keyRange.upperOpen)}catch(e4){if("DataError"===e4.name&&0===e4.code)return onBatch()}else newKeyRange=IDBKeyRange.lowerBound(lastKey,true);keyRange=newKeyRange;keysBatch=null;valuesBatch=null;objectStore.getAll(keyRange,batchSize).onsuccess=onGetAll;objectStore.getAllKeys(keyRange,batchSize).onsuccess=onGetAllKeys}};objectStore.getAll(keyRange,batchSize).onsuccess=onGetAll;objectStore.getAllKeys(keyRange,batchSize).onsuccess=onGetAllKeys}else if(descending)objectStore.openCursor(keyRange,"prev").onsuccess=onCursor;else objectStore.openCursor(keyRange).onsuccess=onCursor}function getAll(objectStore,keyRange,onSuccess){if("function"!=typeof objectStore.getAll){var values=[];objectStore.openCursor(keyRange).onsuccess=function onCursor(e4){var cursor=e4.target.result;if(cursor){values.push(cursor.value);cursor.continue()}else onSuccess({target:{result:values}})}}else objectStore.getAll(keyRange).onsuccess=onSuccess}function allDocsKeys(keys2,docStore,onBatch){var valuesBatch=new Array(keys2.length),count=0;keys2.forEach((function(key2,index5){docStore.get(key2).onsuccess=function(event){if(event.target.result)valuesBatch[index5]=event.target.result;else valuesBatch[index5]={key:key2,error:"not_found"};if(++count===keys2.length)onBatch(keys2,valuesBatch,{})}}))}function createKeyRange(start,end,inclusiveEnd,key2,descending){try{if(start&&end)if(descending)return IDBKeyRange.bound(end,start,!inclusiveEnd,false);else return IDBKeyRange.bound(start,end,false,!inclusiveEnd);else if(start)if(descending)return IDBKeyRange.upperBound(start);else return IDBKeyRange.lowerBound(start);else if(end)if(descending)return IDBKeyRange.lowerBound(end,!inclusiveEnd);else return IDBKeyRange.upperBound(end,!inclusiveEnd);else if(key2)return IDBKeyRange.only(key2)}catch(e4){return{error:e4}}return null}function idbAllDocs(opts,idb,callback){var keyRange,keyRangeError,start="startkey"in opts?opts.startkey:false,end="endkey"in opts?opts.endkey:false,key2="key"in opts?opts.key:false,keys2="keys"in opts?opts.keys:false,skip=opts.skip||0,limit="number"==typeof opts.limit?opts.limit:-1,inclusiveEnd=false!==opts.inclusive_end;if(!keys2)if((keyRangeError=(keyRange=createKeyRange(start,end,inclusiveEnd,key2,opts.descending))&&keyRange.error)&&!("DataError"===keyRangeError.name&&0===keyRangeError.code))return callback(createError(IDB_ERROR,keyRangeError.name,keyRangeError.message));var stores=[DOC_STORE,BY_SEQ_STORE,META_STORE];if(opts.attachments)stores.push(ATTACH_STORE);var txnResult=openTransactionSafely(idb,stores,"readonly");if(txnResult.error)return callback(txnResult.error);var txn=txnResult.txn;txn.oncomplete=function onTxnComplete(){if(opts.attachments)postProcessAttachments(results,opts.binary).then(onResultsReady);else onResultsReady()};txn.onabort=idbError(callback);var docCount,updateSeq,docStore=txn.objectStore(DOC_STORE),seqStore=txn.objectStore(BY_SEQ_STORE),metaStore=txn.objectStore(META_STORE),docIdRevIndex=seqStore.index("_doc_id_rev"),results=[];metaStore.get(META_STORE).onsuccess=function(e4){docCount=e4.target.result.docCount};if(opts.update_seq)seqStore.openKeyCursor(null,"prev").onsuccess=e4=>{var cursor=e4.target.result;if(cursor&&cursor.key)updateSeq=cursor.key};function allDocsInner(winningRev$$1,metadata){var row={id:metadata.id,key:metadata.id,value:{rev:winningRev$$1}};if(metadata.deleted){if(keys2){results.push(row);row.value.deleted=true;row.doc=null}}else if(skip--<=0){results.push(row);if(opts.include_docs)(function fetchDocAsynchronously(metadata,row,winningRev$$1){var key3=metadata.id+"::"+winningRev$$1;docIdRevIndex.get(key3).onsuccess=function onGetDoc(e4){row.doc=decodeDoc(e4.target.result)||{};if(opts.conflicts){var conflicts=collectConflicts(metadata);if(conflicts.length)row.doc._conflicts=conflicts}fetchAttachmentsIfNecessary(row.doc,opts,txn)}})(metadata,row,winningRev$$1)}}function processBatch(batchValues){for(var i2=0,len=batchValues.length;i2<len&&results.length!==limit;i2++){var batchValue=batchValues[i2];if(!batchValue.error||!keys2){var metadata=decodeMetadata(batchValue);allDocsInner(metadata.winningRev,metadata)}else results.push(batchValue)}}function onBatch(batchKeys,batchValues,cursor){if(cursor){processBatch(batchValues);if(results.length<limit)cursor.continue()}}function onResultsReady(){var returnVal={total_rows:docCount,offset:opts.skip,rows:results};if(opts.update_seq&&void 0!==updateSeq)returnVal.update_seq=updateSeq;callback(null,returnVal)}if(!keyRangeError&&0!==limit){if(keys2)return allDocsKeys(keys2,docStore,onBatch);if(-1===limit)return getAll(docStore,keyRange,(function onGetAll(e4){var values=e4.target.result;if(opts.descending)values=values.reverse();processBatch(values)}));runBatchedCursor(docStore,keyRange,opts.descending,limit+skip,onBatch)}}function countDocs(txn,cb2){txn.objectStore(DOC_STORE).index("deletedOrLocal").count(IDBKeyRange.only("0")).onsuccess=function(e4){cb2(e4.target.result)}}var running=false,queue=[];function tryCode(fun,err2,res2,PouchDB2){try{fun(err2,res2)}catch(err3){PouchDB2.emit("error",err3)}}function applyNext(){if(!running&&queue.length){running=true;queue.shift()()}}function enqueueTask(action,callback,PouchDB2){queue.push((function runAction(){action((function runCallback(err2,res2){tryCode(callback,err2,res2,PouchDB2);running=false;nextTick((function runNext(){applyNext(PouchDB2)}))}))}));applyNext()}function changes(opts,api,dbName,idb){if((opts=clone(opts)).continuous){var id=dbName+":"+uuid();changesHandler$1.addListener(dbName,id,api,opts);changesHandler$1.notify(dbName);return{cancel:function(){changesHandler$1.removeListener(dbName,id)}}}var docIds=opts.doc_ids&&new Set(opts.doc_ids);opts.since=opts.since||0;var lastSeq=opts.since,limit="limit"in opts?opts.limit:-1;if(0===limit)limit=1;var txn,bySeqStore,docStore,docIdRevIndex,results=[],numResults=0,filter3=filterChange(opts),docIdsToMetadata=new Map;function onGetMetadata(doc,seq,metadata,cb2){if(metadata.seq!==seq)return cb2();if(metadata.winningRev===doc._rev)return cb2(metadata,doc);var docIdRev=doc._id+"::"+metadata.winningRev;docIdRevIndex.get(docIdRev).onsuccess=function(e4){cb2(metadata,decodeDoc(e4.target.result))}}function finish(){opts.complete(null,{results,last_seq:lastSeq})}var objectStores=[DOC_STORE,BY_SEQ_STORE];if(opts.attachments)objectStores.push(ATTACH_STORE);var txnResult=openTransactionSafely(idb,objectStores,"readonly");if(txnResult.error)return opts.complete(txnResult.error);(txn=txnResult.txn).onabort=idbError(opts.complete);txn.oncomplete=function onTxnComplete(){if(!opts.continuous&&opts.attachments)postProcessAttachments(results).then(finish);else finish()};bySeqStore=txn.objectStore(BY_SEQ_STORE);docStore=txn.objectStore(DOC_STORE);docIdRevIndex=bySeqStore.index("_doc_id_rev");runBatchedCursor(bySeqStore,opts.since&&!opts.descending?IDBKeyRange.lowerBound(opts.since,true):null,opts.descending,limit,(function onBatch(batchKeys,batchValues,cursor){if(cursor&&batchKeys.length){var winningDocs=new Array(batchKeys.length),metadatas=new Array(batchKeys.length),numDone=0;batchValues.forEach((function(value,i2){(function fetchWinningDocAndMetadata(doc,seq,cb2){if(docIds&&!docIds.has(doc._id))return cb2();var metadata=docIdsToMetadata.get(doc._id);if(metadata)return onGetMetadata(doc,seq,metadata,cb2);docStore.get(doc._id).onsuccess=function(e4){metadata=decodeMetadata(e4.target.result);docIdsToMetadata.set(doc._id,metadata);onGetMetadata(doc,seq,metadata,cb2)}})(decodeDoc(value),batchKeys[i2],(function(metadata,winningDoc){metadatas[i2]=metadata;winningDocs[i2]=winningDoc;if(++numDone===batchKeys.length)(function onBatchDone(){for(var promises=[],i2=0,len=winningDocs.length;i2<len&&numResults!==limit;i2++){var winningDoc=winningDocs[i2];if(winningDoc){var metadata=metadatas[i2];promises.push(processMetadataAndWinningDoc(metadata,winningDoc))}}Promise.all(promises).then((function(changes3){for(var i3=0,len2=changes3.length;i3<len2;i3++)if(changes3[i3])opts.onChange(changes3[i3])})).catch(opts.complete);if(numResults!==limit)cursor.continue()})()}))}))}function processMetadataAndWinningDoc(metadata,winningDoc){var change=opts.processChange(winningDoc,metadata,opts);lastSeq=change.seq=metadata.seq;var filtered=filter3(change);if("object"==typeof filtered)return Promise.reject(filtered);if(!filtered)return Promise.resolve();numResults++;if(opts.return_docs)results.push(change);if(opts.attachments&&opts.include_docs)return new Promise((function(resolve){fetchAttachmentsIfNecessary(winningDoc,opts,txn,(function(){postProcessAttachments([change],opts.binary).then((function(){resolve(change)}))}))}));else return Promise.resolve(change)}}))}var blobSupportPromise,cachedDBs=new Map,openReqList=new Map;function IdbPouch(opts,callback){var api=this;enqueueTask((function(thisCallback){init2(api,opts,thisCallback)}),callback,api.constructor)}function init2(api,opts,callback){var dbName=opts.name,idb=null,idbGlobalFailureError=null;api._meta=null;function enrichCallbackError(callback2){return function(error,result){if(error&&error instanceof Error&&!error.reason)if(idbGlobalFailureError)error.reason=idbGlobalFailureError;callback2(error,result)}}function addDeletedOrLocalIndex(txn,callback2){var docStore=txn.objectStore(DOC_STORE);docStore.createIndex("deletedOrLocal","deletedOrLocal",{unique:false});docStore.openCursor().onsuccess=function(event){var cursor=event.target.result;if(cursor){var metadata=cursor.value,deleted=isDeleted(metadata);metadata.deletedOrLocal=deleted?"1":"0";docStore.put(metadata);cursor.continue()}else callback2()}}function migrateLocalStore(txn,cb2){var localStore=txn.objectStore(LOCAL_STORE),docStore=txn.objectStore(DOC_STORE),seqStore=txn.objectStore(BY_SEQ_STORE);docStore.openCursor().onsuccess=function(event){var cursor2=event.target.result;if(cursor2){var metadata=cursor2.value,docId=metadata.id,local=isLocalId(docId),rev3=winningRev(metadata);if(local){var docIdRev=docId+"::"+rev3,start=docId+"::",end=docId+"::~",index5=seqStore.index("_doc_id_rev"),range2=IDBKeyRange.bound(start,end,false,false),seqCursor=index5.openCursor(range2);seqCursor.onsuccess=function(e4){if(!(seqCursor=e4.target.result)){docStore.delete(cursor2.primaryKey);cursor2.continue()}else{var data=seqCursor.value;if(data._doc_id_rev===docIdRev)localStore.put(data);seqStore.delete(seqCursor.primaryKey);seqCursor.continue()}}}else cursor2.continue()}else if(cb2)cb2()}}function migrateAttsAndSeqs(txn,callback2){var seqStore=txn.objectStore(BY_SEQ_STORE),attStore=txn.objectStore(ATTACH_STORE),attAndSeqStore=txn.objectStore(ATTACH_AND_SEQ_STORE);attStore.count().onsuccess=function(e4){if(!e4.target.result)return callback2();seqStore.openCursor().onsuccess=function(e5){var cursor=e5.target.result;if(!cursor)return callback2();for(var doc=cursor.value,seq=cursor.primaryKey,atts=Object.keys(doc._attachments||{}),digestMap={},j2=0;j2<atts.length;j2++)digestMap[doc._attachments[atts[j2]].digest]=true;var digests=Object.keys(digestMap);for(j2=0;j2<digests.length;j2++){var digest=digests[j2];attAndSeqStore.put({seq,digestSeq:digest+"::"+seq})}cursor.continue()}}}function migrateMetadata(txn){var bySeqStore=txn.objectStore(BY_SEQ_STORE),docStore=txn.objectStore(DOC_STORE);docStore.openCursor().onsuccess=function(e4){var cursor2=e4.target.result;if(cursor2){var metadata=function decodeMetadataCompat(storedObject){if(!storedObject.data){storedObject.deleted="1"===storedObject.deletedOrLocal;return storedObject}return decodeMetadata(storedObject)}(cursor2.value);metadata.winningRev=metadata.winningRev||winningRev(metadata);if(metadata.seq)return onGetMetadataSeq();(function fetchMetadataSeq(){var start=metadata.id+"::",end=metadata.id+"::",req2=bySeqStore.index("_doc_id_rev").openCursor(IDBKeyRange.bound(start,end)),metadataSeq=0;req2.onsuccess=function(e5){var cursor3=e5.target.result;if(!cursor3){metadata.seq=metadataSeq;return onGetMetadataSeq()}var seq=cursor3.primaryKey;if(seq>metadataSeq)metadataSeq=seq;cursor3.continue()}})()}function onGetMetadataSeq(){var metadataToStore=encodeMetadata(metadata,metadata.winningRev,metadata.deleted);docStore.put(metadataToStore).onsuccess=function(){cursor2.continue()}}}}api._remote=false;api.type=function(){return"idb"};api._id=toPromise((function(callback2){callback2(null,api._meta.instanceId)}));api._bulkDocs=function idb_bulkDocs(req2,reqOpts,callback2){idbBulkDocs(opts,req2,reqOpts,api,idb,enrichCallbackError(callback2))};api._get=function idb_get(id,opts2,callback2){var doc,metadata,err2,txn=opts2.ctx;if(!txn){var txnResult=openTransactionSafely(idb,[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");if(txnResult.error)return callback2(txnResult.error);txn=txnResult.txn}function finish(){callback2(err2,{doc,metadata,ctx:txn})}txn.objectStore(DOC_STORE).get(id).onsuccess=function(e4){if(!(metadata=decodeMetadata(e4.target.result))){err2=createError(MISSING_DOC,"missing");return finish()}var rev3;if(!opts2.rev){rev3=metadata.winningRev;if(isDeleted(metadata)){err2=createError(MISSING_DOC,"deleted");return finish()}}else rev3=opts2.latest?latest(opts2.rev,metadata):opts2.rev;var objectStore=txn.objectStore(BY_SEQ_STORE),key2=metadata.id+"::"+rev3;objectStore.index("_doc_id_rev").get(key2).onsuccess=function(e5){if(doc=e5.target.result)doc=decodeDoc(doc);if(!doc){err2=createError(MISSING_DOC,"missing");return finish()}finish()}}};api._getAttachment=function(docId,attachId,attachment,opts2,callback2){var txn;if(opts2.ctx)txn=opts2.ctx;else{var txnResult=openTransactionSafely(idb,[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");if(txnResult.error)return callback2(txnResult.error);txn=txnResult.txn}var digest=attachment.digest,type=attachment.content_type;txn.objectStore(ATTACH_STORE).get(digest).onsuccess=function(e4){readBlobData(e4.target.result.body,type,opts2.binary,(function(blobData){callback2(null,blobData)}))}};api._info=function idb_info(callback2){var updateSeq,docCount,txnResult=openTransactionSafely(idb,[META_STORE,BY_SEQ_STORE],"readonly");if(txnResult.error)return callback2(txnResult.error);var txn=txnResult.txn;txn.objectStore(META_STORE).get(META_STORE).onsuccess=function(e4){docCount=e4.target.result.docCount};txn.objectStore(BY_SEQ_STORE).openKeyCursor(null,"prev").onsuccess=function(e4){var cursor=e4.target.result;updateSeq=cursor?cursor.key:0};txn.oncomplete=function(){callback2(null,{doc_count:docCount,update_seq:updateSeq,idb_attachment_format:api._meta.blobSupport?"binary":"base64"})}};api._allDocs=function idb_allDocs(opts2,callback2){idbAllDocs(opts2,idb,enrichCallbackError(callback2))};api._changes=function idbChanges2(opts2){return changes(opts2,api,dbName,idb)};api._close=function(callback2){idb.close();cachedDBs.delete(dbName);callback2()};api._getRevisionTree=function(docId,callback2){var txnResult=openTransactionSafely(idb,[DOC_STORE],"readonly");if(txnResult.error)return callback2(txnResult.error);txnResult.txn.objectStore(DOC_STORE).get(docId).onsuccess=function(event){var doc=decodeMetadata(event.target.result);if(!doc)callback2(createError(MISSING_DOC));else callback2(null,doc.rev_tree)}};api._doCompaction=function(docId,revs,callback2){var txnResult=openTransactionSafely(idb,[DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,ATTACH_AND_SEQ_STORE],"readwrite");if(txnResult.error)return callback2(txnResult.error);var txn=txnResult.txn;txn.objectStore(DOC_STORE).get(docId).onsuccess=function(event){var metadata=decodeMetadata(event.target.result);traverseRevTree(metadata.rev_tree,(function(isLeaf,pos,revHash,ctx,opts2){var rev3=pos+"-"+revHash;if(-1!==revs.indexOf(rev3))opts2.status="missing"}));compactRevs(revs,docId,txn);var winningRev$$1=metadata.winningRev,deleted=metadata.deleted;txn.objectStore(DOC_STORE).put(encodeMetadata(metadata,winningRev$$1,deleted))};txn.onabort=idbError(callback2);txn.oncomplete=function(){callback2()}};api._getLocal=function(id,callback2){var txnResult=openTransactionSafely(idb,[LOCAL_STORE],"readonly");if(txnResult.error)return callback2(txnResult.error);var req2=txnResult.txn.objectStore(LOCAL_STORE).get(id);req2.onerror=idbError(callback2);req2.onsuccess=function(e4){var doc=e4.target.result;if(!doc)callback2(createError(MISSING_DOC));else{delete doc["_doc_id_rev"];callback2(null,doc)}}};api._putLocal=function(doc,opts2,callback2){if("function"==typeof opts2){callback2=opts2;opts2={}}delete doc._revisions;var oldRev=doc._rev,id=doc._id;if(!oldRev)doc._rev="0-1";else doc._rev="0-"+(parseInt(oldRev.split("-")[1],10)+1);var ret,tx=opts2.ctx;if(!tx){var txnResult=openTransactionSafely(idb,[LOCAL_STORE],"readwrite");if(txnResult.error)return callback2(txnResult.error);(tx=txnResult.txn).onerror=idbError(callback2);tx.oncomplete=function(){if(ret)callback2(null,ret)}}var req2,oStore=tx.objectStore(LOCAL_STORE);if(oldRev)(req2=oStore.get(id)).onsuccess=function(e4){var oldDoc=e4.target.result;if(!oldDoc||oldDoc._rev!==oldRev)callback2(createError(REV_CONFLICT));else oStore.put(doc).onsuccess=function(){ret={ok:true,id:doc._id,rev:doc._rev};if(opts2.ctx)callback2(null,ret)}};else{(req2=oStore.add(doc)).onerror=function(e4){callback2(createError(REV_CONFLICT));e4.preventDefault();e4.stopPropagation()};req2.onsuccess=function(){ret={ok:true,id:doc._id,rev:doc._rev};if(opts2.ctx)callback2(null,ret)}}};api._removeLocal=function(doc,opts2,callback2){if("function"==typeof opts2){callback2=opts2;opts2={}}var ret,tx=opts2.ctx;if(!tx){var txnResult=openTransactionSafely(idb,[LOCAL_STORE],"readwrite");if(txnResult.error)return callback2(txnResult.error);(tx=txnResult.txn).oncomplete=function(){if(ret)callback2(null,ret)}}var id=doc._id,oStore=tx.objectStore(LOCAL_STORE),req2=oStore.get(id);req2.onerror=idbError(callback2);req2.onsuccess=function(e4){var oldDoc=e4.target.result;if(!oldDoc||oldDoc._rev!==doc._rev)callback2(createError(MISSING_DOC));else{oStore.delete(id);ret={ok:true,id,rev:"0-0"};if(opts2.ctx)callback2(null,ret)}}};api._destroy=function(opts2,callback2){changesHandler$1.removeAllListeners(dbName);var openReq=openReqList.get(dbName);if(openReq&&openReq.result){openReq.result.close();cachedDBs.delete(dbName)}var req2=indexedDB.deleteDatabase(dbName);req2.onsuccess=function(){openReqList.delete(dbName);if(hasLocalStorage()&&dbName in localStorage)delete localStorage[dbName];callback2(null,{ok:true})};req2.onerror=idbError(callback2)};var cached=cachedDBs.get(dbName);if(cached){idb=cached.idb;api._meta=cached.global;return nextTick((function(){callback(null,api)}))}var req=indexedDB.open(dbName,ADAPTER_VERSION);openReqList.set(dbName,req);req.onupgradeneeded=function(e4){var db=e4.target.result;if(e4.oldVersion<1)return function createSchema(db){var docStore=db.createObjectStore(DOC_STORE,{keyPath:"id"});db.createObjectStore(BY_SEQ_STORE,{autoIncrement:true}).createIndex("_doc_id_rev","_doc_id_rev",{unique:true});db.createObjectStore(ATTACH_STORE,{keyPath:"digest"});db.createObjectStore(META_STORE,{keyPath:"id",autoIncrement:false});db.createObjectStore(DETECT_BLOB_SUPPORT_STORE);docStore.createIndex("deletedOrLocal","deletedOrLocal",{unique:false});db.createObjectStore(LOCAL_STORE,{keyPath:"_id"});var attAndSeqStore=db.createObjectStore(ATTACH_AND_SEQ_STORE,{autoIncrement:true});attAndSeqStore.createIndex("seq","seq");attAndSeqStore.createIndex("digestSeq","digestSeq",{unique:true})}(db);var txn=e4.currentTarget.transaction;if(e4.oldVersion<3)(function createLocalStoreSchema(db){db.createObjectStore(LOCAL_STORE,{keyPath:"_id"}).createIndex("_doc_id_rev","_doc_id_rev",{unique:true})})(db);if(e4.oldVersion<4)(function addAttachAndSeqStore(db){var attAndSeqStore=db.createObjectStore(ATTACH_AND_SEQ_STORE,{autoIncrement:true});attAndSeqStore.createIndex("seq","seq");attAndSeqStore.createIndex("digestSeq","digestSeq",{unique:true})})(db);var migrations=[addDeletedOrLocalIndex,migrateLocalStore,migrateAttsAndSeqs,migrateMetadata],i2=e4.oldVersion;(function next(){var migration=migrations[i2-1];i2++;if(migration)migration(txn,next)})()};req.onsuccess=function(e4){(idb=e4.target.result).onversionchange=function(){idb.close();cachedDBs.delete(dbName)};idb.onabort=function(e5){guardedConsole("error","Database has a global failure",e5.target.error);idbGlobalFailureError=e5.target.error;idb.close();cachedDBs.delete(dbName)};var metaDoc,docCount,blobSupport,instanceId,txn=idb.transaction([META_STORE,DETECT_BLOB_SUPPORT_STORE,DOC_STORE],"readwrite"),storedMetaDoc=false;function completeSetup(){if("undefined"!=typeof blobSupport&&storedMetaDoc){api._meta={name:dbName,instanceId,blobSupport};cachedDBs.set(dbName,{idb,global:api._meta});callback(null,api)}}function storeMetaDocIfReady(){if("undefined"!=typeof docCount&&"undefined"!=typeof metaDoc){var instanceKey=dbName+"_id";if(instanceKey in metaDoc)instanceId=metaDoc[instanceKey];else metaDoc[instanceKey]=instanceId=uuid();metaDoc.docCount=docCount;txn.objectStore(META_STORE).put(metaDoc)}}txn.objectStore(META_STORE).get(META_STORE).onsuccess=function(e5){metaDoc=e5.target.result||{id:META_STORE};storeMetaDocIfReady()};countDocs(txn,(function(count){docCount=count;storeMetaDocIfReady()}));if(!blobSupportPromise)blobSupportPromise=checkBlobSupport(txn,DETECT_BLOB_SUPPORT_STORE,"key");blobSupportPromise.then((function(val2){blobSupport=val2;completeSetup()}));txn.oncomplete=function(){storedMetaDoc=true;completeSetup()};txn.onabort=idbError(callback)};req.onerror=function(e4){var msg=e4.target.error&&e4.target.error.message;if(!msg)msg="Failed to open indexedDB, are you in private browsing mode?";else if(-1!==msg.indexOf("stored database is a higher version"))msg=new Error('This DB was created with the newer "indexeddb" adapter, but you are trying to open it with the older "idb" adapter');guardedConsole("error",msg);callback(createError(IDB_ERROR,msg))}}IdbPouch.valid=function(){try{return"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e4){return false}};function index(PouchDB2){PouchDB2.adapter("idb",IdbPouch,true)}var index_es_default2=index,import_spark_md53=__toESM(require_spark_md5()),setImmediateShim3=self.setImmediate||self.setTimeout,MD5_CHUNK_SIZE3=32768;function rawToBase643(raw){return thisBtoa(raw)}function appendBlob3(buffer,blob,start,end,callback){if(start>0||end<blob.size)blob=blob.slice(start,end);readAsArrayBuffer(blob,(function(arrayBuffer){buffer.append(arrayBuffer);callback()}))}function appendString3(buffer,string,start,end,callback){if(start>0||end<string.length)string=string.substring(start,end);buffer.appendBinary(string);callback()}function binaryMd53(data,callback){var inputIsString="string"==typeof data,len=inputIsString?data.length:data.size,chunkSize=Math.min(MD5_CHUNK_SIZE3,len),chunks=Math.ceil(len/chunkSize),currentChunk=0,buffer=inputIsString?new import_spark_md53.default:new import_spark_md53.default.ArrayBuffer,append2=inputIsString?appendString3:appendBlob3;function next(){setImmediateShim3(loadNextChunk)}function done(){var base64=rawToBase643(buffer.end(true));callback(base64);buffer.destroy()}function loadNextChunk(){var start=currentChunk*chunkSize,end=start+chunkSize;if(++currentChunk<chunks)append2(buffer,data,start,end,next);else append2(buffer,data,start,end,done)}loadNextChunk()}function stringMd53(string){return import_spark_md53.default.hash(string)}var IDB_NULL=Number.MIN_SAFE_INTEGER,IDB_FALSE=Number.MIN_SAFE_INTEGER+1,IDB_TRUE=Number.MIN_SAFE_INTEGER+2,TEST_KEY_INVALID=/^[^a-zA-Z$]|[^a-zA-Z0-9$]+/,TEST_PATH_INVALID=/\\.|(^|\.)[^a-zA-Z$]|[^a-zA-Z0-9$.]+/;function needsSanitise(name,isPath){if(isPath)return TEST_PATH_INVALID.test(name);else return TEST_KEY_INVALID.test(name)}var KEY_INVALID=new RegExp(TEST_KEY_INVALID.source,"g"),PATH_INVALID=new RegExp(TEST_PATH_INVALID.source,"g"),SLASH="\\".charCodeAt(0),IS_DOT=".".charCodeAt(0);function sanitise(name,isPath){const correctCharacters=function(match3){let good="";for(let i2=0;i2<match3.length;i2++){const code=match3.charCodeAt(i2);if(code===IS_DOT&&isPath&&0===i2)good+=".";else if(code===SLASH&&isPath)continue;else good+="_c"+code+"_"}return good};if(isPath)return name.replace(PATH_INVALID,correctCharacters);else return name.replace(KEY_INVALID,correctCharacters)}function needsRewrite(data){for(const key2 of Object.keys(data))if(needsSanitise(key2))return true;else if(null===data[key2]||"boolean"==typeof data[key2])return true;else if("object"==typeof data[key2])return needsRewrite(data[key2])}function rewrite(data){if(!needsRewrite(data))return false;const isArray2=Array.isArray(data),clone2=isArray2?[]:{};Object.keys(data).forEach((function(key2){const safeKey=isArray2?key2:sanitise(key2);if(null===data[key2])clone2[safeKey]=IDB_NULL;else if("boolean"==typeof data[key2])clone2[safeKey]=data[key2]?IDB_TRUE:IDB_FALSE;else if("object"==typeof data[key2])clone2[safeKey]=rewrite(data[key2]);else clone2[safeKey]=data[key2]}));return clone2}var DOC_STORE2="docs",META_LOCAL_STORE="meta";function idbError2(callback){return function(evt){let message="unknown_error";if(evt.target&&evt.target.error)message=evt.target.error.name||evt.target.error.message;callback(createError(IDB_ERROR,message,evt.type))}}function processAttachment(name,src,doc,isBinary,attachmentFormat){delete doc._attachments[name].stub;if("base64"===attachmentFormat){if(isBinary){const att=src.attachments[doc._attachments[name].digest];doc._attachments[name].data=b64ToBluffer(att.data,att.content_type)}else doc._attachments[name].data=src.attachments[doc._attachments[name].digest].data;delete doc._attachments[name].length;return Promise.resolve()}if(isBinary){doc._attachments[name].data=src.attachments[doc._attachments[name].digest].data;return Promise.resolve()}return new Promise((function(resolve){readAsBinaryString(src.attachments[doc._attachments[name].digest].data,(function(binString){doc._attachments[name].data=thisBtoa(binString);delete doc._attachments[name].length;resolve()}))}))}function rawIndexFields(ddoc,viewName){return(ddoc.views[viewName].options&&ddoc.views[viewName].options.def&&ddoc.views[viewName].options.def.fields||[]).map((function(field){if("string"==typeof field)return field;else return Object.keys(field)[0]}))}function isPartialFilterView(ddoc,viewName){return viewName in ddoc.views&&ddoc.views[viewName].options&&ddoc.views[viewName].options.def&&ddoc.views[viewName].options.def.partial_filter_selector}function naturalIndexName(fields){return"_find_idx/"+fields.join("/")}function correctIndexFields(fields){return["deleted"].concat(fields.map((function(field){if(["_id","_rev","_deleted","_attachments"].includes(field))return field.substr(1);else return"data."+sanitise(field,true)})))}var POUCHDB_IDB_VERSION=2,versionMultiplier=Math.pow(10,13);function createIdbVersion(){return versionMultiplier*POUCHDB_IDB_VERSION+(new Date).getTime()}function getPouchDbVersion(version2){return Math.floor(version2/versionMultiplier)}function maintainNativeIndexes(openReq,reject){const docStore=openReq.transaction.objectStore(DOC_STORE2);docStore.getAll(IDBKeyRange.bound("_design/","_design/")).onsuccess=function(e4){const results=e4.target.result,existingIndexNames=Array.from(docStore.indexNames),expectedIndexes=results.filter((function(row){return 0===row.deleted&&row.revs[row.rev].data.views})).map((function(row){return row.revs[row.rev].data})).reduce((function(indexes2,ddoc){return Object.keys(ddoc.views).reduce((function(acc,viewName){const fields=rawIndexFields(ddoc,viewName);if(fields&&fields.length>0)acc[naturalIndexName(fields)]=correctIndexFields(fields);return acc}),indexes2)}),{}),expectedIndexNames=Object.keys(expectedIndexes),systemIndexNames=["seq","deleted,id"];existingIndexNames.forEach((function(index5){if(-1===systemIndexNames.indexOf(index5)&&-1===expectedIndexNames.indexOf(index5))docStore.deleteIndex(index5)}));const newIndexNames=expectedIndexNames.filter((function(ei){return-1===existingIndexNames.indexOf(ei)}));try{newIndexNames.forEach((function(indexName){docStore.createIndex(indexName,expectedIndexes[indexName])}))}catch(err2){reject(err2)}}}function upgradePouchDbSchema(dbName,db,tx,pouchdbVersion){if(pouchdbVersion<1){db.createObjectStore(DOC_STORE2,{keyPath:"id"}).createIndex("seq","seq",{unique:true});db.createObjectStore(META_LOCAL_STORE,{keyPath:"id"})}if(pouchdbVersion<2){const docStore=tx.objectStore(DOC_STORE2);docStore.createIndex("deleted,id",["deleted","id"],{unique:true});if(dbName.includes("-mrview-"))docStore.deleteIndex("seq")}}function openDatabase(openDatabases2,api,opts,resolve,reject){const openReq=opts.versionChangedWhileOpen?indexedDB.open(opts.name):indexedDB.open(opts.name,createIdbVersion());openReq.onupgradeneeded=function(e4){if(e4.oldVersion>0&&e4.oldVersion<versionMultiplier)throw new Error('Incorrect adapter: you should specify the "idb" adapter to open this DB');else if(0===e4.oldVersion&&e4.newVersion<versionMultiplier){indexedDB.deleteDatabase(opts.name);throw new Error("Database was deleted while open")}const tx=e4.target.transaction,db=e4.target.result,pouchdbVersion=getPouchDbVersion(e4.oldVersion);upgradePouchDbSchema(opts.name,db,tx,pouchdbVersion);maintainNativeIndexes(openReq,reject);if(pouchdbVersion<2){const docStore=openReq.transaction.objectStore(DOC_STORE2),metaStore=openReq.transaction.objectStore(META_LOCAL_STORE);docStore.openCursor().onsuccess=event=>{const cursor=event.target.result;if(!cursor)return;const doc=cursor.value;if(!isLocalId(doc.id))return cursor.continue();metaStore.put(doc).onsuccess=()=>{cursor.delete(doc).onsuccess=()=>{cursor.continue()}}}}};openReq.onblocked=function(e4){console.error("onblocked, this should never happen",e4)};openReq.onsuccess=function(e4){const idb=e4.target.result;idb.onabort=function(e5){console.error("Database has a global failure",e5.target.error);delete openDatabases2[opts.name];idb.close()};idb.onversionchange=function(){console.log("Database was made stale, closing handle");openDatabases2[opts.name].versionChangedWhileOpen=true;idb.close()};idb.onclose=function(){console.log("Database was made stale, closing handle");if(opts.name in openDatabases2)openDatabases2[opts.name].versionChangedWhileOpen=true};let metadata={id:META_LOCAL_STORE};const txn=idb.transaction([META_LOCAL_STORE],"readwrite");txn.oncomplete=function(){resolve({idb,metadata})};const metaStore=txn.objectStore(META_LOCAL_STORE);metaStore.get(META_LOCAL_STORE).onsuccess=function(e5){metadata=e5.target.result||metadata;let changed=false;if(!("doc_count"in metadata)){changed=true;metadata.doc_count=0}if(!("seq"in metadata)){changed=true;metadata.seq=0}if(!("db_uuid"in metadata)){changed=true;metadata.db_uuid=uuid()}if(!("idb_attachment_format"in metadata))checkBlobSupport(txn,META_LOCAL_STORE,(blob=>({id:"blob-support",blob}))).then((blobSupport=>{api.blobSupport=metadata.idb_attachment_format=blobSupport?"binary":"base64";metaStore.put(metadata)}));else if(changed){api.blobSupport=metadata.idb_attachment_format;metaStore.put(metadata)}}};openReq.onerror=function(e4){reject(e4.target.error)}}function setup(openDatabases2,api,opts){if(!openDatabases2[opts.name]||openDatabases2[opts.name].versionChangedWhileOpen){opts.versionChangedWhileOpen=openDatabases2[opts.name]&&openDatabases2[opts.name].versionChangedWhileOpen;openDatabases2[opts.name]=new Promise((function(resolve,reject){openDatabase(openDatabases2,api,opts,resolve,reject)}))}return openDatabases2[opts.name]}function info2(metadata,callback){callback(null,{doc_count:metadata.doc_count,update_seq:metadata.seq})}function get(txn,id,opts,callback){if(txn.error)return callback(txn.error);txn.txn.objectStore(DOC_STORE2).get(id).onsuccess=function(e4){const doc=e4.target.result;let rev3;if(!opts.rev)rev3=doc&&doc.rev;else rev3=opts.latest?latest(opts.rev,doc):opts.rev;if(!doc||doc.deleted&&!opts.rev||!(rev3 in doc.revs)){callback(createError(MISSING_DOC,"missing"));return}const result=doc.revs[rev3].data;result._id=doc.id;result._rev=rev3;callback(null,{doc:result,metadata:doc,ctx:txn})}}var BINARY_ATTACHMENTS=false;function getLocal(txn,id,api,callback){if(txn.error)return callback(txn.error);txn.txn.objectStore(META_LOCAL_STORE).get(id).onsuccess=function(e4){const doc=e4.target.result;if(!doc){callback(createError(MISSING_DOC,"missing"));return}const result=doc.revs[doc.rev].data;result._id=doc.id;result._rev=doc.rev;if(result._attachments){const processing=[];for(const name in result._attachments)processing.push(processAttachment(name,doc,result,BINARY_ATTACHMENTS,api.blobSupport));Promise.all(processing).then((()=>callback(null,result))).catch(callback)}else callback(null,result)}}function getAttachment(docId,attachId,attachment,opts,cb2){if(isLocalId(docId)){cb2(createError(MISSING_DOC,"missing"));return}const data=opts.metadata.attachments[attachment.digest].data;if("string"!=typeof data)if(opts.binary)return cb2(null,data);else readAsBinaryString(data,(function(binString){cb2(null,thisBtoa(binString))}));else if(opts.binary)cb2(null,b64ToBluffer(data,attachment.content_type));else cb2(null,data)}function bulkDocs(api,req,opts,metadata,dbOpts,idbChanges2,callback){let txn,error;const results=[],docs=[];let lastWriteIndex;const revsLimit=dbOpts.revs_limit||1e3,rewriteEnabled=-1===dbOpts.name.indexOf("-mrview-"),autoCompaction=dbOpts.auto_compaction;function docsRevsLimit(doc){return isLocalId(doc.id)?1:revsLimit}function revHasAttachment(doc,rev3,digest){return doc.revs[rev3]&&doc.revs[rev3].data._attachments&&Object.values(doc.revs[rev3].data._attachments).find((function(att){return att.digest===digest}))}function convertDocFormat(doc){const newDoc={id:doc.metadata.id,rev:doc.metadata.rev,rev_tree:doc.metadata.rev_tree,revs:doc.metadata.revs||{}};newDoc.revs[newDoc.rev]={data:doc.data,deleted:doc.metadata.deleted};return newDoc}function updateSeq(i2){if(i2===lastWriteIndex)txn.objectStore(META_LOCAL_STORE).put(metadata)}for(let i2=0,len=req.docs.length;i2<len;i2++){let result;try{result=parseDoc(req.docs[i2],opts.new_edits,dbOpts)}catch(err2){result=err2}if(result.error)return callback(result);docs.push(convertDocFormat(result))}(function preProcessAttachments(){const promises=docs.map((function(doc){const data=doc.revs[doc.rev].data;if(!data._attachments)return Promise.resolve(data);const attachments=Object.keys(data._attachments).map((function(k2){data._attachments[k2].name=k2;return function preProcessAttachment(attachment){if(attachment.stub)return Promise.resolve(attachment);let binData;if("string"==typeof attachment.data){try{binData=thisAtob(attachment.data)}catch(e4){return Promise.reject(createError(BAD_ARG,"Attachment is not a valid base64 string"))}if("binary"===metadata.idb_attachment_format)attachment.data=binStringToBluffer(binData,attachment.content_type)}else{binData=attachment.data;if("base64"===metadata.idb_attachment_format)return new Promise((resolve=>{blobToBase64(attachment.data,(function(b64){attachment.data=b64;binaryMd53(binData,(function(result){attachment.digest="md5-"+result;attachment.length=binData.size||binData.length||0;resolve(attachment)}))}))}))}return new Promise((function(resolve){binaryMd53(binData,(function(result){attachment.digest="md5-"+result;attachment.length=binData.size||binData.length||0;resolve(attachment)}))}))}(data._attachments[k2])}));return Promise.all(attachments).then((function(newAttachments){const processed={};newAttachments.forEach((function(attachment){processed[attachment.name]=attachment;delete attachment.name}));data._attachments=processed;return data}))}));return Promise.all(promises)})().then((function(){api._openTransactionSafely([DOC_STORE2,META_LOCAL_STORE],"readwrite",(function(err2,_txn){if(err2)return callback(err2);txn=_txn;txn.onabort=function(){callback(error||createError(UNKNOWN_ERROR,"transaction was aborted"))};txn.ontimeout=idbError2(callback);txn.oncomplete=function(){idbChanges2.notify(dbOpts.name);callback(null,results)};(function fetchExistingDocs(txn2,docs2){let fetched=0;const oldDocs={};function readDone(e4){if(e4.target.result)oldDocs[e4.target.result.id]=e4.target.result;if(++fetched===docs2.length)(function processDocs2(txn2,docs2,oldDocs){docs2.forEach((function(doc,i2){let newDoc;if("was_delete"in opts&&!Object.prototype.hasOwnProperty.call(oldDocs,doc.id))newDoc=createError(MISSING_DOC,"deleted");else if(opts.new_edits&&!Object.prototype.hasOwnProperty.call(oldDocs,doc.id)&&function rootIsMissing2(doc){return"missing"===doc.rev_tree[0].ids[1].status}(doc))newDoc=createError(REV_CONFLICT);else if(Object.prototype.hasOwnProperty.call(oldDocs,doc.id)){newDoc=function update2(txn2,doc,oldDoc){if(doc.rev in oldDoc.revs&&!opts.new_edits)return false;const isRoot=/^1-/.test(doc.rev);if(oldDoc.deleted&&!doc.deleted&&opts.new_edits&&isRoot){const tmp=doc.revs[doc.rev].data;tmp._rev=oldDoc.rev;tmp._id=oldDoc.id;doc=convertDocFormat(parseDoc(tmp,opts.new_edits,dbOpts))}const merged=merge(oldDoc.rev_tree,doc.rev_tree[0],docsRevsLimit(doc));doc.stemmedRevs=merged.stemmedRevs;doc.rev_tree=merged.tree;const revs=oldDoc.revs;revs[doc.rev]=doc.revs[doc.rev];doc.revs=revs;doc.attachments=oldDoc.attachments;if(opts.new_edits&&(oldDoc.deleted&&doc.deleted||!oldDoc.deleted&&"new_leaf"!==merged.conflicts||oldDoc.deleted&&!doc.deleted&&"new_branch"===merged.conflicts||oldDoc.rev===doc.rev))return createError(REV_CONFLICT);doc.wasDeleted=oldDoc.deleted;return doc}(0,doc,oldDocs[doc.id]);if(false==newDoc)return}else{const merged=merge([],doc.rev_tree[0],docsRevsLimit(doc));doc.rev_tree=merged.tree;doc.stemmedRevs=merged.stemmedRevs;newDoc=doc;newDoc.isNewDoc=true;newDoc.wasDeleted=doc.revs[doc.rev].deleted?1:0}if(newDoc.error)results[i2]=newDoc;else{oldDocs[newDoc.id]=newDoc;lastWriteIndex=i2;(function write(txn2,doc,i2){const winningRev$$1=winningRev(doc),writtenRev=doc.rev,isLocal=isLocalId(doc.id),theDoc=doc.revs[winningRev$$1].data,isNewDoc=doc.isNewDoc;if(rewriteEnabled){const result=rewrite(theDoc);if(result){doc.data=result;delete doc.data._attachments}else doc.data=theDoc}else doc.data=theDoc;doc.rev=winningRev$$1;doc.deleted=doc.revs[winningRev$$1].deleted?1:0;if(!isLocal){doc.seq=++metadata.seq;let delta=0;if(doc.isNewDoc)delta=doc.deleted?0:1;else if(doc.wasDeleted!==doc.deleted)delta=doc.deleted?-1:1;metadata.doc_count+=delta}delete doc.isNewDoc;delete doc.wasDeleted;let revsToDelete=doc.stemmedRevs||[];if(autoCompaction&&!isNewDoc){const result=compactTree(doc);if(result.length)revsToDelete=revsToDelete.concat(result)}if(revsToDelete.length)revsToDelete.forEach((function(rev3){delete doc.revs[rev3]}));delete doc.stemmedRevs;if(!("attachments"in doc))doc.attachments={};if(theDoc._attachments)for(const k2 in theDoc._attachments){const attachment=theDoc._attachments[k2];if(attachment.stub){if(!(attachment.digest in doc.attachments)){error=createError(MISSING_STUB);txn2.abort();return}if(revHasAttachment(doc,writtenRev,attachment.digest))doc.attachments[attachment.digest].revs[writtenRev]=true}else{doc.attachments[attachment.digest]=attachment;doc.attachments[attachment.digest].revs={};doc.attachments[attachment.digest].revs[writtenRev]=true;theDoc._attachments[k2]={stub:true,digest:attachment.digest,content_type:attachment.content_type,length:attachment.length,revpos:parseInt(writtenRev,10)}}}if(isLocal&&doc.deleted){txn2.objectStore(META_LOCAL_STORE).delete(doc.id).onsuccess=function(){results[i2]={ok:true,id:doc.id,rev:"0-0"}};updateSeq(i2);return}const docStore=isLocal?META_LOCAL_STORE:DOC_STORE2;txn2.objectStore(docStore).put(doc).onsuccess=function(){results[i2]={ok:true,id:doc.id,rev:writtenRev};updateSeq(i2)}})(txn2,newDoc,i2)}}))})(txn2,docs2,oldDocs)}docs2.forEach((function(doc){const docStore=isLocalId(doc.id)?META_LOCAL_STORE:DOC_STORE2;txn2.objectStore(docStore).get(doc.id).onsuccess=readDone}))})(txn,docs)}))})).catch((function(err2){callback(err2)}))}function allDocsKeys2(keys2,docStore,allDocsInner){const valuesBatch=new Array(keys2.length);let count=0;keys2.forEach((function(key2,index5){docStore.get(key2).onsuccess=function(event){if(event.target.result)valuesBatch[index5]=event.target.result;else valuesBatch[index5]={key:key2,error:"not_found"};count++;if(count===keys2.length)valuesBatch.forEach((function(doc){allDocsInner(doc)}))}}))}function createKeyRange2(start,end,inclusiveStart,inclusiveEnd,key2,descending){try{if(key2)return IDBKeyRange.only([0,key2]);else if(descending)return IDBKeyRange.bound(end,start,!inclusiveEnd,!inclusiveStart);else return IDBKeyRange.bound(start,end,!inclusiveStart,!inclusiveEnd)}catch(e4){return{error:e4}}}function handleKeyRangeError(opts,metadata,err2,callback){if("DataError"===err2.name&&0===err2.code){const returnVal={total_rows:metadata.doc_count,offset:opts.skip,rows:[]};if(opts.update_seq)returnVal.update_seq=metadata.seq;return callback(null,returnVal)}callback(createError(IDB_ERROR,err2.name,err2.message))}function allDocs(txn,metadata,opts,callback){if(txn.error)return callback(txn.error);if(0===opts.limit){const returnVal={total_rows:metadata.doc_count,offset:opts.skip,rows:[]};if(opts.update_seq)returnVal.update_seq=metadata.seq;return callback(null,returnVal)}const results=[],processing=[],key2="key"in opts?opts.key:false,keys2="keys"in opts?opts.keys:false;let skip=opts.skip||0,limit="number"==typeof opts.limit?opts.limit:void 0;const inclusiveEnd=false!==opts.inclusive_end,descending="descending"in opts&&opts.descending?"prev":null,start="startkey"in opts?opts.startkey:descending?"":"",end="endkey"in opts?opts.endkey:descending?"":"",docStore=txn.txn.objectStore(DOC_STORE2);if(keys2){txn.txn.oncomplete=onTxnComplete;return allDocsKeys2(keys2,docStore,(doc=>{if(doc.error)return results.push(doc);const row={id:doc.id,key:doc.id,value:{rev:doc.rev}};if(doc.deleted){row.value.deleted=true;row.doc=null}else if(opts.include_docs)include_doc(row,doc);results.push(row)}))}let keyRange=createKeyRange2([0,start],[0,end],true,inclusiveEnd,key2,descending);if(keyRange.error)return handleKeyRangeError(opts,metadata,keyRange.error,callback);txn.txn.oncomplete=onTxnComplete;function include_doc(row,doc){const docData=doc.revs[doc.rev].data;row.doc=docData;row.doc._id=doc.id;row.doc._rev=doc.rev;if(opts.conflicts){const conflicts=collectConflicts(doc);if(conflicts.length)row.doc._conflicts=conflicts}if(opts.attachments&&docData._attachments)for(const name in docData._attachments)processing.push(processAttachment(name,doc,row.doc,opts.binary,metadata.idb_attachment_format))}function onTxnComplete(){const returnVal={total_rows:metadata.doc_count,offset:0,rows:results};if(opts.update_seq)returnVal.update_seq=metadata.seq;if(processing.length)Promise.all(processing).then((function(){callback(null,returnVal)}));else callback(null,returnVal)}const dbIndex=docStore.index("deleted,id");if(!skip&&!limit)fetchResults();else{let firstKey,limitKey=limit>0;dbIndex.openKeyCursor(keyRange,descending||"next").onsuccess=e4=>{const cursor=e4.target.result;if(!skip){if(void 0===firstKey){firstKey=cursor&&cursor.key;if(!firstKey)return txn.txn.commit()}if(limit){if(limit>1&&cursor){cursor.advance(limit-1);limit=void 0;return}limit=void 0}if(limitKey)limitKey=cursor&&cursor.key;if(!limitKey)limitKey=descending?keyRange.lower:keyRange.upper;keyRange=createKeyRange2(firstKey,limitKey,true,inclusiveEnd,key2,descending);if(keyRange.error){txn.txn.abort();return handleKeyRangeError(opts,metadata,keyRange.error,callback)}fetchResults()}else{if(!cursor)return txn.txn.commit();cursor.advance(skip);skip=0}}}async function fetchResults(){let kr=keyRange;do{kr=await fetchNextBatch(kr)}while(kr);if(descending)results.reverse();return txn.txn.commit();function fetchNextBatch(kr2){return new Promise((resolve=>{dbIndex.getAll(kr2,100).onsuccess=e4=>{const batch=e4.target.result;for(let i2=0;i2<batch.length;++i2){const doc=batch[i2],row={id:doc.id,key:doc.id,value:{rev:doc.rev}};if(opts.include_docs)include_doc(row,doc);results.push(row)}if(batch.length>=100){const lastSeenKey=[0,batch[batch.length-1].id],startKey=descending?kr2.upper:lastSeenKey,endKey=descending?lastSeenKey:kr2.upper;if(startKey[1]!==endKey[1])return resolve(createKeyRange2(startKey,endKey,descending?true:false,descending?false:inclusiveEnd,key2,descending))}return resolve()}}))}}}function changes2(txn,idbChanges2,api,dbOpts,opts){if(txn.error)return opts.complete(txn.error);if(opts.continuous){const id=dbOpts.name+":"+uuid();idbChanges2.addListener(dbOpts.name,id,api,opts);idbChanges2.notify(dbOpts.name);return{cancel:function(){idbChanges2.removeListener(dbOpts.name,id)}}}let limit="limit"in opts?opts.limit:-1;if(0===limit)limit=1;const store=txn.txn.objectStore(DOC_STORE2).index("seq"),filter3=filterChange(opts);let received=0,lastSeq=opts.since||0;const results=[],processing=[];let req;if(opts.descending)req=store.openCursor(null,"prev");else req=store.openCursor(IDBKeyRange.lowerBound(opts.since,true));txn.txn.oncomplete=function onTxnComplete(){Promise.all(processing).then((function(){opts.complete(null,{results,last_seq:lastSeq})}))};req.onsuccess=function onReqSuccess(e4){if(!e4.target.result)return;const cursor=e4.target.result,doc=cursor.value;doc.data=doc.revs[doc.rev].data;doc.data._id=doc.id;doc.data._rev=doc.rev;if(doc.deleted)doc.data._deleted=true;if(opts.doc_ids&&-1===opts.doc_ids.indexOf(doc.id))return cursor.continue();const change=opts.processChange(doc.data,doc,opts);change.seq=doc.seq;lastSeq=doc.seq;const filtered=filter3(change);if("object"==typeof filtered)return opts.complete(filtered);if(filtered){received++;if(opts.return_docs)results.push(change);if(opts.include_docs&&opts.attachments&&doc.data._attachments){const promises=[];for(const name in doc.data._attachments){const p2=processAttachment(name,doc,change.doc,opts.binary,api.blobSupport);promises.push(p2);processing.push(p2)}Promise.all(promises).then((function(){opts.onChange(change)}))}else opts.onChange(change)}if(received!==limit)cursor.continue()}}function getRevisionTree(txn,id,callback){if(txn.error)return callback(txn.error);txn.txn.objectStore(DOC_STORE2).get(id).onsuccess=function(e4){if(!e4.target.result)callback(createError(MISSING_DOC));else callback(null,e4.target.result.rev_tree)}}function doCompaction(txn,id,revs,callback){if(txn.error)return callback(txn.error);const docStore=txn.txn.objectStore(DOC_STORE2);docStore.get(id).onsuccess=function(e4){const doc=e4.target.result;traverseRevTree(doc.rev_tree,(function(isLeaf,pos,revHash,ctx,opts){const rev3=pos+"-"+revHash;if(-1!==revs.indexOf(rev3))opts.status="missing"}));const attachments=[];revs.forEach((function(rev3){if(rev3 in doc.revs){if(doc.revs[rev3].data._attachments)for(const k2 in doc.revs[rev3].data._attachments)attachments.push(doc.revs[rev3].data._attachments[k2].digest);delete doc.revs[rev3]}}));attachments.forEach((function(digest){revs.forEach((function(rev3){delete doc.attachments[digest].revs[rev3]}));if(!Object.keys(doc.attachments[digest].revs).length)delete doc.attachments[digest]}));docStore.put(doc)};txn.txn.oncomplete=function(){callback()}}function destroy(dbOpts,openDatabases2,idbChanges2,callback){idbChanges2.removeAllListeners(dbOpts.name);function doDestroy(){indexedDB.deleteDatabase(dbOpts.name).onsuccess=function(){delete openDatabases2[dbOpts.name];callback(null,{ok:true})}}if(dbOpts.name in openDatabases2)openDatabases2[dbOpts.name].then((function(res2){res2.idb.close();doDestroy()}));else doDestroy()}var COUCH_COLLATE_LO=null,COUCH_COLLATE_HI="",IDB_COLLATE_LO=Number.NEGATIVE_INFINITY,IDB_COLLATE_HI=[[[[[[[[[[[[]]]]]]]]]]]];function externaliseRecord(idbDoc){const doc=idbDoc.revs[idbDoc.rev].data;doc._id=idbDoc.id;doc._rev=idbDoc.rev;if(idbDoc.deleted)doc._deleted=true;return doc}function generateKeyRange(opts){function defined(obj,k2){return void 0!==obj[k2]}function convert(key2,exact){return[0].concat(key2).map((function(k2){if(null===k2&&exact)return IDB_NULL;else if(true===k2)return IDB_TRUE;else if(false===k2)return IDB_FALSE;if(!exact)if(k2===COUCH_COLLATE_LO)return IDB_COLLATE_LO;else if(Object.prototype.hasOwnProperty.call(k2,COUCH_COLLATE_HI))return IDB_COLLATE_HI;return k2}))}if(!defined(opts,"inclusive_end"))opts.inclusive_end=true;if(!defined(opts,"inclusive_start"))opts.inclusive_start=true;if(opts.descending){const realEndkey=opts.startkey,realInclusiveEnd=opts.inclusive_start;opts.startkey=opts.endkey;opts.endkey=realEndkey;opts.inclusive_start=opts.inclusive_end;opts.inclusive_end=realInclusiveEnd}try{if(defined(opts,"key"))return IDBKeyRange.only(convert(opts.key,true));if(defined(opts,"startkey")&&!defined(opts,"endkey"))return IDBKeyRange.bound(convert(opts.startkey),[1],!opts.inclusive_start,true);if(!defined(opts,"startkey")&&defined(opts,"endkey"))return IDBKeyRange.upperBound(convert(opts.endkey),!opts.inclusive_end);if(defined(opts,"startkey")&&defined(opts,"endkey"))return IDBKeyRange.bound(convert(opts.startkey),convert(opts.endkey),!opts.inclusive_start,!opts.inclusive_end);else return IDBKeyRange.only([0])}catch(err2){console.error("Could not generate keyRange",err2,opts);throw Error("Could not generate key range with "+JSON.stringify(opts))}}function getIndexHandle(pdb,fields,reject){const indexName=naturalIndexName(fields);return new Promise((function(resolve){pdb._openTransactionSafely([DOC_STORE2],"readonly",(function(err2,txn){if(err2)return idbError2(reject)(err2);txn.onabort=idbError2(reject);txn.ontimeout=idbError2(reject);if(-1===Array.from(txn.objectStore(DOC_STORE2).indexNames).indexOf(indexName))pdb._freshen().then((function(){return getIndexHandle(pdb,fields,reject)})).then(resolve);else resolve(txn.objectStore(DOC_STORE2).index(indexName))}))}))}function query(idb,signature,opts,fallback){const pdb=this,parts=signature.split("/");return new Promise((function(resolve,reject){pdb.get("_design/"+parts[0]).then((function(ddoc){if(isPartialFilterView(ddoc,parts[1]))return fallback(signature,opts).then(resolve,reject);const fields=rawIndexFields(ddoc,parts[1]);if(!fields)throw new Error("ddoc "+ddoc._id+" with view "+parts[1]+" does not have map.options.def.fields defined.");let skip=opts.skip,limit=Number.isInteger(opts.limit)&&opts.limit;return getIndexHandle(pdb,fields,reject).then((function(indexHandle){const keyRange=generateKeyRange(opts),req=indexHandle.openCursor(keyRange,opts.descending?"prev":"next"),rows=[];req.onerror=idbError2(reject);req.onsuccess=function(e4){const cursor=e4.target.result;if(!cursor||0===limit)return resolve({rows});if(!skip){if(limit)limit-=1;rows.push({doc:externaliseRecord(cursor.value)});cursor.continue()}else{cursor.advance(skip);skip=false}}}))})).catch(reject)}))}function viewCleanup(idb,fallback){return fallback()}function purgeAttachments(doc,revs){if(!doc.attachments)return{};for(let key2 in doc.attachments){const attachment=doc.attachments[key2];for(let rev3 of revs)if(attachment.revs[rev3])delete attachment.revs[rev3];if(0===Object.keys(attachment.revs).length)delete doc.attachments[key2]}return doc.attachments}function purge(txn,docId,revs,callback){if(txn.error)return callback(txn.error);const docStore=txn.txn.objectStore(DOC_STORE2),deletedRevs=[];let documentWasRemovedCompletely=false;docStore.get(docId).onsuccess=e4=>{const doc=e4.target.result;for(const rev3 of revs){doc.rev_tree=removeLeafFromRevTree(doc.rev_tree,rev3);delete doc.revs[rev3];deletedRevs.push(rev3)}if(0!==doc.rev_tree.length){doc.rev=winningRev(doc);doc.data=doc.revs[doc.rev].data;doc.attachments=purgeAttachments(doc,revs);docStore.put(doc)}else{docStore.delete(doc.id);documentWasRemovedCompletely=true}};txn.txn.oncomplete=function(){callback(null,{ok:true,deletedRevs,documentWasRemovedCompletely})}}var ADAPTER_NAME="indexeddb",idbChanges=new Changes,openDatabases={};function IndexeddbPouch(dbOpts,callback){if(dbOpts.view_adapter)console.log("Please note that the indexeddb adapter manages _find indexes itself, therefore it is not using your specified view_adapter");const api=this;let metadata={};const $=function(fun){return function(){const args=Array.prototype.slice.call(arguments);setup(openDatabases,api,dbOpts).then((function(res2){metadata=res2.metadata;args.unshift(res2.idb);fun.apply(api,args)})).catch((function(err2){const last=args.pop();if("function"==typeof last)last(err2);else console.error(err2)}))}},$p=function(fun){return function(){const args=Array.prototype.slice.call(arguments);return setup(openDatabases,api,dbOpts).then((function(res2){metadata=res2.metadata;args.unshift(res2.idb);return fun.apply(api,args)}))}},$t2=function(fun,stores,mode){mode=mode||"readonly";return function(){const args=Array.prototype.slice.call(arguments),txn={};setup(openDatabases,api,dbOpts).then((function(res2){metadata=res2.metadata;txn.txn=res2.idb.transaction(stores,mode)})).catch((function(err2){console.error("Failed to establish transaction safely");console.error(err2);txn.error=err2})).then((function(){args.unshift(txn);fun.apply(api,args)}))}};api._openTransactionSafely=function(stores,mode,callback2){$t2((function(txn,callback3){callback3(txn.error,txn.txn)}),stores,mode)(callback2)};api._remote=false;api.type=function(){return ADAPTER_NAME};api._id=$((function(_,cb2){cb2(null,metadata.db_uuid)}));api._info=$((function(_,cb2){return info2(metadata,cb2)}));api._get=$t2(get,[DOC_STORE2]);api._getLocal=$t2((function(txn,id,callback2){return getLocal(txn,id,api,callback2)}),[META_LOCAL_STORE]);api._bulkDocs=$((function(_,req,opts,callback2){bulkDocs(api,req,opts,metadata,dbOpts,idbChanges,callback2)}));api._allDocs=$t2((function(txn,opts,cb2){allDocs(txn,metadata,opts,cb2)}),[DOC_STORE2]);api._getAttachment=getAttachment;api._changes=$t2((function(txn,opts){changes2(txn,idbChanges,api,dbOpts,opts)}),[DOC_STORE2]);api._getRevisionTree=$t2(getRevisionTree,[DOC_STORE2]);api._doCompaction=$t2(doCompaction,[DOC_STORE2],"readwrite");api._customFindAbstractMapper={query:$p(query),viewCleanup:$p(viewCleanup)};api._destroy=function(opts,callback2){return destroy(dbOpts,openDatabases,idbChanges,callback2)};api._close=$((function(db,cb2){delete openDatabases[dbOpts.name];db.close();cb2()}));api._freshen=function(){return new Promise((function(resolve){api._close((function(){$(resolve)()}))}))};api._purge=$t2(purge,[DOC_STORE2],"readwrite");setTimeout((function(){callback(null,api)}))}IndexeddbPouch.valid=function(){return true};function index2(PouchDB2){PouchDB2.adapter(ADAPTER_NAME,IndexeddbPouch,true)}var index_es_default3=index2;function pool(promiseFactories,limit){return new Promise((function(resolve,reject){var err2,running2=0,current=0,done=0,len=promiseFactories.length;function runNext(){running2++;promiseFactories[current++]().then(onSuccess,onError)}function doNext(){if(++done===len)if(err2)reject(err2);else resolve();else runNextBatch()}function onSuccess(){running2--;doNext()}function onError(thisErr){running2--;err2=err2||thisErr;doNext()}function runNextBatch(){for(;running2<limit&&current<len;)runNext()}runNextBatch()}))}var CHANGES_BATCH_SIZE=25,MAX_SIMULTANEOUS_REVS=50,CHANGES_TIMEOUT_BUFFER=5e3,DEFAULT_HEARTBEAT=1e4,supportsBulkGetMap={};function readAttachmentsAsBlobOrBuffer(row){const doc=row.doc||row.ok,atts=doc&&doc._attachments;if(atts)Object.keys(atts).forEach((function(filename){const att=atts[filename];att.data=b64ToBluffer(att.data,att.content_type)}))}function encodeDocId(id){if(/^_design/.test(id))return"_design/"+encodeURIComponent(id.slice(8));if(id.startsWith("_local/"))return"_local/"+encodeURIComponent(id.slice(7));else return encodeURIComponent(id)}function preprocessAttachments2(doc){if(!doc._attachments||!Object.keys(doc._attachments))return Promise.resolve();else return Promise.all(Object.keys(doc._attachments).map((function(key2){const attachment=doc._attachments[key2];if(attachment.data&&"string"!=typeof attachment.data)return new Promise((function(resolve){blobToBase64(attachment.data,resolve)})).then((function(b64){attachment.data=b64}))})))}function hasUrlPrefix(opts){if(!opts.prefix)return false;const protocol=parseUri(opts.prefix).protocol;return"http"===protocol||"https"===protocol}function getHost(name,opts){if(hasUrlPrefix(opts)){const dbName=opts.name.substr(opts.prefix.length);name=opts.prefix.replace(/\/?$/,"/")+encodeURIComponent(dbName)}const uri=parseUri(name);if(uri.user||uri.password)uri.auth={username:uri.user,password:uri.password};const parts=uri.path.replace(/(^\/|\/$)/g,"").split("/");uri.db=parts.pop();if(-1===uri.db.indexOf("%"))uri.db=encodeURIComponent(uri.db);uri.path=parts.join("/");return uri}function genDBUrl(opts,path2){return genUrl(opts,opts.db+"/"+path2)}function genUrl(opts,path2){const pathDel=!opts.path?"":"/";return opts.protocol+"://"+opts.host+(opts.port?":"+opts.port:"")+"/"+opts.path+pathDel+path2}function paramsToStr(params){const paramKeys=Object.keys(params);if(0===paramKeys.length)return"";else return"?"+paramKeys.map((key2=>key2+"="+encodeURIComponent(params[key2]))).join("&")}function shouldCacheBust(opts){const ua="undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"",isIE=-1!==ua.indexOf("msie"),isTrident=-1!==ua.indexOf("trident"),isEdge=-1!==ua.indexOf("edge"),isGET=!("method"in opts)||"GET"===opts.method;return(isIE||isTrident||isEdge)&&isGET}function HttpPouch(opts,callback){const api=this,host=getHost(opts.name,opts),dbUrl=genDBUrl(host,"");opts=clone(opts);const ourFetch=async function(url,options){(options=options||{}).headers=options.headers||new h2;options.credentials="include";if(opts.auth||host.auth){const nAuth=opts.auth||host.auth,str=nAuth.username+":"+nAuth.password,token=thisBtoa(unescape(encodeURIComponent(str)));options.headers.set("Authorization","Basic "+token)}const headers=opts.headers||{};Object.keys(headers).forEach((function(key2){options.headers.append(key2,headers[key2])}));if(shouldCacheBust(options))url+=(-1===url.indexOf("?")?"?":"&")+"_nonce="+Date.now();const fetchFun=opts.fetch||f3;return await fetchFun(url,options)};function adapterFun$$1(name,fun){return adapterFun(name,(function(...args){setup2().then((function(){return fun.apply(this,args)})).catch((function(e4){args.pop()(e4)}))})).bind(api)}async function fetchJSON(url,options){const result={};(options=options||{}).headers=options.headers||new h2;if(!options.headers.get("Content-Type"))options.headers.set("Content-Type","application/json");if(!options.headers.get("Accept"))options.headers.set("Accept","application/json");const response=await ourFetch(url,options);result.ok=response.ok;result.status=response.status;const json=await response.json();result.data=json;if(!result.ok){result.data.status=result.status;throw generateErrorFromResponse(result.data)}if(Array.isArray(result.data))result.data=result.data.map((function(v2){if(v2.error||v2.missing)return generateErrorFromResponse(v2);else return v2}));return result}let setupPromise;async function setup2(){if(opts.skip_setup)return Promise.resolve();if(setupPromise)return setupPromise;setupPromise=fetchJSON(dbUrl).catch((function(err2){if(err2&&err2.status&&404===err2.status){explainError(404,"PouchDB is just detecting if the remote exists.");return fetchJSON(dbUrl,{method:"PUT"})}else return Promise.reject(err2)})).catch((function(err2){if(err2&&err2.status&&412===err2.status)return true;else return Promise.reject(err2)}));setupPromise.catch((function(){setupPromise=null}));return setupPromise}nextTick((function(){callback(null,api)}));api._remote=true;api.type=function(){return"http"};api.id=adapterFun$$1("id",(async function(callback2){let result;try{const response=await ourFetch(genUrl(host,""));result=await response.json()}catch(err2){result={}}callback2(null,result&&result.uuid?result.uuid+host.db:genDBUrl(host,""))}));api.compact=adapterFun$$1("compact",(async function(opts2,callback2){if("function"==typeof opts2){callback2=opts2;opts2={}}opts2=clone(opts2);await fetchJSON(genDBUrl(host,"_compact"),{method:"POST"});(function ping(){api.info((function(err2,res2){if(res2&&!res2.compact_running)callback2(null,{ok:true});else setTimeout(ping,opts2.interval||200)}))})()}));api.bulkGet=adapterFun("bulkGet",(function(opts2,callback2){const self3=this;async function doBulkGet(cb2){const params={};if(opts2.revs)params.revs=true;if(opts2.attachments)params.attachments=true;if(opts2.latest)params.latest=true;try{const result=await fetchJSON(genDBUrl(host,"_bulk_get"+paramsToStr(params)),{method:"POST",body:JSON.stringify({docs:opts2.docs})});if(opts2.attachments&&opts2.binary)result.data.results.forEach((function(res2){res2.docs.forEach(readAttachmentsAsBlobOrBuffer)}));cb2(null,result.data)}catch(error){cb2(error)}}function doBulkGetShim(){const batchSize=MAX_SIMULTANEOUS_REVS,numBatches=Math.ceil(opts2.docs.length/batchSize);let numDone=0;const results=new Array(numBatches);function onResult(batchNum){return function(err2,res2){results[batchNum]=res2.results;if(++numDone===numBatches)callback2(null,{results:results.flat()})}}for(let i2=0;i2<numBatches;i2++){const subOpts=pick(opts2,["revs","attachments","binary","latest"]);subOpts.docs=opts2.docs.slice(i2*batchSize,Math.min(opts2.docs.length,(i2+1)*batchSize));bulkGet(self3,subOpts,onResult(i2))}}const dbUrl2=genUrl(host,""),supportsBulkGet=supportsBulkGetMap[dbUrl2];if("boolean"!=typeof supportsBulkGet)doBulkGet((function(err2,res2){if(err2){supportsBulkGetMap[dbUrl2]=false;explainError(err2.status,"PouchDB is just detecting if the remote supports the _bulk_get API.");doBulkGetShim()}else{supportsBulkGetMap[dbUrl2]=true;callback2(null,res2)}}));else if(supportsBulkGet)doBulkGet(callback2);else doBulkGetShim()}));api._info=async function(callback2){try{await setup2();const response=await ourFetch(genDBUrl(host,"")),info3=await response.json();info3.host=genDBUrl(host,"");callback2(null,info3)}catch(err2){callback2(err2)}};api.fetch=async function(path2,options){await setup2();const url="/"===path2.substring(0,1)?genUrl(host,path2.substring(1)):genDBUrl(host,path2);return ourFetch(url,options)};api.get=adapterFun$$1("get",(async function(id,opts2,callback2){if("function"==typeof opts2){callback2=opts2;opts2={}}const params={};if((opts2=clone(opts2)).revs)params.revs=true;if(opts2.revs_info)params.revs_info=true;if(opts2.latest)params.latest=true;if(opts2.open_revs){if("all"!==opts2.open_revs)opts2.open_revs=JSON.stringify(opts2.open_revs);params.open_revs=opts2.open_revs}if(opts2.rev)params.rev=opts2.rev;if(opts2.conflicts)params.conflicts=opts2.conflicts;if(opts2.update_seq)params.update_seq=opts2.update_seq;id=encodeDocId(id);function fetchAttachments(doc){const atts=doc._attachments,filenames=atts&&Object.keys(atts);if(atts&&filenames.length)return pool(filenames.map((function(filename){return function(){return async function fetchData(filename){const att=atts[filename],path2=encodeDocId(doc._id)+"/"+encodeAttachmentId(filename)+"?rev="+doc._rev,response=await ourFetch(genDBUrl(host,path2));let blob,data;if("buffer"in response)blob=await response.buffer();else blob=await response.blob();if(opts2.binary){const typeFieldDescriptor=Object.getOwnPropertyDescriptor(blob.__proto__,"type");if(!typeFieldDescriptor||typeFieldDescriptor.set)blob.type=att.content_type;data=blob}else data=await new Promise((function(resolve){blobToBase64(blob,resolve)}));delete att.stub;delete att.length;att.data=data}(filename)}})),5)}const url=genDBUrl(host,id+paramsToStr(params));try{const res2=await fetchJSON(url);if(opts2.attachments)await function fetchAllAttachments(docOrDocs){if(Array.isArray(docOrDocs))return Promise.all(docOrDocs.map((function(doc){if(doc.ok)return fetchAttachments(doc.ok)})));else return fetchAttachments(docOrDocs)}(res2.data);callback2(null,res2.data)}catch(error){error.docId=id;callback2(error)}}));api.remove=adapterFun$$1("remove",(async function(docOrId,optsOrRev,opts2,cb2){let doc;if("string"==typeof optsOrRev){doc={_id:docOrId,_rev:optsOrRev};if("function"==typeof opts2){cb2=opts2;opts2={}}}else{doc=docOrId;if("function"==typeof optsOrRev){cb2=optsOrRev;opts2={}}else{cb2=opts2;opts2=optsOrRev}}const rev3=doc._rev||opts2.rev,url=genDBUrl(host,encodeDocId(doc._id))+"?rev="+rev3;try{cb2(null,(await fetchJSON(url,{method:"DELETE"})).data)}catch(error){cb2(error)}}));function encodeAttachmentId(attachmentId){return attachmentId.split("/").map(encodeURIComponent).join("/")}api.getAttachment=adapterFun$$1("getAttachment",(async function(docId,attachmentId,opts2,callback2){if("function"==typeof opts2){callback2=opts2;opts2={}}const params=opts2.rev?"?rev="+opts2.rev:"",url=genDBUrl(host,encodeDocId(docId))+"/"+encodeAttachmentId(attachmentId)+params;let contentType;try{const response=await ourFetch(url,{method:"GET"});if(!response.ok)throw response;contentType=response.headers.get("content-type");let blob;if("undefined"!=typeof process&&!process.browser&&"function"==typeof response.buffer)blob=await response.buffer();else blob=await response.blob();if("undefined"!=typeof process&&!process.browser){const typeFieldDescriptor=Object.getOwnPropertyDescriptor(blob.__proto__,"type");if(!typeFieldDescriptor||typeFieldDescriptor.set)blob.type=contentType}callback2(null,blob)}catch(err2){callback2(err2)}}));api.removeAttachment=adapterFun$$1("removeAttachment",(async function(docId,attachmentId,rev3,callback2){const url=genDBUrl(host,encodeDocId(docId)+"/"+encodeAttachmentId(attachmentId))+"?rev="+rev3;try{callback2(null,(await fetchJSON(url,{method:"DELETE"})).data)}catch(error){callback2(error)}}));api.putAttachment=adapterFun$$1("putAttachment",(async function(docId,attachmentId,rev3,blob,type,callback2){if("function"==typeof type){callback2=type;type=blob;blob=rev3;rev3=null}const id=encodeDocId(docId)+"/"+encodeAttachmentId(attachmentId);let url=genDBUrl(host,id);if(rev3)url+="?rev="+rev3;if("string"==typeof blob){let binary;try{binary=thisAtob(blob)}catch(err2){return callback2(createError(BAD_ARG,"Attachment is not a valid base64 string"))}blob=binary?binStringToBluffer(binary,type):""}try{callback2(null,(await fetchJSON(url,{headers:new h2({"Content-Type":type}),method:"PUT",body:blob})).data)}catch(error){callback2(error)}}));api._bulkDocs=async function(req,opts2,callback2){req.new_edits=opts2.new_edits;try{await setup2();await Promise.all(req.docs.map(preprocessAttachments2));callback2(null,(await fetchJSON(genDBUrl(host,"_bulk_docs"),{method:"POST",body:JSON.stringify(req)})).data)}catch(error){callback2(error)}};api._put=async function(doc,opts2,callback2){try{await setup2();await preprocessAttachments2(doc);callback2(null,(await fetchJSON(genDBUrl(host,encodeDocId(doc._id)),{method:"PUT",body:JSON.stringify(doc)})).data)}catch(error){error.docId=doc&&doc._id;callback2(error)}};api.allDocs=adapterFun$$1("allDocs",(async function(opts2,callback2){if("function"==typeof opts2){callback2=opts2;opts2={}}const params={};let body,method="GET";if((opts2=clone(opts2)).conflicts)params.conflicts=true;if(opts2.update_seq)params.update_seq=true;if(opts2.descending)params.descending=true;if(opts2.include_docs)params.include_docs=true;if(opts2.attachments)params.attachments=true;if(opts2.key)params.key=JSON.stringify(opts2.key);if(opts2.start_key)opts2.startkey=opts2.start_key;if(opts2.startkey)params.startkey=JSON.stringify(opts2.startkey);if(opts2.end_key)opts2.endkey=opts2.end_key;if(opts2.endkey)params.endkey=JSON.stringify(opts2.endkey);if("undefined"!=typeof opts2.inclusive_end)params.inclusive_end=!!opts2.inclusive_end;if("undefined"!=typeof opts2.limit)params.limit=opts2.limit;if("undefined"!=typeof opts2.skip)params.skip=opts2.skip;const paramStr=paramsToStr(params);if("undefined"!=typeof opts2.keys){method="POST";body={keys:opts2.keys}}try{const result=await fetchJSON(genDBUrl(host,"_all_docs"+paramStr),{method,body:JSON.stringify(body)});if(opts2.include_docs&&opts2.attachments&&opts2.binary)result.data.rows.forEach(readAttachmentsAsBlobOrBuffer);callback2(null,result.data)}catch(error){callback2(error)}}));api._changes=function(opts2){const batchSize="batch_size"in opts2?opts2.batch_size:CHANGES_BATCH_SIZE;if((opts2=clone(opts2)).continuous&&!("heartbeat"in opts2))opts2.heartbeat=DEFAULT_HEARTBEAT;let requestTimeout2="timeout"in opts2?opts2.timeout:3e4;if("timeout"in opts2&&opts2.timeout&&requestTimeout2-opts2.timeout<CHANGES_TIMEOUT_BUFFER)requestTimeout2=opts2.timeout+CHANGES_TIMEOUT_BUFFER;if("heartbeat"in opts2&&opts2.heartbeat&&requestTimeout2-opts2.heartbeat<CHANGES_TIMEOUT_BUFFER)requestTimeout2=opts2.heartbeat+CHANGES_TIMEOUT_BUFFER;const params={};if("timeout"in opts2&&opts2.timeout)params.timeout=opts2.timeout;const limit="undefined"!=typeof opts2.limit?opts2.limit:false;let leftToFetch=limit;if(opts2.style)params.style=opts2.style;if(opts2.include_docs||opts2.filter&&"function"==typeof opts2.filter)params.include_docs=true;if(opts2.attachments)params.attachments=true;if(opts2.continuous)params.feed="longpoll";if(opts2.seq_interval)params.seq_interval=opts2.seq_interval;if(opts2.conflicts)params.conflicts=true;if(opts2.descending)params.descending=true;if(opts2.update_seq)params.update_seq=true;if("heartbeat"in opts2)if(opts2.heartbeat)params.heartbeat=opts2.heartbeat;if(opts2.filter&&"string"==typeof opts2.filter)params.filter=opts2.filter;if(opts2.view&&"string"==typeof opts2.view){params.filter="_view";params.view=opts2.view}if(opts2.query_params&&"object"==typeof opts2.query_params)for(const param_name in opts2.query_params)if(Object.prototype.hasOwnProperty.call(opts2.query_params,param_name))params[param_name]=opts2.query_params[param_name];let body,method="GET";if(opts2.doc_ids){params.filter="_doc_ids";method="POST";body={doc_ids:opts2.doc_ids}}else if(opts2.selector){params.filter="_selector";method="POST";body={selector:opts2.selector}}const controller=new AbortController;let lastFetchedSeq;const fetchData=async function(since,callback2){if(opts2.aborted)return;params.since=since;if("object"==typeof params.since)params.since=JSON.stringify(params.since);if(opts2.descending){if(limit)params.limit=leftToFetch}else params.limit=!limit||leftToFetch>batchSize?batchSize:leftToFetch;const url=genDBUrl(host,"_changes"+paramsToStr(params)),fetchOpts={signal:controller.signal,method,body:JSON.stringify(body)};lastFetchedSeq=since;if(!opts2.aborted)try{await setup2();callback2(null,(await fetchJSON(url,fetchOpts)).data)}catch(error){callback2(error)}},results={results:[]},fetched=function(err2,res2){if(opts2.aborted)return;let raw_results_length=0;if(res2&&res2.results){raw_results_length=res2.results.length;results.last_seq=res2.last_seq;let pending=null,lastSeq=null;if("number"==typeof res2.pending)pending=res2.pending;if("string"==typeof results.last_seq||"number"==typeof results.last_seq)lastSeq=results.last_seq;({}).query=opts2.query_params;res2.results=res2.results.filter((function(c2){leftToFetch--;const ret=filterChange(opts2)(c2);if(ret){if(opts2.include_docs&&opts2.attachments&&opts2.binary)readAttachmentsAsBlobOrBuffer(c2);if(opts2.return_docs)results.results.push(c2);opts2.onChange(c2,pending,lastSeq)}return ret}))}else if(err2){opts2.aborted=true;opts2.complete(err2);return}if(res2&&res2.last_seq)lastFetchedSeq=res2.last_seq;const finished=limit&&leftToFetch<=0||res2&&raw_results_length<batchSize||opts2.descending;if(opts2.continuous&&!(limit&&leftToFetch<=0)||!finished)nextTick((function(){fetchData(lastFetchedSeq,fetched)}));else opts2.complete(null,results)};fetchData(opts2.since||0,fetched);return{cancel:function(){opts2.aborted=true;controller.abort()}}};api.revsDiff=adapterFun$$1("revsDiff",(async function(req,opts2,callback2){if("function"==typeof opts2){callback2=opts2;opts2={}}try{callback2(null,(await fetchJSON(genDBUrl(host,"_revs_diff"),{method:"POST",body:JSON.stringify(req)})).data)}catch(error){callback2(error)}}));api._close=function(callback2){callback2()};api._destroy=async function(options,callback2){try{callback2(null,await fetchJSON(genDBUrl(host,""),{method:"DELETE"}))}catch(error){if(404===error.status)callback2(null,{ok:true});else callback2(error)}}}HttpPouch.valid=function(){return true};function index3(PouchDB2){PouchDB2.adapter("http",HttpPouch,false);PouchDB2.adapter("https",HttpPouch,false)}var index_es_default4=index3,QueryParseError=class _QueryParseError extends Error{constructor(message){super();this.status=400;this.name="query_parse_error";this.message=message;this.error=true;try{Error.captureStackTrace(this,_QueryParseError)}catch(e4){}}},NotFoundError=class _NotFoundError extends Error{constructor(message){super();this.status=404;this.name="not_found";this.message=message;this.error=true;try{Error.captureStackTrace(this,_NotFoundError)}catch(e4){}}},BuiltInError=class _BuiltInError extends Error{constructor(message){super();this.status=500;this.name="invalid_value";this.message=message;this.error=true;try{Error.captureStackTrace(this,_BuiltInError)}catch(e4){}}};function promisedCallback(promise2,callback){if(callback)promise2.then((function(res2){nextTick((function(){callback(null,res2)}))}),(function(reason){nextTick((function(){callback(reason)}))}));return promise2}function callbackify(fun){return function(...args){var cb2=args.pop(),promise2=fun.apply(this,args);if("function"==typeof cb2)promisedCallback(promise2,cb2);return promise2}}function fin(promise2,finalPromiseFactory){return promise2.then((function(res2){return finalPromiseFactory().then((function(){return res2}))}),(function(reason){return finalPromiseFactory().then((function(){throw reason}))}))}function sequentialize(queue2,promiseFactory){return function(){var args=arguments,that=this;return queue2.add((function(){return promiseFactory.apply(that,args)}))}}function uniq(arr){var theSet=new Set(arr),result=new Array(theSet.size),index5=-1;theSet.forEach((function(value){result[++index5]=value}));return result}function mapToKeysArray(map2){var result=new Array(map2.size),index5=-1;map2.forEach((function(value,key2){result[++index5]=key2}));return result}var import_spark_md54=__toESM(require_spark_md5()),setImmediateShim4=self.setImmediate||self.setTimeout,MD5_CHUNK_SIZE4=32768;function rawToBase644(raw){return thisBtoa(raw)}function appendBlob4(buffer,blob,start,end,callback){if(start>0||end<blob.size)blob=blob.slice(start,end);readAsArrayBuffer(blob,(function(arrayBuffer){buffer.append(arrayBuffer);callback()}))}function appendString4(buffer,string,start,end,callback){if(start>0||end<string.length)string=string.substring(start,end);buffer.appendBinary(string);callback()}function binaryMd54(data,callback){var inputIsString="string"==typeof data,len=inputIsString?data.length:data.size,chunkSize=Math.min(MD5_CHUNK_SIZE4,len),chunks=Math.ceil(len/chunkSize),currentChunk=0,buffer=inputIsString?new import_spark_md54.default:new import_spark_md54.default.ArrayBuffer,append2=inputIsString?appendString4:appendBlob4;function next(){setImmediateShim4(loadNextChunk)}function done(){var base64=rawToBase644(buffer.end(true));callback(base64);buffer.destroy()}function loadNextChunk(){var start=currentChunk*chunkSize,end=start+chunkSize;if(++currentChunk<chunks)append2(buffer,data,start,end,next);else append2(buffer,data,start,end,done)}loadNextChunk()}function stringMd54(string){return import_spark_md54.default.hash(string)}var TaskQueue2=class{constructor(){this.promise=Promise.resolve()}add(promiseFactory){this.promise=this.promise.catch((()=>{})).then((()=>promiseFactory()));return this.promise}finish(){return this.promise}};function stringify3(input){if(!input)return"undefined";switch(typeof input){case"function":return input.toString();case"string":return input.toString();default:return JSON.stringify(input)}}function createViewSignature(mapFun,reduceFun){return stringify3(mapFun)+stringify3(reduceFun)+"undefined"}async function createView(sourceDB,viewName,mapFun,reduceFun,temporary,localDocName2){const viewSignature=createViewSignature(mapFun,reduceFun);let cachedViews;if(!temporary){cachedViews=sourceDB._cachedViews=sourceDB._cachedViews||{};if(cachedViews[viewSignature])return cachedViews[viewSignature]}const promiseForView=sourceDB.info().then((async function(info3){const depDbName=info3.db_name+"-mrview-"+(temporary?"temp":stringMd54(viewSignature));await upsert(sourceDB,"_local/"+localDocName2,(function diffFunction(doc){doc.views=doc.views||{};let fullViewName=viewName;if(-1===fullViewName.indexOf("/"))fullViewName=viewName+"/"+viewName;const depDbs=doc.views[fullViewName]=doc.views[fullViewName]||{};if(!depDbs[depDbName]){depDbs[depDbName]=true;return doc}}));const db=(await sourceDB.registerDependentDatabase(depDbName)).db;db.auto_compaction=true;const view={name:depDbName,db,sourceDB,adapter:sourceDB.adapter,mapFun,reduceFun};let lastSeqDoc;try{lastSeqDoc=await view.db.get("_local/lastSeq")}catch(err2){if(404!==err2.status)throw err2}view.seq=lastSeqDoc?lastSeqDoc.seq:0;if(cachedViews)view.db.once("destroyed",(function(){delete cachedViews[viewSignature]}));return view}));if(cachedViews)cachedViews[viewSignature]=promiseForView;return promiseForView}var persistentQueues={},tempViewQueue=new TaskQueue2,CHANGES_BATCH_SIZE2=50;function parseViewName(name){return-1===name.indexOf("/")?[name,name]:name.split("/")}function isGenOne(changes3){return 1===changes3.length&&/^1-/.test(changes3[0].rev)}function emitError(db,e4,data){try{db.emit("error",e4)}catch(err2){guardedConsole("error","The user's map/reduce function threw an uncaught error.\nYou can debug this error by doing:\nmyDatabase.on('error', function (err) { debugger; });\nPlease double-check your map/reduce function.");guardedConsole("error",e4,data)}}function createAbstractMapReduce(localDocName2,mapper3,reducer3,ddocValidator3){function tryMap(db,fun,doc){try{fun(doc)}catch(e4){emitError(db,e4,{fun,doc})}}function tryReduce(db,fun,keys2,values,rereduce){try{return{output:fun(keys2,values,rereduce)}}catch(e4){emitError(db,e4,{fun,keys:keys2,values,rereduce});return{error:e4}}}function sortByKeyThenValue(x2,y2){const keyCompare=collate(x2.key,y2.key);return 0!==keyCompare?keyCompare:collate(x2.value,y2.value)}function sliceResults(results,limit,skip){skip=skip||0;if("number"==typeof limit)return results.slice(skip,limit+skip);else if(skip>0)return results.slice(skip);return results}function rowToDocId(row){const val2=row.value;return val2&&"object"==typeof val2&&val2._id||row.id}function postprocessAttachments(opts){return function(res2){if(opts.include_docs&&opts.attachments&&opts.binary)(function readAttachmentsAsBlobOrBuffer2(res2){for(const row of res2.rows){const atts=row.doc&&row.doc._attachments;if(atts)for(const filename of Object.keys(atts)){const att=atts[filename];atts[filename].data=b64ToBluffer(att.data,att.content_type)}}})(res2);return res2}}function addHttpParam(paramName,opts,params,asJson){let val2=opts[paramName];if("undefined"!=typeof val2){if(asJson)val2=encodeURIComponent(JSON.stringify(val2));params.push(paramName+"="+val2)}}function coerceInteger(integerCandidate){if("undefined"!=typeof integerCandidate){const asNumber=Number(integerCandidate);if(!isNaN(asNumber)&&asNumber===parseInt(integerCandidate,10))return asNumber;else return integerCandidate}}function checkPositiveInteger(number){if(number){if("number"!=typeof number)return new QueryParseError(`Invalid value for integer: "${number}"`);if(number<0)return new QueryParseError(`Invalid value for positive integer: "${number}"`)}}function checkQueryParseError(options,fun){const startkeyName=options.descending?"endkey":"startkey",endkeyName=options.descending?"startkey":"endkey";if("undefined"!=typeof options[startkeyName]&&"undefined"!=typeof options[endkeyName]&&collate(options[startkeyName],options[endkeyName])>0)throw new QueryParseError("No rows can match your key range, reverse your start_key and end_key or set {descending : true}");else if(fun.reduce&&false!==options.reduce)if(options.include_docs)throw new QueryParseError("{include_docs:true} is invalid for reduce");else if(options.keys&&options.keys.length>1&&!options.group&&!options.group_level)throw new QueryParseError("Multi-key fetches for reduce views must use {group: true}");for(const optionName of["group_level","limit","skip"]){const error=checkPositiveInteger(options[optionName]);if(error)throw error}}function defaultsTo(value){return function(reason){if(404===reason.status)return value;else throw reason}}function getQueue(view){const viewName="string"==typeof view?view:view.name;let queue2=persistentQueues[viewName];if(!queue2)queue2=persistentQueues[viewName]=new TaskQueue2;return queue2}async function updateView(view,opts){return sequentialize(getQueue(view),(function(){return async function updateViewInQueue(view,opts){let mapResults,doc,taskId;const mapFun=mapper3(view.mapFun,(function emit2(key2,value){const output={id:doc._id,key:normalizeKey(key2)};if("undefined"!=typeof value&&null!==value)output.value=normalizeKey(value);mapResults.push(output)}));let currentSeq=view.seq||0,indexed_docs=0;const progress={view:view.name,indexed_docs};view.sourceDB.emit("indexing",progress);const queue2=new TaskQueue2;function createIndexableKeysToKeyValues(mapResults2){const indexableKeysToKeyValues=new Map;let lastKey;for(let i2=0,len=mapResults2.length;i2<len;i2++){const emittedKeyValue=mapResults2[i2],complexKey=[emittedKeyValue.key,emittedKeyValue.id];if(i2>0&&0===collate(emittedKeyValue.key,lastKey))complexKey.push(i2);indexableKeysToKeyValues.set(toIndexableString(complexKey),emittedKeyValue);lastKey=emittedKeyValue.key}return indexableKeysToKeyValues}try{await function createTask(){return view.sourceDB.info().then((function(info3){taskId=view.sourceDB.activeTasks.add({name:"view_indexing",total_items:info3.update_seq-currentSeq})}))}();await async function processNextBatch(){return function processBatch(response,purges){const results=response.results;if(!results.length&&!purges.length)return;for(const purge2 of purges)if(results.findIndex((function(change){return change.id===purge2.docId}))<0){const entry={_id:purge2.docId,doc:{_id:purge2.docId,_deleted:1},changes:[]};if(purge2.doc){entry.doc=purge2.doc;entry.changes.push({rev:purge2.doc._rev})}results.push(entry)}const docIdsToChangesAndEmits=function createDocIdsToChangesAndEmits(results){const docIdsToChangesAndEmits=new Map;for(const change of results){if("_"!==change.doc._id[0]){mapResults=[];doc=change.doc;if(!doc._deleted)tryMap(view.sourceDB,mapFun,doc);mapResults.sort(sortByKeyThenValue);const indexableKeysToKeyValues=createIndexableKeysToKeyValues(mapResults);docIdsToChangesAndEmits.set(change.doc._id,[indexableKeysToKeyValues,change.changes])}currentSeq=change.seq}return docIdsToChangesAndEmits}(results);queue2.add(function processChange2(docIdsToChangesAndEmits,seq){return function(){return function saveKeyValues(view,docIdsToChangesAndEmits,seq){return view.db.get("_local/lastSeq").catch(defaultsTo({_id:"_local/lastSeq",seq:0})).then((function(lastSeqDoc){var docIds=mapToKeysArray(docIdsToChangesAndEmits);return Promise.all(docIds.map((function(docId){return async function getDocsToPersist(docId,view,docIdsToChangesAndEmits){const metaDocId="_local/doc_"+docId,defaultMetaDoc={_id:metaDocId,keys:[]},docData=docIdsToChangesAndEmits.get(docId),indexableKeysToKeyValues=docData[0],changes3=docData[1],metaDoc=await function getMetaDoc(){if(isGenOne(changes3))return Promise.resolve(defaultMetaDoc);else return view.db.get(metaDocId).catch(defaultsTo(defaultMetaDoc))}();return function processKeyValueDocs(metaDoc2,kvDocsRes){const kvDocs=[],oldKeys=new Set;for(const row of kvDocsRes.rows){const doc=row.doc;if(doc){kvDocs.push(doc);oldKeys.add(doc._id);doc._deleted=!indexableKeysToKeyValues.has(doc._id);if(!doc._deleted){const keyValue=indexableKeysToKeyValues.get(doc._id);if("value"in keyValue)doc.value=keyValue.value}}}const newKeys=mapToKeysArray(indexableKeysToKeyValues);for(const key2 of newKeys)if(!oldKeys.has(key2)){const kvDoc={_id:key2},keyValue=indexableKeysToKeyValues.get(key2);if("value"in keyValue)kvDoc.value=keyValue.value;kvDocs.push(kvDoc)}metaDoc2.keys=uniq(newKeys.concat(metaDoc2.keys));kvDocs.push(metaDoc2);return kvDocs}(metaDoc,await function getKeyValueDocs(metaDoc2){if(!metaDoc2.keys.length)return Promise.resolve({rows:[]});else return view.db.allDocs({keys:metaDoc2.keys,include_docs:true})}(metaDoc))}(docId,view,docIdsToChangesAndEmits)}))).then((function(listOfDocsToPersist){var docsToPersist=listOfDocsToPersist.flat();lastSeqDoc.seq=seq;docsToPersist.push(lastSeqDoc);return view.db.bulkDocs({docs:docsToPersist})})).then((()=>function updatePurgeSeq(view){return view.sourceDB.get("_local/purges").then((function(res2){const purgeSeq=res2.purgeSeq;return view.db.get("_local/purgeSeq").then((function(res3){return res3._rev})).catch(defaultsTo(void 0)).then((function(rev3){return view.db.put({_id:"_local/purgeSeq",_rev:rev3,purgeSeq})}))})).catch((function(err2){if(404!==err2.status)throw err2}))}(view)))}))}(view,docIdsToChangesAndEmits,seq)}}(docIdsToChangesAndEmits,currentSeq));indexed_docs+=results.length;const progress2={view:view.name,last_seq:response.last_seq,results_count:results.length,indexed_docs};view.sourceDB.emit("indexing",progress2);view.sourceDB.activeTasks.update(taskId,{completed_items:indexed_docs});if(!(results.length<opts.changes_batch_size))return processNextBatch();else return}(await view.sourceDB.changes({return_docs:true,conflicts:true,include_docs:true,style:"all_docs",since:currentSeq,limit:opts.changes_batch_size}),await function getRecentPurges(){return view.db.get("_local/purgeSeq").then((function(res2){return res2.purgeSeq})).catch(defaultsTo(-1)).then((function(purgeSeq){return view.sourceDB.get("_local/purges").then((function(res2){const recentPurges=res2.purges.filter((function(purge2,index5){return index5>purgeSeq})).map((purge2=>purge2.docId)),uniquePurges=recentPurges.filter((function(docId,index5){return recentPurges.indexOf(docId)===index5}));return Promise.all(uniquePurges.map((function(docId){return view.sourceDB.get(docId).then((function(doc2){return{docId,doc:doc2}})).catch(defaultsTo({docId}))})))})).catch(defaultsTo([]))}))}())}();await queue2.finish();view.seq=currentSeq;view.sourceDB.activeTasks.remove(taskId)}catch(error){view.sourceDB.activeTasks.remove(taskId,error)}}(view,opts)}))()}function queryView(view,opts){return sequentialize(getQueue(view),(function(){return async function queryViewInQueue(view,opts){let totalRows;const shouldReduce=view.reduceFun&&false!==opts.reduce,skip=opts.skip||0;if("undefined"!=typeof opts.keys&&!opts.keys.length){opts.limit=0;delete opts.keys}async function fetchFromView(viewOpts){viewOpts.include_docs=true;const res2=await view.db.allDocs(viewOpts);totalRows=res2.total_rows;return res2.rows.map((function(result){if("value"in result.doc&&"object"==typeof result.doc.value&&null!==result.doc.value){const keys2=Object.keys(result.doc.value).sort(),expectedKeys=["id","key","value"];if(!(keys2<expectedKeys||keys2>expectedKeys))return result.doc.value}const parsedKeyAndDocId=parseIndexableString(result.doc._id);return{key:parsedKeyAndDocId[0],id:parsedKeyAndDocId[1],value:"value"in result.doc?result.doc.value:null}}))}async function onMapResultsReady(rows){let finalResults;if(shouldReduce)finalResults=function reduceView(view,results,options){if(0===options.group_level)delete options.group_level;const shouldGroup=options.group||options.group_level,reduceFun=reducer3(view.reduceFun),groups=[],lvl=isNaN(options.group_level)?Number.POSITIVE_INFINITY:options.group_level;for(const result of results){const last=groups[groups.length-1];let groupKey=shouldGroup?result.key:null;if(shouldGroup&&Array.isArray(groupKey))groupKey=groupKey.slice(0,lvl);if(!last||0!==collate(last.groupKey,groupKey))groups.push({keys:[[result.key,result.id]],values:[result.value],groupKey});else{last.keys.push([result.key,result.id]);last.values.push(result.value)}}results=[];for(const group of groups){const reduceTry=tryReduce(view.sourceDB,reduceFun,group.keys,group.values,false);if(reduceTry.error&&reduceTry.error instanceof BuiltInError)throw reduceTry.error;results.push({value:reduceTry.error?null:reduceTry.output,key:group.groupKey})}return{rows:sliceResults(results,options.limit,options.skip)}}(view,rows,opts);else if("undefined"==typeof opts.keys)finalResults={total_rows:totalRows,offset:skip,rows};else finalResults={total_rows:totalRows,offset:skip,rows:sliceResults(rows,opts.limit,opts.skip)};if(opts.update_seq)finalResults.update_seq=view.seq;if(opts.include_docs){const docIds=uniq(rows.map(rowToDocId)),allDocsRes=await view.sourceDB.allDocs({keys:docIds,include_docs:true,conflicts:opts.conflicts,attachments:opts.attachments,binary:opts.binary}),docIdsToDocs=new Map;for(const row of allDocsRes.rows)docIdsToDocs.set(row.id,row.doc);for(const row of rows){const docId=rowToDocId(row),doc=docIdsToDocs.get(docId);if(doc)row.doc=doc}}return finalResults}if("undefined"!=typeof opts.keys){const fetchPromises=opts.keys.map((function(key2){const viewOpts={startkey:toIndexableString([key2]),endkey:toIndexableString([key2,{}])};if(opts.update_seq)viewOpts.update_seq=true;return fetchFromView(viewOpts)}));return onMapResultsReady((await Promise.all(fetchPromises)).flat())}else{const viewOpts={descending:opts.descending};if(opts.update_seq)viewOpts.update_seq=true;let startkey,endkey;if("start_key"in opts)startkey=opts.start_key;if("startkey"in opts)startkey=opts.startkey;if("end_key"in opts)endkey=opts.end_key;if("endkey"in opts)endkey=opts.endkey;if("undefined"!=typeof startkey)viewOpts.startkey=opts.descending?toIndexableString([startkey,{}]):toIndexableString([startkey]);if("undefined"!=typeof endkey){let inclusiveEnd=false!==opts.inclusive_end;if(opts.descending)inclusiveEnd=!inclusiveEnd;viewOpts.endkey=toIndexableString(inclusiveEnd?[endkey,{}]:[endkey])}if("undefined"!=typeof opts.key){const keyStart=toIndexableString([opts.key]),keyEnd=toIndexableString([opts.key,{}]);if(viewOpts.descending){viewOpts.endkey=keyStart;viewOpts.startkey=keyEnd}else{viewOpts.startkey=keyStart;viewOpts.endkey=keyEnd}}if(!shouldReduce){if("number"==typeof opts.limit)viewOpts.limit=opts.limit;viewOpts.skip=skip}return onMapResultsReady(await fetchFromView(viewOpts))}}(view,opts)}))()}return{query:function abstractQuery(fun,opts,callback){const db=this;if("function"==typeof opts){callback=opts;opts={}}opts=opts?function coerceOptions(opts){opts.group_level=coerceInteger(opts.group_level);opts.limit=coerceInteger(opts.limit);opts.skip=coerceInteger(opts.skip);return opts}(opts):{};if("function"==typeof fun)fun={map:fun};const promise2=Promise.resolve().then((function(){return async function queryPromised(db,fun,opts){if("function"==typeof db._query)return function customQuery(db,fun,opts){return new Promise((function(resolve,reject){db._query(fun,opts,(function(err2,res2){if(err2)return reject(err2);resolve(res2)}))}))}(db,fun,opts);if(isRemote(db))return async function httpQuery(db,fun,opts){let body,ok,params=[],method="GET";addHttpParam("reduce",opts,params);addHttpParam("include_docs",opts,params);addHttpParam("attachments",opts,params);addHttpParam("limit",opts,params);addHttpParam("descending",opts,params);addHttpParam("group",opts,params);addHttpParam("group_level",opts,params);addHttpParam("skip",opts,params);addHttpParam("stale",opts,params);addHttpParam("conflicts",opts,params);addHttpParam("startkey",opts,params,true);addHttpParam("start_key",opts,params,true);addHttpParam("endkey",opts,params,true);addHttpParam("end_key",opts,params,true);addHttpParam("inclusive_end",opts,params);addHttpParam("key",opts,params,true);addHttpParam("update_seq",opts,params);params=params.join("&");params=""===params?"":"?"+params;if("undefined"!=typeof opts.keys){const MAX_URL_LENGTH=2e3,keysAsString=`keys=${encodeURIComponent(JSON.stringify(opts.keys))}`;if(keysAsString.length+params.length+1<=MAX_URL_LENGTH)params+=("?"===params[0]?"&":"?")+keysAsString;else{method="POST";if("string"==typeof fun)body={keys:opts.keys};else fun.keys=opts.keys}}if("string"==typeof fun){const parts=parseViewName(fun),response2=await db.fetch("_design/"+parts[0]+"/_view/"+parts[1]+params,{headers:new h2({"Content-Type":"application/json"}),method,body:JSON.stringify(body)});ok=response2.ok;const result2=await response2.json();if(!ok){result2.status=response2.status;throw generateErrorFromResponse(result2)}for(const row of result2.rows)if(row.value&&row.value.error&&"builtin_reduce_error"===row.value.error)throw new Error(row.reason);return new Promise((function(resolve){resolve(result2)})).then(postprocessAttachments(opts))}body=body||{};for(const key2 of Object.keys(fun))if(Array.isArray(fun[key2]))body[key2]=fun[key2];else body[key2]=fun[key2].toString();const response=await db.fetch("_temp_view"+params,{headers:new h2({"Content-Type":"application/json"}),method:"POST",body:JSON.stringify(body)});ok=response.ok;const result=await response.json();if(!ok){result.status=response.status;throw generateErrorFromResponse(result)}return new Promise((function(resolve){resolve(result)})).then(postprocessAttachments(opts))}(db,fun,opts);const updateViewOpts={changes_batch_size:db.__opts.view_update_changes_batch_size||CHANGES_BATCH_SIZE2};if("string"!=typeof fun){checkQueryParseError(opts,fun);tempViewQueue.add((async function(){const view=await createView(db,"temp_view/temp_view",fun.map,fun.reduce,true,localDocName2);return fin(updateView(view,updateViewOpts).then((function(){return queryView(view,opts)})),(function(){return view.db.destroy()}))}));return tempViewQueue.finish()}else{const fullViewName=fun,parts=parseViewName(fullViewName),designDocName=parts[0],viewName=parts[1],doc=await db.get("_design/"+designDocName);if(!(fun=doc.views&&doc.views[viewName]))throw new NotFoundError(`ddoc ${doc._id} has no view named ${viewName}`);ddocValidator3(doc,viewName);checkQueryParseError(opts,fun);const view=await createView(db,fullViewName,fun.map,fun.reduce,false,localDocName2);if("ok"===opts.stale||"update_after"===opts.stale){if("update_after"===opts.stale)nextTick((function(){updateView(view,updateViewOpts)}));return queryView(view,opts)}else{await updateView(view,updateViewOpts);return queryView(view,opts)}}}(db,fun,opts)}));promisedCallback(promise2,callback);return promise2},viewCleanup:callbackify((function(){const db=this;if("function"==typeof db._viewCleanup)return function customViewCleanup(db){return new Promise((function(resolve,reject){db._viewCleanup((function(err2,res2){if(err2)return reject(err2);resolve(res2)}))}))}(db);if(isRemote(db))return async function httpViewCleanup(db){return(await db.fetch("_view_cleanup",{headers:new h2({"Content-Type":"application/json"}),method:"POST"})).json()}(db);else return async function localViewCleanup(db){try{const metaDoc=await db.get("_local/"+localDocName2),docsToViews=new Map;for(const fullViewName of Object.keys(metaDoc.views)){const parts=parseViewName(fullViewName),designDocName="_design/"+parts[0],viewName=parts[1];let views=docsToViews.get(designDocName);if(!views){views=new Set;docsToViews.set(designDocName,views)}views.add(viewName)}const opts={keys:mapToKeysArray(docsToViews),include_docs:true},res2=await db.allDocs(opts),viewsToStatus={};for(const row of res2.rows){const ddocName=row.key.substring(8);for(const viewName of docsToViews.get(row.key)){let fullViewName=ddocName+"/"+viewName;if(!metaDoc.views[fullViewName])fullViewName=viewName;const viewDBNames=Object.keys(metaDoc.views[fullViewName]),statusIsGood=row.doc&&row.doc.views&&row.doc.views[viewName];for(const viewDBName of viewDBNames)viewsToStatus[viewDBName]=viewsToStatus[viewDBName]||statusIsGood}}const destroyPromises=Object.keys(viewsToStatus).filter((function(viewDBName){return!viewsToStatus[viewDBName]})).map((function(viewDBName){return sequentialize(getQueue(viewDBName),(function(){return new db.constructor(viewDBName,db.__opts).destroy()}))()}));return Promise.all(destroyPromises).then((function(){return{ok:true}}))}catch(err2){if(404===err2.status)return{ok:true};else throw err2}}(db)}))}}var index_es_default5=createAbstractMapReduce;function createBuiltInError(name){return new BuiltInError("builtin "+name+" function requires map values to be numbers or number arrays")}function sum(values){for(var result=0,i2=0,len=values.length;i2<len;i2++){var num=values[i2];if("number"!=typeof num)if(Array.isArray(num)){result="number"==typeof result?[result]:result;for(var j2=0,jLen=num.length;j2<jLen;j2++){var jNum=num[j2];if("number"!=typeof jNum)throw createBuiltInError("_sum");else if("undefined"==typeof result[j2])result.push(jNum);else result[j2]+=jNum}}else throw createBuiltInError("_sum");else if("number"==typeof result)result+=num;else result[0]+=num}return result}var log=guardedConsole.bind(null,"log"),isArray=Array.isArray,toJSON=JSON.parse;function evalFunctionWithEval(func,emit2){return scopeEval("return ("+func.replace(/;\s*$/,"")+");",{emit:emit2,sum,log,isArray,toJSON})}var builtInReduce={_sum:function(keys2,values){return sum(values)},_count:function(keys2,values){return values.length},_stats:function(keys2,values){return{sum:sum(values),min:Math.min.apply(null,values),max:Math.max.apply(null,values),count:values.length,sumsqr:function sumsqr(values2){for(var _sumsqr=0,i2=0,len=values2.length;i2<len;i2++){var num=values2[i2];_sumsqr+=num*num}return _sumsqr}(values)}}};function getBuiltIn(reduceFunString){if(/^_sum/.test(reduceFunString))return builtInReduce._sum;else if(/^_count/.test(reduceFunString))return builtInReduce._count;else if(/^_stats/.test(reduceFunString))return builtInReduce._stats;else if(/^_/.test(reduceFunString))throw new Error(reduceFunString+" is not a supported reduce function.")}function mapper(mapFun,emit2){if("function"==typeof mapFun&&2===mapFun.length){var origMap=mapFun;return function(doc){return origMap(doc,emit2)}}else return evalFunctionWithEval(mapFun.toString(),emit2)}function reducer(reduceFun){var reduceFunString=reduceFun.toString(),builtIn=getBuiltIn(reduceFunString);if(builtIn)return builtIn;else return evalFunctionWithEval(reduceFunString)}function ddocValidator(ddoc,viewName){var fun=ddoc.views&&ddoc.views[viewName];if("string"!=typeof fun.map)throw new NotFoundError("ddoc "+ddoc._id+" has no string view named "+viewName+", instead found object of type: "+typeof fun.map)}var localDocName="mrviews",abstract=index_es_default5(localDocName,mapper,reducer,ddocValidator);function query2(fun,opts,callback){return abstract.query.call(this,fun,opts,callback)}function viewCleanup2(callback){return abstract.viewCleanup.call(this,callback)}var index4={query:query2,viewCleanup:viewCleanup2},index_browser_es_default2=index4,CHECKPOINT_VERSION=1,REPLICATOR="pouchdb",CHECKPOINT_HISTORY_SIZE=5,LOWEST_SEQ=0;function updateCheckpoint(db,id,checkpoint,session,returnValue){return db.get(id).catch((function(err2){if(404===err2.status){if("http"===db.adapter||"https"===db.adapter)explainError(404,"PouchDB is just checking if a remote checkpoint exists.");return{session_id:session,_id:id,history:[],replicator:REPLICATOR,version:CHECKPOINT_VERSION}}throw err2})).then((function(doc){if(!returnValue.cancelled)if(doc.last_seq!==checkpoint){doc.history=(doc.history||[]).filter((function(item){return item.session_id!==session}));doc.history.unshift({last_seq:checkpoint,session_id:session});doc.history=doc.history.slice(0,CHECKPOINT_HISTORY_SIZE);doc.version=CHECKPOINT_VERSION;doc.replicator=REPLICATOR;doc.session_id=session;doc.last_seq=checkpoint;return db.put(doc).catch((function(err2){if(409===err2.status)return updateCheckpoint(db,id,checkpoint,session,returnValue);throw err2}))}}))}var CheckpointerInternal=class{constructor(src,target,id,returnValue,opts={writeSourceCheckpoint:true,writeTargetCheckpoint:true}){this.src=src;this.target=target;this.id=id;this.returnValue=returnValue;this.opts=opts;if("undefined"==typeof opts.writeSourceCheckpoint)opts.writeSourceCheckpoint=true;if("undefined"==typeof opts.writeTargetCheckpoint)opts.writeTargetCheckpoint=true}writeCheckpoint(checkpoint,session){var self3=this;return this.updateTarget(checkpoint,session).then((function(){return self3.updateSource(checkpoint,session)}))}updateTarget(checkpoint,session){if(this.opts.writeTargetCheckpoint)return updateCheckpoint(this.target,this.id,checkpoint,session,this.returnValue);else return Promise.resolve(true)}updateSource(checkpoint,session){if(this.opts.writeSourceCheckpoint){var self3=this;return updateCheckpoint(this.src,this.id,checkpoint,session,this.returnValue).catch((function(err2){if(isForbiddenError(err2)){self3.opts.writeSourceCheckpoint=false;return true}throw err2}))}else return Promise.resolve(true)}getCheckpoint(){var self3=this;if(!self3.opts.writeSourceCheckpoint&&!self3.opts.writeTargetCheckpoint)return Promise.resolve(LOWEST_SEQ);if(self3.opts&&self3.opts.writeSourceCheckpoint&&!self3.opts.writeTargetCheckpoint)return self3.src.get(self3.id).then((function(sourceDoc){return sourceDoc.last_seq||LOWEST_SEQ})).catch((function(err2){if(404!==err2.status)throw err2;return LOWEST_SEQ}));else return self3.target.get(self3.id).then((function(targetDoc){if(self3.opts&&self3.opts.writeTargetCheckpoint&&!self3.opts.writeSourceCheckpoint)return targetDoc.last_seq||LOWEST_SEQ;else return self3.src.get(self3.id).then((function(sourceDoc){if(targetDoc.version!==sourceDoc.version)return LOWEST_SEQ;var version2;if(targetDoc.version)version2=targetDoc.version.toString();else version2="undefined";if(version2 in comparisons)return comparisons[version2](targetDoc,sourceDoc);else return LOWEST_SEQ}),(function(err2){if(404===err2.status&&targetDoc.last_seq)return self3.src.put({_id:self3.id,last_seq:LOWEST_SEQ}).then((function(){return LOWEST_SEQ}),(function(err3){if(isForbiddenError(err3)){self3.opts.writeSourceCheckpoint=false;return targetDoc.last_seq}return LOWEST_SEQ}));throw err2}))})).catch((function(err2){if(404!==err2.status)throw err2;return LOWEST_SEQ}))}},comparisons={undefined:function(targetDoc,sourceDoc){if(0===collate(targetDoc.last_seq,sourceDoc.last_seq))return sourceDoc.last_seq;else return 0},1:function(targetDoc,sourceDoc){return compareReplicationLogs(sourceDoc,targetDoc).last_seq}};function compareReplicationLogs(srcDoc,tgtDoc){if(srcDoc.session_id===tgtDoc.session_id)return{last_seq:srcDoc.last_seq,history:srcDoc.history};else return compareReplicationHistory(srcDoc.history,tgtDoc.history)}function compareReplicationHistory(sourceHistory,targetHistory){var S2=sourceHistory[0],sourceRest=sourceHistory.slice(1),T2=targetHistory[0],targetRest=targetHistory.slice(1);if(!S2||0===targetHistory.length)return{last_seq:LOWEST_SEQ,history:[]};if(hasSessionId(S2.session_id,targetHistory))return{last_seq:S2.last_seq,history:sourceHistory};if(hasSessionId(T2.session_id,sourceRest))return{last_seq:T2.last_seq,history:targetRest};else return compareReplicationHistory(sourceRest,targetRest)}function hasSessionId(sessionId,history){var props=history[0],rest=history.slice(1);if(!sessionId||0===history.length)return false;if(sessionId===props.session_id)return true;else return hasSessionId(sessionId,rest)}function isForbiddenError(err2){return"number"==typeof err2.status&&4===Math.floor(err2.status/100)}function Checkpointer(src,target,id,returnValue,opts){if(!(this instanceof CheckpointerInternal))return new CheckpointerInternal(src,target,id,returnValue,opts);else return Checkpointer}var index_es_default6=Checkpointer,import_spark_md55=__toESM(require_spark_md5()),setImmediateShim5=self.setImmediate||self.setTimeout,MD5_CHUNK_SIZE5=32768;function rawToBase645(raw){return thisBtoa(raw)}function appendBlob5(buffer,blob,start,end,callback){if(start>0||end<blob.size)blob=blob.slice(start,end);readAsArrayBuffer(blob,(function(arrayBuffer){buffer.append(arrayBuffer);callback()}))}function appendString5(buffer,string,start,end,callback){if(start>0||end<string.length)string=string.substring(start,end);buffer.appendBinary(string);callback()}function binaryMd55(data,callback){var inputIsString="string"==typeof data,len=inputIsString?data.length:data.size,chunkSize=Math.min(MD5_CHUNK_SIZE5,len),chunks=Math.ceil(len/chunkSize),currentChunk=0,buffer=inputIsString?new import_spark_md55.default:new import_spark_md55.default.ArrayBuffer,append2=inputIsString?appendString5:appendBlob5;function next(){setImmediateShim5(loadNextChunk)}function done(){var base64=rawToBase645(buffer.end(true));callback(base64);buffer.destroy()}function loadNextChunk(){var start=currentChunk*chunkSize,end=start+chunkSize;if(++currentChunk<chunks)append2(buffer,data,start,end,next);else append2(buffer,data,start,end,done)}loadNextChunk()}function stringMd55(string){return import_spark_md55.default.hash(string)}function sortObjectPropertiesByKey(queryParams){return Object.keys(queryParams).sort(collate).reduce((function(result,key2){result[key2]=queryParams[key2];return result}),{})}function generateReplicationId(src,target,opts){var docIds=opts.doc_ids?opts.doc_ids.sort(collate):"",filterFun=opts.filter?opts.filter.toString():"",queryParams="",filterViewName="",selector="";if(opts.selector)selector=JSON.stringify(opts.selector);if(opts.filter&&opts.query_params)queryParams=JSON.stringify(sortObjectPropertiesByKey(opts.query_params));if(opts.filter&&"_view"===opts.filter)filterViewName=opts.view.toString();return Promise.all([src.id(),target.id()]).then((function(res2){var queryData=res2[0]+res2[1]+filterFun+filterViewName+queryParams+docIds+selector;return new Promise((function(resolve){binaryMd55(queryData,resolve)}))})).then((function(md5sum){return"_local/"+md5sum.replace(/\//g,".").replace(/\+/g,"_")}))}var index_es_default7=generateReplicationId,import_events15=__toESM(require_events());function fileHasChanged(localDoc,remoteDoc,filename){return!localDoc._attachments||!localDoc._attachments[filename]||localDoc._attachments[filename].digest!==remoteDoc._attachments[filename].digest}function getDocAttachments(db,doc){var filenames=Object.keys(doc._attachments);return Promise.all(filenames.map((function(filename){return db.getAttachment(doc._id,filename,{rev:doc._rev})})))}function getDocAttachmentsFromTargetOrSource(target,src,doc){var doCheckForLocalAttachments=isRemote(src)&&!isRemote(target),filenames=Object.keys(doc._attachments);if(!doCheckForLocalAttachments)return getDocAttachments(src,doc);else return target.get(doc._id).then((function(localDoc){return Promise.all(filenames.map((function(filename){if(fileHasChanged(localDoc,doc,filename))return src.getAttachment(doc._id,filename);else return target.getAttachment(localDoc._id,filename)})))})).catch((function(error){if(404!==error.status)throw error;return getDocAttachments(src,doc)}))}function createBulkGetOpts(diffs){var requests=[];Object.keys(diffs).forEach((function(id){diffs[id].missing.forEach((function(missingRev){requests.push({id,rev:missingRev})}))}));return{docs:requests,revs:true,latest:true}}function getDocs(src,target,diffs,state){diffs=clone(diffs);var resultDocs=[],ok=true;return Promise.resolve().then((function getAllDocs(){var bulkGetOpts=createBulkGetOpts(diffs);if(bulkGetOpts.docs.length)return src.bulkGet(bulkGetOpts).then((function(bulkGetResponse){if(state.cancelled)throw new Error("cancelled");return Promise.all(bulkGetResponse.results.map((function(bulkGetInfo){return Promise.all(bulkGetInfo.docs.map((function(doc){var remoteDoc=doc.ok;if(doc.error)ok=false;if(!remoteDoc||!remoteDoc._attachments)return remoteDoc;else return getDocAttachmentsFromTargetOrSource(target,src,remoteDoc).then((attachments=>{var filenames=Object.keys(remoteDoc._attachments);attachments.forEach((function(attachment,i2){var att=remoteDoc._attachments[filenames[i2]];delete att.stub;delete att.length;att.data=attachment}));return remoteDoc}))})))}))).then((function(results){resultDocs=resultDocs.concat(results.flat().filter(Boolean))}))}))})).then((function returnResult(){return{ok,docs:resultDocs}}))}var STARTING_BACK_OFF=0;function backOff(opts,returnValue,error,callback){if(false!==opts.retry){if("function"!=typeof opts.back_off_function)opts.back_off_function=defaultBackOff;returnValue.emit("requestError",error);if("active"===returnValue.state||"pending"===returnValue.state){returnValue.emit("paused",error);returnValue.state="stopped";var backOffSet=function backoffTimeSet(){opts.current_back_off=STARTING_BACK_OFF};returnValue.once("paused",(function removeBackOffTimeSet(){returnValue.removeListener("active",backOffSet)}));returnValue.once("active",backOffSet)}opts.current_back_off=opts.current_back_off||STARTING_BACK_OFF;opts.current_back_off=opts.back_off_function(opts.current_back_off);setTimeout(callback,opts.current_back_off)}else{returnValue.emit("error",error);returnValue.removeAllListeners()}}function replicate(src,target,opts,returnValue,result){var currentBatch,repId,checkpointer,taskId,batches=[],pendingBatch={seq:0,changes:[],docs:[]},writingCheckpoint=false,changesCompleted=false,replicationCompleted=false,initial_last_seq=0,last_seq=0,continuous=opts.continuous||opts.live||false,batch_size=opts.batch_size||100,batches_limit=opts.batches_limit||10,style=opts.style||"all_docs",changesPending=false,doc_ids=opts.doc_ids,selector=opts.selector,changedDocs=[],session=uuid();result=result||{ok:true,start_time:(new Date).toISOString(),docs_read:0,docs_written:0,doc_write_failures:0,errors:[]};var changesOpts={};returnValue.ready(src,target);function initCheckpointer(){if(checkpointer)return Promise.resolve();else return index_es_default7(src,target,opts).then((function(res2){repId=res2;var checkpointOpts={};if(false===opts.checkpoint)checkpointOpts={writeSourceCheckpoint:false,writeTargetCheckpoint:false};else if("source"===opts.checkpoint)checkpointOpts={writeSourceCheckpoint:true,writeTargetCheckpoint:false};else if("target"===opts.checkpoint)checkpointOpts={writeSourceCheckpoint:false,writeTargetCheckpoint:true};else checkpointOpts={writeSourceCheckpoint:true,writeTargetCheckpoint:true};checkpointer=new index_es_default6(src,target,repId,returnValue,checkpointOpts)}))}function writeDocs(){changedDocs=[];if(0!==currentBatch.docs.length){var docs=currentBatch.docs,bulkOpts={timeout:opts.timeout};return target.bulkDocs({docs,new_edits:false},bulkOpts).then((function(res2){if(returnValue.cancelled){completeReplication();throw new Error("cancelled")}var errorsById=Object.create(null);res2.forEach((function(res3){if(res3.error)errorsById[res3.id]=res3}));var errorsNo=Object.keys(errorsById).length;result.doc_write_failures+=errorsNo;result.docs_written+=docs.length-errorsNo;docs.forEach((function(doc){var error=errorsById[doc._id];if(error){result.errors.push(error);var errorName=(error.name||"").toLowerCase();if("unauthorized"===errorName||"forbidden"===errorName)returnValue.emit("denied",clone(error));else throw error}else changedDocs.push(doc)}))}),(function(err2){result.doc_write_failures+=docs.length;throw err2}))}}function finishBatch(){if(currentBatch.error)throw new Error("There was a problem getting docs.");result.last_seq=last_seq=currentBatch.seq;var outResult=clone(result);if(changedDocs.length){outResult.docs=changedDocs;if("number"==typeof currentBatch.pending){outResult.pending=currentBatch.pending;delete currentBatch.pending}returnValue.emit("change",outResult)}writingCheckpoint=true;src.info().then((function(info3){var task=src.activeTasks.get(taskId);if(currentBatch&&task){var completed=task.completed_items||0,total_items=parseInt(info3.update_seq,10)-parseInt(initial_last_seq,10);src.activeTasks.update(taskId,{completed_items:completed+currentBatch.changes.length,total_items})}}));return checkpointer.writeCheckpoint(currentBatch.seq,session).then((function(){returnValue.emit("checkpoint",{checkpoint:currentBatch.seq});writingCheckpoint=false;if(returnValue.cancelled){completeReplication();throw new Error("cancelled")}currentBatch=void 0;getChanges()})).catch((function(err2){onCheckpointError(err2);throw err2}))}function getBatchDocs(){return getDocs(src,target,currentBatch.diffs,returnValue).then((function(got){currentBatch.error=!got.ok;got.docs.forEach((function(doc){delete currentBatch.diffs[doc._id];result.docs_read++;currentBatch.docs.push(doc)}))}))}function startNextBatch(){if(!returnValue.cancelled&&!currentBatch)if(0!==batches.length){currentBatch=batches.shift();returnValue.emit("checkpoint",{start_next_batch:currentBatch.seq});(function getDiffs(){var diff={};currentBatch.changes.forEach((function(change){returnValue.emit("checkpoint",{revs_diff:change});if("_user/"!==change.id)diff[change.id]=change.changes.map((function(x2){return x2.rev}))}));return target.revsDiff(diff).then((function(diffs){if(returnValue.cancelled){completeReplication();throw new Error("cancelled")}currentBatch.diffs=diffs}))})().then(getBatchDocs).then(writeDocs).then(finishBatch).then(startNextBatch).catch((function(err2){abortReplication("batch processing terminated with error",err2)}))}else processPendingBatch(true)}function processPendingBatch(immediate){if(0!==pendingBatch.changes.length){if(immediate||changesCompleted||pendingBatch.changes.length>=batch_size){batches.push(pendingBatch);pendingBatch={seq:0,changes:[],docs:[]};if("pending"===returnValue.state||"stopped"===returnValue.state){returnValue.state="active";returnValue.emit("active")}startNextBatch()}}else if(0===batches.length&&!currentBatch){if(continuous&&changesOpts.live||changesCompleted){returnValue.state="pending";returnValue.emit("paused")}if(changesCompleted)completeReplication()}}function abortReplication(reason,err2){if(!replicationCompleted){if(!err2.message)err2.message=reason;result.ok=false;result.status="aborting";batches=[];pendingBatch={seq:0,changes:[],docs:[]};completeReplication(err2)}}function completeReplication(fatalError){if(!replicationCompleted){if(returnValue.cancelled){result.status="cancelled";if(writingCheckpoint)return}result.status=result.status||"complete";result.end_time=(new Date).toISOString();result.last_seq=last_seq;replicationCompleted=true;src.activeTasks.remove(taskId,fatalError);if(fatalError){(fatalError=createError(fatalError)).result=result;var errorName=(fatalError.name||"").toLowerCase();if("unauthorized"===errorName||"forbidden"===errorName){returnValue.emit("error",fatalError);returnValue.removeAllListeners()}else backOff(opts,returnValue,fatalError,(function(){replicate(src,target,opts,returnValue)}))}else{returnValue.emit("complete",result);returnValue.removeAllListeners()}}}function onChange(change,pending,lastSeq){if(returnValue.cancelled)return completeReplication();if("number"==typeof pending)pendingBatch.pending=pending;if(filterChange(opts)(change)){pendingBatch.seq=change.seq||lastSeq;pendingBatch.changes.push(change);returnValue.emit("checkpoint",{pending_batch:pendingBatch.seq});nextTick((function(){processPendingBatch(0===batches.length&&changesOpts.live)}))}else{var task=src.activeTasks.get(taskId);if(task){var completed=task.completed_items||0;src.activeTasks.update(taskId,{completed_items:++completed})}}}function onChangesComplete(changes3){changesPending=false;if(returnValue.cancelled)return completeReplication();if(changes3.results.length>0){changesOpts.since=changes3.results[changes3.results.length-1].seq;getChanges();processPendingBatch(true)}else{var complete=function(){if(continuous){changesOpts.live=true;getChanges()}else changesCompleted=true;processPendingBatch(true)};if(!currentBatch&&0===changes3.results.length){writingCheckpoint=true;checkpointer.writeCheckpoint(changes3.last_seq,session).then((function(){writingCheckpoint=false;result.last_seq=last_seq=changes3.last_seq;if(returnValue.cancelled){completeReplication();throw new Error("cancelled")}else complete()})).catch(onCheckpointError)}else complete()}}function onChangesError(err2){changesPending=false;if(returnValue.cancelled)return completeReplication();abortReplication("changes rejected",err2)}function getChanges(){if(!changesPending&&!changesCompleted&&batches.length<batches_limit){changesPending=true;if(returnValue._changes){returnValue.removeListener("cancel",returnValue._abortChanges);returnValue._changes.cancel()}returnValue.once("cancel",abortChanges);var changes3=src.changes(changesOpts).on("change",onChange);changes3.then(removeListener,removeListener);changes3.then(onChangesComplete).catch(onChangesError);if(opts.retry){returnValue._changes=changes3;returnValue._abortChanges=abortChanges}}function abortChanges(){changes3.cancel()}function removeListener(){returnValue.removeListener("cancel",abortChanges)}}function createTask(checkpoint){return src.info().then((function(info3){var total_items="undefined"==typeof opts.since?parseInt(info3.update_seq,10)-parseInt(checkpoint,10):parseInt(info3.update_seq,10);taskId=src.activeTasks.add({name:`${continuous?"continuous ":""}replication from ${info3.db_name}`,total_items});return checkpoint}))}function startChanges(){initCheckpointer().then((function(){if(!returnValue.cancelled)return checkpointer.getCheckpoint().then(createTask).then((function(checkpoint){initial_last_seq=checkpoint;changesOpts={since:last_seq=checkpoint,limit:batch_size,batch_size,style,doc_ids,selector,return_docs:true};if(opts.filter)if("string"!=typeof opts.filter)changesOpts.include_docs=true;else changesOpts.filter=opts.filter;if("heartbeat"in opts)changesOpts.heartbeat=opts.heartbeat;if("timeout"in opts)changesOpts.timeout=opts.timeout;if(opts.query_params)changesOpts.query_params=opts.query_params;if(opts.view)changesOpts.view=opts.view;getChanges()}));else completeReplication()})).catch((function(err2){abortReplication("getCheckpoint rejected with ",err2)}))}function onCheckpointError(err2){writingCheckpoint=false;abortReplication("writeCheckpoint completed with error",err2)}if(!returnValue.cancelled){if(!returnValue._addedListeners){returnValue.once("cancel",completeReplication);if("function"==typeof opts.complete){returnValue.once("error",opts.complete);returnValue.once("complete",(function(result2){opts.complete(null,result2)}))}returnValue._addedListeners=true}if("undefined"==typeof opts.since)startChanges();else initCheckpointer().then((function(){writingCheckpoint=true;return checkpointer.writeCheckpoint(opts.since,session)})).then((function(){writingCheckpoint=false;if(!returnValue.cancelled){last_seq=opts.since;startChanges()}else completeReplication()})).catch(onCheckpointError)}else completeReplication()}var Replication=class extends import_events15.default{constructor(){super();this.cancelled=false;this.state="pending";const promise2=new Promise(((fulfill,reject)=>{this.once("complete",fulfill);this.once("error",reject)}));this.then=function(resolve,reject){return promise2.then(resolve,reject)};this.catch=function(reject){return promise2.catch(reject)};this.catch((function(){}))}cancel(){this.cancelled=true;this.state="cancelled";this.emit("cancel")}ready(src,target){if(this._readyCalled)return;this._readyCalled=true;const onDestroy2=()=>{this.cancel()};src.once("destroyed",onDestroy2);target.once("destroyed",onDestroy2);function cleanup(){src.removeListener("destroyed",onDestroy2);target.removeListener("destroyed",onDestroy2)}this.once("complete",cleanup);this.once("error",cleanup)}};function toPouch(db,opts){var PouchConstructor=opts.PouchConstructor;if("string"==typeof db)return new PouchConstructor(db,opts);else return db}function replicateWrapper(src,target,opts,callback){if("function"==typeof opts){callback=opts;opts={}}if("undefined"==typeof opts)opts={};if(opts.doc_ids&&!Array.isArray(opts.doc_ids))throw createError(BAD_REQUEST,"`doc_ids` filter parameter is not a list.");opts.complete=callback;(opts=clone(opts)).continuous=opts.continuous||opts.live;opts.retry="retry"in opts?opts.retry:false;opts.PouchConstructor=opts.PouchConstructor||this;var replicateRet=new Replication(opts);replicate(toPouch(src,opts),toPouch(target,opts),opts,replicateRet);return replicateRet}function sync(src,target,opts,callback){if("function"==typeof opts){callback=opts;opts={}}if("undefined"==typeof opts)opts={};(opts=clone(opts)).PouchConstructor=opts.PouchConstructor||this;src=toPouch(src,opts);target=toPouch(target,opts);return new Sync(src,target,opts,callback)}var Sync=class extends import_events15.default{constructor(src,target,opts,callback){super();this.canceled=false;const optsPush=opts.push?Object.assign({},opts,opts.push):opts,optsPull=opts.pull?Object.assign({},opts,opts.pull):opts;this.push=replicateWrapper(src,target,optsPush);this.pull=replicateWrapper(target,src,optsPull);this.pushPaused=true;this.pullPaused=true;const pullChange=change=>{this.emit("change",{direction:"pull",change})},pushChange=change=>{this.emit("change",{direction:"push",change})},pushDenied=doc=>{this.emit("denied",{direction:"push",doc})},pullDenied=doc=>{this.emit("denied",{direction:"pull",doc})},pushPaused=()=>{this.pushPaused=true;if(this.pullPaused)this.emit("paused")},pullPaused=()=>{this.pullPaused=true;if(this.pushPaused)this.emit("paused")},pushActive=()=>{this.pushPaused=false;if(this.pullPaused)this.emit("active",{direction:"push"})},pullActive=()=>{this.pullPaused=false;if(this.pushPaused)this.emit("active",{direction:"pull"})};let removed={};const removeAll=type=>(event,func)=>{if("change"===event&&(func===pullChange||func===pushChange)||"denied"===event&&(func===pullDenied||func===pushDenied)||"paused"===event&&(func===pullPaused||func===pushPaused)||"active"===event&&(func===pullActive||func===pushActive)){if(!(event in removed))removed[event]={};removed[event][type]=true;if(2===Object.keys(removed[event]).length)this.removeAllListeners(event)}};if(opts.live){this.push.on("complete",this.pull.cancel.bind(this.pull));this.pull.on("complete",this.push.cancel.bind(this.push))}function addOneListener(ee,event,listener){if(-1==ee.listeners(event).indexOf(listener))ee.on(event,listener)}this.on("newListener",(function(event){if("change"===event){addOneListener(this.pull,"change",pullChange);addOneListener(this.push,"change",pushChange)}else if("denied"===event){addOneListener(this.pull,"denied",pullDenied);addOneListener(this.push,"denied",pushDenied)}else if("active"===event){addOneListener(this.pull,"active",pullActive);addOneListener(this.push,"active",pushActive)}else if("paused"===event){addOneListener(this.pull,"paused",pullPaused);addOneListener(this.push,"paused",pushPaused)}}));this.on("removeListener",(function(event){if("change"===event){this.pull.removeListener("change",pullChange);this.push.removeListener("change",pushChange)}else if("denied"===event){this.pull.removeListener("denied",pullDenied);this.push.removeListener("denied",pushDenied)}else if("active"===event){this.pull.removeListener("active",pullActive);this.push.removeListener("active",pushActive)}else if("paused"===event){this.pull.removeListener("paused",pullPaused);this.push.removeListener("paused",pushPaused)}}));this.pull.on("removeListener",removeAll("pull"));this.push.on("removeListener",removeAll("push"));const promise2=Promise.all([this.push,this.pull]).then((resp=>{const out={push:resp[0],pull:resp[1]};this.emit("complete",out);if(callback)callback(null,out);this.removeAllListeners();return out}),(err2=>{this.cancel();if(callback)callback(err2);else this.emit("error",err2);this.removeAllListeners();if(callback)throw err2}));this.then=function(success,err2){return promise2.then(success,err2)};this.catch=function(err2){return promise2.catch(err2)}}cancel(){if(!this.canceled){this.canceled=true;this.push.cancel();this.pull.cancel()}}};function replication(PouchDB2){PouchDB2.replicate=replicateWrapper;PouchDB2.sync=sync;Object.defineProperty(PouchDB2.prototype,"replicate",{get:function(){var self3=this;if("undefined"==typeof this.replicateMethods)this.replicateMethods={from:function(other,opts,callback){return self3.constructor.replicate(other,self3,opts,callback)},to:function(other,opts,callback){return self3.constructor.replicate(self3,other,opts,callback)}};return this.replicateMethods}});PouchDB2.prototype.sync=function(dbName,opts,callback){return this.constructor.sync(this,dbName,opts,callback)}}var index_es_default8=replication,import_spark_md56=__toESM(require_spark_md5()),setImmediateShim6=self.setImmediate||self.setTimeout,MD5_CHUNK_SIZE6=32768;function rawToBase646(raw){return thisBtoa(raw)}function appendBlob6(buffer,blob,start,end,callback){if(start>0||end<blob.size)blob=blob.slice(start,end);readAsArrayBuffer(blob,(function(arrayBuffer){buffer.append(arrayBuffer);callback()}))}function appendString6(buffer,string,start,end,callback){if(start>0||end<string.length)string=string.substring(start,end);buffer.appendBinary(string);callback()}function binaryMd56(data,callback){var inputIsString="string"==typeof data,len=inputIsString?data.length:data.size,chunkSize=Math.min(MD5_CHUNK_SIZE6,len),chunks=Math.ceil(len/chunkSize),currentChunk=0,buffer=inputIsString?new import_spark_md56.default:new import_spark_md56.default.ArrayBuffer,append2=inputIsString?appendString6:appendBlob6;function next(){setImmediateShim6(loadNextChunk)}function done(){var base64=rawToBase646(buffer.end(true));callback(base64);buffer.destroy()}function loadNextChunk(){var start=currentChunk*chunkSize,end=start+chunkSize;if(++currentChunk<chunks)append2(buffer,data,start,end,next);else append2(buffer,data,start,end,done)}loadNextChunk()}function stringMd56(string){return import_spark_md56.default.hash(string)}var nativeFlat=(...args)=>args.flat(1/0),polyFlat=(...args)=>{let res2=[];for(const subArr of args)if(Array.isArray(subArr))res2=res2.concat(polyFlat(...subArr));else res2.push(subArr);return res2},flatten="function"==typeof Array.prototype.flat?nativeFlat:polyFlat;function mergeObjects(arr){const res2={};for(const element2 of arr)Object.assign(res2,element2);return res2}function pick2(obj,arr){const res2={};for(const field of arr){const parsedField=parseField(field),value=getFieldFromDoc(obj,parsedField);if("undefined"!=typeof value)setFieldInDoc(res2,parsedField,value)}return res2}function oneArrayIsSubArrayOfOther(left,right){for(let i2=0,len=Math.min(left.length,right.length);i2<len;i2++)if(left[i2]!==right[i2])return false;return true}function oneArrayIsStrictSubArrayOfOther(left,right){if(left.length>right.length)return false;else return oneArrayIsSubArrayOfOther(left,right)}function oneSetIsSubArrayOfOther(left,right){left=left.slice();for(const field of right){if(!left.length)break;const leftIdx=left.indexOf(field);if(-1===leftIdx)return false;else left.splice(leftIdx,1)}return true}function arrayToObject(arr){const res2={};for(const field of arr)res2[field]=true;return res2}function max2(arr,fun){let max3=null,maxScore=-1;for(const element2 of arr){const score=fun(element2);if(score>maxScore){maxScore=score;max3=element2}}return max3}function arrayEquals(arr1,arr2){if(arr1.length!==arr2.length)return false;for(let i2=0,len=arr1.length;i2<len;i2++)if(arr1[i2]!==arr2[i2])return false;return true}function uniq2(arr){return Array.from(new Set(arr))}function resolveToCallback(fun){return function(...args){const maybeCallback=args[args.length-1];if("function"==typeof maybeCallback){const fulfilled=maybeCallback.bind(null,null),rejected=maybeCallback.bind(null);fun.apply(this,args.slice(0,-1)).then(fulfilled,rejected)}else return fun.apply(this,args)}}function massageCreateIndexRequest(requestDef){if(!(requestDef=clone(requestDef)).index)requestDef.index={};for(const key2 of["type","name","ddoc"])if(requestDef.index[key2]){requestDef[key2]=requestDef.index[key2];delete requestDef.index[key2]}if(requestDef.fields){requestDef.index.fields=requestDef.fields;delete requestDef.fields}if(!requestDef.type)requestDef.type="json";return requestDef}function isNonNullObject(value){return"object"==typeof value&&null!==value}function checkFieldValueType(name,value,isHttp){let message="",received=value,addReceived=true;if(-1!==["$in","$nin","$or","$and","$mod","$nor","$all"].indexOf(name))if(!Array.isArray(value))message="Query operator "+name+" must be an array.";if(-1!==["$not","$elemMatch","$allMatch"].indexOf(name))if(!(!Array.isArray(value)&&isNonNullObject(value)))message="Query operator "+name+" must be an object.";if("$mod"===name&&Array.isArray(value))if(2!==value.length)message="Query operator $mod must be in the format [divisor, remainder], where divisor and remainder are both integers.";else{const divisor=value[0],mod=value[1];if(0===divisor){message="Query operator $mod's divisor cannot be 0, cannot divide by zero.";addReceived=false}if("number"!=typeof divisor||parseInt(divisor,10)!==divisor){message="Query operator $mod's divisor is not an integer.";received=divisor}if(parseInt(mod,10)!==mod){message="Query operator $mod's remainder is not an integer.";received=mod}}if("$exists"===name)if("boolean"!=typeof value)message="Query operator $exists must be a boolean.";if("$type"===name){const allowed=["null","boolean","number","string","array","object"],allowedStr='"'+allowed.slice(0,allowed.length-1).join('", "')+'", or "'+allowed[allowed.length-1]+'"';if("string"!=typeof value)message="Query operator $type must be a string. Supported values: "+allowedStr+".";else if(-1==allowed.indexOf(value))message="Query operator $type must be a string. Supported values: "+allowedStr+"."}if("$size"===name)if(parseInt(value,10)!==value)message="Query operator $size must be a integer.";if("$regex"===name)if("string"!=typeof value)if(isHttp)message="Query operator $regex must be a string.";else if(!(value instanceof RegExp))message="Query operator $regex must be a string or an instance of a javascript regular expression.";if(message){if(addReceived)message+=" Received"+(null===received?" ":Array.isArray(received)?" array":" "+typeof received)+": "+(isNonNullObject(received)?JSON.stringify(received,null,"\t"):received);throw new Error(message)}}var requireValidation=["$all","$allMatch","$and","$elemMatch","$exists","$in","$mod","$nin","$nor","$not","$or","$regex","$size","$type"],arrayTypeComparisonOperators=["$in","$nin","$mod","$all"],equalityOperators=["$eq","$gt","$gte","$lt","$lte"];function validateSelector(input,isHttp){if(Array.isArray(input)){for(const entry of input)if(isNonNullObject(entry))validateSelector(entry,isHttp)}else for(const[key2,value]of Object.entries(input)){if(-1!==requireValidation.indexOf(key2))checkFieldValueType(key2,value,isHttp);if(-1===equalityOperators.indexOf(key2))if(-1===arrayTypeComparisonOperators.indexOf(key2))if(isNonNullObject(value))validateSelector(value,isHttp)}}async function dbFetch(db,path2,opts){if(opts.body){opts.body=JSON.stringify(opts.body);opts.headers=new h2({"Content-type":"application/json"})}const response=await db.fetch(path2,opts),json=await response.json();if(!response.ok){json.status=response.status;throw generateErrorFromResponse(createError(json))}return json}async function createIndex(db,requestDef){return await dbFetch(db,"_index",{method:"POST",body:massageCreateIndexRequest(requestDef)})}async function find(db,requestDef){validateSelector(requestDef.selector,true);return await dbFetch(db,"_find",{method:"POST",body:requestDef})}async function explain(db,requestDef){return await dbFetch(db,"_explain",{method:"POST",body:requestDef})}async function getIndexes(db){return await dbFetch(db,"_index",{method:"GET"})}async function deleteIndex(db,indexDef){const ddoc=indexDef.ddoc,type=indexDef.type||"json",name=indexDef.name;if(!ddoc)throw new Error("you must provide an index's ddoc");if(!name)throw new Error("you must provide an index's name");const url="_index/"+[ddoc,type,name].map(encodeURIComponent).join("/");return await dbFetch(db,url,{method:"DELETE"})}function getDeepValue(value,path2){for(const key2 of path2)if(void 0===(value=value[key2]))return;return value}function createDeepMultiMapper(fields,emit2,selector){return function(doc){if(selector&&!matchesSelector(doc,selector))return;const toEmit=[];for(const field of fields){const value=getDeepValue(doc,parseField(field));if(void 0===value)return;toEmit.push(value)}emit2(toEmit)}}function createDeepSingleMapper(field,emit2,selector){const parsedField=parseField(field);return function(doc){if(selector&&!matchesSelector(doc,selector))return;const value=getDeepValue(doc,parsedField);if(void 0!==value)emit2(value)}}function createShallowSingleMapper(field,emit2,selector){return function(doc){if(!selector||matchesSelector(doc,selector))emit2(doc[field])}}function createShallowMultiMapper(fields,emit2,selector){return function(doc){if(selector&&!matchesSelector(doc,selector))return;const toEmit=fields.map((field=>doc[field]));emit2(toEmit)}}function checkShallow(fields){return fields.every((field=>-1===field.indexOf(".")))}function createMapper(fields,emit2,selector){const isShallow=checkShallow(fields),isSingle=1===fields.length;if(isShallow)if(isSingle)return createShallowSingleMapper(fields[0],emit2,selector);else return createShallowMultiMapper(fields,emit2,selector);else if(isSingle)return createDeepSingleMapper(fields[0],emit2,selector);else return createDeepMultiMapper(fields,emit2,selector)}function mapper2(mapFunDef,emit2){return createMapper(Object.keys(mapFunDef.fields),emit2,mapFunDef.partial_filter_selector)}function reducer2(){throw new Error("reduce not supported")}function ddocValidator2(ddoc,viewName){const view=ddoc.views[viewName];if(!view.map||!view.map.fields)throw new Error("ddoc "+ddoc._id+" with view "+viewName+" doesn't have map.fields defined. maybe it wasn't created by this plugin?")}var abstractMapper=index_es_default5("indexes",mapper2,reducer2,ddocValidator2);function abstractMapper$1(db){if(db._customFindAbstractMapper)return{query:function addQueryFallback(signature,opts){const fallback=abstractMapper.query.bind(this);return db._customFindAbstractMapper.query.call(this,signature,opts,fallback)},viewCleanup:function addViewCleanupFallback(){const fallback=abstractMapper.viewCleanup.bind(this);return db._customFindAbstractMapper.viewCleanup.call(this,fallback)}};else return abstractMapper}function massageSort(sort){if(!Array.isArray(sort))throw new Error("invalid sort json - should be an array");return sort.map((function(sorting){if("string"==typeof sorting){const obj={};obj[sorting]="asc";return obj}else return sorting}))}var ddocIdPrefix=/^_design\//;function massageUseIndex(useIndex){let cleanedUseIndex=[];if("string"==typeof useIndex)cleanedUseIndex.push(useIndex);else cleanedUseIndex=useIndex;return cleanedUseIndex.map((function(name){return name.replace(ddocIdPrefix,"")}))}function massageIndexDef(indexDef){indexDef.fields=indexDef.fields.map((function(field){if("string"==typeof field){const obj={};obj[field]="asc";return obj}return field}));if(indexDef.partial_filter_selector)indexDef.partial_filter_selector=massageSelector(indexDef.partial_filter_selector);return indexDef}function getKeyFromDoc(doc,index5){return index5.def.fields.map((obj=>{const field=getKey2(obj);return getFieldFromDoc(doc,parseField(field))}))}function filterInclusiveStart(rows,targetValue,index5){const indexFields=index5.def.fields;let startAt=0;for(const row of rows){let docKey=getKeyFromDoc(row.doc,index5);if(1===indexFields.length)docKey=docKey[0];else for(;docKey.length>targetValue.length;)docKey.pop();if(Math.abs(collate(docKey,targetValue))>0)break;++startAt}return startAt>0?rows.slice(startAt):rows}function reverseOptions(opts){const newOpts=clone(opts);delete newOpts.startkey;delete newOpts.endkey;delete newOpts.inclusive_start;delete newOpts.inclusive_end;if("endkey"in opts)newOpts.startkey=opts.endkey;if("startkey"in opts)newOpts.endkey=opts.startkey;if("inclusive_start"in opts)newOpts.inclusive_end=opts.inclusive_start;if("inclusive_end"in opts)newOpts.inclusive_start=opts.inclusive_end;return newOpts}function validateIndex(index5){const ascFields=index5.fields.filter((function(field){return"asc"===getValue(field)}));if(0!==ascFields.length&&ascFields.length!==index5.fields.length)throw new Error("unsupported mixed sorting")}function validateSort(requestDef,index5){if(index5.defaultUsed&&requestDef.sort){const noneIdSorts=requestDef.sort.filter((function(sortItem){return"_id"!==Object.keys(sortItem)[0]})).map((function(sortItem){return Object.keys(sortItem)[0]}));if(noneIdSorts.length>0)throw new Error('Cannot sort on field(s) "'+noneIdSorts.join(",")+'" when using the default index')}if(!index5.defaultUsed);}function validateFindRequest(requestDef){if("object"!=typeof requestDef.selector)throw new Error("you must provide a selector when you find()")}function getUserFields(selector,sort){const selectorFields=Object.keys(selector),sortFields=sort?sort.map(getKey2):[];let userFields;if(selectorFields.length>=sortFields.length)userFields=selectorFields;else userFields=sortFields;if(0===sortFields.length)return{fields:userFields};userFields=userFields.sort((function(left,right){let leftIdx=sortFields.indexOf(left);if(-1===leftIdx)leftIdx=Number.MAX_VALUE;let rightIdx=sortFields.indexOf(right);if(-1===rightIdx)rightIdx=Number.MAX_VALUE;return leftIdx<rightIdx?-1:leftIdx>rightIdx?1:0}));return{fields:userFields,sortOrder:sort.map(getKey2)}}async function createIndex$1(db,requestDef){const originalIndexDef=clone((requestDef=massageCreateIndexRequest(requestDef)).index);requestDef.index=massageIndexDef(requestDef.index);validateIndex(requestDef.index);let md5;function getMd5(){return md5||(md5=stringMd56(JSON.stringify(requestDef)))}const viewName=requestDef.name||"idx-"+getMd5(),ddocName=requestDef.ddoc||"idx-"+getMd5(),ddocId="_design/"+ddocName;let hasInvalidLanguage=false,viewExists=false;db.constructor.emit("debug",["find","creating index",ddocId]);await upsert(db,ddocId,(function updateDdoc(doc){if(doc._rev&&"query"!==doc.language)hasInvalidLanguage=true;doc.language="query";doc.views=doc.views||{};viewExists=!!doc.views[viewName];if(viewExists)return false;doc.views[viewName]={map:{fields:mergeObjects(requestDef.index.fields),partial_filter_selector:requestDef.index.partial_filter_selector},reduce:"_count",options:{def:originalIndexDef}};return doc}));if(hasInvalidLanguage)throw new Error('invalid language for ddoc with id "'+ddocId+'" (should be "query")');const signature=ddocName+"/"+viewName;await abstractMapper$1(db).query.call(db,signature,{limit:0,reduce:false});return{id:ddocId,name:viewName,result:viewExists?"exists":"created"}}async function getIndexes$1(db){const allDocsRes=await db.allDocs({startkey:"_design/",endkey:"_design/",include_docs:true}),res2={indexes:[{ddoc:null,name:"_all_docs",type:"special",def:{fields:[{_id:"asc"}]}}]};res2.indexes=flatten(res2.indexes,allDocsRes.rows.filter((function(row){return"query"===row.doc.language})).map((function(row){return(void 0!==row.doc.views?Object.keys(row.doc.views):[]).map((function(viewName){const view=row.doc.views[viewName];return{ddoc:row.id,name:viewName,type:"json",def:massageIndexDef(view.options.def)}}))})));res2.indexes.sort((function(left,right){return compare(left.name,right.name)}));res2.total_rows=res2.indexes.length;return res2}var COLLATE_LO=null,COLLATE_HI={"":{}},SHORT_CIRCUIT_QUERY={queryOpts:{limit:0,startkey:COLLATE_HI,endkey:COLLATE_LO},inMemoryFields:[]};function checkFieldInIndex(index5,field){return index5.def.fields.some((key2=>getKey2(key2)===field))}function userOperatorLosesPrecision(selector,field){return"$eq"!==getKey2(selector[field])}function sortFieldsByIndex(userFields,index5){const indexFields=index5.def.fields.map(getKey2);return userFields.slice().sort((function(a2,b3){let aIdx=indexFields.indexOf(a2),bIdx=indexFields.indexOf(b3);if(-1===aIdx)aIdx=Number.MAX_VALUE;if(-1===bIdx)bIdx=Number.MAX_VALUE;return compare(aIdx,bIdx)}))}function getBasicInMemoryFields(index5,selector,userFields){let needToFilterInMemory=false;for(let i2=0,len=(userFields=sortFieldsByIndex(userFields,index5)).length;i2<len;i2++){const field=userFields[i2];if(needToFilterInMemory||!checkFieldInIndex(index5,field))return userFields.slice(i2);if(i2<len-1&&userOperatorLosesPrecision(selector,field))needToFilterInMemory=true}return[]}function getInMemoryFieldsFromNe(selector){const fields=[];for(const[field,matcher]of Object.entries(selector))for(const operator of Object.keys(matcher))if("$ne"===operator)fields.push(field);return fields}function getInMemoryFields(coreInMemoryFields,index5,selector,userFields){return sortFieldsByIndex(uniq2(flatten(coreInMemoryFields,getBasicInMemoryFields(index5,selector,userFields),getInMemoryFieldsFromNe(selector))),index5)}function checkIndexFieldsMatch(indexFields,sortOrder,fields){if(sortOrder){const sortMatches=oneArrayIsStrictSubArrayOfOther(sortOrder,indexFields),selectorMatches=oneArrayIsSubArrayOfOther(fields,indexFields);return sortMatches&&selectorMatches}return oneSetIsSubArrayOfOther(fields,indexFields)}var logicalMatchers=["$eq","$gt","$gte","$lt","$lte"];function isNonLogicalMatcher(matcher){return-1===logicalMatchers.indexOf(matcher)}function checkFieldsLogicallySound(indexFields,selector){const matcher=selector[indexFields[0]];if("undefined"==typeof matcher)return true;else return!(1===Object.keys(matcher).length&&"$ne"===getKey2(matcher))}function checkIndexMatches(index5,sortOrder,fields,selector){const indexFields=index5.def.fields.map(getKey2);if(!checkIndexFieldsMatch(indexFields,sortOrder,fields))return false;else return checkFieldsLogicallySound(indexFields,selector)}function findMatchingIndexes(selector,userFields,sortOrder,indexes2){return indexes2.filter((function(index5){return checkIndexMatches(index5,sortOrder,userFields,selector)}))}function findBestMatchingIndex(selector,userFields,sortOrder,indexes2,useIndex){const matchingIndexes=findMatchingIndexes(selector,userFields,sortOrder,indexes2);if(0===matchingIndexes.length){if(useIndex)throw{error:"no_usable_index",message:"There is no index available for this selector."};const defaultIndex=indexes2[0];defaultIndex.defaultUsed=true;return defaultIndex}if(1===matchingIndexes.length&&!useIndex)return matchingIndexes[0];const userFieldsMap=arrayToObject(userFields);if(useIndex){const useIndexDdoc="_design/"+useIndex[0],useIndexName=2===useIndex.length?useIndex[1]:false,index5=matchingIndexes.find((function(index6){if(useIndexName&&index6.ddoc===useIndexDdoc&&useIndexName===index6.name)return true;if(index6.ddoc===useIndexDdoc)return true;else return false}));if(!index5)throw{error:"unknown_error",message:"Could not find that index or could not use that index for the query"};return index5}return max2(matchingIndexes,(function scoreIndex(index5){const indexFields=index5.def.fields.map(getKey2);let score=0;for(const indexField of indexFields)if(userFieldsMap[indexField])score++;return score}))}function getSingleFieldQueryOptsFor(userOperator,userValue){switch(userOperator){case"$eq":return{key:userValue};case"$lte":return{endkey:userValue};case"$gte":return{startkey:userValue};case"$lt":return{endkey:userValue,inclusive_end:false};case"$gt":return{startkey:userValue,inclusive_start:false}}return{startkey:COLLATE_LO}}function getSingleFieldCoreQueryPlan(selector,index5){const field=getKey2(index5.def.fields[0]),matcher=selector[field]||{},inMemoryFields=[],userOperators=Object.keys(matcher);let combinedOpts;for(const userOperator of userOperators){if(isNonLogicalMatcher(userOperator))inMemoryFields.push(field);const newQueryOpts=getSingleFieldQueryOptsFor(userOperator,matcher[userOperator]);if(combinedOpts)combinedOpts=mergeObjects([combinedOpts,newQueryOpts]);else combinedOpts=newQueryOpts}return{queryOpts:combinedOpts,inMemoryFields}}function getMultiFieldCoreQueryPlan(userOperator,userValue){switch(userOperator){case"$eq":return{startkey:userValue,endkey:userValue};case"$lte":return{endkey:userValue};case"$gte":return{startkey:userValue};case"$lt":return{endkey:userValue,inclusive_end:false};case"$gt":return{startkey:userValue,inclusive_start:false}}}function getMultiFieldQueryOpts(selector,index5){const indexFields=index5.def.fields.map(getKey2);let inMemoryFields=[];const startkey=[],endkey=[];let inclusiveStart,inclusiveEnd;function finish(i2){if(false!==inclusiveStart)startkey.push(COLLATE_LO);if(false!==inclusiveEnd)endkey.push(COLLATE_HI);inMemoryFields=indexFields.slice(i2)}for(let i2=0,len=indexFields.length;i2<len;i2++){const matcher=selector[indexFields[i2]];if(!matcher||!Object.keys(matcher).length){finish(i2);break}else if(Object.keys(matcher).some(isNonLogicalMatcher)){finish(i2);break}else if(i2>0){const usingGtlt="$gt"in matcher||"$gte"in matcher||"$lt"in matcher||"$lte"in matcher,previousKeys=Object.keys(selector[indexFields[i2-1]]),previousWasEq=arrayEquals(previousKeys,["$eq"]),previousWasSame=arrayEquals(previousKeys,Object.keys(matcher));if(usingGtlt&&!previousWasEq&&!previousWasSame){finish(i2);break}}const userOperators=Object.keys(matcher);let combinedOpts=null;for(const userOperator of userOperators){const newOpts=getMultiFieldCoreQueryPlan(userOperator,matcher[userOperator]);if(combinedOpts)combinedOpts=mergeObjects([combinedOpts,newOpts]);else combinedOpts=newOpts}startkey.push("startkey"in combinedOpts?combinedOpts.startkey:COLLATE_LO);endkey.push("endkey"in combinedOpts?combinedOpts.endkey:COLLATE_HI);if("inclusive_start"in combinedOpts)inclusiveStart=combinedOpts.inclusive_start;if("inclusive_end"in combinedOpts)inclusiveEnd=combinedOpts.inclusive_end}const res2={startkey,endkey};if("undefined"!=typeof inclusiveStart)res2.inclusive_start=inclusiveStart;if("undefined"!=typeof inclusiveEnd)res2.inclusive_end=inclusiveEnd;return{queryOpts:res2,inMemoryFields}}function shouldShortCircuit(selector){return Object.keys(selector).map((function(key2){return selector[key2]})).some((function(val2){return"object"==typeof val2&&0===Object.keys(val2).length}))}function getDefaultQueryPlan(selector){return{queryOpts:{startkey:null},inMemoryFields:[Object.keys(selector)]}}function getCoreQueryPlan(selector,index5){if(index5.defaultUsed)return getDefaultQueryPlan(selector,index5);if(1===index5.def.fields.length)return getSingleFieldCoreQueryPlan(selector,index5);else return getMultiFieldQueryOpts(selector,index5)}function planQuery(request2,indexes2){const selector=request2.selector,sort=request2.sort;if(shouldShortCircuit(selector))return Object.assign({},SHORT_CIRCUIT_QUERY,{index:indexes2[0]});const userFieldsRes=getUserFields(selector,sort),userFields=userFieldsRes.fields,index5=findBestMatchingIndex(selector,userFields,userFieldsRes.sortOrder,indexes2,request2.use_index),coreQueryPlan=getCoreQueryPlan(selector,index5);return{queryOpts:coreQueryPlan.queryOpts,index:index5,inMemoryFields:getInMemoryFields(coreQueryPlan.inMemoryFields,index5,selector,userFields)}}function indexToSignature(index5){return index5.ddoc.substring(8)+"/"+index5.name}async function doAllDocs(db,originalOpts){const opts=clone(originalOpts);if(opts.descending){if("endkey"in opts&&"string"!=typeof opts.endkey)opts.endkey="";if("startkey"in opts&&"string"!=typeof opts.startkey)opts.limit=0}else{if("startkey"in opts&&"string"!=typeof opts.startkey)opts.startkey="";if("endkey"in opts&&"string"!=typeof opts.endkey)opts.limit=0}if("key"in opts&&"string"!=typeof opts.key)opts.limit=0;if(opts.limit>0&&opts.indexes_count){opts.original_limit=opts.limit;opts.limit+=opts.indexes_count}const res2=await db.allDocs(opts);res2.rows=res2.rows.filter((function(row){return!/^_design\//.test(row.id)}));if(opts.original_limit)opts.limit=opts.original_limit;res2.rows=res2.rows.slice(0,opts.limit);return res2}async function queryAllOrIndex(db,opts,indexToUse){if("_all_docs"===indexToUse.name)return doAllDocs(db,opts);else return abstractMapper$1(db).query.call(db,indexToSignature(indexToUse),opts)}async function find$1(db,requestDef,explain2){if(requestDef.selector){validateSelector(requestDef.selector,false);requestDef.selector=massageSelector(requestDef.selector)}if(requestDef.sort)requestDef.sort=massageSort(requestDef.sort);if(requestDef.use_index)requestDef.use_index=massageUseIndex(requestDef.use_index);if(!("limit"in requestDef))requestDef.limit=25;validateFindRequest(requestDef);const getIndexesRes=await getIndexes$1(db);db.constructor.emit("debug",["find","planning query",requestDef]);const queryPlan=planQuery(requestDef,getIndexesRes.indexes);db.constructor.emit("debug",["find","query plan",queryPlan]);const indexToUse=queryPlan.index;validateSort(requestDef,indexToUse);let opts=Object.assign({include_docs:true,reduce:false,indexes_count:getIndexesRes.total_rows},queryPlan.queryOpts);if("startkey"in opts&&"endkey"in opts&&collate(opts.startkey,opts.endkey)>0)return{docs:[]};if(requestDef.sort&&"string"!=typeof requestDef.sort[0]&&"desc"===getValue(requestDef.sort[0])){opts.descending=true;opts=reverseOptions(opts)}if(!queryPlan.inMemoryFields.length){opts.limit=requestDef.limit;if("skip"in requestDef)opts.skip=requestDef.skip}if(explain2)return Promise.resolve(queryPlan,opts);const res2=await queryAllOrIndex(db,opts,indexToUse);if(false===opts.inclusive_start)res2.rows=filterInclusiveStart(res2.rows,opts.startkey,indexToUse);if(queryPlan.inMemoryFields.length)res2.rows=filterInMemoryFields(res2.rows,requestDef,queryPlan.inMemoryFields);const resp={docs:res2.rows.map((function(row){const doc=row.doc;if(requestDef.fields)return pick2(doc,requestDef.fields);else return doc}))};if(indexToUse.defaultUsed)resp.warning="No matching index found, create an index to optimize query time.";return resp}async function explain$1(db,requestDef){const queryPlan=await find$1(db,requestDef,true);return{dbname:db.name,index:queryPlan.index,selector:requestDef.selector,range:{start_key:queryPlan.queryOpts.startkey,end_key:queryPlan.queryOpts.endkey},opts:{use_index:requestDef.use_index||[],bookmark:"nil",limit:requestDef.limit,skip:requestDef.skip,sort:requestDef.sort||{},fields:requestDef.fields,conflicts:false,r:[49]},limit:requestDef.limit,skip:requestDef.skip||0,fields:requestDef.fields}}async function deleteIndex$1(db,index5){if(!index5.ddoc)throw new Error("you must supply an index.ddoc when deleting");if(!index5.name)throw new Error("you must supply an index.name when deleting");const docId=index5.ddoc,viewName=index5.name;await upsert(db,docId,(function deltaFun(doc){if(1===Object.keys(doc.views).length&&doc.views[viewName])return{_id:docId,_deleted:true};delete doc.views[viewName];return doc}));await abstractMapper$1(db).viewCleanup.apply(db);return{ok:true}}var plugin2={};plugin2.createIndex=resolveToCallback((async function(requestDef){if("object"!=typeof requestDef)throw new Error("you must provide an index to create");return(isRemote(this)?createIndex:createIndex$1)(this,requestDef)}));plugin2.find=resolveToCallback((async function(requestDef){if("object"!=typeof requestDef)throw new Error("you must provide search parameters to find()");return(isRemote(this)?find:find$1)(this,requestDef)}));plugin2.explain=resolveToCallback((async function(requestDef){if("object"!=typeof requestDef)throw new Error("you must provide search parameters to explain()");return(isRemote(this)?explain:explain$1)(this,requestDef)}));plugin2.getIndexes=resolveToCallback((async function(){return(isRemote(this)?getIndexes:getIndexes$1)(this)}));plugin2.deleteIndex=resolveToCallback((async function(indexDef){if("object"!=typeof indexDef)throw new Error("you must provide an index to delete");return(isRemote(this)?deleteIndex:deleteIndex$1)(this,indexDef)}));var index_browser_es_default3=plugin2,import_transform_pouch=__toESM(require_transform_pouch(),1);index_es_default.plugin(index_es_default2).plugin(index_es_default3).plugin(index_es_default4).plugin(index_browser_es_default2).plugin(index_es_default8).plugin(index_browser_es_default3).plugin(import_transform_pouch.default);function appendPurgeSeqs(db,docs){return db.get("_local/purges").then((function(doc){for(const[docId,rev$$1]of docs){const purgeSeq=doc.purgeSeq+1;doc.purges.push({docId,rev:rev$$1,purgeSeq});if(doc.purges.length>db.purged_infos_limit)doc.purges.splice(0,doc.purges.length-db.purged_infos_limit);doc.purgeSeq=purgeSeq}return doc})).catch((function(err2){if(404!==err2.status)throw err2;return{_id:"_local/purges",purges:docs.map((([docId,rev$$1],idx2)=>({docId,rev:rev$$1,purgeSeq:idx2}))),purgeSeq:docs.length}})).then((function(doc){return db.put(doc)}))}index_es_default.prototype.purgeMulti=adapterFun("_purgeMulti",(function(docs,callback){if("undefined"==typeof this._purge)return callback(createError(UNKNOWN_ERROR,"Purge is not implemented in the "+this.adapter+" adapter."));const self3=this,tasks4=docs.map((param=>()=>new Promise(((res2,rej)=>{const[docId,rev$$1]=param;self3._getRevisionTree(docId,((error,revs)=>{if(error)return res2([param,error]);if(!revs)return res2([param,createError(MISSING_DOC)]);let path2;try{path2=findPathToLeaf(revs,rev$$1)}catch(error2){return res2([param,error2.message||error2])}self3._purge(docId,path2,((error2,result)=>{if(error2)return res2([param,error2]);else return res2([param,result])}))}))}))));(async()=>{const retAll=(await mapAllTasksWithConcurrencyLimit(1,tasks4)).map((e4=>unwrapTaskResult(e4)));await appendPurgeSeqs(self3,retAll.filter((e4=>"ok"in e4[1])).map((e4=>e4[0])));return Object.fromEntries(retAll.map((e4=>[e4[0][0],e4[1]])))})().then((result=>callback(void 0,result))).catch((error=>callback(error)))}));setNoticeClass(import_obsidian.Notice);async function fetchByAPI(request2){var _a5,_b2;const ret=await(0,import_obsidian.requestUrl)(request2);if(ret.status-ret.status%100!=200){const er=new Error(`Request Error:${ret.status}`);if(ret.json){er.message=ret.json.reason;er.name=`${null!=(_a5=ret.json.error)?_a5:""}:${null!=(_b2=ret.json.message)?_b2:""}`}er.status=ret.status;throw er}return ret}var ModuleObsidianAPI=class extends AbstractObsidianModule{constructor(){super(...arguments);this.authHeaderSource=reactiveSource("");this.authHeader=reactive((()=>""==this.authHeaderSource.value?"":"Basic "+window.btoa(this.authHeaderSource.value)));this.last_successful_post=false}$$customFetchHandler(){if(!this._customHandler)this._customHandler=new ObsHttpHandler(void 0,void 0);return this._customHandler}$$getLastPostFailedBySize(){return!this.last_successful_post}async $$connectRemoteCouchDB(uri,auth,disableRequestURI,passphrase,useDynamicIterationCount,performSetup,skipInfo,compression){if(!isValidRemoteCouchDBURI(uri))return"Remote URI is not valid";if(uri.toLowerCase()!=uri)return"Remote URI and database name could not contain capital letters.";if(-1!==uri.indexOf(" "))return"Remote URI and database name could not contain spaces.";const userNameAndPassword=auth.username&&auth.password?`${auth.username}:${auth.password}`:"";if(this.authHeaderSource.value!=userNameAndPassword)this.authHeaderSource.value=userNameAndPassword;const authHeader=this.authHeader.value,db=new index_es_default(uri,{adapter:"http",auth,skip_setup:!performSetup,fetch:async(url,opts)=>{var _a5,_b2;let size="";const localURL=url.toString().substring(uri.length),method=null!=(_a5=null==opts?void 0:opts.method)?_a5:"GET";if(null==opts?void 0:opts.body){const opts_length=opts.body.toString().length;if(opts_length>1e7)if(isCloudantURI(uri)){this.last_successful_post=false;this._log("This request should fail on IBM Cloudant.",LOG_LEVEL_VERBOSE);throw new Error("This request should fail on IBM Cloudant.")}size=` (${opts_length})`}if(!disableRequestURI&&"string"==typeof url&&"string"==typeof(null!=(_b2=null==opts?void 0:opts.body)?_b2:"")){const body=null==opts?void 0:opts.body,transformedHeaders={...null==opts?void 0:opts.headers};if(""!=authHeader)transformedHeaders["authorization"]=authHeader;delete transformedHeaders["host"];delete transformedHeaders["Host"];delete transformedHeaders["content-length"];delete transformedHeaders["Content-Length"];const requestParam={url,method:null==opts?void 0:opts.method,body,headers:transformedHeaders,contentType:"application/json"};try{this.plugin.requestCount.value=this.plugin.requestCount.value+1;const r2=await fetchByAPI(requestParam);if("POST"==method||"PUT"==method)this.last_successful_post=r2.status-r2.status%100==200;else this.last_successful_post=true;this._log(`HTTP:${method}${size} to:${localURL} -> ${r2.status}`,LOG_LEVEL_DEBUG);return new Response(r2.arrayBuffer,{headers:r2.headers,status:r2.status,statusText:`${r2.status}`})}catch(ex){this._log(`HTTP:${method}${size} to:${localURL} -> failed`,LOG_LEVEL_VERBOSE);if(-1!==url.toString().indexOf("_bulk_docs"))this.last_successful_post=false;this._log(ex);throw ex}finally{this.plugin.responseCount.value=this.plugin.responseCount.value+1}}try{if(this.settings.enableDebugTools)opts.headers.append("ngrok-skip-browser-warning","123");this.plugin.requestCount.value=this.plugin.requestCount.value+1;const response=await fetch(url,opts);if("POST"==method||"PUT"==method)this.last_successful_post=response.ok;else this.last_successful_post=true;this._log(`HTTP:${method}${size} to:${localURL} -> ${response.status}`,LOG_LEVEL_DEBUG);if(2!==Math.floor(response.status/100))if("GET"!=method&&-1===localURL.indexOf("/_local/")&&!localURL.endsWith("/")){const r2=response.clone();this._log(`The request may have failed. The reason sent by the server: ${r2.status}: ${r2.statusText}`);try{this._log(await(await r2.blob()).text(),LOG_LEVEL_VERBOSE)}catch(_){this._log("Cloud not parse response",LOG_LEVEL_VERBOSE);this._log(_,LOG_LEVEL_VERBOSE)}}else this._log("Just checkpoint or some server information has been missing. The 404 error shown above is not an error.",LOG_LEVEL_VERBOSE);return response}catch(ex){this._log(`HTTP:${method}${size} to:${localURL} -> failed`,LOG_LEVEL_VERBOSE);if(-1!==url.toString().indexOf("_bulk_docs"))this.last_successful_post=false;this._log(ex);throw ex}finally{this.plugin.responseCount.value=this.plugin.responseCount.value+1}}});replicationFilter(db,compression);disableEncryption();if("false"!==passphrase&&"string"==typeof passphrase)enableEncryption(db,passphrase,useDynamicIterationCount,false);if(skipInfo)return{db,info:{db_name:"",doc_count:0,update_seq:""}};try{const info3=await db.info();return{db,info:info3}}catch(ex){let msg=`${null==ex?void 0:ex.name}:${null==ex?void 0:ex.message}`;if("TypeError"==(null==ex?void 0:ex.name)&&"Failed to fetch"==(null==ex?void 0:ex.message))msg+="\n**Note** This error caused by many reasons. The only sure thing is you didn't touch the server.\nTo check details, open inspector.";this._log(ex,LOG_LEVEL_VERBOSE);return msg}}$$isMobile(){return this.app.isMobile}$$vaultName(){return this.app.vault.getName()}$$getVaultName(){var _a5;return this.core.$$vaultName()+((null==(_a5=this.settings)?void 0:_a5.additionalSuffixOfDatabaseName)?"-"+this.settings.additionalSuffixOfDatabaseName:"")}$$getActiveFilePath(){const file=this.app.workspace.getActiveFile();if(file)return getPathFromTFile(file)}$anyGetAppId(){return Promise.resolve(`${"appId"in this.app?this.app.appId:""}`)}},ModuleObsidianEvents=class extends AbstractObsidianModule{constructor(){super(...arguments);this.hasFocus=true;this.isLastHidden=false}$everyOnloadStart(){this.plugin.registerEvent(this.app.vault.on("rename",((file,oldPath)=>{eventHub.emitEvent(EVENT_FILE_RENAMED,{newPath:file.path,old:oldPath})})));this.plugin.registerEvent(this.app.workspace.on("active-leaf-change",(()=>eventHub.emitEvent(EVENT_LEAF_ACTIVE_CHANGED))));return Promise.resolve(true)}$$performRestart(){this._performAppReload()}_performAppReload(){this.app.commands.executeCommandById("app:reload")}swapSaveCommand(){var _a5,_b2;this._log("Modifying callback of the save command",LOG_LEVEL_VERBOSE);const saveCommandDefinition=null==(_b2=null==(_a5=this.app.commands)?void 0:_a5.commands)?void 0:_b2["editor:save-file"],save=null==saveCommandDefinition?void 0:saveCommandDefinition.callback;if("function"==typeof save){this.initialCallback=save;saveCommandDefinition.callback=()=>{scheduleTask("syncOnEditorSave",250,(()=>{if(this.core.$$isUnloaded()){this._log("Unload and remove the handler.",LOG_LEVEL_VERBOSE);saveCommandDefinition.callback=this.initialCallback;this.initialCallback=void 0}else if(this.settings.syncOnEditorSave){this._log("Sync on Editor Save.",LOG_LEVEL_VERBOSE);fireAndForget((()=>this.core.$$replicate()))}}));save()}}const _this=this;window.CodeMirrorAdapter.commands.save=()=>{_this.app.commands.executeCommandById("editor:save-file")}}registerWatchEvents(){this.setHasFocus=this.setHasFocus.bind(this);this.watchWindowVisibility=this.watchWindowVisibility.bind(this);this.watchWorkspaceOpen=this.watchWorkspaceOpen.bind(this);this.watchOnline=this.watchOnline.bind(this);this.plugin.registerEvent(this.app.workspace.on("file-open",this.watchWorkspaceOpen));this.plugin.registerDomEvent(document,"visibilitychange",this.watchWindowVisibility);this.plugin.registerDomEvent(window,"focus",(()=>this.setHasFocus(true)));this.plugin.registerDomEvent(window,"blur",(()=>this.setHasFocus(false)));this.plugin.registerDomEvent(window,"online",this.watchOnline);this.plugin.registerDomEvent(window,"offline",this.watchOnline)}setHasFocus(hasFocus){this.hasFocus=hasFocus;this.watchWindowVisibility()}watchWindowVisibility(){scheduleTask("watch-window-visibility",100,(()=>fireAndForget((()=>this.watchWindowVisibilityAsync()))))}watchOnline(){scheduleTask("watch-online",500,(()=>fireAndForget((()=>this.watchOnlineAsync()))))}async watchOnlineAsync(){if(navigator.onLine&&this.localDatabase.needScanning){this.localDatabase.needScanning=false;await this.core.$$performFullScan()}}async watchWindowVisibilityAsync(){if(this.settings.suspendFileWatching)return;if(!this.settings.isConfigured)return;if(!this.core.$$isReady())return;if(this.isLastHidden&&!this.hasFocus)return;const isHidden=document.hidden;if(this.isLastHidden!==isHidden){this.isLastHidden=isHidden;await this.core.$everyCommitPendingFileEvent();if(isHidden)await this.core.$everyBeforeSuspendProcess();else{if(this.core.$$isSuspended())return;if(!this.hasFocus)return;await this.core.$everyOnResumeProcess();await this.core.$everyAfterResumeProcess()}}}watchWorkspaceOpen(file){if(!this.settings.suspendFileWatching)if(this.settings.isConfigured)if(this.core.$$isReady())if(file)scheduleTask("watch-workspace-open",500,(()=>fireAndForget((()=>this.watchWorkspaceOpenAsync(file)))))}async watchWorkspaceOpenAsync(file){if(!this.settings.suspendFileWatching)if(this.settings.isConfigured)if(this.core.$$isReady()){await this.core.$everyCommitPendingFileEvent();if(null!=file){if(this.settings.syncOnFileOpen&&!this.core.$$isSuspended())await this.core.$$replicate();await this.core.$$queueConflictCheckIfOpen(file.path)}}}$everyOnLayoutReady(){this.swapSaveCommand();this.registerWatchEvents();return Promise.resolve(true)}$$askReload(message){if(!this.core.$$isReloadingScheduled())scheduleTask("configReload",250,(async()=>{const ret=await this.core.confirm.askSelectStringDialogue(message||"Do you want to restart and reload Obsidian now?",["Yes, schedule a restart after stabilisation","Yes, restart immediately","No, Leave it to me"],{defaultAction:"No, Leave it to me"});if("Yes, restart immediately"==ret)this._performAppReload();else if("Yes, schedule a restart after stabilisation"==ret)this.core.$$scheduleAppReload()}));else this._log("Reloading is already scheduled",LOG_LEVEL_VERBOSE)}$$scheduleAppReload(){if(!this.core._totalProcessingCount){const __tick=reactiveSource(0);this.core._totalProcessingCount=reactive((()=>{const dbCount=this.core.databaseQueueCount.value,replicationCount=this.core.replicationResultCount.value,storageApplyingCount=this.core.storageApplyingCount.value,chunkCount=collectingChunks.value,pluginScanCount=pluginScanningCount.value,hiddenFilesCount=hiddenFilesEventCount.value+hiddenFilesProcessingCount.value,conflictProcessCount=this.core.conflictProcessQueueCount.value,e4=this.core.pendingFileEventCount.value,proc=this.core.processingFileEventCount.value;__tick.value;return dbCount+replicationCount+storageApplyingCount+chunkCount+pluginScanCount+hiddenFilesCount+conflictProcessCount+e4+proc}));this.plugin.registerInterval(setInterval((()=>{__tick.value++}),1e3));let stableCheck=3;this.core._totalProcessingCount.onChanged((e4=>{if(0==e4.value){if(stableCheck--<=0)this._performAppReload();this._log(`Obsidian will be restarted soon! (Within ${stableCheck} seconds)`,LOG_LEVEL_NOTICE,"restart-notice")}else stableCheck=3}))}}};function add_css6(target){append_styles(target,"svelte-1xnxxxe","label.svelte-1xnxxxe.svelte-1xnxxxe{min-width:4em;width:4em;display:inline-flex;flex-direction:row;justify-content:flex-end}ul.svelte-1xnxxxe.svelte-1xnxxxe{flex-grow:1;display:inline-flex;flex-direction:column;list-style-type:none;margin-block-start:0;margin-block-end:0;margin-inline-start:0;margin-inline-end:0;padding-inline-start:0}li.svelte-1xnxxxe.svelte-1xnxxxe{padding:var(--size-2-1) var(--size-4-1);display:inline-flex;flex-grow:1;align-items:center;justify-content:flex-end;gap:var(--size-4-2)}li.svelte-1xnxxxe input.svelte-1xnxxxe{min-width:10em}button.iconbutton.svelte-1xnxxxe.svelte-1xnxxxe{max-width:4em}")}function get_each_context6(ctx,list,i2){const child_ctx=ctx.slice();child_ctx[15]=list[i2];child_ctx[16]=list;child_ctx[17]=i2;return child_ctx}function create_each_block6(ctx){let li,label,t0,t1,input,input_class_value,t22,button,mounted,dispose,t0_value=ctx[2][ctx[17]]+"",t1_value=ctx[3][ctx[17]]+"";function input_input_handler(){ctx[8].call(input,ctx[16],ctx[17])}function click_handler(){return ctx[9](ctx[17])}return{c(){li=element("li");label=element("label");t0=text(t0_value);t1=text(t1_value);input=element("input");t22=space();button=element("button");button.textContent="";attr(label,"class","svelte-1xnxxxe");attr(input,"type","text");attr(input,"class",input_class_value=null_to_empty(ctx[2][ctx[17]])+" svelte-1xnxxxe");attr(button,"class","iconbutton svelte-1xnxxxe");attr(li,"class","svelte-1xnxxxe")},m(target,anchor){insert(target,li,anchor);append(li,label);append(label,t0);append(label,t1);append(li,input);set_input_value(input,ctx[15]);append(li,t22);append(li,button);if(!mounted){dispose=[listen(input,"input",input_input_handler),listen(button,"click",click_handler)];mounted=true}},p(new_ctx,dirty){ctx=new_ctx;if(4&dirty&&t0_value!==(t0_value=ctx[2][ctx[17]]+""))set_data(t0,t0_value);if(8&dirty&&t1_value!==(t1_value=ctx[3][ctx[17]]+""))set_data(t1,t1_value);if(4&dirty&&input_class_value!==(input_class_value=null_to_empty(ctx[2][ctx[17]])+" svelte-1xnxxxe"))attr(input,"class",input_class_value);if(1&dirty&&input.value!==ctx[15])set_input_value(input,ctx[15])},d(detaching){if(detaching)detach(li);mounted=false;run_all(dispose)}}}function create_fragment6(ctx){let ul,t0,li0,label,button0,t22,li1,button1,t32,button1_disabled_value,t4,button2,t5,button2_disabled_value,mounted,dispose,each_value=ensure_array_like(ctx[0]),each_blocks=[];for(let i2=0;i2<each_value.length;i2+=1)each_blocks[i2]=create_each_block6(get_each_context6(ctx,each_value,i2));return{c(){ul=element("ul");for(let i2=0;i2<each_blocks.length;i2+=1)each_blocks[i2].c();t0=space();li0=element("li");label=element("label");button0=element("button");button0.textContent="Add";t22=space();li1=element("li");button1=element("button");t32=text("Apply");t4=space();button2=element("button");t5=text("Revert");attr(label,"class","svelte-1xnxxxe");attr(li0,"class","svelte-1xnxxxe");button1.disabled=button1_disabled_value=ctx[3].some(ctx[11])||ctx[2].every(func_1);button2.disabled=button2_disabled_value=ctx[3].some(ctx[13])||ctx[2].every(func_3);attr(li1,"class","buttons svelte-1xnxxxe");attr(ul,"class","svelte-1xnxxxe")},m(target,anchor){insert(target,ul,anchor);for(let i2=0;i2<each_blocks.length;i2+=1)if(each_blocks[i2])each_blocks[i2].m(ul,null);append(ul,t0);append(ul,li0);append(li0,label);append(label,button0);append(ul,t22);append(ul,li1);append(li1,button1);append(button1,t32);append(li1,t4);append(li1,button2);append(button2,t5);if(!mounted){dispose=[listen(button0,"click",ctx[10]),listen(button1,"click",ctx[12]),listen(button2,"click",ctx[14])];mounted=true}},p(ctx2,[dirty]){if(45&dirty){each_value=ensure_array_like(ctx2[0]);let i2;for(i2=0;i2<each_value.length;i2+=1){const child_ctx=get_each_context6(ctx2,each_value,i2);if(each_blocks[i2])each_blocks[i2].p(child_ctx,dirty);else{each_blocks[i2]=create_each_block6(child_ctx);each_blocks[i2].c();each_blocks[i2].m(ul,t0)}}for(;i2<each_blocks.length;i2+=1)each_blocks[i2].d(1);each_blocks.length=each_value.length}if(12&dirty&&button1_disabled_value!==(button1_disabled_value=ctx2[3].some(ctx2[11])||ctx2[2].every(func_1)))button1.disabled=button1_disabled_value;if(12&dirty&&button2_disabled_value!==(button2_disabled_value=ctx2[3].some(ctx2[13])||ctx2[2].every(func_3)))button2.disabled=button2_disabled_value},i:noop2,o:noop2,d(detaching){if(detaching)detach(ul);destroy_each(each_blocks,detaching);mounted=false;run_all(dispose)}}}var CHECK_OK="",CHECK_NG="",MARK_MODIFIED=" ";function checkRegExp(pattern){if(""==pattern.trim())return"";try{new RegExp(pattern);return CHECK_OK}catch(ex){return CHECK_NG}}var func_1=e4=>""===e4,func_3=e4=>""===e4;function instance6($$self,$$props,$$invalidate){let statusName,modified,{patterns=[]}=$$props,{originals=[]}=$$props,{apply=_=>Promise.resolve()}=$$props;function revert(){$$invalidate(0,patterns=[...originals])}function remove(idx2){$$invalidate(0,patterns[idx2]="",patterns)}function add(){$$invalidate(0,patterns=[...patterns,""])}$$self.$$set=$$props2=>{if("patterns"in $$props2)$$invalidate(0,patterns=$$props2.patterns);if("originals"in $$props2)$$invalidate(7,originals=$$props2.originals);if("apply"in $$props2)$$invalidate(1,apply=$$props2.apply)};$$self.$$.update=()=>{if(1&$$self.$$.dirty)$$invalidate(3,statusName=patterns.map((e4=>checkRegExp(e4))));if(129&$$self.$$.dirty)$$invalidate(2,modified=patterns.map(((e4,i2)=>{var _a5;return e4!=(null!==(_a5=null==originals?void 0:originals[i2])&&void 0!==_a5?_a5:"")?MARK_MODIFIED:""})))};return[patterns,apply,modified,statusName,revert,remove,add,originals,function input_input_handler(each_value,idx2){each_value[idx2]=this.value;$$invalidate(0,patterns)},idx2=>remove(idx2),()=>add(),e4=>e4===CHECK_NG,()=>apply(patterns),e4=>e4===CHECK_NG,()=>revert()]}var _a4,MultipleRegExpControl=class extends SvelteComponent{constructor(options){super();init(this,options,instance6,create_fragment6,safe_not_equal,{patterns:0,originals:7,apply:1},add_css6)}},MultipleRegExpControl_default=MultipleRegExpControl,OnDialogSettingsDefault={configPassphrase:"",preset:"",syncMode:"ONEVENTS",dummy:0,deviceAndVaultName:""},AllSettingDefault={...DEFAULT_SETTINGS,...OnDialogSettingsDefault},SettingInformation={liveSync:{name:"Sync Mode"},couchDB_URI:{name:"Server URI",placeHolder:"https://........"},couchDB_USER:{name:"Username",desc:"username"},couchDB_PASSWORD:{name:"Password",desc:"password"},couchDB_DBNAME:{name:"Database Name"},passphrase:{name:"Passphrase",desc:"Encryption phassphrase. If changed, you should overwrite the server's database with the new (encrypted) files."},showStatusOnEditor:{name:"Show status inside the editor",desc:"Requires restart of Obsidian."},showOnlyIconsOnEditor:{name:"Show status as icons only"},showStatusOnStatusbar:{name:"Show status on the status bar",desc:"Requires restart of Obsidian."},lessInformationInLog:{name:"Show only notifications",desc:"Disables logging, only shows notifications. Please disable if you report an issue."},showVerboseLog:{name:"Verbose Log",desc:"Show verbose log. Please enable if you report an issue."},hashCacheMaxCount:{name:"Memory cache size (by total items)"},hashCacheMaxAmount:{name:"Memory cache size (by total characters)",desc:"(Mega chars)"},writeCredentialsForSettingSync:{name:"Write credentials in the file",desc:"(Not recommended) If set, credentials will be stored in the file."},notifyAllSettingSyncFile:{name:"Notify all setting files"},configPassphrase:{name:"Passphrase of sensitive configuration items",desc:"This passphrase will not be copied to another device. It will be set to `Default` until you configure it again."},configPassphraseStore:{name:"Encrypting sensitive configuration items"},syncOnSave:{name:"Sync on Save",desc:"Starts synchronisation when a file is saved."},syncOnEditorSave:{name:"Sync on Editor Save",desc:"When you save a file in the editor, start a sync automatically"},syncOnFileOpen:{name:"Sync on File Open",desc:"Forces the file to be synced when opened."},syncOnStart:{name:"Sync on Startup",desc:"Automatically Sync all files when opening Obsidian."},syncAfterMerge:{name:"Sync after merging file",desc:"Sync automatically after merging files"},trashInsteadDelete:{name:"Use the trash bin",desc:"Move remotely deleted files to the trash, instead of deleting."},doNotDeleteFolder:{name:"Keep empty folder",desc:"Should we keep folders that don't have any files inside?"},resolveConflictsByNewerFile:{name:"(BETA) Always overwrite with a newer file",desc:"Testing only - Resolve file conflicts by syncing newer copies of the file, this can overwrite modified files. Be Warned."},checkConflictOnlyOnOpen:{name:"Delay conflict resolution of inactive files",desc:"Should we only check for conflicts when a file is opened?"},showMergeDialogOnlyOnActive:{name:"Delay merge conflict prompt for inactive files.",desc:"Should we prompt you about conflicting files when a file is opened?"},disableMarkdownAutoMerge:{name:"Always prompt merge conflicts",desc:"Should we prompt you for every single merge, even if we can safely merge automatcially?"},writeDocumentsIfConflicted:{name:"Apply Latest Change if Conflicting",desc:"Enable this option to automatically apply the most recent change to documents even when it conflicts"},syncInternalFilesInterval:{name:"Scan hidden files periodically",desc:"Seconds, 0 to disable"},batchSave:{name:"Batch database update",desc:"Reducing the frequency with which on-disk changes are reflected into the DB"},readChunksOnline:{name:"Fetch chunks on demand",desc:"(ex. Read chunks online) If this option is enabled, LiveSync reads chunks online directly instead of replicating them locally. Increasing Custom chunk size is recommended."},syncMaxSizeInMB:{name:"Maximum file size",desc:"(MB) If this is set, changes to local and remote files that are larger than this will be skipped. If the file becomes smaller again, a newer one will be used."},useIgnoreFiles:{name:"(Beta) Use ignore files",desc:"If this is set, changes to local files which are matched by the ignore files will be skipped. Remote changes are determined using local ignore files."},ignoreFiles:{name:"Ignore files",desc:"Comma separated `.gitignore, .dockerignore`"},batch_size:{name:"Batch size",desc:"Number of changes to sync at a time. Defaults to 50. Minimum is 2."},batches_limit:{name:"Batch limit",desc:"Number of batches to process at a time. Defaults to 40. Minimum is 2. This along with batch size controls how many docs are kept in memory at a time."},useTimeouts:{name:"Use timeouts instead of heartbeats",desc:"If this option is enabled, PouchDB will hold the connection open for 60 seconds, and if no change arrives in that time, close and reopen the socket, instead of holding it open indefinitely. Useful when a proxy limits request duration but can increase resource usage."},concurrencyOfReadChunksOnline:{name:"Batch size of on-demand fetching"},minimumIntervalOfReadChunksOnline:{name:"The delay for consecutive on-demand fetches"},suspendFileWatching:{name:"Suspend file watching",desc:"Stop watching for file changes."},suspendParseReplicationResult:{name:"Suspend database reflecting",desc:"Stop reflecting database changes to storage files."},writeLogToTheFile:{name:"Write logs into the file",desc:"Warning! This will have a serious impact on performance. And the logs will not be synchronised under the default name. Please be careful with logs; they often contain your confidential information."},deleteMetadataOfDeletedFiles:{name:"Do not keep metadata of deleted files."},useIndexedDBAdapter:{name:"(Obsolete) Use an old adapter for compatibility",desc:"Before v0.17.16, we used an old adapter for the local database. Now the new adapter is preferred. However, it needs local database rebuilding. Please disable this toggle when you have enough time. If leave it enabled, also while fetching from the remote database, you will be asked to disable this.",obsolete:true},watchInternalFileChanges:{name:"Scan changes on customization sync",desc:"Do not use internal API"},doNotSuspendOnFetching:{name:"Fetch database with previous behaviour"},disableCheckingConfigMismatch:{name:"Do not check configuration mismatch before replication"},usePluginSync:{name:"Enable customization sync"},autoSweepPlugins:{name:"Scan customization automatically",desc:"Scan customization before replicating."},autoSweepPluginsPeriodic:{name:"Scan customization periodically",desc:"Scan customization every 1 minute."},notifyPluginOrSettingUpdated:{name:"Notify customized",desc:"Notify when other device has newly customized."},remoteType:{name:"Remote Type",desc:"Remote server type"},endpoint:{name:"Endpoint URL",placeHolder:"https://........"},accessKey:{name:"Access Key"},secretKey:{name:"Secret Key"},region:{name:"Region",placeHolder:"auto"},bucket:{name:"Bucket Name"},useCustomRequestHandler:{name:"Use Custom HTTP Handler",desc:"Enable this if your Object Storage doesn't support CORS"},maxChunksInEden:{name:"Maximum Incubating Chunks",desc:"The maximum number of chunks that can be incubated within the document. Chunks exceeding this number will immediately graduate to independent chunks."},maxTotalLengthInEden:{name:"Maximum Incubating Chunk Size",desc:"The maximum total size of chunks that can be incubated within the document. Chunks exceeding this size will immediately graduate to independent chunks."},maxAgeInEden:{name:"Maximum Incubation Period",desc:"The maximum duration for which chunks can be incubated within the document. Chunks exceeding this period will graduate to independent chunks."},settingSyncFile:{name:"Filename",desc:"Save settings to a markdown file. You will be notified when new settings arrive. You can set different files by the platform."},preset:{name:"Presets",desc:"Apply preset configuration"},syncMode:{name:"Sync Mode"},periodicReplicationInterval:{name:"Periodic Sync interval",desc:"Interval (sec)"},syncInternalFilesBeforeReplication:{name:"Scan for hidden files before replication"},automaticallyDeleteMetadataOfDeletedFiles:{name:"Delete old metadata of deleted files on start-up",desc:"(Days passed, 0 to disable automatic-deletion)"},additionalSuffixOfDatabaseName:{name:"Database suffix",desc:"LiveSync could not handle multiple vaults which have same name without different prefix, This should be automatically configured."},hashAlg:{name:(null==(_a4=configurationNames["hashAlg"])?void 0:_a4.name)||"",desc:"xxhash64 is the current default."},deviceAndVaultName:{name:"Device name",desc:"Unique name between all synchronized devices. To edit this setting, please disable customization sync once."},displayLanguage:{name:"Display Language",desc:'Not all messages have been translated. And, please revert to "Default" when reporting errors.'},enableChunkSplitterV2:{name:"Use splitting-limit-capped chunk splitter",desc:"If enabled, chunks will be split into no more than 100 items. However, dedupe is slightly weaker."},disableWorkerForGeneratingChunks:{name:"Do not split chunks in the background",desc:"If disabled(toggled), chunks will be split on the UI thread (Previous behaviour)."},processSmallFilesInUIThread:{name:"Process small files in the foreground",desc:"If enabled, the file under 1kb will be processed in the UI thread."},batchSaveMinimumDelay:{name:"Minimum delay for batch database updating",desc:"Seconds. Saving to the local database will be delayed until this value after we stop typing or saving."},batchSaveMaximumDelay:{name:"Maximum delay for batch database updating",desc:"Saving will be performed forcefully after this number of seconds."},notifyThresholdOfRemoteStorageSize:{name:"Notify when the estimated remote storage size exceeds on start up",desc:"MB (0 to disable)."},usePluginSyncV2:{name:"Enable per-file customization sync",desc:"If enabled, efficient per-file customization sync will be used. A minor migration is required when enabling this feature, and all devices must be updated to v0.23.18. Enabling this feature will result in losing compatibility with older versions."},handleFilenameCaseSensitive:{name:"Handle files as Case-Sensitive",desc:"If this enabled, All files are handled as case-Sensitive (Previous behaviour)."},doNotUseFixedRevisionForChunks:{name:"Compute revisions for chunks (Previous behaviour)",desc:"If this enabled, all chunks will be stored with the revision made from its content. (Previous behaviour)"},sendChunksBulkMaxSize:{name:"Maximum size of chunks to send in one request",desc:"MB"},useAdvancedMode:{name:"Enable advanced features"},usePowerUserMode:{name:"Enable poweruser features"},useEdgeCaseMode:{name:"Enable edge case treatment features"},enableDebugTools:{name:"Enable Developers' Debug Tools.",desc:"Requires restart of Obsidian"}};function translateInfo(infoSrc){if(!infoSrc)return false;const info3={...infoSrc};info3.name=$t(info3.name);if(info3.desc)info3.desc=$t(info3.desc);return info3}function _getConfig(key2){if(key2 in configurationNames)return configurationNames[key2];if(key2 in SettingInformation)return SettingInformation[key2];else return false}function getConfig(key2){return translateInfo(_getConfig(key2))}function getConfName(key2){const conf=getConfig(key2);if(!conf)return`${key2} (No info)`;else return conf.name}var import_obsidian9=require("obsidian"),LiveSyncSetting=class _LiveSyncSetting extends import_obsidian9.Setting{constructor(containerEl){super(containerEl);this.watchDirtyKeys=[];this.holdValue=false;this.descBuf="";this.nameBuf="";this.placeHolderBuf="";this.hasPassword=false;this.updateHandlers=new Set;this.prevStatus={};_LiveSyncSetting.env.settingComponents.push(this)}_createDocStub(key2,value){var _a5,_b2,_c2,_d2;{const paneName=findAttrFromParent(this.settingEl,"data-pane"),panelName=findAttrFromParent(this.settingEl,"data-panel");createStub("string"==typeof this.nameBuf?this.nameBuf:null!=(_b2=null==(_a5=this.nameBuf.textContent)?void 0:_a5.toString())?_b2:"",key2,"string"==typeof value?value:null!=(_d2=null==(_c2=value.textContent)?void 0:_c2.toString())?_d2:"",panelName,paneName)}}setDesc(desc){this.descBuf=desc;this._createDocStub("desc",desc);super.setDesc(desc);return this}setName(name){this.nameBuf=name;this._createDocStub("name",name);super.setName(name);return this}setAuto(key2,opt){this.autoWireSetting(key2,opt);return this}autoWireSetting(key2,opt){const conf=getConfig(key2);if(!conf)return;const name=`${conf.name}${statusDisplay(conf.status)}`;this.setName(name);if(conf.desc)this.setDesc(conf.desc);this._createDocStub("key",key2);if(conf.obsolete)this._createDocStub("is_obsolete","true");if(conf.level)this._createDocStub("level",conf.level);this.holdValue=(null==opt?void 0:opt.holdValue)||this.holdValue;this.selfKey=key2;if(conf.obsolete||(null==opt?void 0:opt.obsolete))this.settingEl.toggleClass("sls-setting-obsolete",true);if(null==opt?void 0:opt.onUpdate)this.addOnUpdate(opt.onUpdate);const stat=this._getComputedStatus();if(false===stat.visibility)this.settingEl.toggleClass("sls-setting-hidden",!stat.visibility);return conf}autoWireComponent(component,conf,opt){this.placeHolderBuf=(null==conf?void 0:conf.placeHolder)||(null==opt?void 0:opt.placeHolder)||"";if((null==conf?void 0:conf.level)==LEVEL_ADVANCED)this.settingEl.toggleClass("sls-setting-advanced",true);else if((null==conf?void 0:conf.level)==LEVEL_POWER_USER)this.settingEl.toggleClass("sls-setting-poweruser",true);if(this.placeHolderBuf&&component instanceof import_obsidian9.TextComponent)component.setPlaceholder(this.placeHolderBuf);if(null==opt?void 0:opt.onUpdate)this.addOnUpdate(opt.onUpdate)}async commitValue(value){const key2=this.selfKey;if(void 0!==key2)if(value!=_LiveSyncSetting.env.editingSettings[key2]){_LiveSyncSetting.env.editingSettings[key2]=value;if(!this.holdValue)await _LiveSyncSetting.env.saveSettings([key2])}_LiveSyncSetting.env.requestUpdate()}autoWireText(key2,opt){const conf=this.autoWireSetting(key2,opt);this.addText((text2=>{this.autoWiredComponent=text2;const setValue=wrapMemo((value=>{text2.setValue(value)}));this.invalidateValue=()=>setValue(`${_LiveSyncSetting.env.editingSettings[key2]}`);this.invalidateValue();text2.onChange((async value=>{await this.commitValue(value)}));if(null==opt?void 0:opt.isPassword){text2.inputEl.setAttribute("type","password");this.hasPassword=true}this.autoWireComponent(this.autoWiredComponent,conf,opt)}));return this}autoWireTextArea(key2,opt){const conf=this.autoWireSetting(key2,opt);this.addTextArea((text2=>{this.autoWiredComponent=text2;const setValue=wrapMemo((value=>{text2.setValue(value)}));this.invalidateValue=()=>setValue(`${_LiveSyncSetting.env.editingSettings[key2]}`);this.invalidateValue();text2.onChange((async value=>{await this.commitValue(value)}));if(null==opt?void 0:opt.isPassword){text2.inputEl.setAttribute("type","password");this.hasPassword=true}this.autoWireComponent(this.autoWiredComponent,conf,opt)}));return this}autoWireNumeric(key2,opt){const conf=this.autoWireSetting(key2,opt);this.addText((text2=>{this.autoWiredComponent=text2;if(opt.clampMin)text2.inputEl.setAttribute("min",`${opt.clampMin}`);if(opt.clampMax)text2.inputEl.setAttribute("max",`${opt.clampMax}`);let lastError=false;const setValue=wrapMemo((value=>{text2.setValue(value)}));this.invalidateValue=()=>{if(!lastError)setValue(`${_LiveSyncSetting.env.editingSettings[key2]}`)};this.invalidateValue();text2.onChange((async TextValue=>{const value=Number(TextValue);let hasError=false;if(isNaN(value))hasError=true;if(opt.clampMax&&opt.clampMax<value)hasError=true;if(opt.clampMin&&opt.clampMin>value)if(opt.acceptZero&&0==value);else hasError=true;if(!hasError){lastError=false;this.setTooltip("");text2.inputEl.toggleClass("sls-item-invalid-value",false);await this.commitValue(value)}else{this.setTooltip(`The value should ${opt.clampMin||"~"} < value < ${opt.clampMax||"~"}`);text2.inputEl.toggleClass("sls-item-invalid-value",true);lastError=true;return false}}));text2.inputEl.setAttr("type","number");this.autoWireComponent(this.autoWiredComponent,conf,opt)}));return this}autoWireToggle(key2,opt){const conf=this.autoWireSetting(key2,opt);this.addToggle((toggle=>{this.autoWiredComponent=toggle;const setValue=wrapMemo((value=>{toggle.setValue((null==opt?void 0:opt.invert)?!value:value)}));this.invalidateValue=()=>{var _a5;return setValue(null!=(_a5=_LiveSyncSetting.env.editingSettings[key2])?_a5:false)};this.invalidateValue();toggle.onChange((async value=>{await this.commitValue((null==opt?void 0:opt.invert)?!value:value)}));this.autoWireComponent(this.autoWiredComponent,conf,opt)}));return this}autoWireDropDown(key2,opt){const conf=this.autoWireSetting(key2,opt);this.addDropdown((dropdown=>{this.autoWiredComponent=dropdown;const setValue=wrapMemo((value=>{dropdown.setValue(value)}));dropdown.addOptions(opt.options);this.invalidateValue=()=>setValue(_LiveSyncSetting.env.editingSettings[key2]||"");this.invalidateValue();dropdown.onChange((async value=>{await this.commitValue(value)}));this.autoWireComponent(this.autoWiredComponent,conf,opt)}));return this}addApplyButton(keys2,text2){this.addButton((button=>{this.applyButtonComponent=button;this.watchDirtyKeys=unique([...keys2,...this.watchDirtyKeys]);button.setButtonText(null!=text2?text2:"Apply");button.onClick((async()=>{await _LiveSyncSetting.env.saveSettings(keys2);_LiveSyncSetting.env.reloadAllSettings()}));_LiveSyncSetting.env.requestUpdate()}));return this}addOnUpdate(func){this.updateHandlers.add(func);return this}_getComputedStatus(){let newConf={};for(const handler of this.updateHandlers)newConf={...newConf,...handler()};return newConf}_applyOnUpdateHandlers(){if(this.updateHandlers.size>0){const newConf=this._getComputedStatus(),keys2=Object.keys(newConf);for(const k2 of keys2)if(!(k2 in this.prevStatus)||this.prevStatus[k2]!=newConf[k2])switch(k2){case"visibility":this.settingEl.toggleClass("sls-setting-hidden",!(newConf[k2]||false));this.prevStatus[k2]=newConf[k2];break;case"classes":break;case"disabled":this.setDisabled(newConf[k2]||false);this.settingEl.toggleClass("sls-setting-disabled",newConf[k2]||false);this.prevStatus[k2]=newConf[k2];break;case"isCta":{const component=this.autoWiredComponent;if(component instanceof import_obsidian9.ButtonComponent)if(newConf[k2])component.setCta();else component.removeCta();this.prevStatus[k2]=newConf[k2]}break;case"isWarning":{const component=this.autoWiredComponent;if(component instanceof import_obsidian9.ButtonComponent)if(newConf[k2])component.setWarning();this.prevStatus[k2]=newConf[k2]}break}}}_onUpdate(){if(this.applyButtonComponent){const isDirty2=_LiveSyncSetting.env.isSomeDirty(this.watchDirtyKeys);this.applyButtonComponent.setDisabled(!isDirty2);if(isDirty2)this.applyButtonComponent.setCta();else this.applyButtonComponent.removeCta()}if(this.selfKey&&!_LiveSyncSetting.env.isDirty(this.selfKey)&&this.invalidateValue)this.invalidateValue();if(this.holdValue&&this.selfKey){const isDirty2=_LiveSyncSetting.env.isDirty(this.selfKey),alt=isDirty2?`Original: ${_LiveSyncSetting.env.initialSettings[this.selfKey]}`:"";this.controlEl.toggleClass("sls-item-dirty",isDirty2);if(!this.hasPassword){this.nameEl.toggleClass("sls-item-dirty-help",isDirty2);this.setTooltip(alt,{delay:10,placement:"right"})}}this._applyOnUpdateHandlers()}},EVENT_REQUEST_SHOW_HISTORY="show-history",import_obsidian10=require("obsidian");function visibleOnly(cond){return()=>({visibility:cond()})}function enableOnly(cond){return()=>({disabled:!cond()})}function getLevelStr(level){return level==LEVEL_POWER_USER?" (Power User)":level==LEVEL_ADVANCED?" (Advanced)":level==LEVEL_EDGE_CASE?" (Edge Case)":""}function findAttrFromParent(el,attr2){let current=el;for(;current;){const value=current.getAttribute(attr2);if(value)return value;current=current.parentElement}return""}var toc=new Set,stubs={};function createStub(name,key2,value,panel,pane){var _a5;{if(!(pane in stubs))stubs[pane]={};if(!(panel in stubs[pane]))stubs[pane][panel]=new Map;const old=null!=(_a5=stubs[pane][panel].get(name))?_a5:{};stubs[pane][panel].set(name,{...old,[key2]:value});scheduleTask("update-stub",100,(()=>{eventHub.emitEvent("document-stub-created",{toc,stub:stubs})}))}}function wrapMemo(func){let buf;return arg=>{if(buf!==arg){func(arg);buf=arg}}}var ObsidianLiveSyncSettingTab=class extends import_obsidian.PluginSettingTab{constructor(app2,plugin3){super(app2,plugin3);this.selectedScreen="";this.settingComponents=[];this.controlledElementFunc=[];this.onSavedHandlers=[];this.inWizard=false;this.isShown=false;this.screenElements={};this.plugin=plugin3;LiveSyncSetting.env=this;eventHub.onEvent(EVENT_REQUEST_RELOAD_SETTING_TAB,(()=>{this.requestReload()}))}get editingSettings(){if(!this._editingSettings)this.reloadAllSettings();return this._editingSettings}set editingSettings(v2){if(!this._editingSettings)this.reloadAllSettings();this._editingSettings=v2}applySetting(keys2){for(const k2 of keys2)if(this.isDirty(k2))if(!(k2 in OnDialogSettingsDefault)){this.plugin.settings[k2]=this.editingSettings[k2];this.initialSettings[k2]=this.plugin.settings[k2]}keys2.forEach((e4=>this.refreshSetting(e4)))}applyAllSettings(){var _a5;const changedKeys=Object.keys(null!=(_a5=this.editingSettings)?_a5:{}).filter((e4=>this.isDirty(e4)));this.applySetting(changedKeys);this.reloadAllSettings()}async saveLocalSetting(key2){var _a5,_b2,_c2,_d2;if("configPassphrase"==key2){localStorage.setItem("ls-setting-passphrase",null!=(_b2=null==(_a5=this.editingSettings)?void 0:_a5[key2])?_b2:"");return await Promise.resolve()}if("deviceAndVaultName"==key2){this.plugin.$$setDeviceAndVaultName(null!=(_d2=null==(_c2=this.editingSettings)?void 0:_c2[key2])?_d2:"");this.plugin.$$saveDeviceAndVaultName();return await Promise.resolve()}}async saveSettings(keys2){let hasChanged=false;const appliedKeys=[];for(const k2 of keys2)if(this.isDirty(k2)){appliedKeys.push(k2);if(!(k2 in OnDialogSettingsDefault)){this.plugin.settings[k2]=this.editingSettings[k2];this.initialSettings[k2]=this.plugin.settings[k2];hasChanged=true}else{await this.saveLocalSetting(k2);this.initialSettings[k2]=this.editingSettings[k2]}}if(hasChanged)await this.plugin.saveSettings();const handlers=this.onSavedHandlers.filter((e4=>-1!==appliedKeys.indexOf(e4.key))).map((e4=>e4.handler(this.editingSettings[e4.key])));await Promise.all(handlers);keys2.forEach((e4=>this.refreshSetting(e4)))}async saveAllDirtySettings(){var _a5;const changedKeys=Object.keys(null!=(_a5=this.editingSettings)?_a5:{}).filter((e4=>this.isDirty(e4)));await this.saveSettings(changedKeys);this.reloadAllSettings()}requestUpdate(){scheduleTask("update-setting",10,(()=>{for(const setting of this.settingComponents)setting._onUpdate();for(const func of this.controlledElementFunc)func()}))}reloadAllLocalSettings(){const ret={...OnDialogSettingsDefault};ret.configPassphrase=localStorage.getItem("ls-setting-passphrase")||"";ret.preset="";ret.deviceAndVaultName=this.plugin.$$getDeviceAndVaultName();return ret}computeAllLocalSettings(){var _a5,_b2;return{syncMode:(null==(_a5=this.editingSettings)?void 0:_a5.liveSync)?"LIVESYNC":(null==(_b2=this.editingSettings)?void 0:_b2.periodicReplication)?"PERIODIC":"ONEVENTS"}}reloadAllSettings(skipUpdate=false){const localSetting=this.reloadAllLocalSettings();this._editingSettings={...this.plugin.settings,...localSetting};this._editingSettings={...this.editingSettings,...this.computeAllLocalSettings()};this.initialSettings={...this.editingSettings};if(!skipUpdate)this.requestUpdate()}refreshSetting(key2){const localSetting=this.reloadAllLocalSettings();if(key2 in this.plugin.settings)if(key2 in localSetting){this.initialSettings[key2]=localSetting[key2];this.editingSettings[key2]=localSetting[key2]}else{this.initialSettings[key2]=this.plugin.settings[key2];this.editingSettings[key2]=this.initialSettings[key2]}this.editingSettings={...this.editingSettings,...this.computeAllLocalSettings()};this.requestUpdate()}isDirty(key2){var _a5;return isObjectDifferent(this.editingSettings[key2],null==(_a5=this.initialSettings)?void 0:_a5[key2])}isSomeDirty(keys2){return keys2.some((e4=>this.isDirty(e4)))}isConfiguredAs(key2,value){if(!this.editingSettings)return false;else return this.editingSettings[key2]==value}async testConnection(settingOverride={}){const trialSetting={...this.editingSettings,...settingOverride},replicator=await this.plugin.$anyNewReplicator(trialSetting);await replicator.tryConnectRemote(trialSetting);const status=await replicator.getRemoteStatus(trialSetting);if(status)if(status.estimatedSize)Logger(`Estimated size: ${sizeToHumanReadable2(status.estimatedSize)}`,LOG_LEVEL_NOTICE)}closeSetting(){this.plugin.app.setting.close()}handleElement(element2,func){const updateFunc=((element3,func2)=>{const prev={};return()=>{const newValue=func2(),keys2=Object.keys(newValue);for(const k2 of keys2)if(prev[k2]!==newValue[k2]){if("visibility"==k2)element3.toggleClass("sls-setting-hidden",!(newValue[k2]||false));prev[k2]=newValue[k2]}}})(element2,func);this.controlledElementFunc.push(updateFunc);updateFunc()}createEl(el,tag,o2,callback,func){const element2=el.createEl(tag,o2,callback);if(func)this.handleElement(element2,func);return element2}addEl(el,tag,o2,callback,func){const elm=this.createEl(el,tag,o2,callback,func);return Promise.resolve(elm)}addOnSaved(key2,func){this.onSavedHandlers.push({key:key2,handler:func})}resetEditingSettings(){this._editingSettings=void 0;this.initialSettings=void 0}hide(){this.isShown=false}requestReload(){var _a5;if(this.isShown){const newConf=this.plugin.settings,keys2=Object.keys(newConf);let hasLoaded=false;for(const k2 of keys2)if("deviceAndVaultName"!==k2)if(isObjectDifferent(newConf[k2],null==(_a5=this.initialSettings)?void 0:_a5[k2]))if(this.isDirty(k2))this.plugin.confirm.askInPopup(`config-reloaded-${k2}`,`The setting "${getConfName(k2)}" was modified from another device. Click {HERE} to reload settings. Click elsewhere to ignore changes`,(anchor=>{anchor.text="HERE";anchor.addEventListener("click",(()=>{this.refreshSetting(k2);this.display()}))}));else{this.refreshSetting(k2);hasLoaded=true}if(hasLoaded)this.display();else this.requestUpdate()}else this.reloadAllSettings(true)}changeDisplay(screen){for(const k2 in this.screenElements)if(k2==screen)this.screenElements[k2].forEach((element2=>element2.removeClass("setting-collapsed")));else this.screenElements[k2].forEach((element2=>element2.addClass("setting-collapsed")));if(this.menuEl)this.menuEl.querySelectorAll(".sls-setting-label").forEach((element2=>{if(element2.hasClass(`c-${screen}`)){element2.addClass("selected");element2.querySelector("input[type=radio]").checked=true}else{element2.removeClass("selected");element2.querySelector("input[type=radio]").checked=false}}));this.selectedScreen=screen}async enableMinimalSetup(){this.editingSettings.liveSync=false;this.editingSettings.periodicReplication=false;this.editingSettings.syncOnSave=false;this.editingSettings.syncOnEditorSave=false;this.editingSettings.syncOnStart=false;this.editingSettings.syncOnFileOpen=false;this.editingSettings.syncAfterMerge=false;this.plugin.replicator.closeReplication();await this.saveAllDirtySettings();this.containerEl.addClass("isWizard");this.inWizard=true;this.changeDisplay("20")}display(){const changeDisplay=this.changeDisplay.bind(this),{containerEl}=this;this.settingComponents.length=0;this.controlledElementFunc.length=0;this.onSavedHandlers.length=0;this.screenElements={};if(null==this._editingSettings||null==this.initialSettings)this.reloadAllSettings();if(void 0===this.editingSettings||null==this.initialSettings)return;this.isShown=true;containerEl.empty();containerEl.addClass("sls-setting");containerEl.removeClass("isWizard");const setStyle=(el,styleHead,condition)=>{if(condition()){el.addClass(`${styleHead}-enabled`);el.removeClass(`${styleHead}-disabled`)}else{el.addClass(`${styleHead}-disabled`);el.removeClass(`${styleHead}-enabled`)}};setStyle(containerEl,"menu-setting-poweruser",(()=>this.isConfiguredAs("usePowerUserMode",true)));setStyle(containerEl,"menu-setting-advanced",(()=>this.isConfiguredAs("useAdvancedMode",true)));setStyle(containerEl,"menu-setting-edgecase",(()=>this.isConfiguredAs("useEdgeCaseMode",true)));const addScreenElement=(key2,element2)=>{if(!(key2 in this.screenElements))this.screenElements[key2]=[];this.screenElements[key2].push(element2)},menuWrapper=this.createEl(containerEl,"div",{cls:"sls-setting-menu-wrapper"});if(this.menuEl)this.menuEl.remove();this.menuEl=menuWrapper.createDiv("");this.menuEl.addClass("sls-setting-menu");const menuTabs=this.menuEl.querySelectorAll(".sls-setting-label"),selectPane=event=>{const target=event.target;if("INPUT"==target.tagName){const value=target.getAttribute("value");if(value&&this.selectedScreen!=value)changeDisplay(value)}},isNeedRebuildLocal=()=>this.isSomeDirty(["useIndexedDBAdapter","doNotUseFixedRevisionForChunks","handleFilenameCaseSensitive","passphrase","useDynamicIterationCount","usePathObfuscation","encrypt"]),isNeedRebuildRemote=()=>this.isSomeDirty(["doNotUseFixedRevisionForChunks","handleFilenameCaseSensitive","passphrase","useDynamicIterationCount","usePathObfuscation","encrypt"]),confirmRebuild=async()=>{if(!await isPassphraseValid()){Logger("Passphrase is not valid, please fix it.",LOG_LEVEL_NOTICE);return}const result=await confirmWithMessage(this.plugin,"Rebuild Required","Rebuilding Databases are required to apply the changes.. Please select the method to apply the changes.\n\n<details>\n<summary>Legends</summary>\n\n| Symbol | Meaning |\n|: ------ :| ------- |\n|  | Up to Date |\n|  | Synchronise to balance |\n| , | Transfer to overwrite |\n| , | Transfer to overwrite from other side |\n\n</details>\n\n## Rebuild Both from This Device\nAt a glance:          \nReconstruct both the local and remote databases using existing files from this device.\nThis causes a lockout other devices, and they need to perform fetching. \n## Fetch from Remote\nAt a glance:         \nInitialise the local database and reconstruct it using data fetched from the remote database.\nThis case includes the case which you have rebuilt the remote database.\n## (Danger) Save Only Settings\nStore only the settings. **Caution: This may lead to data corruption**; database reconstruction is generally necessary.",["Fetch from Remote","Rebuild Both from This Device","(Danger) Save Only Settings","Cancel"],"Cancel",0);if("Cancel"!=result){if("Fetch from Remote"==result)if(!await checkWorkingPassphrase())if("yes"!=await this.plugin.confirm.askYesNoDialog("Are you sure to proceed?",{defaultOption:"No"}))return;if(!this.editingSettings.encrypt)this.editingSettings.passphrase="";await this.saveAllDirtySettings();await this.applyAllSettings();if("Fetch from Remote"==result){await this.plugin.storageAccess.writeFileAuto(FLAGMD_REDFLAG3_HR,"");this.plugin.$$scheduleAppReload();this.closeSetting()}else if("Rebuild Both from This Device"==result){await this.plugin.storageAccess.writeFileAuto(FLAGMD_REDFLAG2_HR,"");this.plugin.$$scheduleAppReload();this.closeSetting()}else if("(Danger) Save Only Settings"==result)await this.plugin.saveSettings()}};this.createEl(menuWrapper,"div",{cls:"sls-setting-menu-buttons"},(el=>{el.addClass("wizardHidden");el.createEl("label",{text:"Changes need to be applied!"});this.addEl(el,"button",{text:"Apply",cls:"mod-warning"},(buttonEl=>{buttonEl.addEventListener("click",(()=>fireAndForget((async()=>await confirmRebuild()))))}))}),visibleOnly((()=>isNeedRebuildLocal()||isNeedRebuildRemote())));const setLevelClass=(el,level)=>{switch(level){case LEVEL_POWER_USER:el.addClass("sls-setting-poweruser");break;case LEVEL_ADVANCED:el.addClass("sls-setting-advanced");break;case LEVEL_EDGE_CASE:el.addClass("sls-setting-edgecase");break;default:}};let paneNo=0;const addPane=(parentEl,title,icon,order,wizardHidden,level)=>{const el=this.createEl(parentEl,"div",{text:""});{const mdTitle=`${paneNo++}. ${title}${getLevelStr(null!=level?level:"")}`;el.setAttribute("data-pane",mdTitle);toc.add(`| ${icon} | [${mdTitle}](#${mdTitle.toLowerCase().replace(/ /g,"-").replace(/[^\w\s-]/g,"")}) | `)}setLevelClass(el,level);el.createEl("h3",{text:title,cls:"sls-setting-pane-title"});if(this.menuEl)this.menuEl.createEl("label",{cls:`sls-setting-label c-${order} ${wizardHidden?"wizardHidden":""}`},(el2=>{setLevelClass(el2,level);const inputEl=el2.createEl("input",{type:"radio",name:"disp",value:`${order}`,cls:"sls-setting-tab"});el2.createEl("div",{cls:"sls-setting-menu-btn",text:icon,title});inputEl.addEventListener("change",selectPane);inputEl.addEventListener("click",selectPane)}));addScreenElement(`${order}`,el);return Promise.resolve(el)},panelNoMap={},addPanel=(parentEl,title,callback,func,level)=>{const el=this.createEl(parentEl,"div",{text:""},callback,func);{const paneNo2=findAttrFromParent(parentEl,"data-pane");if(!(paneNo2 in panelNoMap))panelNoMap[paneNo2]=0;panelNoMap[paneNo2]+=1;const panelNo=panelNoMap[paneNo2];el.setAttribute("data-panel",`${panelNo}. ${title}${getLevelStr(null!=level?level:"")}`)}setLevelClass(el,level);this.createEl(el,"h4",{text:title,cls:"sls-setting-panel-title"});return Promise.resolve(el)};menuTabs.forEach((element2=>{const e4=element2.querySelector(".sls-setting-tab");if(e4)e4.addEventListener("change",(event=>{menuTabs.forEach((element3=>element3.removeClass("selected")));this.changeDisplay(event.currentTarget.value);element2.addClass("selected")}))}));const lastVersion=~~(versionNumberString2Number("0.24.3")/1e3),isAnySyncEnabled=()=>{var _a5,_b2,_c2,_d2;if(this.isConfiguredAs("isConfigured",false))return false;if(this.isConfiguredAs("liveSync",true))return true;if(this.isConfiguredAs("periodicReplication",true))return true;if(this.isConfiguredAs("syncOnFileOpen",true))return true;if(this.isConfiguredAs("syncOnSave",true))return true;if(this.isConfiguredAs("syncOnEditorSave",true))return true;if(this.isConfiguredAs("syncOnStart",true))return true;if(this.isConfiguredAs("syncAfterMerge",true))return true;if(this.isConfiguredAs("syncOnFileOpen",true))return true;if("CONNECTED"==(null==(_b2=null==(_a5=this.plugin)?void 0:_a5.replicator)?void 0:_b2.syncStatus))return true;if("PAUSED"==(null==(_d2=null==(_c2=this.plugin)?void 0:_c2.replicator)?void 0:_d2.syncStatus))return true;else return false},enableOnlySyncDisabled=enableOnly((()=>!isAnySyncEnabled())),onlyOnCouchDB=()=>({visibility:this.isConfiguredAs("remoteType",REMOTE_COUCHDB)}),onlyOnMinIO=()=>({visibility:this.isConfiguredAs("remoteType",REMOTE_MINIO)}),checkWorkingPassphrase=async()=>{if(this.editingSettings.remoteType==REMOTE_MINIO)return true;const settingForCheck={...this.editingSettings},replicator=this.plugin.$anyNewReplicator(settingForCheck);if(!(replicator instanceof LiveSyncCouchDBReplicator))return true;const db=await replicator.connectRemoteCouchDBWithSetting(settingForCheck,this.plugin.$$isMobile(),true);if("string"==typeof db){Logger(`ERROR: Failed to check passphrase with the remote server: \n${db}.`,LOG_LEVEL_NOTICE);return false}else if(await checkSyncInfo(db.db))return true;else{Logger("ERROR: Passphrase is not compatible with the remote server! Please check it again!",LOG_LEVEL_NOTICE);return false}},isPassphraseValid=async()=>{if(this.editingSettings.encrypt&&""==this.editingSettings.passphrase){Logger("You cannot enable encryption without a passphrase",LOG_LEVEL_NOTICE);return false}if(this.editingSettings.encrypt&&!await testCrypt()){Logger("Your device does not support encryption.",LOG_LEVEL_NOTICE);return false}return true},rebuildDB=async method=>{if(!this.editingSettings.encrypt||""!=this.editingSettings.passphrase)if(!this.editingSettings.encrypt||await testCrypt()){if(!this.editingSettings.encrypt)this.editingSettings.passphrase="";this.applyAllSettings();await this.plugin.$allSuspendAllSync();await this.plugin.$allSuspendExtraSync();this.reloadAllSettings();this.editingSettings.isConfigured=true;Logger("Syncing has been disabled, fetch and re-enabled if desired.",LOG_LEVEL_NOTICE);await this.saveAllDirtySettings();this.closeSetting();await delay(2e3);await this.plugin.rebuilder.$performRebuildDB(method)}else Logger("Your device does not support encryption.",LOG_LEVEL_NOTICE);else Logger("You cannot enable encryption without a passphrase",LOG_LEVEL_NOTICE)};addPane(containerEl,"Change Log","",100,false).then((paneEl=>{var _a5,_b2;const informationDivEl=this.createEl(paneEl,"div",{text:""}),tmpDiv=createDiv();tmpDiv.addClass("op-warn-info");tmpDiv.innerHTML="<p>Here due to an upgrade notification? Please review the version history. If you're satisfied, click the button. A new update will prompt this again.</p><button> OK, I have read everything. </button>";if(lastVersion>((null==(_a5=this.editingSettings)?void 0:_a5.lastReadUpdates)||0)){const informationButtonDiv=informationDivEl.appendChild(tmpDiv);null==(_b2=informationButtonDiv.querySelector("button"))||_b2.addEventListener("click",(()=>{fireAndForget((async()=>{this.editingSettings.lastReadUpdates=lastVersion;await this.saveAllDirtySettings();informationButtonDiv.remove()}))}))}fireAndForget((()=>import_obsidian.MarkdownRenderer.render(this.plugin.app,"## 0.24.0\n\nI know that we have been waiting for a long time. It is finally released!\n\nOver the past three years since the inception of the plugin, various features have been implemented to address diverse user needs. This is truly honourable, and I am grateful for your years of support. However, this process has led to an increasingly disorganised codebase, with features becoming entangled. Consequently, this has led to a situation where bugs can go unnoticed and resolving one issue may inadvertently introduce another.\n\nIn 0.24.0, I reorganised the previously jumbled main codebase into clearly defined modules. Although I had assumed that the total size of the code would not increase, I discovered that it has in fact increased. While the complexity is still considerable, the refactoring has improved the clarity of the code's structure. Additionally, while testing the release candidates, we still found many bugs to fix, which helped to make this plug-in robust and stable. Therefore, we are now ready to use the updated plug-in, and in addition to that, proceed to the next step.\n\nThis is also the first step towards a fully-fledged-fancy LiveSync, not just a plug-in from Obsidian. Of course, it will still be a plug-in primarily and foremost, but this development marks a significant step towards the self-hosting concept.\n\nFinally, I would like to once again express my respect and gratitude to all of you. My gratitude extends to all of the dev testers! Your contributions have certainly made the plug-in robust and stable!\n\nThank you, and I hope your troubles will be resolved!\n\n---\n\n## 0.24.3\n\n### Improved\n\n-   Many messages have been improved for better understanding as thanks to the fine works of @Volkor3-16! Thank you so much!\n-   Documentations also have been updated to reflect the changes in the messages.\n-   Now the style of In-Editor Status has been solid for some Android devices.\n\n## 0.24.2\n\n### Rewritten\n\n-   Hidden File Sync is now respects the file changes on the storage. Not simply comparing modified times.\n    -   This makes hidden file sync more robust and reliable.\n\n### Fixed\n\n-   `Scan hidden files before replication` is now configurable again.\n-   Some unexpected errors are now handled more gracefully.\n-   Meaningless event passing during boot sequence is now prevented.\n-   Error handling for non-existing files has been fixed.\n-   Hidden files will not be batched to avoid the potential error.\n    -   This behaviour had been causing the error in the previous versions in specific situations.\n-   The log which checking automatic conflict resolution is now in verbose level.\n-   Replication log (skipping non-targetting files) shows the correct information.\n-   The dialogue that asking enabling optional feature during `Rebuild Everything` now prevents to show the `overwrite` option.\n    -   The rebuilding device is the first, meaningless.\n-   Files with different modified time but identical content are no longer processed repeatedly.\n-   Some unexpected errors which caused after terminating plug-in are now avoided.\n-\n\n### Improved\n\n-   JSON files are now more transferred efficiently.\n    -   Now the JSON files are transferred in more fine chunks, which makes the transfer more efficient.\n\n## 0.24.1\n\n### Fixed\n\n-   Vault History can show the correct information of match-or-not for each file and database even if it is a binary file.\n-   `Sync settings via markdown` is now hidden during the setup wizard.\n-   Verify and Fix will ignore the hidden files if the hidden file sync is disabled.\n\n#### New feature\n\n-   Now we can fetch the tweaks from the remote database while the setting dialogue and wizard are processing.\n\n### Improved\n\n-   More things are moved to the modules.\n    -   Includes the Main codebase. Now `main.ts` is almost stub.\n-   EventHub is now more robust and typesafe.\n\n## 0.24.0\n\n### Improved\n\n-   The welcome message is now more simple to encourage the use of the Setup-URI.\n    -   The secondary message is also simpler to guide users to Minimal Setup.\n        -   But Setup-URI will be recommended again, due to its importance.\n    -   These dialogues contain a link to the documentation which can be clicked.\n-   The minimal setup is more minimal now. And, the setup is more user-friendly.\n    -   Now the Configuration of the remote database is checked more robustly, but we can ignore the warning and proceed with the setup.\n-   Before we are asked about each feature, we are asked if we want to use optional features in the first place.\n    -   This is to prevent the user from being overwhelmed by the features.\n    -   And made it clear that it is not recommended for new users.\n-   Many messages have been improved for better understanding.\n    -   Ridiculous messages have been (carefully) refined.\n    -   Dialogues are more informative and friendly.\n        -   A lot of messages have been mostly rewritten, leveraging Markdown.\n        -   Especially auto-closing dialogues are now explicitly labelled: `To stop the countdown, tap anywhere on the dialogue`.\n-   Now if the is plugin configured to ignore some events, we will get a chance to fix it, in addition to the warning.\n    -   And why that has happened is also explained in the dialogue.\n-   A note relating to device names has been added to Customisation Sync on the setting dialogue.\n-   We can verify and resolve also the hidden files now.\n\n### Fixed\n\n-   We can resolve the conflict of the JSON file correctly now.\n-   Verifying files between the local database and storage is now working correctly.\n-   While restarting the plug-in, the shown dialogues will be automatically closed to avoid unexpected behaviour.\n-   Replicated documents that the local device has configured to ignore are now correctly ignored.\n-   The chunks of the document on the local device during the first transfer will be created correctly.\n    -   And why we should create them is now explained in the dialogue.\n-   If optional features have been enabled in the wizard, `Enable advanced features` will be toggled correctly.\n    The hidden file sync is now working correctly. - Now the deletion of hidden files is correctly synchronised.\n-   Customisation Sync is now working correctly together with hidden file sync.\n-   No longer database suffix is stored in the setting sharing markdown.\n-   A fair number of bugs have been fixed.\n\n### Changed\n\n-   Some default settings have been changed for an easier new user experience.\n    -   Preventing the meaningless migration of the settings.\n\n### Tiding\n\n-   The codebase has been reorganised into clearly defined modules.\n-   Commented-out codes have been gradually removed.\n\nOlder notes are in [updates_old.md](https://github.com/vrtmrz/obsidian-livesync/blob/main/updates_old.md).\n",informationDivEl,"/",this.plugin)))}));addPane(containerEl,"Setup","",110,false).then((paneEl=>{addPanel(paneEl,"Quick Setup").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Connect with Setup URI").setDesc("This is the recommended method to set up Self-hosted LiveSync with a Setup URI.").addButton((text2=>{text2.setButtonText("Use").onClick((()=>{this.closeSetting();eventHub.emitEvent(EVENT_REQUEST_OPEN_SETUP_URI)}))}));new LiveSyncSetting(paneEl2).setName("Manual setup").setDesc("Not recommended, but useful if you don't have a Setup URI").addButton((text2=>{text2.setButtonText("Start").onClick((async()=>{await this.enableMinimalSetup()}))}));new LiveSyncSetting(paneEl2).setName("Enable LiveSync").setDesc("Only enable this after configuring either of the above two options or completing all configuration manually.").addOnUpdate(visibleOnly((()=>!this.isConfiguredAs("isConfigured",true)))).addButton((text2=>{text2.setButtonText("Enable").onClick((async()=>{this.editingSettings.isConfigured=true;await this.saveAllDirtySettings();this.plugin.$$askReload()}))}))}));addPanel(paneEl,"To setup other devices",void 0,visibleOnly((()=>this.isConfiguredAs("isConfigured",true)))).then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Copy the current settings to a Setup URI").setDesc("Perfect for setting up a new device!").addButton((text2=>{text2.setButtonText("Copy").onClick((()=>{eventHub.emitEvent(EVENT_REQUEST_COPY_SETUP_URI)}))}))}));addPanel(paneEl,"Reset").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Discard existing settings and databases").addButton((text2=>{text2.setButtonText("Discard").onClick((async()=>{if("yes"==await this.plugin.confirm.askYesNoDialog("Do you really want to discard existing settings and databases?",{defaultOption:"No"})){this.editingSettings={...this.editingSettings,...DEFAULT_SETTINGS};await this.saveAllDirtySettings();this.plugin.settings={...DEFAULT_SETTINGS};await this.plugin.$$saveSettingData();await this.plugin.$$resetLocalDatabase();this.plugin.$$askReload()}})).setWarning()})).addOnUpdate(visibleOnly((()=>this.isConfiguredAs("isConfigured",true))))}));addPanel(paneEl,"Enable extra and advanced features").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireToggle("useAdvancedMode");new LiveSyncSetting(paneEl2).autoWireToggle("usePowerUserMode");new LiveSyncSetting(paneEl2).autoWireToggle("useEdgeCaseMode");this.addOnSaved("useAdvancedMode",(()=>this.display()));this.addOnSaved("usePowerUserMode",(()=>this.display()));this.addOnSaved("useEdgeCaseMode",(()=>this.display()))}));addPanel(paneEl,"Online Tips").then((paneEl2=>{const repo="vrtmrz/obsidian-livesync",topPath="/docs/troubleshooting.md",rawRepoURI=`https://raw.githubusercontent.com/${repo}/main`;this.createEl(paneEl2,"div","",(el=>el.innerHTML=`<a href='https://github.com/${repo}/blob/main${topPath}' target="_blank">Open in browser</a>`));const troubleShootEl=this.createEl(paneEl2,"div",{text:"",cls:"sls-troubleshoot-preview"}),loadMarkdownPage=async(pathAll,basePathParam="")=>{var _a5,_b2;troubleShootEl.style.minHeight=troubleShootEl.clientHeight+"px";troubleShootEl.empty();const directoryArr=(pathAll.startsWith("/")?pathAll:`${basePathParam}/${pathAll}`).split("/"),filename=directoryArr.pop(),basePath=directoryArr.join("/");let remoteTroubleShootMDSrc="";try{remoteTroubleShootMDSrc=await(0,import_obsidian10.request)(`${rawRepoURI}${basePath}/${filename}`)}catch(ex){remoteTroubleShootMDSrc="An error occurred!!\n"+ex.toString()}const remoteTroubleShootMD=remoteTroubleShootMDSrc.replace(/\((.*?(.png)|(.jpg))\)/g,`(${rawRepoURI}${basePath}/$1)`);await import_obsidian.MarkdownRenderer.render(this.plugin.app,`<a class='sls-troubleshoot-anchor'></a> [Tips and Troubleshooting](${topPath}) [PageTop](${filename})\n\n${remoteTroubleShootMD}`,troubleShootEl,`${rawRepoURI}`,this.plugin);null==(_b2=null==(_a5=troubleShootEl.querySelector(".sls-troubleshoot-anchor"))?void 0:_a5.parentElement)||_b2.setCssStyles({position:"sticky",top:"-1em",backgroundColor:"var(--modal-background)"});troubleShootEl.querySelectorAll("a.internal-link").forEach((anchorEl=>{anchorEl.addEventListener("click",(evt=>{fireAndForget((async()=>{const uri=anchorEl.getAttr("data-href");if(uri)if(uri.startsWith("#")){evt.preventDefault();const p2=Array.from(troubleShootEl.querySelectorAll("[data-heading]")).find((e4=>{var _a6;return(null==(_a6=e4.getAttr("data-heading"))?void 0:_a6.toLowerCase().split(" ").join("-"))==uri.substring(1).toLowerCase()}));if(p2){p2.setCssStyles({scrollMargin:"3em"});p2.scrollIntoView({behavior:"instant",block:"start"})}}else{evt.preventDefault();await loadMarkdownPage(uri,basePath);troubleShootEl.setCssStyles({scrollMargin:"1em"});troubleShootEl.scrollIntoView({behavior:"instant",block:"start"})}}))}))}));troubleShootEl.style.minHeight=""};loadMarkdownPage(topPath)}))}));addPane(containerEl,"General Settings","",20,false).then((paneEl=>{addPanel(paneEl,"Appearance").then((paneEl2=>{const languages=Object.fromEntries([["","Default"],...SUPPORTED_I18N_LANGS.map((e4=>[e4,$t(`lang-${e4}`)]))]);new LiveSyncSetting(paneEl2).autoWireDropDown("displayLanguage",{options:languages});this.addOnSaved("displayLanguage",(()=>this.display()));new LiveSyncSetting(paneEl2).autoWireToggle("showStatusOnEditor");new LiveSyncSetting(paneEl2).autoWireToggle("showOnlyIconsOnEditor",{onUpdate:visibleOnly((()=>this.isConfiguredAs("showStatusOnEditor",true)))});new LiveSyncSetting(paneEl2).autoWireToggle("showStatusOnStatusbar")}));addPanel(paneEl,"Logging").then((paneEl2=>{paneEl2.addClass("wizardHidden");new LiveSyncSetting(paneEl2).autoWireToggle("lessInformationInLog");new LiveSyncSetting(paneEl2).autoWireToggle("showVerboseLog",{onUpdate:visibleOnly((()=>this.isConfiguredAs("lessInformationInLog",false)))})}));new LiveSyncSetting(paneEl).setClass("wizardOnly").addButton((button=>button.setButtonText("Next").setCta().onClick((()=>{this.changeDisplay("0")}))))}));let checkResultDiv;const checkConfig=async checkResultDiv2=>{var _a5,_b2,_c2,_d2,_e2,_f,_g,_h,_i2,_j,_k;Logger("Checking database configuration",LOG_LEVEL_INFO);let isSuccessful=true;const emptyDiv=createDiv();emptyDiv.innerHTML="<span></span>";null==checkResultDiv2||checkResultDiv2.replaceChildren(emptyDiv);const addResult=(msg,classes)=>{const tmpDiv=createDiv();tmpDiv.addClass("ob-btn-config-fix");if(classes)tmpDiv.addClasses(classes);tmpDiv.innerHTML=`${msg}`;null==checkResultDiv2||checkResultDiv2.appendChild(tmpDiv)};try{if(isCloudantURI(this.editingSettings.couchDB_URI)){Logger("This feature cannot be used with IBM Cloudant.",LOG_LEVEL_NOTICE);return}const responseConfig=(await requestToCouchDB(this.editingSettings.couchDB_URI,this.editingSettings.couchDB_USER,this.editingSettings.couchDB_PASSWORD,window.origin)).json,addConfigFixButton=(title,key2,value)=>{var _a6;if(!checkResultDiv2)return;const tmpDiv=createDiv();tmpDiv.addClass("ob-btn-config-fix");tmpDiv.innerHTML=`<label>${title}</label><button>Fix</button>`;const x2=checkResultDiv2.appendChild(tmpDiv);null==(_a6=x2.querySelector("button"))||_a6.addEventListener("click",(()=>{fireAndForget((async()=>{Logger(`CouchDB Configuration: ${title} -> Set ${key2} to ${value}`);const res2=await requestToCouchDB(this.editingSettings.couchDB_URI,this.editingSettings.couchDB_USER,this.editingSettings.couchDB_PASSWORD,void 0,key2,value);if(200==res2.status){Logger(`CouchDB Configuration: ${title} successfully updated`,LOG_LEVEL_NOTICE);checkResultDiv2.removeChild(x2);await checkConfig(checkResultDiv2)}else{Logger(`CouchDB Configuration: ${title} failed`,LOG_LEVEL_NOTICE);Logger(res2.text,LOG_LEVEL_VERBOSE)}}))}))};addResult("---Notice---",["ob-btn-config-head"]);addResult("If the server configuration is not persistent (e.g., running on docker), the values here may change. Once you are able to connect, please update the settings in the server's local.ini.",["ob-btn-config-info"]);addResult("--Config check--",["ob-btn-config-head"]);if(!(this.editingSettings.couchDB_USER in responseConfig.admins))addResult(" You do not have administrator privileges.");else addResult(" You have administrator privileges.");if("true"!=(null==(_a5=null==responseConfig?void 0:responseConfig.chttpd)?void 0:_a5.require_valid_user)){isSuccessful=false;addResult(" chttpd.require_valid_user is wrong.");addConfigFixButton("Set chttpd.require_valid_user = true","chttpd/require_valid_user","true")}else addResult(" chttpd.require_valid_user is ok.");if("true"!=(null==(_b2=null==responseConfig?void 0:responseConfig.chttpd_auth)?void 0:_b2.require_valid_user)){isSuccessful=false;addResult(" chttpd_auth.require_valid_user is wrong.");addConfigFixButton("Set chttpd_auth.require_valid_user = true","chttpd_auth/require_valid_user","true")}else addResult(" chttpd_auth.require_valid_user is ok.");if(!(null==responseConfig?void 0:responseConfig.httpd["WWW-Authenticate"])){isSuccessful=false;addResult(" httpd.WWW-Authenticate is missing");addConfigFixButton("Set httpd.WWW-Authenticate","httpd/WWW-Authenticate",'Basic realm="couchdb"')}else addResult(" httpd.WWW-Authenticate is ok.");if("true"!=(null==(_c2=null==responseConfig?void 0:responseConfig.httpd)?void 0:_c2.enable_cors)){isSuccessful=false;addResult(" httpd.enable_cors is wrong");addConfigFixButton("Set httpd.enable_cors","httpd/enable_cors","true")}else addResult(" httpd.enable_cors is ok.");if(!isCloudantURI(this.editingSettings.couchDB_URI)){if(Number(null!=(_e2=null==(_d2=null==responseConfig?void 0:responseConfig.chttpd)?void 0:_d2.max_http_request_size)?_e2:0)<4294967296){isSuccessful=false;addResult(" chttpd.max_http_request_size is low)");addConfigFixButton("Set chttpd.max_http_request_size","chttpd/max_http_request_size","4294967296")}else addResult(" chttpd.max_http_request_size is ok.");if(Number(null!=(_g=null==(_f=null==responseConfig?void 0:responseConfig.couchdb)?void 0:_f.max_document_size)?_g:0)<5e7){isSuccessful=false;addResult(" couchdb.max_document_size is low)");addConfigFixButton("Set couchdb.max_document_size","couchdb/max_document_size","50000000")}else addResult(" couchdb.max_document_size is ok.")}if("true"!=(null==(_h=null==responseConfig?void 0:responseConfig.cors)?void 0:_h.credentials)){isSuccessful=false;addResult(" cors.credentials is wrong");addConfigFixButton("Set cors.credentials","cors/credentials","true")}else addResult(" cors.credentials is ok.");const ConfiguredOrigins=((null!=(_j=null==(_i2=null==responseConfig?void 0:responseConfig.cors)?void 0:_i2.origins)?_j:"")+"").split(",");if("*"==(null==(_k=null==responseConfig?void 0:responseConfig.cors)?void 0:_k.origins)||-1!==ConfiguredOrigins.indexOf("app://obsidian.md")&&-1!==ConfiguredOrigins.indexOf("capacitor://localhost")&&-1!==ConfiguredOrigins.indexOf("http://localhost"))addResult(" cors.origins is ok.");else{addResult(" cors.origins is wrong");addConfigFixButton("Set cors.origins","cors/origins","app://obsidian.md,capacitor://localhost,http://localhost");isSuccessful=false}addResult("--Connection check--",["ob-btn-config-head"]);addResult(`Current origin:${window.location.origin}`);const origins=["app://obsidian.md","capacitor://localhost","http://localhost"];for(const org of origins){const rr=await requestToCouchDB(this.editingSettings.couchDB_URI,this.editingSettings.couchDB_USER,this.editingSettings.couchDB_PASSWORD,org),responseHeaders=Object.fromEntries(Object.entries(rr.headers).map((e4=>{e4[0]=`${e4[0]}`.toLowerCase();return e4})));addResult(`Origin check:${org}`);if("true"!=responseHeaders["access-control-allow-credentials"]){addResult(" CORS is not allowing credentials");isSuccessful=false}else addResult(" CORS credentials OK");if(responseHeaders["access-control-allow-origin"]!=org)addResult(` CORS Origin is unmatched:${origin}->${responseHeaders["access-control-allow-origin"]}`);else addResult(" CORS origin OK")}addResult("--Done--",["ob-btn-config-head"]);addResult("If you're having trouble with the Connection-check (even after checking config), please check your reverse proxy configuration.",["ob-btn-config-info"]);Logger("Checking configuration done",LOG_LEVEL_INFO)}catch(ex){if(401==(null==ex?void 0:ex.status)){isSuccessful=false;addResult(" Access forbidden.");addResult("We could not continue the test.");Logger("Checking configuration done",LOG_LEVEL_INFO)}else{Logger("Checking configuration failed",LOG_LEVEL_NOTICE);Logger(ex);isSuccessful=false}}return isSuccessful};addPane(containerEl,"Remote Configuration","",0,false).then((paneEl=>{addPanel(paneEl,"Remote Server").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireDropDown("remoteType",{holdValue:true,options:{[REMOTE_COUCHDB]:"CouchDB",[REMOTE_MINIO]:"Minio,S3,R2"},onUpdate:enableOnlySyncDisabled});addPanel(paneEl2,"Minio,S3,R2",void 0,onlyOnMinIO).then((paneEl3=>{const syncWarnMinio=this.createEl(paneEl3,"div",{text:""});import_obsidian.MarkdownRenderer.render(this.plugin.app,"WARNING: This feature is a Work In Progress, so please keep in mind the following:\n- Append only architecture. A rebuild is required to shrink the storage.\n- A bit fragile.\n- When first syncing, all history will be transferred from the remote. Be mindful of data caps and slow speeds.\n- Only differences are synced live.\n\nIf you run into any issues, or have ideas about this feature, please create a issue on GitHub.\nI appreciate you for your great dedication.\n",syncWarnMinio,"/",this.plugin);syncWarnMinio.addClass("op-warn-info");new LiveSyncSetting(paneEl3).autoWireText("endpoint",{holdValue:true});new LiveSyncSetting(paneEl3).autoWireText("accessKey",{holdValue:true});new LiveSyncSetting(paneEl3).autoWireText("secretKey",{holdValue:true,isPassword:true});new LiveSyncSetting(paneEl3).autoWireText("region",{holdValue:true});new LiveSyncSetting(paneEl3).autoWireText("bucket",{holdValue:true});new LiveSyncSetting(paneEl3).autoWireToggle("useCustomRequestHandler",{holdValue:true});new LiveSyncSetting(paneEl3).setName("Test Connection").addButton((button=>button.setButtonText("Test").setDisabled(false).onClick((async()=>{await this.testConnection(this.editingSettings)}))));new LiveSyncSetting(paneEl3).setName("Apply Settings").setClass("wizardHidden").addApplyButton(["remoteType","endpoint","region","accessKey","secretKey","bucket","useCustomRequestHandler"]).addOnUpdate(onlyOnMinIO)}));addPanel(paneEl2,"CouchDB",void 0,onlyOnCouchDB).then((paneEl3=>{if(this.plugin.$$isMobile())this.createEl(paneEl3,"div",{text:"Cannot connect to non-HTTPS URI. Please update your config and try again."},void 0,visibleOnly((()=>!this.editingSettings.couchDB_URI.startsWith("https://")))).addClass("op-warn");else this.createEl(paneEl3,"div",{text:"Configured as non-HTTPS URI. Be warned that this may not work on mobile devices."},void 0,visibleOnly((()=>!this.editingSettings.couchDB_URI.startsWith("https://")))).addClass("op-warn-info");this.createEl(paneEl3,"div",{text:'These settings are unable to be changed during synchronization. Please disable all syncing in the "Sync Settings" to unlock.'},void 0,visibleOnly((()=>isAnySyncEnabled()))).addClass("sls-setting-hidden");new LiveSyncSetting(paneEl3).autoWireText("couchDB_URI",{holdValue:true,onUpdate:enableOnlySyncDisabled});new LiveSyncSetting(paneEl3).autoWireText("couchDB_USER",{holdValue:true,onUpdate:enableOnlySyncDisabled});new LiveSyncSetting(paneEl3).autoWireText("couchDB_PASSWORD",{holdValue:true,isPassword:true,onUpdate:enableOnlySyncDisabled});new LiveSyncSetting(paneEl3).autoWireText("couchDB_DBNAME",{holdValue:true,onUpdate:enableOnlySyncDisabled});new LiveSyncSetting(paneEl3).setName("Test Database Connection").setClass("wizardHidden").setDesc("Open database connection. If the remote database is not found and you have permission to create a database, the database will be created.").addButton((button=>button.setButtonText("Test").setDisabled(false).onClick((async()=>{await this.testConnection()}))));new LiveSyncSetting(paneEl3).setName("Validate Database Configuration").setDesc("Checks and fixes any potential issues with the database config.").addButton((button=>button.setButtonText("Check").setDisabled(false).onClick((async()=>{await checkConfig(checkResultDiv)}))));checkResultDiv=this.createEl(paneEl3,"div",{text:""});new LiveSyncSetting(paneEl3).setName("Apply Settings").setClass("wizardHidden").addApplyButton(["remoteType","couchDB_URI","couchDB_USER","couchDB_PASSWORD","couchDB_DBNAME"]).addOnUpdate(onlyOnCouchDB)}))}));addPanel(paneEl,"Notification").then((paneEl2=>{paneEl2.addClass("wizardHidden");new LiveSyncSetting(paneEl2).autoWireNumeric("notifyThresholdOfRemoteStorageSize",{}).setClass("wizardHidden")}));addPanel(paneEl,"Privacy & Encryption").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireToggle("encrypt",{holdValue:true});const isEncryptEnabled=visibleOnly((()=>this.isConfiguredAs("encrypt",true)));new LiveSyncSetting(paneEl2).autoWireText("passphrase",{holdValue:true,isPassword:true,onUpdate:isEncryptEnabled});new LiveSyncSetting(paneEl2).autoWireToggle("usePathObfuscation",{holdValue:true,onUpdate:isEncryptEnabled});new LiveSyncSetting(paneEl2).autoWireToggle("useDynamicIterationCount",{holdValue:true,onUpdate:isEncryptEnabled}).setClass("wizardHidden")}));addPanel(paneEl,"Fetch settings").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Fetch config from remote server").setDesc("Fetch necessary settings from already configured remote server.").addButton((button=>button.setButtonText("Fetch").setDisabled(false).onClick((async()=>{const trialSetting={...this.initialSettings,...this.editingSettings},newTweaks=await this.plugin.$$checkAndAskUseRemoteConfiguration(trialSetting);if(false!==newTweaks.result){this.editingSettings={...this.editingSettings,...newTweaks.result};this.requestUpdate()}}))))}));new LiveSyncSetting(paneEl).setClass("wizardOnly").addButton((button=>button.setButtonText("Next").setCta().setDisabled(false).onClick((async()=>{if(!await checkConfig(checkResultDiv))if("no"==await this.plugin.confirm.askYesNoDialog("The configuration check has failed. Do you want to continue anyway?",{defaultOption:"No",title:"Remote Configuration Check Failed"}))return;if(!this.editingSettings.encrypt||!this.editingSettings.usePathObfuscation)if("no"==await this.plugin.confirm.askYesNoDialog("We recommend enabling End-To-End Encryption, and Path Obfuscation. Are you sure you want to continue without encryption?",{defaultOption:"No",title:"Encryption is not enabled"}))return;if(!this.editingSettings.encrypt)this.editingSettings.passphrase="";if(!await isPassphraseValid())if("no"==await this.plugin.confirm.askYesNoDialog("Your encryption passphrase might be invalid. Are you sure you want to continue?",{defaultOption:"No",title:"Encryption Passphrase Invalid?"}))return;if(isCloudantURI(this.editingSettings.couchDB_URI))this.editingSettings={...this.editingSettings,...PREFERRED_SETTING_CLOUDANT};else if(this.editingSettings.remoteType==REMOTE_MINIO)this.editingSettings={...this.editingSettings,...PREFERRED_JOURNAL_SYNC};else this.editingSettings={...this.editingSettings,...PREFERRED_SETTING_SELF_HOSTED};if("yes"==await this.plugin.confirm.askYesNoDialog("Do you want to fetch the config from the remote server?",{defaultOption:"Yes",title:"Fetch config"})){const trialSetting={...this.initialSettings,...this.editingSettings},newTweaks=await this.plugin.$$checkAndAskUseRemoteConfiguration(trialSetting);if(false!==newTweaks.result){this.editingSettings={...this.editingSettings,...newTweaks.result};this.requestUpdate()}}changeDisplay("30")}))))}));addPane(containerEl,"Sync Settings","",30,false).then((paneEl=>{if(""!=this.editingSettings.versionUpFlash){const c2=this.createEl(paneEl,"div",{text:this.editingSettings.versionUpFlash,cls:"op-warn sls-setting-hidden"},(el=>{this.createEl(el,"button",{text:"I got it and updated."},(e4=>{e4.addClass("mod-cta");e4.addEventListener("click",(()=>{fireAndForget((async()=>{this.editingSettings.versionUpFlash="";await this.saveAllDirtySettings();c2.remove()}))}))}))}),visibleOnly((()=>!this.isConfiguredAs("versionUpFlash",""))))}this.createEl(paneEl,"div",{text:"Please select and apply any preset item to complete the wizard.",cls:"wizardOnly"}).addClasses(["op-warn-info"]);addPanel(paneEl,"Synchronization Preset").then((paneEl2=>{const options=this.editingSettings.remoteType==REMOTE_COUCHDB?{NONE:"",LIVESYNC:"LiveSync",PERIODIC:"Periodic w/ batch",DISABLE:"Disable all automatic"}:{NONE:"",PERIODIC:"Periodic w/ batch",DISABLE:"Disable all automatic"};new LiveSyncSetting(paneEl2).autoWireDropDown("preset",{options,holdValue:true}).addButton((button=>{button.setButtonText("Apply");button.onClick((async()=>{await this.saveAllDirtySettings()}))}));this.addOnSaved("preset",(async currentPreset=>{if(""==currentPreset){Logger("Select any preset.",LOG_LEVEL_NOTICE);return}const presetAllDisabled={batchSave:false,liveSync:false,periodicReplication:false,syncOnSave:false,syncOnEditorSave:false,syncOnStart:false,syncOnFileOpen:false,syncAfterMerge:false},presetLiveSync={...presetAllDisabled,liveSync:true},presetPeriodic={...presetAllDisabled,batchSave:true,periodicReplication:true,syncOnSave:false,syncOnEditorSave:false,syncOnStart:true,syncOnFileOpen:true,syncAfterMerge:true};if("LIVESYNC"==currentPreset){this.editingSettings={...this.editingSettings,...presetLiveSync};Logger("Configured synchronization mode: LiveSync",LOG_LEVEL_NOTICE)}else if("PERIODIC"==currentPreset){this.editingSettings={...this.editingSettings,...presetPeriodic};Logger("Configured synchronization mode: Periodic",LOG_LEVEL_NOTICE)}else{Logger("Configured synchronization mode: DISABLED",LOG_LEVEL_NOTICE);this.editingSettings={...this.editingSettings,...presetAllDisabled}}if(this.inWizard){this.closeSetting();this.inWizard=false;if(!this.editingSettings.isConfigured){this.editingSettings.isConfigured=true;await this.saveAllDirtySettings();await this.plugin.$$realizeSettingSyncMode();await rebuildDB("localOnly");if("yes"==await this.plugin.confirm.askYesNoDialog("All done! Do you want to generate a setup URI to set up other devices?",{defaultOption:"Yes",title:"Congratulations!"}))eventHub.emitEvent(EVENT_REQUEST_COPY_SETUP_URI)}else if(isNeedRebuildLocal()||isNeedRebuildRemote())await confirmRebuild();else{await this.saveAllDirtySettings();await this.plugin.$$realizeSettingSyncMode();this.plugin.$$askReload()}}else{await this.saveAllDirtySettings();await this.plugin.$$realizeSettingSyncMode()}}))}));addPanel(paneEl,"Synchronization Method").then((paneEl2=>{paneEl2.addClass("wizardHidden");const onlyOnNonLiveSync=visibleOnly((()=>!this.isConfiguredAs("syncMode","LIVESYNC"))),onlyOnPeriodic=visibleOnly((()=>this.isConfiguredAs("syncMode","PERIODIC"))),optionsSyncMode=this.editingSettings.remoteType==REMOTE_COUCHDB?{ONEVENTS:"On events",PERIODIC:"Periodic and on events",LIVESYNC:"LiveSync"}:{ONEVENTS:"On events",PERIODIC:"Periodic and on events"};new LiveSyncSetting(paneEl2).autoWireDropDown("syncMode",{options:optionsSyncMode}).setClass("wizardHidden");this.addOnSaved("syncMode",(async value=>{this.editingSettings.liveSync=false;this.editingSettings.periodicReplication=false;if("LIVESYNC"==value)this.editingSettings.liveSync=true;else if("PERIODIC"==value)this.editingSettings.periodicReplication=true;await this.saveSettings(["liveSync","periodicReplication"]);await this.plugin.$$realizeSettingSyncMode()}));new LiveSyncSetting(paneEl2).autoWireNumeric("periodicReplicationInterval",{clampMax:5e3,onUpdate:onlyOnPeriodic}).setClass("wizardHidden");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("syncOnSave",{onUpdate:onlyOnNonLiveSync});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("syncOnEditorSave",{onUpdate:onlyOnNonLiveSync});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("syncOnFileOpen",{onUpdate:onlyOnNonLiveSync});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("syncOnStart",{onUpdate:onlyOnNonLiveSync});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("syncAfterMerge",{onUpdate:onlyOnNonLiveSync})}));addPanel(paneEl,"Update thinning").then((paneEl2=>{paneEl2.addClass("wizardHidden");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("batchSave");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireNumeric("batchSaveMinimumDelay",{acceptZero:true,onUpdate:visibleOnly((()=>this.isConfiguredAs("batchSave",true)))});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireNumeric("batchSaveMaximumDelay",{acceptZero:true,onUpdate:visibleOnly((()=>this.isConfiguredAs("batchSave",true)))})}));addPanel(paneEl,"Deletion Propagation",void 0,void 0,LEVEL_ADVANCED).then((paneEl2=>{paneEl2.addClass("wizardHidden");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("trashInsteadDelete");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("doNotDeleteFolder")}));addPanel(paneEl,"Conflict resolution",void 0,void 0,LEVEL_ADVANCED).then((paneEl2=>{paneEl2.addClass("wizardHidden");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("resolveConflictsByNewerFile");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("checkConflictOnlyOnOpen");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("showMergeDialogOnlyOnActive")}));addPanel(paneEl,"Sync settings via markdown",void 0,void 0,LEVEL_ADVANCED).then((paneEl2=>{paneEl2.addClass("wizardHidden");new LiveSyncSetting(paneEl2).autoWireText("settingSyncFile",{holdValue:true}).addApplyButton(["settingSyncFile"]);new LiveSyncSetting(paneEl2).autoWireToggle("writeCredentialsForSettingSync");new LiveSyncSetting(paneEl2).autoWireToggle("notifyAllSettingSyncFile")}));addPanel(paneEl,"Hidden Files",void 0,void 0,LEVEL_ADVANCED).then((paneEl2=>{paneEl2.addClass("wizardHidden");new LiveSyncSetting(paneEl2).setName("Hidden file synchronization").setClass("wizardHidden").settingEl.createDiv("").innerText=this.editingSettings.syncInternalFiles?" : Enabled":" : Disabled";if(this.editingSettings.syncInternalFiles)new LiveSyncSetting(paneEl2).setName("Disable Hidden files sync").setClass("wizardHidden").addButton((button=>{button.setButtonText("Disable").onClick((async()=>{this.editingSettings.syncInternalFiles=false;await this.saveAllDirtySettings();this.display()}))}));else new LiveSyncSetting(paneEl2).setName("Enable Hidden files sync").setClass("wizardHidden").addButton((button=>{button.setButtonText("Merge").onClick((async()=>{this.closeSetting();await this.plugin.$anyConfigureOptionalSyncFeature("MERGE")}))})).addButton((button=>{button.setButtonText("Fetch").onClick((async()=>{this.closeSetting();await this.plugin.$anyConfigureOptionalSyncFeature("FETCH")}))})).addButton((button=>{button.setButtonText("Overwrite").onClick((async()=>{this.closeSetting();await this.plugin.$anyConfigureOptionalSyncFeature("OVERWRITE")}))}));new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("syncInternalFilesBeforeReplication",{onUpdate:visibleOnly((()=>this.isConfiguredAs("watchInternalFileChanges",true)))});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireNumeric("syncInternalFilesInterval",{clampMin:10,acceptZero:true})}))}));addPane(containerEl,"Selector","",33,false,LEVEL_ADVANCED).then((paneEl=>{addPanel(paneEl,"Normal Files").then((paneEl2=>{paneEl2.addClass("wizardHidden");const syncFilesSetting=new LiveSyncSetting(paneEl2).setName("Synchronising files").setDesc("(RegExp) Empty to sync all files. Set filter as a regular expression to limit synchronising files.").setClass("wizardHidden");new MultipleRegExpControl_default({target:syncFilesSetting.controlEl,props:{patterns:this.editingSettings.syncOnlyRegEx.split("|[]|"),originals:[...this.editingSettings.syncOnlyRegEx.split("|[]|")],apply:async newPatterns=>{this.editingSettings.syncOnlyRegEx=newPatterns.map((e4=>e4.trim())).filter((e4=>""!=e4)).join("|[]|");await this.saveAllDirtySettings();this.display()}}});const nonSyncFilesSetting=new LiveSyncSetting(paneEl2).setName("Non-Synchronising files").setDesc("(RegExp) If this is set, any changes to local and remote files that match this will be skipped.").setClass("wizardHidden");new MultipleRegExpControl_default({target:nonSyncFilesSetting.controlEl,props:{patterns:this.editingSettings.syncIgnoreRegEx.split("|[]|"),originals:[...this.editingSettings.syncIgnoreRegEx.split("|[]|")],apply:async newPatterns=>{this.editingSettings.syncIgnoreRegEx=newPatterns.map((e4=>e4.trim())).filter((e4=>""!=e4)).join("|[]|");await this.saveAllDirtySettings();this.display()}}});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireNumeric("syncMaxSizeInMB",{clampMin:0});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("useIgnoreFiles");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireTextArea("ignoreFiles",{onUpdate:visibleOnly((()=>this.isConfiguredAs("useIgnoreFiles",true)))})}));addPanel(paneEl,"Hidden Files",void 0,void 0,LEVEL_ADVANCED).then((paneEl2=>{const defaultSkipPattern="\\/node_modules\\/, \\/\\.git\\/, ^\\.git\\/, \\/obsidian-livesync\\/",defaultSkipPatternXPlat=defaultSkipPattern+",\\/workspace$ ,\\/workspace.json$,\\/workspace-mobile.json$",pat=this.editingSettings.syncInternalFilesIgnorePatterns.split(",").map((x2=>x2.trim())).filter((x2=>""!=x2)),patSetting=new LiveSyncSetting(paneEl2).setName("Ignore patterns").setClass("wizardHidden").setDesc("");new MultipleRegExpControl_default({target:patSetting.controlEl,props:{patterns:pat,originals:[...pat],apply:async newPatterns=>{this.editingSettings.syncInternalFilesIgnorePatterns=newPatterns.map((e4=>e4.trim())).filter((e4=>""!=e4)).join(", ");await this.saveAllDirtySettings();this.display()}}});const addDefaultPatterns=async patterns=>{const oldList=this.editingSettings.syncInternalFilesIgnorePatterns.split(",").map((x2=>x2.trim())).filter((x2=>""!=x2)),newList=patterns.split(",").map((x2=>x2.trim())).filter((x2=>""!=x2)),allSet=new Set([...oldList,...newList]);this.editingSettings.syncInternalFilesIgnorePatterns=[...allSet].join(", ");await this.saveAllDirtySettings();this.display()};new LiveSyncSetting(paneEl2).setName("Add default patterns").setClass("wizardHidden").addButton((button=>{button.setButtonText("Default").onClick((async()=>{await addDefaultPatterns(defaultSkipPattern)}))})).addButton((button=>{button.setButtonText("Cross-platform").onClick((async()=>{await addDefaultPatterns(defaultSkipPatternXPlat)}))}))}))}));addPane(containerEl,"Customization sync","",60,false,LEVEL_ADVANCED).then((paneEl=>{addPanel(paneEl,"Customization Sync").then((paneEl2=>{const enableOnlyOnPluginSyncIsNotEnabled=enableOnly((()=>this.isConfiguredAs("usePluginSync",false))),visibleOnlyOnPluginSyncEnabled=visibleOnly((()=>this.isConfiguredAs("usePluginSync",true)));this.createEl(paneEl2,"div",{text:"Please set device name to identify this device. This name should be unique among your devices. While not configured, we cannot enable this feature.",cls:"op-warn"},(c2=>{}),visibleOnly((()=>this.isConfiguredAs("deviceAndVaultName",""))));this.createEl(paneEl2,"div",{text:"We cannot change the device name while this feature is enabled. Please disable this feature to change the device name.",cls:"op-warn-info"},(c2=>{}),visibleOnly((()=>this.isConfiguredAs("usePluginSync",true))));new LiveSyncSetting(paneEl2).autoWireText("deviceAndVaultName",{placeHolder:"desktop",onUpdate:enableOnlyOnPluginSyncIsNotEnabled});new LiveSyncSetting(paneEl2).autoWireToggle("usePluginSyncV2");new LiveSyncSetting(paneEl2).autoWireToggle("usePluginSync",{onUpdate:enableOnly((()=>!this.isConfiguredAs("deviceAndVaultName","")))});new LiveSyncSetting(paneEl2).autoWireToggle("autoSweepPlugins",{onUpdate:visibleOnlyOnPluginSyncEnabled});new LiveSyncSetting(paneEl2).autoWireToggle("autoSweepPluginsPeriodic",{onUpdate:visibleOnly((()=>this.isConfiguredAs("usePluginSync",true)&&this.isConfiguredAs("autoSweepPlugins",true)))});new LiveSyncSetting(paneEl2).autoWireToggle("notifyPluginOrSettingUpdated",{onUpdate:visibleOnlyOnPluginSyncEnabled});new LiveSyncSetting(paneEl2).setName("Open").setDesc("Open the dialog").addButton((button=>{button.setButtonText("Open").setDisabled(false).onClick((()=>{eventHub.emitEvent(EVENT_REQUEST_OPEN_PLUGIN_SYNC_DIALOG)}))})).addOnUpdate(visibleOnlyOnPluginSyncEnabled)}))}));addPane(containerEl,"Hatch","",50,true).then((paneEl=>{addPanel(paneEl,"Reporting Issue").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Make report to inform the issue").addButton((button=>button.setButtonText("Make report").setCta().setDisabled(false).onClick((async()=>{let responseConfig={};const REDACTED="";if(this.editingSettings.remoteType==REMOTE_COUCHDB)try{const r2=await requestToCouchDB(this.editingSettings.couchDB_URI,this.editingSettings.couchDB_USER,this.editingSettings.couchDB_PASSWORD,window.origin);Logger(JSON.stringify(r2.json,null,2));responseConfig=r2.json;responseConfig["couch_httpd_auth"].secret=REDACTED;responseConfig["couch_httpd_auth"].authentication_db=REDACTED;responseConfig["couch_httpd_auth"].authentication_redirect=REDACTED;responseConfig["couchdb"].uuid=REDACTED;responseConfig["admins"]=REDACTED}catch(ex){Logger(ex,LOG_LEVEL_VERBOSE);responseConfig="Requesting information from the remote CouchDB has failed. If you are using IBM Cloudant, this is normal behaviour."}else if(this.editingSettings.remoteType==REMOTE_MINIO)responseConfig="Object Storage Synchronisation";const pluginConfig=JSON.parse(JSON.stringify(this.editingSettings));pluginConfig.couchDB_DBNAME=REDACTED;pluginConfig.couchDB_PASSWORD=REDACTED;const scheme=pluginConfig.couchDB_URI.startsWith("http:")?"(HTTP)":pluginConfig.couchDB_URI.startsWith("https:")?"(HTTPS)":"";pluginConfig.couchDB_URI=isCloudantURI(pluginConfig.couchDB_URI)?"cloudant":`self-hosted${scheme}`;pluginConfig.couchDB_USER=REDACTED;pluginConfig.passphrase=REDACTED;pluginConfig.encryptedPassphrase=REDACTED;pluginConfig.encryptedCouchDBConnection=REDACTED;pluginConfig.accessKey=REDACTED;pluginConfig.secretKey=REDACTED;pluginConfig.region=`${REDACTED}(${pluginConfig.region.length} letters)`;pluginConfig.bucket=`${REDACTED}(${pluginConfig.bucket.length} letters)`;pluginConfig.pluginSyncExtendedSetting={};const endpoint=pluginConfig.endpoint;if(""==endpoint)pluginConfig.endpoint="Not configured or AWS";else{const endpointScheme=pluginConfig.endpoint.startsWith("http:")?"(HTTP)":pluginConfig.endpoint.startsWith("https:")?"(HTTPS)":"";pluginConfig.endpoint=`${-1!==endpoint.indexOf(".r2.cloudflarestorage.")?"R2":"self-hosted?"}(${endpointScheme})`}const msgConfig=`---- Obsidian info ----\nNavigator: ${navigator.userAgent}\nFileSystem: ${this.plugin.$$isStorageInsensitive()?"insensitive":"sensitive"}\n---- remote config ----\n${(0,import_obsidian.stringifyYaml)(responseConfig)}\n---- Plug-in config ---\nversion:0.24.3\n${(0,import_obsidian.stringifyYaml)(pluginConfig)}`;console.log(msgConfig);await navigator.clipboard.writeText(msgConfig);Logger("Information has been copied to clipboard",LOG_LEVEL_NOTICE)}))));new LiveSyncSetting(paneEl2).autoWireToggle("writeLogToTheFile")}));addPanel(paneEl,"Scram Switches").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireToggle("suspendFileWatching");this.addOnSaved("suspendFileWatching",(()=>this.plugin.$$askReload()));new LiveSyncSetting(paneEl2).autoWireToggle("suspendParseReplicationResult");this.addOnSaved("suspendParseReplicationResult",(()=>this.plugin.$$askReload()))}));addPanel(paneEl,"Recovery and Repair").then((paneEl2=>{const addResult=async(path2,file,fileOnDB)=>{const storageFileStat=file?await this.plugin.storageAccess.statHidden(file):null;resultArea.appendChild(this.createEl(resultArea,"div",{},(el=>{el.appendChild(this.createEl(el,"h6",{text:path2}));el.appendChild(this.createEl(el,"div",{},(infoGroupEl=>{infoGroupEl.appendChild(this.createEl(infoGroupEl,"div",{text:"Storage : Modified: "+(!storageFileStat?"Missing:":`${new Date(storageFileStat.mtime).toLocaleString()}, Size:${storageFileStat.size}`)}));infoGroupEl.appendChild(this.createEl(infoGroupEl,"div",{text:"Database: Modified: "+(!fileOnDB?"Missing:":`${new Date(fileOnDB.mtime).toLocaleString()}, Size:${fileOnDB.size}`)}))})));if(fileOnDB&&file)el.appendChild(this.createEl(el,"button",{text:"Show history"},(buttonEl=>{buttonEl.onClickEvent((()=>{eventHub.emitEvent(EVENT_REQUEST_SHOW_HISTORY,{file,fileOnDB})}))})));if(file)el.appendChild(this.createEl(el,"button",{text:"Storage -> Database"},(buttonEl=>{buttonEl.onClickEvent((async()=>{if(file.startsWith(".")){const addOn=this.plugin.getAddOn(HiddenFileSync.name);if(addOn){const file2=(await addOn.scanInternalFiles()).find((e4=>e4.path==path2));if(!file2){Logger(`Failed to find the file in the internal files: ${path2}`,LOG_LEVEL_NOTICE);return}if(!await addOn.storeInternalFileToDatabase(file2,true)){Logger(`Failed to store the file to the database (Hidden file): ${file2}`,LOG_LEVEL_NOTICE);return}}}else if(!await this.plugin.fileHandler.storeFileToDB(file,true)){Logger(`Failed to store the file to the database: ${file}`,LOG_LEVEL_NOTICE);return}el.remove()}))})));if(fileOnDB)el.appendChild(this.createEl(el,"button",{text:"Database -> Storage"},(buttonEl=>{buttonEl.onClickEvent((async()=>{if(fileOnDB.path.startsWith(ICHeader)){const addOn=this.plugin.getAddOn(HiddenFileSync.name);if(addOn)if(!await addOn.extractInternalFileFromDatabase(path2,true)){Logger(`Failed to store the file to the database (Hidden file): ${file}`,LOG_LEVEL_NOTICE);return}}else if(!await this.plugin.fileHandler.dbToStorage(fileOnDB,null,true)){Logger(`Failed to store the file to the storage: ${fileOnDB.path}`,LOG_LEVEL_NOTICE);return}el.remove()}))})));return el})))},checkBetweenStorageAndDatabase=async(file,fileOnDB)=>{const dataContent=readAsBlob(fileOnDB),content=createBlob(await this.plugin.storageAccess.readHiddenFileBinary(file));if(await isDocContentSame(content,dataContent))Logger(`Compare: SAME: ${file}`);else{Logger(`Compare: CONTENT IS NOT MATCHED! ${file}`,LOG_LEVEL_NOTICE);addResult(file,file,fileOnDB)}};new LiveSyncSetting(paneEl2).setName("Recreate missing chunks for all files").setDesc("This will recreate chunks for all files. If there were missing chunks, this may fix the errors.").addButton((button=>button.setButtonText("Recreate all").setCta().onClick((async()=>{await this.plugin.fileHandler.createAllChunks(true)}))));new LiveSyncSetting(paneEl2).setName("Resolve All conflicted files by the newer one").setDesc("Resolve all conflicted files by the newer one. Caution: This will overwrite the older one, and cannot resurrect the overwritten one.").addButton((button=>button.setButtonText("Resolve All").setCta().onClick((async()=>{await this.plugin.rebuilder.resolveAllConflictedFilesByNewerOnes()}))));new LiveSyncSetting(paneEl2).setName("Verify and repair all files").setDesc("Compare the content of files between on local database and storage. If not matched, you will be asked which one you want to keep.").addButton((button=>button.setButtonText("Verify all").setDisabled(false).setCta().onClick((async()=>{Logger("Start verifying all files",LOG_LEVEL_NOTICE,"verify");const ignorePatterns=this.plugin.settings.syncInternalFilesIgnorePatterns.replace(/\n| /g,"").split(",").filter((e4=>e4)).map((e4=>new RegExp(e4,"i")));this.plugin.localDatabase.hashCaches.clear();Logger("Start verifying all files",LOG_LEVEL_NOTICE,"verify");const files=this.plugin.settings.syncInternalFiles?await this.plugin.storageAccess.getFilesIncludeHidden("/",void 0,ignorePatterns):await this.plugin.storageAccess.getFileNames(),documents=[],adn=this.plugin.localDatabase.findAllDocs();for await(const i3 of adn){const path2=getPath2(i3);if(!path2.startsWith(ICXHeader))if(!path2.startsWith(PSCHeader))if(this.plugin.settings.syncInternalFiles||!path2.startsWith(ICHeader))documents.push(stripAllPrefixes(path2))}const allPaths=[...new Set([...documents,...files])];let i2=0;const incProc=()=>{i2++;if(i2%25==0)Logger(`Checking ${i2}/${files.length} files \n`,LOG_LEVEL_NOTICE,"verify-processed")},semaphore=Semaphore(10),processes=allPaths.map((async path2=>{try{if(shouldBeIgnored(path2))return incProc();const stat=await this.plugin.storageAccess.isExistsIncludeHidden(path2)?await this.plugin.storageAccess.statHidden(path2):false,fileOnStorage=null!=stat?stat:false;if(!await this.plugin.$$isTargetFile(path2))return incProc();const releaser=await semaphore.acquire(1);if(fileOnStorage&&this.plugin.$$isFileSizeExceeded(fileOnStorage.size))return incProc();try{const dbPath=path2.startsWith(".")?addPrefix(path2,ICHeader):path2,fileOnDB=await this.plugin.localDatabase.getDBEntry(dbPath);if(fileOnDB&&this.plugin.$$isFileSizeExceeded(fileOnDB.size))return incProc();if(!fileOnDB&&fileOnStorage){Logger(`Compare: Not found on the local database: ${path2}`,LOG_LEVEL_NOTICE);addResult(path2,path2,false);return incProc()}if(fileOnDB&&!fileOnStorage){Logger(`Compare: Not found on the storage: ${path2}`,LOG_LEVEL_NOTICE);addResult(path2,false,fileOnDB);return incProc()}if(fileOnStorage&&fileOnDB)await checkBetweenStorageAndDatabase(path2,fileOnDB)}catch(ex){Logger(`Error while processing ${path2}`,LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE)}finally{releaser();incProc()}}catch(ex){Logger(`Error while processing without semaphore ${path2}`,LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE)}}));await Promise.all(processes);Logger("done",LOG_LEVEL_NOTICE,"verify")}))));const resultArea=paneEl2.createDiv({text:""});new LiveSyncSetting(paneEl2).setName("Check and convert non-path-obfuscated files").setDesc("").addButton((button=>button.setButtonText("Perform").setDisabled(false).setWarning().onClick((async()=>{var _a5,_b2,_c2;for await(const docName of this.plugin.localDatabase.findAllDocNames())if(!docName.startsWith("f:")){const idEncoded=await this.plugin.$$path2id(docName),doc=await this.plugin.localDatabase.getRaw(docName);if(!doc)continue;if("newnote"!=doc.type&&"plain"!=doc.type)continue;if(null!=(_a5=null==doc?void 0:doc.deleted)?_a5:false)continue;const newDoc={...doc};newDoc._id=idEncoded;newDoc.path=docName;delete newDoc._rev;try{const obfuscatedDoc=await this.plugin.localDatabase.getRaw(idEncoded,{revs_info:true});null==(_b2=obfuscatedDoc._revs_info)||_b2.shift();const previousRev=null==(_c2=obfuscatedDoc._revs_info)?void 0:_c2.shift();if(previousRev)newDoc._rev=previousRev.rev;else newDoc._rev="1-"+`00000000000000000000000000000000${~~(1e9*Math.random())}${~~(1e9*Math.random())}${~~(1e9*Math.random())}${~~(1e9*Math.random())}`.slice(-32);const ret=await this.plugin.localDatabase.putRaw(newDoc,{force:true});if(ret.ok){Logger(`${docName} has been converted as conflicted document`,LOG_LEVEL_NOTICE);doc._deleted=true;if((await this.plugin.localDatabase.putRaw(doc)).ok)Logger(`Old ${docName} has been deleted`,LOG_LEVEL_NOTICE);await this.plugin.$$queueConflictCheckIfOpen(docName)}else{Logger(`Converting ${docName} Failed!`,LOG_LEVEL_NOTICE);Logger(ret,LOG_LEVEL_VERBOSE)}}catch(ex){if(404==(null==ex?void 0:ex.status)){if((await this.plugin.localDatabase.putRaw(newDoc)).ok){Logger(`${docName} has been converted`,LOG_LEVEL_NOTICE);doc._deleted=true;if((await this.plugin.localDatabase.putRaw(doc)).ok)Logger(`Old ${docName} has been deleted`,LOG_LEVEL_NOTICE)}}else{Logger(`Something went wrong while converting ${docName}`,LOG_LEVEL_NOTICE);Logger(ex,LOG_LEVEL_VERBOSE)}}}Logger("Converting finished",LOG_LEVEL_NOTICE)}))))}));addPanel(paneEl,"Reset").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Back to non-configured").addButton((button=>button.setButtonText("Back").setDisabled(false).onClick((async()=>{this.editingSettings.isConfigured=false;await this.saveAllDirtySettings();this.plugin.$$askReload()}))));new LiveSyncSetting(paneEl2).setName("Delete all customization sync data").addButton((button=>button.setButtonText("Delete").setDisabled(false).setWarning().onClick((async()=>{Logger("Deleting customization sync data",LOG_LEVEL_NOTICE);const newData=(await this.plugin.localDatabase.allDocsRaw({startkey:"ix:",endkey:"ix:",include_docs:true})).rows.map((e4=>({...e4.doc,_deleted:true})));Logger(`${(await this.plugin.localDatabase.bulkDocsRaw(newData)).length} items have been removed, to confirm how many items are left, please perform it again.`,LOG_LEVEL_NOTICE)}))))}))}));addPane(containerEl,"Advanced","",46,false,LEVEL_ADVANCED).then((paneEl=>{addPanel(paneEl,"Memory cache").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireNumeric("hashCacheMaxCount",{clampMin:10});new LiveSyncSetting(paneEl2).autoWireNumeric("hashCacheMaxAmount",{clampMin:1})}));addPanel(paneEl,"Local Database Tweak").then((paneEl2=>{paneEl2.addClass("wizardHidden");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireNumeric("customChunkSize",{clampMin:0});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("enableChunkSplitterV2",{onUpdate:enableOnly((()=>this.isConfiguredAs("useSegmenter",false)))});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("useSegmenter",{onUpdate:enableOnly((()=>this.isConfiguredAs("enableChunkSplitterV2",false)))})}));addPanel(paneEl,"Transfer Tweak").then((paneEl2=>{new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("readChunksOnline",{onUpdate:onlyOnCouchDB});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireNumeric("concurrencyOfReadChunksOnline",{clampMin:10,onUpdate:onlyOnCouchDB});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireNumeric("minimumIntervalOfReadChunksOnline",{clampMin:10,onUpdate:onlyOnCouchDB})}))}));addPane(containerEl,"Power users","",47,true,LEVEL_POWER_USER).then((paneEl=>{addPanel(paneEl,"Remote Database Tweak").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireToggle("useEden").setClass("wizardHidden");const onlyUsingEden=visibleOnly((()=>this.isConfiguredAs("useEden",true)));new LiveSyncSetting(paneEl2).autoWireNumeric("maxChunksInEden",{onUpdate:onlyUsingEden}).setClass("wizardHidden");new LiveSyncSetting(paneEl2).autoWireNumeric("maxTotalLengthInEden",{onUpdate:onlyUsingEden}).setClass("wizardHidden");new LiveSyncSetting(paneEl2).autoWireNumeric("maxAgeInEden",{onUpdate:onlyUsingEden}).setClass("wizardHidden");new LiveSyncSetting(paneEl2).autoWireToggle("enableCompression").setClass("wizardHidden")}));addPanel(paneEl,"CouchDB Connection Tweak",void 0,onlyOnCouchDB).then((paneEl2=>{paneEl2.addClass("wizardHidden");this.createEl(paneEl2,"div",{text:"If you reached the payload size limit when using IBM Cloudant, please decrease batch size and batch limit to a lower value."},void 0,onlyOnCouchDB).addClass("wizardHidden");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireNumeric("batch_size",{clampMin:2,onUpdate:onlyOnCouchDB});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireNumeric("batches_limit",{clampMin:2,onUpdate:onlyOnCouchDB});new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("useTimeouts",{onUpdate:onlyOnCouchDB})}));addPanel(paneEl,"Configuration Encryption").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Encrypting sensitive configuration items").autoWireDropDown("configPassphraseStore",{options:{"":"Default",LOCALSTORAGE:"Use a custom passphrase",ASK_AT_LAUNCH:"Ask an passphrase at every launch"},holdValue:true}).setClass("wizardHidden");new LiveSyncSetting(paneEl2).autoWireText("configPassphrase",{isPassword:true,holdValue:true}).setClass("wizardHidden").addOnUpdate((()=>({disabled:!this.isConfiguredAs("configPassphraseStore","LOCALSTORAGE")})));new LiveSyncSetting(paneEl2).addApplyButton(["configPassphrase","configPassphraseStore"]).setClass("wizardHidden")}));addPanel(paneEl,"Developer").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireToggle("enableDebugTools").setClass("wizardHidden")}))}));addPane(containerEl,"Patches","",51,false,LEVEL_EDGE_CASE).then((paneEl=>{addPanel(paneEl,"Compatibility (Metadata)").then((paneEl2=>{new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("deleteMetadataOfDeletedFiles");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireNumeric("automaticallyDeleteMetadataOfDeletedFiles",{onUpdate:visibleOnly((()=>this.isConfiguredAs("deleteMetadataOfDeletedFiles",true)))})}));addPanel(paneEl,"Compatibility (Conflict Behaviour)").then((paneEl2=>{paneEl2.addClass("wizardHidden");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("disableMarkdownAutoMerge");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("writeDocumentsIfConflicted")}));addPanel(paneEl,"Compatibility (Database structure)").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireToggle("useIndexedDBAdapter",{invert:true,holdValue:true});new LiveSyncSetting(paneEl2).autoWireToggle("doNotUseFixedRevisionForChunks",{holdValue:true}).setClass("wizardHidden");new LiveSyncSetting(paneEl2).autoWireToggle("handleFilenameCaseSensitive",{holdValue:true}).setClass("wizardHidden");this.addOnSaved("useIndexedDBAdapter",(async()=>{await this.saveAllDirtySettings();await rebuildDB("localOnly")}))}));addPanel(paneEl,"Compatibility (Internal API Usage)").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireToggle("watchInternalFileChanges",{invert:true})}));addPanel(paneEl,"Edge case addressing (Database)").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireText("additionalSuffixOfDatabaseName",{holdValue:true}).addApplyButton(["additionalSuffixOfDatabaseName"]);this.addOnSaved("additionalSuffixOfDatabaseName",(async key2=>{Logger("Suffix has been changed. Reopening database...",LOG_LEVEL_NOTICE);await this.plugin.$$initializeDatabase()}));new LiveSyncSetting(paneEl2).autoWireDropDown("hashAlg",{options:{"":"Old Algorithm",xxhash32:"xxhash32 (Fast)",xxhash64:"xxhash64 (Fastest)",sha1:"Fallback (Without WebAssembly)"}});this.addOnSaved("hashAlg",(async()=>{await this.plugin.localDatabase._prepareHashFunctions()}))}));addPanel(paneEl,"Edge case addressing (Behaviour)").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireToggle("doNotSuspendOnFetching");new LiveSyncSetting(paneEl2).setClass("wizardHidden").autoWireToggle("doNotDeleteFolder")}));addPanel(paneEl,"Edge case addressing (Processing)").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireToggle("disableWorkerForGeneratingChunks");new LiveSyncSetting(paneEl2).autoWireToggle("processSmallFilesInUIThread",{onUpdate:visibleOnly((()=>this.isConfiguredAs("disableWorkerForGeneratingChunks",false)))})}));addPanel(paneEl,"Compatibility (Trouble addressed)").then((paneEl2=>{new LiveSyncSetting(paneEl2).autoWireToggle("disableCheckingConfigMismatch")}))}));addPane(containerEl,"Maintenance","",70,true).then((paneEl=>{this.createEl(paneEl,"div",{text:"The remote database is locked for synchronization to prevent vault corruption because this device isn't marked as 'resolved'. Please backup your vault, reset the local database, and select 'Mark this device as resolved'. This warning will persist until the device is confirmed as resolved by replication.",cls:"op-warn"},(c2=>{this.createEl(c2,"button",{text:"I've made a backup, mark this device 'resolved'",cls:"mod-warning"},(e4=>{e4.addEventListener("click",(()=>{fireAndForget((async()=>{await this.plugin.$$markRemoteResolved();this.display()}))}))}))}),visibleOnly((()=>{var _a5,_b2;return null==(_b2=null==(_a5=this.plugin)?void 0:_a5.replicator)?void 0:_b2.remoteLockedAndDeviceNotAccepted})));this.createEl(paneEl,"div",{text:"To prevent unwanted vault corruption, the remote database has been locked for synchronization. (This device is marked 'resolved') When all your devices are marked 'resolved', unlock the database. This warning kept showing until confirming the device is resolved by the replication",cls:"op-warn"},(c2=>this.createEl(c2,"button",{text:"I'm ready, unlock the database",cls:"mod-warning"},(e4=>{e4.addEventListener("click",(()=>{fireAndForget((async()=>{await this.plugin.$$markRemoteUnlocked();this.display()}))}))}))),visibleOnly((()=>{var _a5,_b2;return null==(_b2=null==(_a5=this.plugin)?void 0:_a5.replicator)?void 0:_b2.remoteLocked})));addPanel(paneEl,"Scram!").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Lock Server").setDesc("Lock the remote server to prevent synchronization with other devices.").addButton((button=>button.setButtonText("Lock").setDisabled(false).setWarning().onClick((async()=>{await this.plugin.$$markRemoteLocked()}))));new LiveSyncSetting(paneEl2).setName("Emergency restart").setDesc("Disables all synchronization and restart.").addButton((button=>button.setButtonText("Flag and restart").setDisabled(false).setWarning().onClick((async()=>{await this.plugin.storageAccess.writeFileAuto(FLAGMD_REDFLAG,"");this.plugin.$$performRestart()}))))}));addPanel(paneEl,"Syncing").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Resend").setDesc("Resend all chunks to the remote.").addButton((button=>button.setButtonText("Send chunks").setWarning().setDisabled(false).onClick((async()=>{if(this.plugin.replicator instanceof LiveSyncCouchDBReplicator)await this.plugin.replicator.sendChunks(this.plugin.settings,void 0,true,0)})))).addOnUpdate(onlyOnCouchDB);new LiveSyncSetting(paneEl2).setName("Reset journal received history").setDesc("Initialise journal received history. On the next sync, every item except this device sent will be downloaded again.").addButton((button=>button.setButtonText("Reset received").setWarning().setDisabled(false).onClick((async()=>{await this.getMinioJournalSyncClient().updateCheckPointInfo((info3=>({...info3,receivedFiles:new Set,knownIDs:new Set})));Logger("Journal received history has been cleared.",LOG_LEVEL_NOTICE)})))).addOnUpdate(onlyOnMinIO);new LiveSyncSetting(paneEl2).setName("Reset journal sent history").setDesc("Initialise journal sent history. On the next sync, every item except this device received will be sent again.").addButton((button=>button.setButtonText("Reset sent history").setWarning().setDisabled(false).onClick((async()=>{await this.getMinioJournalSyncClient().updateCheckPointInfo((info3=>({...info3,lastLocalSeq:0,sentIDs:new Set,sentFiles:new Set})));Logger("Journal sent history has been cleared.",LOG_LEVEL_NOTICE)})))).addOnUpdate(onlyOnMinIO)}));addPanel(paneEl,"Rebuilding Operations (Local)").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Fetch from remote").setDesc("Restore or reconstruct local database from remote.").addButton((button=>button.setButtonText("Fetch").setWarning().setDisabled(false).onClick((async()=>{await this.plugin.storageAccess.writeFileAuto(FLAGMD_REDFLAG3_HR,"");this.plugin.$$performRestart()})))).addButton((button=>button.setButtonText("Fetch w/o restarting").setWarning().setDisabled(false).onClick((async()=>{await rebuildDB("localOnly")}))));new LiveSyncSetting(paneEl2).setName("Fetch rebuilt DB (Save local documents before)").setDesc("Restore or reconstruct local database from remote database but use local chunks.").addButton((button=>button.setButtonText("Save and Fetch").setWarning().setDisabled(false).onClick((async()=>{await rebuildDB("localOnlyWithChunks")})))).addOnUpdate(onlyOnCouchDB)}));addPanel(paneEl,"Total Overhaul").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Rebuild everything").setDesc("Rebuild local and remote database with local files.").addButton((button=>button.setButtonText("Rebuild").setWarning().setDisabled(false).onClick((async()=>{await this.plugin.storageAccess.writeFileAuto(FLAGMD_REDFLAG2_HR,"");this.plugin.$$performRestart()})))).addButton((button=>button.setButtonText("Rebuild w/o restarting").setWarning().setDisabled(false).onClick((async()=>{await rebuildDB("rebuildBothByThisDevice")}))))}));addPanel(paneEl,"Rebuilding Operations (Remote Only)").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Perform cleanup").setDesc("Reduces storage space by discarding all non-latest revisions. This requires the same amount of free space on the remote server and the local client.").addButton((button=>button.setButtonText("Perform").setDisabled(false).onClick((async()=>{const replicator=this.plugin.replicator;Logger("Cleanup has been began",LOG_LEVEL_NOTICE,"compaction");if(await replicator.compactRemote(this.editingSettings))Logger("Cleanup has been completed!",LOG_LEVEL_NOTICE,"compaction");else Logger("Cleanup has been failed!",LOG_LEVEL_NOTICE,"compaction")})))).addOnUpdate(onlyOnCouchDB);new LiveSyncSetting(paneEl2).setName("Overwrite remote").setDesc("Overwrite remote with local DB and passphrase.").addButton((button=>button.setButtonText("Send").setWarning().setDisabled(false).onClick((async()=>{await rebuildDB("remoteOnly")}))));new LiveSyncSetting(paneEl2).setName("Reset all journal counter").setDesc("Initialise all journal history, On the next sync, every item will be received and sent.").addButton((button=>button.setButtonText("Reset all").setWarning().setDisabled(false).onClick((async()=>{await this.getMinioJournalSyncClient().resetCheckpointInfo();Logger("Journal exchange history has been cleared.",LOG_LEVEL_NOTICE)})))).addOnUpdate(onlyOnMinIO);new LiveSyncSetting(paneEl2).setName("Purge all journal counter").setDesc("Purge all download/upload cache.").addButton((button=>button.setButtonText("Reset all").setWarning().setDisabled(false).onClick((async()=>{await this.getMinioJournalSyncClient().resetAllCaches();Logger("Journal download/upload cache has been cleared.",LOG_LEVEL_NOTICE)})))).addOnUpdate(onlyOnMinIO);new LiveSyncSetting(paneEl2).setName("Fresh Start Wipe").setDesc("Delete all data on the remote server.").addButton((button=>button.setButtonText("Delete").setWarning().setDisabled(false).onClick((async()=>{await this.getMinioJournalSyncClient().updateCheckPointInfo((info3=>({...info3,receivedFiles:new Set,knownIDs:new Set,lastLocalSeq:0,sentIDs:new Set,sentFiles:new Set})));await this.resetRemoteBucket();Logger("Deleted all data on remote server",LOG_LEVEL_NOTICE)})))).addOnUpdate(onlyOnMinIO)}));addPanel(paneEl,"Deprecated").then((paneEl2=>{new LiveSyncSetting(paneEl2).setClass("sls-setting-obsolete").setName("Run database cleanup").setDesc("Attempt to shrink the database by deleting unused chunks. This may not work consistently. Use the 'Rebuild everything' under Total Overhaul.").addButton((button=>button.setButtonText("DryRun").setDisabled(false).onClick((async()=>{await this.dryRunGC()})))).addButton((button=>button.setButtonText("Perform cleaning").setDisabled(false).setWarning().onClick((async()=>{this.closeSetting();await this.dbGC()})))).addOnUpdate(onlyOnCouchDB)}));addPanel(paneEl,"Reset").then((paneEl2=>{new LiveSyncSetting(paneEl2).setName("Delete local database to reset or uninstall Self-hosted LiveSync").addButton((button=>button.setButtonText("Delete").setWarning().setDisabled(false).onClick((async()=>{await this.plugin.$$resetLocalDatabase();await this.plugin.$$initializeDatabase()}))))}))}));yieldNextAnimationFrame().then((()=>{if(""==this.selectedScreen)if(lastVersion!=this.editingSettings.lastReadUpdates)if(this.editingSettings.isConfigured)changeDisplay("100");else changeDisplay("110");else if(isAnySyncEnabled())changeDisplay("20");else changeDisplay("110");else changeDisplay(this.selectedScreen);this.requestUpdate()}))}async dryRunGC(){await skipIfDuplicated("cleanup",(async()=>{const replicator=this.plugin.$$getReplicator();if(!(replicator instanceof LiveSyncCouchDBReplicator))return;const remoteDBConn=await replicator.connectRemoteCouchDBWithSetting(this.plugin.settings,this.plugin.$$isMobile());if("string"!=typeof remoteDBConn){await purgeUnreferencedChunks(remoteDBConn.db,true,this.plugin.settings,false);await purgeUnreferencedChunks(this.plugin.localDatabase.localDatabase,true);this.plugin.localDatabase.hashCaches.clear()}else Logger(remoteDBConn)}))}async dbGC(){await skipIfDuplicated("cleanup",(async()=>{const replicator=this.plugin.$$getReplicator();if(!(replicator instanceof LiveSyncCouchDBReplicator))return;await this.plugin.$$getReplicator().markRemoteLocked(this.plugin.settings,true,true);const remoteDBConnection=await replicator.connectRemoteCouchDBWithSetting(this.plugin.settings,this.plugin.$$isMobile());if("string"!=typeof remoteDBConnection){await purgeUnreferencedChunks(remoteDBConnection.db,false,this.plugin.settings,true);await purgeUnreferencedChunks(this.plugin.localDatabase.localDatabase,false);this.plugin.localDatabase.hashCaches.clear();await balanceChunkPurgedDBs(this.plugin.localDatabase.localDatabase,remoteDBConnection.db);this.plugin.localDatabase.refreshSettings();Logger("The remote database has been cleaned up! Other devices will be cleaned up on the next synchronisation.")}else Logger(remoteDBConnection)}))}getMinioJournalSyncClient(){const id=this.plugin.settings.accessKey,key2=this.plugin.settings.secretKey,bucket=this.plugin.settings.bucket,region=this.plugin.settings.region,endpoint=this.plugin.settings.endpoint,useCustomRequestHandler=this.plugin.settings.useCustomRequestHandler;return new JournalSyncMinio(id,key2,endpoint,bucket,this.plugin.simpleStore,this.plugin,useCustomRequestHandler,region)}async resetRemoteBucket(){const minioJournal=this.getMinioJournalSyncClient();await minioJournal.resetBucket()}},ModuleObsidianSettingDialogue=class extends AbstractObsidianModule{$everyOnloadStart(){this.settingTab=new ObsidianLiveSyncSettingTab(this.app,this.plugin);this.plugin.addSettingTab(this.settingTab);eventHub.onEvent(EVENT_REQUEST_OPEN_SETTINGS,(()=>this.openSetting()));eventHub.onEvent(EVENT_REQUEST_OPEN_SETTING_WIZARD,(()=>{this.openSetting();this.settingTab.enableMinimalSetup()}));return Promise.resolve(true)}openSetting(){this.app.setting.open();this.app.setting.openTabById("obsidian-livesync")}get appId(){return`${"appId"in this.app?this.app.appId:""}`}};function isImage(path2){const ext2=path2.split(".").splice(-1)[0].toLowerCase();return["png","jpg","jpeg","gif","bmp","webp"].includes(ext2)}function isComparableText(path2){const ext2=path2.split(".").splice(-1)[0].toLowerCase();return isPlainText(path2)||["md","mdx","txt","json"].includes(ext2)}function isComparableTextDecode(path2){const ext2=path2.split(".").splice(-1)[0].toLowerCase();return["json"].includes(ext2)}function readDocument(w2){if(0==w2.data.length)return"";if(isImage(w2.path))return new Uint8Array(decodeBinary(w2.data));if("plain"==w2.type||"plain"==w2.datatype)return getDocData(w2.data);if(isComparableTextDecode(w2.path))return readString(new Uint8Array(decodeBinary(w2.data)));if(isComparableText(w2.path))return getDocData(w2.data);try{return readString(new Uint8Array(decodeBinary(w2.data)))}catch(ex){Logger(ex,LOG_LEVEL_VERBOSE)}return getDocData(w2.data)}var DocumentHistoryModal=class extends import_obsidian.Modal{constructor(app2,plugin3,file,id,revision){super(app2);this.showDiff=false;this.revs_info=[];this.currentText="";this.currentDeleted=false;this.BlobURLs=new Map;this.plugin=plugin3;this.file=file instanceof import_obsidian.TFile?getPathFromTFile(file):file;this.id=id;this.initialRev=revision;if(!file&&id)this.file=this.plugin.$$id2path(id);if("1"==localStorage.getItem("ols-history-highlightdiff"))this.showDiff=true}async loadFile(initialRev){var _a5,_b2;if(!this.id)this.id=await this.plugin.$$path2id(this.file);const db=this.plugin.localDatabase;try{const w2=await db.getRaw(this.id,{revs_info:true});this.revs_info=null!=(_b2=null==(_a5=w2._revs_info)?void 0:_a5.filter((e4=>"available"==(null==e4?void 0:e4.status))))?_b2:[];this.range.max=`${Math.max(this.revs_info.length-1,0)}`;this.range.value=this.range.max;this.fileInfo.setText(`${this.file} / ${this.revs_info.length} revisions`);await this.loadRevs(initialRev)}catch(ex){if(isErrorOfMissingDoc(ex)){this.range.max="0";this.range.value="";this.range.disabled=true;this.contentView.setText("We don't have any history for this note.")}else{this.contentView.setText("Error while loading file.");Logger(ex,LOG_LEVEL_VERBOSE)}}}async loadRevs(initialRev){if(0==this.revs_info.length)return;if(initialRev){const rIndex=this.revs_info.findIndex((e4=>e4.rev==initialRev));if(rIndex>=0)this.range.value=""+(this.revs_info.length-1-rIndex)}const index5=this.revs_info.length-1-this.range.value/1,rev3=this.revs_info[index5];await this.showExactRev(rev3.rev)}revokeURL(key2){const v2=this.BlobURLs.get(key2);if(v2)URL.revokeObjectURL(v2);this.BlobURLs.delete(key2)}generateBlobURL(key2,data){this.revokeURL(key2);const v2=URL.createObjectURL(new Blob([data],{endings:"transparent",type:"application/octet-stream"}));this.BlobURLs.set(key2,v2);return v2}async showExactRev(rev3){const db=this.plugin.localDatabase,w2=await db.getDBEntry(this.file,{rev:rev3},false,false,true);this.currentText="";this.currentDeleted=false;if(false===w2){this.currentDeleted=true;this.info.innerHTML="";this.contentView.innerHTML=`Could not read this revision<br>(${rev3})`}else{this.currentDoc=w2;this.info.innerHTML=`Modified:${new Date(w2.mtime).toLocaleString()}`;let result;const w1data=readDocument(w2);this.currentDeleted=!!w2.deleted;if(this.showDiff){const prevRevIdx=this.revs_info.length-1-(this.range.value/1-1);if(prevRevIdx>=0&&prevRevIdx<this.revs_info.length){const oldRev=this.revs_info[prevRevIdx].rev,w22=await db.getDBEntry(this.file,{rev:oldRev},false,false,true);if(false!=w22)if("string"==typeof w1data){result="";const dmp=new import_diff_match_patch.diff_match_patch,w2data=readDocument(w22),diff=dmp.diff_main(w2data,w1data);dmp.diff_cleanupSemantic(diff);for(const v2 of diff){const x1=v2[0],x2=v2[1];if(x1==import_diff_match_patch.DIFF_DELETE)result+="<span class='history-deleted'>"+escapeStringToHTML(x2)+"</span>";else if(x1==import_diff_match_patch.DIFF_EQUAL)result+="<span class='history-normal'>"+escapeStringToHTML(x2)+"</span>";else if(x1==import_diff_match_patch.DIFF_INSERT)result+="<span class='history-added'>"+escapeStringToHTML(x2)+"</span>"}result=result.replace(/\n/g,"<br>")}else if(isImage(this.file)){result=`<div class='ls-imgdiff-wrap'>\n    <div class='overlay'>\n        <img class='img-base' src="${this.generateBlobURL("base",w1data)}">\n        <img class='img-overlay' src='${this.generateBlobURL("overlay",readDocument(w22))}'>\n    </div>\n</div>`;this.contentView.removeClass("op-pre")}}}if(null==result)if("string"!=typeof w1data){if(isImage(this.file)){result=`<div class='ls-imgdiff-wrap'>\n<div class='overlay'>\n<img class='img-base' src="${this.generateBlobURL("base",w1data)}">\n</div>\n</div>`;this.contentView.removeClass("op-pre")}}else result=escapeStringToHTML(w1data);if(null==result)result="string"==typeof w1data?escapeStringToHTML(w1data):"Binary file";this.contentView.innerHTML=(this.currentDeleted?"(At this revision, the file has been deleted)\n":"")+result}}onOpen(){const{contentEl}=this;this.titleEl.setText("Document History");contentEl.empty();this.fileInfo=contentEl.createDiv("");this.fileInfo.addClass("op-info");const divView=contentEl.createDiv("");divView.addClass("op-flex");divView.createEl("input",{type:"range"},(e4=>{this.range=e4;e4.addEventListener("change",(e5=>{scheduleOnceIfDuplicated("loadRevs",(()=>this.loadRevs()))}));e4.addEventListener("input",(e5=>{scheduleOnceIfDuplicated("loadRevs",(()=>this.loadRevs()))}))}));contentEl.createDiv("",(e4=>{e4.createEl("label",{},(label=>{label.appendChild(createEl("input",{type:"checkbox"},(checkbox=>{if(this.showDiff)checkbox.checked=true;checkbox.addEventListener("input",(evt=>{this.showDiff=checkbox.checked;localStorage.setItem("ols-history-highlightdiff",true==this.showDiff?"1":"");scheduleOnceIfDuplicated("loadRevs",(()=>this.loadRevs()))}))})));label.appendText("Highlight diff")}))})).addClass("op-info");this.info=contentEl.createDiv("");this.info.addClass("op-info");fireAndForget((async()=>await this.loadFile(this.initialRev)));const div=contentEl.createDiv({text:"Loading old revisions..."});this.contentView=div;div.addClass("op-scrollable");div.addClass("op-pre");const buttons=contentEl.createDiv("");buttons.createEl("button",{text:"Copy to clipboard"},(e4=>{e4.addClass("mod-cta");e4.addEventListener("click",(()=>{fireAndForget((async()=>{await navigator.clipboard.writeText(this.currentText);Logger("Old content copied to clipboard",LOG_LEVEL_NOTICE)}))}))}));const focusFile=async path2=>{const targetFile=this.plugin.app.vault.getFileByPath(path2);if(targetFile){const leaf=this.plugin.app.workspace.getLeaf(false);await leaf.openFile(targetFile)}else Logger("Unable to display the file in the editor",LOG_LEVEL_NOTICE)};buttons.createEl("button",{text:"Back to this revision"},(e4=>{e4.addClass("mod-cta");e4.addEventListener("click",(()=>{fireAndForget((async()=>{const pathToWrite=stripPrefix(this.file);if(!isValidPath(pathToWrite)){Logger("Path is not valid to write content.",LOG_LEVEL_INFO);return}if(!this.currentDoc){Logger("No active file loaded.",LOG_LEVEL_INFO);return}const d4=readContent(this.currentDoc);await this.plugin.storageAccess.writeHiddenFileAuto(pathToWrite,d4);await focusFile(pathToWrite);this.close()}))}))}))}onClose(){const{contentEl}=this;contentEl.empty();this.BlobURLs.forEach((value=>{console.log(value);if(value)URL.revokeObjectURL(value)}))}},import_obsidian11=require("obsidian"),ModuleObsidianDocumentHistory=class extends AbstractObsidianModule{$everyOnloadStart(){this.addCommand({id:"livesync-history",name:"Show history",callback:()=>{const file=this.core.$$getActiveFilePath();if(file)this.showHistory(file,void 0)}});this.addCommand({id:"livesync-filehistory",name:"Pick a file to show history",callback:()=>{fireAndForget((async()=>await this.fileHistory()))}});eventHub.onEvent(EVENT_REQUEST_SHOW_HISTORY,(({file,fileOnDB})=>{this.showHistory(file,fileOnDB._id)}));return Promise.resolve(true)}showHistory(file,id){new DocumentHistoryModal(this.app,this.plugin,file,id).open()}async fileHistory(){const notes=[];for await(const doc of this.localDatabase.findAllDocs())notes.push({id:doc._id,path:getPath2(doc),dispPath:getPath2(doc),mtime:doc.mtime});notes.sort(((a2,b3)=>b3.mtime-a2.mtime));const notesList=notes.map((e4=>e4.dispPath)),target=await this.core.confirm.askSelectString("File to view History",notesList);if(target){const targetId=notes.find((e4=>e4.dispPath==target));this.showHistory(targetId.path,targetId.id)}}};function add_css7(target){append_styles(target,"svelte-1vjy5r1",".svelte-1vjy5r1.svelte-1vjy5r1.svelte-1vjy5r1{box-sizing:border-box}.globalhistory.svelte-1vjy5r1.svelte-1vjy5r1.svelte-1vjy5r1{margin-bottom:2em}table.svelte-1vjy5r1.svelte-1vjy5r1.svelte-1vjy5r1{width:100%}.more.svelte-1vjy5r1>div.svelte-1vjy5r1.svelte-1vjy5r1{display:flex}.more.svelte-1vjy5r1>div.svelte-1vjy5r1>button.svelte-1vjy5r1{flex-grow:1}th.svelte-1vjy5r1.svelte-1vjy5r1.svelte-1vjy5r1{position:sticky;top:0;backdrop-filter:blur(10px)}td.mtime.svelte-1vjy5r1.svelte-1vjy5r1.svelte-1vjy5r1{white-space:break-spaces}td.path.svelte-1vjy5r1.svelte-1vjy5r1.svelte-1vjy5r1{word-break:break-word}.row.svelte-1vjy5r1.svelte-1vjy5r1.svelte-1vjy5r1{display:flex;flex-direction:row;flex-wrap:wrap}.row.svelte-1vjy5r1>label.svelte-1vjy5r1.svelte-1vjy5r1{display:flex;align-items:center;min-width:5em}.row.svelte-1vjy5r1>input.svelte-1vjy5r1.svelte-1vjy5r1{flex-grow:1}.filenames.svelte-1vjy5r1.svelte-1vjy5r1.svelte-1vjy5r1{display:flex;flex-direction:column}.filenames.svelte-1vjy5r1>.path.svelte-1vjy5r1.svelte-1vjy5r1{font-size:70%}.rev.svelte-1vjy5r1.svelte-1vjy5r1.svelte-1vjy5r1{text-overflow:ellipsis;max-width:3em;display:inline-block;overflow:hidden;white-space:nowrap}")}function get_each_context7(ctx,list,i2){const child_ctx=ctx.slice();child_ctx[26]=list[i2];return child_ctx}function create_if_block_54(ctx){let div;return{c(){div=element("div");div.textContent="Gathering information...";attr(div,"class"," svelte-1vjy5r1")},m(target,anchor){insert(target,div,anchor)},d(detaching){if(detaching)detach(div)}}}function create_if_block_44(ctx){let th;return{c(){th=element("th");th.textContent="Chunks";attr(th,"class","svelte-1vjy5r1")},m(target,anchor){insert(target,th,anchor)},d(detaching){if(detaching)detach(th)}}}function create_else_block_23(ctx){let div,button,mounted,dispose;return{c(){div=element("div");button=element("button");button.textContent="+1 week";attr(button,"class","svelte-1vjy5r1");attr(div,"class","svelte-1vjy5r1")},m(target,anchor){insert(target,div,anchor);append(div,button);if(!mounted){dispose=listen(button,"click",ctx[17]);mounted=true}},p:noop2,d(detaching){if(detaching)detach(div);mounted=false;dispose()}}}function create_if_block_34(ctx){let div;return{c(){div=element("div");attr(div,"class"," svelte-1vjy5r1")},m(target,anchor){insert(target,div,anchor)},p:noop2,d(detaching){if(detaching)detach(div)}}}function create_else_block_14(ctx){let t4,t_value=ctx[26].rev+"";return{c(){t4=text(t_value)},m(target,anchor){insert(target,t4,anchor)},p(ctx2,dirty){if(32&dirty&&t_value!==(t_value=ctx2[26].rev+""))set_data(t4,t_value)},d(detaching){if(detaching)detach(t4)}}}function create_if_block_24(ctx){let a2,t4,mounted,dispose,t_value=ctx[26].rev+"";function click_handler_2(){return ctx[19](ctx[26])}return{c(){a2=element("a");t4=text(t_value);attr(a2,"class","svelte-1vjy5r1")},m(target,anchor){insert(target,a2,anchor);append(a2,t4);if(!mounted){dispose=listen(a2,"click",click_handler_2);mounted=true}},p(new_ctx,dirty){ctx=new_ctx;if(32&dirty&&t_value!==(t_value=ctx[26].rev+""))set_data(t4,t_value)},d(detaching){if(detaching)detach(a2);mounted=false;dispose()}}}function create_if_block_14(ctx){let td3,t4,t_value=ctx[26].chunks+"";return{c(){td3=element("td");t4=text(t_value);attr(td3,"class","svelte-1vjy5r1")},m(target,anchor){insert(target,td3,anchor);append(td3,t4)},p(ctx2,dirty){if(32&dirty&&t_value!==(t_value=ctx2[26].chunks+""))set_data(t4,t_value)},d(detaching){if(detaching)detach(td3)}}}function create_each_block7(ctx){let tr,td0,t0,t1,td1,div,span0,t22,t32,t4,span1,a2,t5,t6,td22,span2,t7,td3,t8,t9,mounted,dispose,t0_value=ctx[26].mtimeDisp+"",t3_value=ctx[26].dirname.split("/").join("/")+"",t5_value=ctx[26].filename+"",t8_value=ctx[26].changes+"";function click_handler_1(){return ctx[18](ctx[26])}function select_block_type_1(ctx2,dirty){if(ctx2[26].isPlain)return create_if_block_24;else return create_else_block_14}let current_block_type=select_block_type_1(ctx),if_block0=current_block_type(ctx),if_block1=ctx[1]&&create_if_block_14(ctx);return{c(){tr=element("tr");td0=element("td");t0=text(t0_value);t1=space();td1=element("td");div=element("div");span0=element("span");t22=text("/");t32=text(t3_value);t4=space();span1=element("span");a2=element("a");t5=text(t5_value);t6=space();td22=element("td");span2=element("span");if_block0.c();t7=space();td3=element("td");t8=text(t8_value);t9=space();if(if_block1)if_block1.c();attr(td0,"class","mtime svelte-1vjy5r1");attr(span0,"class","path svelte-1vjy5r1");attr(a2,"class","svelte-1vjy5r1");attr(span1,"class","filename svelte-1vjy5r1");attr(div,"class","filenames svelte-1vjy5r1");attr(td1,"class","path svelte-1vjy5r1");attr(span2,"class","rev svelte-1vjy5r1");attr(td22,"class","svelte-1vjy5r1");attr(td3,"class","svelte-1vjy5r1");attr(tr,"class","svelte-1vjy5r1")},m(target,anchor){insert(target,tr,anchor);append(tr,td0);append(td0,t0);append(tr,t1);append(tr,td1);append(td1,div);append(div,span0);append(span0,t22);append(span0,t32);append(div,t4);append(div,span1);append(span1,a2);append(a2,t5);append(tr,t6);append(tr,td22);append(td22,span2);if_block0.m(span2,null);append(tr,t7);append(tr,td3);append(td3,t8);append(tr,t9);if(if_block1)if_block1.m(tr,null);if(!mounted){dispose=listen(a2,"click",click_handler_1);mounted=true}},p(new_ctx,dirty){ctx=new_ctx;if(32&dirty&&t0_value!==(t0_value=ctx[26].mtimeDisp+""))set_data(t0,t0_value);if(32&dirty&&t3_value!==(t3_value=ctx[26].dirname.split("/").join("/")+""))set_data(t32,t3_value);if(32&dirty&&t5_value!==(t5_value=ctx[26].filename+""))set_data(t5,t5_value);if(current_block_type===(current_block_type=select_block_type_1(ctx))&&if_block0)if_block0.p(ctx,dirty);else{if_block0.d(1);if_block0=current_block_type(ctx);if(if_block0){if_block0.c();if_block0.m(span2,null)}}if(32&dirty&&t8_value!==(t8_value=ctx[26].changes+""))set_data(t8,t8_value);if(ctx[1])if(if_block1)if_block1.p(ctx,dirty);else{if_block1=create_if_block_14(ctx);if_block1.c();if_block1.m(tr,null)}else if(if_block1){if_block1.d(1);if_block1=null}},d(detaching){if(detaching)detach(tr);if_block0.d();if(if_block1)if_block1.d();mounted=false;dispose()}}}function create_else_block4(ctx){let div,button,mounted,dispose;return{c(){div=element("div");button=element("button");button.textContent="+1 week";attr(button,"class","svelte-1vjy5r1");attr(div,"class","svelte-1vjy5r1")},m(target,anchor){insert(target,div,anchor);append(div,button);if(!mounted){dispose=listen(button,"click",ctx[20]);mounted=true}},p:noop2,d(detaching){if(detaching)detach(div);mounted=false;dispose()}}}function create_if_block4(ctx){let div;return{c(){div=element("div");attr(div,"class"," svelte-1vjy5r1")},m(target,anchor){insert(target,div,anchor)},p:noop2,d(detaching){if(detaching)detach(div)}}}function create_fragment7(ctx){let div4,h1,t1,div3,div0,label0,input0,t32,div1,label1,input1,t5,div2,label2,t7,label3,input2,span0,t9,label4,input3,span1,t11,label5,input4,span2,t13,t14,table2,tr0,th0,t16,th1,t18,th2,t20,th3,t22,t23,tr1,td0,t24,t25,tr2,td1,mounted,dispose,if_block0=ctx[6]&&create_if_block_54(ctx),if_block1=ctx[1]&&create_if_block_44(ctx);function select_block_type(ctx2,dirty){if(ctx2[6])return create_if_block_34;else return create_else_block_23}let current_block_type=select_block_type(ctx),if_block2=current_block_type(ctx),each_value=ensure_array_like(ctx[5]),each_blocks=[];for(let i2=0;i2<each_value.length;i2+=1)each_blocks[i2]=create_each_block7(get_each_context7(ctx,each_value,i2));function select_block_type_2(ctx2,dirty){if(ctx2[6])return create_if_block4;else return create_else_block4}let current_block_type_1=select_block_type_2(ctx),if_block3=current_block_type_1(ctx);return{c(){div4=element("div");h1=element("h1");h1.textContent="Vault history";t1=space();div3=element("div");div0=element("div");label0=element("label");label0.textContent="From:";input0=element("input");t32=space();div1=element("div");label1=element("label");label1.textContent="To:";input1=element("input");t5=space();div2=element("div");label2=element("label");label2.textContent="Info:";t7=space();label3=element("label");input2=element("input");span0=element("span");span0.textContent="Diff";t9=space();label4=element("label");input3=element("input");span1=element("span");span1.textContent="Chunks";t11=space();label5=element("label");input4=element("input");span2=element("span");span2.textContent="File integrity";t13=space();if(if_block0)if_block0.c();t14=space();table2=element("table");tr0=element("tr");th0=element("th");th0.textContent="Date";t16=space();th1=element("th");th1.textContent="Path";t18=space();th2=element("th");th2.textContent="Rev";t20=space();th3=element("th");th3.textContent="Stat";t22=space();if(if_block1)if_block1.c();t23=space();tr1=element("tr");td0=element("td");if_block2.c();t24=space();for(let i2=0;i2<each_blocks.length;i2+=1)each_blocks[i2].c();t25=space();tr2=element("tr");td1=element("td");if_block3.c();attr(h1,"class","svelte-1vjy5r1");attr(label0,"for","");attr(label0,"class","svelte-1vjy5r1");attr(input0,"type","date");input0.disabled=ctx[6];attr(input0,"class","svelte-1vjy5r1");attr(div0,"class","row svelte-1vjy5r1");attr(label1,"for","");attr(label1,"class","svelte-1vjy5r1");attr(input1,"type","date");input1.disabled=ctx[6];attr(input1,"class","svelte-1vjy5r1");attr(div1,"class","row svelte-1vjy5r1");attr(label2,"for","");attr(label2,"class","svelte-1vjy5r1");attr(input2,"type","checkbox");input2.disabled=ctx[6];attr(input2,"class","svelte-1vjy5r1");attr(span0,"class","svelte-1vjy5r1");attr(label3,"class","svelte-1vjy5r1");attr(input3,"type","checkbox");input3.disabled=ctx[6];attr(input3,"class","svelte-1vjy5r1");attr(span1,"class","svelte-1vjy5r1");attr(label4,"class","svelte-1vjy5r1");attr(input4,"type","checkbox");input4.disabled=ctx[6];attr(input4,"class","svelte-1vjy5r1");attr(span2,"class","svelte-1vjy5r1");attr(label5,"class","svelte-1vjy5r1");attr(div2,"class","row svelte-1vjy5r1");attr(div3,"class","control svelte-1vjy5r1");attr(th0,"class","svelte-1vjy5r1");attr(th1,"class","svelte-1vjy5r1");attr(th2,"class","svelte-1vjy5r1");attr(th3,"class","svelte-1vjy5r1");attr(tr0,"class","svelte-1vjy5r1");attr(td0,"colspan","5");attr(td0,"class","more svelte-1vjy5r1");attr(tr1,"class","svelte-1vjy5r1");attr(td1,"colspan","5");attr(td1,"class","more svelte-1vjy5r1");attr(tr2,"class","svelte-1vjy5r1");attr(table2,"class","svelte-1vjy5r1");attr(div4,"class","globalhistory svelte-1vjy5r1")},m(target,anchor){insert(target,div4,anchor);append(div4,h1);append(div4,t1);append(div4,div3);append(div3,div0);append(div0,label0);append(div0,input0);set_input_value(input0,ctx[3]);append(div3,t32);append(div3,div1);append(div1,label1);append(div1,input1);set_input_value(input1,ctx[4]);append(div3,t5);append(div3,div2);append(div2,label2);append(div2,t7);append(div2,label3);append(label3,input2);input2.checked=ctx[0];append(label3,span0);append(div2,t9);append(div2,label4);append(label4,input3);input3.checked=ctx[1];append(label4,span1);append(div2,t11);append(div2,label5);append(label5,input4);input4.checked=ctx[2];append(label5,span2);append(div4,t13);if(if_block0)if_block0.m(div4,null);append(div4,t14);append(div4,table2);append(table2,tr0);append(tr0,th0);append(tr0,t16);append(tr0,th1);append(tr0,t18);append(tr0,th2);append(tr0,t20);append(tr0,th3);append(tr0,t22);if(if_block1)if_block1.m(tr0,null);append(table2,t23);append(table2,tr1);append(tr1,td0);if_block2.m(td0,null);append(table2,t24);for(let i2=0;i2<each_blocks.length;i2+=1)if(each_blocks[i2])each_blocks[i2].m(table2,null);append(table2,t25);append(table2,tr2);append(tr2,td1);if_block3.m(td1,null);if(!mounted){dispose=[listen(input0,"input",ctx[12]),listen(input1,"input",ctx[13]),listen(input2,"change",ctx[14]),listen(input3,"change",ctx[15]),listen(input4,"change",ctx[16])];mounted=true}},p(ctx2,[dirty]){if(64&dirty)input0.disabled=ctx2[6];if(8&dirty)set_input_value(input0,ctx2[3]);if(64&dirty)input1.disabled=ctx2[6];if(16&dirty)set_input_value(input1,ctx2[4]);if(64&dirty)input2.disabled=ctx2[6];if(1&dirty)input2.checked=ctx2[0];if(64&dirty)input3.disabled=ctx2[6];if(2&dirty)input3.checked=ctx2[1];if(64&dirty)input4.disabled=ctx2[6];if(4&dirty)input4.checked=ctx2[2];if(ctx2[6])if(if_block0);else{if_block0=create_if_block_54(ctx2);if_block0.c();if_block0.m(div4,t14)}else if(if_block0){if_block0.d(1);if_block0=null}if(ctx2[1])if(if_block1);else{if_block1=create_if_block_44(ctx2);if_block1.c();if_block1.m(tr0,null)}else if(if_block1){if_block1.d(1);if_block1=null}if(current_block_type===(current_block_type=select_block_type(ctx2))&&if_block2)if_block2.p(ctx2,dirty);else{if_block2.d(1);if_block2=current_block_type(ctx2);if(if_block2){if_block2.c();if_block2.m(td0,null)}}if(1570&dirty){each_value=ensure_array_like(ctx2[5]);let i2;for(i2=0;i2<each_value.length;i2+=1){const child_ctx=get_each_context7(ctx2,each_value,i2);if(each_blocks[i2])each_blocks[i2].p(child_ctx,dirty);else{each_blocks[i2]=create_each_block7(child_ctx);each_blocks[i2].c();each_blocks[i2].m(table2,t25)}}for(;i2<each_blocks.length;i2+=1)each_blocks[i2].d(1);each_blocks.length=each_value.length}if(current_block_type_1===(current_block_type_1=select_block_type_2(ctx2))&&if_block3)if_block3.p(ctx2,dirty);else{if_block3.d(1);if_block3=current_block_type_1(ctx2);if(if_block3){if_block3.c();if_block3.m(td1,null)}}},i:noop2,o:noop2,d(detaching){if(detaching)detach(div4);if(if_block0)if_block0.d();if(if_block1)if_block1.d();if_block2.d();destroy_each(each_blocks,detaching);if_block3.d();mounted=false;run_all(dispose)}}}function mtimeToDate(mtime){return new Date(mtime).toLocaleString()}function instance7($$self,$$props,$$invalidate){let{plugin:plugin3}=$$props,showDiffInfo=false,showChunkCorrected=false,checkStorageDiff=false,range_from_epoch=Date.now()-6048e5,range_to_epoch=Date.now()+1728e5;const timezoneOffset=(new Date).getTimezoneOffset();let dispDateFrom=new Date(range_from_epoch-timezoneOffset).toISOString().split("T")[0],dispDateTo=new Date(range_to_epoch-timezoneOffset).toISOString().split("T")[0],history=[],loading=false;async function getHistory(showDiffInfo2,showChunkCorrected2,checkStorageDiff2){$$invalidate(6,loading=true);const newDisplay=[],page=await async function fetchChanges(){var _a5,_b2,_c2;try{const db=plugin3.localDatabase;let result=[];for await(const docA of db.findAllNormalDocs()){if(docA.mtime<range_from_epoch)continue;if(!isAnyNote(docA))continue;const path2=getPath2(docA),isPlain=isPlainText(docA.path);let p2;const reversedRevs=(null!==(_a5=(await db.getRaw(docA._id,{revs_info:true}))._revs_info)&&void 0!==_a5?_a5:[]).reverse(),DIFF_DELETE4=-1,DIFF_EQUAL4=0,DIFF_INSERT4=1;for(const revInfo of reversedRevs)if("available"==revInfo.status){const doc=!isPlain&&showDiffInfo||checkStorageDiff&&revInfo.rev==docA._rev?await db.getDBEntry(path2,{rev:revInfo.rev},false,false,true):await db.getDBEntryMeta(path2,{rev:revInfo.rev},true);if(false===doc)continue;const rev3=revInfo.rev,mtime="mtime"in doc?doc.mtime:0;if(range_from_epoch>mtime)continue;if(range_to_epoch<mtime)continue;let diffDetail="";if(showDiffInfo&&!isPlain){const data=getDocData(doc.data);if(void 0===p2)p2=data;if(p2!=data){const dmp=new import_diff_match_patch.diff_match_patch,diff=dmp.diff_main(p2,data);dmp.diff_cleanupSemantic(diff);p2=data;const pxInit={[DIFF_DELETE4]:0,[DIFF_EQUAL4]:0,[DIFF_INSERT4]:0},px=diff.reduce(((p3,c2)=>{var _a6;return{...p3,[c2[0]]:(null!==(_a6=p3[c2[0]])&&void 0!==_a6?_a6:0)+c2[1].length}}),pxInit);diffDetail=`-${px[DIFF_DELETE4]}, +${px[DIFF_INSERT4]}`}}const isDeleted2=doc._deleted||(null==doc?void 0:doc.deleted)||false;if(isDeleted2)diffDetail+=" ";if(rev3==docA._rev)if(checkStorageDiff)if(await plugin3.storageAccess.isExistsIncludeHidden(stripAllPrefixes(getPath2(docA)))){const data=await plugin3.storageAccess.readHiddenFileBinary(stripAllPrefixes(getPath2(docA))),d4=readAsBlob(doc);if(await isDocContentSame(data,d4))diffDetail+=" ";else diffDetail+=" "}const docPath=getPath2(doc),[filename,...pathItems]=docPath.split("/").reverse();let chunksStatus="";if(showChunkCorrected){const chunks=null!==(_b2=null==doc?void 0:doc.children)&&void 0!==_b2?_b2:[],loadedChunks=await db.allDocsRaw({keys:[...chunks]}),totalCount=loadedChunks.rows.length,errorCount=loadedChunks.rows.filter((e4=>"error"in e4)).length;if(0==errorCount)chunksStatus=` ${totalCount}`;else chunksStatus=` ${errorCount}  ${totalCount}`}result.push({id:doc._id,rev:doc._rev,path:docPath,dirname:pathItems.reverse().join("/"),filename,mtime,mtimeDisp:mtimeToDate(mtime),size:null!==(_c2=null==doc?void 0:doc.size)&&void 0!==_c2?_c2:0,isDeleted:isDeleted2,changes:diffDetail,chunks:chunksStatus,isPlain})}}return[...result].sort(((a2,b3)=>b3.mtime-a2.mtime))}finally{$$invalidate(6,loading=false)}}();newDisplay.push(...page);$$invalidate(5,history=[...newDisplay])}function nextWeek(){$$invalidate(4,dispDateTo=new Date(range_to_epoch-timezoneOffset+6048e5).toISOString().split("T")[0])}function prevWeek(){$$invalidate(3,dispDateFrom=new Date(range_from_epoch-timezoneOffset-6048e5).toISOString().split("T")[0])}onMount((async()=>{await getHistory()}));onDestroy((()=>{}));function showHistory(file,rev3){new DocumentHistoryModal(plugin3.app,plugin3,file,void 0,rev3).open()}function openFile(file){plugin3.app.workspace.openLinkText(file,file)}$$self.$$set=$$props2=>{if("plugin"in $$props2)$$invalidate(11,plugin3=$$props2.plugin)};$$self.$$.update=()=>{if(31&$$self.$$.dirty){range_from_epoch=new Date(dispDateFrom).getTime()+timezoneOffset;range_to_epoch=new Date(dispDateTo).getTime()+timezoneOffset;getHistory()}};return[showDiffInfo,showChunkCorrected,checkStorageDiff,dispDateFrom,dispDateTo,history,loading,nextWeek,prevWeek,showHistory,openFile,plugin3,function input0_input_handler(){dispDateFrom=this.value;$$invalidate(3,dispDateFrom)},function input1_input_handler(){dispDateTo=this.value;$$invalidate(4,dispDateTo)},function input2_change_handler(){showDiffInfo=this.checked;$$invalidate(0,showDiffInfo)},function input3_change_handler(){showChunkCorrected=this.checked;$$invalidate(1,showChunkCorrected)},function input4_change_handler(){checkStorageDiff=this.checked;$$invalidate(2,checkStorageDiff)},()=>nextWeek(),entry=>openFile(entry.path),entry=>showHistory(entry.path,(null==entry?void 0:entry.rev)||""),()=>prevWeek()]}var GlobalHistory=class extends SvelteComponent{constructor(options){super();init(this,options,instance7,create_fragment7,safe_not_equal,{plugin:11},add_css7)}},GlobalHistory_default=GlobalHistory,VIEW_TYPE_GLOBAL_HISTORY="global-history",GlobalHistoryView=class extends import_obsidian.ItemView{constructor(leaf,plugin3){super(leaf);this.icon="clock";this.title="";this.navigation=true;this.plugin=plugin3}getIcon(){return"clock"}getViewType(){return VIEW_TYPE_GLOBAL_HISTORY}getDisplayText(){return"Vault history"}async onOpen(){this.component=new GlobalHistory_default({target:this.contentEl,props:{plugin:this.plugin}});await Promise.resolve()}async onClose(){var _a5;null==(_a5=this.component)||_a5.$destroy();await Promise.resolve()}},ModuleObsidianGlobalHistory=class extends AbstractObsidianModule{$everyOnloadStart(){this.addCommand({id:"livesync-global-history",name:"Show vault history",callback:()=>{this.showGlobalHistory()}});this.registerView(VIEW_TYPE_GLOBAL_HISTORY,(leaf=>new GlobalHistoryView(leaf,this.plugin)));return Promise.resolve(true)}showGlobalHistory(){this.core.$$showView(VIEW_TYPE_GLOBAL_HISTORY)}},SETTING_HEADER="````yaml:livesync-setting\n",SETTING_FOOTER="\n````",ModuleObsidianSettingsAsMarkdown=class extends AbstractObsidianModule{$everyOnloadStart(){this.addCommand({id:"livesync-export-config",name:"Write setting markdown manually",checkCallback:checking=>{if(checking)return""!=this.settings.settingSyncFile;fireAndForget((async()=>{await this.core.$$saveSettingData()}))}});this.addCommand({id:"livesync-import-config",name:"Parse setting file",editorCheckCallback:(checking,editor,ctx)=>{if(checking){const doc=editor.getValue();return""!=this.extractSettingFromWholeText(doc).body}if(ctx.file){const file=ctx.file;fireAndForget((async()=>await this.checkAndApplySettingFromMarkdown(file.path,false)))}}});eventHub.onEvent("event-file-changed",(info3=>{fireAndForget((()=>this.checkAndApplySettingFromMarkdown(info3.file,info3.automated)))}));eventHub.onEvent(EVENT_SETTING_SAVED,(settings=>{if(""!=settings.settingSyncFile)fireAndForget((()=>this.saveSettingToMarkdown(settings.settingSyncFile)))}));return Promise.resolve(true)}extractSettingFromWholeText(data){if(-1===data.indexOf(SETTING_HEADER))return{preamble:data,body:"",postscript:""};const startMarkerPos=data.indexOf(SETTING_HEADER),dataStartPos=-1==startMarkerPos?data.length:startMarkerPos,endMarkerPos=-1==startMarkerPos?data.length:data.indexOf(SETTING_FOOTER,dataStartPos),dataEndPos=-1==endMarkerPos?data.length:endMarkerPos,body=data.substring(dataStartPos+SETTING_HEADER.length,dataEndPos);return{preamble:data.substring(0,dataStartPos),body,postscript:data.substring(dataEndPos+SETTING_FOOTER.length+1)}}async parseSettingFromMarkdown(filename,data){if(!await this.core.storageAccess.isExists(filename))return{preamble:"",body:"",postscript:""};if(data)return this.extractSettingFromWholeText(data);const parseData=null!=data?data:await this.core.storageAccess.readFileText(filename);return this.extractSettingFromWholeText(parseData)}async checkAndApplySettingFromMarkdown(filename,automated){if(automated&&!this.settings.notifyAllSettingSyncFile)if(!this.settings.settingSyncFile||this.settings.settingSyncFile!=filename){this._log(`Setting file (${filename}) does not match the current configuration. skipped.`,LOG_LEVEL_DEBUG);return}const{body}=await this.parseSettingFromMarkdown(filename);let newSetting={};try{newSetting=(0,import_obsidian.parseYaml)(body)}catch(ex){this._log("Could not parse YAML",LOG_LEVEL_NOTICE);this._log(ex,LOG_LEVEL_VERBOSE);return}if("settingSyncFile"in newSetting&&newSetting.settingSyncFile!=filename){this._log("This setting file seems to backed up one. Please fix the filename or settingSyncFile value.",automated?LOG_LEVEL_INFO:LOG_LEVEL_NOTICE);return}let settingToApply={...DEFAULT_SETTINGS};settingToApply={...settingToApply,...newSetting};if(!(null==settingToApply?void 0:settingToApply.writeCredentialsForSettingSync)){settingToApply.couchDB_USER=this.settings.couchDB_USER;settingToApply.couchDB_PASSWORD=this.settings.couchDB_PASSWORD;settingToApply.passphrase=this.settings.passphrase}if(!isObjectDifferent(this.generateSettingForMarkdown(this.settings,settingToApply.writeCredentialsForSettingSync),this.generateSettingForMarkdown(settingToApply))){this._log("Setting markdown has been detected, but not changed.",automated?LOG_LEVEL_INFO:LOG_LEVEL_NOTICE);return}const addMsg=this.settings.settingSyncFile!=filename?" (This is not-active file)":"";this.core.confirm.askInPopup("apply-setting-from-md",`Setting markdown ${filename}${addMsg} has been detected. Apply this from {HERE}.`,(anchor=>{anchor.text="HERE";anchor.addEventListener("click",(()=>{fireAndForget((async()=>{const APPLY_AND_RESTART="Apply settings and restart obsidian",APPLY_AND_REBUILD="Apply settings and restart obsidian with red_flag_rebuild.md",APPLY_AND_FETCH="Apply settings and restart obsidian with red_flag_fetch.md",result=await this.core.confirm.askSelectStringDialogue("Ready for apply the setting.",[APPLY_AND_RESTART,"Apply settings",APPLY_AND_FETCH,APPLY_AND_REBUILD,"Cancel"],{defaultAction:APPLY_AND_RESTART});if("Apply settings"==result||result==APPLY_AND_RESTART||result==APPLY_AND_REBUILD||result==APPLY_AND_FETCH){this.core.settings=settingToApply;await this.core.$$saveSettingData();if("Apply settings"==result){this._log("Loaded settings have been applied!",LOG_LEVEL_NOTICE);return}if(result==APPLY_AND_REBUILD)await this.core.rebuilder.scheduleRebuild();if(result==APPLY_AND_FETCH)await this.core.rebuilder.scheduleFetch();this.core.$$performRestart()}}))}))}))}generateSettingForMarkdown(settings,keepCredential){const saveData={...settings?settings:this.settings};delete saveData.encryptedCouchDBConnection;delete saveData.encryptedPassphrase;delete saveData.additionalSuffixOfDatabaseName;if(!saveData.writeCredentialsForSettingSync&&!keepCredential){delete saveData.couchDB_USER;delete saveData.couchDB_PASSWORD;delete saveData.passphrase}return saveData}async saveSettingToMarkdown(filename){const saveData=this.generateSettingForMarkdown();if(!await this.core.storageAccess.isExists(filename)){await this.core.storageAccess.ensureDir(filename);const initialContent='This file contains Self-hosted LiveSync settings as YAML.\nExcept for the `livesync-setting` code block, we can add a note for free.\n\nIf the name of this file matches the value of the "settingSyncFile" setting inside the `livesync-setting` block, LiveSync will tell us whenever the settings change. We can decide to accept or decline the remote setting. (In other words, we can back up this file by renaming it to another name).\n\nWe can perform a command in this file.\n- `Parse setting file` : load the setting from the file.\n\n**Note** Please handle it with all of your care if you have configured to write credentials in.\n\n\n';await this.core.storageAccess.writeFileAuto(filename,initialContent+SETTING_HEADER+"\n"+SETTING_FOOTER)}const data=await this.core.storageAccess.readFileText(filename),{preamble,body,postscript}=this.extractSettingFromWholeText(data),newBody=(0,import_obsidian.stringifyYaml)(saveData);if(newBody==body)this._log("Markdown setting: Nothing had been changed",LOG_LEVEL_VERBOSE);else{await this.core.storageAccess.writeFileAuto(filename,preamble+SETTING_HEADER+newBody+SETTING_FOOTER+postscript);this._log(`Markdown setting: ${filename} has been updated!`,LOG_LEVEL_VERBOSE)}}},ModuleInitializerFile=class extends AbstractModule{async $$performFullScan(showingNotice){this._log("Opening the key-value database",LOG_LEVEL_VERBOSE);const isInitialized=await this.core.kvDB.get("initialized")||false;if(!this.settings.isConfigured){if(showingNotice)this._log("LiveSync is not configured yet. Synchronising between the storage and the local database is now prevented.",LOG_LEVEL_NOTICE,"syncAll");return}if(showingNotice)this._log("Initializing",LOG_LEVEL_NOTICE,"syncAll");this._log("Initialize and checking database files");this._log("Checking deleted files");await this.collectDeletedFiles();this._log("Collecting local files on the storage",LOG_LEVEL_VERBOSE);const filesStorageSrc=this.core.storageAccess.getFiles(),_filesStorage=[];for(const f4 of filesStorageSrc)if(await this.core.$$isTargetFile(f4.path,f4!=filesStorageSrc[0]))_filesStorage.push(f4);const convertCase=path2=>{if(this.settings.handleFilenameCaseSensitive)return path2;else return path2.toLowerCase()},storageFileNameMap=Object.fromEntries(_filesStorage.map((e4=>[e4.path,e4]))),storageFileNames=Object.keys(storageFileNameMap),storageFileNameCapsPair=storageFileNames.map((e4=>[e4,convertCase(e4)])),storageFileNameCI2CS=Object.fromEntries(storageFileNameCapsPair.map((e4=>[e4[1],e4[0]])));this._log("Collecting local files on the DB",LOG_LEVEL_VERBOSE);const _DBEntries=[];let count=0;for await(const doc of this.localDatabase.findAllNormalDocs()){count++;if(count%25==0)this._log(`Collecting local files on the DB: ${count}`,showingNotice?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,"syncAll");const path2=getPath2(doc);if(isValidPath(path2)&&await this.core.$$isTargetFile(path2,true)){if(!isMetaEntry(doc)){this._log(`Invalid entry: ${path2}`,LOG_LEVEL_INFO);continue}_DBEntries.push(doc)}}const databaseFileNameMap=Object.fromEntries(_DBEntries.map((e4=>[getPath2(e4),e4]))),databaseFileNames=Object.keys(databaseFileNameMap),databaseFileNameCapsPair=databaseFileNames.map((e4=>[e4,convertCase(e4)])),databaseFileNameCI2CS=Object.fromEntries(databaseFileNameCapsPair.map((e4=>[e4[1],e4[0]]))),allFiles=unique([...Object.keys(databaseFileNameCI2CS),...Object.keys(storageFileNameCI2CS)]);this._log(`Total files in the database: ${databaseFileNames.length}`,LOG_LEVEL_VERBOSE,"syncAll");this._log(`Total files in the storage: ${storageFileNames.length}`,LOG_LEVEL_VERBOSE,"syncAll");this._log(`Total files: ${allFiles.length}`,LOG_LEVEL_VERBOSE,"syncAll");const filesExistOnlyInStorage=allFiles.filter((e4=>!databaseFileNameCI2CS[e4])),filesExistOnlyInDatabase=allFiles.filter((e4=>!storageFileNameCI2CS[e4])),filesExistBoth=allFiles.filter((e4=>databaseFileNameCI2CS[e4]&&storageFileNameCI2CS[e4]));this._log(`Files exist only in storage: ${filesExistOnlyInStorage.length}`,LOG_LEVEL_VERBOSE,"syncAll");this._log(`Files exist only in database: ${filesExistOnlyInDatabase.length}`,LOG_LEVEL_VERBOSE,"syncAll");this._log(`Files exist both in storage and database: ${filesExistBoth.length}`,LOG_LEVEL_VERBOSE,"syncAll");this._log("Synchronising...");const processStatus={},logLevel=showingNotice?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO,updateLog=throttle(((key2,msg)=>{processStatus[key2]=msg;const log2=Object.values(processStatus).join("\n");this._log(log2,logLevel,"syncAll")}),25),initProcess=[],runAll=async(procedureName,objects,callback)=>{if(0==objects.length){this._log(`${procedureName}: Nothing to do`);return}this._log(procedureName);if(!this.localDatabase.isReady)throw Error("Database is not ready!");let success=0,failed2=0;const processor=new QueueProcessor((async e4=>{try{await callback(e4[0]);success++}catch(ex){this._log(`Error while ${procedureName}`,LOG_LEVEL_NOTICE);this._log(ex,LOG_LEVEL_VERBOSE);failed2++}if((success+failed2)%10==0){const msg2=`${procedureName}: DONE:${success}, FAILED:${failed2}, LAST:${processor._queue.length}`;updateLog(procedureName,msg2)}}),{batchSize:1,concurrentLimit:10,delay:0,suspended:true,maintainDelay:false,interval:0},objects);await processor.waitForAllDoneAndTerminate();updateLog(procedureName,`${procedureName} All done: DONE:${success}, FAILED:${failed2}`)};initProcess.push(runAll("UPDATE DATABASE",filesExistOnlyInStorage,(async e4=>{const file=storageFileNameMap[storageFileNameCI2CS[e4]];if(!this.core.$$isFileSizeExceeded(file.stat.size)){const path2=file.path;await this.core.fileHandler.storeFileToDB(file);eventHub.emitEvent("event-file-changed",{file:path2,automated:true})}else this._log(`UPDATE DATABASE: ${e4} has been skipped due to file size exceeding the limit`,logLevel)})));initProcess.push(runAll("UPDATE STORAGE",filesExistOnlyInDatabase,(async e4=>{var _a5;const w2=databaseFileNameMap[databaseFileNameCI2CS[e4]],path2=null!=(_a5=getPath2(w2))?_a5:e4;if(w2&&!(w2.deleted||w2._deleted))if(!this.core.$$isFileSizeExceeded(w2.size)){await this.core.fileHandler.dbToStorage(path2,null,true);eventHub.emitEvent("event-file-changed",{file:e4,automated:true});this._log(`Check or pull from db:${path2} OK`)}else this._log(`UPDATE STORAGE: ${path2} has been skipped due to file size exceeding the limit`,logLevel);else if(w2)this._log(`Deletion history skipped: ${path2}`,LOG_LEVEL_VERBOSE);else this._log(`entry not found: ${path2}`)})));const fileMap=filesExistBoth.map((path2=>({file:storageFileNameMap[storageFileNameCI2CS[path2]],doc:databaseFileNameMap[databaseFileNameCI2CS[path2]]})));initProcess.push(runAll("SYNC DATABASE AND STORAGE",fileMap,(async e4=>{const{file,doc}=e4;if(!this.core.$$isFileSizeExceeded(file.stat.size)&&!this.core.$$isFileSizeExceeded(doc.size))await this.syncFileBetweenDBandStorage(file,doc);else this._log(`SYNC DATABASE AND STORAGE: ${getPath2(doc)} has been skipped due to file size exceeding the limit`,logLevel)})));await Promise.all(initProcess);this._log("Initialized, NOW TRACKING!");if(!isInitialized)await this.core.kvDB.set("initialized",true);if(showingNotice)this._log("Initialize done!",LOG_LEVEL_NOTICE,"syncAll")}async syncFileBetweenDBandStorage(file,doc){if(!doc)throw new Error(`Missing doc:${file.path}`);if("path"in file){const w2=this.core.storageAccess.getFileStub(file.path);if(w2)file=w2;else throw new Error(`Missing file:${file.path}`)}switch(compareFileFreshness(file,doc)){case BASE_IS_NEW:if(!this.core.$$isFileSizeExceeded(file.stat.size)){this._log("STORAGE -> DB :"+file.path);await this.core.fileHandler.storeFileToDB(file)}else this._log(`STORAGE -> DB : ${file.path} has been skipped due to file size exceeding the limit`,LOG_LEVEL_NOTICE);break;case TARGET_IS_NEW:if(!this.core.$$isFileSizeExceeded(doc.size)){this._log("STORAGE <- DB :"+file.path);if(await this.core.fileHandler.dbToStorage(doc,stripAllPrefixes(file.path),true))eventHub.emitEvent("event-file-changed",{file:file.path,automated:true});else this._log(`STORAGE <- DB : Cloud not read ${file.path}, possibly deleted`,LOG_LEVEL_NOTICE);return caches}else this._log(`STORAGE <- DB : ${file.path} has been skipped due to file size exceeding the limit`,LOG_LEVEL_NOTICE);break;case EVEN:this._log("STORAGE == DB :"+file.path,LOG_LEVEL_DEBUG);break;default:this._log("STORAGE ?? DB :"+file.path+" Something got weird")}}async collectDeletedFiles(){const limitDays=this.settings.automaticallyDeleteMetadataOfDeletedFiles;if(limitDays<=0)return;this._log("Checking expired file history");const limit=Date.now()-864e5*limitDays,notes=[];for await(const doc of this.localDatabase.findAllDocs({conflicts:true}))if(isAnyNote(doc))if(doc.deleted&&doc.mtime-limit<0)notes.push({path:getPath2(doc),mtime:doc.mtime,ttl:(doc.mtime-limit)/1e3/86400,doc});if(0!=notes.length){for(const v2 of notes){this._log(`Deletion history expired: ${v2.path}`);const delDoc=v2.doc;delDoc._deleted=true;await this.localDatabase.putRaw(delDoc)}this._log("Checking expired file history done")}else{this._log("There are no old documents");this._log("Checking expired file history done")}}async $$initializeDatabase(showingNotice=false,reopenDatabase=true){this.core.$$resetIsReady();if(!reopenDatabase||await this.core.$$openDatabase()){if(this.localDatabase.isReady)await this.core.$$performFullScan(showingNotice);if(!await this.core.$everyOnDatabaseInitialized(showingNotice)){this._log("Initializing database has been failed on some module",LOG_LEVEL_NOTICE);return false}this.core.$$markIsReady();await this.core.$everyCommitPendingFileEvent();return true}else{this.core.$$resetIsReady();return false}}},ModuleKeyValueDB=class extends AbstractModule{tryCloseKvDB(){var _a5;try{null==(_a5=this.core.kvDB)||_a5.close();return true}catch(e4){this._log("Failed to close KeyValueDB",LOG_LEVEL_VERBOSE);this._log(e4);return false}}async openKeyValueDB(){await delay(10);try{this.tryCloseKvDB();await delay(10);await yieldMicrotask();this.core.kvDB=await OpenKeyValueDatabase(this.core.$$getVaultName()+"-livesync-kv");await yieldMicrotask();await delay(100)}catch(e4){this.core.kvDB=void 0;this._log("Failed to open KeyValueDB",LOG_LEVEL_NOTICE);this._log(e4,LOG_LEVEL_VERBOSE);return false}return true}$allOnDBUnload(db){if(this.core.kvDB)this.core.kvDB.close()}$allOnDBClose(db){if(this.core.kvDB)this.core.kvDB.close()}async $everyOnloadAfterLoadSettings(){if(!await this.openKeyValueDB())return false;this.core.simpleStore=this.core.$$getSimpleStore("os");return Promise.resolve(true)}$$getSimpleStore(kind){const prefix=`${kind}-`;return{get:async key2=>await this.core.kvDB.get(`${prefix}${key2}`),set:async(key2,value)=>{await this.core.kvDB.set(`${prefix}${key2}`,value)},delete:async key2=>{await this.core.kvDB.del(`${prefix}${key2}`)},keys:async(from,to,count)=>{const ret=this.core.kvDB.keys(IDBKeyRange.bound(`${prefix}${from||""}`,`${prefix}${to||""}`),count);return(await ret).map((e4=>e4.toString())).filter((e4=>e4.startsWith(prefix))).map((e4=>e4.substring(prefix.length)))}}}$everyOnInitializeDatabase(db){return this.openKeyValueDB()}async $everyOnResetDatabase(db){try{const kvDBKey="queued-files";await this.core.kvDB.del(kvDBKey);await this.core.kvDB.destroy();await yieldMicrotask();this.core.kvDB=await OpenKeyValueDatabase(this.core.$$getVaultName()+"-livesync-kv");await delay(100)}catch(e4){this.core.kvDB=void 0;this._log("Failed to reset KeyValueDB",LOG_LEVEL_NOTICE);this._log(e4,LOG_LEVEL_VERBOSE);return false}return true}},ModulePouchDB=class extends AbstractModule{$$createPouchDBInstance(name,options){const optionPass=null!=options?options:{};if(this.settings.useIndexedDBAdapter){optionPass.adapter="indexeddb";optionPass.purged_infos_limit=1;return new index_es_default(name+"-indexeddb",optionPass)}return new index_es_default(name,optionPass)}},ModuleReplicator=class extends AbstractModule{constructor(){super(...arguments);this._saveQueuedFiles=throttle((()=>{const saveData=this.replicationResultProcessor._queue.filter((e4=>null!=e4)).map((e4=>{var _a5;return null!=(_a5=null==e4?void 0:e4._id)?_a5:""}));fireAndForget((()=>this.core.kvDB.set("queued-files",saveData)))}),100);this.replicationResultProcessor=new QueueProcessor((async docs=>{if(this.settings.suspendParseReplicationResult)return;const change=docs[0];if(change)if(!isChunk(change._id)){if(!await this.core.$anyModuleParsedReplicationResultItem(change))if("versioninfo"!=change.type){if(change._id!=SYNCINFO_ID&&!change._id.startsWith("_design"))if(isAnyNote(change)){const docPath=getPath2(change);if(!await this.core.$$isTargetFile(docPath)){Logger(`Skipped: ${docPath}`,LOG_LEVEL_VERBOSE);return}if(this.databaseQueuedProcessor._isSuspended)Logger(`Processing scheduled: ${docPath}`,LOG_LEVEL_INFO);const size=change.size;if(this.core.$$isFileSizeExceeded(size)){Logger(`Processing ${docPath} has been skipped due to file size exceeding the limit`,LOG_LEVEL_NOTICE);return}this.databaseQueuedProcessor.enqueue(change)}}else if(change.version>VER){this.core.replicator.closeReplication();Logger("Remote database updated to incompatible version. update your Self-hosted LiveSync plugin.",LOG_LEVEL_NOTICE)}}else sendValue(`leaf-${change._id}`,change)}),{batchSize:1,suspended:true,concurrentLimit:100,delay:0,totalRemainingReactiveSource:this.core.replicationResultCount}).replaceEnqueueProcessor(((queue2,newItem)=>[...queue2.filter((e4=>e4._id!=newItem._id)),newItem])).startPipeline().onUpdateProgress((()=>{this.saveQueuedFiles()}));this.databaseQueuedProcessor=new QueueProcessor((async docs=>{var _a5;const dbDoc=docs[0],path2=getPath2(dbDoc),doc=await this.localDatabase.getDBEntryFromMeta({...dbDoc},{},false,true,true);if(doc)if(await this.core.$anyProcessOptionalSyncFiles(dbDoc));else if(isValidPath(getPath2(doc)))this.storageApplyingProcessor.enqueue(doc);else Logger(`Skipped: ${path2} (${doc._id.substring(0,8)})`,LOG_LEVEL_VERBOSE);else Logger(`Something went wrong while gathering content of ${path2} (${dbDoc._id.substring(0,8)}, ${null==(_a5=dbDoc._rev)?void 0:_a5.substring(0,10)}) `,LOG_LEVEL_NOTICE)}),{suspended:true,batchSize:1,concurrentLimit:10,yieldThreshold:1,delay:0,totalRemainingReactiveSource:this.core.databaseQueueCount}).replaceEnqueueProcessor(((queue2,newItem)=>[...queue2.filter((e4=>e4._id!=newItem._id)),newItem])).startPipeline();this.storageApplyingProcessor=new QueueProcessor((async docs=>{const entry=docs[0];await this.core.$anyProcessReplicatedDoc(entry)}),{suspended:true,batchSize:1,concurrentLimit:6,yieldThreshold:1,delay:0,totalRemainingReactiveSource:this.core.storageApplyingCount}).replaceEnqueueProcessor(((queue2,newItem)=>[...queue2.filter((e4=>e4._id!=newItem._id)),newItem])).startPipeline()}$everyOnloadAfterLoadSettings(){eventHub.onEvent(EVENT_FILE_SAVED,(()=>{if(this.settings.syncOnSave&&!this.core.$$isSuspended())scheduleTask("perform-replicate-after-save",250,(()=>this.core.$$waitForReplicationOnce()))}));return Promise.resolve(true)}async setReplicator(){const replicator=await this.core.$anyNewReplicator();if(!replicator){this._log("No replicator is available, this is the fatal error.",LOG_LEVEL_NOTICE);return false}this.core.replicator=replicator;await yieldMicrotask();return true}$$getReplicator(){return this.core.replicator}$everyOnInitializeDatabase(db){return this.setReplicator()}$everyOnResetDatabase(db){return this.setReplicator()}async $everyBeforeReplicate(showMessage){await this.loadQueuedFiles();return true}async $$replicate(showMessage=false){var _a5;if(!this.core.$$isReady())return;if(isLockAcquired("cleanup")){Logger("Database cleaning up is in process. replication has been cancelled",LOG_LEVEL_NOTICE);return}if(""!=this.settings.versionUpFlash){Logger("Open settings and check message, please. replication has been cancelled.",LOG_LEVEL_NOTICE);return}if(!await this.core.$everyCommitPendingFileEvent()){Logger("Some file events are pending. Replication has been cancelled.",LOG_LEVEL_NOTICE);return false}if(!await this.core.$everyBeforeReplicate(showMessage)){Logger("Replication has been cancelled by some module failure",LOG_LEVEL_NOTICE);return false}const ret=await this.core.replicator.openReplication(this.settings,false,showMessage,false);if(!ret)if(this.core.replicator.tweakSettingsMismatched)await this.core.$$askResolvingMismatchedTweaks();else if(null==(_a5=this.core.replicator)?void 0:_a5.remoteLockedAndDeviceNotAccepted)if(this.core.replicator.remoteCleaned&&this.settings.useIndexedDBAdapter){Logger("The remote database has been cleaned.",showMessage?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO);await skipIfDuplicated("cleanup",(async()=>{const message=`The remote database has been cleaned up.\nTo synchronize, this device must be also cleaned up. ${await purgeUnreferencedChunks(this.localDatabase.localDatabase,true)} chunk(s) will be erased from this device.\nHowever, If there are many chunks to be deleted, maybe fetching again is faster.\nWe will lose the history of this device if we fetch the remote database again.\nEven if you choose to clean up, you will see this option again if you exit Obsidian and then synchronise again.`,ret2=await this.core.confirm.confirmWithMessage("Cleaned",message,["Fetch again","Cleanup","Dismiss"],"Dismiss",30);if("Fetch again"==ret2)await this.core.rebuilder.$performRebuildDB("localOnly");if("Cleanup"==ret2){const replicator=this.core.$$getReplicator();if(!(replicator instanceof LiveSyncCouchDBReplicator))return;const remoteDB=await replicator.connectRemoteCouchDBWithSetting(this.settings,this.core.$$isMobile(),true);if("string"==typeof remoteDB){Logger(remoteDB,LOG_LEVEL_NOTICE);return false}await purgeUnreferencedChunks(this.localDatabase.localDatabase,false);this.localDatabase.hashCaches.clear();if(await this.core.replicator.openReplication(this.settings,false,showMessage,true)){await balanceChunkPurgedDBs(this.localDatabase.localDatabase,remoteDB.db);await purgeUnreferencedChunks(this.localDatabase.localDatabase,false);this.localDatabase.hashCaches.clear();await this.core.$$getReplicator().markRemoteResolved(this.settings);Logger("The local database has been cleaned up.",showMessage?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO)}else Logger("Replication has been cancelled. Please try it again.",showMessage?LOG_LEVEL_NOTICE:LOG_LEVEL_INFO)}}))}else{const message="\nThe remote database has been rebuilt.\nTo synchronize, this device must fetch everything again once.\nOr if you are sure know what had been happened, we can unlock the database from the setting dialog.\n                    ",CHOICE_FETCH="Fetch again",CHOICE_DISMISS="Dismiss";if(await this.core.confirm.confirmWithMessage("Locked",message,[CHOICE_FETCH,CHOICE_DISMISS],CHOICE_DISMISS,10)==CHOICE_FETCH){const CHOICE_RESTART="Restart",CHOICE_WITHOUT_RESTART="Without restart";if(await this.core.confirm.askSelectStringDialogue("Self-hosted LiveSync restarts Obsidian to fetch everything safely. However, you can do it without restarting. Please choose one.",[CHOICE_RESTART,CHOICE_WITHOUT_RESTART],{title:"Fetch again",defaultAction:CHOICE_RESTART,timeout:30})==CHOICE_RESTART){await this.core.rebuilder.scheduleFetch();return}else await this.core.rebuilder.$performRebuildDB("localOnly")}}return ret}$$parseReplicationResult(docs){if(this.settings.suspendParseReplicationResult&&!this.replicationResultProcessor.isSuspended)this.replicationResultProcessor.suspend();this.replicationResultProcessor.enqueueAll(docs);if(!this.settings.suspendParseReplicationResult&&this.replicationResultProcessor.isSuspended)this.replicationResultProcessor.resume()}saveQueuedFiles(){this._saveQueuedFiles()}async loadQueuedFiles(){var _a5;if(this.settings.suspendParseReplicationResult)return;if(!this.settings.isConfigured)return;const chunkedIds=arrayToChunkedArray([...new Set(null!=(_a5=await this.core.kvDB.get("queued-files"))?_a5:[])],100);for await(const idsBatch of chunkedIds){const ret=await this.localDatabase.allDocsRaw({keys:idsBatch,include_docs:true,limit:100}),docs=ret.rows.filter((e4=>e4.doc)).map((e4=>e4.doc)),errors=ret.rows.filter((e4=>!e4.doc&&!e4.value.deleted));if(errors.length>0){Logger("Some queued processes were not resurrected");Logger(JSON.stringify(errors),LOG_LEVEL_VERBOSE)}this.replicationResultProcessor.enqueueAll(docs);await this.replicationResultProcessor.waitForAllProcessed()}}$everyBeforeSuspendProcess(){this.core.replicator.closeReplication();return Promise.resolve(true)}async $$replicateAllToServer(showingNotice=false,sendChunksInBulkDisabled=false){if(!this.core.$$isReady())return false;if(!await this.core.$everyBeforeReplicate(showingNotice)){Logger("Replication has been cancelled by some module failure",LOG_LEVEL_NOTICE);return false}if(!sendChunksInBulkDisabled)if(this.core.replicator instanceof LiveSyncCouchDBReplicator)if("yes"==await this.core.confirm.askYesNoDialog("Do you want to send all chunks before replication?",{defaultOption:"No",timeout:20}))await this.core.replicator.sendChunks(this.core.settings,void 0,true,0);if(await this.core.replicator.replicateAllToServer(this.settings,showingNotice))return true;const checkResult=await this.core.$anyAfterConnectCheckFailed();if("CHECKAGAIN"==checkResult)return await this.core.$$replicateAllToServer(showingNotice);else return!checkResult}async $$replicateAllFromServer(showingNotice=false){if(!this.core.$$isReady())return false;if(await this.core.replicator.replicateAllFromServer(this.settings,showingNotice))return true;const checkResult=await this.core.$anyAfterConnectCheckFailed();if("CHECKAGAIN"==checkResult)return await this.core.$$replicateAllFromServer(showingNotice);else return!checkResult}async $$waitForReplicationOnce(){return await shareRunningResult("replication",(()=>this.core.$$replicate()))}},ModuleReplicatorCouchDB=class extends AbstractModule{$anyNewReplicator(settingOverride={}){if({...this.settings,...settingOverride}.remoteType!=REMOTE_MINIO)return Promise.resolve(new LiveSyncCouchDBReplicator(this.core))}$everyAfterResumeProcess(){if(this.settings.remoteType!=REMOTE_MINIO){if(this.settings.liveSync)fireAndForget((()=>this.core.replicator.openReplication(this.settings,true,false,false)));if(!this.settings.liveSync&&this.settings.syncOnStart)fireAndForget((()=>this.core.replicator.openReplication(this.settings,false,false,false)))}return Promise.resolve(true)}},ModuleReplicatorMinIO=class extends AbstractModule{$anyNewReplicator(settingOverride={}){if({...this.settings,...settingOverride}.remoteType==REMOTE_MINIO)return Promise.resolve(new LiveSyncJournalReplicator(this.core))}},ModuleTargetFilter=class extends AbstractModule{constructor(){super(...arguments);this.totalFileEventCount=0;this.ignoreFileCache=new LRUCache(300,25e4,true);this.ignoreFiles=[]}reloadIgnoreFiles(){this.ignoreFiles=this.settings.ignoreFiles.split(",").map((e4=>e4.trim()))}$everyOnload(){eventHub.onEvent(EVENT_SETTING_SAVED,(evt=>{this.reloadIgnoreFiles()}));eventHub.onEvent(EVENT_REQUEST_RELOAD_SETTING_TAB,(()=>{this.reloadIgnoreFiles()}));return Promise.resolve(true)}$$id2path(id,entry,stripPrefix2){const tempId=id2path(id,entry);if(stripPrefix2&&isInternalMetadata(tempId))return stripInternalMetadataPrefix(tempId);else return tempId}async $$path2id(filename,prefix){const destPath=addPrefix(filename,null!=prefix?prefix:"");return await path2id(destPath,this.settings.usePathObfuscation?this.settings.passphrase:"",!this.settings.handleFilenameCaseSensitive)}$$isFileSizeExceeded(size){if(this.settings.syncMaxSizeInMB>0&&size>0)if(1024*this.settings.syncMaxSizeInMB*1024<size)return true;return false}$$markFileListPossiblyChanged(){this.totalFileEventCount++}get fileListPossiblyChanged(){if(isDirty("totalFileEventCount",this.totalFileEventCount))return true;else return false}async $$isTargetFile(file,keepFileCheckList=false){var _a5,_b2;const fileCount=useMemo({key:"fileCount"},((ctx,prev)=>{var _a6;if(keepFileCheckList&&prev)return prev;if(!keepFileCheckList&&prev&&!this.fileListPossiblyChanged)return prev;const fileList=null!=(_a6=ctx.get("fileList"))?_a6:[],vaultFiles=this.core.storageAccess.getFileNames().sort();if(prev&&vaultFiles.length==fileList.length){const fl3=new Set([...fileList,...vaultFiles]);if(fileList.length==fl3.size&&vaultFiles.length==fl3.size)return prev}ctx.set("fileList",vaultFiles);const fileCount2={};for(const file2 of vaultFiles){const lc3=file2.toLowerCase();if(!fileCount2[lc3])fileCount2[lc3]=1;else fileCount2[lc3]++}return fileCount2})),filepath=getStoragePathFromUXFileInfo(file),lc2=filepath.toLowerCase();if(this.core.$$shouldCheckCaseInsensitive())if(lc2 in fileCount&&fileCount[lc2]>1)return false;const fileNameLC=null==(_a5=getStoragePathFromUXFileInfo(file).split("/").pop())?void 0:_a5.toLowerCase();if(this.settings.useIgnoreFiles){if(this.ignoreFiles.some((e4=>e4.toLowerCase()==fileNameLC)))await this.readIgnoreFile(filepath);if(await this.core.$$isIgnoredByIgnoreFiles(file))return false}if(!(null==(_b2=this.localDatabase)?void 0:_b2.isTargetFile(filepath)))return false;else return true}async readIgnoreFile(path2){try{const gitignore=(await this.core.storageAccess.readFileText(path2)).split(/\r?\n/g);this.ignoreFileCache.set(path2,gitignore);return gitignore}catch(ex){this._log(`Failed to read ignore file ${path2}`);this._log(ex,LOG_LEVEL_VERBOSE);this.ignoreFileCache.set(path2,false);return false}}async getIgnoreFile(path2){var _a5;if(this.ignoreFileCache.has(path2))return null!=(_a5=this.ignoreFileCache.get(path2))?_a5:false;else return await this.readIgnoreFile(path2)}async $$isIgnoredByIgnoreFiles(file){if(!this.settings.useIgnoreFiles)return false;const filepath=getStoragePathFromUXFileInfo(file);if(this.ignoreFileCache.has(filepath))await this.readIgnoreFile(filepath);if(!await isAcceptedAll(filepath,this.ignoreFiles,(filename=>this.getIgnoreFile(filename))))return true;else return false}},ModulePeriodicProcess=class extends AbstractModule{constructor(){super(...arguments);this.periodicSyncProcessor=new PeriodicProcessor(this.core,(async()=>await this.core.$$replicate()))}_disablePeriodic(){var _a5;null==(_a5=this.periodicSyncProcessor)||_a5.disable();return Promise.resolve(true)}_resumePeriodic(){this.periodicSyncProcessor.enable(this.settings.periodicReplication?1e3*this.settings.periodicReplicationInterval:0);return Promise.resolve(true)}$allOnUnload(){return this._disablePeriodic()}$everyBeforeRealizeSetting(){return this._disablePeriodic()}$everyBeforeSuspendProcess(){return this._disablePeriodic()}$everyAfterResumeProcess(){return this._resumePeriodic()}$everyAfterRealizeSetting(){return this._resumePeriodic()}},ModuleRemoteGovernor=class extends AbstractModule{async $$markRemoteLocked(lockByClean=false){return await this.core.replicator.markRemoteLocked(this.settings,true,lockByClean)}async $$markRemoteUnlocked(){return await this.core.replicator.markRemoteLocked(this.settings,false,false)}async $$markRemoteResolved(){return await this.core.replicator.markRemoteResolved(this.settings)}},ModuleLocalDatabaseObsidian=class extends AbstractModule{$everyOnloadStart(){return Promise.resolve(true)}async $$openDatabase(){if(null!=this.localDatabase)await this.localDatabase.close();const vaultName=this.core.$$getVaultName();this._log($f`Waiting for ready...`);this.core.localDatabase=new LiveSyncLocalDB(vaultName,this.core);initializeStores(vaultName);return await this.localDatabase.initializeDatabase()}$$isDatabaseReady(){return null!=this.localDatabase&&this.localDatabase.isReady}},ModuleConflictChecker=class extends AbstractModule{constructor(){super(...arguments);this.conflictResolveQueue=new QueueProcessor((async filenames=>{await this.core.$$resolveConflict(filenames[0])}),{suspended:false,batchSize:1,concurrentLimit:1,delay:10,keepResultUntilDownstreamConnected:false}).replaceEnqueueProcessor(((queue2,newEntity)=>{sendValue("cancel-resolve-conflict:"+newEntity,true);return[...[...queue2].filter((e4=>e4!=newEntity)),newEntity]}));this.conflictCheckQueue=new QueueProcessor((files=>{const filename=files[0];return Promise.resolve([filename])}),{suspended:false,batchSize:1,concurrentLimit:5,delay:10,keepResultUntilDownstreamConnected:true,pipeTo:this.conflictResolveQueue,totalRemainingReactiveSource:this.core.conflictProcessQueueCount})}async $$queueConflictCheckIfOpen(file){const path2=file;if(this.settings.checkConflictOnlyOnOpen){const af2=this.core.$$getActiveFilePath();if(af2&&af2!=path2){this._log(`${file} is conflicted, merging process has been postponed.`,LOG_LEVEL_NOTICE);return}}await this.core.$$queueConflictCheck(path2)}async $$queueConflictCheck(file){const optionalConflictResult=await this.core.$anyGetOptionalConflictCheckMethod(file);if(true!=optionalConflictResult)if("newer"===optionalConflictResult)await this.core.$anyResolveConflictByNewest(file);else this.conflictCheckQueue.enqueue(file)}$$waitForAllConflictProcessed(){return this.conflictResolveQueue.waitForAllProcessed()}},ModuleResolvingMismatchedTweaks=class extends AbstractModule{async $anyAfterConnectCheckFailed(){if(!this.core.replicator.tweakSettingsMismatched)return false;const ret=await this.core.$$askResolvingMismatchedTweaks();if("OK"==ret)return false;if("CHECKAGAIN"==ret)return"CHECKAGAIN";if("IGNORE"==ret)return true}async $$askResolvingMismatchedTweaks(){if(!this.core.replicator.tweakSettingsMismatched)return"OK";const preferred=extractObject(TweakValuesShouldMatchedTemplate,this.core.replicator.preferredTweakValue),mine=extractObject(TweakValuesShouldMatchedTemplate,this.settings),items=Object.entries(TweakValuesShouldMatchedTemplate);let rebuildRequired=false,table2="| Value name | This device | Configured | \n|: --- |: --- :|: ---- :| \n";for(const v2 of items){const key2=v2[0],valueMine=escapeMarkdownValue(mine[key2]),valuePreferred=escapeMarkdownValue(preferred[key2]);if(valueMine!=valuePreferred){if(-1!==CompatibilityBreakingTweakValues.indexOf(key2))rebuildRequired=true;table2+=`| ${confName(key2)} | ${valueMine} | ${valuePreferred} | \n`}}const message=`\nYour configuration has not been matched with the one on the remote server.\n(Which you had decided once before, or set by initially synchronised device).\n\nConfigured values:\n\n${table2}\n\nPlease select which one you want to use.\n\n- Use configured: Update settings of this device by configured one on the remote server.\n  You should select this if you have changed the settings on ** another device **.\n- Update with mine: Update settings on the remote server by the settings of this device.\n  You should select this if you have changed the settings on ** this device **.\n- Dismiss: Ignore this message and keep the current settings.\n  You cannot synchronise until you resolve this issue without enabling \`Do not check configuration mismatch before replication\`.${rebuildRequired?"\n\n**Note**: We have detected that some of the values are different to make incompatible the local database with the remote database.\nIf you choose to use the configured values, the local database will be rebuilt, and if you choose to use the values of this device, the remote database will be rebuilt. \nBoth of them takes a few minutes. Please choose after considering the situation.":""}`,CHOICE_AND_VALUES=[["Use configured",preferred],["Update with mine",true],["Dismiss",false]],CHOICES=Object.fromEntries(CHOICE_AND_VALUES),retKey=await this.core.confirm.confirmWithMessage("Tweaks Mismatched or Changed",message,Object.keys(CHOICES),"Dismiss",60);if(!retKey)return"IGNORE";const conf=CHOICES[retKey];if(true===conf){await this.core.replicator.setPreferredRemoteTweakSettings(this.settings);if(rebuildRequired)await this.core.rebuilder.$rebuildRemote();Logger("Tweak values on the remote server have been updated. Your other device will see this message.",LOG_LEVEL_NOTICE);return"CHECKAGAIN"}if(conf){this.settings={...this.settings,...conf};await this.core.replicator.setPreferredRemoteTweakSettings(this.settings);await this.core.$$saveSettingData();if(rebuildRequired)await this.core.rebuilder.$fetchLocal();Logger("Configuration has been updated as configured by the other device.",LOG_LEVEL_NOTICE);return"CHECKAGAIN"}return"IGNORE"}async $$checkAndAskUseRemoteConfiguration(trialSetting){const replicator=await this.core.$anyNewReplicator(trialSetting);if(await replicator.tryConnectRemote(trialSetting)){const preferred=await replicator.getRemotePreferredTweakValues(trialSetting);if(preferred){const items=Object.entries(TweakValuesShouldMatchedTemplate);let rebuildRequired=false,table2="| Value name | This device | Stored | \n|: --- |: ---- :|: ---- :| \n",differenceCount=0;for(const v2 of items){const key2=v2[0],valuePreferred=escapeMarkdownValue(preferred[key2]),currentDisp=`${escapeMarkdownValue(null==trialSetting?void 0:trialSetting[key2])} |`;if((null==trialSetting?void 0:trialSetting[key2])!==preferred[key2]){if(-1!==CompatibilityBreakingTweakValues.indexOf(key2))rebuildRequired=true;table2+=`| ${confName(key2)} | ${currentDisp} ${valuePreferred} | \n`;differenceCount++}}if(0===differenceCount){this._log("The settings in the remote database are the same as the local database.",LOG_LEVEL_NOTICE);return{result:false,requireFetch:false}}const message=`\nThe settings in the remote database are as follows.\nIf you want to use these settings, please select "Use configured".\nIf you want to keep the settings of this device, please select "Dismiss".\n\n${table2}\n\n>[!TIP]\n> If you want to synchronise all settings, please use \`Sync settings via markdown\` after applying minimal configuration with this feature.\n\n${rebuildRequired&&this.core.settings.isConfigured?"\n\n>[!WARNING]\n> Some remote configurations are not compatible with the local database of this device. Rebuilding the local database will be required.\n***Please ensure that you have time and are connected to a stable network to apply!***":""}`,CHOICE_USE_REMOTE="Use configured",CHOICE_DISMISS="Dismiss",CHOICES=[CHOICE_USE_REMOTE,CHOICE_DISMISS],retKey=await this.core.confirm.askSelectStringDialogue(message,CHOICES,{title:"Use Remote Configuration",timeout:0,defaultAction:CHOICE_DISMISS});if(!retKey)return{result:false,requireFetch:false};if(retKey===CHOICE_DISMISS)return{result:false,requireFetch:false};if(retKey===CHOICE_USE_REMOTE)return{result:{...trialSetting,...preferred},requireFetch:rebuildRequired}}else this._log("Failed to get the preferred tweak values from the remote server.",LOG_LEVEL_NOTICE);return{result:false,requireFetch:false}}else{this._log("Failed to connect to the remote server.",LOG_LEVEL_NOTICE);return{result:false,requireFetch:false}}}},ModuleIntegratedTest=class extends AbstractObsidianModule{async waitFor(proc,timeout=1e4){await delay(100);const start=Date.now();for(;!await proc();){if(timeout>0)if(Date.now()-start>timeout){this._log("Timeout");return false}await delay(500)}return true}waitWithReplicating(proc,timeout=1e4){return this.waitFor((async()=>{await this.tryReplicate();return await proc()}),timeout)}async storageContentIsEqual(file,content){try{if(await this.readStorageContent(file)===content)return true;else return false}catch(e4){this._log(`Error: ${e4}`);return false}}async assert(proc){if(!await proc()){this._log("Assertion failed");return false}return true}async _orDie(key2,proc){if(!await this._test(key2,proc))throw new Error(`${key2}`);return true}tryReplicate(){if(!this.settings.liveSync)return shareRunningResult("replicate-test",(async()=>{await this.core.$$replicate()}))}async readStorageContent(file){if(await this.core.storageAccess.isExistsIncludeHidden(file))return await this.core.storageAccess.readHiddenFileText(file)}async _proceed(no,title){const stepContent=`Step ${no}`;await this.core.$anyResolveConflictByNewest("_STEP.md");await this.core.storageAccess.writeFileAuto("_STEP.md",stepContent);await this._orDie(`Wait for acknowledge ${no}`,(async()=>{if(!await this.waitWithReplicating((async()=>await this.storageContentIsEqual("_STEP_ACK.md",stepContent)),2e4))return false;else return true}));return true}async _join(no,title){const stepContent=`Step ${no}`;await this._orDie(`Wait for step ${no} (${title})`,(async()=>{if(!await this.waitWithReplicating((async()=>await this.storageContentIsEqual("_STEP.md",stepContent)),2e4))return false;else return true}));await this.core.$anyResolveConflictByNewest("_STEP_ACK.md");await this.core.storageAccess.writeFileAuto("_STEP_ACK.md",stepContent);await this.tryReplicate();return true}async performStep({step,title,isGameChanger,proc,check}){if(isGameChanger){await this._proceed(step,title);try{await proc()}catch(e4){this._log(`Error: ${e4}`);return false}return await this._orDie(`Step ${step} - ${title}`,(async()=>await this.waitWithReplicating(check)))}else return await this._join(step,title)}async nonLiveTestRunner(isLeader,testMain){const storage=this.core.storageAccess;let testFileName;this.addTestResult("-------Starting ... ",true,`Test as ${isLeader?"Leader":"Receiver"} command file IT.md`);if(isLeader)await this._proceed(0,"start");await this.tryReplicate();await this.performStep({step:0,title:"Make sure that command File Not Exists",isGameChanger:isLeader,proc:async()=>await storage.removeHidden("IT.md"),check:async()=>!await storage.isExistsIncludeHidden("IT.md")});await this.performStep({step:1,title:"Make sure that command File Not Exists On Receiver",isGameChanger:!isLeader,proc:async()=>await storage.removeHidden("ITx.md"),check:async()=>!await storage.isExistsIncludeHidden("ITx.md")});await this.performStep({step:2,title:"Decide the test file name",isGameChanger:isLeader,proc:async()=>{testFileName=Date.now()+"-"+Math.ceil(1e3*Math.random())+".md";await storage.writeFileAuto("IT.md",testFileName)},check:()=>Promise.resolve(true)});await this.performStep({step:3,title:"Wait for the command file to be arrived",isGameChanger:!isLeader,proc:async()=>{},check:async()=>await storage.isExistsIncludeHidden("IT.md")});await this.performStep({step:4,title:"Send the response file",isGameChanger:!isLeader,proc:async()=>{await storage.writeHiddenFileAuto("ITx.md","!")},check:()=>Promise.resolve(true)});await this.performStep({step:5,title:"Wait for the response file to be arrived",isGameChanger:isLeader,proc:async()=>{},check:async()=>await storage.isExistsIncludeHidden("ITx.md")});await this.performStep({step:6,title:"Proceed to begin the test",isGameChanger:isLeader,proc:async()=>{},check:()=>Promise.resolve(true)});await this.performStep({step:6,title:"Begin the test",isGameChanger:true,proc:async()=>{},check:()=>Promise.resolve(true)});try{this.addTestResult("** Main------",true,"");if(isLeader)return await testMain(testFileName,true);else{const testFileName2=await this.readStorageContent("IT.md");this.addTestResult("testFileName",true,`Request client to use :${testFileName2}`);return await testMain(testFileName2,false)}}finally{this.addTestResult("Teardown",true,`Deleting ${testFileName}`);await storage.removeHidden(testFileName)}return true}async testBasic(filename,isLeader){const storage=this.core.storageAccess,database=this.core.databaseFileAccess;await this.addTestResult("---**Starting Basic Test**---",true,`Test as ${isLeader?"Leader":"Receiver"} command file ${filename}`);await this.performStep({step:0,title:"Make sure that file is not exist",isGameChanger:!isLeader,proc:async()=>{},check:async()=>!await storage.isExists(filename)});await this.performStep({step:1,title:"Write a file",isGameChanger:isLeader,proc:async()=>await storage.writeFileAuto(filename,"Hello World"),check:async()=>await storage.isExists(filename)});await this.performStep({step:2,title:"Make sure the file is arrived",isGameChanger:!isLeader,proc:async()=>{},check:async()=>await storage.isExists(filename)});await this.performStep({step:3,title:"Update to Hello World 2",isGameChanger:isLeader,proc:async()=>await storage.writeFileAuto(filename,"Hello World 2"),check:async()=>await this.storageContentIsEqual(filename,"Hello World 2")});await this.performStep({step:4,title:"Make sure the modified file is arrived",isGameChanger:!isLeader,proc:async()=>{},check:async()=>await this.storageContentIsEqual(filename,"Hello World 2")});await this.performStep({step:5,title:"Update to Hello World 3",isGameChanger:!isLeader,proc:async()=>await storage.writeFileAuto(filename,"Hello World 3"),check:async()=>await this.storageContentIsEqual(filename,"Hello World 3")});await this.performStep({step:6,title:"Make sure the modified file is arrived",isGameChanger:isLeader,proc:async()=>{},check:async()=>await this.storageContentIsEqual(filename,"Hello World 3")});await this.performStep({step:7,title:"Update to Multiline",isGameChanger:isLeader,proc:async()=>await storage.writeFileAuto(filename,"Line1:A\nLine2:B\nLine3:C\nLine4:D"),check:async()=>await this.storageContentIsEqual(filename,"Line1:A\nLine2:B\nLine3:C\nLine4:D")});await this.performStep({step:8,title:"Make sure the modified file is arrived",isGameChanger:!isLeader,proc:async()=>{},check:async()=>await this.storageContentIsEqual(filename,"Line1:A\nLine2:B\nLine3:C\nLine4:D")});if(!this.settings.liveSync){const multiLineContentL="Line1:A\nLine2:B\nLine3:C!\nLine4:D",multiLineContentC="Line1:A\nLine2:bbbbb\nLine3:C\nLine4:D";await this.performStep({step:9,title:"Progress to be conflicted",isGameChanger:isLeader,proc:async()=>{},check:()=>Promise.resolve(true)});await storage.writeFileAuto(filename,isLeader?multiLineContentL:multiLineContentC);await this.performStep({step:10,title:"Update As Conflicted",isGameChanger:!isLeader,proc:async()=>{},check:()=>Promise.resolve(true)});await this.performStep({step:10,title:"Make sure Automatically resolved",isGameChanger:isLeader,proc:async()=>{},check:async()=>0===(await database.getConflictedRevs(filename)).length});await this.performStep({step:11,title:"Make sure Automatically resolved",isGameChanger:!isLeader,proc:async()=>{},check:async()=>0===(await database.getConflictedRevs(filename)).length});const sensiblyMergedContent="Line1:A\nLine2:bbbbb\nLine3:C!\nLine4:D";await this.performStep({step:12,title:"Make sure Sensibly Merged on Leader",isGameChanger:isLeader,proc:async()=>{},check:async()=>await this.storageContentIsEqual(filename,sensiblyMergedContent)});await this.performStep({step:13,title:"Make sure Sensibly Merged on Receiver",isGameChanger:!isLeader,proc:async()=>{},check:async()=>await this.storageContentIsEqual(filename,sensiblyMergedContent)})}await this.performStep({step:14,title:"Delete File",isGameChanger:isLeader,proc:async()=>{await storage.removeHidden(filename)},check:async()=>!await storage.isExists(filename)});await this.performStep({step:15,title:"Make sure File is deleted",isGameChanger:!isLeader,proc:async()=>{},check:async()=>!await storage.isExists(filename)});this._log("The Basic Test has been completed",LOG_LEVEL_NOTICE);return true}async testBasicEvent(isLeader){this.settings.liveSync=false;await this.saveSettings();await this._test("basic",(async()=>await this.nonLiveTestRunner(isLeader,((t4,l2)=>this.testBasic(t4,l2)))))}async testBasicLive(isLeader){this.settings.liveSync=true;await this.saveSettings();await this._test("basic",(async()=>await this.nonLiveTestRunner(isLeader,((t4,l2)=>this.testBasic(t4,l2)))))}async $everyModuleTestMultiDevice(){if(!this.settings.enableDebugTools)return Promise.resolve(true);const isLeader=-1===this.core.$$vaultName().indexOf("recv");this.addTestResult("-------",true,"Test as "+(isLeader?"Leader":"Receiver"));try{this._log("Starting Test");await this.testBasicEvent(isLeader);if(this.settings.remoteType==REMOTE_MINIO)await this.testBasicLive(isLeader)}catch(e4){this._log(e4);this._log(`Error: ${e4}`);return Promise.resolve(false)}return Promise.resolve(true)}},ModuleRebuilder=class extends AbstractModule{$everyOnload(){this.core.rebuilder=this;return Promise.resolve(true)}async $performRebuildDB(method){if("localOnly"==method)await this.$fetchLocal();if("localOnlyWithChunks"==method)await this.$fetchLocal(true);if("remoteOnly"==method)await this.$rebuildRemote();if("rebuildBothByThisDevice"==method)await this.$rebuildEverything()}async askUsingOptionalFeature(opt){if("yes"==await this.core.confirm.askYesNoDialog("Do you want to enable extra features? If you are new to Self-hosted LiveSync, try the core feature first!",{title:"Enable extra features",defaultOption:"No",timeout:15}))await this.core.$allAskUsingOptionalSyncFeature(opt)}async rebuildRemote(){await this.core.$allSuspendExtraSync();this.core.settings.isConfigured=true;await this.core.$$realizeSettingSyncMode();await this.core.$$markRemoteLocked();await this.core.$$tryResetRemoteDatabase();await this.core.$$markRemoteLocked();await delay(500);await this.askUsingOptionalFeature({enableOverwrite:true});await delay(1e3);await this.core.$$replicateAllToServer(true);await delay(1e3);await this.core.$$replicateAllToServer(true,true)}$rebuildRemote(){return this.rebuildRemote()}async rebuildEverything(){await this.core.$allSuspendExtraSync();await this.askUseNewAdapter();this.core.settings.isConfigured=true;await this.core.$$realizeSettingSyncMode();await this.resetLocalDatabase();await delay(1e3);await this.core.$$initializeDatabase(true);await this.core.$$markRemoteLocked();await this.core.$$tryResetRemoteDatabase();await this.core.$$markRemoteLocked();await delay(500);await this.askUsingOptionalFeature({enableOverwrite:false});await delay(1e3);await this.core.$$replicateAllToServer(true);await delay(1e3);await this.core.$$replicateAllToServer(true,true)}$rebuildEverything(){return this.rebuildEverything()}$fetchLocal(makeLocalChunkBeforeSync){return this.fetchLocal(makeLocalChunkBeforeSync)}async scheduleRebuild(){try{await this.core.storageAccess.writeFileAuto(FLAGMD_REDFLAG2_HR,"")}catch(ex){this._log("Could not create red_flag_rebuild.md",LOG_LEVEL_NOTICE);this._log(ex,LOG_LEVEL_VERBOSE)}this.core.$$performRestart()}async scheduleFetch(){try{await this.core.storageAccess.writeFileAuto(FLAGMD_REDFLAG3_HR,"")}catch(ex){this._log("Could not create red_flag_fetch.md",LOG_LEVEL_NOTICE);this._log(ex,LOG_LEVEL_VERBOSE)}this.core.$$performRestart()}async $$tryResetRemoteDatabase(){await this.core.replicator.tryResetRemoteDatabase(this.settings)}async $$tryCreateRemoteDatabase(){await this.core.replicator.tryCreateRemoteDatabase(this.settings)}async $$resetLocalDatabase(){this.core.storageAccess.clearTouched();await this.localDatabase.resetDatabase()}async suspendAllSync(){this.core.settings.liveSync=false;this.core.settings.periodicReplication=false;this.core.settings.syncOnSave=false;this.core.settings.syncOnEditorSave=false;this.core.settings.syncOnStart=false;this.core.settings.syncOnFileOpen=false;this.core.settings.syncAfterMerge=false;await this.core.$allSuspendExtraSync()}async suspendReflectingDatabase(){if(!this.core.settings.doNotSuspendOnFetching)if(this.core.settings.remoteType!=REMOTE_MINIO){this._log("Suspending reflection: Database and storage changes will not be reflected in each other until completely finished the fetching.",LOG_LEVEL_NOTICE);this.core.settings.suspendParseReplicationResult=true;this.core.settings.suspendFileWatching=true;await this.core.saveSettings()}}async resumeReflectingDatabase(){if(!this.core.settings.doNotSuspendOnFetching)if(this.core.settings.remoteType!=REMOTE_MINIO){this._log("Database and storage reflection has been resumed!",LOG_LEVEL_NOTICE);this.core.settings.suspendParseReplicationResult=false;this.core.settings.suspendFileWatching=false;await this.core.$$performFullScan(true);await this.core.$everyBeforeReplicate(false);await this.core.saveSettings()}}async askUseNewAdapter(){if(!this.core.settings.useIndexedDBAdapter){const message="Now this core has been configured to use the old database adapter for keeping compatibility. Do you want to deactivate it?",CHOICE_YES="Yes, disable and use latest",choices=[CHOICE_YES,"No, keep compatibility"];if(await this.core.confirm.confirmWithMessage("Database adapter",message,choices,CHOICE_YES,10)==CHOICE_YES)this.core.settings.useIndexedDBAdapter=true}}async fetchLocal(makeLocalChunkBeforeSync){await this.core.$allSuspendExtraSync();await this.askUseNewAdapter();this.core.settings.isConfigured=true;await this.suspendReflectingDatabase();await this.core.$$realizeSettingSyncMode();await this.resetLocalDatabase();await delay(1e3);await this.core.$$openDatabase();this.core.$$markIsReady();if(makeLocalChunkBeforeSync)await this.core.fileHandler.createAllChunks(true);await this.core.$$markRemoteResolved();await delay(500);await this.core.$$replicateAllFromServer(true);await delay(1e3);await this.core.$$replicateAllFromServer(true);await this.resumeReflectingDatabase();await this.askUsingOptionalFeature({enableFetch:true})}async fetchLocalWithRebuild(){return await this.fetchLocal(true)}async $allSuspendAllSync(){await this.suspendAllSync();return true}async resetLocalDatabase(){if(this.core.settings.isConfigured&&""==this.core.settings.additionalSuffixOfDatabaseName)await this.core.$$resetLocalDatabase();const suffix=await this.core.$anyGetAppId()||"";this.core.settings.additionalSuffixOfDatabaseName=suffix;await this.core.$$resetLocalDatabase()}async fetchRemoteChunks(){if(!this.core.settings.doNotSuspendOnFetching&&this.core.settings.readChunksOnline&&this.core.settings.remoteType==REMOTE_COUCHDB){this._log("Fetching chunks",LOG_LEVEL_NOTICE);const replicator=this.core.$$getReplicator(),remoteDB=await replicator.connectRemoteCouchDBWithSetting(this.settings,this.core.$$isMobile(),true);if("string"==typeof remoteDB)this._log(remoteDB,LOG_LEVEL_NOTICE);else await fetchAllUsedChunks(this.localDatabase.localDatabase,remoteDB.db);this._log("Fetching chunks done",LOG_LEVEL_NOTICE)}}async resolveAllConflictedFilesByNewerOnes(){this._log("Resolving conflicts by newer ones",LOG_LEVEL_NOTICE);const files=this.core.storageAccess.getFileNames();let i2=0;for(const file of files){if(i2++%10)this._log(`Check and Processing ${i2} / ${files.length}`,LOG_LEVEL_NOTICE,"resolveAllConflictedFilesByNewerOnes");await this.core.$anyResolveConflictByNewest(file)}this._log("Done!",LOG_LEVEL_NOTICE,"resolveAllConflictedFilesByNewerOnes")}},import_crypto2=require("crypto"),import_obsidian12=require("obsidian"),ModuleReplicateTest=class extends AbstractObsidianModule{constructor(){super(...arguments);this.testRootPath="_test/";this.testInfoPath="_testinfo/";this.watchIsSynchronised=false}get isLeader(){return this.core.$$getVaultName().indexOf("dev")>=0&&this.core.$$vaultName().indexOf("recv")<0}get nameByKind(){if(!this.isLeader)return"RECV";else if(this.isLeader)return"LEADER"}get pairName(){if(this.isLeader)return"RECV";else if(!this.isLeader)return"LEADER"}async readFileContent(file){try{return await this.core.storageAccess.readHiddenFileText(file)}catch(e4){return""}}async dumpList(){if(this.settings.syncInternalFiles){this._log("Write file list (Include Hidden)");await this._dumpFileListIncludeHidden("files.md")}else{this._log("Write file list");await this._dumpFileList("files.md")}}async $everyBeforeReplicate(showMessage){if(!this.settings.enableDebugTools)return Promise.resolve(true);await this.dumpList();return true}$everyOnloadAfterLoadSettings(){if(!this.settings.enableDebugTools)return Promise.resolve(true);this.addCommand({id:"dump-file-structure-normal",name:"Dump Structure (Normal)",callback:()=>{this._dumpFileList("files.md").finally((()=>{this.refreshSyncStatus()}))}});this.addCommand({id:"dump-file-structure-ih",name:"Dump Structure (Include Hidden)",callback:()=>{this._dumpFileListIncludeHidden("files.md")}});this.addCommand({id:"dump-file-structure-auto",name:"Dump Structure",callback:()=>{this.dumpList()}});this.addCommand({id:"dump-file-test",name:"Perform Test (Dev) "+(this.isLeader?"(Leader)":"(Recv)"),callback:()=>{this.performTestManually()}});this.addCommand({id:"watch-sync-result",name:"Watch sync result is matched between devices",callback:()=>{this.watchIsSynchronised=!this.watchIsSynchronised;this.refreshSyncStatus()}});this.app.vault.on("modify",(async file=>{if(file.path.startsWith(this.testInfoPath))await this.refreshSyncStatus();else scheduleTask("dumpStatus",125,(async()=>{await this.dumpList();return true}))}));this.statusBarSyncStatus=this.plugin.addStatusBarItem();return Promise.resolve(true)}async getSyncStatusAsText(){const fileMine=this.testInfoPath+this.nameByKind+"/files.md",filePair=this.testInfoPath+this.pairName+"/files.md",mine=(0,import_obsidian12.parseYaml)(await this.readFileContent(fileMine)),pair=(0,import_obsidian12.parseYaml)(await this.readFileContent(filePair)),result=[];if(mine.length!=pair.length)result.push(`File count is different: ${mine.length} vs ${pair.length}`);const filesAll=new Set([...mine.map((e4=>e4.path)),...pair.map((e4=>e4.path))]);for(const file of filesAll){const mineFile=mine.find((e4=>e4.path==file)),pairFile=pair.find((e4=>e4.path==file));if(!mineFile||!pairFile)result.push(`File not found: ${file}`);else{if(mineFile.size!=pairFile.size)result.push(`Size is different: ${file} ${mineFile.size} vs ${pairFile.size}`);if(mineFile.hash!=pairFile.hash)result.push(`Hash is different: ${file} ${mineFile.hash} vs ${pairFile.hash}`)}}eventHub.emitEvent("debug-sync-status",result);return result.join("\n")}async refreshSyncStatus(){if(this.watchIsSynchronised){const syncStatus=await this.getSyncStatusAsText();if(syncStatus){this.statusBarSyncStatus.setText("Sync Status: Having Error");this._log(`Sync Status: Having Error\n${syncStatus}`,LOG_LEVEL_INFO)}else this.statusBarSyncStatus.setText("Sync Status: Synchronised")}else this.statusBarSyncStatus.setText("")}async _dumpFileList(outFile){const files=this.core.storageAccess.getFiles(),out=[];for(const file of files){if(!await this.core.$$isTargetFile(file.path))continue;if(file.path.startsWith(this.testInfoPath))continue;const stat=await this.core.storageAccess.stat(file.path);if(stat){const hashSrc=await this.core.storageAccess.readHiddenFileBinary(file.path),hash2=await import_crypto2.webcrypto.subtle.digest("SHA-1",hashSrc),hashStr=uint8ArrayToHexString(new Uint8Array(hash2)),item={path:file.path,name:file.name,size:stat.size,mtime:stat.mtime,hash:hashStr};out.push(item)}}out.sort(((a2,b3)=>a2.path.localeCompare(b3.path)));if(outFile){outFile=this.testInfoPath+this.nameByKind+"/"+outFile;await this.core.storageAccess.ensureDir(outFile);await this.core.storageAccess.writeHiddenFileAuto(outFile,(0,import_obsidian12.stringifyYaml)(out))}this._log(`Dumped ${out.length} files`,LOG_LEVEL_INFO)}async _dumpFileListIncludeHidden(outFile){const ignorePatterns=this.settings.syncInternalFilesIgnorePatterns.replace(/\n| /g,"").split(",").filter((e4=>e4)).map((e4=>new RegExp(e4,"i"))),out=[],files=await this.core.storageAccess.getFilesIncludeHidden("",void 0,ignorePatterns);console.dir(files);for(const file of files){if(file.startsWith(this.testInfoPath))continue;const stat=await this.core.storageAccess.statHidden(file);if(stat){const hashSrc=await this.core.storageAccess.readHiddenFileBinary(file),hash2=await import_crypto2.webcrypto.subtle.digest("SHA-1",hashSrc),hashStr=uint8ArrayToHexString(new Uint8Array(hash2)),item={path:file,name:file.split("/").pop(),size:stat.size,mtime:stat.mtime,hash:hashStr};out.push(item)}}out.sort(((a2,b3)=>a2.path.localeCompare(b3.path)));if(outFile){outFile=this.testInfoPath+this.nameByKind+"/"+outFile;await this.core.storageAccess.ensureDir(outFile);await this.core.storageAccess.writeHiddenFileAuto(outFile,(0,import_obsidian12.stringifyYaml)(out))}this._log(`Dumped ${out.length} files`,LOG_LEVEL_NOTICE)}async collectTestFiles(){const files=["README.md","docs/adding_translations.md","docs/design_docs_of_journalsync.md","docs/design_docs_of_keep_newborn_chunks.md","docs/design_docs_of_prefixed_hidden_file_sync.md","docs/design_docs_of_sharing_tweak_value.md","docs/quick_setup_cn.md","docs/quick_setup_ja.md","docs/quick_setup.md","docs/settings_ja.md","docs/settings.md","docs/setup_cloudant_ja.md","docs/setup_cloudant.md","docs/setup_flyio.md","docs/setup_own_server_cn.md","docs/setup_own_server_ja.md","docs/setup_own_server.md","docs/tech_info_ja.md","docs/tech_info.md","docs/terms.md","docs/troubleshooting.md","images/1.png","images/2.png","images/corrupted_data.png","images/hatch.png","images/lock_pattern1.png","images/lock_pattern2.png","images/quick_setup_1.png","images/quick_setup_2.png","images/quick_setup_3.png","images/quick_setup_3b.png","images/quick_setup_4.png","images/quick_setup_5.png","images/quick_setup_6.png","images/quick_setup_7.png","images/quick_setup_8.png","images/quick_setup_9_1.png","images/quick_setup_9_2.png","images/quick_setup_10.png","images/remote_db_setting.png","images/write_logs_into_the_file.png"];for(const file of files){const remote="https://raw.githubusercontent.com/vrtmrz/obsidian-livesync/refs/heads/main/"+file,local=this.testRootPath+file;try{const f4=(await(0,import_obsidian12.requestUrl)(remote)).arrayBuffer;await this.core.storageAccess.ensureDir(local);await this.core.storageAccess.writeHiddenFileAuto(local,f4)}catch(ex){this._log(`Could not fetch ${remote}`,LOG_LEVEL_VERBOSE);this._log(ex,LOG_LEVEL_VERBOSE)}}await this.dumpList()}async waitFor(proc,timeout=1e4){await delay(100);const start=Date.now();for(;!await proc();){if(timeout>0)if(Date.now()-start>timeout){this._log("Timeout");return false}await delay(500)}return true}async testConflictedManually1(){await this.core.$$replicate();if(this.isLeader)await this.core.storageAccess.writeHiddenFileAuto(this.testRootPath+"wonka.md","Resolve! \n*****, the amazing chocolatier!!");await this.core.$$replicate();await this.core.$$replicate();if("no"==await this.core.confirm.askYesNoDialog("Ready to begin the test conflict Manually 1?",{timeout:30,defaultOption:"Yes"}))return;const fileA="Resolve to KEEP THIS\nWilly Wonka, Willy Wonka, the amazing chocolatier!!";if(this.isLeader)await this.core.storageAccess.writeHiddenFileAuto(this.testRootPath+"wonka.md",fileA);else await this.core.storageAccess.writeHiddenFileAuto(this.testRootPath+"wonka.md","Resolve to DISCARD THIS\nCharlie Bucket, Charlie Bucket, the amazing chocolatier!!");if("no"!=await this.core.confirm.askYesNoDialog("Ready to check the result of Manually 1?",{timeout:30,defaultOption:"Yes"})){await this.core.$$replicate();await this.core.$$replicate();if(!await this.waitFor((async()=>{await this.core.$$replicate();return true==await this.__assertStorageContent(this.testRootPath+"wonka.md",fileA,false,true)}),3e4))return await this.__assertStorageContent(this.testRootPath+"wonka.md",fileA,false,true);else return true}}async testConflictedManually2(){await this.core.$$replicate();if(this.isLeader)await this.core.storageAccess.writeHiddenFileAuto(this.testRootPath+"concat.md","Resolve To concatenate\nABCDEFG");await this.core.$$replicate();await this.core.$$replicate();if("no"==await this.core.confirm.askYesNoDialog("Ready to begin the test conflict Manually 2?",{timeout:30,defaultOption:"Yes"}))return;const concatenated="Resolve to Concatenate\nABCDEFGHIJKLMNOPQRSTUVWXYZ";if(this.isLeader)await this.core.storageAccess.writeHiddenFileAuto(this.testRootPath+"concat.md","Resolve to Concatenate\nABCDEFGHIJKLMNOPQRSTYZ");else await this.core.storageAccess.writeHiddenFileAuto(this.testRootPath+"concat.md","Resolve to Concatenate\nAJKLMNOPQRSTUVWXYZ");if("no"!=await this.core.confirm.askYesNoDialog("Ready to test conflict Manually 2?",{timeout:30,defaultOption:"Yes"})){await this.core.$$replicate();await this.core.$$replicate();if(!await this.waitFor((async()=>{await this.core.$$replicate();return true==await this.__assertStorageContent(this.testRootPath+"concat.md",concatenated,false,true)}),3e4))return await this.__assertStorageContent(this.testRootPath+"concat.md",concatenated,false,true);else return true}}async testConflictAutomatic(){if(this.isLeader){const baseDoc="Tasks!\n- [ ] Task 1\n- [ ] Task 2\n- [ ] Task 3\n- [ ] Task 4\n";await this.core.storageAccess.writeHiddenFileAuto(this.testRootPath+"task.md",baseDoc)}await delay(100);await this.core.$$replicate();await this.core.$$replicate();if("no"!=await this.core.confirm.askYesNoDialog("Ready to test conflict?",{timeout:30,defaultOption:"Yes"})){if(this.isLeader)await this.core.storageAccess.writeHiddenFileAuto(this.testRootPath+"task.md","Tasks!\n- [ ] Task 1\n- [v] Task 2\n- [ ] Task 3\n- [ ] Task 4\n");else await this.core.storageAccess.writeHiddenFileAuto(this.testRootPath+"task.md","Tasks!\n- [ ] Task 1\n- [ ] Task 2\n- [v] Task 3\n- [ ] Task 4\n");await this.core.$$replicate();await this.core.$$replicate();await delay(1e3);if("no"!=await this.core.confirm.askYesNoDialog("Ready to check result?",{timeout:30,defaultOption:"Yes"})){await this.core.$$replicate();await this.core.$$replicate();return this.__assertStorageContent(this.testRootPath+"task.md","Tasks!\n- [ ] Task 1\n- [v] Task 2\n- [v] Task 3\n- [ ] Task 4\n",false,true)}}}async checkConflictResolution(){this._log("Before testing conflicted files, resolve all once",LOG_LEVEL_NOTICE);await this.core.rebuilder.resolveAllConflictedFilesByNewerOnes();await this.core.rebuilder.resolveAllConflictedFilesByNewerOnes();await this.core.$$replicate();await delay(1e3);if(!await this.testConflictAutomatic()){this._log("Conflict resolution (Auto) failed",LOG_LEVEL_NOTICE);return false}if(!await this.testConflictedManually1()){this._log("Conflict resolution (Manual1) failed",LOG_LEVEL_NOTICE);return false}if(!await this.testConflictedManually2()){this._log("Conflict resolution (Manual2) failed",LOG_LEVEL_NOTICE);return false}return true}async __assertStorageContent(fileName,content,inverted=false,showResult=false){try{const fileContent=await this.core.storageAccess.readHiddenFileText(fileName);let result=fileContent===content;if(inverted)result=!result;if(result)return true;else{if(showResult)this._log(`Content is not same \n Expected:${content}\n Actual:${fileContent}`,LOG_LEVEL_VERBOSE);return`Content is not same \n Expected:${content}\n Actual:${fileContent}`}}catch(e4){this._log(`Cannot assert storage content: ${e4}`);return false}}async performTestManually(){if(!this.settings.enableDebugTools)return Promise.resolve(true);await this.checkConflictResolution()}async $everyModuleTestMultiDevice(){if(!this.settings.enableDebugTools)return Promise.resolve(true);await this._test("Conflict resolution",(async()=>await this.checkConflictResolution()));return this.testDone()}},ModuleLiveSyncMain=class extends AbstractModule{constructor(){super(...arguments);this.isReady=false;this._suspended=false;this._unloaded=false}async $$onLiveSyncReady(){if(await this.core.$everyOnLayoutReady()){eventHub.emitEvent(EVENT_LAYOUT_READY);if(this.settings.suspendFileWatching||this.settings.suspendParseReplicationResult){const ANSWER_KEEP="Keep LiveSync disabled",ANSWER_RESUME="Resume and restart Obsidian",message=`Self-hosted LiveSync has been configured to ignore some events. Is this correct?\n\n| Type | Status | Note |\n|:---:|:---:|---|\n| Storage Events | ${this.settings.suspendFileWatching?"suspended":"active"} | Every modification will be ignored |\n| Database Events | ${this.settings.suspendParseReplicationResult?"suspended":"active"} | Every synchronised change will be postponed |\n\nDo you want to resume them and restart Obsidian?\n\n> [!DETAILS]-\n> These flags are set by the plug-in while rebuilding, or fetching. If the process ends abnormally, it may be kept unintended.\n> If you are not sure, you can try to rerun these processes. Make sure to back your vault up.\n`;if(await this.core.confirm.askSelectStringDialogue(message,[ANSWER_KEEP,ANSWER_RESUME],{defaultAction:ANSWER_KEEP,title:"Scram Enabled"})==ANSWER_RESUME){this.settings.suspendFileWatching=false;this.settings.suspendParseReplicationResult=false;await this.saveSettings();await this.core.$$scheduleAppReload();return}}if(!await this.core.$$initializeDatabase(false,false))return false;if(await this.core.$everyOnFirstInitialize()){await this.core.$$realizeSettingSyncMode();fireAndForget((async()=>{this._log("Additional safety scan..",LOG_LEVEL_VERBOSE);if(!await this.core.$allScanStat())this._log("Additional safety scan has failed on a module",LOG_LEVEL_NOTICE);else this._log("Additional safety scan completed",LOG_LEVEL_VERBOSE)}))}}}$$wireUpEvents(){eventHub.onEvent(EVENT_SETTING_SAVED,(settings=>{this.localDatabase.settings=settings;setLang(settings.displayLanguage);eventHub.emitEvent(EVENT_REQUEST_RELOAD_SETTING_TAB)}));eventHub.onEvent(EVENT_SETTING_SAVED,(settings=>{fireAndForget((()=>this.core.$$realizeSettingSyncMode()))}))}async $$onLiveSyncLoad(){this.$$wireUpEvents();eventHub.emitEvent(EVENT_PLUGIN_LOADED,this.core);this._log("loading plugin");if(!await this.core.$everyOnloadStart()){this._log("Plugin initialisation was cancelled by a module",LOG_LEVEL_NOTICE);return}this._log($f`Self-hosted LiveSync${" v"}${"0.24.3"} ${"0.24.3"}`);await this.core.$$loadSettings();if(!await this.core.$everyOnloadAfterLoadSettings()){this._log("Plugin initialisation was cancelled by a module",LOG_LEVEL_NOTICE);return}const lsKey="obsidian-live-sync-ver"+this.core.$$getVaultName(),last_version=localStorage.getItem(lsKey);if(~~(versionNumberString2Number("0.24.3")/1e3)>this.settings.lastReadUpdates&&this.settings.isConfigured)this._log($f`LiveSync has updated, please read the changelog!`,LOG_LEVEL_NOTICE);if(this.isMobile)this.settings.disableRequestURI=true;if(last_version&&Number(last_version)<VER){this.settings.liveSync=false;this.settings.syncOnSave=false;this.settings.syncOnEditorSave=false;this.settings.syncOnStart=false;this.settings.syncOnFileOpen=false;this.settings.syncAfterMerge=false;this.settings.periodicReplication=false;this.settings.versionUpFlash=$f`LiveSync has been updated, In case of breaking updates, all automatic synchronization has been temporarily disabled. Ensure that all devices are up to date before enabling.`;await this.saveSettings()}localStorage.setItem(lsKey,`${VER}`);await this.core.$$openDatabase();this.core.$$realizeSettingSyncMode=this.core.$$realizeSettingSyncMode.bind(this);this.core.$$onLiveSyncReady=this.core.$$onLiveSyncReady.bind(this);await this.core.$everyOnload();await Promise.all(this.core.addOns.map((e4=>e4.onload())))}async $$onLiveSyncUnload(){var _a5;eventHub.emitEvent(EVENT_PLUGIN_UNLOADED);await this.core.$allStartOnUnload();cancelAllPeriodicTask();cancelAllTasks();stopAllRunningProcessors();await this.core.$allOnUnload();this._unloaded=true;for(const addOn of this.core.addOns)addOn.onunload();if(null!=this.localDatabase){this.localDatabase.onunload();if(this.core.replicator)null==(_a5=this.core.replicator)||_a5.closeReplication();await this.localDatabase.close()}this._log($f`unloading plugin`)}async $$realizeSettingSyncMode(){await this.core.$everyBeforeSuspendProcess();await this.core.$everyBeforeRealizeSetting();this.localDatabase.refreshSettings();await this.core.$everyCommitPendingFileEvent();await this.core.$everyRealizeSettingSyncMode();if(!this.core.$$isSuspended()){await this.core.$everyOnResumeProcess();await this.core.$everyAfterResumeProcess();await this.core.$everyAfterRealizeSetting()}}$$isReloadingScheduled(){return void 0!==this.core._totalProcessingCount}$$isReady(){return this.isReady}$$markIsReady(){this.isReady=true}$$resetIsReady(){this.isReady=false}$$isSuspended(){var _a5;return this._suspended||!(null==(_a5=this.settings)?void 0:_a5.isConfigured)}$$setSuspended(value){this._suspended=value}$$isUnloaded(){return this._unloaded}},ModuleExtraSyncObsidian=class extends AbstractObsidianModule{constructor(){super(...arguments);this.deviceAndVaultName=""}$$getDeviceAndVaultName(){return this.deviceAndVaultName}$$setDeviceAndVaultName(name){this.deviceAndVaultName=name}};function throwShouldBeOverridden(){throw new Error("This function should be overridden by the module.")}var InterceptiveAll=Promise.resolve(true),InterceptiveEvery=Promise.resolve(true),InterceptiveAny=Promise.resolve(void 0),ObsidianLiveSyncPlugin=class extends import_obsidian.Plugin{constructor(){super(...arguments);this.addOns=[new ConfigSync(this),new HiddenFileSync(this)];this.modules=[new ModuleLiveSyncMain(this),new ModuleExtraSyncObsidian(this,this),new ModuleDatabaseFileAccess(this),new ModulePouchDB(this),new ModuleConflictChecker(this),new ModuleLocalDatabaseObsidian(this),new ModuleReplicatorMinIO(this),new ModuleReplicatorCouchDB(this),new ModuleReplicator(this),new ModuleFileHandler(this),new ModuleConflictResolver(this),new ModuleRemoteGovernor(this),new ModuleTargetFilter(this),new ModulePeriodicProcess(this),new ModuleKeyValueDB(this),new ModuleInitializerFile(this),new ModuleObsidianAPI(this,this),new ModuleObsidianEvents(this,this),new ModuleFileAccessObsidian(this,this),new ModuleObsidianSettings(this,this),new ModuleResolvingMismatchedTweaks(this),new ModuleObsidianSettingsAsMarkdown(this,this),new ModuleObsidianSettingDialogue(this,this),new ModuleLog(this,this),new ModuleInputUIObsidian(this,this),new ModuleObsidianMenu(this,this),new ModuleRebuilder(this),new ModuleSetupObsidian(this,this),new ModuleObsidianDocumentHistory(this,this),new ModuleMigration(this),new ModuleRedFlag(this),new ModuleInteractiveConflictResolver(this,this),new ModuleObsidianGlobalHistory(this,this),new ModuleCheckRemoteSize(this),new ModuleDev(this,this),new ModuleReplicateTest(this,this),new ModuleIntegratedTest(this,this)];this.injected=injectModules(this,[...this.modules,...this.addOns]);this.requestCount=reactiveSource(0);this.responseCount=reactiveSource(0);this.totalQueued=reactiveSource(0);this.batched=reactiveSource(0);this.processing=reactiveSource(0);this.databaseQueueCount=reactiveSource(0);this.storageApplyingCount=reactiveSource(0);this.replicationResultCount=reactiveSource(0);this.conflictProcessQueueCount=reactiveSource(0);this.pendingFileEventCount=reactiveSource(0);this.processingFileEventCount=reactiveSource(0);this.replicationStat=reactiveSource({sent:0,arrived:0,maxPullSeq:0,maxPushSeq:0,lastSyncPullSeq:0,lastSyncPushSeq:0,syncStatus:"CLOSED"})}getAddOn(cls){for(const addon of this.addOns)if(addon.constructor.name==cls)return addon}$$isSuspended(){throwShouldBeOverridden()}$$setSuspended(value){throwShouldBeOverridden()}$$isDatabaseReady(){throwShouldBeOverridden()}$$getDeviceAndVaultName(){throwShouldBeOverridden()}$$setDeviceAndVaultName(name){throwShouldBeOverridden()}$$addLog(message,level=LOG_LEVEL_INFO,key2=""){throwShouldBeOverridden()}$$isReady(){throwShouldBeOverridden()}$$markIsReady(){throwShouldBeOverridden()}$$resetIsReady(){throwShouldBeOverridden()}getDatabase(){return this.localDatabase.localDatabase}getSettings(){return this.settings}$$markFileListPossiblyChanged(){throwShouldBeOverridden()}$$customFetchHandler(){throwShouldBeOverridden()}$$getLastPostFailedBySize(){throwShouldBeOverridden()}$$isStorageInsensitive(){throwShouldBeOverridden()}$$shouldCheckCaseInsensitive(){throwShouldBeOverridden()}$$isUnloaded(){throwShouldBeOverridden()}$$isReloadingScheduled(){throwShouldBeOverridden()}$$getReplicator(){throwShouldBeOverridden()}$$connectRemoteCouchDB(uri,auth,disableRequestURI,passphrase,useDynamicIterationCount,performSetup,skipInfo,compression){throwShouldBeOverridden()}$$isMobile(){throwShouldBeOverridden()}$$vaultName(){throwShouldBeOverridden()}$$getActiveFilePath(){throwShouldBeOverridden()}$$id2path(id,entry,stripPrefix2){throwShouldBeOverridden()}$$path2id(filename,prefix){throwShouldBeOverridden()}$$createPouchDBInstance(name,options){throwShouldBeOverridden()}$allOnDBUnload(db){}$allOnDBClose(db){}$anyNewReplicator(settingOverride={}){throwShouldBeOverridden()}$everyOnInitializeDatabase(db){return InterceptiveEvery}$everyOnResetDatabase(db){return InterceptiveEvery}$$getVaultName(){throwShouldBeOverridden()}$$getSimpleStore(kind){throwShouldBeOverridden()}$everyOnLayoutReady(){return InterceptiveEvery}$everyOnFirstInitialize(){return InterceptiveEvery}$$onLiveSyncReady(){throwShouldBeOverridden()}$$wireUpEvents(){throwShouldBeOverridden()}$$onLiveSyncLoad(){throwShouldBeOverridden()}$$onLiveSyncUnload(){throwShouldBeOverridden()}$allScanStat(){return InterceptiveAll}$everyOnloadStart(){return InterceptiveEvery}$everyOnloadAfterLoadSettings(){return InterceptiveEvery}$everyOnload(){return InterceptiveEvery}$anyHandlerProcessesFileEvent(item){return InterceptiveAny}$allStartOnUnload(){return InterceptiveAll}$allOnUnload(){return InterceptiveAll}$$openDatabase(){throwShouldBeOverridden()}$$realizeSettingSyncMode(){throwShouldBeOverridden()}$$performRestart(){throwShouldBeOverridden()}$$clearUsedPassphrase(){throwShouldBeOverridden()}$$loadSettings(){throwShouldBeOverridden()}$$saveDeviceAndVaultName(){throwShouldBeOverridden()}$$saveSettingData(){throwShouldBeOverridden()}$anyProcessOptionalFileEvent(path2){return InterceptiveAny}$everyCommitPendingFileEvent(){return InterceptiveEvery}$anyGetOptionalConflictCheckMethod(path2){return InterceptiveAny}$$queueConflictCheckIfOpen(file){throwShouldBeOverridden()}$$queueConflictCheck(file){throwShouldBeOverridden()}$$waitForAllConflictProcessed(){throwShouldBeOverridden()}$anyProcessOptionalSyncFiles(doc){return InterceptiveAny}$anyProcessReplicatedDoc(doc){return InterceptiveAny}$$parseReplicationResult(docs){throwShouldBeOverridden()}$anyModuleParsedReplicationResultItem(docs){return InterceptiveAny}$everyBeforeRealizeSetting(){return InterceptiveEvery}$everyAfterRealizeSetting(){return InterceptiveEvery}$everyRealizeSettingSyncMode(){return InterceptiveEvery}$everyBeforeSuspendProcess(){return InterceptiveEvery}$everyOnResumeProcess(){return InterceptiveEvery}$everyAfterResumeProcess(){return InterceptiveEvery}$$askResolvingMismatchedTweaks(){throwShouldBeOverridden()}$$checkAndAskUseRemoteConfiguration(settings){throwShouldBeOverridden()}$everyBeforeReplicate(showMessage){return InterceptiveEvery}$$replicate(showMessage=false){throwShouldBeOverridden()}$everyOnDatabaseInitialized(showingNotice){throwShouldBeOverridden()}$$initializeDatabase(showingNotice=false,reopenDatabase=true){throwShouldBeOverridden()}$anyAfterConnectCheckFailed(){return InterceptiveAny}$$replicateAllToServer(showingNotice=false,sendChunksInBulkDisabled=false){throwShouldBeOverridden()}$$replicateAllFromServer(showingNotice=false){throwShouldBeOverridden()}$$markRemoteLocked(lockByClean=false){throwShouldBeOverridden()}$$markRemoteUnlocked(){throwShouldBeOverridden()}$$markRemoteResolved(){throwShouldBeOverridden()}$$isFileSizeExceeded(size){throwShouldBeOverridden()}$$performFullScan(showingNotice){throwShouldBeOverridden()}$anyResolveConflictByUI(filename,conflictCheckResult){return InterceptiveAny}$$resolveConflictByDeletingRev(path2,deleteRevision,subTitle=""){throwShouldBeOverridden()}$$resolveConflict(filename){throwShouldBeOverridden()}$anyResolveConflictByNewest(filename){throwShouldBeOverridden()}$$waitForReplicationOnce(){throwShouldBeOverridden()}$$resetLocalDatabase(){throwShouldBeOverridden()}$$tryResetRemoteDatabase(){throwShouldBeOverridden()}$$tryCreateRemoteDatabase(){throwShouldBeOverridden()}$$isIgnoredByIgnoreFiles(file){throwShouldBeOverridden()}$$isTargetFile(file,keepFileCheckList=false){throwShouldBeOverridden()}$$askReload(message){throwShouldBeOverridden()}$$scheduleAppReload(){throwShouldBeOverridden()}$allSuspendAllSync(){return InterceptiveAll}$allSuspendExtraSync(){return InterceptiveAll}$allAskUsingOptionalSyncFeature(opt){throwShouldBeOverridden()}$anyConfigureOptionalSyncFeature(mode){throwShouldBeOverridden()}$$showView(viewType){throwShouldBeOverridden()}$everyModuleTest(){return InterceptiveEvery}$everyModuleTestMultiDevice(){return InterceptiveEvery}$$addTestResult(name,key2,result,summary,message){throwShouldBeOverridden()}_isThisModuleEnabled(){return true}$anyGetAppId(){return InterceptiveAny}onload(){this.$$onLiveSyncLoad()}async saveSettings(){await this.$$saveSettingData()}onunload(){this.$$onLiveSyncUnload()}};
/* nosourcemap */