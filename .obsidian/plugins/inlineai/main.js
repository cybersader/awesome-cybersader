/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var Ly=Object.create;var ys=Object.defineProperty;var Dy=Object.getOwnPropertyDescriptor;var My=Object.getOwnPropertyNames;var Fy=Object.getPrototypeOf,Uy=Object.prototype.hasOwnProperty;var zy=(n,e,t)=>e in n?ys(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var N=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),vd=(n,e)=>{for(var t in e)ys(n,t,{get:e[t],enumerable:!0})},Ad=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of My(e))!Uy.call(n,a)&&a!==t&&ys(n,a,{get:()=>e[a],enumerable:!(r=Dy(e,a))||r.enumerable});return n};var pt=(n,e,t)=>(t=n!=null?Ly(Fy(n)):{},Ad(e||!n||!n.__esModule?ys(t,"default",{value:n,enumerable:!0}):t,n)),By=n=>Ad(ys({},"__esModule",{value:!0}),n);var ne=(n,e,t)=>zy(n,typeof e!="symbol"?e+"":e,t);var _h=N((AS,bh)=>{"use strict";bh.exports=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e=="undefined"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}});var Ih=N((ES,mc)=>{"use strict";var Xb=/[\p{Lu}]/u,Yb=/[\p{Ll}]/u,wh=/^[\p{Lu}](?![\p{Lu}])/gu,Eh=/([\p{Alpha}\p{N}_]|$)/u,Oh=/[_.\- ]+/,Qb=new RegExp("^"+Oh.source),vh=new RegExp(Oh.source+Eh.source,"gu"),Ah=new RegExp("\\d+"+Eh.source,"gu"),e_=(n,e,t)=>{let r=!1,a=!1,s=!1;for(let i=0;i<n.length;i++){let o=n[i];r&&Xb.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,s=a,a=!0,i++):a&&s&&Yb.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),s=a,a=!1,r=!0):(r=e(o)===o&&t(o)!==o,s=a,a=t(o)===o&&e(o)!==o)}return n},t_=(n,e)=>(wh.lastIndex=0,n.replace(wh,t=>e(t))),r_=(n,e)=>(vh.lastIndex=0,Ah.lastIndex=0,n.replace(vh,(t,r)=>e(r)).replace(Ah,t=>e(t))),xh=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(s=>s.trim()).filter(s=>s.length).join("-"):n=n.trim(),n.length===0)return"";let t=e.locale===!1?s=>s.toLowerCase():s=>s.toLocaleLowerCase(e.locale),r=e.locale===!1?s=>s.toUpperCase():s=>s.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=e_(n,t,r)),n=n.replace(Qb,""),e.preserveConsecutiveUppercase?n=t_(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),r_(n,r))};mc.exports=xh;mc.exports.default=xh});var Wh=N((rk,Jh)=>{function wt(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}Jh.exports=wt;wt.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};wt.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};wt.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};wt.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};wt.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};wt.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};wt.prototype.start=wt.prototype.try;wt.prototype.errors=function(){return this._errors};wt.prototype.attempts=function(){return this._attempts};wt.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(n[s]||0)+1;n[s]=i,i>=t&&(e=a,t=i)}return e}});var Xh=N(Un=>{var yw=Wh();Un.operation=function(n){var e=Un.timeouts(n);return new yw(e,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})};Un.timeouts=function(n){if(n instanceof Array)return[].concat(n);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in n)e[t]=n[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],a=0;a<e.retries;a++)r.push(this.createTimeout(a,e));return n&&n.forever&&!r.length&&r.push(this.createTimeout(a,e)),r.sort(function(s,i){return s-i}),r};Un.createTimeout=function(n,e){var t=e.randomize?Math.random()+1:1,r=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,n));return r=Math.min(r,e.maxTimeout),r};Un.wrap=function(n,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var r in n)typeof n[r]=="function"&&t.push(r)}for(var a=0;a<t.length;a++){var s=t[a],i=n[s];n[s]=function(u){var c=Un.operation(e),l=Array.prototype.slice.call(arguments,1),d=l.pop();l.push(function(h){c.retry(h)||(h&&(arguments[0]=c.mainError()),d.apply(this,arguments))}),c.attempt(function(){u.apply(n,l)})}.bind(n,i),n[s].options=e}}});var Qh=N((ak,Yh)=>{Yh.exports=Xh()});var ao=N((sk,no)=>{"use strict";var bw=Qh(),_w=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],ro=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},ww=(n,e,t)=>{let r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},vw=n=>_w.includes(n),ef=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};let a=bw.operation(e);a.attempt(async s=>{try{t(await n(s))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof ro)a.stop(),r(i.originalError);else if(i instanceof TypeError&&!vw(i.message))a.stop(),r(i);else{ww(i,s,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}a.retry(i)||r(a.mainError())}}})});no.exports=ef;no.exports.default=ef;no.exports.AbortError=ro});var af=N((bk,Pc)=>{"use strict";var Iw=Object.prototype.hasOwnProperty,Ve="~";function Hs(){}Object.create&&(Hs.prototype=Object.create(null),new Hs().__proto__||(Ve=!1));function Pw(n,e,t){this.fn=n,this.context=e,this.once=t||!1}function nf(n,e,t,r,a){if(typeof t!="function")throw new TypeError("The listener must be a function");var s=new Pw(t,r||n,a),i=Ve?Ve+e:e;return n._events[i]?n._events[i].fn?n._events[i]=[n._events[i],s]:n._events[i].push(s):(n._events[i]=s,n._eventsCount++),n}function uo(n,e){--n._eventsCount===0?n._events=new Hs:delete n._events[e]}function Me(){this._events=new Hs,this._eventsCount=0}Me.prototype.eventNames=function(){var e=[],t,r;if(this._eventsCount===0)return e;for(r in t=this._events)Iw.call(t,r)&&e.push(Ve?r.slice(1):r);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};Me.prototype.listeners=function(e){var t=Ve?Ve+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var a=0,s=r.length,i=new Array(s);a<s;a++)i[a]=r[a].fn;return i};Me.prototype.listenerCount=function(e){var t=Ve?Ve+e:e,r=this._events[t];return r?r.fn?1:r.length:0};Me.prototype.emit=function(e,t,r,a,s,i){var o=Ve?Ve+e:e;if(!this._events[o])return!1;var u=this._events[o],c=arguments.length,l,d;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),c){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,a),!0;case 5:return u.fn.call(u.context,t,r,a,s),!0;case 6:return u.fn.call(u.context,t,r,a,s,i),!0}for(d=1,l=new Array(c-1);d<c;d++)l[d-1]=arguments[d];u.fn.apply(u.context,l)}else{var h=u.length,f;for(d=0;d<h;d++)switch(u[d].once&&this.removeListener(e,u[d].fn,void 0,!0),c){case 1:u[d].fn.call(u[d].context);break;case 2:u[d].fn.call(u[d].context,t);break;case 3:u[d].fn.call(u[d].context,t,r);break;case 4:u[d].fn.call(u[d].context,t,r,a);break;default:if(!l)for(f=1,l=new Array(c-1);f<c;f++)l[f-1]=arguments[f];u[d].fn.apply(u[d].context,l)}}return!0};Me.prototype.on=function(e,t,r){return nf(this,e,t,r,!1)};Me.prototype.once=function(e,t,r){return nf(this,e,t,r,!0)};Me.prototype.removeListener=function(e,t,r,a){var s=Ve?Ve+e:e;if(!this._events[s])return this;if(!t)return uo(this,s),this;var i=this._events[s];if(i.fn)i.fn===t&&(!a||i.once)&&(!r||i.context===r)&&uo(this,s);else{for(var o=0,u=[],c=i.length;o<c;o++)(i[o].fn!==t||a&&!i[o].once||r&&i[o].context!==r)&&u.push(i[o]);u.length?this._events[s]=u.length===1?u[0]:u:uo(this,s)}return this};Me.prototype.removeAllListeners=function(e){var t;return e?(t=Ve?Ve+e:e,this._events[t]&&uo(this,t)):(this._events=new Hs,this._eventsCount=0),this};Me.prototype.off=Me.prototype.removeListener;Me.prototype.addListener=Me.prototype.on;Me.prefixed=Ve;Me.EventEmitter=Me;typeof Pc!="undefined"&&(Pc.exports=Me)});var of=N((_k,sf)=>{"use strict";sf.exports=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})))});var cf=N((wk,lo)=>{"use strict";var Tw=of(),co=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},uf=(n,e,t)=>new Promise((r,a)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}let s=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){a(u)}return}let i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new co(i);typeof n.cancel=="function"&&n.cancel(),a(o)},e);Tw(n.then(r,a),()=>{clearTimeout(s)})});lo.exports=uf;lo.exports.default=uf;lo.exports.TimeoutError=co});var lf=N(Tc=>{"use strict";Object.defineProperty(Tc,"__esModule",{value:!0});function Sw(n,e,t){let r=0,a=n.length;for(;a>0;){let s=a/2|0,i=r+s;t(n[i],e)<=0?(r=++i,a-=s+1):a=s}return r}Tc.default=Sw});var df=N(kc=>{"use strict";Object.defineProperty(kc,"__esModule",{value:!0});var kw=lf(),Sc=class{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);let r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}let a=kw.default(this._queue,r,(s,i)=>i.priority-s.priority);this._queue.splice(a,0,r)}dequeue(){let e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}};kc.default=Sc});var fo=N(Rc=>{"use strict";Object.defineProperty(Rc,"__esModule",{value:!0});var Cw=af(),hf=cf(),Rw=df(),ho=()=>{},Nw=new hf.TimeoutError,Cc=class extends Cw{constructor(e){var t,r,a,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=ho,this._resolveIdle=ho,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:Rw.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(a=e.interval)===null||a===void 0?void 0:a.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=ho,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=ho,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(this._intervalId===void 0){let t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{let s=async()=>{this._pendingCount++,this._intervalCount++;try{let i=this._timeout===void 0&&t.timeout===void 0?e():hf.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&a(Nw)});r(await i)}catch(i){a(i)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};Rc.default=Cc});var Gs=N((kk,mf)=>{var Mw="2.0.0",Fw=Number.MAX_SAFE_INTEGER||9007199254740991,Uw=16,zw=250,Bw=["major","premajor","minor","preminor","patch","prepatch","prerelease"];mf.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:Uw,MAX_SAFE_BUILD_LENGTH:zw,MAX_SAFE_INTEGER:Fw,RELEASE_TYPES:Bw,SEMVER_SPEC_VERSION:Mw,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}});var Ks=N((Ck,gf)=>{var qw=typeof process=="object"&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...n)=>console.error("SEMVER",...n):()=>{};gf.exports=qw});var Ka=N((wr,yf)=>{var{MAX_SAFE_COMPONENT_LENGTH:jc,MAX_SAFE_BUILD_LENGTH:Vw,MAX_LENGTH:Hw}=Gs(),Zw=Ks();wr=yf.exports={};var Gw=wr.re=[],Kw=wr.safeRe=[],C=wr.src=[],R=wr.t={},Jw=0,Lc="[a-zA-Z0-9-]",Ww=[["\\s",1],["\\d",Hw],[Lc,Vw]],Xw=n=>{for(let[e,t]of Ww)n=n.split(`${e}*`).join(`${e}{0,${t}}`).split(`${e}+`).join(`${e}{1,${t}}`);return n},H=(n,e,t)=>{let r=Xw(e),a=Jw++;Zw(n,a,e),R[n]=a,C[a]=e,Gw[a]=new RegExp(e,t?"g":void 0),Kw[a]=new RegExp(r,t?"g":void 0)};H("NUMERICIDENTIFIER","0|[1-9]\\d*");H("NUMERICIDENTIFIERLOOSE","\\d+");H("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${Lc}*`);H("MAINVERSION",`(${C[R.NUMERICIDENTIFIER]})\\.(${C[R.NUMERICIDENTIFIER]})\\.(${C[R.NUMERICIDENTIFIER]})`);H("MAINVERSIONLOOSE",`(${C[R.NUMERICIDENTIFIERLOOSE]})\\.(${C[R.NUMERICIDENTIFIERLOOSE]})\\.(${C[R.NUMERICIDENTIFIERLOOSE]})`);H("PRERELEASEIDENTIFIER",`(?:${C[R.NUMERICIDENTIFIER]}|${C[R.NONNUMERICIDENTIFIER]})`);H("PRERELEASEIDENTIFIERLOOSE",`(?:${C[R.NUMERICIDENTIFIERLOOSE]}|${C[R.NONNUMERICIDENTIFIER]})`);H("PRERELEASE",`(?:-(${C[R.PRERELEASEIDENTIFIER]}(?:\\.${C[R.PRERELEASEIDENTIFIER]})*))`);H("PRERELEASELOOSE",`(?:-?(${C[R.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${C[R.PRERELEASEIDENTIFIERLOOSE]})*))`);H("BUILDIDENTIFIER",`${Lc}+`);H("BUILD",`(?:\\+(${C[R.BUILDIDENTIFIER]}(?:\\.${C[R.BUILDIDENTIFIER]})*))`);H("FULLPLAIN",`v?${C[R.MAINVERSION]}${C[R.PRERELEASE]}?${C[R.BUILD]}?`);H("FULL",`^${C[R.FULLPLAIN]}$`);H("LOOSEPLAIN",`[v=\\s]*${C[R.MAINVERSIONLOOSE]}${C[R.PRERELEASELOOSE]}?${C[R.BUILD]}?`);H("LOOSE",`^${C[R.LOOSEPLAIN]}$`);H("GTLT","((?:<|>)?=?)");H("XRANGEIDENTIFIERLOOSE",`${C[R.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`);H("XRANGEIDENTIFIER",`${C[R.NUMERICIDENTIFIER]}|x|X|\\*`);H("XRANGEPLAIN",`[v=\\s]*(${C[R.XRANGEIDENTIFIER]})(?:\\.(${C[R.XRANGEIDENTIFIER]})(?:\\.(${C[R.XRANGEIDENTIFIER]})(?:${C[R.PRERELEASE]})?${C[R.BUILD]}?)?)?`);H("XRANGEPLAINLOOSE",`[v=\\s]*(${C[R.XRANGEIDENTIFIERLOOSE]})(?:\\.(${C[R.XRANGEIDENTIFIERLOOSE]})(?:\\.(${C[R.XRANGEIDENTIFIERLOOSE]})(?:${C[R.PRERELEASELOOSE]})?${C[R.BUILD]}?)?)?`);H("XRANGE",`^${C[R.GTLT]}\\s*${C[R.XRANGEPLAIN]}$`);H("XRANGELOOSE",`^${C[R.GTLT]}\\s*${C[R.XRANGEPLAINLOOSE]}$`);H("COERCEPLAIN",`(^|[^\\d])(\\d{1,${jc}})(?:\\.(\\d{1,${jc}}))?(?:\\.(\\d{1,${jc}}))?`);H("COERCE",`${C[R.COERCEPLAIN]}(?:$|[^\\d])`);H("COERCEFULL",C[R.COERCEPLAIN]+`(?:${C[R.PRERELEASE]})?(?:${C[R.BUILD]})?(?:$|[^\\d])`);H("COERCERTL",C[R.COERCE],!0);H("COERCERTLFULL",C[R.COERCEFULL],!0);H("LONETILDE","(?:~>?)");H("TILDETRIM",`(\\s*)${C[R.LONETILDE]}\\s+`,!0);wr.tildeTrimReplace="$1~";H("TILDE",`^${C[R.LONETILDE]}${C[R.XRANGEPLAIN]}$`);H("TILDELOOSE",`^${C[R.LONETILDE]}${C[R.XRANGEPLAINLOOSE]}$`);H("LONECARET","(?:\\^)");H("CARETTRIM",`(\\s*)${C[R.LONECARET]}\\s+`,!0);wr.caretTrimReplace="$1^";H("CARET",`^${C[R.LONECARET]}${C[R.XRANGEPLAIN]}$`);H("CARETLOOSE",`^${C[R.LONECARET]}${C[R.XRANGEPLAINLOOSE]}$`);H("COMPARATORLOOSE",`^${C[R.GTLT]}\\s*(${C[R.LOOSEPLAIN]})$|^$`);H("COMPARATOR",`^${C[R.GTLT]}\\s*(${C[R.FULLPLAIN]})$|^$`);H("COMPARATORTRIM",`(\\s*)${C[R.GTLT]}\\s*(${C[R.LOOSEPLAIN]}|${C[R.XRANGEPLAIN]})`,!0);wr.comparatorTrimReplace="$1$2$3";H("HYPHENRANGE",`^\\s*(${C[R.XRANGEPLAIN]})\\s+-\\s+(${C[R.XRANGEPLAIN]})\\s*$`);H("HYPHENRANGELOOSE",`^\\s*(${C[R.XRANGEPLAINLOOSE]})\\s+-\\s+(${C[R.XRANGEPLAINLOOSE]})\\s*$`);H("STAR","(<|>)?=?\\s*\\*");H("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$");H("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")});var go=N((Rk,bf)=>{var Yw=Object.freeze({loose:!0}),Qw=Object.freeze({}),ev=n=>n?typeof n!="object"?Yw:n:Qw;bf.exports=ev});var Dc=N((Nk,vf)=>{var _f=/^[0-9]+$/,wf=(n,e)=>{let t=_f.test(n),r=_f.test(e);return t&&r&&(n=+n,e=+e),n===e?0:t&&!r?-1:r&&!t?1:n<e?-1:1},tv=(n,e)=>wf(e,n);vf.exports={compareIdentifiers:wf,rcompareIdentifiers:tv}});var Fe=N(($k,xf)=>{var yo=Ks(),{MAX_LENGTH:Af,MAX_SAFE_INTEGER:bo}=Gs(),{safeRe:Ef,t:Of}=Ka(),rv=go(),{compareIdentifiers:Ja}=Dc(),Mc=class n{constructor(e,t){if(t=rv(t),e instanceof n){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if(typeof e!="string")throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>Af)throw new TypeError(`version is longer than ${Af} characters`);yo("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;let r=e.trim().match(t.loose?Ef[Of.LOOSE]:Ef[Of.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>bo||this.major<0)throw new TypeError("Invalid major version");if(this.minor>bo||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>bo||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(a=>{if(/^[0-9]+$/.test(a)){let s=+a;if(s>=0&&s<bo)return s}return a}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(yo("SemVer.compare",this.version,this.options,e),!(e instanceof n)){if(typeof e=="string"&&e===this.version)return 0;e=new n(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof n||(e=new n(e,this.options)),Ja(this.major,e.major)||Ja(this.minor,e.minor)||Ja(this.patch,e.patch)}comparePre(e){if(e instanceof n||(e=new n(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{let r=this.prerelease[t],a=e.prerelease[t];if(yo("prerelease compare",t,r,a),r===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(r===void 0)return-1;if(r===a)continue;return Ja(r,a)}while(++t)}compareBuild(e){e instanceof n||(e=new n(e,this.options));let t=0;do{let r=this.build[t],a=e.build[t];if(yo("build compare",t,r,a),r===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(r===void 0)return-1;if(r===a)continue;return Ja(r,a)}while(++t)}inc(e,t,r){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":this.prerelease.length===0&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"major":(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case"pre":{let a=Number(r)?1:0;if(!t&&r===!1)throw new Error("invalid increment argument: identifier is empty");if(this.prerelease.length===0)this.prerelease=[a];else{let s=this.prerelease.length;for(;--s>=0;)typeof this.prerelease[s]=="number"&&(this.prerelease[s]++,s=-2);if(s===-1){if(t===this.prerelease.join(".")&&r===!1)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(a)}}if(t){let s=[t,a];r===!1&&(s=[t]),Ja(this.prerelease[0],t)===0?isNaN(this.prerelease[1])&&(this.prerelease=s):this.prerelease=s}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};xf.exports=Mc});var zn=N((jk,Pf)=>{var If=Fe(),nv=(n,e,t=!1)=>{if(n instanceof If)return n;try{return new If(n,e)}catch(r){if(!t)return null;throw r}};Pf.exports=nv});var Sf=N((Lk,Tf)=>{var av=zn(),sv=(n,e)=>{let t=av(n,e);return t?t.version:null};Tf.exports=sv});var Cf=N((Dk,kf)=>{var iv=zn(),ov=(n,e)=>{let t=iv(n.trim().replace(/^[=v]+/,""),e);return t?t.version:null};kf.exports=ov});var $f=N((Mk,Nf)=>{var Rf=Fe(),uv=(n,e,t,r,a)=>{typeof t=="string"&&(a=r,r=t,t=void 0);try{return new Rf(n instanceof Rf?n.version:n,t).inc(e,r,a).version}catch(s){return null}};Nf.exports=uv});var Df=N((Fk,Lf)=>{var jf=zn(),cv=(n,e)=>{let t=jf(n,null,!0),r=jf(e,null,!0),a=t.compare(r);if(a===0)return null;let s=a>0,i=s?t:r,o=s?r:t,u=!!i.prerelease.length;if(!!o.prerelease.length&&!u)return!o.patch&&!o.minor?"major":i.patch?"patch":i.minor?"minor":"major";let l=u?"pre":"";return t.major!==r.major?l+"major":t.minor!==r.minor?l+"minor":t.patch!==r.patch?l+"patch":"prerelease"};Lf.exports=cv});var Ff=N((Uk,Mf)=>{var lv=Fe(),dv=(n,e)=>new lv(n,e).major;Mf.exports=dv});var zf=N((zk,Uf)=>{var hv=Fe(),fv=(n,e)=>new hv(n,e).minor;Uf.exports=fv});var qf=N((Bk,Bf)=>{var pv=Fe(),mv=(n,e)=>new pv(n,e).patch;Bf.exports=mv});var Hf=N((qk,Vf)=>{var gv=zn(),yv=(n,e)=>{let t=gv(n,e);return t&&t.prerelease.length?t.prerelease:null};Vf.exports=yv});var vt=N((Vk,Gf)=>{var Zf=Fe(),bv=(n,e,t)=>new Zf(n,t).compare(new Zf(e,t));Gf.exports=bv});var Jf=N((Hk,Kf)=>{var _v=vt(),wv=(n,e,t)=>_v(e,n,t);Kf.exports=wv});var Xf=N((Zk,Wf)=>{var vv=vt(),Av=(n,e)=>vv(n,e,!0);Wf.exports=Av});var _o=N((Gk,Qf)=>{var Yf=Fe(),Ev=(n,e,t)=>{let r=new Yf(n,t),a=new Yf(e,t);return r.compare(a)||r.compareBuild(a)};Qf.exports=Ev});var tp=N((Kk,ep)=>{var Ov=_o(),xv=(n,e)=>n.sort((t,r)=>Ov(t,r,e));ep.exports=xv});var np=N((Jk,rp)=>{var Iv=_o(),Pv=(n,e)=>n.sort((t,r)=>Iv(r,t,e));rp.exports=Pv});var Js=N((Wk,ap)=>{var Tv=vt(),Sv=(n,e,t)=>Tv(n,e,t)>0;ap.exports=Sv});var wo=N((Xk,sp)=>{var kv=vt(),Cv=(n,e,t)=>kv(n,e,t)<0;sp.exports=Cv});var Fc=N((Yk,ip)=>{var Rv=vt(),Nv=(n,e,t)=>Rv(n,e,t)===0;ip.exports=Nv});var Uc=N((Qk,op)=>{var $v=vt(),jv=(n,e,t)=>$v(n,e,t)!==0;op.exports=jv});var vo=N((eC,up)=>{var Lv=vt(),Dv=(n,e,t)=>Lv(n,e,t)>=0;up.exports=Dv});var Ao=N((tC,cp)=>{var Mv=vt(),Fv=(n,e,t)=>Mv(n,e,t)<=0;cp.exports=Fv});var zc=N((rC,lp)=>{var Uv=Fc(),zv=Uc(),Bv=Js(),qv=vo(),Vv=wo(),Hv=Ao(),Zv=(n,e,t,r)=>{switch(e){case"===":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n===t;case"!==":return typeof n=="object"&&(n=n.version),typeof t=="object"&&(t=t.version),n!==t;case"":case"=":case"==":return Uv(n,t,r);case"!=":return zv(n,t,r);case">":return Bv(n,t,r);case">=":return qv(n,t,r);case"<":return Vv(n,t,r);case"<=":return Hv(n,t,r);default:throw new TypeError(`Invalid operator: ${e}`)}};lp.exports=Zv});var hp=N((nC,dp)=>{var Gv=Fe(),Kv=zn(),{safeRe:Eo,t:Oo}=Ka(),Jv=(n,e)=>{if(n instanceof Gv)return n;if(typeof n=="number"&&(n=String(n)),typeof n!="string")return null;e=e||{};let t=null;if(!e.rtl)t=n.match(e.includePrerelease?Eo[Oo.COERCEFULL]:Eo[Oo.COERCE]);else{let u=e.includePrerelease?Eo[Oo.COERCERTLFULL]:Eo[Oo.COERCERTL],c;for(;(c=u.exec(n))&&(!t||t.index+t[0].length!==n.length);)(!t||c.index+c[0].length!==t.index+t[0].length)&&(t=c),u.lastIndex=c.index+c[1].length+c[2].length;u.lastIndex=-1}if(t===null)return null;let r=t[2],a=t[3]||"0",s=t[4]||"0",i=e.includePrerelease&&t[5]?`-${t[5]}`:"",o=e.includePrerelease&&t[6]?`+${t[6]}`:"";return Kv(`${r}.${a}.${s}${i}${o}`,e)};dp.exports=Jv});var pp=N((aC,fp)=>{var Bc=class{constructor(){this.max=1e3,this.map=new Map}get(e){let t=this.map.get(e);if(t!==void 0)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&t!==void 0){if(this.map.size>=this.max){let a=this.map.keys().next().value;this.delete(a)}this.map.set(e,t)}return this}};fp.exports=Bc});var At=N((sC,bp)=>{var Wv=/\s+/g,qc=class n{constructor(e,t){if(t=Yv(t),e instanceof n)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new n(e.raw,t);if(e instanceof Vc)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(Wv," "),this.set=this.raw.split("||").map(r=>this.parseRange(r.trim())).filter(r=>r.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){let r=this.set[0];if(this.set=this.set.filter(a=>!gp(a[0])),this.set.length===0)this.set=[r];else if(this.set.length>1){for(let a of this.set)if(a.length===1&&s0(a[0])){this.set=[a];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");let t=this.set[e];for(let r=0;r<t.length;r++)r>0&&(this.formatted+=" "),this.formatted+=t[r].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){let r=((this.options.includePrerelease&&n0)|(this.options.loose&&a0))+":"+e,a=mp.get(r);if(a)return a;let s=this.options.loose,i=s?rt[He.HYPHENRANGELOOSE]:rt[He.HYPHENRANGE];e=e.replace(i,m0(this.options.includePrerelease)),le("hyphen replace",e),e=e.replace(rt[He.COMPARATORTRIM],e0),le("comparator trim",e),e=e.replace(rt[He.TILDETRIM],t0),le("tilde trim",e),e=e.replace(rt[He.CARETTRIM],r0),le("caret trim",e);let o=e.split(" ").map(d=>i0(d,this.options)).join(" ").split(/\s+/).map(d=>p0(d,this.options));s&&(o=o.filter(d=>(le("loose invalid filter",d,this.options),!!d.match(rt[He.COMPARATORLOOSE])))),le("range list",o);let u=new Map,c=o.map(d=>new Vc(d,this.options));for(let d of c){if(gp(d))return[d];u.set(d.value,d)}u.size>1&&u.has("")&&u.delete("");let l=[...u.values()];return mp.set(r,l),l}intersects(e,t){if(!(e instanceof n))throw new TypeError("a Range is required");return this.set.some(r=>yp(r,t)&&e.set.some(a=>yp(a,t)&&r.every(s=>a.every(i=>s.intersects(i,t)))))}test(e){if(!e)return!1;if(typeof e=="string")try{e=new Qv(e,this.options)}catch(t){return!1}for(let t=0;t<this.set.length;t++)if(g0(this.set[t],e,this.options))return!0;return!1}};bp.exports=qc;var Xv=pp(),mp=new Xv,Yv=go(),Vc=Ws(),le=Ks(),Qv=Fe(),{safeRe:rt,t:He,comparatorTrimReplace:e0,tildeTrimReplace:t0,caretTrimReplace:r0}=Ka(),{FLAG_INCLUDE_PRERELEASE:n0,FLAG_LOOSE:a0}=Gs(),gp=n=>n.value==="<0.0.0-0",s0=n=>n.value==="",yp=(n,e)=>{let t=!0,r=n.slice(),a=r.pop();for(;t&&r.length;)t=r.every(s=>a.intersects(s,e)),a=r.pop();return t},i0=(n,e)=>(le("comp",n,e),n=c0(n,e),le("caret",n),n=o0(n,e),le("tildes",n),n=d0(n,e),le("xrange",n),n=f0(n,e),le("stars",n),n),Ze=n=>!n||n.toLowerCase()==="x"||n==="*",o0=(n,e)=>n.trim().split(/\s+/).map(t=>u0(t,e)).join(" "),u0=(n,e)=>{let t=e.loose?rt[He.TILDELOOSE]:rt[He.TILDE];return n.replace(t,(r,a,s,i,o)=>{le("tilde",n,r,a,s,i,o);let u;return Ze(a)?u="":Ze(s)?u=`>=${a}.0.0 <${+a+1}.0.0-0`:Ze(i)?u=`>=${a}.${s}.0 <${a}.${+s+1}.0-0`:o?(le("replaceTilde pr",o),u=`>=${a}.${s}.${i}-${o} <${a}.${+s+1}.0-0`):u=`>=${a}.${s}.${i} <${a}.${+s+1}.0-0`,le("tilde return",u),u})},c0=(n,e)=>n.trim().split(/\s+/).map(t=>l0(t,e)).join(" "),l0=(n,e)=>{le("caret",n,e);let t=e.loose?rt[He.CARETLOOSE]:rt[He.CARET],r=e.includePrerelease?"-0":"";return n.replace(t,(a,s,i,o,u)=>{le("caret",n,a,s,i,o,u);let c;return Ze(s)?c="":Ze(i)?c=`>=${s}.0.0${r} <${+s+1}.0.0-0`:Ze(o)?s==="0"?c=`>=${s}.${i}.0${r} <${s}.${+i+1}.0-0`:c=`>=${s}.${i}.0${r} <${+s+1}.0.0-0`:u?(le("replaceCaret pr",u),s==="0"?i==="0"?c=`>=${s}.${i}.${o}-${u} <${s}.${i}.${+o+1}-0`:c=`>=${s}.${i}.${o}-${u} <${s}.${+i+1}.0-0`:c=`>=${s}.${i}.${o}-${u} <${+s+1}.0.0-0`):(le("no pr"),s==="0"?i==="0"?c=`>=${s}.${i}.${o}${r} <${s}.${i}.${+o+1}-0`:c=`>=${s}.${i}.${o}${r} <${s}.${+i+1}.0-0`:c=`>=${s}.${i}.${o} <${+s+1}.0.0-0`),le("caret return",c),c})},d0=(n,e)=>(le("replaceXRanges",n,e),n.split(/\s+/).map(t=>h0(t,e)).join(" ")),h0=(n,e)=>{n=n.trim();let t=e.loose?rt[He.XRANGELOOSE]:rt[He.XRANGE];return n.replace(t,(r,a,s,i,o,u)=>{le("xRange",n,r,a,s,i,o,u);let c=Ze(s),l=c||Ze(i),d=l||Ze(o),h=d;return a==="="&&h&&(a=""),u=e.includePrerelease?"-0":"",c?a===">"||a==="<"?r="<0.0.0-0":r="*":a&&h?(l&&(i=0),o=0,a===">"?(a=">=",l?(s=+s+1,i=0,o=0):(i=+i+1,o=0)):a==="<="&&(a="<",l?s=+s+1:i=+i+1),a==="<"&&(u="-0"),r=`${a+s}.${i}.${o}${u}`):l?r=`>=${s}.0.0${u} <${+s+1}.0.0-0`:d&&(r=`>=${s}.${i}.0${u} <${s}.${+i+1}.0-0`),le("xRange return",r),r})},f0=(n,e)=>(le("replaceStars",n,e),n.trim().replace(rt[He.STAR],"")),p0=(n,e)=>(le("replaceGTE0",n,e),n.trim().replace(rt[e.includePrerelease?He.GTE0PRE:He.GTE0],"")),m0=n=>(e,t,r,a,s,i,o,u,c,l,d,h)=>(Ze(r)?t="":Ze(a)?t=`>=${r}.0.0${n?"-0":""}`:Ze(s)?t=`>=${r}.${a}.0${n?"-0":""}`:i?t=`>=${t}`:t=`>=${t}${n?"-0":""}`,Ze(c)?u="":Ze(l)?u=`<${+c+1}.0.0-0`:Ze(d)?u=`<${c}.${+l+1}.0-0`:h?u=`<=${c}.${l}.${d}-${h}`:n?u=`<${c}.${l}.${+d+1}-0`:u=`<=${u}`,`${t} ${u}`.trim()),g0=(n,e,t)=>{for(let r=0;r<n.length;r++)if(!n[r].test(e))return!1;if(e.prerelease.length&&!t.includePrerelease){for(let r=0;r<n.length;r++)if(le(n[r].semver),n[r].semver!==Vc.ANY&&n[r].semver.prerelease.length>0){let a=n[r].semver;if(a.major===e.major&&a.minor===e.minor&&a.patch===e.patch)return!0}return!1}return!0}});var Ws=N((iC,Op)=>{var Xs=Symbol("SemVer ANY"),Gc=class n{static get ANY(){return Xs}constructor(e,t){if(t=_p(t),e instanceof n){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),Zc("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===Xs?this.value="":this.value=this.operator+this.semver.version,Zc("comp",this)}parse(e){let t=this.options.loose?wp[vp.COMPARATORLOOSE]:wp[vp.COMPARATOR],r=e.match(t);if(!r)throw new TypeError(`Invalid comparator: ${e}`);this.operator=r[1]!==void 0?r[1]:"",this.operator==="="&&(this.operator=""),r[2]?this.semver=new Ap(r[2],this.options.loose):this.semver=Xs}toString(){return this.value}test(e){if(Zc("Comparator.test",e,this.options.loose),this.semver===Xs||e===Xs)return!0;if(typeof e=="string")try{e=new Ap(e,this.options)}catch(t){return!1}return Hc(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof n))throw new TypeError("a Comparator is required");return this.operator===""?this.value===""?!0:new Ep(e.value,t).test(this.value):e.operator===""?e.value===""?!0:new Ep(this.value,t).test(e.semver):(t=_p(t),t.includePrerelease&&(this.value==="<0.0.0-0"||e.value==="<0.0.0-0")||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))?!1:!!(this.operator.startsWith(">")&&e.operator.startsWith(">")||this.operator.startsWith("<")&&e.operator.startsWith("<")||this.semver.version===e.semver.version&&this.operator.includes("=")&&e.operator.includes("=")||Hc(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<")||Hc(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}};Op.exports=Gc;var _p=go(),{safeRe:wp,t:vp}=Ka(),Hc=zc(),Zc=Ks(),Ap=Fe(),Ep=At()});var Ys=N((oC,xp)=>{var y0=At(),b0=(n,e,t)=>{try{e=new y0(e,t)}catch(r){return!1}return e.test(n)};xp.exports=b0});var Pp=N((uC,Ip)=>{var _0=At(),w0=(n,e)=>new _0(n,e).set.map(t=>t.map(r=>r.value).join(" ").trim().split(" "));Ip.exports=w0});var Sp=N((cC,Tp)=>{var v0=Fe(),A0=At(),E0=(n,e,t)=>{let r=null,a=null,s=null;try{s=new A0(e,t)}catch(i){return null}return n.forEach(i=>{s.test(i)&&(!r||a.compare(i)===-1)&&(r=i,a=new v0(r,t))}),r};Tp.exports=E0});var Cp=N((lC,kp)=>{var O0=Fe(),x0=At(),I0=(n,e,t)=>{let r=null,a=null,s=null;try{s=new x0(e,t)}catch(i){return null}return n.forEach(i=>{s.test(i)&&(!r||a.compare(i)===1)&&(r=i,a=new O0(r,t))}),r};kp.exports=I0});var $p=N((dC,Np)=>{var Kc=Fe(),P0=At(),Rp=Js(),T0=(n,e)=>{n=new P0(n,e);let t=new Kc("0.0.0");if(n.test(t)||(t=new Kc("0.0.0-0"),n.test(t)))return t;t=null;for(let r=0;r<n.set.length;++r){let a=n.set[r],s=null;a.forEach(i=>{let o=new Kc(i.semver.version);switch(i.operator){case">":o.prerelease.length===0?o.patch++:o.prerelease.push(0),o.raw=o.format();case"":case">=":(!s||Rp(o,s))&&(s=o);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${i.operator}`)}}),s&&(!t||Rp(t,s))&&(t=s)}return t&&n.test(t)?t:null};Np.exports=T0});var Lp=N((hC,jp)=>{var S0=At(),k0=(n,e)=>{try{return new S0(n,e).range||"*"}catch(t){return null}};jp.exports=k0});var xo=N((fC,Up)=>{var C0=Fe(),Fp=Ws(),{ANY:R0}=Fp,N0=At(),$0=Ys(),Dp=Js(),Mp=wo(),j0=Ao(),L0=vo(),D0=(n,e,t,r)=>{n=new C0(n,r),e=new N0(e,r);let a,s,i,o,u;switch(t){case">":a=Dp,s=j0,i=Mp,o=">",u=">=";break;case"<":a=Mp,s=L0,i=Dp,o="<",u="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if($0(n,e,r))return!1;for(let c=0;c<e.set.length;++c){let l=e.set[c],d=null,h=null;if(l.forEach(f=>{f.semver===R0&&(f=new Fp(">=0.0.0")),d=d||f,h=h||f,a(f.semver,d.semver,r)?d=f:i(f.semver,h.semver,r)&&(h=f)}),d.operator===o||d.operator===u||(!h.operator||h.operator===o)&&s(n,h.semver))return!1;if(h.operator===u&&i(n,h.semver))return!1}return!0};Up.exports=D0});var Bp=N((pC,zp)=>{var M0=xo(),F0=(n,e,t)=>M0(n,e,">",t);zp.exports=F0});var Vp=N((mC,qp)=>{var U0=xo(),z0=(n,e,t)=>U0(n,e,"<",t);qp.exports=z0});var Gp=N((gC,Zp)=>{var Hp=At(),B0=(n,e,t)=>(n=new Hp(n,t),e=new Hp(e,t),n.intersects(e,t));Zp.exports=B0});var Jp=N((yC,Kp)=>{var q0=Ys(),V0=vt();Kp.exports=(n,e,t)=>{let r=[],a=null,s=null,i=n.sort((l,d)=>V0(l,d,t));for(let l of i)q0(l,e,t)?(s=l,a||(a=l)):(s&&r.push([a,s]),s=null,a=null);a&&r.push([a,null]);let o=[];for(let[l,d]of r)l===d?o.push(l):!d&&l===i[0]?o.push("*"):d?l===i[0]?o.push(`<=${d}`):o.push(`${l} - ${d}`):o.push(`>=${l}`);let u=o.join(" || "),c=typeof e.raw=="string"?e.raw:String(e);return u.length<c.length?u:e}});var tm=N((bC,em)=>{var Wp=At(),Wc=Ws(),{ANY:Jc}=Wc,Qs=Ys(),Xc=vt(),H0=(n,e,t={})=>{if(n===e)return!0;n=new Wp(n,t),e=new Wp(e,t);let r=!1;e:for(let a of n.set){for(let s of e.set){let i=G0(a,s,t);if(r=r||i!==null,i)continue e}if(r)return!1}return!0},Z0=[new Wc(">=0.0.0-0")],Xp=[new Wc(">=0.0.0")],G0=(n,e,t)=>{if(n===e)return!0;if(n.length===1&&n[0].semver===Jc){if(e.length===1&&e[0].semver===Jc)return!0;t.includePrerelease?n=Z0:n=Xp}if(e.length===1&&e[0].semver===Jc){if(t.includePrerelease)return!0;e=Xp}let r=new Set,a,s;for(let f of n)f.operator===">"||f.operator===">="?a=Yp(a,f,t):f.operator==="<"||f.operator==="<="?s=Qp(s,f,t):r.add(f.semver);if(r.size>1)return null;let i;if(a&&s){if(i=Xc(a.semver,s.semver,t),i>0)return null;if(i===0&&(a.operator!==">="||s.operator!=="<="))return null}for(let f of r){if(a&&!Qs(f,String(a),t)||s&&!Qs(f,String(s),t))return null;for(let p of e)if(!Qs(f,String(p),t))return!1;return!0}let o,u,c,l,d=s&&!t.includePrerelease&&s.semver.prerelease.length?s.semver:!1,h=a&&!t.includePrerelease&&a.semver.prerelease.length?a.semver:!1;d&&d.prerelease.length===1&&s.operator==="<"&&d.prerelease[0]===0&&(d=!1);for(let f of e){if(l=l||f.operator===">"||f.operator===">=",c=c||f.operator==="<"||f.operator==="<=",a){if(h&&f.semver.prerelease&&f.semver.prerelease.length&&f.semver.major===h.major&&f.semver.minor===h.minor&&f.semver.patch===h.patch&&(h=!1),f.operator===">"||f.operator===">="){if(o=Yp(a,f,t),o===f&&o!==a)return!1}else if(a.operator===">="&&!Qs(a.semver,String(f),t))return!1}if(s){if(d&&f.semver.prerelease&&f.semver.prerelease.length&&f.semver.major===d.major&&f.semver.minor===d.minor&&f.semver.patch===d.patch&&(d=!1),f.operator==="<"||f.operator==="<="){if(u=Qp(s,f,t),u===f&&u!==s)return!1}else if(s.operator==="<="&&!Qs(s.semver,String(f),t))return!1}if(!f.operator&&(s||a)&&i!==0)return!1}return!(a&&c&&!s&&i!==0||s&&l&&!a&&i!==0||h||d)},Yp=(n,e,t)=>{if(!n)return e;let r=Xc(n.semver,e.semver,t);return r>0?n:r<0||e.operator===">"&&n.operator===">="?e:n},Qp=(n,e,t)=>{if(!n)return e;let r=Xc(n.semver,e.semver,t);return r<0?n:r>0||e.operator==="<"&&n.operator==="<="?e:n};em.exports=H0});var sm=N((_C,am)=>{var Yc=Ka(),rm=Gs(),K0=Fe(),nm=Dc(),J0=zn(),W0=Sf(),X0=Cf(),Y0=$f(),Q0=Df(),eA=Ff(),tA=zf(),rA=qf(),nA=Hf(),aA=vt(),sA=Jf(),iA=Xf(),oA=_o(),uA=tp(),cA=np(),lA=Js(),dA=wo(),hA=Fc(),fA=Uc(),pA=vo(),mA=Ao(),gA=zc(),yA=hp(),bA=Ws(),_A=At(),wA=Ys(),vA=Pp(),AA=Sp(),EA=Cp(),OA=$p(),xA=Lp(),IA=xo(),PA=Bp(),TA=Vp(),SA=Gp(),kA=Jp(),CA=tm();am.exports={parse:J0,valid:W0,clean:X0,inc:Y0,diff:Q0,major:eA,minor:tA,patch:rA,prerelease:nA,compare:aA,rcompare:sA,compareLoose:iA,compareBuild:oA,sort:uA,rsort:cA,gt:lA,lt:dA,eq:hA,neq:fA,gte:pA,lte:mA,cmp:gA,coerce:yA,Comparator:bA,Range:_A,satisfies:wA,toComparators:vA,maxSatisfying:AA,minSatisfying:EA,minVersion:OA,validRange:xA,outside:IA,gtr:PA,ltr:TA,intersects:SA,simplifyRange:kA,subset:CA,SemVer:K0,re:Yc.re,src:Yc.src,tokens:Yc.t,SEMVER_SPEC_VERSION:rm.SEMVER_SPEC_VERSION,RELEASE_TYPES:rm.RELEASE_TYPES,compareIdentifiers:nm.compareIdentifiers,rcompareIdentifiers:nm.rcompareIdentifiers}});var Am=N((bR,vm)=>{"use strict";var _m=(n=0)=>e=>`\x1B[${38+n};5;${e}m`,wm=(n=0)=>(e,t,r)=>`\x1B[${38+n};2;${e};${t};${r}m`;function hE(){let n=new Map,e={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};e.color.gray=e.color.blackBright,e.bgColor.bgGray=e.bgColor.bgBlackBright,e.color.grey=e.color.blackBright,e.bgColor.bgGrey=e.bgColor.bgBlackBright;for(let[t,r]of Object.entries(e)){for(let[a,s]of Object.entries(r))e[a]={open:`\x1B[${s[0]}m`,close:`\x1B[${s[1]}m`},r[a]=e[a],n.set(s[0],s[1]);Object.defineProperty(e,t,{value:r,enumerable:!1})}return Object.defineProperty(e,"codes",{value:n,enumerable:!1}),e.color.close="\x1B[39m",e.bgColor.close="\x1B[49m",e.color.ansi256=_m(),e.color.ansi16m=wm(),e.bgColor.ansi256=_m(10),e.bgColor.ansi16m=wm(10),Object.defineProperties(e,{rgbToAnsi256:{value:(t,r,a)=>t===r&&r===a?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(r/255*5)+Math.round(a/255*5),enumerable:!1},hexToRgb:{value:t=>{let r=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(t.toString(16));if(!r)return[0,0,0];let{colorString:a}=r.groups;a.length===3&&(a=a.split("").map(i=>i+i).join(""));let s=Number.parseInt(a,16);return[s>>16&255,s>>8&255,s&255]},enumerable:!1},hexToAnsi256:{value:t=>e.rgbToAnsi256(...e.hexToRgb(t)),enumerable:!1}}),e}Object.defineProperty(vm,"exports",{enumerable:!0,get:hE})});var Og=N(cu=>{"use strict";cu.byteLength=UE;cu.toByteArray=BE;cu.fromByteArray=HE;var ir=[],Tt=[],FE=typeof Uint8Array!="undefined"?Uint8Array:Array,jl="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Gn=0,Ag=jl.length;Gn<Ag;++Gn)ir[Gn]=jl[Gn],Tt[jl.charCodeAt(Gn)]=Gn;var Gn,Ag;Tt[45]=62;Tt[95]=63;function Eg(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function UE(n){var e=Eg(n),t=e[0],r=e[1];return(t+r)*3/4-r}function zE(n,e,t){return(e+t)*3/4-t}function BE(n){var e,t=Eg(n),r=t[0],a=t[1],s=new FE(zE(n,r,a)),i=0,o=a>0?r-4:r,u;for(u=0;u<o;u+=4)e=Tt[n.charCodeAt(u)]<<18|Tt[n.charCodeAt(u+1)]<<12|Tt[n.charCodeAt(u+2)]<<6|Tt[n.charCodeAt(u+3)],s[i++]=e>>16&255,s[i++]=e>>8&255,s[i++]=e&255;return a===2&&(e=Tt[n.charCodeAt(u)]<<2|Tt[n.charCodeAt(u+1)]>>4,s[i++]=e&255),a===1&&(e=Tt[n.charCodeAt(u)]<<10|Tt[n.charCodeAt(u+1)]<<4|Tt[n.charCodeAt(u+2)]>>2,s[i++]=e>>8&255,s[i++]=e&255),s}function qE(n){return ir[n>>18&63]+ir[n>>12&63]+ir[n>>6&63]+ir[n&63]}function VE(n,e,t){for(var r,a=[],s=e;s<t;s+=3)r=(n[s]<<16&16711680)+(n[s+1]<<8&65280)+(n[s+2]&255),a.push(qE(r));return a.join("")}function HE(n){for(var e,t=n.length,r=t%3,a=[],s=16383,i=0,o=t-r;i<o;i+=s)a.push(VE(n,i,i+s>o?o:i+s));return r===1?(e=n[t-1],a.push(ir[e>>2]+ir[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],a.push(ir[e>>10]+ir[e>>4&63]+ir[e<<2&63]+"=")),a.join("")}});var Ny=N((aB,ls)=>{var P=function(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32},oe=-1,ce=1,K=0;P.Diff=function(n,e){return[n,e]};P.prototype.diff_main=function(n,e,t,r){typeof r=="undefined"&&(this.Diff_Timeout<=0?r=Number.MAX_VALUE:r=new Date().getTime()+this.Diff_Timeout*1e3);var a=r;if(n==null||e==null)throw new Error("Null input. (diff_main)");if(n==e)return n?[new P.Diff(K,n)]:[];typeof t=="undefined"&&(t=!0);var s=t,i=this.diff_commonPrefix(n,e),o=n.substring(0,i);n=n.substring(i),e=e.substring(i),i=this.diff_commonSuffix(n,e);var u=n.substring(n.length-i);n=n.substring(0,n.length-i),e=e.substring(0,e.length-i);var c=this.diff_compute_(n,e,s,a);return o&&c.unshift(new P.Diff(K,o)),u&&c.push(new P.Diff(K,u)),this.diff_cleanupMerge(c),c};P.prototype.diff_compute_=function(n,e,t,r){var a;if(!n)return[new P.Diff(ce,e)];if(!e)return[new P.Diff(oe,n)];var s=n.length>e.length?n:e,i=n.length>e.length?e:n,o=s.indexOf(i);if(o!=-1)return a=[new P.Diff(ce,s.substring(0,o)),new P.Diff(K,i),new P.Diff(ce,s.substring(o+i.length))],n.length>e.length&&(a[0][0]=a[2][0]=oe),a;if(i.length==1)return[new P.Diff(oe,n),new P.Diff(ce,e)];var u=this.diff_halfMatch_(n,e);if(u){var c=u[0],l=u[1],d=u[2],h=u[3],f=u[4],p=this.diff_main(c,d,t,r),g=this.diff_main(l,h,t,r);return p.concat([new P.Diff(K,f)],g)}return t&&n.length>100&&e.length>100?this.diff_lineMode_(n,e,r):this.diff_bisect_(n,e,r)};P.prototype.diff_lineMode_=function(n,e,t){var r=this.diff_linesToChars_(n,e);n=r.chars1,e=r.chars2;var a=r.lineArray,s=this.diff_main(n,e,!1,t);this.diff_charsToLines_(s,a),this.diff_cleanupSemantic(s),s.push(new P.Diff(K,""));for(var i=0,o=0,u=0,c="",l="";i<s.length;){switch(s[i][0]){case ce:u++,l+=s[i][1];break;case oe:o++,c+=s[i][1];break;case K:if(o>=1&&u>=1){s.splice(i-o-u,o+u),i=i-o-u;for(var d=this.diff_main(c,l,!1,t),h=d.length-1;h>=0;h--)s.splice(i,0,d[h]);i=i+d.length}u=0,o=0,c="",l="";break}i++}return s.pop(),s};P.prototype.diff_bisect_=function(n,e,t){for(var r=n.length,a=e.length,s=Math.ceil((r+a)/2),i=s,o=2*s,u=new Array(o),c=new Array(o),l=0;l<o;l++)u[l]=-1,c[l]=-1;u[i+1]=0,c[i+1]=0;for(var d=r-a,h=d%2!=0,f=0,p=0,g=0,y=0,m=0;m<s&&!(new Date().getTime()>t);m++){for(var b=-m+f;b<=m-p;b+=2){var A=i+b,I;b==-m||b!=m&&u[A-1]<u[A+1]?I=u[A+1]:I=u[A-1]+1;for(var _=I-b;I<r&&_<a&&n.charAt(I)==e.charAt(_);)I++,_++;if(u[A]=I,I>r)p+=2;else if(_>a)f+=2;else if(h){var v=i+d-b;if(v>=0&&v<o&&c[v]!=-1){var E=r-c[v];if(I>=E)return this.diff_bisectSplit_(n,e,I,_,t)}}}for(var O=-m+g;O<=m-y;O+=2){var v=i+O,E;O==-m||O!=m&&c[v-1]<c[v+1]?E=c[v+1]:E=c[v-1]+1;for(var S=E-O;E<r&&S<a&&n.charAt(r-E-1)==e.charAt(a-S-1);)E++,S++;if(c[v]=E,E>r)y+=2;else if(S>a)g+=2;else if(!h){var A=i+d-O;if(A>=0&&A<o&&u[A]!=-1){var I=u[A],_=i+I-A;if(E=r-E,I>=E)return this.diff_bisectSplit_(n,e,I,_,t)}}}}return[new P.Diff(oe,n),new P.Diff(ce,e)]};P.prototype.diff_bisectSplit_=function(n,e,t,r,a){var s=n.substring(0,t),i=e.substring(0,r),o=n.substring(t),u=e.substring(r),c=this.diff_main(s,i,!1,a),l=this.diff_main(o,u,!1,a);return c.concat(l)};P.prototype.diff_linesToChars_=function(n,e){var t=[],r={};t[0]="";function a(u){for(var c="",l=0,d=-1,h=t.length;d<u.length-1;){d=u.indexOf(`
`,l),d==-1&&(d=u.length-1);var f=u.substring(l,d+1);(r.hasOwnProperty?r.hasOwnProperty(f):r[f]!==void 0)?c+=String.fromCharCode(r[f]):(h==s&&(f=u.substring(l),d=u.length),c+=String.fromCharCode(h),r[f]=h,t[h++]=f),l=d+1}return c}var s=4e4,i=a(n);s=65535;var o=a(e);return{chars1:i,chars2:o,lineArray:t}};P.prototype.diff_charsToLines_=function(n,e){for(var t=0;t<n.length;t++){for(var r=n[t][1],a=[],s=0;s<r.length;s++)a[s]=e[r.charCodeAt(s)];n[t][1]=a.join("")}};P.prototype.diff_commonPrefix=function(n,e){if(!n||!e||n.charAt(0)!=e.charAt(0))return 0;for(var t=0,r=Math.min(n.length,e.length),a=r,s=0;t<a;)n.substring(s,a)==e.substring(s,a)?(t=a,s=t):r=a,a=Math.floor((r-t)/2+t);return a};P.prototype.diff_commonSuffix=function(n,e){if(!n||!e||n.charAt(n.length-1)!=e.charAt(e.length-1))return 0;for(var t=0,r=Math.min(n.length,e.length),a=r,s=0;t<a;)n.substring(n.length-a,n.length-s)==e.substring(e.length-a,e.length-s)?(t=a,s=t):r=a,a=Math.floor((r-t)/2+t);return a};P.prototype.diff_commonOverlap_=function(n,e){var t=n.length,r=e.length;if(t==0||r==0)return 0;t>r?n=n.substring(t-r):t<r&&(e=e.substring(0,t));var a=Math.min(t,r);if(n==e)return a;for(var s=0,i=1;;){var o=n.substring(a-i),u=e.indexOf(o);if(u==-1)return s;i+=u,(u==0||n.substring(a-i)==e.substring(0,i))&&(s=i,i++)}};P.prototype.diff_halfMatch_=function(n,e){if(this.Diff_Timeout<=0)return null;var t=n.length>e.length?n:e,r=n.length>e.length?e:n;if(t.length<4||r.length*2<t.length)return null;var a=this;function s(p,g,y){for(var m=p.substring(y,y+Math.floor(p.length/4)),b=-1,A="",I,_,v,E;(b=g.indexOf(m,b+1))!=-1;){var O=a.diff_commonPrefix(p.substring(y),g.substring(b)),S=a.diff_commonSuffix(p.substring(0,y),g.substring(0,b));A.length<S+O&&(A=g.substring(b-S,b)+g.substring(b,b+O),I=p.substring(0,y-S),_=p.substring(y+O),v=g.substring(0,b-S),E=g.substring(b+O))}return A.length*2>=p.length?[I,_,v,E,A]:null}var i=s(t,r,Math.ceil(t.length/4)),o=s(t,r,Math.ceil(t.length/2)),u;if(!i&&!o)return null;o?i?u=i[4].length>o[4].length?i:o:u=o:u=i;var c,l,d,h;n.length>e.length?(c=u[0],l=u[1],d=u[2],h=u[3]):(d=u[0],h=u[1],c=u[2],l=u[3]);var f=u[4];return[c,l,d,h,f]};P.prototype.diff_cleanupSemantic=function(n){for(var e=!1,t=[],r=0,a=null,s=0,i=0,o=0,u=0,c=0;s<n.length;)n[s][0]==K?(t[r++]=s,i=u,o=c,u=0,c=0,a=n[s][1]):(n[s][0]==ce?u+=n[s][1].length:c+=n[s][1].length,a&&a.length<=Math.max(i,o)&&a.length<=Math.max(u,c)&&(n.splice(t[r-1],0,new P.Diff(oe,a)),n[t[r-1]+1][0]=ce,r--,r--,s=r>0?t[r-1]:-1,i=0,o=0,u=0,c=0,a=null,e=!0)),s++;for(e&&this.diff_cleanupMerge(n),this.diff_cleanupSemanticLossless(n),s=1;s<n.length;){if(n[s-1][0]==oe&&n[s][0]==ce){var l=n[s-1][1],d=n[s][1],h=this.diff_commonOverlap_(l,d),f=this.diff_commonOverlap_(d,l);h>=f?(h>=l.length/2||h>=d.length/2)&&(n.splice(s,0,new P.Diff(K,d.substring(0,h))),n[s-1][1]=l.substring(0,l.length-h),n[s+1][1]=d.substring(h),s++):(f>=l.length/2||f>=d.length/2)&&(n.splice(s,0,new P.Diff(K,l.substring(0,f))),n[s-1][0]=ce,n[s-1][1]=d.substring(0,d.length-f),n[s+1][0]=oe,n[s+1][1]=l.substring(f),s++),s++}s++}};P.prototype.diff_cleanupSemanticLossless=function(n){function e(f,p){if(!f||!p)return 6;var g=f.charAt(f.length-1),y=p.charAt(0),m=g.match(P.nonAlphaNumericRegex_),b=y.match(P.nonAlphaNumericRegex_),A=m&&g.match(P.whitespaceRegex_),I=b&&y.match(P.whitespaceRegex_),_=A&&g.match(P.linebreakRegex_),v=I&&y.match(P.linebreakRegex_),E=_&&f.match(P.blanklineEndRegex_),O=v&&p.match(P.blanklineStartRegex_);return E||O?5:_||v?4:m&&!A&&I?3:A||I?2:m||b?1:0}for(var t=1;t<n.length-1;){if(n[t-1][0]==K&&n[t+1][0]==K){var r=n[t-1][1],a=n[t][1],s=n[t+1][1],i=this.diff_commonSuffix(r,a);if(i){var o=a.substring(a.length-i);r=r.substring(0,r.length-i),a=o+a.substring(0,a.length-i),s=o+s}for(var u=r,c=a,l=s,d=e(r,a)+e(a,s);a.charAt(0)===s.charAt(0);){r+=a.charAt(0),a=a.substring(1)+s.charAt(0),s=s.substring(1);var h=e(r,a)+e(a,s);h>=d&&(d=h,u=r,c=a,l=s)}n[t-1][1]!=u&&(u?n[t-1][1]=u:(n.splice(t-1,1),t--),n[t][1]=c,l?n[t+1][1]=l:(n.splice(t+1,1),t--))}t++}};P.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/;P.whitespaceRegex_=/\s/;P.linebreakRegex_=/[\r\n]/;P.blanklineEndRegex_=/\n\r?\n$/;P.blanklineStartRegex_=/^\r?\n\r?\n/;P.prototype.diff_cleanupEfficiency=function(n){for(var e=!1,t=[],r=0,a=null,s=0,i=!1,o=!1,u=!1,c=!1;s<n.length;)n[s][0]==K?(n[s][1].length<this.Diff_EditCost&&(u||c)?(t[r++]=s,i=u,o=c,a=n[s][1]):(r=0,a=null),u=c=!1):(n[s][0]==oe?c=!0:u=!0,a&&(i&&o&&u&&c||a.length<this.Diff_EditCost/2&&i+o+u+c==3)&&(n.splice(t[r-1],0,new P.Diff(oe,a)),n[t[r-1]+1][0]=ce,r--,a=null,i&&o?(u=c=!0,r=0):(r--,s=r>0?t[r-1]:-1,u=c=!1),e=!0)),s++;e&&this.diff_cleanupMerge(n)};P.prototype.diff_cleanupMerge=function(n){n.push(new P.Diff(K,""));for(var e=0,t=0,r=0,a="",s="",i;e<n.length;)switch(n[e][0]){case ce:r++,s+=n[e][1],e++;break;case oe:t++,a+=n[e][1],e++;break;case K:t+r>1?(t!==0&&r!==0&&(i=this.diff_commonPrefix(s,a),i!==0&&(e-t-r>0&&n[e-t-r-1][0]==K?n[e-t-r-1][1]+=s.substring(0,i):(n.splice(0,0,new P.Diff(K,s.substring(0,i))),e++),s=s.substring(i),a=a.substring(i)),i=this.diff_commonSuffix(s,a),i!==0&&(n[e][1]=s.substring(s.length-i)+n[e][1],s=s.substring(0,s.length-i),a=a.substring(0,a.length-i))),e-=t+r,n.splice(e,t+r),a.length&&(n.splice(e,0,new P.Diff(oe,a)),e++),s.length&&(n.splice(e,0,new P.Diff(ce,s)),e++),e++):e!==0&&n[e-1][0]==K?(n[e-1][1]+=n[e][1],n.splice(e,1)):e++,r=0,t=0,a="",s="";break}n[n.length-1][1]===""&&n.pop();var o=!1;for(e=1;e<n.length-1;)n[e-1][0]==K&&n[e+1][0]==K&&(n[e][1].substring(n[e][1].length-n[e-1][1].length)==n[e-1][1]?(n[e][1]=n[e-1][1]+n[e][1].substring(0,n[e][1].length-n[e-1][1].length),n[e+1][1]=n[e-1][1]+n[e+1][1],n.splice(e-1,1),o=!0):n[e][1].substring(0,n[e+1][1].length)==n[e+1][1]&&(n[e-1][1]+=n[e+1][1],n[e][1]=n[e][1].substring(n[e+1][1].length)+n[e+1][1],n.splice(e+1,1),o=!0)),e++;o&&this.diff_cleanupMerge(n)};P.prototype.diff_xIndex=function(n,e){var t=0,r=0,a=0,s=0,i;for(i=0;i<n.length&&(n[i][0]!==ce&&(t+=n[i][1].length),n[i][0]!==oe&&(r+=n[i][1].length),!(t>e));i++)a=t,s=r;return n.length!=i&&n[i][0]===oe?s:s+(e-a)};P.prototype.diff_prettyHtml=function(n){for(var e=[],t=/&/g,r=/</g,a=/>/g,s=/\n/g,i=0;i<n.length;i++){var o=n[i][0],u=n[i][1],c=u.replace(t,"&amp;").replace(r,"&lt;").replace(a,"&gt;").replace(s,"&para;<br>");switch(o){case ce:e[i]='<ins style="background:#e6ffe6;">'+c+"</ins>";break;case oe:e[i]='<del style="background:#ffe6e6;">'+c+"</del>";break;case K:e[i]="<span>"+c+"</span>";break}}return e.join("")};P.prototype.diff_text1=function(n){for(var e=[],t=0;t<n.length;t++)n[t][0]!==ce&&(e[t]=n[t][1]);return e.join("")};P.prototype.diff_text2=function(n){for(var e=[],t=0;t<n.length;t++)n[t][0]!==oe&&(e[t]=n[t][1]);return e.join("")};P.prototype.diff_levenshtein=function(n){for(var e=0,t=0,r=0,a=0;a<n.length;a++){var s=n[a][0],i=n[a][1];switch(s){case ce:t+=i.length;break;case oe:r+=i.length;break;case K:e+=Math.max(t,r),t=0,r=0;break}}return e+=Math.max(t,r),e};P.prototype.diff_toDelta=function(n){for(var e=[],t=0;t<n.length;t++)switch(n[t][0]){case ce:e[t]="+"+encodeURI(n[t][1]);break;case oe:e[t]="-"+n[t][1].length;break;case K:e[t]="="+n[t][1].length;break}return e.join("	").replace(/%20/g," ")};P.prototype.diff_fromDelta=function(n,e){for(var t=[],r=0,a=0,s=e.split(/\t/g),i=0;i<s.length;i++){var o=s[i].substring(1);switch(s[i].charAt(0)){case"+":try{t[r++]=new P.Diff(ce,decodeURI(o))}catch(l){throw new Error("Illegal escape in diff_fromDelta: "+o)}break;case"-":case"=":var u=parseInt(o,10);if(isNaN(u)||u<0)throw new Error("Invalid number in diff_fromDelta: "+o);var c=n.substring(a,a+=u);s[i].charAt(0)=="="?t[r++]=new P.Diff(K,c):t[r++]=new P.Diff(oe,c);break;default:if(s[i])throw new Error("Invalid diff operation in diff_fromDelta: "+s[i])}}if(a!=n.length)throw new Error("Delta length ("+a+") does not equal source text length ("+n.length+").");return t};P.prototype.match_main=function(n,e,t){if(n==null||e==null||t==null)throw new Error("Null input. (match_main)");return t=Math.max(0,Math.min(t,n.length)),n==e?0:n.length?n.substring(t,t+e.length)==e?t:this.match_bitap_(n,e,t):-1};P.prototype.match_bitap_=function(n,e,t){if(e.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var r=this.match_alphabet_(e),a=this;function s(I,_){var v=I/e.length,E=Math.abs(t-_);return a.Match_Distance?v+E/a.Match_Distance:E?1:v}var i=this.Match_Threshold,o=n.indexOf(e,t);o!=-1&&(i=Math.min(s(0,o),i),o=n.lastIndexOf(e,t+e.length),o!=-1&&(i=Math.min(s(0,o),i)));var u=1<<e.length-1;o=-1;for(var c,l,d=e.length+n.length,h,f=0;f<e.length;f++){for(c=0,l=d;c<l;)s(f,t+l)<=i?c=l:d=l,l=Math.floor((d-c)/2+c);d=l;var p=Math.max(1,t-l+1),g=Math.min(t+l,n.length)+e.length,y=Array(g+2);y[g+1]=(1<<f)-1;for(var m=g;m>=p;m--){var b=r[n.charAt(m-1)];if(f===0?y[m]=(y[m+1]<<1|1)&b:y[m]=(y[m+1]<<1|1)&b|((h[m+1]|h[m])<<1|1)|h[m+1],y[m]&u){var A=s(f,m-1);if(A<=i)if(i=A,o=m-1,o>t)p=Math.max(1,2*t-o);else break}}if(s(f+1,t)>i)break;h=y}return o};P.prototype.match_alphabet_=function(n){for(var e={},t=0;t<n.length;t++)e[n.charAt(t)]=0;for(var t=0;t<n.length;t++)e[n.charAt(t)]|=1<<n.length-t-1;return e};P.prototype.patch_addContext_=function(n,e){if(e.length!=0){if(n.start2===null)throw Error("patch not initialized");for(var t=e.substring(n.start2,n.start2+n.length1),r=0;e.indexOf(t)!=e.lastIndexOf(t)&&t.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)r+=this.Patch_Margin,t=e.substring(n.start2-r,n.start2+n.length1+r);r+=this.Patch_Margin;var a=e.substring(n.start2-r,n.start2);a&&n.diffs.unshift(new P.Diff(K,a));var s=e.substring(n.start2+n.length1,n.start2+n.length1+r);s&&n.diffs.push(new P.Diff(K,s)),n.start1-=a.length,n.start2-=a.length,n.length1+=a.length+s.length,n.length2+=a.length+s.length}};P.prototype.patch_make=function(n,e,t){var r,a;if(typeof n=="string"&&typeof e=="string"&&typeof t=="undefined")r=n,a=this.diff_main(r,e,!0),a.length>2&&(this.diff_cleanupSemantic(a),this.diff_cleanupEfficiency(a));else if(n&&typeof n=="object"&&typeof e=="undefined"&&typeof t=="undefined")a=n,r=this.diff_text1(a);else if(typeof n=="string"&&e&&typeof e=="object"&&typeof t=="undefined")r=n,a=e;else if(typeof n=="string"&&typeof e=="string"&&t&&typeof t=="object")r=n,a=t;else throw new Error("Unknown call format to patch_make.");if(a.length===0)return[];for(var s=[],i=new P.patch_obj,o=0,u=0,c=0,l=r,d=r,h=0;h<a.length;h++){var f=a[h][0],p=a[h][1];switch(!o&&f!==K&&(i.start1=u,i.start2=c),f){case ce:i.diffs[o++]=a[h],i.length2+=p.length,d=d.substring(0,c)+p+d.substring(c);break;case oe:i.length1+=p.length,i.diffs[o++]=a[h],d=d.substring(0,c)+d.substring(c+p.length);break;case K:p.length<=2*this.Patch_Margin&&o&&a.length!=h+1?(i.diffs[o++]=a[h],i.length1+=p.length,i.length2+=p.length):p.length>=2*this.Patch_Margin&&o&&(this.patch_addContext_(i,l),s.push(i),i=new P.patch_obj,o=0,l=d,u=c);break}f!==ce&&(u+=p.length),f!==oe&&(c+=p.length)}return o&&(this.patch_addContext_(i,l),s.push(i)),s};P.prototype.patch_deepCopy=function(n){for(var e=[],t=0;t<n.length;t++){var r=n[t],a=new P.patch_obj;a.diffs=[];for(var s=0;s<r.diffs.length;s++)a.diffs[s]=new P.Diff(r.diffs[s][0],r.diffs[s][1]);a.start1=r.start1,a.start2=r.start2,a.length1=r.length1,a.length2=r.length2,e[t]=a}return e};P.prototype.patch_apply=function(n,e){if(n.length==0)return[e,[]];n=this.patch_deepCopy(n);var t=this.patch_addPadding(n);e=t+e+t,this.patch_splitMax(n);for(var r=0,a=[],s=0;s<n.length;s++){var i=n[s].start2+r,o=this.diff_text1(n[s].diffs),u,c=-1;if(o.length>this.Match_MaxBits?(u=this.match_main(e,o.substring(0,this.Match_MaxBits),i),u!=-1&&(c=this.match_main(e,o.substring(o.length-this.Match_MaxBits),i+o.length-this.Match_MaxBits),(c==-1||u>=c)&&(u=-1))):u=this.match_main(e,o,i),u==-1)a[s]=!1,r-=n[s].length2-n[s].length1;else{a[s]=!0,r=u-i;var l;if(c==-1?l=e.substring(u,u+o.length):l=e.substring(u,c+this.Match_MaxBits),o==l)e=e.substring(0,u)+this.diff_text2(n[s].diffs)+e.substring(u+o.length);else{var d=this.diff_main(o,l,!1);if(o.length>this.Match_MaxBits&&this.diff_levenshtein(d)/o.length>this.Patch_DeleteThreshold)a[s]=!1;else{this.diff_cleanupSemanticLossless(d);for(var h=0,f,p=0;p<n[s].diffs.length;p++){var g=n[s].diffs[p];g[0]!==K&&(f=this.diff_xIndex(d,h)),g[0]===ce?e=e.substring(0,u+f)+g[1]+e.substring(u+f):g[0]===oe&&(e=e.substring(0,u+f)+e.substring(u+this.diff_xIndex(d,h+g[1].length))),g[0]!==oe&&(h+=g[1].length)}}}}}return e=e.substring(t.length,e.length-t.length),[e,a]};P.prototype.patch_addPadding=function(n){for(var e=this.Patch_Margin,t="",r=1;r<=e;r++)t+=String.fromCharCode(r);for(var r=0;r<n.length;r++)n[r].start1+=e,n[r].start2+=e;var a=n[0],s=a.diffs;if(s.length==0||s[0][0]!=K)s.unshift(new P.Diff(K,t)),a.start1-=e,a.start2-=e,a.length1+=e,a.length2+=e;else if(e>s[0][1].length){var i=e-s[0][1].length;s[0][1]=t.substring(s[0][1].length)+s[0][1],a.start1-=i,a.start2-=i,a.length1+=i,a.length2+=i}if(a=n[n.length-1],s=a.diffs,s.length==0||s[s.length-1][0]!=K)s.push(new P.Diff(K,t)),a.length1+=e,a.length2+=e;else if(e>s[s.length-1][1].length){var i=e-s[s.length-1][1].length;s[s.length-1][1]+=t.substring(0,i),a.length1+=i,a.length2+=i}return t};P.prototype.patch_splitMax=function(n){for(var e=this.Match_MaxBits,t=0;t<n.length;t++)if(!(n[t].length1<=e)){var r=n[t];n.splice(t--,1);for(var a=r.start1,s=r.start2,i="";r.diffs.length!==0;){var o=new P.patch_obj,u=!0;for(o.start1=a-i.length,o.start2=s-i.length,i!==""&&(o.length1=o.length2=i.length,o.diffs.push(new P.Diff(K,i)));r.diffs.length!==0&&o.length1<e-this.Patch_Margin;){var c=r.diffs[0][0],l=r.diffs[0][1];c===ce?(o.length2+=l.length,s+=l.length,o.diffs.push(r.diffs.shift()),u=!1):c===oe&&o.diffs.length==1&&o.diffs[0][0]==K&&l.length>2*e?(o.length1+=l.length,a+=l.length,u=!1,o.diffs.push(new P.Diff(c,l)),r.diffs.shift()):(l=l.substring(0,e-o.length1-this.Patch_Margin),o.length1+=l.length,a+=l.length,c===K?(o.length2+=l.length,s+=l.length):u=!1,o.diffs.push(new P.Diff(c,l)),l==r.diffs[0][1]?r.diffs.shift():r.diffs[0][1]=r.diffs[0][1].substring(l.length))}i=this.diff_text2(o.diffs),i=i.substring(i.length-this.Patch_Margin);var d=this.diff_text1(r.diffs).substring(0,this.Patch_Margin);d!==""&&(o.length1+=d.length,o.length2+=d.length,o.diffs.length!==0&&o.diffs[o.diffs.length-1][0]===K?o.diffs[o.diffs.length-1][1]+=d:o.diffs.push(new P.Diff(K,d))),u||n.splice(++t,0,o)}}};P.prototype.patch_toText=function(n){for(var e=[],t=0;t<n.length;t++)e[t]=n[t];return e.join("")};P.prototype.patch_fromText=function(n){var e=[];if(!n)return e;for(var t=n.split(`
`),r=0,a=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;r<t.length;){var s=t[r].match(a);if(!s)throw new Error("Invalid patch string: "+t[r]);var i=new P.patch_obj;for(e.push(i),i.start1=parseInt(s[1],10),s[2]===""?(i.start1--,i.length1=1):s[2]=="0"?i.length1=0:(i.start1--,i.length1=parseInt(s[2],10)),i.start2=parseInt(s[3],10),s[4]===""?(i.start2--,i.length2=1):s[4]=="0"?i.length2=0:(i.start2--,i.length2=parseInt(s[4],10)),r++;r<t.length;){var o=t[r].charAt(0);try{var u=decodeURI(t[r].substring(1))}catch(c){throw new Error("Illegal escape in patch_fromText: "+u)}if(o=="-")i.diffs.push(new P.Diff(oe,u));else if(o=="+")i.diffs.push(new P.Diff(ce,u));else if(o==" ")i.diffs.push(new P.Diff(K,u));else{if(o=="@")break;if(o!=="")throw new Error('Invalid patch mode "'+o+'" in: '+u)}r++}}return e};P.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0};P.patch_obj.prototype.toString=function(){var n,e;this.length1===0?n=this.start1+",0":this.length1==1?n=this.start1+1:n=this.start1+1+","+this.length1,this.length2===0?e=this.start2+",0":this.length2==1?e=this.start2+1:e=this.start2+1+","+this.length2;for(var t=["@@ -"+n+" +"+e+` @@
`],r,a=0;a<this.diffs.length;a++){switch(this.diffs[a][0]){case ce:r="+";break;case oe:r="-";break;case K:r=" ";break}t[a+1]=r+encodeURI(this.diffs[a][1])+`
`}return t.join("").replace(/%20/g," ")};ls.exports=P;ls.exports.diff_match_patch=P;ls.exports.DIFF_DELETE=oe;ls.exports.DIFF_INSERT=ce;ls.exports.DIFF_EQUAL=K});var Px={};vd(Px,{default:()=>xu});module.exports=By(Px);var ds=require("obsidian");var ut=require("obsidian");var Ed=`
You are an advanced language model that performs text transformations based on specific instructions. Your task is to process input text to produce the desired output based on a given transformation type. You can handle tasks like adding emojis, making text longer or shorter, and converting text into tables, among many others. Use **Obsidian-flavored markdown** in all your transformations when applicable. Follow the examples provided to guide your responses. 

It is **very important** that you follow the examples. Do not add anything at the start of the output like "Output:" or "Here's a rephrased version of the input text:" or anything similar. Just provide the transformed text.

**Examples:**

---

**Task:** Add Emojis.  
**Prompt:** Add relevant emojis to make the text more engaging.  

**Input:**  
"Let's celebrate the success of our project."  

**Output:**  
"\u{1F389} Let's celebrate the success of our project! \u{1F680}\u{1F44F}"  

---

**Task:** Convert to Table.  
**Prompt:** Convert the text into an Obsidian table format.  

**Input:**  
"Name: John, Age: 30, Profession: Engineer"  

**Output:**  
| Name  | Age | Profession   |
|-------|-----|-------------|
| John  | 30  | Engineer|

---
`,Od=`
You are an advanced language model specialized in following specific instructions to create and process markdown documents. Always use **Obsidian-flavored Markdown** syntax in your responses whenever applicable.

## Examples:

**Prompt:** Create a note titled "Daily Goals" with a list of tasks.  
**Output:**  
# Daily Goals  
- [ ] Task 1: Complete the project proposal  
- [ ] Task 2: Attend team meeting  
- [ ] Task 3: Review budget plan  

---

**Prompt:** Generate a note about "Meeting Notes" with a table summarizing the key points.  
**Output:**  
# Meeting Notes  

| Topic          | Discussion Summary           | Action Items           |  
|-----------------|------------------------------|------------------------|  
| Project Update | Discussed project milestones | Update Gantt chart     |  
| Budget Review  | Reviewed proposed budget     | Finalize budget draft  |  

---

**Prompt:** Create a note titled "Books to Read" with headings for different genres and a list of book titles under each genre.  
**Output:**  
# Books to Read  

## Fiction  
- *Dune* by Frank Herbert  
- *1984* by George Orwell  

## Non-Fiction  
- *Sapiens* by Yuval Noah Harari  
- *Educated* by Tara Westover  

## Science  
- *A Brief History of Time* by Stephen Hawking  
- *The Selfish Gene* by Richard Dawkins  

---

Follow this structure and style for all responses, adapting to the specific **Prompt** provided.`;var Tu={provider:"ollama",model:"llama3.2",apiKey:"",customURL:"",selectionPrompt:Ed,cursorPrompt:Od,customCommands:[],commandPrefix:"/"},Ei=class extends ut.PluginSettingTab{constructor(t,r){super(t,r);ne(this,"plugin");this.plugin=r}async saveSettings(){await this.plugin.saveSettings(),this.plugin.chatapi.updateSettings(this.plugin.settings)}display(){let{containerEl:t}=this;t.empty(),new ut.Setting(t).setName("Provider").setDesc("Choose between OpenAI, Ollama, or a custom OpenAI-compatible endpoint.").addDropdown(r=>r.addOption("openai","OpenAI").addOption("ollama","Ollama").addOption("custom","Custom/OpenAI-compatible").setValue(this.plugin.settings.provider).onChange(async a=>{this.plugin.settings.provider=a,await this.saveSettings(),this.display()})),new ut.Setting(t).setName("Model").setDesc("Specify the model to use.").addText(r=>{r.setPlaceholder("e.g., gpt-4o-mini").setValue(this.plugin.settings.model).inputEl.addEventListener("blur",async()=>{this.plugin.settings.model=r.getValue(),await this.saveSettings()})}),(this.plugin.settings.provider==="openai"||this.plugin.settings.provider==="custom")&&new ut.Setting(t).setName("API key").setDesc("Enter your API key.").addText(r=>{r.setPlaceholder("sk-...").setValue(this.plugin.settings.apiKey||"").inputEl.addEventListener("blur",async()=>{this.plugin.settings.apiKey=r.getValue(),await this.saveSettings()})}),this.plugin.settings.provider==="custom"&&new ut.Setting(t).setName("Custom endpoint").setDesc("Enter your OpenAI-compatible base URL (e.g. https://api.groq.com/openai/v1).").addText(r=>{r.setPlaceholder("https://api.mycustomhost.com/v1").setValue(this.plugin.settings.customURL||"").inputEl.addEventListener("blur",async()=>{this.plugin.settings.customURL=r.getValue(),await this.saveSettings()})}),new ut.Setting(t).setName("Advanced").setHeading(),new ut.Setting(t).setName("Selection prompt").setDesc("System Prompt used when the tooltip is triggered with selected text.").addTextArea(r=>{r.setPlaceholder("e.g., Summarize the selected text.").setValue(this.plugin.settings.selectionPrompt).inputEl.addEventListener("blur",async()=>{this.plugin.settings.selectionPrompt=r.getValue(),await this.saveSettings()}),r.inputEl.classList.add("wide-text-settings")}),new ut.Setting(t).setName("Cursor prompt").setDesc("System Prompt used when the tooltip is triggered with selected text.").addTextArea(r=>{r.setPlaceholder("e.g., Generate text based on cursor position.").setValue(this.plugin.settings.cursorPrompt).inputEl.addEventListener("blur",async()=>{this.plugin.settings.cursorPrompt=r.getValue(),await this.saveSettings()}),r.inputEl.classList.add("wide-text-settings")}),t.createEl("h3",{text:"Custom Commands"}),t.createEl("p",{text:"Add your own custom commands. Triggered with the prefix defined in the Command Prefix setting."}),new ut.Setting(t).setName("Command Prefix").setDesc("The prefix used to trigger custom commands (e.g., /, !, #)").addText(r=>{r.setPlaceholder("/").setValue(this.plugin.settings.commandPrefix).inputEl.addEventListener("blur",async()=>{this.plugin.settings.commandPrefix=r.getValue().charAt(0),await this.saveSettings(),this.display()})}),this.plugin.settings.customCommands.forEach((r,a)=>{new ut.Setting(t).setName(`Command: ${r.keyword}`).setDesc("Edit the command prompt.").addText(s=>{s.setValue(r.keyword).setPlaceholder("Command name").inputEl.addEventListener("blur",async()=>{this.plugin.settings.customCommands[a].keyword=s.getValue(),await this.saveSettings()})}).addTextArea(s=>{s.setValue(r.prompt).setPlaceholder("Command prompt").inputEl.addEventListener("blur",async()=>{this.plugin.settings.customCommands[a].prompt=s.getValue(),await this.saveSettings()})}).addExtraButton(s=>s.setIcon("trash").setTooltip("Delete this command").onClick(async()=>{this.plugin.settings.customCommands.splice(a,1),await this.saveSettings(),this.display()}))}),new ut.Setting(t).addButton(r=>r.setButtonText("Add Command").setCta().onClick(async()=>{this.plugin.settings.customCommands.push({keyword:"new_command",prompt:""}),await this.saveSettings(),this.display()}))}};var Cr=require("@codemirror/state"),We=require("@codemirror/view"),ws=require("obsidian");var bs=require("@codemirror/state"),ta=require("@codemirror/view"),Id=require("@codemirror/view");var Oi=bs.StateEffect.define(),cr=bs.StateField.define({create(){return null},update(n,e){let t=e.effects.find(r=>r.is(Oi));return t?t.value:e.effects.some(r=>r.is(kt))?null:n}}),xd=ta.Decoration.mark({class:"cm-selectionBackground"}),Pd=bs.StateField.define({create(n){let e=n.field(cr);return e?ta.Decoration.set([xd.range(e.from,e.to)]):ta.Decoration.none},update(n,e){let t=e.state.field(cr);return t?ta.Decoration.set([xd.range(t.from,t.to)]):ta.Decoration.none},provide:n=>Id.EditorView.decorations.from(n)});var Td=require("@codemirror/autocomplete"),_s=require("@codemirror/view");function qy(n={prefix:"/",customCommands:[]}){let{prefix:e,customCommands:t}=n;return r=>{let a=r.matchBefore(new RegExp(`^\\${e}\\w*`));return!a||a.from==a.to&&!r.explicit?null:{from:a.from+1,options:t.map(s=>({label:s.keyword,type:void 0,detail:s.prompt}))}}}function Sd(n={prefix:"/",customCommands:[]}){return(0,Td.autocompletion)({override:[qy(n)]})}var Vy=_s.Decoration.mark({class:"cm-slashCommand"});function kd({prefix:n,customCommands:e}){return _s.ViewPlugin.fromClass(class{constructor(t){ne(this,"decorations");this.decorations=this.buildDecorations(t)}update(t){(t.docChanged||t.viewportChanged)&&(this.decorations=this.buildDecorations(t.view))}buildDecorations(t){let r=e.map(i=>i.keyword).join("|"),a=new RegExp(`\\${n}(${r})\\b`,"g"),s=t.visibleRanges.flatMap(({from:i,to:o})=>[...t.state.doc.sliceString(i,o).matchAll(a)].map(c=>c.index!==void 0?Vy.range(i+c.index,i+c.index+1+c[1].length):null).filter(c=>c!==null));return _s.Decoration.set(s)}},{decorations:t=>t.decorations})}var ku=Cr.StateEffect.define(),kt=Cr.StateEffect.define(),vs=Cr.StateEffect.define(),Su=class extends We.WidgetType{constructor(t,r,a){super();ne(this,"chatApiManager");ne(this,"selectionInfo");ne(this,"plugin");ne(this,"outerEditorView",null);ne(this,"dom");ne(this,"innerDom");ne(this,"textFieldView");ne(this,"submitButton");ne(this,"loaderElement");ne(this,"acceptButton");ne(this,"discardButton");this.chatApiManager=t,this.selectionInfo=r,this.plugin=a,this.dom=createEl("div",{cls:"cm-cursor-overlay",attr:{style:"user-select: none;"}}),this.innerDom=this.dom.createEl("div",{cls:"cm-cursor-overlay-inner"})}toDOM(t){this.outerEditorView=t,this.createPencilIcon(),this.createInputField(),this.createSubmitButton(),this.createLoader(),setTimeout(()=>{var s;(s=this.textFieldView)==null||s.focus()},0);let r=s=>{this.dom.contains(s.target)||this.dismissTooltip()},a=s=>{s.key==="Escape"&&this.dismissTooltip()};return document.addEventListener("mousedown",r),document.addEventListener("keydown",a),this.dom.addEventListener("destroy",()=>{document.removeEventListener("mousedown",r),document.removeEventListener("keydown",a)}),this.dom}destroy(){var t;(t=this.textFieldView)==null||t.destroy(),this.innerDom.empty(),this.submitButton.remove(),this.loaderElement.remove(),this.acceptButton&&this.acceptButton.remove(),this.discardButton&&this.discardButton.remove(),this.textFieldView=void 0,this.outerEditorView=null}dismissTooltip(){this.outerEditorView&&this.outerEditorView.dispatch({effects:kt.of(null)})}createPencilIcon(){if(!this.innerDom.querySelector(".cm-pencil-icon")){let t=this.innerDom.createEl("div",{cls:"cm-pencil-icon"});(0,ws.setIcon)(t,"pencil")}}createInputField(){let t=this.innerDom.createEl("div",{cls:"cm-tooltip-editor",attr:{style:"user-select: text;"}});this.textFieldView=new We.EditorView({state:Cr.EditorState.create({doc:"",extensions:[(0,We.placeholder)("Ask copilot"),We.keymap.of([{key:"Enter",run:()=>(this.submitAction(),!0),preventDefault:!0}]),Sd({prefix:this.plugin.settings.commandPrefix,customCommands:this.plugin.settings.customCommands}),kd({prefix:this.plugin.settings.commandPrefix,customCommands:this.plugin.settings.customCommands})]}),parent:t})}createSubmitButton(){this.submitButton=this.innerDom.createEl("button",{cls:"submit-button tooltip-button",text:"Submit"}),(0,ws.setIcon)(this.submitButton,"send-horizontal"),this.submitButton.onclick=()=>{this.submitAction()}}createLoader(){this.loaderElement=this.innerDom.createEl("div",{cls:"loader"}),this.toggleLoading(!1)}submitAction(){var a,s,i,o;let t=(s=(a=this.textFieldView)==null?void 0:a.state.doc.toString())!=null?s:"";if(!t.trim()){console.warn("Empty input. Submission aborted.");return}let r=(o=(i=this.selectionInfo)==null?void 0:i.text)!=null?o:"";this.toggleLoading(!0),this.chatApiManager.callSelection(t,r).then(u=>{this.showActionButtons()}).catch(u=>{console.error("Error calling AI:",u)}).finally(()=>{this.toggleLoading(!1)})}toggleLoading(t){t?(this.submitButton.classList.add("hidden"),this.loaderElement.classList.remove("hidden")):(this.submitButton.classList.remove("hidden"),this.loaderElement.classList.add("hidden"))}showActionButtons(){this.submitButton.classList.add("hidden"),this.createAcceptButton(),this.createDiscardButton()}createAcceptButton(){this.acceptButton||(this.acceptButton=this.innerDom.createEl("button",{cls:"accept-button tooltip-button primary-action",text:"Accept"}),(0,ws.setIcon)(this.acceptButton,"check"),this.acceptButton.onclick=()=>{this.acceptAction()},this.innerDom.appendChild(this.acceptButton))}createDiscardButton(){this.discardButton||(this.discardButton=this.innerDom.createEl("button",{cls:"discard-button tooltip-button",text:"Discard"}),(0,ws.setIcon)(this.discardButton,"cross"),this.discardButton.onclick=()=>{this.discardAction()},this.innerDom.appendChild(this.discardButton))}acceptAction(){this.outerEditorView&&this.outerEditorView.dispatch({effects:vs.of(null)}),this.dismissTooltip()}discardAction(){this.dismissTooltip()}};function Hy(n,e,t){var i,o;let r=(i=n.selection.ranges.find(u=>!u.empty))!=null?i:n.selection.main,a=(o=n.field(cr,!1))!=null?o:null,s=We.Decoration.widget({widget:new Su(e,a,t),above:!0,inline:!0,side:-9999}).range(r.from);return We.Decoration.set([s])}function Zy(n,e){return Cr.StateField.define({create(t){return We.Decoration.none},update(t,r){return r.effects.some(a=>a.is(ku))?Hy(r.state,n,e):r.effects.some(a=>a.is(kt))?We.Decoration.none:t},provide:t=>We.EditorView.decorations.from(t)})}function Cd(n,e){return[Zy(n,e)]}var xi="RFC3986",Ii={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:n=>String(n)},Rd="RFC1738";var Gy=Array.isArray,Ht=(()=>{let n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})();var Cu=1024,Nd=(n,e,t,r,a)=>{if(n.length===0)return n;let s=n;if(typeof n=="symbol"?s=Symbol.prototype.toString.call(n):typeof n!="string"&&(s=String(n)),t==="iso-8859-1")return escape(s).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<s.length;o+=Cu){let u=s.length>=Cu?s.slice(o,o+Cu):s,c=[];for(let l=0;l<u.length;++l){let d=u.charCodeAt(l);if(d===45||d===46||d===95||d===126||d>=48&&d<=57||d>=65&&d<=90||d>=97&&d<=122||a===Rd&&(d===40||d===41)){c[c.length]=u.charAt(l);continue}if(d<128){c[c.length]=Ht[d];continue}if(d<2048){c[c.length]=Ht[192|d>>6]+Ht[128|d&63];continue}if(d<55296||d>=57344){c[c.length]=Ht[224|d>>12]+Ht[128|d>>6&63]+Ht[128|d&63];continue}l+=1,d=65536+((d&1023)<<10|u.charCodeAt(l)&1023),c[c.length]=Ht[240|d>>18]+Ht[128|d>>12&63]+Ht[128|d>>6&63]+Ht[128|d&63]}i+=c.join("")}return i};function $d(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function Ru(n,e){if(Gy(n)){let t=[];for(let r=0;r<n.length;r+=1)t.push(e(n[r]));return t}return e(n)}var Ky=Object.prototype.hasOwnProperty,jd={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},Zt=Array.isArray,Jy=Array.prototype.push,Ld=function(n,e){Jy.apply(n,Zt(e)?e:[e])},Wy=Date.prototype.toISOString,Ae={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:Nd,encodeValuesOnly:!1,format:xi,formatter:Ii[xi],indices:!1,serializeDate(n){return Wy.call(n)},skipNulls:!1,strictNullHandling:!1};function Xy(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}var Nu={};function Dd(n,e,t,r,a,s,i,o,u,c,l,d,h,f,p,g,y,m){let b=n,A=m,I=0,_=!1;for(;(A=A.get(Nu))!==void 0&&!_;){let L=A.get(n);if(I+=1,typeof L!="undefined"){if(L===I)throw new RangeError("Cyclic object value");_=!0}typeof A.get(Nu)=="undefined"&&(I=0)}if(typeof c=="function"?b=c(e,b):b instanceof Date?b=h==null?void 0:h(b):t==="comma"&&Zt(b)&&(b=Ru(b,function(L){return L instanceof Date?h==null?void 0:h(L):L})),b===null){if(s)return u&&!g?u(e,Ae.encoder,y,"key",f):e;b=""}if(Xy(b)||$d(b)){if(u){let L=g?e:u(e,Ae.encoder,y,"key",f);return[(p==null?void 0:p(L))+"="+(p==null?void 0:p(u(b,Ae.encoder,y,"value",f)))]}return[(p==null?void 0:p(e))+"="+(p==null?void 0:p(String(b)))]}let v=[];if(typeof b=="undefined")return v;let E;if(t==="comma"&&Zt(b))g&&u&&(b=Ru(b,u)),E=[{value:b.length>0?b.join(",")||null:void 0}];else if(Zt(c))E=c;else{let L=Object.keys(b);E=l?L.sort(l):L}let O=o?String(e).replace(/\./g,"%2E"):String(e),S=r&&Zt(b)&&b.length===1?O+"[]":O;if(a&&Zt(b)&&b.length===0)return S+"[]";for(let L=0;L<E.length;++L){let q=E[L],V=typeof q=="object"&&typeof q.value!="undefined"?q.value:b[q];if(i&&V===null)continue;let de=d&&o?q.replace(/\./g,"%2E"):q,Ie=Zt(b)?typeof t=="function"?t(S,de):S:S+(d?"."+de:"["+de+"]");m.set(n,I);let ve=new WeakMap;ve.set(Nu,m),Ld(v,Dd(V,Ie,t,r,a,s,i,o,t==="comma"&&g&&Zt(b)?null:u,c,l,d,h,f,p,g,y,ve))}return v}function Yy(n=Ae){if(typeof n.allowEmptyArrays!="undefined"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys!="undefined"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder!="undefined"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");let e=n.charset||Ae.charset;if(typeof n.charset!="undefined"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=xi;if(typeof n.format!="undefined"){if(!Ky.call(Ii,n.format))throw new TypeError("Unknown format option provided.");t=n.format}let r=Ii[t],a=Ae.filter;(typeof n.filter=="function"||Zt(n.filter))&&(a=n.filter);let s;if(n.arrayFormat&&n.arrayFormat in jd?s=n.arrayFormat:"indices"in n?s=n.indices?"indices":"repeat":s=Ae.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");let i=typeof n.allowDots=="undefined"?n.encodeDotInKeys?!0:Ae.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:Ae.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:Ae.allowEmptyArrays,arrayFormat:s,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:Ae.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter=="undefined"?Ae.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:Ae.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:Ae.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:Ae.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:Ae.encodeValuesOnly,filter:a,format:t,formatter:r,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:Ae.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:Ae.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:Ae.strictNullHandling}}function $u(n,e={}){let t=n,r=Yy(e),a,s;typeof r.filter=="function"?(s=r.filter,t=s("",t)):Zt(r.filter)&&(s=r.filter,a=s);let i=[];if(typeof t!="object"||t===null)return"";let o=jd[r.arrayFormat],u=o==="comma"&&r.commaRoundTrip;a||(a=Object.keys(t)),r.sort&&a.sort(r.sort);let c=new WeakMap;for(let h=0;h<a.length;++h){let f=a[h];r.skipNulls&&t[f]===null||Ld(i,Dd(t[f],f,o,u,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}let l=i.join(r.delimiter),d=r.addQueryPrefix===!0?"?":"";return r.charsetSentinel&&(r.charset==="iso-8859-1"?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),l.length>0?d+l:""}var en="4.77.3";var Md=!1,tn,ju,eb,tb,rb,Lu,nb,Pi,Du,Mu,Fu,Ti,Uu;function Fd(n,e={auto:!1}){if(Md)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(tn)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${tn}'\``);Md=e.auto,tn=n.kind,ju=n.fetch,eb=n.Request,tb=n.Response,rb=n.Headers,Lu=n.FormData,nb=n.Blob,Pi=n.File,Du=n.ReadableStream,Mu=n.getMultipartRequestOptions,Fu=n.getDefaultAgent,Ti=n.fileFromPath,Uu=n.isFsReadStream}var Si=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function Ud({manuallyImported:n}={}){let e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n",t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData!="undefined"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob!="undefined"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File!="undefined"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream!="undefined"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new Si(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}tn||Fd(Ud(),{auto:!0});var z=class extends Error{},_e=class n extends z{constructor(e,t,r,a){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.request_id=a==null?void 0:a["x-request-id"],this.error=t;let s=t;this.code=s==null?void 0:s.code,this.param=s==null?void 0:s.param,this.type=s==null?void 0:s.type}static makeMessage(e,t,r){let a=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e||!a)return new lr({message:r,cause:ki(t)});let s=t==null?void 0:t.error;return e===400?new ra(e,s,r,a):e===401?new na(e,s,r,a):e===403?new aa(e,s,r,a):e===404?new sa(e,s,r,a):e===409?new ia(e,s,r,a):e===422?new oa(e,s,r,a):e===429?new ua(e,s,r,a):e>=500?new ca(e,s,r,a):new n(e,s,r,a)}},ge=class extends _e{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}},lr=class extends _e{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}},Ct=class extends lr{constructor({message:e}={}){super({message:e!=null?e:"Request timed out."})}},ra=class extends _e{},na=class extends _e{},aa=class extends _e{},sa=class extends _e{},ia=class extends _e{},oa=class extends _e{},ua=class extends _e{},ca=class extends _e{},la=class extends z{constructor(){super("Could not parse response content as the length limit was reached")}},da=class extends z{constructor(){super("Could not parse response content as the request was rejected by the content filter")}};var rn=class n{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let r=n.NEWLINE_CHARS.has(t[t.length-1]||""),a=t.split(n.NEWLINE_REGEXP);return r&&a.pop(),a.length===1&&!r?(this.buffer.push(a[0]),[]):(this.buffer.length>0&&(a=[this.buffer.join("")+a[0],...a.slice(1)],this.buffer=[]),r||(this.buffer=[a.pop()||""]),a)}decodeText(e){var t;if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer!="undefined"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new z(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder!="undefined"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return(t=this.textDecoder)!=null||(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new z(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new z("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};rn.NEWLINE_CHARS=new Set([`
`,"\r"]);rn.NEWLINE_REGEXP=/\r\n|[\n\r]/g;var Gt=class n{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let s=!1;try{for await(let i of ib(e,t))if(!s){if(i.data.startsWith("[DONE]")){s=!0;continue}if(i.event===null){let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(o&&o.error)throw new _e(void 0,o.error,void 0,void 0);yield o}else{let o;try{o=JSON.parse(i.data)}catch(u){throw console.error("Could not parse message into JSON:",i.data),console.error("From chunk:",i.raw),u}if(i.event=="error")throw new _e(void 0,o.error,o.message,void 0);yield{event:i.event,data:o}}}s=!0}catch(i){if(i instanceof Error&&i.name==="AbortError")return;throw i}finally{s||t.abort()}}return new n(a,t)}static fromReadableStream(e,t){let r=!1;async function*a(){let i=new rn,o=zd(e);for await(let u of o)for(let c of i.decode(u))yield c;for(let u of i.flush())yield u}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(let o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new n(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){let i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new n(()=>a(e),this.controller),new n(()=>a(t),this.controller)]}toReadableStream(){let e=this,t,r=new TextEncoder;return new Du({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{let{value:s,done:i}=await t.next();if(i)return a.close();let o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){var a;await((a=t.return)==null?void 0:a.call(t))}})}};async function*ib(n,e){if(!n.body)throw e.abort(),new z("Attempted to iterate over a response with no body");let t=new zu,r=new rn,a=zd(n.body);for await(let s of ob(a))for(let i of r.decode(s)){let o=t.decode(i);o&&(yield o)}for(let s of r.flush()){let i=t.decode(s);i&&(yield i)}}async function*ob(n){let e=new Uint8Array;for await(let t of n){if(t==null)continue;let r=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,a=new Uint8Array(e.length+r.length);a.set(e),a.set(r,e.length),e=a;let s;for(;(s=ub(e))!==-1;)yield e.slice(0,s),e=e.slice(s)}e.length>0&&(yield e)}function ub(n){for(let r=0;r<n.length-2;r++){if(n[r]===10&&n[r+1]===10||n[r]===13&&n[r+1]===13)return r+2;if(n[r]===13&&n[r+1]===10&&r+3<n.length&&n[r+2]===13&&n[r+3]===10)return r+4}return-1}var zu=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=cb(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}};function cb(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function zd(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var Bd=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",qd=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&As(n),As=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",lb=n=>qd(n)||Bd(n)||Uu(n);async function Vu(n,e,t){var a,s,i;if(n=await n,qd(n))return n;if(Bd(n)){let o=await n.blob();e||(e=(a=new URL(n.url).pathname.split(/[\\/]/).pop())!=null?a:"unknown_file");let u=As(o)?[await o.arrayBuffer()]:[o];return new Pi(u,e,t)}let r=await db(n);if(e||(e=(s=fb(n))!=null?s:"unknown_file"),!(t!=null&&t.type)){let o=(i=r[0])==null?void 0:i.type;typeof o=="string"&&(t={...t,type:o})}return new Pi(r,e,t)}async function db(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(As(n))e.push(await n.arrayBuffer());else if(pb(n))for await(let r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${hb(n)}`);return e}function hb(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function fb(n){var e;return Bu(n.name)||Bu(n.filename)||((e=Bu(n.path))==null?void 0:e.split(/[\\/]/).pop())}var Bu=n=>{if(typeof n=="string")return n;if(typeof Buffer!="undefined"&&n instanceof Buffer)return String(n)},pb=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Hu=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var mt=async n=>{let e=await Vd(n.body);return Mu(e,n)},Vd=async n=>{let e=new Lu;return await Promise.all(Object.entries(n||{}).map(([t,r])=>qu(e,t,r))),e};var qu=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(lb(t)){let r=await Vu(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>qu(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,a])=>qu(n,`${e}[${r}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var gb=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},yb=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ci;async function Jd(n){let{response:e}=n;if(n.options.stream)return ha("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):Gt.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;let t=e.headers.get("content-type");if((t==null?void 0:t.includes("application/json"))||(t==null?void 0:t.includes("application/vnd.api+json"))){let s=await e.json();return ha("response",e.status,e.url,e.headers,s),Wd(s,e)}let a=await e.text();return ha("response",e.status,e.url,e.headers,a),a}function Wd(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var Ni=class n extends Promise{constructor(e,t=Jd){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new n(this.responsePromise,async t=>Wd(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},$i=class{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=Zu("maxRetries",t),this.timeout=Zu("timeout",r),this.httpAgent=a,this.fetch=s!=null?s:ju}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Ab(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Ib()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async a=>{let s=a&&As(a==null?void 0:a.body)?new DataView(await a.body.arrayBuffer()):(a==null?void 0:a.body)instanceof DataView?a.body:(a==null?void 0:a.body)instanceof ArrayBuffer?new DataView(a.body):a&&ArrayBuffer.isView(a==null?void 0:a.body)?new DataView(a.body.buffer):a==null?void 0:a.body;return{method:e,path:t,...a,body:s}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer!="undefined")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder!="undefined")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){var g,y,m,b,A,I;let{method:r,path:a,query:s,headers:i={}}=e,o=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:Hu(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,u=this.calculateContentLength(o),c=this.buildURL(a,s);"timeout"in e&&Zu("timeout",e.timeout);let l=(g=e.timeout)!=null?g:this.timeout,d=(m=(y=e.httpAgent)!=null?y:this.httpAgent)!=null?m:Fu(c),h=l+1e3;typeof((b=d==null?void 0:d.options)==null?void 0:b.timeout)=="number"&&h>((A=d.options.timeout)!=null?A:0)&&(d.options.timeout=h),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);let f=this.buildHeaders({options:e,headers:i,contentLength:u,retryCount:t});return{req:{method:r,...o&&{body:o},headers:f,...d&&{agent:d},signal:(I=e.signal)!=null?I:null},url:c,timeout:l}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:a}){let s={};r&&(s["content-length"]=r);let i=this.defaultHeaders(e);return Gd(s,i),Gd(s,t),Hu(e.body)&&tn!=="node"&&delete s["content-type"],Kd(i,"x-stainless-retry-count")===void 0&&Kd(t,"x-stainless-retry-count")===void 0&&(s["x-stainless-retry-count"]=String(a)),this.validateHeaders(s,t),s}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return _e.generate(e,t,r,a)}request(e,t=null){return new Ni(this.makeRequest(e,t))}async makeRequest(e,t){var d,h,f;let r=await e,a=(d=r.maxRetries)!=null?d:this.maxRetries;t==null&&(t=a),await this.prepareOptions(r);let{req:s,url:i,timeout:o}=this.buildRequest(r,{retryCount:a-t});if(await this.prepareRequest(s,{url:i,options:r}),ha("request",i,r,s.headers),(h=r.signal)!=null&&h.aborted)throw new ge;let u=new AbortController,c=await this.fetchWithTimeout(i,s,o,u).catch(ki);if(c instanceof Error){if((f=r.signal)!=null&&f.aborted)throw new ge;if(t)return this.retryRequest(r,t);throw c.name==="AbortError"?new Ct:new lr({cause:c})}let l=bb(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){let A=`retrying, ${t} attempts remaining`;return ha(`response (error; ${A})`,c.status,i,l),this.retryRequest(r,t,l)}let p=await c.text().catch(A=>ki(A).message),g=Eb(p),y=g?void 0:p;throw ha(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,i,l,y),this.makeStatusError(c.status,g,y,l)}return{response:c,options:r,controller:u}}requestAPIList(e,t){let r=this.makeRequest(t,null);return new Gu(this,r,e)}buildURL(e,t){let r=xb(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return Xd(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r!="undefined").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new z(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){let{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());let o=setTimeout(()=>a.abort(),r),u={signal:a.signal,...i};return u.method&&(u.method=u.method.toUpperCase()),this.fetch.call(void 0,e,u).finally(()=>{clearTimeout(o)})}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){var o;let a,s=r==null?void 0:r["retry-after-ms"];if(s){let u=parseFloat(s);Number.isNaN(u)||(a=u)}let i=r==null?void 0:r["retry-after"];if(i&&!a){let u=parseFloat(i);Number.isNaN(u)?a=Date.parse(i)-Date.now():a=u*1e3}if(!(a&&0<=a&&a<60*1e3)){let u=(o=e.maxRetries)!=null?o:this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,u)}return await dr(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${en}`}},Es=class{constructor(e,t,r,a){Ci.set(this,void 0),gb(this,Ci,e,"f"),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new z("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await yb(this,Ci,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ci=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},Gu=class extends Ni{constructor(e,t,r){super(t,async a=>new r(e,a.response,await Jd(a),a.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},bb=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}}),_b={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ue=n=>typeof n=="object"&&n!==null&&!Xd(n)&&Object.keys(n).every(e=>Yd(_b,e)),wb=()=>{var e,t;if(typeof Deno!="undefined"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":en,"X-Stainless-OS":Zd(Deno.build.os),"X-Stainless-Arch":Hd(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:(t=(e=Deno.version)==null?void 0:e.deno)!=null?t:"unknown"};if(typeof EdgeRuntime!="undefined")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":en,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process!="undefined"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":en,"X-Stainless-OS":Zd(process.platform),"X-Stainless-Arch":Hd(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let n=vb();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":en,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":en,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function vb(){if(typeof navigator=="undefined"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}var Hd=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Zd=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),Ri,Ab=()=>Ri!=null?Ri:Ri=wb(),Eb=n=>{try{return JSON.parse(n)}catch(e){return}},Ob=/^[a-z][a-z0-9+.-]*:/i,xb=n=>Ob.test(n),dr=n=>new Promise(e=>setTimeout(e,n)),Zu=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new z(`${n} must be an integer`);if(e<0)throw new z(`${n} must be a positive integer`);return e},ki=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch(e){}return new Error(n)};var Os=n=>{var e,t,r,a,s,i;if(typeof process!="undefined")return(r=(t=(e=process.env)==null?void 0:e[n])==null?void 0:t.trim())!=null?r:void 0;if(typeof Deno!="undefined")return(i=(s=(a=Deno.env)==null?void 0:a.get)==null?void 0:s.call(a,n))==null?void 0:i.trim()};function Xd(n){if(!n)return!0;for(let e in n)return!1;return!0}function Yd(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Gd(n,e){for(let t in e){if(!Yd(e,t))continue;let r=t.toLowerCase();if(!r)continue;let a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}function ha(n,...e){var t;typeof process!="undefined"&&((t=process==null?void 0:process.env)==null?void 0:t.DEBUG)==="true"&&console.log(`OpenAI:DEBUG:${n}`,...e)}var Ib=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Qd=()=>typeof window!="undefined"&&typeof window.document!="undefined"&&typeof navigator!="undefined",Pb=n=>typeof(n==null?void 0:n.get)=="function";var Kd=(n,e)=>{var r;let t=e.toLowerCase();if(Pb(n)){let a=((r=e[0])==null?void 0:r.toUpperCase())+e.substring(1).replace(/([^\w])(\w)/g,(s,i,o)=>i+o.toUpperCase());for(let s of[e,t,e.toUpperCase(),a]){let i=n.get(s);if(i)return i}}for(let[a,s]of Object.entries(n))if(a.toLowerCase()===t)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${e} header, using the first entry.`),s[0]):s};function xs(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}var ji=class extends Es{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.object=r.object}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}nextPageParams(){return null}nextPageInfo(){return null}},he=class extends Es{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[]}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var r;let e=this.getPaginatedItems();if(!e.length)return null;let t=(r=e[e.length-1])==null?void 0:r.id;return t?{params:{after:t}}:null}};var $=class{constructor(e){this._client=e}};var fa=class extends ${create(e,t){var r;return this._client.post("/chat/completions",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}};var Rr=class extends ${constructor(){super(...arguments),this.completions=new fa(this._client)}};Rr.Completions=fa;var pa=class extends ${create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}};var ma=class extends ${create(e,t){return this._client.post("/audio/transcriptions",mt({body:e,...t}))}};var ga=class extends ${create(e,t){return this._client.post("/audio/translations",mt({body:e,...t}))}};var Kt=class extends ${constructor(){super(...arguments),this.transcriptions=new ma(this._client),this.translations=new ga(this._client),this.speech=new pa(this._client)}};Kt.Transcriptions=ma;Kt.Translations=ga;Kt.Speech=pa;var Nr=class extends ${create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/batches",an,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}},an=class extends he{};Nr.BatchesPage=an;var sn=class extends ${create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/assistants",ya,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}},ya=class extends he{};sn.AssistantsPage=ya;function Ku(n){return typeof n.parse=="function"}var $r=n=>(n==null?void 0:n.role)==="assistant",Ju=n=>(n==null?void 0:n.role)==="function",Wu=n=>(n==null?void 0:n.role)==="tool";var Rt=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},fe=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Xu,Li,Di,Is,Ps,Mi,Ts,hr,Ss,Fi,Ui,ba,eh,_a=class{constructor(){Xu.add(this),this.controller=new AbortController,Li.set(this,void 0),Di.set(this,()=>{}),Is.set(this,()=>{}),Ps.set(this,void 0),Mi.set(this,()=>{}),Ts.set(this,()=>{}),hr.set(this,{}),Ss.set(this,!1),Fi.set(this,!1),Ui.set(this,!1),ba.set(this,!1),Rt(this,Li,new Promise((e,t)=>{Rt(this,Di,e,"f"),Rt(this,Is,t,"f")}),"f"),Rt(this,Ps,new Promise((e,t)=>{Rt(this,Mi,e,"f"),Rt(this,Ts,t,"f")}),"f"),fe(this,Li,"f").catch(()=>{}),fe(this,Ps,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},fe(this,Xu,"m",eh).bind(this))},0)}_connected(){this.ended||(fe(this,Di,"f").call(this),this._emit("connect"))}get ended(){return fe(this,Ss,"f")}get errored(){return fe(this,Fi,"f")}get aborted(){return fe(this,Ui,"f")}abort(){this.controller.abort()}on(e,t){return(fe(this,hr,"f")[e]||(fe(this,hr,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=fe(this,hr,"f")[e];if(!r)return this;let a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(fe(this,hr,"f")[e]||(fe(this,hr,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{Rt(this,ba,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){Rt(this,ba,!0,"f"),await fe(this,Ps,"f")}_emit(e,...t){if(fe(this,Ss,"f"))return;e==="end"&&(Rt(this,Ss,!0,"f"),fe(this,Mi,"f").call(this));let r=fe(this,hr,"f")[e];if(r&&(fe(this,hr,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){let a=t[0];!fe(this,ba,"f")&&!(r!=null&&r.length)&&Promise.reject(a),fe(this,Is,"f").call(this,a),fe(this,Ts,"f").call(this,a),this._emit("end");return}if(e==="error"){let a=t[0];!fe(this,ba,"f")&&!(r!=null&&r.length)&&Promise.reject(a),fe(this,Is,"f").call(this,a),fe(this,Ts,"f").call(this,a),this._emit("end")}}_emitFinal(){}};Li=new WeakMap,Di=new WeakMap,Is=new WeakMap,Ps=new WeakMap,Mi=new WeakMap,Ts=new WeakMap,hr=new WeakMap,Ss=new WeakMap,Fi=new WeakMap,Ui=new WeakMap,ba=new WeakMap,Xu=new WeakSet,eh=function(e){if(Rt(this,Fi,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new ge),e instanceof ge)return Rt(this,Ui,!0,"f"),this._emit("abort",e);if(e instanceof z)return this._emit("error",e);if(e instanceof Error){let t=new z(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new z(String(e)))};function th(n,e){let t={...n};return Object.defineProperties(t,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),t}function Yu(n){return(n==null?void 0:n.$brand)==="auto-parseable-response-format"}function rh(n,{parser:e,callback:t}){let r={...n};return Object.defineProperties(r,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:e,enumerable:!1},$callback:{value:t,enumerable:!1}}),r}function on(n){return(n==null?void 0:n.$brand)==="auto-parseable-tool"}function nh(n,e){return!e||!Qu(e)?{...n,choices:n.choices.map(t=>{var r;return{...t,message:{...t.message,parsed:null,tool_calls:(r=t.message.tool_calls)!=null?r:[]}}})}:ks(n,e)}function ks(n,e){let t=n.choices.map(r=>{var a,s;if(r.finish_reason==="length")throw new la;if(r.finish_reason==="content_filter")throw new da;return{...r,message:{...r.message,tool_calls:(s=(a=r.message.tool_calls)==null?void 0:a.map(i=>$b(e,i)))!=null?s:[],parsed:r.message.content&&!r.message.refusal?Nb(e,r.message.content):null}}});return{...n,choices:t}}function Nb(n,e){var t,r;return((t=n.response_format)==null?void 0:t.type)!=="json_schema"?null:((r=n.response_format)==null?void 0:r.type)==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function $b(n,e){var r;let t=(r=n.tools)==null?void 0:r.find(a=>{var s;return((s=a.function)==null?void 0:s.name)===e.function.name});return{...e,function:{...e.function,parsed_arguments:on(t)?t.$parseRaw(e.function.arguments):t!=null&&t.function.strict?JSON.parse(e.function.arguments):null}}}function ah(n,e){var r;if(!n)return!1;let t=(r=n.tools)==null?void 0:r.find(a=>{var s;return((s=a.function)==null?void 0:s.name)===e.function.name});return on(t)||(t==null?void 0:t.function.strict)||!1}function Qu(n){var e,t;return Yu(n.response_format)?!0:(t=(e=n.tools)==null?void 0:e.some(r=>on(r)||r.type==="function"&&r.function.strict===!0))!=null?t:!1}function sh(n){for(let e of n!=null?n:[]){if(e.type!=="function")throw new z(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new z(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var Xe=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},je,ec,zi,tc,rc,nc,oh,ac,ih=10,wa=class extends _a{constructor(){super(...arguments),je.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Ju(e)||Wu(e))&&e.content)this._emit("functionCallResult",e.content);else if($r(e)&&e.function_call)this._emit("functionCall",e.function_call);else if($r(e)&&e.tool_calls)for(let r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new z("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),Xe(this,je,"m",ec).call(this)}async finalMessage(){return await this.done(),Xe(this,je,"m",zi).call(this)}async finalFunctionCall(){return await this.done(),Xe(this,je,"m",tc).call(this)}async finalFunctionCallResult(){return await this.done(),Xe(this,je,"m",rc).call(this)}async totalUsage(){return await this.done(),Xe(this,je,"m",nc).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=Xe(this,je,"m",zi).call(this);t&&this._emit("finalMessage",t);let r=Xe(this,je,"m",ec).call(this);r&&this._emit("finalContent",r);let a=Xe(this,je,"m",tc).call(this);a&&this._emit("finalFunctionCall",a);let s=Xe(this,je,"m",rc).call(this);s!=null&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",Xe(this,je,"m",nc).call(this))}async _createChatCompletion(e,t,r){let a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),Xe(this,je,"m",oh).call(this,t);let s=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(ks(s,t))}async _runChatCompletion(e,t,r){for(let a of t.messages)this._addMessage(a,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){var h;let a="function",{function_call:s="auto",stream:i,...o}=t,u=typeof s!="string"&&(s==null?void 0:s.name),{maxChatCompletions:c=ih}=r||{},l={};for(let f of t.functions)l[f.name||f.function.name]=f;let d=t.functions.map(f=>({name:f.name||f.function.name,parameters:f.parameters,description:f.description}));for(let f of t.messages)this._addMessage(f,!1);for(let f=0;f<c;++f){let g=(h=(await this._createChatCompletion(e,{...o,function_call:s,functions:d,messages:[...this.messages]},r)).choices[0])==null?void 0:h.message;if(!g)throw new z("missing message in ChatCompletion response");if(!g.function_call)return;let{name:y,arguments:m}=g.function_call,b=l[y];if(b){if(u&&u!==y){let v=`Invalid function_call: ${JSON.stringify(y)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,name:y,content:v});continue}}else{let v=`Invalid function_call: ${JSON.stringify(y)}. Available options are: ${d.map(E=>JSON.stringify(E.name)).join(", ")}. Please try again`;this._addMessage({role:a,name:y,content:v});continue}let A;try{A=Ku(b)?await b.parse(m):m}catch(v){this._addMessage({role:a,name:y,content:v instanceof Error?v.message:String(v)});continue}let I=await b.function(A,this),_=Xe(this,je,"m",ac).call(this,I);if(this._addMessage({role:a,name:y,content:_}),u)return}}async _runTools(e,t,r){var f,p,g;let a="tool",{tool_choice:s="auto",stream:i,...o}=t,u=typeof s!="string"&&((f=s==null?void 0:s.function)==null?void 0:f.name),{maxChatCompletions:c=ih}=r||{},l=t.tools.map(y=>{if(on(y)){if(!y.$callback)throw new z("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:y.$callback,name:y.function.name,description:y.function.description||"",parameters:y.function.parameters,parse:y.$parseRaw,strict:!0}}}return y}),d={};for(let y of l)y.type==="function"&&(d[y.function.name||y.function.function.name]=y.function);let h="tools"in t?l.map(y=>y.type==="function"?{type:"function",function:{name:y.function.name||y.function.function.name,parameters:y.function.parameters,description:y.function.description,strict:y.function.strict}}:y):void 0;for(let y of t.messages)this._addMessage(y,!1);for(let y=0;y<c;++y){let b=(p=(await this._createChatCompletion(e,{...o,tool_choice:s,tools:h,messages:[...this.messages]},r)).choices[0])==null?void 0:p.message;if(!b)throw new z("missing message in ChatCompletion response");if(!((g=b.tool_calls)!=null&&g.length))return;for(let A of b.tool_calls){if(A.type!=="function")continue;let I=A.id,{name:_,arguments:v}=A.function,E=d[_];if(E){if(u&&u!==_){let q=`Invalid tool_call: ${JSON.stringify(_)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,tool_call_id:I,content:q});continue}}else{let q=`Invalid tool_call: ${JSON.stringify(_)}. Available options are: ${Object.keys(d).map(V=>JSON.stringify(V)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:I,content:q});continue}let O;try{O=Ku(E)?await E.parse(v):v}catch(q){let V=q instanceof Error?q.message:String(q);this._addMessage({role:a,tool_call_id:I,content:V});continue}let S=await E.function(O,this),L=Xe(this,je,"m",ac).call(this,S);if(this._addMessage({role:a,tool_call_id:I,content:L}),u)return}}}};je=new WeakSet,ec=function(){var e;return(e=Xe(this,je,"m",zi).call(this).content)!=null?e:null},zi=function(){var t,r;let e=this.messages.length;for(;e-- >0;){let a=this.messages[e];if($r(a)){let{function_call:s,...i}=a,o={...i,content:(t=a.content)!=null?t:null,refusal:(r=a.refusal)!=null?r:null};return s&&(o.function_call=s),o}}throw new z("stream ended without producing a ChatCompletionMessage with role=assistant")},tc=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){let a=this.messages[r];if($r(a)&&(a!=null&&a.function_call))return a.function_call;if($r(a)&&((e=a==null?void 0:a.tool_calls)!=null&&e.length))return(t=a.tool_calls.at(-1))==null?void 0:t.function}},rc=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Ju(t)&&t.content!=null||Wu(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(r=>{var a;return r.role==="assistant"&&((a=r.tool_calls)==null?void 0:a.some(s=>s.type==="function"&&s.id===t.tool_call_id))}))return t.content}},nc=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},oh=function(e){if(e.n!=null&&e.n>1)throw new z("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ac=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var Cs=class n extends wa{static runFunctions(e,t,r){let a=new n,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){let a=new n,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}_addMessage(e,t=!0){super._addMessage(e,t),$r(e)&&e.content&&this._emit("content",e.content)}};var Pe={STR:1,NUM:2,ARR:4,OBJ:8,NULL:16,BOOL:32,NAN:64,INFINITY:128,MINUS_INFINITY:256,INF:384,SPECIAL:496,ATOM:499,COLLECTION:12,ALL:511},sc=class extends Error{},ic=class extends Error{};function jb(n,e=Pe.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return Lb(n.trim(),e)}var Lb=(n,e)=>{let t=n.length,r=0,a=h=>{throw new sc(`${h} at position ${r}`)},s=h=>{throw new ic(`${h} at position ${r}`)},i=()=>(d(),r>=t&&a("Unexpected end of input"),n[r]==='"'?o():n[r]==="{"?u():n[r]==="["?c():n.substring(r,r+4)==="null"||Pe.NULL&e&&t-r<4&&"null".startsWith(n.substring(r))?(r+=4,null):n.substring(r,r+4)==="true"||Pe.BOOL&e&&t-r<4&&"true".startsWith(n.substring(r))?(r+=4,!0):n.substring(r,r+5)==="false"||Pe.BOOL&e&&t-r<5&&"false".startsWith(n.substring(r))?(r+=5,!1):n.substring(r,r+8)==="Infinity"||Pe.INFINITY&e&&t-r<8&&"Infinity".startsWith(n.substring(r))?(r+=8,1/0):n.substring(r,r+9)==="-Infinity"||Pe.MINUS_INFINITY&e&&1<t-r&&t-r<9&&"-Infinity".startsWith(n.substring(r))?(r+=9,-1/0):n.substring(r,r+3)==="NaN"||Pe.NAN&e&&t-r<3&&"NaN".startsWith(n.substring(r))?(r+=3,NaN):l()),o=()=>{let h=r,f=!1;for(r++;r<t&&(n[r]!=='"'||f&&n[r-1]==="\\");)f=n[r]==="\\"?!f:!1,r++;if(n.charAt(r)=='"')try{return JSON.parse(n.substring(h,++r-Number(f)))}catch(p){s(String(p))}else if(Pe.STR&e)try{return JSON.parse(n.substring(h,r-Number(f))+'"')}catch(p){return JSON.parse(n.substring(h,n.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},u=()=>{r++,d();let h={};try{for(;n[r]!=="}";){if(d(),r>=t&&Pe.OBJ&e)return h;let f=o();d(),r++;try{let p=i();Object.defineProperty(h,f,{value:p,writable:!0,enumerable:!0,configurable:!0})}catch(p){if(Pe.OBJ&e)return h;throw p}d(),n[r]===","&&r++}}catch(f){if(Pe.OBJ&e)return h;a("Expected '}' at end of object")}return r++,h},c=()=>{r++;let h=[];try{for(;n[r]!=="]";)h.push(i()),d(),n[r]===","&&r++}catch(f){if(Pe.ARR&e)return h;a("Expected ']' at end of array")}return r++,h},l=()=>{if(r===0){n==="-"&&Pe.NUM&e&&a("Not sure what '-' is");try{return JSON.parse(n)}catch(f){if(Pe.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch(p){}s(String(f))}}let h=r;for(n[r]==="-"&&r++;n[r]&&!",]}".includes(n[r]);)r++;r==t&&!(Pe.NUM&e)&&a("Unterminated number literal");try{return JSON.parse(n.substring(h,r))}catch(f){n.substring(h,r)==="-"&&Pe.NUM&e&&a("Not sure what '-' is");try{return JSON.parse(n.substring(h,n.lastIndexOf("e")))}catch(p){s(String(p))}}},d=()=>{for(;r<t&&` 
\r	`.includes(n[r]);)r++};return i()},oc=n=>jb(n,Pe.ALL^Pe.NUM);var va=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},ae=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ee,fr,Aa,jr,uc,Bi,cc,lc,dc,qi,hc,uh,Ea=class n extends wa{constructor(e){super(),Ee.add(this),fr.set(this,void 0),Aa.set(this,void 0),jr.set(this,void 0),va(this,fr,e,"f"),va(this,Aa,[],"f")}get currentChatCompletionSnapshot(){return ae(this,jr,"f")}static fromReadableStream(e){let t=new n(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let a=new n(t);return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,r){var i;super._createChatCompletion;let a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),ae(this,Ee,"m",uc).call(this);let s=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(let o of s)ae(this,Ee,"m",cc).call(this,o);if((i=s.controller.signal)!=null&&i.aborted)throw new ge;return this._addChatCompletion(ae(this,Ee,"m",qi).call(this))}async _fromReadableStream(e,t){var i;let r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),ae(this,Ee,"m",uc).call(this),this._connected();let a=Gt.fromReadableStream(e,this.controller),s;for await(let o of a)s&&s!==o.id&&this._addChatCompletion(ae(this,Ee,"m",qi).call(this)),ae(this,Ee,"m",cc).call(this,o),s=o.id;if((i=a.controller.signal)!=null&&i.aborted)throw new ge;return this._addChatCompletion(ae(this,Ee,"m",qi).call(this))}[(fr=new WeakMap,Aa=new WeakMap,jr=new WeakMap,Ee=new WeakSet,uc=function(){this.ended||va(this,jr,void 0,"f")},Bi=function(t){let r=ae(this,Aa,"f")[t.index];return r||(r={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},ae(this,Aa,"f")[t.index]=r,r)},cc=function(t){var a,s,i,o,u,c,l,d,h,f,p,g,y,m,b,A,I,_,v,E;if(this.ended)return;let r=ae(this,Ee,"m",uh).call(this,t);this._emit("chunk",t,r);for(let O of t.choices){let S=r.choices[O.index];O.delta.content!=null&&((a=S.message)==null?void 0:a.role)==="assistant"&&((s=S.message)!=null&&s.content)&&(this._emit("content",O.delta.content,S.message.content),this._emit("content.delta",{delta:O.delta.content,snapshot:S.message.content,parsed:S.message.parsed})),O.delta.refusal!=null&&((i=S.message)==null?void 0:i.role)==="assistant"&&((o=S.message)!=null&&o.refusal)&&this._emit("refusal.delta",{delta:O.delta.refusal,snapshot:S.message.refusal}),((u=O.logprobs)==null?void 0:u.content)!=null&&((c=S.message)==null?void 0:c.role)==="assistant"&&this._emit("logprobs.content.delta",{content:(l=O.logprobs)==null?void 0:l.content,snapshot:(h=(d=S.logprobs)==null?void 0:d.content)!=null?h:[]}),((f=O.logprobs)==null?void 0:f.refusal)!=null&&((p=S.message)==null?void 0:p.role)==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:(g=O.logprobs)==null?void 0:g.refusal,snapshot:(m=(y=S.logprobs)==null?void 0:y.refusal)!=null?m:[]});let L=ae(this,Ee,"m",Bi).call(this,S);S.finish_reason&&(ae(this,Ee,"m",dc).call(this,S),L.current_tool_call_index!=null&&ae(this,Ee,"m",lc).call(this,S,L.current_tool_call_index));for(let q of(b=O.delta.tool_calls)!=null?b:[])L.current_tool_call_index!==q.index&&(ae(this,Ee,"m",dc).call(this,S),L.current_tool_call_index!=null&&ae(this,Ee,"m",lc).call(this,S,L.current_tool_call_index)),L.current_tool_call_index=q.index;for(let q of(A=O.delta.tool_calls)!=null?A:[]){let V=(I=S.message.tool_calls)==null?void 0:I[q.index];V!=null&&V.type&&((V==null?void 0:V.type)==="function"?this._emit("tool_calls.function.arguments.delta",{name:(_=V.function)==null?void 0:_.name,index:q.index,arguments:V.function.arguments,parsed_arguments:V.function.parsed_arguments,arguments_delta:(E=(v=q.function)==null?void 0:v.arguments)!=null?E:""}):(V==null||V.type,void 0))}}},lc=function(t,r){var i,o,u;if(ae(this,Ee,"m",Bi).call(this,t).done_tool_calls.has(r))return;let s=(i=t.message.tool_calls)==null?void 0:i[r];if(!s)throw new Error("no tool call snapshot");if(!s.type)throw new Error("tool call snapshot missing `type`");if(s.type==="function"){let c=(u=(o=ae(this,fr,"f"))==null?void 0:o.tools)==null?void 0:u.find(l=>l.type==="function"&&l.function.name===s.function.name);this._emit("tool_calls.function.arguments.done",{name:s.function.name,index:r,arguments:s.function.arguments,parsed_arguments:on(c)?c.$parseRaw(s.function.arguments):c!=null&&c.function.strict?JSON.parse(s.function.arguments):null})}else s.type},dc=function(t){var a,s;let r=ae(this,Ee,"m",Bi).call(this,t);if(t.message.content&&!r.content_done){r.content_done=!0;let i=ae(this,Ee,"m",hc).call(this);this._emit("content.done",{content:t.message.content,parsed:i?i.$parseRaw(t.message.content):null})}t.message.refusal&&!r.refusal_done&&(r.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),(a=t.logprobs)!=null&&a.content&&!r.logprobs_content_done&&(r.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),(s=t.logprobs)!=null&&s.refusal&&!r.logprobs_refusal_done&&(r.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},qi=function(){if(this.ended)throw new z("stream has ended, this shouldn't happen");let t=ae(this,jr,"f");if(!t)throw new z("request ended without sending any chunks");return va(this,jr,void 0,"f"),va(this,Aa,[],"f"),Db(t,ae(this,fr,"f"))},hc=function(){var r;let t=(r=ae(this,fr,"f"))==null?void 0:r.response_format;return Yu(t)?t:null},uh=function(t){var l,d,h,f,p,g;var r,a,s,i;let o=ae(this,jr,"f"),{choices:u,...c}=t;o?Object.assign(o,c):o=va(this,jr,{...c,choices:[]},"f");for(let{delta:y,finish_reason:m,index:b,logprobs:A=null,...I}of t.choices){let _=o.choices[b];if(_||(_=o.choices[b]={finish_reason:m,index:b,message:{},logprobs:A,...I}),A)if(!_.logprobs)_.logprobs=Object.assign({},A);else{let{content:V,refusal:de,...Ie}=A;Object.assign(_.logprobs,Ie),V&&((l=(r=_.logprobs).content)!=null||(r.content=[]),_.logprobs.content.push(...V)),de&&((d=(a=_.logprobs).refusal)!=null||(a.refusal=[]),_.logprobs.refusal.push(...de))}if(m&&(_.finish_reason=m,ae(this,fr,"f")&&Qu(ae(this,fr,"f")))){if(m==="length")throw new la;if(m==="content_filter")throw new da}if(Object.assign(_,I),!y)continue;let{content:v,refusal:E,function_call:O,role:S,tool_calls:L,...q}=y;if(Object.assign(_.message,q),E&&(_.message.refusal=(_.message.refusal||"")+E),S&&(_.message.role=S),O&&(_.message.function_call?(O.name&&(_.message.function_call.name=O.name),O.arguments&&((h=(s=_.message.function_call).arguments)!=null||(s.arguments=""),_.message.function_call.arguments+=O.arguments)):_.message.function_call=O),v&&(_.message.content=(_.message.content||"")+v,!_.message.refusal&&ae(this,Ee,"m",hc).call(this)&&(_.message.parsed=oc(_.message.content))),L){_.message.tool_calls||(_.message.tool_calls=[]);for(let{index:V,id:de,type:Ie,function:ve,...Qr}of L){let $e=(f=(i=_.message.tool_calls)[V])!=null?f:i[V]={};Object.assign($e,Qr),de&&($e.id=de),Ie&&($e.type=Ie),ve&&((g=$e.function)!=null||($e.function={name:(p=ve.name)!=null?p:"",arguments:""})),ve!=null&&ve.name&&($e.function.name=ve.name),ve!=null&&ve.arguments&&($e.function.arguments+=ve.arguments,ah(ae(this,fr,"f"),$e)&&($e.function.parsed_arguments=oc($e.function.arguments)))}}}return o},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",a=>{let s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(let a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Gt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function Db(n,e){let{id:t,choices:r,created:a,model:s,system_fingerprint:i,...o}=n,u={...o,id:t,choices:r.map(({message:c,finish_reason:l,index:d,logprobs:h,...f})=>{var A,I,_;if(!l)throw new z(`missing finish_reason for choice ${d}`);let{content:p=null,function_call:g,tool_calls:y,...m}=c,b=c.role;if(!b)throw new z(`missing role for choice ${d}`);if(g){let{arguments:v,name:E}=g;if(v==null)throw new z(`missing function_call.arguments for choice ${d}`);if(!E)throw new z(`missing function_call.name for choice ${d}`);return{...f,message:{content:p,function_call:{arguments:v,name:E},role:b,refusal:(A=c.refusal)!=null?A:null},finish_reason:l,index:d,logprobs:h}}return y?{...f,index:d,finish_reason:l,logprobs:h,message:{...m,role:b,content:p,refusal:(I=c.refusal)!=null?I:null,tool_calls:y.map((v,E)=>{let{function:O,type:S,id:L,...q}=v,{arguments:V,name:de,...Ie}=O||{};if(L==null)throw new z(`missing choices[${d}].tool_calls[${E}].id
${Vi(n)}`);if(S==null)throw new z(`missing choices[${d}].tool_calls[${E}].type
${Vi(n)}`);if(de==null)throw new z(`missing choices[${d}].tool_calls[${E}].function.name
${Vi(n)}`);if(V==null)throw new z(`missing choices[${d}].tool_calls[${E}].function.arguments
${Vi(n)}`);return{...q,id:L,type:S,function:{...Ie,name:de,arguments:V}}})}}:{...f,message:{...m,content:p,role:b,refusal:(_=c.refusal)!=null?_:null},finish_reason:l,index:d,logprobs:h}}),created:a,model:s,object:"chat.completion",...i?{system_fingerprint:i}:{}};return nh(u,e)}function Vi(n){return JSON.stringify(n)}var Rs=class n extends Ea{static fromReadableStream(e){let t=new n(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){let a=new n(null),s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){let a=new n(t),s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}};var Ns=class extends ${parse(e,t){return sh(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t==null?void 0:t.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(r=>ks(r,e))}runFunctions(e,t){return e.stream?Rs.runFunctions(this._client,e,t):Cs.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Rs.runTools(this._client,e,t):Cs.runTools(this._client,e,t)}stream(e,t){return Ea.createChatCompletion(this._client,e,t)}};var Oa=class extends ${constructor(){super(...arguments),this.completions=new Ns(this._client)}};(function(n){n.Completions=Ns})(Oa||(Oa={}));var M=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ct=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},ke,fc,Jt,Hi,Nt,cn,xa,un,Ki,lt,Zi,Gi,Ls,$s,js,ch,lh,dh,hh,fh,ph,mh,Wt=class n extends _a{constructor(){super(...arguments),ke.add(this),fc.set(this,[]),Jt.set(this,{}),Hi.set(this,{}),Nt.set(this,void 0),cn.set(this,void 0),xa.set(this,void 0),un.set(this,void 0),Ki.set(this,void 0),lt.set(this,void 0),Zi.set(this,void 0),Gi.set(this,void 0),Ls.set(this,void 0)}[(fc=new WeakMap,Jt=new WeakMap,Hi=new WeakMap,Nt=new WeakMap,cn=new WeakMap,xa=new WeakMap,un=new WeakMap,Ki=new WeakMap,lt=new WeakMap,Zi=new WeakMap,Gi=new WeakMap,Ls=new WeakMap,ke=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",a=>{let s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(let a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){var s;let r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let a=Gt.fromReadableStream(e,this.controller);for await(let i of a)M(this,ke,"m",$s).call(this,i);if((s=a.controller.signal)!=null&&s.aborted)throw new ge;return this._addRun(M(this,ke,"m",js).call(this))}toReadableStream(){return new Gt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,a,s){let i=new n;return i._run(()=>i._runToolAssistantStream(e,t,r,a,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,a,s){var c;let i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o={...a,stream:!0},u=await e.submitToolOutputs(t,r,o,{...s,signal:this.controller.signal});this._connected();for await(let l of u)M(this,ke,"m",$s).call(this,l);if((c=u.controller.signal)!=null&&c.aborted)throw new ge;return this._addRun(M(this,ke,"m",js).call(this))}static createThreadAssistantStream(e,t,r){let a=new n;return a._run(()=>a._threadAssistantStream(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}static createAssistantStream(e,t,r,a){let s=new n;return s._run(()=>s._runAssistantStream(e,t,r,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),s}currentEvent(){return M(this,Zi,"f")}currentRun(){return M(this,Gi,"f")}currentMessageSnapshot(){return M(this,Nt,"f")}currentRunStepSnapshot(){return M(this,Ls,"f")}async finalRunSteps(){return await this.done(),Object.values(M(this,Jt,"f"))}async finalMessages(){return await this.done(),Object.values(M(this,Hi,"f"))}async finalRun(){if(await this.done(),!M(this,cn,"f"))throw Error("Final run was not received.");return M(this,cn,"f")}async _createThreadAssistantStream(e,t,r){var o;let a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let s={...t,stream:!0},i=await e.createAndRun(s,{...r,signal:this.controller.signal});this._connected();for await(let u of i)M(this,ke,"m",$s).call(this,u);if((o=i.controller.signal)!=null&&o.aborted)throw new ge;return this._addRun(M(this,ke,"m",js).call(this))}async _createAssistantStream(e,t,r,a){var u;let s=a==null?void 0:a.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i={...r,stream:!0},o=await e.create(t,i,{...a,signal:this.controller.signal});this._connected();for await(let c of o)M(this,ke,"m",$s).call(this,c);if((u=o.controller.signal)!=null&&u.aborted)throw new ge;return this._addRun(M(this,ke,"m",js).call(this))}static accumulateDelta(e,t){for(let[r,a]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=a;continue}let s=e[r];if(s==null){e[r]=a;continue}if(r==="index"||r==="type"){e[r]=a;continue}if(typeof s=="string"&&typeof a=="string")s+=a;else if(typeof s=="number"&&typeof a=="number")s+=a;else if(xs(s)&&xs(a))s=this.accumulateDelta(s,a);else if(Array.isArray(s)&&Array.isArray(a)){if(s.every(i=>typeof i=="string"||typeof i=="number")){s.push(...a);continue}for(let i of a){if(!xs(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);let o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);let u=s[o];u==null?s.push(i):s[o]=this.accumulateDelta(u,i)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${a}, accValue: ${s}`);e[r]=s}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,a){return await this._createAssistantStream(t,e,r,a)}async _runToolAssistantStream(e,t,r,a,s){return await this._createToolAssistantStream(r,e,t,a,s)}};$s=function(e){if(!this.ended)switch(ct(this,Zi,e,"f"),M(this,ke,"m",dh).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":M(this,ke,"m",mh).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":M(this,ke,"m",lh).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":M(this,ke,"m",ch).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},js=function(){if(this.ended)throw new z("stream has ended, this shouldn't happen");if(!M(this,cn,"f"))throw Error("Final run has not been received");return M(this,cn,"f")},ch=function(e){let[t,r]=M(this,ke,"m",fh).call(this,e,M(this,Nt,"f"));ct(this,Nt,t,"f"),M(this,Hi,"f")[t.id]=t;for(let a of r){let s=t.content[a.index];(s==null?void 0:s.type)=="text"&&this._emit("textCreated",s.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let a of e.data.delta.content){if(a.type=="text"&&a.text){let s=a.text,i=t.content[a.index];if(i&&i.type=="text")this._emit("textDelta",s,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(a.index!=M(this,xa,"f")){if(M(this,un,"f"))switch(M(this,un,"f").type){case"text":this._emit("textDone",M(this,un,"f").text,M(this,Nt,"f"));break;case"image_file":this._emit("imageFileDone",M(this,un,"f").image_file,M(this,Nt,"f"));break}ct(this,xa,a.index,"f")}ct(this,un,t.content[a.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(M(this,xa,"f")!==void 0){let a=e.data.content[M(this,xa,"f")];if(a)switch(a.type){case"image_file":this._emit("imageFileDone",a.image_file,M(this,Nt,"f"));break;case"text":this._emit("textDone",a.text,M(this,Nt,"f"));break}}M(this,Nt,"f")&&this._emit("messageDone",e.data),ct(this,Nt,void 0,"f")}},lh=function(e){let t=M(this,ke,"m",hh).call(this,e);switch(ct(this,Ls,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let s of r.step_details.tool_calls)s.index==M(this,Ki,"f")?this._emit("toolCallDelta",s,t.step_details.tool_calls[s.index]):(M(this,lt,"f")&&this._emit("toolCallDone",M(this,lt,"f")),ct(this,Ki,s.index,"f"),ct(this,lt,t.step_details.tool_calls[s.index],"f"),M(this,lt,"f")&&this._emit("toolCallCreated",M(this,lt,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ct(this,Ls,void 0,"f"),e.data.step_details.type=="tool_calls"&&M(this,lt,"f")&&(this._emit("toolCallDone",M(this,lt,"f")),ct(this,lt,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},dh=function(e){M(this,fc,"f").push(e),this._emit("event",e)},hh=function(e){switch(e.event){case"thread.run.step.created":return M(this,Jt,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=M(this,Jt,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let a=Wt.accumulateDelta(t,r.delta);M(this,Jt,"f")[e.data.id]=a}return M(this,Jt,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":M(this,Jt,"f")[e.data.id]=e.data;break}if(M(this,Jt,"f")[e.data.id])return M(this,Jt,"f")[e.data.id];throw new Error("No snapshot available")},fh=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let a=e.data;if(a.delta.content)for(let s of a.delta.content)if(s.index in t.content){let i=t.content[s.index];t.content[s.index]=M(this,ke,"m",ph).call(this,s,i)}else t.content[s.index]=s,r.push(s);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},ph=function(e,t){return Wt.accumulateDelta(t,e)},mh=function(e){switch(ct(this,Gi,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":ct(this,cn,e.data,"f"),M(this,lt,"f")&&(this._emit("toolCallDone",M(this,lt,"f")),ct(this,lt,void 0,"f"));break;case"thread.run.cancelling":break}};var ln=class extends ${create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},r){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Ia,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}},Ia=class extends he{};ln.MessagesPage=Ia;var dn=class extends ${retrieve(e,t,r,a={},s){return ue(a)?this.retrieve(e,t,r,{},a):this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{query:a,...s,headers:{"OpenAI-Beta":"assistants=v2",...s==null?void 0:s.headers}})}list(e,t,r={},a){return ue(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Pa,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}},Pa=class extends he{};dn.RunStepsPage=Pa;var pr=class extends ${constructor(){super(...arguments),this.steps=new dn(this._client)}create(e,t,r){var i;let{include:a,...s}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:a},body:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers},stream:(i=t.stream)!=null?i:!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}list(e,t={},r){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Ta,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}createAndStream(e,t,r){return Wt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){let a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:s,response:i}=await this.retrieve(e,t,{...r,headers:{...r==null?void 0:r.headers,...a}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{let u=i.headers.get("openai-poll-after-ms");if(u){let c=parseInt(u);isNaN(c)||(o=c)}}await dr(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,r){return Wt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,a){var s;return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers},stream:(s=r.stream)!=null?s:!1})}async submitToolOutputsAndPoll(e,t,r,a){let s=await this.submitToolOutputs(e,t,r,a);return await this.poll(e,s.id,a)}submitToolOutputsStream(e,t,r,a){return Wt.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,a)}},Ta=class extends he{};pr.RunsPage=Ta;pr.Steps=dn;pr.RunStepsPage=Pa;var Xt=class extends ${constructor(){super(...arguments),this.runs=new pr(this._client),this.messages=new ln(this._client)}create(e={},t){return ue(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}createAndRun(e,t){var r;return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers},stream:(r=e.stream)!=null?r:!1})}async createAndRunPoll(e,t){let r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return Wt.createThreadAssistantStream(e,this._client.beta.threads,t)}};Xt.Runs=pr;Xt.RunsPage=Ta;Xt.Messages=ln;Xt.MessagesPage=Ia;var gh=async n=>{let e=await Promise.allSettled(n),t=e.filter(a=>a.status==="rejected");if(t.length){for(let a of t)console.error(a.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}let r=[];for(let a of e)a.status==="fulfilled"&&r.push(a.value);return r};var hn=class extends ${create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e,t={},r){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Lr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}async poll(e,t,r){let a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let s=await this.retrieve(e,t,{...r,headers:a}).withResponse(),i=s.data;switch(i.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{let u=s.response.headers.get("openai-poll-after-ms");if(u){let c=parseInt(u);isNaN(c)||(o=c)}}await dr(o);break;case"failed":case"completed":return i}}}async upload(e,t,r){let a=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:a.id},r)}async uploadAndPoll(e,t,r){let a=await this.upload(e,t,r);return await this.poll(e,a.id,r)}},Lr=class extends he{};hn.VectorStoreFilesPage=Lr;var Sa=class extends ${create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}async createAndPoll(e,t,r){let a=await this.create(e,t);return await this.poll(e,a.id,r)}listFiles(e,t,r={},a){return ue(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Lr,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v2",...a==null?void 0:a.headers}})}async poll(e,t,r){let a={...r==null?void 0:r.headers,"X-Stainless-Poll-Helper":"true"};for(r!=null&&r.pollIntervalMs&&(a["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){let{data:s,response:i}=await this.retrieve(e,t,{...r,headers:a}).withResponse();switch(s.status){case"in_progress":let o=5e3;if(r!=null&&r.pollIntervalMs)o=r.pollIntervalMs;else{let u=i.headers.get("openai-poll-after-ms");if(u){let c=parseInt(u);isNaN(c)||(o=c)}}await dr(o);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},a){var h;if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let s=(h=a==null?void 0:a.maxConcurrency)!=null?h:5,i=Math.min(s,t.length),o=this._client,u=t.values(),c=[...r];async function l(f){for(let p of f){let g=await o.files.create({file:p,purpose:"assistants"},a);c.push(g.id)}}let d=Array(i).fill(u).map(l);return await gh(d),await this.createAndPoll(e,{file_ids:c})}};var Yt=class extends ${constructor(){super(...arguments),this.files=new hn(this._client),this.fileBatches=new Sa(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r==null?void 0:r.headers}})}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/vector_stores",ka,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t==null?void 0:t.headers}})}},ka=class extends he{};Yt.VectorStoresPage=ka;Yt.Files=hn;Yt.VectorStoreFilesPage=Lr;Yt.FileBatches=Sa;var gt=class extends ${constructor(){super(...arguments),this.vectorStores=new Yt(this._client),this.chat=new Oa(this._client),this.assistants=new sn(this._client),this.threads=new Xt(this._client)}};gt.VectorStores=Yt;gt.VectorStoresPage=ka;gt.Assistants=sn;gt.AssistantsPage=ya;gt.Threads=Xt;var fn=class extends ${create(e,t){var r;return this._client.post("/completions",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}};var pn=class extends ${create(e,t){return this._client.post("/embeddings",{body:e,...t})}};var Dr=class extends ${create(e,t){return this._client.post("/files",mt({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/files",mn,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t==null?void 0:t.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){let a=new Set(["processed","error","deleted"]),s=Date.now(),i=await this.retrieve(e);for(;!i.status||!a.has(i.status);)if(await dr(t),i=await this.retrieve(e),Date.now()-s>r)throw new Ct({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}},mn=class extends he{};Dr.FileObjectsPage=mn;var gn=class extends ${list(e,t={},r){return ue(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Ca,{query:t,...r})}},Ca=class extends he{};gn.FineTuningJobCheckpointsPage=Ca;var Qt=class extends ${constructor(){super(...arguments),this.checkpoints=new gn(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return ue(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Ra,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return ue(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Na,{query:t,...r})}},Ra=class extends he{},Na=class extends he{};Qt.FineTuningJobsPage=Ra;Qt.FineTuningJobEventsPage=Na;Qt.Checkpoints=gn;Qt.FineTuningJobCheckpointsPage=Ca;var er=class extends ${constructor(){super(...arguments),this.jobs=new Qt(this._client)}};er.Jobs=Qt;er.FineTuningJobsPage=Ra;er.FineTuningJobEventsPage=Na;var yn=class extends ${createVariation(e,t){return this._client.post("/images/variations",mt({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",mt({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}};var Mr=class extends ${retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",bn,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}},bn=class extends ji{};Mr.ModelsPage=bn;var _n=class extends ${create(e,t){return this._client.post("/moderations",{body:e,...t})}};var $a=class extends ${create(e,t,r){return this._client.post(`/uploads/${e}/parts`,mt({body:t,...r}))}};var Fr=class extends ${constructor(){super(...arguments),this.parts=new $a(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(`/uploads/${e}/complete`,{body:t,...r})}};Fr.Parts=$a;var yh,W=class extends $i{constructor({baseURL:e=Os("OPENAI_BASE_URL"),apiKey:t=Os("OPENAI_API_KEY"),organization:r=(i=>(i=Os("OPENAI_ORG_ID"))!=null?i:null)(),project:a=(o=>(o=Os("OPENAI_PROJECT_ID"))!=null?o:null)(),...s}={}){var c;if(t===void 0)throw new z("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let u={apiKey:t,organization:r,project:a,...s,baseURL:e||"https://api.openai.com/v1"};if(!u.dangerouslyAllowBrowser&&Qd())throw new z(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:u.baseURL,timeout:(c=u.timeout)!=null?c:6e5,httpAgent:u.httpAgent,maxRetries:u.maxRetries,fetch:u.fetch}),this.completions=new fn(this),this.chat=new Rr(this),this.embeddings=new pn(this),this.files=new Dr(this),this.images=new yn(this),this.audio=new Kt(this),this.moderations=new _n(this),this.models=new Mr(this),this.fineTuning=new er(this),this.beta=new gt(this),this.batches=new Nr(this),this.uploads=new Fr(this),this._options=u,this.apiKey=t,this.organization=r,this.project=a}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return $u(e,{arrayFormat:"brackets"})}};yh=W;W.OpenAI=yh;W.DEFAULT_TIMEOUT=6e5;W.OpenAIError=z;W.APIError=_e;W.APIConnectionError=lr;W.APIConnectionTimeoutError=Ct;W.APIUserAbortError=ge;W.NotFoundError=sa;W.ConflictError=ia;W.RateLimitError=ua;W.BadRequestError=ra;W.AuthenticationError=na;W.InternalServerError=ca;W.PermissionDeniedError=aa;W.UnprocessableEntityError=oa;W.toFile=Vu;W.fileFromPath=Ti;W.Completions=fn;W.Chat=Rr;W.Embeddings=pn;W.Files=Dr;W.FileObjectsPage=mn;W.Images=yn;W.Audio=Kt;W.Moderations=_n;W.Models=Mr;W.ModelsPage=bn;W.FineTuning=er;W.Beta=gt;W.Batches=Nr;W.BatchesPage=an;W.Uploads=Fr;function pc(n,e=ja){n=n.trim();let t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function ja(n){if(typeof n=="undefined")return null;try{return JSON.parse(n)}catch(s){}let e="",t=[],r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch(s){return null}}var Ph=pt(_h(),1),n_=pt(Ih(),1);function Th(n,e){return(e==null?void 0:e[n])||(0,Ph.default)(n)}function Sh(n,e,t){let r={};for(let a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function kh(n){return Array.isArray(n)?[...n]:{...n}}function a_(n,e){let t=kh(n);for(let[r,a]of Object.entries(e)){let[s,...i]=r.split(".").reverse(),o=t;for(let u of i.reverse()){if(o[u]===void 0)break;o[u]=kh(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function gc(n){let e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var $t=class n{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,gc(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof n||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r,[o,...u]=a.split(".").reverse();for(let c of u.reverse()){if(!(c in s)||s[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof s[c]=="object"&&s[c]!=null?i[c]={}:Array.isArray(s[c])&&(i[c]=[])),s=s[c],i=i[c]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Sh(Object.keys(t).length?a_(r,t):r,Th,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function yt(n,e){var t;return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?(t=Ds(n,e))!=null?t:[...n,...e]:[...n,{type:"text",text:e}]}function Ch(n,e){return n==="error"||e==="error"?"error":"success"}function s_(n,e){function t(r,a){if(typeof r!="object"||r===null||r===void 0)return r;if(a>=e)return Array.isArray(r)?"[Array]":"[Object]";if(Array.isArray(r))return r.map(i=>t(i,a+1));let s={};for(let i of Object.keys(r))s[i]=t(r[i],a+1);return s}return JSON.stringify(t(n,0),null,2)}var Be=class extends $t{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}getType(){return this._getType()}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(e===null)return this;let t=s_(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}};function ye(n,e){let t={...n};for(let[r,a]of Object.entries(e))if(t[r]==null)t[r]=a;else{if(a==null)continue;if(typeof t[r]!=typeof a||Array.isArray(t[r])!==Array.isArray(a))throw new Error(`field[${r}] already exists in the message chunk, but with a different type.`);if(typeof t[r]=="string"){if(r==="type")continue;t[r]+=a}else if(typeof t[r]=="object"&&!Array.isArray(t[r]))t[r]=ye(t[r],a);else if(Array.isArray(t[r]))t[r]=Ds(t[r],a);else{if(t[r]===a)continue;console.warn(`field[${r}] already exists in this message chunk and value has unsupported type.`)}}return t}function Ds(n,e){if(!(n===void 0&&e===void 0)){if(n===void 0||e===void 0)return n||e;{let t=[...n];for(let r of e)if(typeof r=="object"&&"index"in r&&typeof r.index=="number"){let a=t.findIndex(s=>s.index===r.index);a!==-1?t[a]=ye(t[a],r):t.push(r)}else{if(typeof r=="object"&&"text"in r&&r.text==="")continue;t.push(r)}return t}}}function Rh(n,e){if(!n&&!e)throw new Error("Cannot merge two undefined objects.");if(!n||!e)return n||e;if(typeof n!=typeof e)throw new Error(`Cannot merge objects of different types.
Left ${typeof n}
Right ${typeof e}`);if(typeof n=="string"&&typeof e=="string")return n+e;if(Array.isArray(n)&&Array.isArray(e))return Ds(n,e);if(typeof n=="object"&&typeof e=="object")return ye(n,e);if(n===e)return n;throw new Error(`Can not merge objects of different types.
Left ${n}
Right ${e}`)}var Ye=class extends Be{};function Nh(n){return typeof n.role=="string"}function La(n){return typeof(n==null?void 0:n._getType)=="function"}function $h(n){return La(n)&&typeof n.concat=="function"}function jh(n){return n!=null&&typeof n=="object"&&"lc_direct_tool_output"in n&&n.lc_direct_tool_output===!0}var mr=class extends Be{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){typeof e=="string"&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return e._getType()==="tool"}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},Da=class n extends Ye{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){var t;return new n({content:yt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),artifact:Rh(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:(t=this.id)!=null?t:e.id,status:Ch(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function Lh(n){let e=[],t=[];for(let r of n)if(r.function){let a=r.function.name;try{let s=JSON.parse(r.function.arguments),i={name:a||"",args:s||{},id:r.id};e.push(i)}catch(s){t.push({name:a,args:r.function.arguments,id:r.id,error:"Malformed args."})}}else continue;return[e,t]}var Qe=class extends Be{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){var a,s,i,o,u;let r;if(typeof e=="string")r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t!=null?t:{}};else{r=e;let c=(a=r.additional_kwargs)==null?void 0:a.tool_calls,l=r.tool_calls;c!=null&&c.length>0&&(l===void 0||l.length===0)&&console.warn(["New LangChain packages are available that more efficiently handle",`tool calling.

Please upgrade your packages to versions that set`,"message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(c!=null&&l===void 0){let[d,h]=Lh(c);r.tool_calls=d!=null?d:[],r.invalid_tool_calls=h!=null?h:[]}else r.tool_calls=(s=r.tool_calls)!=null?s:[],r.invalid_tool_calls=(i=r.invalid_tool_calls)!=null?i:[]}catch(d){r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r!="string"&&(this.tool_calls=(o=r.tool_calls)!=null?o:this.tool_calls,this.invalid_tool_calls=(u=r.invalid_tool_calls)!=null?u:this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}};function Ms(n){return n._getType()==="ai"}function yc(n){return n._getType()==="ai"}var Le=class n extends Ye{constructor(e){var r,a,s,i,o;let t;if(typeof e=="string")t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(e.tool_call_chunks===void 0)t={...e,tool_calls:(r=e.tool_calls)!=null?r:[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0};else{let u=[],c=[];for(let l of e.tool_call_chunks){let d={};try{if(d=ja(l.args||"{}"),d===null||typeof d!="object"||Array.isArray(d))throw new Error("Malformed tool call chunk args.");u.push({name:(a=l.name)!=null?a:"",args:d,id:l.id,type:"tool_call"})}catch(h){c.push({name:l.name,args:l.args,id:l.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:u,invalid_tool_calls:c,usage_metadata:e.usage_metadata!==void 0?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=(s=t.tool_call_chunks)!=null?s:this.tool_call_chunks,this.tool_calls=(i=t.tool_calls)!=null?i:this.tool_calls,this.invalid_tool_calls=(o=t.invalid_tool_calls)!=null?o:this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){var r,a,s,i,o,u,c,l,d,h,f,p,g,y,m,b,A,I,_,v,E,O,S,L,q,V,de,Ie,ve,Qr,$e,hs,fs,ps,ms,gs,Ai,ad,sd,id,od,ud,cd,ld,dd,hd,fd,pd,md,gd,yd,bd,_d;let t={content:yt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:(r=this.id)!=null?r:e.id};if(this.tool_call_chunks!==void 0||e.tool_call_chunks!==void 0){let ea=Ds(this.tool_call_chunks,e.tool_call_chunks);ea!==void 0&&ea.length>0&&(t.tool_call_chunks=ea)}if(this.usage_metadata!==void 0||e.usage_metadata!==void 0){let ea={...(((s=(a=this.usage_metadata)==null?void 0:a.input_token_details)==null?void 0:s.audio)!==void 0||((o=(i=e.usage_metadata)==null?void 0:i.input_token_details)==null?void 0:o.audio)!==void 0)&&{audio:((l=(c=(u=this.usage_metadata)==null?void 0:u.input_token_details)==null?void 0:c.audio)!=null?l:0)+((f=(h=(d=e.usage_metadata)==null?void 0:d.input_token_details)==null?void 0:h.audio)!=null?f:0)},...(((g=(p=this.usage_metadata)==null?void 0:p.input_token_details)==null?void 0:g.cache_read)!==void 0||((m=(y=e.usage_metadata)==null?void 0:y.input_token_details)==null?void 0:m.cache_read)!==void 0)&&{cache_read:((I=(A=(b=this.usage_metadata)==null?void 0:b.input_token_details)==null?void 0:A.cache_read)!=null?I:0)+((E=(v=(_=e.usage_metadata)==null?void 0:_.input_token_details)==null?void 0:v.cache_read)!=null?E:0)},...(((S=(O=this.usage_metadata)==null?void 0:O.input_token_details)==null?void 0:S.cache_creation)!==void 0||((q=(L=e.usage_metadata)==null?void 0:L.input_token_details)==null?void 0:q.cache_creation)!==void 0)&&{cache_creation:((Ie=(de=(V=this.usage_metadata)==null?void 0:V.input_token_details)==null?void 0:de.cache_creation)!=null?Ie:0)+(($e=(Qr=(ve=e.usage_metadata)==null?void 0:ve.input_token_details)==null?void 0:Qr.cache_creation)!=null?$e:0)}},wd={...(((fs=(hs=this.usage_metadata)==null?void 0:hs.output_token_details)==null?void 0:fs.audio)!==void 0||((ms=(ps=e.usage_metadata)==null?void 0:ps.output_token_details)==null?void 0:ms.audio)!==void 0)&&{audio:((ad=(Ai=(gs=this.usage_metadata)==null?void 0:gs.output_token_details)==null?void 0:Ai.audio)!=null?ad:0)+((od=(id=(sd=e.usage_metadata)==null?void 0:sd.output_token_details)==null?void 0:id.audio)!=null?od:0)},...(((cd=(ud=this.usage_metadata)==null?void 0:ud.output_token_details)==null?void 0:cd.reasoning)!==void 0||((dd=(ld=e.usage_metadata)==null?void 0:ld.output_token_details)==null?void 0:dd.reasoning)!==void 0)&&{reasoning:((pd=(fd=(hd=this.usage_metadata)==null?void 0:hd.output_token_details)==null?void 0:fd.reasoning)!=null?pd:0)+((yd=(gd=(md=e.usage_metadata)==null?void 0:md.output_token_details)==null?void 0:gd.reasoning)!=null?yd:0)}},Iu=(bd=this.usage_metadata)!=null?bd:{input_tokens:0,output_tokens:0,total_tokens:0},Pu=(_d=e.usage_metadata)!=null?_d:{input_tokens:0,output_tokens:0,total_tokens:0},jy={input_tokens:Iu.input_tokens+Pu.input_tokens,output_tokens:Iu.output_tokens+Pu.output_tokens,total_tokens:Iu.total_tokens+Pu.total_tokens,...Object.keys(ea).length>0&&{input_token_details:ea},...Object.keys(wd).length>0&&{output_token_details:wd}};t.usage_metadata=jy}return new n(t)}};var Ur=class n extends Be{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return n}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}get _printableFields(){return{...super._printableFields,role:this.role}}},wn=class n extends Ye{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){var t;return new n({content:yt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),role:this.role,id:(t=this.id)!=null?t:e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}};var vn=class n extends Ye{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){var t,r;return new n({content:yt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),name:(t=this.name)!=null?t:"",id:(r=this.id)!=null?r:e.id})}};var dt=class extends Be{static lc_name(){return"HumanMessage"}_getType(){return"human"}},An=class n extends Ye{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){var t;return new n({content:yt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),id:(t=this.id)!=null?t:e.id})}};var zr=class extends Be{static lc_name(){return"SystemMessage"}_getType(){return"system"}},Br=class n extends Ye{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){var t;return new n({content:yt(this.content,e.content),additional_kwargs:ye(this.additional_kwargs,e.additional_kwargs),response_metadata:ye(this.response_metadata,e.response_metadata),id:(t=this.id)!=null?t:e.id})}};function Ji(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function Fa(n){return!!(n&&typeof n=="object"&&"type"in n&&n.type==="tool_call")}var Ma=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}};function o_(n){return Fa(n)?n:typeof n.id=="string"&&n.type==="function"&&typeof n.function=="object"&&n.function!==null&&"arguments"in n.function&&typeof n.function.arguments=="string"&&"name"in n.function&&typeof n.function.name=="string"?{id:n.id,args:JSON.parse(n.function.arguments),name:n.function.name,type:"tool_call"}:n}function u_(n){return typeof n=="object"&&n!=null&&n.lc===1&&Array.isArray(n.id)&&n.kwargs!=null&&typeof n.kwargs=="object"}function bc(n){let e,t;if(u_(n)){let r=n.id.at(-1);r==="HumanMessage"||r==="HumanMessageChunk"?e="user":r==="AIMessage"||r==="AIMessageChunk"?e="assistant":r==="SystemMessage"||r==="SystemMessageChunk"?e="system":e="unknown",t=n.kwargs}else{let{type:r,...a}=n;e=r,t=a}if(e==="human"||e==="user")return new dt(t);if(e==="ai"||e==="assistant"){let{tool_calls:r,...a}=t;if(!Array.isArray(r))return new Qe(t);let s=r.map(o_);return new Qe({...a,tool_calls:s})}else{if(e==="system")return new zr(t);if(e==="developer")return new zr({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});if(e==="tool"&&"tool_call_id"in t)return new mr({...t,content:t.content,tool_call_id:t.tool_call_id,name:t.name});throw Ji(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(n,null,2)}`),"MESSAGE_COERCION_FAILURE")}}function En(n){if(typeof n=="string")return new dt(n);if(La(n))return n;if(Array.isArray(n)){let[e,t]=n;return bc({type:e,content:t})}else if(Nh(n)){let{role:e,...t}=n;return bc({...t,type:e})}else return bc(n)}function Fs(n,e="Human",t="AI"){let r=[];for(let a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);let i=a.name?`${a.name}, `:"",o=typeof a.content=="string"?a.content:JSON.stringify(a.content,null,2);r.push(`${s}: ${i}${o}`)}return r.join(`
`)}function _c(n){var t;let e=n._getType();if(e==="human")return new An({...n});if(e==="ai"){let r={...n};return"tool_calls"in r&&(r={...r,tool_call_chunks:(t=r.tool_calls)==null?void 0:t.map(a=>({...a,type:"tool_call_chunk",index:void 0,args:JSON.stringify(a.args)}))}),new Le({...r})}else{if(e==="system")return new Br({...n});if(e==="function")return new vn({...n});if(Ur.isInstance(n))return new wn({...n});throw new Error("Unknown message type.")}}var re;(function(n){n.assertEqual=a=>a;function e(a){}n.assertIs=e;function t(a){throw new Error}n.assertNever=t,n.arrayToEnum=a=>{let s={};for(let i of a)s[i]=i;return s},n.getValidEnumValues=a=>{let s=n.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),i={};for(let o of s)i[o]=a[o];return n.objectValues(i)},n.objectValues=a=>n.objectKeys(a).map(function(s){return a[s]}),n.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{let s=[];for(let i in a)Object.prototype.hasOwnProperty.call(a,i)&&s.push(i);return s},n.find=(a,s)=>{for(let i of a)if(s(i))return i},n.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&isFinite(a)&&Math.floor(a)===a;function r(a,s=" | "){return a.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}n.joinValues=r,n.jsonStringifyReplacer=(a,s)=>typeof s=="bigint"?s.toString():s})(re||(re={}));var vc;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(vc||(vc={}));var k=re.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),yr=n=>{switch(typeof n){case"undefined":return k.undefined;case"string":return k.string;case"number":return isNaN(n)?k.nan:k.number;case"boolean":return k.boolean;case"function":return k.function;case"bigint":return k.bigint;case"symbol":return k.symbol;case"object":return Array.isArray(n)?k.array:n===null?k.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?k.promise:typeof Map!="undefined"&&n instanceof Map?k.map:typeof Set!="undefined"&&n instanceof Set?k.set:typeof Date!="undefined"&&n instanceof Date?k.date:k.object;default:return k.unknown}},x=re.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),c_=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:"),ht=class n extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};let t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){let t=e||function(s){return s.message},r={_errors:[]},a=s=>{for(let i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(a);else if(i.code==="invalid_return_type")a(i.returnTypeError);else if(i.code==="invalid_arguments")a(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,u=0;for(;u<i.path.length;){let c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return a(this),r}static assert(e){if(!(e instanceof n))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,re.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){let t={},r=[];for(let a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}};ht.create=n=>new ht(n);var Ba=(n,e)=>{let t;switch(n.code){case x.invalid_type:n.received===k.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case x.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,re.jsonStringifyReplacer)}`;break;case x.unrecognized_keys:t=`Unrecognized key(s) in object: ${re.joinValues(n.keys,", ")}`;break;case x.invalid_union:t="Invalid input";break;case x.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${re.joinValues(n.options)}`;break;case x.invalid_enum_value:t=`Invalid enum value. Expected ${re.joinValues(n.options)}, received '${n.received}'`;break;case x.invalid_arguments:t="Invalid function arguments";break;case x.invalid_return_type:t="Invalid function return type";break;case x.invalid_date:t="Invalid date";break;case x.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:re.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case x.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case x.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case x.custom:t="Invalid input";break;case x.invalid_intersection_types:t="Intersection results could not be merged";break;case x.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case x.not_finite:t="Number must be finite";break;default:t=e.defaultError,re.assertNever(n)}return{message:t}},Fh=Ba;function l_(n){Fh=n}function Wi(){return Fh}var Xi=n=>{let{data:e,path:t,errorMaps:r,issueData:a}=n,s=[...t,...a.path||[]],i={...a,path:s};if(a.message!==void 0)return{...a,path:s,message:a.message};let o="",u=r.filter(c=>!!c).slice().reverse();for(let c of u)o=c(i,{data:e,defaultError:o}).message;return{...a,path:s,message:o}},d_=[];function T(n,e){let t=Wi(),r=Xi({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,t,t===Ba?void 0:Ba].filter(a=>!!a)});n.common.issues.push(r)}var De=class n{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let a of t){if(a.status==="aborted")return B;a.status==="dirty"&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let a of t){let s=await a.key,i=await a.value;r.push({key:s,value:i})}return n.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let a of t){let{key:s,value:i}=a;if(s.status==="aborted"||i.status==="aborted")return B;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value!="undefined"||a.alwaysSet)&&(r[s.value]=i.value)}return{status:e.value,value:r}}},B=Object.freeze({status:"aborted"}),za=n=>({status:"dirty",value:n}),qe=n=>({status:"valid",value:n}),Ac=n=>n.status==="aborted",Ec=n=>n.status==="dirty",On=n=>n.status==="valid",Bs=n=>typeof Promise!="undefined"&&n instanceof Promise;function Yi(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)}function Uh(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t}var j;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(j||(j={}));var Us,zs,bt=class{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},Dh=(n,e)=>{if(On(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new ht(n.common.issues);return this._error=t,this._error}}};function Z(n){if(!n)return{};let{errorMap:e,invalid_type_error:t,required_error:r,description:a}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(i,o)=>{var u,c;let{message:l}=n;return i.code==="invalid_enum_value"?{message:l!=null?l:o.defaultError}:typeof o.data=="undefined"?{message:(u=l!=null?l:r)!==null&&u!==void 0?u:o.defaultError}:i.code!=="invalid_type"?{message:o.defaultError}:{message:(c=l!=null?l:t)!==null&&c!==void 0?c:o.defaultError}},description:a}}var G=class{get description(){return this._def.description}_getType(e){return yr(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:yr(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new De,ctx:{common:e.parent.common,data:e.data,parsedType:yr(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(Bs(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;let a={common:{issues:[],async:(r=t==null?void 0:t.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:yr(e)},s=this._parseSync({data:e,path:a.path,parent:a});return Dh(a,s)}"~validate"(e){var t,r;let a={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:yr(e)};if(!this["~standard"].async)try{let s=this._parseSync({data:e,path:[],parent:a});return On(s)?{value:s.value}:{issues:a.common.issues}}catch(s){!((r=(t=s==null?void 0:s.message)===null||t===void 0?void 0:t.toLowerCase())===null||r===void 0)&&r.includes("encountered")&&(this["~standard"].async=!0),a.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:a}).then(s=>On(s)?{value:s.value}:{issues:a.common.issues})}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:yr(e)},a=this._parse({data:e,path:r.path,parent:r}),s=await(Bs(a)?a:Promise.resolve(a));return Dh(r,s)}refine(e,t){let r=a=>typeof t=="string"||typeof t=="undefined"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,s)=>{let i=e(a),o=()=>s.addIssue({code:x.custom,...r(a)});return typeof Promise!="undefined"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,a)=>e(r)?!0:(a.addIssue(typeof t=="function"?t(r,a):t),!1))}_refinement(e){return new ft({schema:this,typeName:w.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:t=>this["~validate"](t)}}optional(){return et.create(this,this._def)}nullable(){return rr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return _r.create(this)}promise(){return Hr.create(this,this._def)}or(e){return Cn.create([this,e],this._def)}and(e){return Rn.create(this,e,this._def)}transform(e){return new ft({...Z(this._def),schema:this,typeName:w.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new Dn({...Z(this._def),innerType:this,defaultValue:t,typeName:w.ZodDefault})}brand(){return new qs({typeName:w.ZodBranded,type:this,...Z(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new Mn({...Z(this._def),innerType:this,catchValue:t,typeName:w.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Vs.create(this,e)}readonly(){return Fn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},h_=/^c[^\s-]{8,}$/i,f_=/^[0-9a-z]+$/,p_=/^[0-9A-HJKMNP-TV-Z]{26}$/i,m_=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,g_=/^[a-z0-9_-]{21}$/i,y_=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,b_=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,__=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,w_="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",wc,v_=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,A_=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,E_=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,O_=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,x_=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,I_=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,zh="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",P_=new RegExp(`^${zh}$`);function Bh(n){let e="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return n.precision?e=`${e}\\.\\d{${n.precision}}`:n.precision==null&&(e=`${e}(\\.\\d+)?`),e}function T_(n){return new RegExp(`^${Bh(n)}$`)}function qh(n){let e=`${zh}T${Bh(n)}`,t=[];return t.push(n.local?"Z?":"Z"),n.offset&&t.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${t.join("|")})`,new RegExp(`^${e}$`)}function S_(n,e){return!!((e==="v4"||!e)&&v_.test(n)||(e==="v6"||!e)&&E_.test(n))}function k_(n,e){if(!y_.test(n))return!1;try{let[t]=n.split("."),r=t.replace(/-/g,"+").replace(/_/g,"/").padEnd(t.length+(4-t.length%4)%4,"="),a=JSON.parse(atob(r));return!(typeof a!="object"||a===null||!a.typ||!a.alg||e&&a.alg!==e)}catch(t){return!1}}function C_(n,e){return!!((e==="v4"||!e)&&A_.test(n)||(e==="v6"||!e)&&O_.test(n))}var qr=class n extends G{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==k.string){let s=this._getOrReturnCtx(e);return T(s,{code:x.invalid_type,expected:k.string,received:s.parsedType}),B}let r=new De,a;for(let s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:x.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="max")e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:x.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="length"){let i=e.data.length>s.value,o=e.data.length<s.value;(i||o)&&(a=this._getOrReturnCtx(e,a),i?T(a,{code:x.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&T(a,{code:x.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),r.dirty())}else if(s.kind==="email")__.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"email",code:x.invalid_string,message:s.message}),r.dirty());else if(s.kind==="emoji")wc||(wc=new RegExp(w_,"u")),wc.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"emoji",code:x.invalid_string,message:s.message}),r.dirty());else if(s.kind==="uuid")m_.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"uuid",code:x.invalid_string,message:s.message}),r.dirty());else if(s.kind==="nanoid")g_.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"nanoid",code:x.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid")h_.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"cuid",code:x.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid2")f_.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"cuid2",code:x.invalid_string,message:s.message}),r.dirty());else if(s.kind==="ulid")p_.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"ulid",code:x.invalid_string,message:s.message}),r.dirty());else if(s.kind==="url")try{new URL(e.data)}catch(i){a=this._getOrReturnCtx(e,a),T(a,{validation:"url",code:x.invalid_string,message:s.message}),r.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"regex",code:x.invalid_string,message:s.message}),r.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),T(a,{code:x.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),r.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),T(a,{code:x.invalid_string,validation:{startsWith:s.value},message:s.message}),r.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),T(a,{code:x.invalid_string,validation:{endsWith:s.value},message:s.message}),r.dirty()):s.kind==="datetime"?qh(s).test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{code:x.invalid_string,validation:"datetime",message:s.message}),r.dirty()):s.kind==="date"?P_.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{code:x.invalid_string,validation:"date",message:s.message}),r.dirty()):s.kind==="time"?T_(s).test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{code:x.invalid_string,validation:"time",message:s.message}),r.dirty()):s.kind==="duration"?b_.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"duration",code:x.invalid_string,message:s.message}),r.dirty()):s.kind==="ip"?S_(e.data,s.version)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"ip",code:x.invalid_string,message:s.message}),r.dirty()):s.kind==="jwt"?k_(e.data,s.alg)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"jwt",code:x.invalid_string,message:s.message}),r.dirty()):s.kind==="cidr"?C_(e.data,s.version)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"cidr",code:x.invalid_string,message:s.message}),r.dirty()):s.kind==="base64"?x_.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"base64",code:x.invalid_string,message:s.message}),r.dirty()):s.kind==="base64url"?I_.test(e.data)||(a=this._getOrReturnCtx(e,a),T(a,{validation:"base64url",code:x.invalid_string,message:s.message}),r.dirty()):re.assertNever(s);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(a=>e.test(a),{validation:t,code:x.invalid_string,...j.errToObj(r)})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...j.errToObj(e)})}url(e){return this._addCheck({kind:"url",...j.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...j.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...j.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...j.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...j.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...j.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...j.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...j.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...j.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...j.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...j.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...j.errToObj(e)})}datetime(e){var t,r;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)=="undefined"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,local:(r=e==null?void 0:e.local)!==null&&r!==void 0?r:!1,...j.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)=="undefined"?null:e==null?void 0:e.precision,...j.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...j.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...j.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...j.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...j.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...j.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...j.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...j.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...j.errToObj(t)})}nonempty(e){return this.min(1,j.errToObj(e))}trim(){return new n({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};qr.create=n=>{var e;return new qr({checks:[],typeName:w.ZodString,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...Z(n)})};function R_(n,e){let t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,a=t>r?t:r,s=parseInt(n.toFixed(a).replace(".","")),i=parseInt(e.toFixed(a).replace(".",""));return s%i/Math.pow(10,a)}var xn=class n extends G{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==k.number){let s=this._getOrReturnCtx(e);return T(s,{code:x.invalid_type,expected:k.number,received:s.parsedType}),B}let r,a=new De;for(let s of this._def.checks)s.kind==="int"?re.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{code:x.invalid_type,expected:"integer",received:"float",message:s.message}),a.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:x.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:x.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="multipleOf"?R_(e.data,s.value)!==0&&(r=this._getOrReturnCtx(e,r),T(r,{code:x.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),T(r,{code:x.not_finite,message:s.message}),a.dirty()):re.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,j.toString(t))}gt(e,t){return this.setLimit("min",e,!1,j.toString(t))}lte(e,t){return this.setLimit("max",e,!0,j.toString(t))}lt(e,t){return this.setLimit("max",e,!1,j.toString(t))}setLimit(e,t,r,a){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:j.toString(a)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:j.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:j.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:j.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:j.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:j.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:j.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:j.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:j.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:j.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&re.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}};xn.create=n=>new xn({checks:[],typeName:w.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...Z(n)});var In=class n extends G{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch(s){return this._getInvalidInput(e)}if(this._getType(e)!==k.bigint)return this._getInvalidInput(e);let r,a=new De;for(let s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:x.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),T(r,{code:x.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),T(r,{code:x.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):re.assertNever(s);return{status:a.value,value:e.data}}_getInvalidInput(e){let t=this._getOrReturnCtx(e);return T(t,{code:x.invalid_type,expected:k.bigint,received:t.parsedType}),B}gte(e,t){return this.setLimit("min",e,!0,j.toString(t))}gt(e,t){return this.setLimit("min",e,!1,j.toString(t))}lte(e,t){return this.setLimit("max",e,!0,j.toString(t))}lt(e,t){return this.setLimit("max",e,!1,j.toString(t))}setLimit(e,t,r,a){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:j.toString(a)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:j.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:j.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:j.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:j.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:j.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};In.create=n=>{var e;return new In({checks:[],typeName:w.ZodBigInt,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...Z(n)})};var Pn=class extends G{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==k.boolean){let r=this._getOrReturnCtx(e);return T(r,{code:x.invalid_type,expected:k.boolean,received:r.parsedType}),B}return qe(e.data)}};Pn.create=n=>new Pn({typeName:w.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...Z(n)});var Tn=class n extends G{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==k.date){let s=this._getOrReturnCtx(e);return T(s,{code:x.invalid_type,expected:k.date,received:s.parsedType}),B}if(isNaN(e.data.getTime())){let s=this._getOrReturnCtx(e);return T(s,{code:x.invalid_date}),B}let r=new De,a;for(let s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:x.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),r.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(a=this._getOrReturnCtx(e,a),T(a,{code:x.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),r.dirty()):re.assertNever(s);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:j.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:j.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}};Tn.create=n=>new Tn({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:w.ZodDate,...Z(n)});var qa=class extends G{_parse(e){if(this._getType(e)!==k.symbol){let r=this._getOrReturnCtx(e);return T(r,{code:x.invalid_type,expected:k.symbol,received:r.parsedType}),B}return qe(e.data)}};qa.create=n=>new qa({typeName:w.ZodSymbol,...Z(n)});var Sn=class extends G{_parse(e){if(this._getType(e)!==k.undefined){let r=this._getOrReturnCtx(e);return T(r,{code:x.invalid_type,expected:k.undefined,received:r.parsedType}),B}return qe(e.data)}};Sn.create=n=>new Sn({typeName:w.ZodUndefined,...Z(n)});var kn=class extends G{_parse(e){if(this._getType(e)!==k.null){let r=this._getOrReturnCtx(e);return T(r,{code:x.invalid_type,expected:k.null,received:r.parsedType}),B}return qe(e.data)}};kn.create=n=>new kn({typeName:w.ZodNull,...Z(n)});var Vr=class extends G{constructor(){super(...arguments),this._any=!0}_parse(e){return qe(e.data)}};Vr.create=n=>new Vr({typeName:w.ZodAny,...Z(n)});var br=class extends G{constructor(){super(...arguments),this._unknown=!0}_parse(e){return qe(e.data)}};br.create=n=>new br({typeName:w.ZodUnknown,...Z(n)});var jt=class extends G{_parse(e){let t=this._getOrReturnCtx(e);return T(t,{code:x.invalid_type,expected:k.never,received:t.parsedType}),B}};jt.create=n=>new jt({typeName:w.ZodNever,...Z(n)});var Va=class extends G{_parse(e){if(this._getType(e)!==k.undefined){let r=this._getOrReturnCtx(e);return T(r,{code:x.invalid_type,expected:k.void,received:r.parsedType}),B}return qe(e.data)}};Va.create=n=>new Va({typeName:w.ZodVoid,...Z(n)});var _r=class n extends G{_parse(e){let{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==k.array)return T(t,{code:x.invalid_type,expected:k.array,received:t.parsedType}),B;if(a.exactLength!==null){let i=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(i||o)&&(T(t,{code:i?x.too_big:x.too_small,minimum:o?a.exactLength.value:void 0,maximum:i?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(T(t,{code:x.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(T(t,{code:x.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>a.type._parseAsync(new bt(t,i,t.path,o)))).then(i=>De.mergeArray(r,i));let s=[...t.data].map((i,o)=>a.type._parseSync(new bt(t,i,t.path,o)));return De.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new n({...this._def,minLength:{value:e,message:j.toString(t)}})}max(e,t){return new n({...this._def,maxLength:{value:e,message:j.toString(t)}})}length(e,t){return new n({...this._def,exactLength:{value:e,message:j.toString(t)}})}nonempty(e){return this.min(1,e)}};_r.create=(n,e)=>new _r({type:n,minLength:null,maxLength:null,exactLength:null,typeName:w.ZodArray,...Z(e)});function Ua(n){if(n instanceof tt){let e={};for(let t in n.shape){let r=n.shape[t];e[t]=et.create(Ua(r))}return new tt({...n._def,shape:()=>e})}else return n instanceof _r?new _r({...n._def,type:Ua(n.element)}):n instanceof et?et.create(Ua(n.unwrap())):n instanceof rr?rr.create(Ua(n.unwrap())):n instanceof tr?tr.create(n.items.map(e=>Ua(e))):n}var tt=class n extends G{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),t=re.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==k.object){let c=this._getOrReturnCtx(e);return T(c,{code:x.invalid_type,expected:k.object,received:c.parsedType}),B}let{status:r,ctx:a}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof jt&&this._def.unknownKeys==="strip"))for(let c in a.data)i.includes(c)||o.push(c);let u=[];for(let c of i){let l=s[c],d=a.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new bt(a,d,a.path,c)),alwaysSet:c in a.data})}if(this._def.catchall instanceof jt){let c=this._def.unknownKeys;if(c==="passthrough")for(let l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:a.data[l]}});else if(c==="strict")o.length>0&&(T(a,{code:x.unrecognized_keys,keys:o}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let c=this._def.catchall;for(let l of o){let d=a.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new bt(a,d,a.path,l)),alwaysSet:l in a.data})}}return a.common.async?Promise.resolve().then(async()=>{let c=[];for(let l of u){let d=await l.key,h=await l.value;c.push({key:d,value:h,alwaysSet:l.alwaysSet})}return c}).then(c=>De.mergeObjectSync(r,c)):De.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return j.errToObj,new n({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,s,i,o;let u=(i=(s=(a=this._def).errorMap)===null||s===void 0?void 0:s.call(a,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=j.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new n({...this._def,unknownKeys:"strip"})}passthrough(){return new n({...this._def,unknownKeys:"passthrough"})}extend(e){return new n({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new n({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:w.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new n({...this._def,catchall:e})}pick(e){let t={};return re.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}omit(e){let t={};return re.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}deepPartial(){return Ua(this)}partial(e){let t={};return re.objectKeys(this.shape).forEach(r=>{let a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}),new n({...this._def,shape:()=>t})}required(e){let t={};return re.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let s=this.shape[r];for(;s instanceof et;)s=s._def.innerType;t[r]=s}}),new n({...this._def,shape:()=>t})}keyof(){return Vh(re.objectKeys(this.shape))}};tt.create=(n,e)=>new tt({shape:()=>n,unknownKeys:"strip",catchall:jt.create(),typeName:w.ZodObject,...Z(e)});tt.strictCreate=(n,e)=>new tt({shape:()=>n,unknownKeys:"strict",catchall:jt.create(),typeName:w.ZodObject,...Z(e)});tt.lazycreate=(n,e)=>new tt({shape:n,unknownKeys:"strip",catchall:jt.create(),typeName:w.ZodObject,...Z(e)});var Cn=class extends G{_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;function a(s){for(let o of s)if(o.result.status==="valid")return o.result;for(let o of s)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;let i=s.map(o=>new ht(o.ctx.common.issues));return T(t,{code:x.invalid_union,unionErrors:i}),B}if(t.common.async)return Promise.all(r.map(async s=>{let i={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(a);{let s,i=[];for(let u of r){let c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!s&&(s={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;let o=i.map(u=>new ht(u));return T(t,{code:x.invalid_union,unionErrors:o}),B}}get options(){return this._def.options}};Cn.create=(n,e)=>new Cn({options:n,typeName:w.ZodUnion,...Z(e)});var gr=n=>n instanceof Nn?gr(n.schema):n instanceof ft?gr(n.innerType()):n instanceof $n?[n.value]:n instanceof jn?n.options:n instanceof Ln?re.objectValues(n.enum):n instanceof Dn?gr(n._def.innerType):n instanceof Sn?[void 0]:n instanceof kn?[null]:n instanceof et?[void 0,...gr(n.unwrap())]:n instanceof rr?[null,...gr(n.unwrap())]:n instanceof qs||n instanceof Fn?gr(n.unwrap()):n instanceof Mn?gr(n._def.innerType):[],Qi=class n extends G{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==k.object)return T(t,{code:x.invalid_type,expected:k.object,received:t.parsedType}),B;let r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(T(t,{code:x.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),B)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let a=new Map;for(let s of t){let i=gr(s.shape[e]);if(!i.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let o of i){if(a.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);a.set(o,s)}}return new n({typeName:w.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...Z(r)})}};function Oc(n,e){let t=yr(n),r=yr(e);if(n===e)return{valid:!0,data:n};if(t===k.object&&r===k.object){let a=re.objectKeys(e),s=re.objectKeys(n).filter(o=>a.indexOf(o)!==-1),i={...n,...e};for(let o of s){let u=Oc(n[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===k.array&&r===k.array){if(n.length!==e.length)return{valid:!1};let a=[];for(let s=0;s<n.length;s++){let i=n[s],o=e[s],u=Oc(i,o);if(!u.valid)return{valid:!1};a.push(u.data)}return{valid:!0,data:a}}else return t===k.date&&r===k.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}var Rn=class extends G{_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=(s,i)=>{if(Ac(s)||Ac(i))return B;let o=Oc(s.value,i.value);return o.valid?((Ec(s)||Ec(i))&&t.dirty(),{status:t.value,value:o.data}):(T(r,{code:x.invalid_intersection_types}),B)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([s,i])=>a(s,i)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}};Rn.create=(n,e,t)=>new Rn({left:n,right:e,typeName:w.ZodIntersection,...Z(t)});var tr=class n extends G{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==k.array)return T(r,{code:x.invalid_type,expected:k.array,received:r.parsedType}),B;if(r.data.length<this._def.items.length)return T(r,{code:x.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),B;!this._def.rest&&r.data.length>this._def.items.length&&(T(r,{code:x.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let s=[...r.data].map((i,o)=>{let u=this._def.items[o]||this._def.rest;return u?u._parse(new bt(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(s).then(i=>De.mergeArray(t,i)):De.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new n({...this._def,rest:e})}};tr.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new tr({items:n,typeName:w.ZodTuple,rest:null,...Z(e)})};var eo=class n extends G{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==k.object)return T(r,{code:x.invalid_type,expected:k.object,received:r.parsedType}),B;let a=[],s=this._def.keyType,i=this._def.valueType;for(let o in r.data)a.push({key:s._parse(new bt(r,o,r.path,o)),value:i._parse(new bt(r,r.data[o],r.path,o)),alwaysSet:o in r.data});return r.common.async?De.mergeObjectAsync(t,a):De.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof G?new n({keyType:e,valueType:t,typeName:w.ZodRecord,...Z(r)}):new n({keyType:qr.create(),valueType:e,typeName:w.ZodRecord,...Z(t)})}},Ha=class extends G{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==k.map)return T(r,{code:x.invalid_type,expected:k.map,received:r.parsedType}),B;let a=this._def.keyType,s=this._def.valueType,i=[...r.data.entries()].map(([o,u],c)=>({key:a._parse(new bt(r,o,r.path,[c,"key"])),value:s._parse(new bt(r,u,r.path,[c,"value"]))}));if(r.common.async){let o=new Map;return Promise.resolve().then(async()=>{for(let u of i){let c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return B;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{let o=new Map;for(let u of i){let c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return B;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}};Ha.create=(n,e,t)=>new Ha({valueType:e,keyType:n,typeName:w.ZodMap,...Z(t)});var Za=class n extends G{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==k.set)return T(r,{code:x.invalid_type,expected:k.set,received:r.parsedType}),B;let a=this._def;a.minSize!==null&&r.data.size<a.minSize.value&&(T(r,{code:x.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&r.data.size>a.maxSize.value&&(T(r,{code:x.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());let s=this._def.valueType;function i(u){let c=new Set;for(let l of u){if(l.status==="aborted")return B;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}let o=[...r.data.values()].map((u,c)=>s._parse(new bt(r,u,r.path,c)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new n({...this._def,minSize:{value:e,message:j.toString(t)}})}max(e,t){return new n({...this._def,maxSize:{value:e,message:j.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}};Za.create=(n,e)=>new Za({valueType:n,minSize:null,maxSize:null,typeName:w.ZodSet,...Z(e)});var to=class n extends G{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==k.function)return T(t,{code:x.invalid_type,expected:k.function,received:t.parsedType}),B;function r(o,u){return Xi({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Wi(),Ba].filter(c=>!!c),issueData:{code:x.invalid_arguments,argumentsError:u}})}function a(o,u){return Xi({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Wi(),Ba].filter(c=>!!c),issueData:{code:x.invalid_return_type,returnTypeError:u}})}let s={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof Hr){let o=this;return qe(async function(...u){let c=new ht([]),l=await o._def.args.parseAsync(u,s).catch(f=>{throw c.addIssue(r(u,f)),c}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,s).catch(f=>{throw c.addIssue(a(d,f)),c})})}else{let o=this;return qe(function(...u){let c=o._def.args.safeParse(u,s);if(!c.success)throw new ht([r(u,c.error)]);let l=Reflect.apply(i,this,c.data),d=o._def.returns.safeParse(l,s);if(!d.success)throw new ht([a(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new n({...this._def,args:tr.create(e).rest(br.create())})}returns(e){return new n({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new n({args:e||tr.create([]).rest(br.create()),returns:t||br.create(),typeName:w.ZodFunction,...Z(r)})}},Nn=class extends G{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};Nn.create=(n,e)=>new Nn({getter:n,typeName:w.ZodLazy,...Z(e)});var $n=class extends G{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return T(t,{received:t.data,code:x.invalid_literal,expected:this._def.value}),B}return{status:"valid",value:e.data}}get value(){return this._def.value}};$n.create=(n,e)=>new $n({value:n,typeName:w.ZodLiteral,...Z(e)});function Vh(n,e){return new jn({values:n,typeName:w.ZodEnum,...Z(e)})}var jn=class n extends G{constructor(){super(...arguments),Us.set(this,void 0)}_parse(e){if(typeof e.data!="string"){let t=this._getOrReturnCtx(e),r=this._def.values;return T(t,{expected:re.joinValues(r),received:t.parsedType,code:x.invalid_type}),B}if(Yi(this,Us,"f")||Uh(this,Us,new Set(this._def.values),"f"),!Yi(this,Us,"f").has(e.data)){let t=this._getOrReturnCtx(e),r=this._def.values;return T(t,{received:t.data,code:x.invalid_enum_value,options:r}),B}return qe(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return n.create(e,{...this._def,...t})}exclude(e,t=this._def){return n.create(this.options.filter(r=>!e.includes(r)),{...this._def,...t})}};Us=new WeakMap;jn.create=Vh;var Ln=class extends G{constructor(){super(...arguments),zs.set(this,void 0)}_parse(e){let t=re.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==k.string&&r.parsedType!==k.number){let a=re.objectValues(t);return T(r,{expected:re.joinValues(a),received:r.parsedType,code:x.invalid_type}),B}if(Yi(this,zs,"f")||Uh(this,zs,new Set(re.getValidEnumValues(this._def.values)),"f"),!Yi(this,zs,"f").has(e.data)){let a=re.objectValues(t);return T(r,{received:r.data,code:x.invalid_enum_value,options:a}),B}return qe(e.data)}get enum(){return this._def.values}};zs=new WeakMap;Ln.create=(n,e)=>new Ln({values:n,typeName:w.ZodNativeEnum,...Z(e)});var Hr=class extends G{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==k.promise&&t.common.async===!1)return T(t,{code:x.invalid_type,expected:k.promise,received:t.parsedType}),B;let r=t.parsedType===k.promise?t.data:Promise.resolve(t.data);return qe(r.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}};Hr.create=(n,e)=>new Hr({type:n,typeName:w.ZodPromise,...Z(e)});var ft=class extends G{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===w.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:i=>{T(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),a.type==="preprocess"){let i=a.transform(r.data,s);if(r.common.async)return Promise.resolve(i).then(async o=>{if(t.value==="aborted")return B;let u=await this._def.schema._parseAsync({data:o,path:r.path,parent:r});return u.status==="aborted"?B:u.status==="dirty"||t.value==="dirty"?za(u.value):u});{if(t.value==="aborted")return B;let o=this._def.schema._parseSync({data:i,path:r.path,parent:r});return o.status==="aborted"?B:o.status==="dirty"||t.value==="dirty"?za(o.value):o}}if(a.type==="refinement"){let i=o=>{let u=a.refinement(o,s);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){let o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?B:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?B:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(r.common.async===!1){let i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!On(i))return i;let o=a.transform(i.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>On(i)?Promise.resolve(a.transform(i.value,s)).then(o=>({status:t.value,value:o})):i);re.assertNever(a)}};ft.create=(n,e,t)=>new ft({schema:n,typeName:w.ZodEffects,effect:e,...Z(t)});ft.createWithPreprocess=(n,e,t)=>new ft({schema:e,effect:{type:"preprocess",transform:n},typeName:w.ZodEffects,...Z(t)});var et=class extends G{_parse(e){return this._getType(e)===k.undefined?qe(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};et.create=(n,e)=>new et({innerType:n,typeName:w.ZodOptional,...Z(e)});var rr=class extends G{_parse(e){return this._getType(e)===k.null?qe(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};rr.create=(n,e)=>new rr({innerType:n,typeName:w.ZodNullable,...Z(e)});var Dn=class extends G{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===k.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};Dn.create=(n,e)=>new Dn({innerType:n,typeName:w.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...Z(e)});var Mn=class extends G{_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return Bs(a)?a.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new ht(r.common.issues)},input:r.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new ht(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}};Mn.create=(n,e)=>new Mn({innerType:n,typeName:w.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...Z(e)});var Ga=class extends G{_parse(e){if(this._getType(e)!==k.nan){let r=this._getOrReturnCtx(e);return T(r,{code:x.invalid_type,expected:k.nan,received:r.parsedType}),B}return{status:"valid",value:e.data}}};Ga.create=n=>new Ga({typeName:w.ZodNaN,...Z(n)});var N_=Symbol("zod_brand"),qs=class extends G{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}},Vs=class n extends G{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let s=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?B:s.status==="dirty"?(t.dirty(),za(s.value)):this._def.out._parseAsync({data:s.value,path:r.path,parent:r})})();{let a=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?B:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:r.path,parent:r})}}static create(e,t){return new n({in:e,out:t,typeName:w.ZodPipeline})}},Fn=class extends G{_parse(e){let t=this._def.innerType._parse(e),r=a=>(On(a)&&(a.value=Object.freeze(a.value)),a);return Bs(t)?t.then(a=>r(a)):r(t)}unwrap(){return this._def.innerType}};Fn.create=(n,e)=>new Fn({innerType:n,typeName:w.ZodReadonly,...Z(e)});function Hh(n,e={},t){return n?Vr.create().superRefine((r,a)=>{var s,i;if(!n(r)){let o=typeof e=="function"?e(r):typeof e=="string"?{message:e}:e,u=(i=(s=o.fatal)!==null&&s!==void 0?s:t)!==null&&i!==void 0?i:!0,c=typeof o=="string"?{message:o}:o;a.addIssue({code:"custom",...c,fatal:u})}}):Vr.create()}var $_={object:tt.lazycreate},w;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(w||(w={}));var j_=(n,e={message:`Input not instance of ${n.name}`})=>Hh(t=>t instanceof n,e),Zh=qr.create,Gh=xn.create,L_=Ga.create,D_=In.create,Kh=Pn.create,M_=Tn.create,F_=qa.create,U_=Sn.create,z_=kn.create,B_=Vr.create,q_=br.create,V_=jt.create,H_=Va.create,Z_=_r.create,G_=tt.create,K_=tt.strictCreate,J_=Cn.create,W_=Qi.create,X_=Rn.create,Y_=tr.create,Q_=eo.create,ew=Ha.create,tw=Za.create,rw=to.create,nw=Nn.create,aw=$n.create,sw=jn.create,iw=Ln.create,ow=Hr.create,Mh=ft.create,uw=et.create,cw=rr.create,lw=ft.createWithPreprocess,dw=Vs.create,hw=()=>Zh().optional(),fw=()=>Gh().optional(),pw=()=>Kh().optional(),mw={string:n=>qr.create({...n,coerce:!0}),number:n=>xn.create({...n,coerce:!0}),boolean:n=>Pn.create({...n,coerce:!0}),bigint:n=>In.create({...n,coerce:!0}),date:n=>Tn.create({...n,coerce:!0})},gw=B,_t=Object.freeze({__proto__:null,defaultErrorMap:Ba,setErrorMap:l_,getErrorMap:Wi,makeIssue:Xi,EMPTY_PATH:d_,addIssueToContext:T,ParseStatus:De,INVALID:B,DIRTY:za,OK:qe,isAborted:Ac,isDirty:Ec,isValid:On,isAsync:Bs,get util(){return re},get objectUtil(){return vc},ZodParsedType:k,getParsedType:yr,ZodType:G,datetimeRegex:qh,ZodString:qr,ZodNumber:xn,ZodBigInt:In,ZodBoolean:Pn,ZodDate:Tn,ZodSymbol:qa,ZodUndefined:Sn,ZodNull:kn,ZodAny:Vr,ZodUnknown:br,ZodNever:jt,ZodVoid:Va,ZodArray:_r,ZodObject:tt,ZodUnion:Cn,ZodDiscriminatedUnion:Qi,ZodIntersection:Rn,ZodTuple:tr,ZodRecord:eo,ZodMap:Ha,ZodSet:Za,ZodFunction:to,ZodLazy:Nn,ZodLiteral:$n,ZodEnum:jn,ZodNativeEnum:Ln,ZodPromise:Hr,ZodEffects:ft,ZodTransformer:ft,ZodOptional:et,ZodNullable:rr,ZodDefault:Dn,ZodCatch:Mn,ZodNaN:Ga,BRAND:N_,ZodBranded:qs,ZodPipeline:Vs,ZodReadonly:Fn,custom:Hh,Schema:G,ZodSchema:G,late:$_,get ZodFirstPartyTypeKind(){return w},coerce:mw,any:B_,array:Z_,bigint:D_,boolean:Kh,date:M_,discriminatedUnion:W_,effect:Mh,enum:sw,function:rw,instanceof:j_,intersection:X_,lazy:nw,literal:aw,map:ew,nan:L_,nativeEnum:iw,never:V_,null:z_,nullable:cw,number:Gh,object:G_,oboolean:pw,onumber:fw,optional:uw,ostring:hw,pipeline:dw,preprocess:lw,promise:ow,record:Q_,set:tw,strictObject:K_,string:Zh,symbol:F_,transformer:Mh,tuple:Y_,undefined:U_,union:J_,unknown:q_,void:H_,NEVER:gw,ZodIssueCode:x,quotelessJson:c_,ZodError:ht});var Cl=pt(ao(),1);var tf=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Aw(n){return typeof n=="string"&&tf.test(n)}var Zr=Aw;var Ce=[];for(so=0;so<256;++so)Ce.push((so+256).toString(16).slice(1));var so;function rf(n,e=0){return(Ce[n[e+0]]+Ce[n[e+1]]+Ce[n[e+2]]+Ce[n[e+3]]+"-"+Ce[n[e+4]]+Ce[n[e+5]]+"-"+Ce[n[e+6]]+Ce[n[e+7]]+"-"+Ce[n[e+8]]+Ce[n[e+9]]+"-"+Ce[n[e+10]]+Ce[n[e+11]]+Ce[n[e+12]]+Ce[n[e+13]]+Ce[n[e+14]]+Ce[n[e+15]]).toLowerCase()}var io,Ew=new Uint8Array(16);function xc(){if(!io&&(io=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!io))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return io(Ew)}var Ow=typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ic={randomUUID:Ow};function xw(n,e,t){if(Ic.randomUUID&&!e&&!n)return Ic.randomUUID();n=n||{};var r=n.random||(n.rng||xc)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(var a=0;a<16;++a)e[t+a]=r[a];return e}return rf(r)}var pe=xw;var ff=pt(ao(),1),po=pt(fo(),1);var $w=(...n)=>fetch(...n),jw=Symbol.for("ls:fetch_implementation");var D=()=>{var n;return(n=globalThis[jw])!=null?n:$w};var Lw=[400,401,403,404,405,406,407,408],Dw=[409],Zs=class{constructor(e){var t,r;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(t=e.maxConcurrency)!=null?t:1/0,this.maxRetries=(r=e.maxRetries)!=null?r:6,"default"in po.default?this.queue=new po.default.default({concurrency:this.maxConcurrency}):this.queue=new po.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>(0,ff.default)(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||(a==null?void 0:a.code)==="ECONNABORTED")throw a;let s=a==null?void 0:a.response,i=s==null?void 0:s.status;if(i){if(Lw.includes(+i))throw a;if(Dw.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>D()(...e).then(t=>t.ok?t:Promise.reject(t)))}};function Nc(n){return typeof(n==null?void 0:n._getType)=="function"}function $c(n){let e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}function Y(n,e){if(!Zr(n)){let t=e!==void 0?`Invalid UUID for ${e}: ${n}`:`Invalid UUID: ${n}`;throw new Error(t)}return n}var pf={};function mo(n){pf[n]||(console.warn(n),pf[n]=!0)}var RA=pt(sm(),1);function vr(n){if(!n||n.split("/").length>2||n.startsWith("/")||n.endsWith("/")||n.split(":").length>2)throw new Error(`Invalid identifier format: ${n}`);let[e,t]=n.split(":"),r=t||"latest";if(e.includes("/")){let[a,s]=e.split("/",2);if(!a||!s)throw new Error(`Invalid identifier format: ${n}`);return[a,s,r]}else{if(!e)throw new Error(`Invalid identifier format: ${n}`);return["-",e,r]}}var Qc=class extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}};async function X(n,e,t){let r;if(n.ok){t&&(r=await n.text());return}r=await n.text();let a=`Failed to ${e}. Received status [${n.status}]: ${n.statusText}. Server response: ${r}`;throw n.status===409?new Qc(a):new Error(a)}var im="[...]",NA={result:"[Circular]"},Io=[],Wa=[];function $A(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function nt(n,e,t,r){var i;try{return JSON.stringify(n,e,t)}catch(o){if(!((i=o.message)!=null&&i.includes("Converting circular structure to JSON")))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),typeof r=="undefined"&&(r=$A()),tl(n,"",0,[],void 0,0,r);var a;try{Wa.length===0?a=JSON.stringify(n,e,t):a=JSON.stringify(n,jA(e),t)}catch(u){return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;Io.length!==0;){var s=Io.pop();s.length===4?Object.defineProperty(s[0],s[1],s[3]):s[0][s[1]]=s[2]}}return a}}function el(n,e,t,r){var a=Object.getOwnPropertyDescriptor(r,t);a.get!==void 0?a.configurable?(Object.defineProperty(r,t,{value:n}),Io.push([r,t,e,a])):Wa.push([e,t,n]):(r[t]=n,Io.push([r,t,e]))}function tl(n,e,t,r,a,s,i){s+=1;var o;if(typeof n=="object"&&n!==null){for(o=0;o<r.length;o++)if(r[o]===n){el(NA,n,e,a);return}if(typeof i.depthLimit!="undefined"&&s>i.depthLimit){el(im,n,e,a);return}if(typeof i.edgesLimit!="undefined"&&t+1>i.edgesLimit){el(im,n,e,a);return}if(r.push(n),Array.isArray(n))for(o=0;o<n.length;o++)tl(n[o],o,o,r,n,s,i);else{var u=Object.keys(n);for(o=0;o<u.length;o++){var c=u[o];tl(n[c],c,o,r,n,s,i)}}r.pop()}}function jA(n){return n=typeof n!="undefined"?n:function(e,t){return t},function(e,t){if(Wa.length>0)for(var r=0;r<Wa.length;r++){var a=Wa[r];if(a[1]===e&&a[0]===t){t=a[2],Wa.splice(r,1);break}}return n.call(this,e,t)}}function om(n){var s,i;let e=To(),t=um(),r=(s=n.extra)!=null?s:{},a=r.metadata;return n.extra={...r,runtime:{...e,...r==null?void 0:r.runtime},metadata:{...t,...t.revision_id||n.revision_id?{revision_id:(i=n.revision_id)!=null?i:t.revision_id}:{},...a}},n}var LA=()=>{let n=Ar("TRACING_SAMPLING_RATE");if(n===void 0)return;let e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},DA=n=>{let t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"};async function MA(n){let e=[];for await(let t of n)e.push(t);return e}function rl(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}var FA=async n=>{var e;if((n==null?void 0:n.status)===429){let t=parseInt((e=n.headers.get("retry-after"))!=null?e:"30",10)*1e3;if(t>0)return await new Promise(r=>setTimeout(r,t)),!0}return!1},nl=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t,r=new Promise(s=>{t=s}),a=nt(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:r,size:a}),this.sizeBytes+=a,r}pop(e){var a,s;if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");let t=[],r=0;for(;r+((s=(a=this.peek())==null?void 0:a.size)!=null?s:0)<e&&this.items.length>0;){let i=this.items.shift();i&&(t.push(i),r+=i.size,this.sizeBytes-=i.size)}if(t.length===0&&this.items.length>0){let i=this.items.shift();t.push(i),r+=i.size,this.sizeBytes-=i.size}return[t.map(i=>({action:i.action,item:i.payload})),()=>t.forEach(i=>i.itemPromiseResolve())]}},UA=20971520,zA=2500,Bn=class n{constructor(e={}){var r,a,s,i,o,u,c,l,d,h,f,p,g,y,m,b;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new nl}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:nr("LANGSMITH_TRACING_BACKGROUND")==="false"}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1});let t=n.getDefaultClientConfig();if(this.tracingSampleRate=LA(),this.apiUrl=(a=rl((r=e.apiUrl)!=null?r:t.apiUrl))!=null?a:"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=rl((s=e.apiKey)!=null?s:t.apiKey),this.webUrl=rl((i=e.webUrl)!=null?i:t.webUrl),(o=this.webUrl)!=null&&o.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=(u=e.timeout_ms)!=null?u:9e4,this.caller=new Zs((c=e.callerOptions)!=null?c:{}),this.traceBatchConcurrency=(l=e.traceBatchConcurrency)!=null?l:this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.batchIngestCaller=new Zs({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...(d=e.callerOptions)!=null?d:{},onFailedResponseHook:FA}),this.hideInputs=(f=(h=e.hideInputs)!=null?h:e.anonymizer)!=null?f:t.hideInputs,this.hideOutputs=(g=(p=e.hideOutputs)!=null?p:e.anonymizer)!=null?g:t.hideOutputs,this.autoBatchTracing=(y=e.autoBatchTracing)!=null?y:this.autoBatchTracing,this.blockOnRootRunFinalization=(m=e.blockOnRootRunFinalization)!=null?m:this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=(b=e.manualFlushMode)!=null?b:this.manualFlushMode}static getDefaultClientConfig(){var s;let e=Ar("API_KEY"),t=(s=Ar("ENDPOINT"))!=null?s:"https://api.smith.langchain.com",r=Ar("HIDE_INPUTS")==="true",a=Ar("HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:DA(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){let e={"User-Agent":`langsmith-js/${Po}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){var i;let r=(i=t==null?void 0:t.toString())!=null?i:"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(D(),a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(s,`Failed to fetch ${e}`),s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let a=Number(t.get("offset"))||0,s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(s));let i=`${this.apiUrl}${e}?${t}`,o=await this.caller.call(D(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(o,`Failed to fetch ${e}`);let u=r?r(await o.json()):await o.json();if(u.length===0||(yield u,u.length<s))break;a+=u.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let s=t?{...t}:{};for(;;){let o=await(await this.caller.call(D(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];let u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let r=[];for(let a of e)this.filteredPostUuids.has(a.id)?this.filteredPostUuids.delete(a.id):r.push(a);return r}else{let r=[];for(let a of e)a.id!==a.trace_id&&!this.filteredPostUuids.has(a.trace_id)||Math.random()<this.tracingSampleRate?r.push(a):this.filteredPostUuids.add(a.id);return r}}async _getBatchSizeLimitBytes(){var t,r,a;let e=await this._ensureServerInfo();return(a=(r=this.batchSizeBytesLimit)!=null?r:(t=e.batch_ingest_config)==null?void 0:t.size_limit_bytes)!=null?a:UA}async _getMultiPartSupport(){var t,r;return(r=(t=(await this._ensureServerInfo()).instance_flags)==null?void 0:t.dataset_examples_multipart_enabled)!=null?r:!1}drainAutoBatchQueue(e){let t=[];for(;this.autoBatchQueue.items.length>0;){let[r,a]=this.autoBatchQueue.pop(e);if(!r.length){a();break}let s=this._processBatch(r,a).catch(console.error);t.push(s)}return Promise.all(t)}async _processBatch(e,t){var r;if(!e.length){t();return}try{let a={runCreates:e.filter(i=>i.action==="create").map(i=>i.item),runUpdates:e.filter(i=>i.action==="update").map(i=>i.item)},s=await this._ensureServerInfo();(r=s==null?void 0:s.batch_ingest_config)!=null&&r.use_multipart_endpoint?await this.multipartIngestRuns(a):await this.batchIngestRuns(a)}finally{t()}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.action==="create"&&(e.item=om(e.item));let t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;let r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){let e=await D()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(zA),...this.fetchOptions});return await X(e,"get server info"),e.json()}async _ensureServerInfo(){return this._getServerInfoPromise===void 0&&(this._getServerInfoPromise=(async()=>{var e;if(this._serverInfo===void 0)try{this._serverInfo=await this._getServerInfo()}catch(t){console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to batch operations and default limits.")}return(e=this._serverInfo)!=null?e:{}})()),this._getServerInfoPromise.then(e=>(this._serverInfo===void 0&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){let e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){var o;if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;let a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:(o=e.start_time)!=null?o:Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}let s=om(a),i=await this.caller.call(D(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:nt(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){var o,u;if(e===void 0&&t===void 0)return;let r=(o=e==null?void 0:e.map(c=>this.prepareRunCreateOrUpdateInputs(c)))!=null?o:[],a=(u=t==null?void 0:t.map(c=>this.prepareRunCreateOrUpdateInputs(c)))!=null?u:[];if(r.length>0&&a.length>0){let c=r.reduce((d,h)=>(h.id&&(d[h.id]=h),d),{}),l=[];for(let d of a)d.id!==void 0&&c[d.id]?c[d.id]={...c[d.id],...d}:l.push(d);r=Object.values(c),a=l}let s={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!s.post.length&&!s.patch.length)return;let i={post:[],patch:[]};for(let c of["post","patch"]){let l=c,d=s[l].reverse(),h=d.pop();for(;h!==void 0;)i[l].push(h),h=d.pop()}(i.post.length>0||i.patch.length>0)&&await this._postBatchIngestRuns(nt(i))}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(D(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(e===void 0&&t===void 0)return;let r={},a=[];for(let l of e!=null?e:[]){let d=this.prepareRunCreateOrUpdateInputs(l);d.id!==void 0&&d.attachments!==void 0&&(r[d.id]=d.attachments),delete d.attachments,a.push(d)}let s=[];for(let l of t!=null?t:[])s.push(this.prepareRunCreateOrUpdateInputs(l));if(a.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(s.find(l=>l.trace_id===void 0||l.dotted_order===void 0)!==void 0)throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&s.length>0){let l=a.reduce((h,f)=>(f.id&&(h[f.id]=f),h),{}),d=[];for(let h of s)h.id!==void 0&&l[h.id]?l[h.id]={...l[h.id],...h}:d.push(h);a=Object.values(l),s=d}if(a.length===0&&s.length===0)return;let u=[],c=[];for(let[l,d]of[["post",a],["patch",s]])for(let h of d){let{inputs:f,outputs:p,events:g,attachments:y,...m}=h,b={inputs:f,outputs:p,events:g},A=nt(m);c.push({name:`${l}.${m.id}`,payload:new Blob([A],{type:`application/json; length=${A.length}`})});for(let[I,_]of Object.entries(b)){if(_===void 0)continue;let v=nt(_);c.push({name:`${l}.${m.id}.${I}`,payload:new Blob([v],{type:`application/json; length=${v.length}`})})}if(m.id!==void 0){let I=r[m.id];if(I){delete r[m.id];for(let[_,v]of Object.entries(I)){let E,O;if(Array.isArray(v)?[E,O]=v:(E=v.mimeType,O=v.data),_.includes(".")){console.warn(`Skipping attachment '${_}' for run ${m.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}c.push({name:`attachment.${m.id}.${_}`,payload:new Blob([O],{type:`${E}; length=${O.byteLength}`})})}}}u.push(`trace=${m.trace_id},id=${m.id}`)}await this._sendMultipartRequest(c,u.join("; "))}async _sendMultipartRequest(e,t){try{let r="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=[];for(let u of e)a.push(new Blob([`--${r}\r
`])),a.push(new Blob([`Content-Disposition: form-data; name="${u.name}"\r
`,`Content-Type: ${u.payload.type}\r
\r
`])),a.push(u.payload),a.push(new Blob([`\r
`]));a.push(new Blob([`--${r}--\r
`]));let i=await new Blob(a).arrayBuffer(),o=await this.batchIngestCaller.call(D(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${r}`},body:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(o,"ingest multipart runs",!0)}catch(r){console.warn(`${r.message.trim()}

Context: ${t}`)}}async updateRun(e,t){Y(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));let r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0&&this.blockOnRootRunFinalization&&!this.manualFlushMode){await this.processRunOperation({action:"update",item:r}).catch(console.error);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}let a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(D(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:nt(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(s,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Y(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r!=null&&r.projectName?a=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?a=r==null?void 0:r.projectId:a=(await this.readProject({projectName:Ar("PROJECT")||"default"})).id;let s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){let a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await MA(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>{var o,u;return((o=s==null?void 0:s.dotted_order)!=null?o:"").localeCompare((u=i==null?void 0:i.dotted_order)!=null?u:"")});for(let s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(let s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){let{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,isRoot:c,runType:l,error:d,id:h,query:f,filter:p,traceFilter:g,treeFilter:y,limit:m,select:b}=e,A=[];if(t&&(A=Array.isArray(t)?t:[t]),r){let E=Array.isArray(r)?r:[r],O=await Promise.all(E.map(S=>this.readProject({projectName:S}).then(L=>L.id)));A.push(...O)}let I=["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],_={session:A.length?A:null,run_type:l,reference_example:i,query:f,filter:p,trace_filter:g,tree_filter:y,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:d,id:h,limit:m,trace:s,select:b||I,is_root:c},v=0;for await(let E of this._getCursorPaginatedList("/runs/query",_))if(m){if(v>=m)break;if(E.length+v>m){yield*E.slice(0,m-v);break}v+=E.length,yield*E}else yield*E}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:s,projectIds:i,referenceExampleIds:o,startTime:u,endTime:c,error:l,query:d,filter:h,traceFilter:f,treeFilter:p,isRoot:g,dataSourceType:y}){let m=i||[];s&&(m=[...i||[],...await Promise.all(s.map(v=>this.readProject({projectName:v}).then(E=>E.id)))]);let A=Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:m,reference_example:o,start_time:u,end_time:c,error:l,query:d,filter:h,trace_filter:f,tree_filter:p,is_root:g,data_source_type:y}).filter(([v,E])=>E!==void 0));return await(await this.caller.call(D(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(A),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||pe()};Y(e);let s=await(await this.caller.call(D(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){Y(e);let t=await this.caller.call(D(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(t,"unshare run",!0)}async readRunSharedLink(e){Y(e);let r=await(await this.caller.call(D(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(t!==void 0)for(let i of t)r.append("id",i);return Y(e),await(await this.caller.call(D(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),Y(e);let a=await(await this.caller.call(D(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};Y(e);let s=await(await this.caller.call(D(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){Y(e);let t=await this.caller.call(D(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(t,"unshare dataset",!0)}async readSharedDataset(e){return Y(e),await(await this.caller.call(D(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async listSharedExamples(e,t){let r={};t!=null&&t.exampleIds&&(r.id=t.exampleIds);let a=new URLSearchParams;Object.entries(r).forEach(([o,u])=>{Array.isArray(u)?u.forEach(c=>a.append(o,c)):a.append(o,u)});let s=await this.caller.call(D(),`${this.apiUrl}/public/${e}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await s.json();if(!s.ok)throw"detail"in i?new Error(`Failed to list shared examples.
Status: ${s.status}
Message: ${i.detail.join(`
`)}`):new Error(`Failed to list shared examples: ${s.status} ${s.statusText}`);return i.map(o=>({...o,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){let o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=s||{};r&&(c.metadata=r);let l={name:e,extra:c,description:t};i!==null&&(l.reference_dataset_id=i);let d=await this.caller.call(D(),u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(d,"create project"),await d.json()}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){let o=`${this.apiUrl}/sessions/${e}`,u=s;a&&(u={...u||{},metadata:a});let c={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(D(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(l,"update project"),await l.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions",a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Y(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");let s=await this.caller.call(D(),`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch(i){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions",s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)Y(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());let i=await this._get(a,s),o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async getProjectUrl({projectId:e,projectName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(e===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i,metadata:o}={}){let u=new URLSearchParams;if(e!==void 0)for(let c of e)u.append("id",c);if(t!==void 0&&u.append("name",t),r!==void 0&&u.append("name_contains",r),a!==void 0)u.append("reference_dataset",a);else if(s!==void 0){let c=await this.readDataset({datasetName:s});u.append("reference_dataset",c.id)}i!==void 0&&u.append("reference_free",i.toString()),o!==void 0&&u.append("metadata",JSON.stringify(o));for await(let c of this._getPaginated("/sessions",u))yield*c}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,Y(r);let a=await this.caller.call(D(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(a,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){let u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach(h=>{c.append("input_keys",h)}),a.forEach(h=>{c.append("output_keys",h)}),s&&c.append("description",s),i&&c.append("data_type",i),o&&c.append("name",o);let l=await this.caller.call(D(),u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(l,"upload CSV"),await l.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:a,outputsSchema:s,metadata:i}={}){let o={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),a&&(o.inputs_schema_definition=a),s&&(o.outputs_schema_definition=s);let u=await this.caller.call(D(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(u,"create dataset"),await u.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets",a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)Y(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");let s=await this._get(r,a),i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(r){if(r instanceof Error&&r.message.toLocaleLowerCase().includes("not found"))return!1;throw r}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);let i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s,metadata:i}={}){let o="/datasets",u=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(let c of r)u.append("id",c);a!==void 0&&u.append("name",a),s!==void 0&&u.append("name_contains",s),i!==void 0&&u.append("metadata",JSON.stringify(i));for await(let c of this._getPaginated(o,u))yield*c}async updateDataset(e){let{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");let s=t!=null?t:(await this.readDataset({datasetName:r})).id;Y(s);let i=await this.caller.call(D(),`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(i,"update dataset"),await i.json()}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)Y(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");let s=await this.caller.call(D(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(s,`delete ${r}`),await s.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let a=e;if(!a&&!t)throw new Error("Must provide either datasetName or datasetId");if(a&&t)throw new Error("Must provide either datasetName or datasetId, not both");a||(a=(await this.readDataset({datasetName:t})).id),Y(a);let s={tag:r},i=await this.caller.call(D(),`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(i,"index dataset"),await i.json()}async similarExamples(e,t,r,{filter:a}={}){let s={limit:r,inputs:e};a!==void 0&&(s.filter=a),Y(t);let i=await this.caller.call(D(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(i,"fetch similar examples"),(await i.json()).examples}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:s,exampleId:i,metadata:o,split:u,sourceRunId:c}){let l=r;if(l===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(l!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");l===void 0&&(l=(await this.readDataset({datasetName:a})).id);let d=s||new Date,h={dataset_id:l,inputs:e,outputs:t,created_at:d==null?void 0:d.toISOString(),id:i,metadata:o,split:u,source_run_id:c},f=await this.caller.call(D(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(h),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(f,"create example"),await f.json()}async createExamples(e){let{inputs:t,outputs:r,metadata:a,sourceRunIds:s,exampleIds:i,datasetId:o,datasetName:u}=e,c=o;if(c===void 0&&u===void 0)throw new Error("Must provide either datasetName or datasetId");if(c!==void 0&&u!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");c===void 0&&(c=(await this.readDataset({datasetName:u})).id);let l=t.map((f,p)=>({dataset_id:c,inputs:f,outputs:r?r[p]:void 0,metadata:a?a[p]:void 0,split:e.splits?e.splits[p]:void 0,id:i?i[p]:void 0,source_run_id:s?s[p]:void 0})),d=await this.caller.call(D(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(d,"create examples"),await d.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let a=e.map(i=>Nc(i)?$c(i):i),s=Nc(t)?$c(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){Y(e);let t=`/examples/${e}`,r=await this._get(t),{attachment_urls:a,...s}=r,i=s;return a&&(i.attachments=Object.entries(a).reduce((o,[u,c])=>(o[u.slice(11)]={presigned_url:c.presigned_url},o),{})),i}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:s,inlineS3Urls:i,metadata:o,limit:u,offset:c,filter:l,includeAttachments:d}={}){let h;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)h=e;else if(t!==void 0)h=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let f=new URLSearchParams({dataset:h}),p=a?typeof a=="string"?a:a==null?void 0:a.toISOString():void 0;p&&f.append("as_of",p);let g=i!=null?i:!0;if(f.append("inline_s3_urls",g.toString()),r!==void 0)for(let m of r)f.append("id",m);if(s!==void 0)for(let m of s)f.append("splits",m);if(o!==void 0){let m=JSON.stringify(o);f.append("metadata",m)}u!==void 0&&f.append("limit",u.toString()),c!==void 0&&f.append("offset",c.toString()),l!==void 0&&f.append("filter",l),d===!0&&["attachment_urls","outputs","metadata"].forEach(m=>f.append("select",m));let y=0;for await(let m of this._getPaginated("/examples",f)){for(let b of m){let{attachment_urls:A,...I}=b,_=I;A&&(_.attachments=Object.entries(A).reduce((v,[E,O])=>(v[E.slice(11)]={presigned_url:O.presigned_url},v),{})),yield _,y++}if(u!==void 0&&y>=u)break}}async deleteExample(e){Y(e);let t=`/examples/${e}`,r=await this.caller.call(D(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(r,`delete ${t}`),await r.json()}async updateExample(e,t){Y(e);let r=await this.caller.call(D(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(r,"update example"),await r.json()}async updateExamples(e){let t=await this.caller.call(D(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(t,"update examples"),await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?a=(await this.readDataset({datasetName:t})).id:a=e,Y(a);let s=new URLSearchParams,i=r?typeof r=="string"?r:r==null?void 0:r.toISOString():void 0;return i&&s.append("as_of",i),await this._get(`/datasets/${a}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:s=!1}){let i;if(e===void 0&&t===void 0)throw new Error("Must provide dataset name or ID");if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");e===void 0?i=(await this.readDataset({datasetName:t})).id:i=e,Y(i);let o={split_name:r,examples:a.map(c=>(Y(c),c)),remove:s},u=await this.caller.call(D(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(u,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){mo("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead.");let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));let o=await t.evaluateRun(i,s),[u,c]=await this._logEvaluationFeedback(o,i,r);return c[0]}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:d,projectId:h,comparativeExperimentId:f}){var b;if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");let p={type:u!=null?u:"api",metadata:o!=null?o:{}};c!==void 0&&(p==null?void 0:p.metadata)!==void 0&&!p.metadata.__run&&(p.metadata.__run={run_id:c}),(p==null?void 0:p.metadata)!==void 0&&((b=p.metadata.__run)==null?void 0:b.run_id)!==void 0&&Y(p.metadata.__run.run_id);let g={id:l!=null?l:pe(),run_id:e,key:t,score:r,value:a,correction:s,comment:i,feedback_source:p,comparative_experiment_id:f,feedbackConfig:d,session_id:h},y=`${this.apiUrl}/feedback`,m=await this.caller.call(D(),y,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(g),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(m,"create feedback",!0),g}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){let i={};t!=null&&(i.score=t),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),Y(e);let o=await this.caller.call(D(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(o,"update feedback",!0)}async readFeedback(e){Y(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Y(e);let t=`/feedback/${e}`,r=await this.caller.call(D(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(r,`delete ${t}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(let s of t)a.append("key",s);if(r)for(let s of r)a.append("source",s);for await(let s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){let s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(D(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:s,metadata:i,id:o}){var l;if(t.length===0)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),!r==null)throw new Error("A reference dataset is required");let u={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:s,created_at:(l=a!=null?a:new Date)==null?void 0:l.toISOString(),extra:{}};return i&&(u.extra.metadata=i),await(await this.caller.call(D(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){Y(e);let t=new URLSearchParams({run_id:e});for await(let r of this._getPaginated("/feedback/tokens",t))yield*r}_selectEvalResults(e){let t;return"results"in e?t=e.results:t=[e],t}async _logEvaluationFeedback(e,t,r){let a=this._selectEvalResults(e),s=[];for(let i of a){let o=r||{};i.evaluatorInfo&&(o={...i.evaluatorInfo,...o});let u=null;i.targetRunId?u=i.targetRunId:t&&(u=t.id),s.push(await this.createFeedback(u,i.key,{score:i.score,value:i.value,comment:i.comment,correction:i.correction,sourceInfo:o,sourceRunId:i.sourceRunId,feedbackConfig:i.feedbackConfig,feedbackSourceType:"model"}))}return[a,s]}async logEvaluationFeedback(e,t,r){let[a]=await this._logEvaluationFeedback(e,t,r);return a}async*listAnnotationQueues(e={}){let{queueIds:t,name:r,nameContains:a,limit:s}=e,i=new URLSearchParams;t&&t.forEach((u,c)=>{Y(u,`queueIds[${c}]`),i.append("ids",u)}),r&&i.append("name",r),a&&i.append("name_contains",a),i.append("limit",(s!==void 0?Math.min(s,100):100).toString());let o=0;for await(let u of this._getPaginated("/annotation-queues",i))if(yield*u,o++,s!==void 0&&o>=s)break}async createAnnotationQueue(e){let{name:t,description:r,queueId:a}=e,s={name:t,description:r,id:a||pe()},i=await this.caller.call(D(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(s).filter(([u,c])=>c!==void 0))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(i,"create annotation queue"),await i.json()}async readAnnotationQueue(e){let t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){let{name:r,description:a}=t,s=await this.caller.call(D(),`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:a}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(s,"update annotation queue")}async deleteAnnotationQueue(e){let t=await this.caller.call(D(),`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){let r=await this.caller.call(D(),`${this.apiUrl}/annotation-queues/${Y(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map((a,s)=>Y(a,`runIds[${s}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){let r=`/annotation-queues/${Y(e,"queueId")}/run`,a=await this.caller.call(D(),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(a,"get run from annotation queue"),await a.json()}async _currentTenantIsOwner(e){let t=await this._getSettings();return e=="-"||t.tenant_handle===e}async _ownerConflictError(e,t){let r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){let t=await this.caller.call(D(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){let a=typeof r.detail=="string"?r.detail:JSON.stringify(r.detail),s=new Error(`Error ${t.status}: ${t.statusText}
${a}`);throw s.statusCode=t.status,s}if(r.commits.length!==0)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){let[r,a,s]=vr(e),i=await this.caller.call(D(),`${this.apiUrl}/likes/${r}/${a}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(i,`${t?"like":"unlike"} prompt`),await i.json()}async _getPromptUrl(e){let[t,r,a]=vr(e);if(await this._currentTenantIsOwner(t)){let s=await this._getSettings();return a!=="latest"?`${this.getHostUrl()}/prompts/${r}/${a.substring(0,8)}?organizationId=${s.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${s.id}`}else return a!=="latest"?`${this.getHostUrl()}/hub/${t}/${r}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(let t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,r=>r.commits))yield*t}async*listPrompts(e){var r;let t=new URLSearchParams;t.append("sort_field",(r=e==null?void 0:e.sortField)!=null?r:"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!(e!=null&&e.isArchived)).toString()),(e==null?void 0:e.isPublic)!==void 0&&t.append("is_public",e.isPublic.toString()),e!=null&&e.query&&t.append("query",e.query);for await(let a of this._getPaginated("/repos",t,s=>s.repos))yield*a}async getPrompt(e){let[t,r,a]=vr(e),s=await this.caller.call(D(),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(s.status===404)return null;await X(s,"get prompt");let i=await s.json();return i.repo?i.repo:null}async createPrompt(e,t){let r=await this._getSettings();if(t!=null&&t.isPublic&&!r.tenant_handle)throw new Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle. 
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);let[a,s,i]=vr(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);let o={repo_handle:s,...(t==null?void 0:t.description)&&{description:t.description},...(t==null?void 0:t.readme)&&{readme:t.readme},...(t==null?void 0:t.tags)&&{tags:t.tags},is_public:!!(t!=null&&t.isPublic)},u=await this.caller.call(D(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(u,"create prompt");let{repo:c}=await u.json();return c}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[a,s,i]=vr(e),o=(r==null?void 0:r.parentCommitHash)==="latest"||!(r!=null&&r.parentCommitHash)?await this._getLatestCommitHash(`${a}/${s}`):r==null?void 0:r.parentCommitHash,u={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},c=await this.caller.call(D(),`${this.apiUrl}/commits/${a}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(c,"create commit");let l=await c.json();return this._getPromptUrl(`${a}/${s}${l.commit_hash?`:${l.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");let r=new FormData;for(let i of t){let o=i.id,u={...i.metadata&&{metadata:i.metadata},...i.split&&{split:i.split}},c=nt(u),l=new Blob([c],{type:"application/json"});if(r.append(o,l),i.inputs){let d=nt(i.inputs),h=new Blob([d],{type:"application/json"});r.append(`${o}.inputs`,h)}if(i.outputs){let d=nt(i.outputs),h=new Blob([d],{type:"application/json"});r.append(`${o}.outputs`,h)}if(i.attachments)for(let[d,h]of Object.entries(i.attachments)){let f,p;Array.isArray(h)?[f,p]=h:(f=h.mimeType,p=h.data);let g=new Blob([p],{type:`${f}; length=${p.byteLength}`});r.append(`${o}.attachment.${d}`,g)}if(i.attachments_operations){let d=nt(i.attachments_operations),h=new Blob([d],{type:"application/json"});r.append(`${o}.attachments_operations`,h)}}return await(await this.caller.call(D(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"PATCH",headers:this.headers,body:r})).json()}async uploadExamplesMultipart(e,t=[]){var i;if(!await this._getMultiPartSupport())throw new Error("Your LangSmith version does not allow using the multipart examples endpoint, please update to the latest version.");let r=new FormData;for(let o of t){let u=((i=o.id)!=null?i:pe()).toString(),c={created_at:o.created_at,...o.metadata&&{metadata:o.metadata},...o.split&&{split:o.split}},l=nt(c),d=new Blob([l],{type:"application/json"});r.append(u,d);let h=nt(o.inputs),f=new Blob([h],{type:"application/json"});if(r.append(`${u}.inputs`,f),o.outputs){let p=nt(o.outputs),g=new Blob([p],{type:"application/json"});r.append(`${u}.outputs`,g)}if(o.attachments)for(let[p,g]of Object.entries(o.attachments)){let y,m;Array.isArray(g)?[y,m]=g:(y=g.mimeType,m=g.data);let b=new Blob([m],{type:`${y}; length=${m.byteLength}`});r.append(`${u}.attachment.${p}`,b)}}return await(await this.caller.call(D(),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:r})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[r,a]=vr(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);let s={};if((t==null?void 0:t.description)!==void 0&&(s.description=t.description),(t==null?void 0:t.readme)!==void 0&&(s.readme=t.readme),(t==null?void 0:t.tags)!==void 0&&(s.tags=t.tags),(t==null?void 0:t.isPublic)!==void 0&&(s.is_public=t.isPublic),(t==null?void 0:t.isArchived)!==void 0&&(s.is_archived=t.isArchived),Object.keys(s).length===0)throw new Error("No valid update options provided");let i=await this.caller.call(D(),`${this.apiUrl}/repos/${r}/${a}`,{method:"PATCH",body:JSON.stringify(s),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await X(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");let[t,r,a]=vr(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return await(await this.caller.call(D(),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async pullPromptCommit(e,t){let[r,a,s]=vr(e),i=await this.caller.call(D(),`${this.apiUrl}/commits/${r}/${a}/${s}${t!=null&&t.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await X(i,"pull prompt commit");let o=await i.json();return{owner:r,repo:a,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){let r=await this.pullPromptCommit(e,{includeModel:t==null?void 0:t.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(a=>a!=="object")&&await this.updatePrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}):await this.createPrompt(e,{description:t==null?void 0:t.description,readme:t==null?void 0:t.readme,tags:t==null?void 0:t.tags,isPublic:t==null?void 0:t.isPublic}),t!=null&&t.object?await this.createCommit(e,t==null?void 0:t.object,{parentCommitHash:t==null?void 0:t.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){var h,f;let{sourceApiUrl:r=this.apiUrl,datasetName:a}=t,[s,i]=this.parseTokenOrUrl(e,r),o=new n({apiUrl:s,apiKey:"placeholder"}),u=await o.readSharedDataset(i),c=a||u.name;try{if(await this.hasDataset({datasetId:c})){console.log(`Dataset ${c} already exists in your tenant. Skipping.`);return}}catch(p){}let l=await o.listSharedExamples(i),d=await this.createDataset(c,{description:u.description,dataType:u.data_type||"kv",inputsSchema:(h=u.inputs_schema_definition)!=null?h:void 0,outputsSchema:(f=u.outputs_schema_definition)!=null?f:void 0});try{await this.createExamples({inputs:l.map(p=>p.inputs),outputs:l.flatMap(p=>p.outputs?[p.outputs]:[]),datasetId:d.id})}catch(p){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),p}}parseTokenOrUrl(e,t,r=2,a="dataset"){try{return Y(e),[t,e]}catch(s){}try{let i=new URL(e).pathname.split("/").filter(o=>o!=="");if(i.length>=r){let o=i[i.length-r];return[t,o]}else throw new Error(`Invalid public ${a} URL: ${e}`)}catch(s){throw new Error(`Invalid public ${a} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()])}};var Po="0.2.14";var Or,BA=()=>typeof window!="undefined"&&typeof window.document!="undefined",qA=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",VA=()=>typeof window!="undefined"&&window.name==="nodejs"||typeof navigator!="undefined"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),cm=()=>typeof Deno!="undefined",HA=()=>typeof process!="undefined"&&typeof process.versions!="undefined"&&typeof process.versions.node!="undefined"&&!cm(),ZA=()=>Or||(BA()?Or="browser":HA()?Or="node":qA()?Or="webworker":VA()?Or="jsdom":cm()?Or="deno":Or="other",Or),al;function To(){if(al===void 0){let n=ZA(),e=KA();al={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:Po,...e}}return al}function um(){let n=GA()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(let[r,a]of Object.entries(n))(r.startsWith("LANGCHAIN_")||r.startsWith("LANGSMITH_"))&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function GA(){try{return typeof process!="undefined"&&process.env?Object.entries(process.env).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch(n){return}}function nr(n){var e;try{return typeof process!="undefined"?(e=process.env)==null?void 0:e[n]:void 0}catch(t){return}}function Ar(n){return nr(`LANGSMITH_${n}`)||nr(`LANGCHAIN_${n}`)}var sl;function KA(){if(sl!==void 0)return sl;let n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of n){let r=nr(t);r!==void 0&&(e[t]=r)}return sl=e,e}var lm=n=>n!==void 0?n:!!["TRACING_V2","TRACING"].find(t=>Ar(t)==="true");var So=Symbol.for("lc:context_variables");function JA(n){return n.replace(/[-:.]/g,"")}function WA(n,e,t=1){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return JA(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}var ko=class n{constructor(e,t){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t}static fromHeader(e){let t=e.split(","),r={},a=[];for(let s of t){let[i,o]=s.split("="),u=decodeURIComponent(o);i==="langsmith-metadata"?r=JSON.parse(u):i==="langsmith-tags"&&(a=u.split(","))}return new n(r,a)}toHeader(){let e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}},Er=class n{constructor(e){var o,u,c,l,d;if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Co(e)){Object.assign(this,{...e});return}let t=n.getDefaultConfig(),{metadata:r,...a}=e,s=(o=a.client)!=null?o:n.getSharedClient(),i={...r,...(u=a==null?void 0:a.extra)==null?void 0:u.metadata};if(a.extra={...a.extra,metadata:i},Object.assign(this,{...t,...a,client:s}),this.trace_id||(this.parent_run?this.trace_id=(c=this.parent_run.trace_id)!=null?c:this.id:this.trace_id=this.id),(l=this.execution_order)!=null||(this.execution_order=1),(d=this.child_execution_order)!=null||(this.child_execution_order=1),!this.dotted_order){let h=WA(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+h:this.dotted_order=h}}static getDefaultConfig(){var e,t,r;return{id:pe(),run_type:"chain",project_name:(t=(e=nr("LANGCHAIN_PROJECT"))!=null?e:nr("LANGCHAIN_SESSION"))!=null?t:"default",child_runs:[],api_url:(r=nr("LANGCHAIN_ENDPOINT"))!=null?r:"http://localhost:1984",api_key:nr("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return n.sharedClient||(n.sharedClient=new Bn),n.sharedClient}createChild(e){var u,c,l,d,h,f,p;let t=this.child_execution_order+1,r=new n({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});So in this&&(r[So]=this[So]);let a=Symbol.for("lc:child_config"),s=(c=(u=e.extra)==null?void 0:u[a])!=null?c:this.extra[a];if(YA(s)){let g={...s},y=XA(g.callbacks)?(d=(l=g.callbacks).copy)==null?void 0:d.call(l):void 0;y&&(Object.assign(y,{_parentRunId:r.id}),(p=(f=(h=y.handlers)==null?void 0:h.find(hm))==null?void 0:f.updateFromRunTree)==null||p.call(f,r),g.callbacks=y),r.extra[a]=g}let i=new Set,o=this;for(;o!=null&&!i.has(o.id);)i.add(o.id),o.child_execution_order=Math.max(o.child_execution_order,t),o=o.parent_run;return this.child_runs.push(r),r}async end(e,t,r=Date.now(),a){var s,i,o;this.outputs=(s=this.outputs)!=null?s:e,this.error=(i=this.error)!=null?i:t,this.end_time=(o=this.end_time)!=null?o:r,a&&Object.keys(a).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...a}}:{metadata:a})}_convertToCreate(e,t,r=!0){var u,c;let a=(u=e.extra)!=null?u:{};if(a.runtime||(a.runtime={}),t)for(let[l,d]of Object.entries(t))a.runtime[l]||(a.runtime[l]=d);let s,i;return r?(i=(c=e.parent_run)==null?void 0:c.id,s=[]):(s=e.child_runs.map(l=>this._convertToCreate(l,t,r)),i=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:a,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:s,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments}}async postRun(e=!0){try{let t=To(),r=await this._convertToCreate(this,t,!0);if(await this.client.createRun(r),!e){mo("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(let a of this.child_runs)await a.postRun(!1)}}catch(t){console.error(`Error in postRun for run ${this.id}:`,t)}}async patchRun(){var e;try{let t={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:(e=this.parent_run)==null?void 0:e.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments};await this.client.updateRun(this.id,t)}catch(t){console.error(`Error in patchRun for run ${this.id}`,t)}}toJSON(){return this._convertToCreate(this,void 0,!1)}static fromRunnableConfig(e,t){var c,l,d,h,f,p,g;let r=e==null?void 0:e.callbacks,a,s,i,o=lm();if(r){let y=(l=(c=r==null?void 0:r.getParentRunId)==null?void 0:c.call(r))!=null?l:"",m=(d=r==null?void 0:r.handlers)==null?void 0:d.find(b=>(b==null?void 0:b.name)=="langchain_tracer");a=(h=m==null?void 0:m.getRun)==null?void 0:h.call(m,y),s=m==null?void 0:m.projectName,i=m==null?void 0:m.client,o=o||!!m}return a?new n({name:a.name,id:a.id,trace_id:a.trace_id,dotted_order:a.dotted_order,client:i,tracingEnabled:o,project_name:s,tags:[...new Set(((f=a==null?void 0:a.tags)!=null?f:[]).concat((p=e==null?void 0:e.tags)!=null?p:[]))],extra:{metadata:{...(g=a==null?void 0:a.extra)==null?void 0:g.metadata,...e==null?void 0:e.metadata}}}).createChild(t):new n({...t,client:i,tracingEnabled:o,project_name:s})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){var c,l,d,h;let r="get"in e&&typeof e.get=="function"?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,a=r["langsmith-trace"];if(!a||typeof a!="string")return;let s=a.trim(),i=s.split(".").map(f=>{let[p,g]=f.split("Z");return{strTime:p,time:Date.parse(p+"Z"),uuid:g}}),o=i[0].uuid,u={...t,name:(c=t==null?void 0:t.name)!=null?c:"parent",run_type:(l=t==null?void 0:t.run_type)!=null?l:"chain",start_time:(d=t==null?void 0:t.start_time)!=null?d:Date.now(),id:(h=i.at(-1))==null?void 0:h.uuid,trace_id:o,dotted_order:s};if(r.baggage&&typeof r.baggage=="string"){let f=ko.fromHeader(r.baggage);u.metadata=f.metadata,u.tags=f.tags}return new n(u)}toHeaders(e){var r;let t={"langsmith-trace":this.dotted_order,baggage:new ko((r=this.extra)==null?void 0:r.metadata,this.tags).toHeader()};if(e)for(let[a,s]of Object.entries(t))e.set(a,s);return t}};Object.defineProperty(Er,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});function Co(n){return n!==void 0&&typeof n.createChild=="function"&&typeof n.postRun=="function"}function hm(n){return typeof n=="object"&&n!=null&&typeof n.name=="string"&&n.name==="langchain_tracer"}function dm(n){return Array.isArray(n)&&n.some(e=>hm(e))}function XA(n){return typeof n=="object"&&n!=null&&Array.isArray(n.handlers)}function YA(n){var e;return n!==void 0&&typeof n.callbacks=="object"&&(dm((e=n.callbacks)==null?void 0:e.handlers)||dm(n.callbacks))}var ol=class{getStore(){}run(e,t){return t()}},il=Symbol.for("ls:tracing_async_local_storage"),QA=new ol,ul=class{getInstance(){var e;return(e=globalThis[il])!=null?e:QA}initializeGlobalInstance(e){globalThis[il]===void 0&&(globalThis[il]=e)}},eE=new ul,fm=()=>{let n=eE.getInstance().getStore();if(!Co(n))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join(`
`));return n};var XC=Symbol.for("langsmith:traceable:root");function Ro(n){return typeof n=="function"&&"langsmith:traceable"in n}var cl={};vd(cl,{JsonPatchError:()=>me,_areEquals:()=>ti,applyOperation:()=>Vn,applyPatch:()=>Gr,applyReducer:()=>aE,deepClone:()=>rE,getValueByPointer:()=>Do,validate:()=>mm,validator:()=>Mo});var tE=Object.prototype.hasOwnProperty;function $o(n,e){return tE.call(n,e)}function jo(n){if(Array.isArray(n)){let t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)$o(n,t)&&e.push(t);return e}function Ue(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function Lo(n){let e=0,t=n.length,r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function ar(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function ei(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function No(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(No(n[t]))return!0}else if(typeof n=="object"){let t=jo(n),r=t.length;for(var e=0;e<r;e++)if(No(n[t[e]]))return!0}}return!1}function pm(n,e){let t=[n];for(let r in e){let a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a!="undefined"&&t.push(`${r}: ${a}`)}return t.join(`
`)}var qn=class extends Error{constructor(e,t,r,a,s){super(pm(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=pm(e,{name:t,index:r,operation:a,tree:s})}};var me=qn,rE=Ue,Xa={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=Do(t,this.path);r&&(r=Ue(r));let a=Vn(t,{op:"remove",path:this.from}).removed;return Vn(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){let r=Do(t,this.from);return Vn(t,{op:"add",path:this.path,value:Ue(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:ti(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},nE={add:function(n,e,t){return Lo(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:Xa.move,copy:Xa.copy,test:Xa.test,_get:Xa._get};function Do(n,e){if(e=="")return n;var t={op:"_get",path:e};return Vn(n,t),t.value}function Vn(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):Mo(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=Do(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=ti(n,e.value),i.test===!1)throw new me("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new me("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=Ue(n));let o=(e.path||"").split("/"),u=n,c=1,l=o.length,d,h,f;for(typeof t=="function"?f=t:f=Mo;;){if(h=o[c],h&&h.indexOf("~")!=-1&&(h=ei(h)),a&&(h=="__proto__"||h=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(u[h]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&f(e,0,n,d)),c++,Array.isArray(u)){if(h==="-")h=u.length;else{if(t&&!Lo(h))throw new me("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);Lo(h)&&(h=~~h)}if(c>=l){if(t&&e.op==="add"&&h>u.length)throw new me("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);let p=nE[e.op].call(e,u,h,n);if(p.test===!1)throw new me("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}}else if(c>=l){let p=Xa[e.op].call(e,u,h,n);if(p.test===!1)throw new me("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return p}if(u=u[h],t&&c<l&&(!u||typeof u!="object"))throw new me("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function Gr(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new me("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=Ue(n));let s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=Vn(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function aE(n,e,t){let r=Vn(n,e);if(r.test===!1)throw new me("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function Mo(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new me("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(Xa[n.op]){if(typeof n.path!="string")throw new me("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new me('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new me("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new me("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&No(n.value))throw new me("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new me("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new me("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=mm([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new me("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new me("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function mm(n,e,t){try{if(!Array.isArray(n))throw new me("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Gr(Ue(e),Ue(n),t||!0);else{t=t||Mo;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof me)return a;throw a}}function ti(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!ti(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!ti(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}function gm(n,e,t,r,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var s=jo(e),i=jo(n),o=!1,u=!1,c=i.length-1;c>=0;c--){var l=i[c],d=n[l];if($o(e,l)&&!(e[l]===void 0&&d!==void 0&&Array.isArray(e)===!1)){var h=e[l];typeof d=="object"&&d!=null&&typeof h=="object"&&h!=null&&Array.isArray(d)===Array.isArray(h)?gm(d,h,t,r+"/"+ar(l),a):d!==h&&(o=!0,a&&t.push({op:"test",path:r+"/"+ar(l),value:Ue(d)}),t.push({op:"replace",path:r+"/"+ar(l),value:Ue(h)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:r+"/"+ar(l),value:Ue(d)}),t.push({op:"remove",path:r+"/"+ar(l)}),u=!0):(a&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}),o=!0)}if(!(!u&&s.length==i.length))for(var c=0;c<s.length;c++){var l=s[c];!$o(n,l)&&e[l]!==void 0&&t.push({op:"add",path:r+"/"+ar(l),value:Ue(e[l])})}}}function Fo(n,e,t=!1){var r=[];return gm(n,e,r,"",t),r}var oR={...cl,JsonPatchError:qn,deepClone:Ue,escapePathComponent:ar,unescapePathComponent:ei};var sE=()=>typeof window!="undefined"&&typeof window.document!="undefined",iE=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",oE=()=>typeof window!="undefined"&&window.name==="nodejs"||typeof navigator!="undefined"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),dl=()=>typeof Deno!="undefined",uE=()=>typeof process!="undefined"&&typeof process.versions!="undefined"&&typeof process.versions.node!="undefined"&&!dl(),cE=()=>{let n;return sE()?n="browser":uE()?n="node":iE()?n="webworker":oE()?n="jsdom":dl()?n="deno":n="other",n},ll;async function ym(){return ll===void 0&&(ll={library:"langchain-js",runtime:cE()}),ll}function se(n){var e;try{return typeof process!="undefined"?(e=process.env)==null?void 0:e[n]:dl()?Deno==null?void 0:Deno.env.get(n):void 0}catch(t){return}}var hl=class{};function fl(n){return"lc_prefer_streaming"in n&&n.lc_prefer_streaming}var Hn=class n extends hl{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,gc(this.constructor)]}constructor(e){var t,r,a,s,i,o,u;super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:se("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=(t=e.ignoreLLM)!=null?t:this.ignoreLLM,this.ignoreChain=(r=e.ignoreChain)!=null?r:this.ignoreChain,this.ignoreAgent=(a=e.ignoreAgent)!=null?a:this.ignoreAgent,this.ignoreRetriever=(s=e.ignoreRetriever)!=null?s:this.ignoreRetriever,this.ignoreCustomEvent=(i=e.ignoreCustomEvent)!=null?i:this.ignoreCustomEvent,this.raiseError=(o=e.raiseError)!=null?o:this.raiseError,this.awaitHandlers=this.raiseError||((u=e._awaitHandler)!=null?u:this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return $t.prototype.toJSON.call(this)}toJSONNotImplemented(){return $t.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:pe()}),Object.assign(this,e)}}return new t}},bm=n=>{let e=n;return e!==void 0&&typeof e.copy=="function"&&typeof e.name=="string"&&typeof e.awaitHandlers=="boolean"};function pl(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function lE(n){return n.replace(/[-:.]/g,"")}function dE(n,e,t){let r=t.toFixed(0).slice(0,3).padStart(3,"0");return lE(`${new Date(n).toISOString().slice(0,-1)}${r}Z`)+e}function Ya(n){return typeof n._addRunToRunMap=="function"}var Et=class extends Hn{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){let t=dE(e.start_time,e.id,e.execution_order),r={...e};if(r.parent_run_id!==void 0){let a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){var r;let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,a,s,i,o,u){let c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d!=null?d:{},tags:i||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,t,r,a,s,i,o,u){var l,d,h;let c=(l=this.runMap.get(r))!=null?l:this._createRunForLLMStart(e,t,r,a,s,i,o,u);return await((d=this.onRunCreate)==null?void 0:d.call(this,c)),await((h=this.onLLMStart)==null?void 0:h.call(this,c)),c}_createRunForChatModelStart(e,t,r,a,s,i,o,u){let c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d!=null?d:{},tags:i||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,t,r,a,s,i,o,u){var l,d,h;let c=(l=this.runMap.get(r))!=null?l:this._createRunForChatModelStart(e,t,r,a,s,i,o,u);return await((d=this.onRunCreate)==null?void 0:d.call(this,c)),await((h=this.onLLMStart)==null?void 0:h.call(this,c)),c}async handleLLMEnd(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onLLMEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleLLMError(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onLLMError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}_createRunForChainStart(e,t,r,a,s,i,o,u){let c=this._getExecutionOrder(a),l=Date.now(),d={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o!=null?o:"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,r,a,s,i,o,u){var l,d,h;let c=(l=this.runMap.get(r))!=null?l:this._createRunForChainStart(e,t,r,a,s,i,o,u);return await((d=this.onRunCreate)==null?void 0:d.call(this,c)),await((h=this.onChainStart)==null?void 0:h.call(this,c)),c}async handleChainEnd(e,t,r,a,s){var o;let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=pl(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=pl(s.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){var o;let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=pl(s.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}_createRunForToolStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o!=null?o:e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,r,a,s,i,o){var c,l,d;let u=(c=this.runMap.get(r))!=null?c:this._createRunForToolStart(e,t,r,a,s,i,o);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onToolStart)==null?void 0:d.call(this,u)),u}async handleToolEnd(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onToolEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onToolError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var s;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentAction)==null?void 0:s.call(this,r))}async handleAgentEnd(e,t){var a;let r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentEnd)==null?void 0:a.call(this,r)))}_createRunForRetrieverStart(e,t,r,a,s,i,o){let u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o!=null?o:e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,r,a,s,i,o){var c,l,d;let u=(c=this.runMap.get(r))!=null?c:this._createRunForRetrieverStart(e,t,r,a,s,i,o);return await((l=this.onRunCreate)==null?void 0:l.call(this,u)),await((d=this.onRetrieverStart)==null?void 0:d.call(this,u)),u}async handleRetrieverEnd(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var a;let r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((a=this.onText)==null?void 0:a.call(this,r)))}async handleLLMNewToken(e,t,r,a,s,i){var u;let o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}};var ml=pt(Am(),1);function Ge(n,e){return`${n.open}${e}${n.close}`}function Ot(n,e){try{return JSON.stringify(n,null,2)}catch(t){return e}}function Em(n){return typeof n=="string"?n.trim():n==null?n:Ot(n,n.toString())}function Kr(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:at}=ml.default,ri=class extends Et{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{let o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?Ge(ml.default.bold,o):o}).join(" > ");return Ge(at.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${Ge(at.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Ot(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${Ge(at.cyan,"[chain/end]")} [${t}] [${Kr(e)}] Exiting Chain run with output: ${Ot(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${Ge(at.red,"[chain/error]")} [${t}] [${Kr(e)}] Chain run errored with error: ${Ot(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${Ge(at.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Ot(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${Ge(at.cyan,"[llm/end]")} [${t}] [${Kr(e)}] Exiting LLM run with output: ${Ot(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${Ge(at.red,"[llm/error]")} [${t}] [${Kr(e)}] LLM run errored with error: ${Ot(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${Ge(at.green,"[tool/start]")} [${t}] Entering Tool run with input: "${Em(e.inputs.input)}"`)}onToolEnd(e){var r;let t=this.getBreadcrumbs(e);console.log(`${Ge(at.cyan,"[tool/end]")} [${t}] [${Kr(e)}] Exiting Tool run with output: "${Em((r=e.outputs)==null?void 0:r.output)}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${Ge(at.red,"[tool/error]")} [${t}] [${Kr(e)}] Tool run errored with error: ${Ot(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${Ge(at.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Ot(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${Ge(at.cyan,"[retriever/end]")} [${t}] [${Kr(e)}] Exiting Retriever run with output: ${Ot(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${Ge(at.red,"[retriever/error]")} [${t}] [${Kr(e)}] Retriever run errored with error: ${Ot(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${Ge(at.blue,"[agent/action]")} [${r}] Agent selected action: ${Ot(t.actions[t.actions.length-1],"[action]")}`)}};var gl,Om=()=>{if(gl===void 0){let n=se("LANGCHAIN_CALLBACKS_BACKGROUND")==="false"?{blockOnRootRunFinalization:!0}:{};gl=new Bn(n)}return gl};var Qa=class n extends Et{constructor(e={}){var i;super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:a}=e;this.projectName=(i=r!=null?r:se("LANGCHAIN_PROJECT"))!=null?i:se("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a!=null?a:Om();let s=n.getTraceableRunTree();s&&this.updateFromRunTree(s)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await ym()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){var s,i,o;let t=e,r=new Set;for(;t.parent_run&&!(r.has(t.id)||(r.add(t.id),!t.parent_run));)t=t.parent_run;r.clear();let a=[t];for(;a.length>0;){let u=a.shift();!u||r.has(u.id)||(r.add(u.id),this.runMap.set(u.id,u),u.child_runs&&a.push(...u.child_runs))}this.client=(s=e.client)!=null?s:this.client,this.projectName=(i=e.project_name)!=null?i:this.projectName,this.exampleId=(o=e.reference_example_id)!=null?o:this.exampleId}convertToRunTree(e){let t={},r=[];for(let[a,s]of this.runMap){let i=new Er({...s,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[a]=i,r.push([a,s.dotted_order])}r.sort((a,s)=>!a[1]||!s[1]?0:a[1].localeCompare(s[1]));for(let[a]of r){let s=this.runMap.get(a),i=t[a];if(!(!s||!i)&&s.parent_run_id){let o=t[s.parent_run_id];o&&(o.child_runs.push(i),i.parent_run=o)}}return t[e]}static getTraceableRunTree(){try{return fm()}catch(e){return}}};var Uo=pt(fo(),1);var xm=Symbol.for("ls:tracing_async_local_storage"),Zn=Symbol.for("lc:context_variables"),Im=n=>{globalThis[xm]=n},Jr=()=>globalThis[xm];var ni;function fE(){let n="default"in Uo.default?Uo.default.default:Uo.default;return new n({autoStart:!0,concurrency:1})}function pE(){return typeof ni=="undefined"&&(ni=fE()),ni}async function be(n,e){if(e===!0){let t=Jr();t!==void 0?await t.run(void 0,async()=>n()):await n()}else ni=pE(),ni.add(async()=>{let t=Jr();t!==void 0?await t.run(void 0,async()=>n()):await n()})}var Pm=n=>n!==void 0?n:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(t=>se(t)==="true");function yl(n){var r;let e=Jr();if(e===void 0)return;let t=e.getStore();return(r=t==null?void 0:t[Zn])==null?void 0:r[n]}var mE=Symbol("lc:configure_hooks"),Tm=()=>yl(mE)||[];function Sm(n){return n?Array.isArray(n)||"name"in n?{callbacks:n}:n:{}}var bl=class{setHandler(e){return this.setHandlers([e])}},es=class{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>be(async()=>{var o;try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,t,this.runId,this.tags,this.metadata))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}},_l=class extends es{getChild(e){let t=new Re(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw a}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`),t.raiseError)throw e}},t.awaitHandlers)))}},zo=class extends es{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>be(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,t!=null?t:{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){if((o.raiseError?console.error:console.warn)(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${c}`),o.raiseError)throw c}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}},wl=class extends es{getChild(e){let t=new Re(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>be(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainError: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>be(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainEnd: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}},vl=class extends es{getChild(e){let t=new Re(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>be(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${a}`),t.raiseError)throw a}},t.awaitHandlers)))}},Re=class n extends bl{constructor(e,t){var r,a,s,i,o,u;super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(r=t==null?void 0:t.handlers)!=null?r:this.handlers,this.inheritableHandlers=(a=t==null?void 0:t.inheritableHandlers)!=null?a:this.inheritableHandlers,this.tags=(s=t==null?void 0:t.tags)!=null?s:this.tags,this.inheritableTags=(i=t==null?void 0:t.inheritableTags)!=null?i:this.inheritableTags,this.metadata=(o=t==null?void 0:t.metadata)!=null?o:this.metadata,this.inheritableMetadata=(u=t==null?void 0:t.inheritableMetadata)!=null?u:this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{let d=l===0&&r?r:pe();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return Ya(h)&&h._createRunForLLMStart(e,[c],d,this._parentRunId,s,this.tags,this.metadata,u),be(async()=>{var f;try{await((f=h.handleLLMStart)==null?void 0:f.call(h,e,[c],d,this._parentRunId,s,this.tags,this.metadata,u))}catch(p){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${p}`),h.raiseError)throw p}},h.awaitHandlers)})),new zo(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async(c,l)=>{let d=l===0&&r?r:pe();return await Promise.all(this.handlers.map(h=>{if(!h.ignoreLLM)return Ya(h)&&h._createRunForChatModelStart(e,[c],d,this._parentRunId,s,this.tags,this.metadata,u),be(async()=>{var f,p;try{if(h.handleChatModelStart)await((f=h.handleChatModelStart)==null?void 0:f.call(h,e,[c],d,this._parentRunId,s,this.tags,this.metadata,u));else if(h.handleLLMStart){let g=Fs(c);await((p=h.handleLLMStart)==null?void 0:p.call(h,e,[g],d,this._parentRunId,s,this.tags,this.metadata,u))}}catch(g){if((h.raiseError?console.error:console.warn)(`Error in handler ${h.constructor.name}, handleLLMStart: ${g}`),h.raiseError)throw g}},h.awaitHandlers)})),new zo(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=pe(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreChain)return Ya(u)&&u._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,o),be(async()=>{var c;try{await((c=u.handleChainStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,a,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new wl(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=pe(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreAgent)return Ya(u)&&u._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),be(async()=>{var c;try{await((c=u.handleToolStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new vl(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=pe(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>{if(!u.ignoreRetriever)return Ya(u)&&u._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,o),be(async()=>{var c;try{await((c=u.handleRetrieverStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){if((u.raiseError?console.error:console.warn)(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`),u.raiseError)throw l}},u.awaitHandlers)})),new _l(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,s){await Promise.all(this.handlers.map(i=>be(async()=>{var o;if(!i.ignoreCustomEvent)try{await((o=i.handleCustomEvent)==null?void 0:o.call(i,e,t,r,this.tags,this.metadata))}catch(u){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleCustomEvent: ${u}`),i.raiseError)throw u}},i.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let a of this.handlers){let s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(let a of this.tags){let s=this.inheritableTags.includes(a);r.addTags([a],s)}for(let a of Object.keys(this.metadata)){let s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(let a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends Hn{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:pe()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static configure(e,t,r,a,s,i,o){return this._configureSync(e,t,r,a,s,i,o)}static _configureSync(e,t,r,a,s,i,o){var h,f,p,g,y;let u;(e||t)&&(Array.isArray(e)||!e?(u=new n,u.setHandlers((h=e==null?void 0:e.map(ai))!=null?h:[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(ai):t==null?void 0:t.handlers,!1));let c=se("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=((f=Qa.getTraceableRunTree())==null?void 0:f.tracingEnabled)||Pm(),d=l||((p=se("LANGCHAIN_TRACING"))!=null?p:!1);if(c||d){if(u||(u=new n),c&&!u.handlers.some(m=>m.name===ri.prototype.name)){let m=new ri;u.addHandler(m,!0)}if(d&&!u.handlers.some(m=>m.name==="langchain_tracer")&&l){let m=new Qa;u.addHandler(m,!0),u._parentRunId=(y=(g=Qa.getTraceableRunTree())==null?void 0:g.id)!=null?y:u._parentRunId}}for(let{contextVar:m,inheritable:b=!0,handlerClass:A,envVar:I}of Tm()){let _=I&&se(I)==="true"&&A,v,E=m!==void 0?yl(m):void 0;E&&bm(E)?v=E:_&&(v=new A({})),v!==void 0&&(u||(u=new n),u.handlers.some(O=>O.name===v.name)||u.addHandler(v,b))}return(r||a)&&u&&(u.addTags(r!=null?r:[]),u.addTags(a!=null?a:[],!1)),(s||i)&&u&&(u.addMetadata(s!=null?s:{}),u.addMetadata(i!=null?i:{},!1)),u}};function ai(n){return"name"in n?n:Hn.fromMethods(n)}var Bo=class{getStore(){}run(e,t){return t()}enterWith(e){}},gE=new Bo,km=Symbol.for("lc:child_config"),Al=class{getInstance(){var e;return(e=Jr())!=null?e:gE}getRunnableConfig(){var t,r;return(r=(t=this.getInstance().getStore())==null?void 0:t.extra)==null?void 0:r[km]}runWithConfig(e,t,r){var l;let a=Re._configureSync(e==null?void 0:e.callbacks,void 0,e==null?void 0:e.tags,void 0,e==null?void 0:e.metadata),s=this.getInstance(),i=s.getStore(),o=a==null?void 0:a.getParentRunId(),u=(l=a==null?void 0:a.handlers)==null?void 0:l.find(d=>(d==null?void 0:d.name)==="langchain_tracer"),c;return u&&o?c=u.convertToRunTree(o):r||(c=new Er({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[km]:e}),i!==void 0&&i[Zn]!==void 0&&(c[Zn]=i[Zn]),s.run(c,t)}initializeGlobalInstance(e){Jr()===void 0&&Im(e)}},st=new Al;var qo=25;async function it(n){return Re._configureSync(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function Vo(...n){var t,r,a;let e={};for(let s of n.filter(i=>!!i))for(let i of Object.keys(s))if(i==="metadata")e[i]={...e[i],...s[i]};else if(i==="tags"){let o=(t=e[i])!=null?t:[];e[i]=[...new Set(o.concat((r=s[i])!=null?r:[]))]}else if(i==="configurable")e[i]={...e[i],...s[i]};else if(i==="timeout")e.timeout===void 0?e.timeout=s.timeout:s.timeout!==void 0&&(e.timeout=Math.min(e.timeout,s.timeout));else if(i==="signal")e.signal===void 0?e.signal=s.signal:s.signal!==void 0&&("any"in AbortSignal?e.signal=AbortSignal.any([e.signal,s.signal]):e.signal=s.signal);else if(i==="callbacks"){let o=e.callbacks,u=s.callbacks;if(Array.isArray(u))if(!o)e.callbacks=u;else if(Array.isArray(o))e.callbacks=o.concat(u);else{let c=o.copy();for(let l of u)c.addHandler(ai(l),!0);e.callbacks=c}else if(u)if(!o)e.callbacks=u;else if(Array.isArray(o)){let c=u.copy();for(let l of o)c.addHandler(ai(l),!0);e.callbacks=c}else e.callbacks=new Re(u._parentRunId,{handlers:o.handlers.concat(u.handlers),inheritableHandlers:o.inheritableHandlers.concat(u.inheritableHandlers),tags:Array.from(new Set(o.tags.concat(u.tags))),inheritableTags:Array.from(new Set(o.inheritableTags.concat(u.inheritableTags))),metadata:{...o.metadata,...u.metadata}})}else{let o=i;e[o]=(a=s[o])!=null?a:e[o]}return e}var yE=new Set(["string","number","boolean"]);function Q(n){var r;let e=st.getRunnableConfig(),t={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(e){let{runId:a,runName:s,...i}=e;t=Object.entries(i).reduce((o,[u,c])=>(c!==void 0&&(o[u]=c),o),t)}if(n&&(t=Object.entries(n).reduce((a,[s,i])=>(i!==void 0&&(a[s]=i),a),t)),t!=null&&t.configurable)for(let a of Object.keys(t.configurable))yE.has(typeof t.configurable[a])&&!((r=t.metadata)!=null&&r[a])&&(t.metadata||(t.metadata={}),t.metadata[a]=t.configurable[a]);if(t.timeout!==void 0){if(t.timeout<=0)throw new Error("Timeout must be a positive number");let a=AbortSignal.timeout(t.timeout);t.signal!==void 0?"any"in AbortSignal&&(t.signal=AbortSignal.any([t.signal,a])):t.signal=a,delete t.timeout}return t}function we(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s,runId:i}={}){let o=Q(n);return e!==void 0&&(delete o.runName,o.callbacks=e),r!==void 0&&(o.recursionLimit=r),t!==void 0&&(o.maxConcurrency=t),a!==void 0&&(o.runName=a),s!==void 0&&(o.configurable={...o.configurable,...s}),i!==void 0&&delete o.runId,o}function Lt(n){return n?{configurable:n.configurable,recursionLimit:n.recursionLimit,callbacks:n.callbacks,tags:n.tags,metadata:n.metadata,maxConcurrency:n.maxConcurrency,timeout:n.timeout,signal:n.signal}:void 0}async function sr(n,e){if(e===void 0)return n;let t;return Promise.race([n.catch(r=>{if(!(e!=null&&e.aborted))throw r}),new Promise((r,a)=>{t=()=>{a(new Error("Aborted"))},e.addEventListener("abort",t),e.aborted&&a(new Error("Aborted"))})]).finally(()=>e.removeEventListener("abort",t))}var ze=class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){let t=e.getReader();return new n({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};function El(n,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){let s=await n.next();for(let i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function Te(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){let t={...n};for(let[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Te(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}var xr=class{constructor(e){var t,r;Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=(r=e.signal)!=null?r:(t=this.config)==null?void 0:t.signal,this.setup=new Promise((a,s)=>{st.runWithConfig(Lt(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(a,s):this.firstResult.then(i=>a(void 0),s)},!0)})}async next(...e){var t;return(t=this.signal)==null||t.throwIfAborted(),this.firstResultUsed?st.runWithConfig(Lt(this.config),this.signal?async()=>sr(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function Cm(n,e,t,r,...a){let s=new xr({generator:e,startSetup:t,signal:r}),i=await s.setup;return{output:n(s,i,...a),setup:i}}var Dt=class{constructor(e){var t;Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=(t=e.ops)!=null?t:[]}concat(e){let t=this.ops.concat(e.ops),r=Gr({},t);return new si({ops:t,state:r[r.length-1].newDocument})}},si=class n extends Dt{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=Gr(this.state,e.ops);return new n({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=Gr({},e.ops);return new n({ops:e.ops,state:t[t.length-1].newDocument})}},$m=n=>n.name==="log_stream_tracer";async function Rm(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function Nm(n,e){let{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function bE(n){return n!==void 0&&n.message!==void 0}var ii=class extends Et{constructor(e){var t,r;super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(t=e==null?void 0:e.autoClose)!=null?t:!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(r=e==null?void 0:e._schemaFormat)!=null?r:this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=ze.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){var a;if(e.id===this.rootId)return!1;let t=(a=e.tags)!=null?a:[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let a=this.keyMapByRunId[e];a&&await this.writer.write(new Dt({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var a,s,i;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Dt({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:(a=e.tags)!=null?a:[],metadata:(i=(s=e.extra)==null?void 0:s.metadata)!=null?i:{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await Rm(e,this._schemaFormat)),await this.writer.write(new Dt({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await Rm(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await Nm(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new Dt({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new Dt({ops:[{op:"replace",path:"/final_output",value:await Nm(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a=this.keyMapByRunId[e.id];if(a===void 0)return;let s=e.inputs.messages!==void 0,i;s?bE(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new Le({id:`run-${e.id}`,content:t}):i=t;let o=new Dt({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}};var Ho="__run",xt=class n{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},It=class n extends xt{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}};function Zo({name:n,serialized:e}){return n!==void 0?n:(e==null?void 0:e.name)!==void 0?e.name:(e==null?void 0:e.id)!==void 0&&Array.isArray(e==null?void 0:e.id)?e.id[e.id.length-1]:"Unnamed"}var jm=n=>n.name==="event_stream_tracer",Go=class extends Et{constructor(e){var t;super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=(t=e==null?void 0:e.autoClose)!=null?t:!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=ze.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){var a;let t=(a=e.tags)!=null?a:[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.runType)),this.includeTags!==void 0&&(r=r||t.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.runType)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let a=this.runInfoMap.get(e);if(a===void 0){yield r.value;return}function s(o,u){return o==="llm"&&typeof u=="string"?new xt({text:u}):u}let i=this.tappedPromises.get(e);if(i===void 0){let o;i=new Promise(u=>{o=u}),this.tappedPromises.set(e,i);try{let u={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...u,data:{chunk:s(a.runType,r.value)}},a),yield r.value;for await(let c of t)a.runType!=="tool"&&a.runType!=="retriever"&&await this.send({...u,data:{chunk:s(a.runType,c)}},a),yield c}finally{o()}}else{yield r.value;for await(let o of t)yield o}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);r!==void 0?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){var i,o,u,c,l,d;let t=Zo(e),r=e.inputs.messages!==void 0?"chat_model":"llm",a={tags:(i=e.tags)!=null?i:[],metadata:(u=(o=e.extra)==null?void 0:o.metadata)!=null?u:{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);let s=`on_${r}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:(c=e.tags)!=null?c:[],run_id:e.id,metadata:(d=(l=e.extra)==null?void 0:l.metadata)!=null?d:{}},a)}async onLLMNewToken(e,t,r){let a=this.runInfoMap.get(e.id),s,i;if(a===void 0)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(this.runInfoMap.size!==1){if(a.runType==="chat_model")i="on_chat_model_stream",(r==null?void 0:r.chunk)===void 0?s=new Le({content:t,id:`run-${e.id}`}):s=r.chunk.message;else if(a.runType==="llm")i="on_llm_stream",(r==null?void 0:r.chunk)===void 0?s=new xt({text:t}):s=r.chunk;else throw new Error(`Unexpected run type ${a.runType}`);await this.send({event:i,data:{chunk:s},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}}async onLLMEnd(e){var i,o,u,c;let t=this.runInfoMap.get(e.id);this.runInfoMap.delete(e.id);let r;if(t===void 0)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let a=(i=e.outputs)==null?void 0:i.generations,s;if(t.runType==="chat_model"){for(let l of a!=null?a:[]){if(s!==void 0)break;s=(o=l[0])==null?void 0:o.message}r="on_chat_model_end"}else if(t.runType==="llm")s={generations:a==null?void 0:a.map(l=>l.map(d=>({text:d.text,generationInfo:d.generationInfo}))),llmOutput:(c=(u=e.outputs)==null?void 0:u.llmOutput)!=null?c:{}},r="on_llm_end";else throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);await this.sendEndEvent({event:r,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){var i,o,u,c,l,d,h;let t=Zo(e),r=(i=e.run_type)!=null?i:"chain",a={tags:(o=e.tags)!=null?o:[],metadata:(c=(u=e.extra)==null?void 0:u.metadata)!=null?c:{},name:t,runType:e.run_type},s={};e.inputs.input===""&&Object.keys(e.inputs).length===1?(s={},a.inputs={}):e.inputs.input!==void 0?(s.input=e.inputs.input,a.inputs=e.inputs.input):(s.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:s,name:t,tags:(l=e.tags)!=null?l:[],run_id:e.id,metadata:(h=(d=e.extra)==null?void 0:d.metadata)!=null?h:{}},a)}async onChainEnd(e){var o,u,c,l,d;let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,a=(u=(o=e.inputs)!=null?o:t.inputs)!=null?u:{},i={output:(l=(c=e.outputs)==null?void 0:c.output)!=null?l:e.outputs,input:a};a.input&&Object.keys(a).length===1&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:(d=t.metadata)!=null?d:{}},t)}async onToolStart(e){var a,s,i,o,u,c,l,d;let t=Zo(e),r={tags:(a=e.tags)!=null?a:[],metadata:(i=(s=e.extra)==null?void 0:s.metadata)!=null?i:{},name:t,runType:"tool",inputs:(o=e.inputs)!=null?o:{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:(u=e.inputs)!=null?u:{}},name:t,run_id:e.id,tags:(c=e.tags)!=null?c:[],metadata:(d=(l=e.extra)==null?void 0:l.metadata)!=null?d:{}},r)}async onToolEnd(e){var a;let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(t.inputs===void 0)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=((a=e.outputs)==null?void 0:a.output)===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){var s,i,o,u,c,l;let t=Zo(e),a={tags:(s=e.tags)!=null?s:[],metadata:(o=(i=e.extra)==null?void 0:i.metadata)!=null?o:{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:(u=e.tags)!=null?u:[],run_id:e.id,metadata:(l=(c=e.extra)==null?void 0:c.metadata)!=null?l:{}},a)}async onRetrieverEnd(e){var r,a;let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),t===void 0)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:(a=(r=e.outputs)==null?void 0:r.documents)!=null?a:e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){let a=this.runInfoMap.get(r);if(a===void 0)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){let e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};var Lm=pt(ao(),1),Ko=pt(fo(),1),_E=[400,401,402,403,404,405,406,407,409],wE=n=>{var t,r,a;if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;let e=(r=(t=n==null?void 0:n.response)==null?void 0:t.status)!=null?r:n==null?void 0:n.status;if(e&&_E.includes(+e))throw n;if(((a=n==null?void 0:n.error)==null?void 0:a.code)==="insufficient_quota"){let s=new Error(n==null?void 0:n.message);throw s.name="InsufficientQuotaError",s}},Ir=class{constructor(e){var r,a,s;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(r=e.maxConcurrency)!=null?r:1/0,this.maxRetries=(a=e.maxRetries)!=null?a:6,this.onFailedAttempt=(s=e.onFailedAttempt)!=null?s:wE;let t="default"in Ko.default?Ko.default.default:Ko.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,Lm.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var oi=class extends Et{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function ui(n){return n?n.lc_runnable:!1}var Jo=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){var s;let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,a=(s=e.tags)!=null?s:[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(i=>{var o;return(o=this.includeTags)==null?void 0:o.includes(i)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(i=>{var o;return!((o=this.excludeTags)!=null&&o.includes(i))})),r}};var Mm=Symbol("Let zodToJsonSchema decide on which parser to use"),Dm={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Fm=n=>typeof n=="string"?{...Dm,name:n}:{...Dm,...n};var Um=n=>{let e=Fm(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function Ol(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function ee(n,e,t,r,a){n[e]=t,Ol(n,e,r,a)}function zm(){return{}}function Bm(n,e){var r,a,s;let t={type:"array"};return(r=n.type)!=null&&r._def&&((s=(a=n.type)==null?void 0:a._def)==null?void 0:s.typeName)!==w.ZodAny&&(t.items=F(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&ee(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&ee(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(ee(t,"minItems",n.exactLength.value,n.exactLength.message,e),ee(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function qm(n,e){let t={type:"integer",format:"int64"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?ee(t,"minimum",r.value,r.message,e):ee(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),ee(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?ee(t,"maximum",r.value,r.message,e):ee(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),ee(t,"maximum",r.value,r.message,e));break;case"multipleOf":ee(t,"multipleOf",r.value,r.message,e);break}return t}function Vm(){return{type:"boolean"}}function Wo(n,e){return F(n.type._def,e)}var Hm=(n,e)=>F(n.innerType._def,e);function xl(n,e,t){let r=t!=null?t:e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>xl(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return vE(n,e)}}var vE=(n,e)=>{let t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(let r of n.checks)switch(r.kind){case"min":ee(t,"minimum",r.value,r.message,e);break;case"max":ee(t,"maximum",r.value,r.message,e);break}return t};function Zm(n,e){return{...F(n.innerType._def,e),default:n.defaultValue()}}function Gm(n,e){return e.effectStrategy==="input"?F(n.schema._def,e):{}}function Km(n){return{type:"string",enum:Array.from(n.values)}}var AE=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function Jm(n,e){let t=[F(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),F(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s),r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,a=[];return t.forEach(s=>{if(AE(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){let{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function Wm(n,e){let t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}var Il,Mt={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Il===void 0&&(Il=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Il),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function Xo(n,e){let t={type:"string"};if(n.checks)for(let r of n.checks)switch(r.kind){case"min":ee(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":ee(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Ft(t,"email",r.message,e);break;case"format:idn-email":Ft(t,"idn-email",r.message,e);break;case"pattern:zod":Ke(t,Mt.email,r.message,e);break}break;case"url":Ft(t,"uri",r.message,e);break;case"uuid":Ft(t,"uuid",r.message,e);break;case"regex":Ke(t,r.regex,r.message,e);break;case"cuid":Ke(t,Mt.cuid,r.message,e);break;case"cuid2":Ke(t,Mt.cuid2,r.message,e);break;case"startsWith":Ke(t,RegExp(`^${Pl(r.value,e)}`),r.message,e);break;case"endsWith":Ke(t,RegExp(`${Pl(r.value,e)}$`),r.message,e);break;case"datetime":Ft(t,"date-time",r.message,e);break;case"date":Ft(t,"date",r.message,e);break;case"time":Ft(t,"time",r.message,e);break;case"duration":Ft(t,"duration",r.message,e);break;case"length":ee(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),ee(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"includes":{Ke(t,RegExp(Pl(r.value,e)),r.message,e);break}case"ip":{r.version!=="v6"&&Ft(t,"ipv4",r.message,e),r.version!=="v4"&&Ft(t,"ipv6",r.message,e);break}case"base64url":Ke(t,Mt.base64url,r.message,e);break;case"jwt":Ke(t,Mt.jwt,r.message,e);break;case"cidr":{r.version!=="v6"&&Ke(t,Mt.ipv4Cidr,r.message,e),r.version!=="v4"&&Ke(t,Mt.ipv6Cidr,r.message,e);break}case"emoji":Ke(t,Mt.emoji(),r.message,e);break;case"ulid":{Ke(t,Mt.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Ft(t,"binary",r.message,e);break}case"contentEncoding:base64":{ee(t,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{Ke(t,Mt.base64,r.message,e);break}}break}case"nanoid":Ke(t,Mt.nanoid,r.message,e);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}function Pl(n,e){return e.patternStrategy==="escape"?OE(n):n}var EE=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function OE(n){let e="";for(let t=0;t<n.length;t++)EE.has(n[t])||(e+="\\"),e+=n[t];return e}function Ft(n,e,t,r){var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):ee(n,"format",e,t,r)}function Ke(n,e,t,r){var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Xm(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):ee(n,"pattern",Xm(e,r),t,r)}function Xm(n,e){var u;if(!e.applyRegexFlags||!n.flags)return n.source;let t={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=t.i?n.source.toLowerCase():n.source,a="",s=!1,i=!1,o=!1;for(let c=0;c<r.length;c++){if(s){a+=r[c],s=!1;continue}if(t.i){if(i){if(r[c].match(/[a-z]/)){o?(a+=r[c],a+=`${r[c-2]}-${r[c]}`.toUpperCase(),o=!1):r[c+1]==="-"&&((u=r[c+2])!=null&&u.match(/[a-z]/))?(a+=r[c],o=!0):a+=`${r[c]}${r[c].toUpperCase()}`;continue}}else if(r[c].match(/[a-z]/)){a+=`[${r[c]}${r[c].toUpperCase()}]`;continue}}if(t.m){if(r[c]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(r[c]==="$"){a+=`($|(?=[\r
]))`;continue}}if(t.s&&r[c]==="."){a+=i?`${r[c]}\r
`:`[${r[c]}\r
]`;continue}a+=r[c],r[c]==="\\"?s=!0:i&&r[c]==="]"?i=!1:!i&&r[c]==="["&&(i=!0)}try{new RegExp(a)}catch(c){return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a}function Yo(n,e){var r,a,s,i,o,u,c;if(e.target==="openAi"&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===w.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((l,d)=>{var h;return{...l,[d]:(h=F(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",d]}))!=null?h:{}}},{}),additionalProperties:!1};let t={type:"object",additionalProperties:(a=F(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?a:{}};if(e.target==="openApi3")return t;if(((s=n.keyType)==null?void 0:s._def.typeName)===w.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){let{type:l,...d}=Xo(n.keyType._def,e);return{...t,propertyNames:d}}else{if(((o=n.keyType)==null?void 0:o._def.typeName)===w.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};if(((u=n.keyType)==null?void 0:u._def.typeName)===w.ZodBranded&&n.keyType._def.type._def.typeName===w.ZodString&&((c=n.keyType._def.type._def.checks)!=null&&c.length)){let{type:l,...d}=Wo(n.keyType._def,e);return{...t,propertyNames:d}}}return t}function Ym(n,e){if(e.mapStrategy==="record")return Yo(n,e);let t=F(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=F(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function Qm(n){let e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function eg(){return{not:{}}}function tg(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var ci={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function ng(n,e){if(e.target==="openApi3")return rg(n,e);let t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in ci&&(!r._def.checks||!r._def.checks.length))){let r=t.reduce((a,s)=>{let i=ci[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=t.reduce((a,s)=>{let i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){let a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return rg(n,e)}var rg=(n,e)=>{let t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>F(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function ag(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:ci[n.innerType._def.typeName],nullable:!0}:{type:[ci[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let r=F(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let t=F(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function sg(n,e){let t={type:"number"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"int":t.type="integer",Ol(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?ee(t,"minimum",r.value,r.message,e):ee(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),ee(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?ee(t,"maximum",r.value,r.message,e):ee(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),ee(t,"maximum",r.value,r.message,e));break;case"multipleOf":ee(t,"multipleOf",r.value,r.message,e);break}return t}function xE(n,e){var t,r;return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":(t=F(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?t:!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":(r=F(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?r:!0}function ig(n,e){let t=e.target==="openAi",r={type:"object",...Object.entries(n.shape()).reduce((a,[s,i])=>{if(i===void 0||i._def===void 0)return a;let o=i.isOptional();o&&t&&(i instanceof et&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);let u=F(i._def,{...e,currentPath:[...e.currentPath,"properties",s],propertyPath:[...e.currentPath,"properties",s]});return u===void 0?a:{properties:{...a.properties,[s]:u},required:o?a.required:[...a.required,s]}},{properties:{},required:[]}),additionalProperties:xE(n,e)};return r.required.length||delete r.required,r}var og=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return F(n.innerType._def,e);let t=F(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}};var ug=(n,e)=>{if(e.pipeStrategy==="input")return F(n.in._def,e);if(e.pipeStrategy==="output")return F(n.out._def,e);let t=F(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=F(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function cg(n,e){return F(n.type._def,e)}function lg(n,e){let r={type:"array",uniqueItems:!0,items:F(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&ee(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&ee(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function dg(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>F(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:F(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>F(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function hg(){return{not:{}}}function fg(){return{}}var pg=(n,e)=>F(n.innerType._def,e);function F(n,e,t=!1){var i;let r=e.seen.get(n);if(e.override){let o=(i=e.override)==null?void 0:i.call(e,n,e,r,t);if(o!==Mm)return o}if(r&&!t){let o=IE(r,e);if(o!==void 0)return o}let a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);let s=TE(n,n.typeName,e);return s&&SE(n,e,s),a.jsonSchema=s,s}var IE=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:PE(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},PE=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},TE=(n,e,t)=>{switch(e){case w.ZodString:return Xo(n,t);case w.ZodNumber:return sg(n,t);case w.ZodObject:return ig(n,t);case w.ZodBigInt:return qm(n,t);case w.ZodBoolean:return Vm();case w.ZodDate:return xl(n,t);case w.ZodUndefined:return hg();case w.ZodNull:return tg(t);case w.ZodArray:return Bm(n,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return ng(n,t);case w.ZodIntersection:return Jm(n,t);case w.ZodTuple:return dg(n,t);case w.ZodRecord:return Yo(n,t);case w.ZodLiteral:return Wm(n,t);case w.ZodEnum:return Km(n);case w.ZodNativeEnum:return Qm(n);case w.ZodNullable:return ag(n,t);case w.ZodOptional:return og(n,t);case w.ZodMap:return Ym(n,t);case w.ZodSet:return lg(n,t);case w.ZodLazy:return F(n.getter()._def,t);case w.ZodPromise:return cg(n,t);case w.ZodNaN:case w.ZodNever:return eg();case w.ZodEffects:return Gm(n,t);case w.ZodAny:return zm();case w.ZodUnknown:return fg();case w.ZodDefault:return Zm(n,t);case w.ZodBranded:return Wo(n,t);case w.ZodReadonly:return pg(n,t);case w.ZodCatch:return Hm(n,t);case w.ZodPipeline:return ug(n,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(r=>{})(e)}},SE=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t);var Pt=(n,e)=>{var u;let t=Um(e),r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((c,[l,d])=>{var h;return{...c,[l]:(h=F(d._def,{...t,currentPath:[...t.basePath,t.definitionPath,l]},!0))!=null?h:{}}},{}):void 0,a=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,s=(u=F(n._def,a===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,a]},!1))!=null?u:{},i=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;i!==void 0&&(s.title=i);let o=a===void 0?r?{...s,[t.definitionPath]:r}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:s}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":(t.target==="jsonSchema2019-09"||t.target==="openAi")&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),t.target==="openAi"&&("anyOf"in o||"oneOf"in o||"allOf"in o||"type"in o&&Array.isArray(o.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),o};function Tl(n){return n.replace(/[^a-zA-Z-_0-9]/g,"_")}var kE=["*","_","`"];function CE(n){let e="";for(let[t,r]of Object.entries(n))e+=`	classDef ${t} ${r};
`;return e}function mg(n,e,t){var f,p,g,y,m;let{firstNode:r,lastNode:a,nodeColors:s,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:u=9}=t!=null?t:{},c=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:`graph TD;
`;if(i){let b="default",A={[b]:"{0}({1})"};r!==void 0&&(A[r]="{0}([{1}]):::first"),a!==void 0&&(A[a]="{0}([{1}]):::last");for(let[I,_]of Object.entries(n)){let v=(f=_.name.split(":").pop())!=null?f:"",O=kE.some(L=>v.startsWith(L)&&v.endsWith(L))?`<p>${v}</p>`:v;Object.keys((p=_.metadata)!=null?p:{}).length&&(O+=`<hr/><small><em>${Object.entries((g=_.metadata)!=null?g:{}).map(([L,q])=>`${L} = ${q}`).join(`
`)}</em></small>`);let S=((y=A[I])!=null?y:A[b]).replace("{0}",Tl(I)).replace("{1}",O);c+=`	${S}
`}}let l={};for(let b of e){let A=b.source.split(":"),I=b.target.split(":"),_=A.filter((v,E)=>v===I[E]).join(":");l[_]||(l[_]=[]),l[_].push(b)}let d=new Set;function h(b,A){let I=b.length===1&&b[0].source===b[0].target;if(A&&!I){let _=A.split(":").pop();if(d.has(_))throw new Error(`Found duplicate subgraph '${_}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(_),c+=`	subgraph ${_}
`}for(let _ of b){let{source:v,target:E,data:O,conditional:S}=_,L="";if(O!==void 0){let q=O,V=q.split(" ");V.length>u&&(q=Array.from({length:Math.ceil(V.length/u)},(de,Ie)=>V.slice(Ie*u,(Ie+1)*u).join(" ")).join("&nbsp;<br>&nbsp;")),L=S?` -. &nbsp;${q}&nbsp; .-> `:` -- &nbsp;${q}&nbsp; --> `}else L=S?" -.-> ":" --> ";c+=`	${Tl(v)}${L}${Tl(E)};
`}for(let _ in l)_.startsWith(`${A}:`)&&_!==A&&h(l[_],_);A&&!I&&(c+=`	end
`)}h((m=l[""])!=null?m:[],"");for(let b in l)!b.includes(":")&&b!==""&&h(l[b],b);return i&&(c+=CE(s!=null?s:{})),c}async function gg(n,e){let{backgroundColor:t="white"}=e!=null?e:{},r=btoa(n);t!==void 0&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(t)||(t=`!${t}`));let a=`https://mermaid.ink/img/${r}?bgColor=${t}`,s=await fetch(a);if(!s.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${s.status}`,`Status text: ${s.statusText}`].join(`
`));return await s.blob()}function RE(n,e){var t;if(n!==void 0&&!Zr(n))return n;if(ui(e))try{let r=e.getName();return r=r.startsWith("Runnable")?r.slice(8):r,r}catch(r){return e.getName()}else return(t=e.name)!=null?t:"UnknownSchema"}function NE(n){return ui(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...Pt(n.data.schema),title:n.data.name}}}var li=class n{constructor(e){var t,r;Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=(t=e==null?void 0:e.nodes)!=null?t:this.nodes,this.edges=(r=e==null?void 0:e.edges)!=null?r:this.edges}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Zr(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...NE(t)})),edges:this.edges.map(t=>{let r={source:e[t.source],target:e[t.target]};return typeof t.data!="undefined"&&(r.data=t.data),typeof t.conditional!="undefined"&&(r.conditional=t.conditional),r})}}addNode(e,t,r){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let a=t!=null?t:pe(),s={id:a,data:e,name:RE(t,e),metadata:r};return this.nodes[a]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let s={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(s),s}firstNode(){return yg(this)}lastNode(){return bg(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map(c=>c.id).every(Zr)&&(r="");let s=c=>r?`${r}:${c}`:c;Object.entries(e.nodes).forEach(([c,l])=>{this.nodes[s(c)]={...l,id:s(c)}});let i=e.edges.map(c=>({...c,source:s(c.source),target:s(c.target)}));this.edges=[...this.edges,...i];let o=e.firstNode(),u=e.lastNode();return[o?{id:s(o.id),data:o.data}:void 0,u?{id:s(u.id),data:u.data}:void 0]}trimFirstNode(){let e=this.firstNode();e&&yg(this,[e.id])&&this.removeNode(e)}trimLastNode(){let e=this.lastNode();e&&bg(this,[e.id])&&this.removeNode(e)}reid(){let e=Object.fromEntries(Object.values(this.nodes).map(a=>[a.id,a.name])),t=new Map;Object.values(e).forEach(a=>{t.set(a,(t.get(a)||0)+1)});let r=a=>{let s=e[a];return Zr(a)&&t.get(s)===1?s:a};return new n({nodes:Object.fromEntries(Object.entries(this.nodes).map(([a,s])=>[r(a),{...s,id:r(a)}])),edges:this.edges.map(a=>({...a,source:r(a.source),target:r(a.target)}))})}drawMermaid(e){let{withStyles:t,curveStyle:r,nodeColors:a={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:s}=e!=null?e:{},i=this.reid(),o=i.firstNode(),u=i.lastNode();return mg(i.nodes,i.edges,{firstNode:o==null?void 0:o.id,lastNode:u==null?void 0:u.id,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:s})}async drawMermaidPng(e){let t=this.drawMermaid(e);return gg(t,{backgroundColor:e==null?void 0:e.backgroundColor})}};function yg(n,e=[]){let t=new Set(n.edges.filter(a=>!e.includes(a.source)).map(a=>a.target)),r=[];for(let a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function bg(n,e=[]){let t=new Set(n.edges.filter(a=>!e.includes(a.target)).map(a=>a.source)),r=[];for(let a of Object.values(n.nodes))!e.includes(a.id)&&!t.has(a.id)&&r.push(a);return r.length===1?r[0]:void 0}function _g(n){let e=new TextEncoder,t=new ReadableStream({async start(r){for await(let a of n)r.enqueue(e.encode(`event: data
data: ${JSON.stringify(a)}

`));r.enqueue(e.encode(`event: end

`)),r.close()}});return ze.fromReadableStream(t)}function Sl(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.iterator]=="function"&&typeof n.next=="function"}var wg=n=>n!=null&&typeof n=="object"&&"next"in n&&typeof n.next=="function";function Qo(n){return typeof n=="object"&&n!==null&&typeof n[Symbol.asyncIterator]=="function"}function*kl(n,e){for(;;){let{value:t,done:r}=st.runWithConfig(Lt(n),e.next.bind(e),!0);if(r)break;yield t}}async function*eu(n,e){let t=e[Symbol.asyncIterator]();for(;;){let{value:r,done:a}=await st.runWithConfig(Lt(n),t.next.bind(e),!0);if(a)break;yield r}}function Oe(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}var ie=class extends $t{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){var r,a;let t=(a=(r=this.name)!=null?r:this.constructor.lc_name())!=null?a:this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Tr({bound:this,kwargs:e,config:{}})}map(){return new tu({bound:this})}withRetry(e){return new ru({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Tr({bound:this,config:e,kwargs:{}})}withFallbacks(e){let t=Array.isArray(e)?e:e.fallbacks;return new nu({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(Q);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([a])=>a!=="runId"));return Array.from({length:t},(a,s)=>Q(s===0?e:r))}return Array.from({length:t},()=>Q(e))}async batch(e,t,r){var u,c;let a=this._getOptionsList(t!=null?t:{},e.length),s=(c=(u=a[0])==null?void 0:u.maxConcurrency)!=null?c:r==null?void 0:r.maxConcurrency,i=new Ir({maxConcurrency:s,onFailedAttempt:l=>{throw l}}),o=e.map((l,d)=>i.call(async()=>{try{return await this.invoke(l,a[d])}catch(h){if(r!=null&&r.returnExceptions)return h;throw h}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=Q(t),a=new xr({generator:this._streamIterator(e,r),config:r});return await a.setup,ze.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;e===void 0?t=Q(e):t=Q({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){var u;let a=Q(r),s=await it(a),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),Oe(t,"input"),a.runId,a==null?void 0:a.runType,void 0,void 0,(u=a==null?void 0:a.runName)!=null?u:this.getName()));delete a.runId;let o;try{let c=e.call(this,t,a,i);o=await sr(c,r==null?void 0:r.signal)}catch(c){throw await(i==null?void 0:i.handleChainError(c)),c}return await(i==null?void 0:i.handleChainEnd(Oe(o,"output"))),o}async _batchWithConfig(e,t,r,a){var c;let s=this._getOptionsList(r!=null?r:{},t.length),i=await Promise.all(s.map(it)),o=await Promise.all(i.map(async(l,d)=>{var f;let h=await(l==null?void 0:l.handleChainStart(this.toJSON(),Oe(t[d],"input"),s[d].runId,s[d].runType,void 0,void 0,(f=s[d].runName)!=null?f:this.getName()));return delete s[d].runId,h})),u;try{let l=e.call(this,t,s,o,a);u=await sr(l,(c=s==null?void 0:s[0])==null?void 0:c.signal)}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(Oe(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0,u=Q(r),c=await it(u);async function*l(){for await(let h of e){if(s)if(a===void 0)a=h;else try{a=Te(a,h)}catch(f){a=void 0,s=!1}yield h}}let d;try{let h=await Cm(t.bind(this),l(),async()=>{var y;return c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},u.runId,u.runType,void 0,void 0,(y=u.runName)!=null?y:this.getName())},r==null?void 0:r.signal,u);delete u.runId,d=h.setup;let f=d==null?void 0:d.handlers.find(jm),p=h.output;f!==void 0&&d!==void 0&&(p=f.tapOutputIterable(d.runId,p));let g=d==null?void 0:d.handlers.find($m);g!==void 0&&d!==void 0&&(p=g.tapOutputIterable(d.runId,p));for await(let y of p)if(yield y,o)if(i===void 0)i=y;else try{i=Te(i,y)}catch(m){i=void 0,o=!1}}catch(h){throw await(d==null?void 0:d.handleChainError(h,void 0,void 0,void 0,{inputs:Oe(a,"input")})),h}await(d==null?void 0:d.handleChainEnd(i!=null?i:{},void 0,void 0,void 0,{inputs:Oe(a,"input")}))}getGraph(e){let t=new li,r=t.addNode({name:`${this.getName()}Input`,schema:_t.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:_t.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new Sr({first:this,last:Pr(e)})}pick(e){return this.pipe(new au(e))}assign(e){return this.pipe(new ts(new Wr({steps:e})))}async*transform(e,t){let r;for await(let a of e)r===void 0?r=a:r=Te(r,a);yield*this._streamIterator(r,Q(t))}async*streamLog(e,t,r){let a=new ii({...r,autoClose:!1,_schemaFormat:"original"}),s=Q(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){let{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let u=a.copy();u.addHandler(t,!0),r.callbacks=u}let s=this.stream(e,r);async function i(){try{let u=await s;for await(let c of u){let l=new Dt({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(l)}}finally{await t.writer.close()}}let o=i();try{for await(let u of t)yield u}finally{await o}}streamEvents(e,t,r){let a;if(t.version==="v1")a=this._streamEventsV1(e,t,r);else if(t.version==="v2")a=this._streamEventsV2(e,t,r);else throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');return t.encoding==="text/event-stream"?_g(a):ze.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){var f,p;let a=new Go({...r,autoClose:!1}),s=Q(t),i=(f=s.runId)!=null?f:pe();s.runId=i;let o=s.callbacks;if(o===void 0)s.callbacks=[a];else if(Array.isArray(o))s.callbacks=o.concat(a);else{let g=o.copy();g.addHandler(a,!0),s.callbacks=g}let u=this;async function c(){try{let g=await u.stream(e,s),y=a.tapOutputIterable(i,g);for await(let m of y);}finally{await a.finish()}}let l=c(),d=!1,h;try{for await(let g of a){if(!d){g.data.input=e,d=!0,h=g.run_id,yield g;continue}g.run_id===h&&g.event.endsWith("_end")&&(p=g.data)!=null&&p.input&&delete g.data.input,yield g}}finally{await l}}async*_streamEventsV1(e,t,r){var p,g,y;let a,s=!1,i=Q(t),o=(p=i.tags)!=null?p:[],u=(g=i.metadata)!=null?g:{},c=(y=i.runName)!=null?y:this.getName(),l=new ii({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new Jo({...r}),h=this._streamLog(e,l,i);for await(let m of h){if(a?a=a.concat(m):a=si.fromRunLogPatch(m),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;let _={...a.state},v={run_id:_.id,event:`on_${_.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};d.includeEvent(v,_.type)&&(yield v)}let b=m.ops.filter(_=>_.path.startsWith("/logs/")).map(_=>_.path.split("/")[2]),A=[...new Set(b)];for(let _ of A){let v,E={},O=a.state.logs[_];if(O.end_time===void 0?O.streamed_output.length>0?v="stream":v="start":v="end",v==="start")O.inputs!==void 0&&(E.input=O.inputs);else if(v==="end")O.inputs!==void 0&&(E.input=O.inputs),E.output=O.final_output;else if(v==="stream"){let S=O.streamed_output.length;if(S!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${S} instead. Encountered in: "${O.name}"`);E={chunk:O.streamed_output[0]},O.streamed_output=[]}yield{event:`on_${O.type}_${v}`,name:O.name,run_id:O.id,tags:O.tags,metadata:O.metadata,data:E}}let{state:I}=a;if(I.streamed_output.length>0){let _=I.streamed_output.length;if(_!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${_} instead. Encountered in: "${I.name}"`);let v={chunk:I.streamed_output[0]};I.streamed_output=[];let E={event:`on_${I.type}_stream`,run_id:I.id,tags:o,metadata:u,name:c,data:v};d.includeEvent(E,I.type)&&(yield E)}}let f=a==null?void 0:a.state;if(f!==void 0){let m={event:`on_${f.type}_end`,name:c,run_id:f.id,tags:o,metadata:u,data:{output:f.final_output}};d.includeEvent(m,f.type)&&(yield m)}}static isRunnable(e){return ui(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Tr({bound:this,config:{},configFactories:[a=>({callbacks:[new oi({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return jE(this,e)}},Tr=class n extends ie{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=Vo(this.config,...e);return Vo(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(Q(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(Q(s),this.kwargs))):await this._mergeConfig(Q(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(Q(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(Q(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(Q(t),this.kwargs))}streamEvents(e,t,r){let a=this,s=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(Q(t),a.kwargs),version:t.version},r)};return ze.fromAsyncGenerator(s())}static isRunnableBinding(e){return e.bound&&ie.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new oi({config:a,onStart:e,onEnd:t,onError:r})]})]})}},tu=class n extends ie{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new n({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,we(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},ru=class extends Tr{static lc_name(){return"RunnableRetry"}constructor(e){var t,r;super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=(t=e.maxAttemptNumber)!=null?t:this.maxAttemptNumber,this.onFailedAttempt=(r=e.onFailedAttempt)!=null?r:this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return we(t,{callbacks:r==null?void 0:r.getChild(a)})}async _invoke(e,t,r){return(0,Cl.default)(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:a=>this.onFailedAttempt(a,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,a){let s={};try{await(0,Cl.default)(async i=>{let o=e.map((h,f)=>f).filter(h=>s[h.toString()]===void 0||s[h.toString()]instanceof Error),u=o.map(h=>e[h]),c=o.map(h=>this._patchConfigForRetry(i,t==null?void 0:t[h],r==null?void 0:r[h])),l=await super.batch(u,c,{...a,returnExceptions:!0}),d;for(let h=0;h<l.length;h+=1){let f=l[h],p=o[h];f instanceof Error&&d===void 0&&(d=f,d.input=u[h]),s[p.toString()]=f}if(d)throw d;return l},{onFailedAttempt:i=>this.onFailedAttempt(i,i.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((a==null?void 0:a.returnExceptions)!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},Sr=class n extends ie{static lc_name(){return"RunnableSequence"}constructor(e){var t,r;super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=(t=e.middle)!=null?t:this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=(r=e.omitSequenceTags)!=null?r:this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){var u;let r=Q(t),a=await it(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),Oe(e,"input"),r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;let i=e,o;try{let c=[this.first,...this.middle];for(let l=0;l<c.length;l+=1){let h=c[l].invoke(i,we(r,{callbacks:s==null?void 0:s.getChild(this.omitSequenceTags?void 0:`seq:step:${l+1}`)}));i=await sr(h,t==null?void 0:t.signal)}if((u=t==null?void 0:t.signal)!=null&&u.aborted)throw new Error("Aborted");o=await this.last.invoke(i,we(r,{callbacks:s==null?void 0:s.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(c){throw await(s==null?void 0:s.handleChainError(c)),c}return await(s==null?void 0:s.handleChainEnd(Oe(o,"output"))),o}async batch(e,t,r){var u;let a=this._getOptionsList(t!=null?t:{},e.length),s=await Promise.all(a.map(it)),i=await Promise.all(s.map(async(c,l)=>{let d=await(c==null?void 0:c.handleChainStart(this.toJSON(),Oe(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName));return delete a[l].runId,d})),o=e;try{for(let c=0;c<this.steps.length;c+=1){let d=this.steps[c].batch(o,i.map((h,f)=>{let p=h==null?void 0:h.getChild(this.omitSequenceTags?void 0:`seq:step:${c+1}`);return we(a[f],{callbacks:p})}),r);o=await sr(d,(u=a[0])==null?void 0:u.signal)}}catch(c){throw await Promise.all(i.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(i.map(c=>c==null?void 0:c.handleChainEnd(Oe(o,"output")))),o}async*_streamIterator(e,t){var d;let r=await it(t),{runId:a,...s}=t!=null?t:{},i=await(r==null?void 0:r.handleChainStart(this.toJSON(),Oe(e,"input"),a,void 0,void 0,void 0,s==null?void 0:s.runName)),o=[this.first,...this.middle,this.last],u=!0,c;async function*l(){yield e}try{let h=o[0].transform(l(),we(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let f=1;f<o.length;f+=1)h=await o[f].transform(h,we(s,{callbacks:i==null?void 0:i.getChild(this.omitSequenceTags?void 0:`seq:step:${f+1}`)}));for await(let f of h)if((d=t==null?void 0:t.signal)==null||d.throwIfAborted(),yield f,u)if(c===void 0)c=f;else try{c=Te(c,f)}catch(p){c=void 0,u=!1}}catch(h){throw await(i==null?void 0:i.handleChainError(h)),h}await(i==null?void 0:i.handleChainEnd(Oe(c,"output")))}getGraph(e){let t=new li,r=null;return this.steps.forEach((a,s)=>{let i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);let o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){var t;return n.isRunnableSequence(e)?new n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:(t=this.name)!=null?t:e.name}):new n({first:this.first,middle:[...this.middle,this.last],last:Pr(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&ie.isRunnable(e)}static from([e,...t],r){let a={};return typeof r=="string"?a.name=r:r!==void 0&&(a=r),new n({...a,first:Pr(e),middle:t.slice(0,-1).map(Pr),last:Pr(t[t.length-1])})}},Wr=class n extends ie{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=Pr(r)}static from(e){return new n({steps:e})}async invoke(e,t){let r=Q(t),a=await it(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r==null?void 0:r.runName));delete r.runId;let i={};try{let o=Object.entries(this.steps).map(async([u,c])=>{i[u]=await c.invoke(e,we(r,{callbacks:s==null?void 0:s.getChild(`map:key:${u}`)}))});await sr(Promise.all(o),t==null?void 0:t.signal)}catch(o){throw await(s==null?void 0:s.handleChainError(o)),o}return await(s==null?void 0:s.handleChainEnd(i)),i}async*_transform(e,t,r){let a={...this.steps},s=El(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],c)=>{let l=u.transform(s[c],we(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){let o=Promise.race(i.values()),{key:u,result:c,gen:l}=await sr(o,r==null?void 0:r.signal);i.delete(u),c.done||(yield{[u]:c.value},i.set(u,l.next().then(d=>({key:u,gen:l,result:d}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=Q(t),s=new xr({generator:this.transform(r(),a),config:a});return await s.setup,ze.fromAsyncGenerator(s)}},Rl=class n extends ie{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Ro(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t!=null?t:{},1),a=await it(r),s=this.func(we(r,{callbacks:a}),e);return sr(s,r==null?void 0:r.signal)}async*_streamIterator(e,t){var s,i;let[r]=this._getOptionsList(t!=null?t:{},1),a=await this.invoke(e,t);if(Qo(a)){for await(let o of a)(s=r==null?void 0:r.signal)==null||s.throwIfAborted(),yield o;return}if(wg(a)){for(;;){(i=r==null?void 0:r.signal)==null||i.throwIfAborted();let o=a.next();if(o.done)break;yield o.value}return}yield a}static from(e){return new n({func:e})}};function $E(n){if(Ro(n))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}var kr=class n extends ie{static lc_name(){return"RunnableLambda"}constructor(e){if(Ro(e.func))return Rl.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),$E(e.func),this.func=e.func}static from(e){return new n({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{var o;let i=we(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((o=t==null?void 0:t.recursionLimit)!=null?o:qo)-1});st.runWithConfig(Lt(i),async()=>{var u,c,l;try{let d=await this.func(e,{...i});if(d&&ie.isRunnable(d)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");d=await d.invoke(e,{...i,recursionLimit:((u=i.recursionLimit)!=null?u:qo)-1})}else if(Qo(d)){let h;for await(let f of eu(i,d))if((c=t==null?void 0:t.signal)==null||c.throwIfAborted(),h===void 0)h=f;else try{h=Te(h,f)}catch(p){h=f}d=h}else if(Sl(d)){let h;for(let f of kl(i,d))if((l=t==null?void 0:t.signal)==null||l.throwIfAborted(),h===void 0)h=f;else try{h=Te(h,f)}catch(p){h=f}d=h}a(d)}catch(d){s(d)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,r){var o,u,c;let a;for await(let l of e)if(a===void 0)a=l;else try{a=Te(a,l)}catch(d){a=l}let s=we(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((o=r==null?void 0:r.recursionLimit)!=null?o:qo)-1}),i=await new Promise((l,d)=>{st.runWithConfig(Lt(s),async()=>{try{let h=await this.func(a,{...s,config:s});l(h)}catch(h){d(h)}})});if(i&&ie.isRunnable(i)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");let l=await i.stream(a,s);for await(let d of l)yield d}else if(Qo(i))for await(let l of eu(s,i))(u=r==null?void 0:r.signal)==null||u.throwIfAborted(),yield l;else if(Sl(i))for(let l of kl(s,i))(c=r==null?void 0:r.signal)==null||c.throwIfAborted(),yield l;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=Q(t),s=new xr({generator:this.transform(r(),a),config:a});return await s.setup,ze.fromAsyncGenerator(s)}};var nu=class extends ie{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=Q(t),a=await it(r),{runId:s,...i}=r,o=await(a==null?void 0:a.handleChainStart(this.toJSON(),Oe(e,"input"),s,void 0,void 0,void 0,i==null?void 0:i.runName)),u=we(i,{callbacks:o==null?void 0:o.getChild()});return await st.runWithConfig(u,async()=>{var d;let l;for(let h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();try{let f=await h.invoke(e,u);return await(o==null?void 0:o.handleChainEnd(Oe(f,"output"))),f}catch(f){l===void 0&&(l=f)}}throw l===void 0?new Error("No error stored at end of fallback."):(await(o==null?void 0:o.handleChainError(l)),l)})}async*_streamIterator(e,t){var d;let r=Q(t),a=await it(r),{runId:s,...i}=r,o=await(a==null?void 0:a.handleChainStart(this.toJSON(),Oe(e,"input"),s,void 0,void 0,void 0,i==null?void 0:i.runName)),u,c;for(let h of this.runnables()){(d=r==null?void 0:r.signal)==null||d.throwIfAborted();let f=we(i,{callbacks:o==null?void 0:o.getChild()});try{let p=await h.stream(e,f);c=eu(f,p);break}catch(p){u===void 0&&(u=p)}}if(c===void 0){let h=u!=null?u:new Error("No error stored at end of fallback.");throw await(o==null?void 0:o.handleChainError(h)),h}let l;try{for await(let h of c){yield h;try{l=l===void 0?l:Te(l,h)}catch(f){l=void 0}}}catch(h){throw await(o==null?void 0:o.handleChainError(h)),h}await(o==null?void 0:o.handleChainEnd(Oe(l,"output")))}async batch(e,t,r){var u;if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");let a=this._getOptionsList(t!=null?t:{},e.length),s=await Promise.all(a.map(c=>it(c))),i=await Promise.all(s.map(async(c,l)=>{let d=await(c==null?void 0:c.handleChainStart(this.toJSON(),Oe(e[l],"input"),a[l].runId,void 0,void 0,void 0,a[l].runName));return delete a[l].runId,d})),o;for(let c of this.runnables()){(u=a[0].signal)==null||u.throwIfAborted();try{let l=await c.batch(e,i.map((d,h)=>we(a[h],{callbacks:d==null?void 0:d.getChild()})),r);return await Promise.all(i.map((d,h)=>d==null?void 0:d.handleChainEnd(Oe(l[h],"output")))),l}catch(l){o===void 0&&(o=l)}}throw o?(await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function Pr(n){if(typeof n=="function")return new kr({func:n});if(ie.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){let e={};for(let[t,r]of Object.entries(n))e[t]=Pr(r);return new Wr({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var ts=class extends ie{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Wr&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let a=this.mapper.getStepsKeys(),[s,i]=El(e),o=this.mapper.transform(i,we(r,{callbacks:t==null?void 0:t.getChild()})),u=o.next();for await(let c of s){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);let l=Object.fromEntries(Object.entries(c).filter(([d])=>!a.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(let c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=Q(t),s=new xr({generator:this.transform(r(),a),config:a});return await s.setup,ze.fromAsyncGenerator(s)}},au=class extends ie{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=Q(t),s=new xr({generator:this.transform(r(),a),config:a});return await s.setup,ze.fromAsyncGenerator(s)}},di=class extends Tr{constructor(e){var r;let t=Sr.from([kr.from(async a=>{let s;if(Fa(a))try{s=await this.schema.parseAsync(a.args)}catch(i){throw new Ma("Received tool input did not match expected schema",JSON.stringify(a.args))}else s=a;return s}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name});super({bound:t,config:(r=e.config)!=null?r:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};function jE(n,e){var a,s,i;let t=(a=e.name)!=null?a:n.getName(),r=(i=e.description)!=null?i:(s=e.schema)==null?void 0:s.description;return e.schema.constructor===_t.ZodString?new di({name:t,description:r,schema:_t.object({input:_t.string()}).transform(o=>o.input),bound:n}):new di({name:t,description:r,schema:e.schema,bound:n})}var LE=typeof window=="object"?window:{},J="0123456789abcdef".split(""),DE=[-2147483648,8388608,32768,128],Ut=[24,16,8,0];var Se=[];function zt(n){n?(Se[0]=Se[16]=Se[1]=Se[2]=Se[3]=Se[4]=Se[5]=Se[6]=Se[7]=Se[8]=Se[9]=Se[10]=Se[11]=Se[12]=Se[13]=Se[14]=Se[15]=0,this.blocks=Se):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}zt.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===LE.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<Ut[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<Ut[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<Ut[a++&3],i[a>>2]|=(128|t&63)<<Ut[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<Ut[a++&3],i[a>>2]|=(128|t>>6&63)<<Ut[a++&3],i[a>>2]|=(128|t&63)<<Ut[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<Ut[a++&3],i[a>>2]|=(128|t>>12&63)<<Ut[a++&3],i[a>>2]|=(128|t>>6&63)<<Ut[a++&3],i[a>>2]|=(128|t&63)<<Ut[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};zt.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=DE[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};zt.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0};zt.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return J[n>>28&15]+J[n>>24&15]+J[n>>20&15]+J[n>>16&15]+J[n>>12&15]+J[n>>8&15]+J[n>>4&15]+J[n&15]+J[e>>28&15]+J[e>>24&15]+J[e>>20&15]+J[e>>16&15]+J[e>>12&15]+J[e>>8&15]+J[e>>4&15]+J[e&15]+J[t>>28&15]+J[t>>24&15]+J[t>>20&15]+J[t>>16&15]+J[t>>12&15]+J[t>>8&15]+J[t>>4&15]+J[t&15]+J[r>>28&15]+J[r>>24&15]+J[r>>20&15]+J[r>>16&15]+J[r>>12&15]+J[r>>8&15]+J[r>>4&15]+J[r&15]+J[a>>28&15]+J[a>>24&15]+J[a>>20&15]+J[a>>16&15]+J[a>>12&15]+J[a>>8&15]+J[a>>4&15]+J[a&15]};zt.prototype.toString=zt.prototype.hex;zt.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]};zt.prototype.array=zt.prototype.digest;zt.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};var Nl=n=>new zt(!0).update(n).hex();var vg=(...n)=>Nl(n.join("_"));var $l=class{},ME=new Map,su=class n extends $l{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e!=null?e:new Map}lookup(e,t){var r;return Promise.resolve((r=this.cache.get(vg(e,t)))!=null?r:null)}async update(e,t,r){this.cache.set(vg(e,t),r)}static global(){return new n(ME)}};var iu=class extends $t{},ou=class extends iu{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new dt(this.value)]}},uu=class extends iu{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Fs(this.messages)}toChatMessages(){return this.messages}};var xg=pt(Og(),1);var ZE=Object.defineProperty,GE=(n,e,t)=>e in n?ZE(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,KE=(n,e,t)=>(GE(n,typeof e!="symbol"?e+"":e,t),t);function JE(n,e){let t=Array.from({length:n.length},(r,a)=>({start:a,end:a+1}));for(;t.length>1;){let r=null;for(let a=0;a<t.length-1;a++){let s=n.slice(t[a].start,t[a+1].end),i=e.get(s.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,a])}if(r!=null){let a=r[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function WE(n,e){return n.length===1?[e.get(n.join(","))]:JE(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function XE(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Ll=class{constructor(n,e){ne(this,"specialTokens");ne(this,"inverseSpecialTokens");ne(this,"patStr");ne(this,"textEncoder",new TextEncoder);ne(this,"textDecoder",new TextDecoder("utf-8"));ne(this,"rankMap",new Map);ne(this,"textMap",new Map);this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,a)=>{let[s,i,...o]=a.split(" "),u=Number.parseInt(i,10);return o.forEach((c,l)=>r[c]=u+l),r},{});for(let[r,a]of Object.entries(t)){let s=xg.default.toByteArray(r);this.rankMap.set(s.join(","),a),this.textMap.set(a,s)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[a,s])=>(r[s]=this.textEncoder.encode(a),r),{})}encode(n,e=[],t="all"){var c;let r=new RegExp(this.patStr,"ug"),a=Ll.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!i.has(l)):t);if(o.size>0){let l=Ll.specialTokenRegex([...o]),d=n.match(l);if(d!=null)throw new Error(`The text contains a special token that is not allowed: ${d[0]}`)}let u=0;for(;;){let l=null,d=u;for(;a.lastIndex=d,l=a.exec(n),!(l==null||i.has(l[0]));)d=l.index+1;let h=(c=l==null?void 0:l.index)!=null?c:n.length;for(let p of n.substring(u,h).matchAll(r)){let g=this.textEncoder.encode(p[0]),y=this.rankMap.get(g.join(","));if(y!=null){s.push(y);continue}s.push(...WE(g,this.rankMap))}if(l==null)break;let f=this.specialTokens[l[0]];s.push(f),u=l.index+l[0].length}return s}decode(n){var s;let e=[],t=0;for(let i=0;i<n.length;++i){let o=n[i],u=(s=this.textMap.get(o))!=null?s:this.inverseSpecialTokens[o];u!=null&&(e.push(u),t+=u.length)}let r=new Uint8Array(t),a=0;for(let i of e)r.set(i,a),a+=i.length;return this.textDecoder.decode(r)}},lu=Ll;KE(lu,"specialTokenRegex",n=>new RegExp(n.map(e=>XE(e)).join("|"),"g"));function Dl(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1-2024-12-17":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}var du={},YE=new Ir({});async function QE(n){return n in du||(du[n]=YE.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new lu(e)).catch(e=>{throw delete du[n],e})),await du[n]}async function Ig(n){return QE(Dl(n))}var eO=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n;function Pg(n){return typeof n!="object"||!n?!1:!!("type"in n&&n.type==="function"&&"function"in n&&typeof n.function=="object"&&n.function&&"name"in n.function&&"parameters"in n.function)}var tO=()=>!1,hi=class extends ie{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){var t,r,a;super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=(t=e.verbose)!=null?t:tO(),this.callbacks=e.callbacks,this.tags=(r=e.tags)!=null?r:[],this.metadata=(a=e.metadata)!=null?a:{}}},fi=class extends hi{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){let{cache:a,...s}=r;super({callbacks:e!=null?e:t,...s}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof a=="object"?this.cache=a:a?this.cache=su.global():this.cache=void 0,this.caller=new Ir(r!=null?r:{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Ig("modelName"in this?eO(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new ou(e):Array.isArray(e)?new uu(e.map(En)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){let r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([i,o])=>o!==void 0).map(([i,o])=>`${i}:${JSON.stringify(o)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};var or=class extends ie{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=Q(t);return this.func&&await this.func(e,r),this._callWithConfig(a=>Promise.resolve(a),e,r)}async*transform(e,t){let r=Q(t),a,s=!0;for await(let i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,s)if(a===void 0)a=i;else try{a=Te(a,i)}catch(o){a=void 0,s=!1}this.func&&a!==void 0&&await this.func(a,r)}static assign(e){return new ts(new Wr({steps:e}))}};function pi(n){return typeof(n==null?void 0:n.parse)=="function"}var rs=class n extends fi{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptionsCompat(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){let r=n._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){var r;if(this._streamResponseChunks===n.prototype._streamResponseChunks)yield this.invoke(e,t);else{let s=n._convertInputToPromptValue(e).toChatMessages(),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(t),u={...i.metadata,...this.getLsParams(o)},c=await Re.configure(i.callbacks,this.callbacks,i.tags,this.tags,u,this.metadata,{verbose:this.verbose}),l={options:o,invocation_params:this==null?void 0:this.invocationParams(o),batch_size:1},d=await(c==null?void 0:c.handleChatModelStart(this.toJSON(),[s],i.runId,void 0,l,void 0,void 0,i.runName)),h,f;try{for await(let p of this._streamResponseChunks(s,o,d==null?void 0:d[0])){if(p.message.id==null){let g=(r=d==null?void 0:d.at(0))==null?void 0:r.runId;g!=null&&p.message._updateId(`run-${g}`)}p.message.response_metadata={...p.generationInfo,...p.message.response_metadata},yield p.message,h?h=h.concat(p):h=p,yc(p.message)&&p.message.usage_metadata!==void 0&&(f={tokenUsage:{promptTokens:p.message.usage_metadata.input_tokens,completionTokens:p.message.usage_metadata.output_tokens,totalTokens:p.message.usage_metadata.total_tokens}})}}catch(p){throw await Promise.all((d!=null?d:[]).map(g=>g==null?void 0:g.handleLLMError(p))),p}await Promise.all((d!=null?d:[]).map(p=>p==null?void 0:p.handleLLMEnd({generations:[[h]],llmOutput:f})))}}getLsParams(e){let t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r){var f,p;let a=e.map(g=>g.map(En)),s={...r.metadata,...this.getLsParams(t)},i=await Re.configure(r.callbacks,this.callbacks,r.tags,this.tags,s,this.metadata,{verbose:this.verbose}),o={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1},u=await(i==null?void 0:i.handleChatModelStart(this.toJSON(),a,r.runId,void 0,o,void 0,void 0,r.runName)),c=[],l=[];if(!!(u!=null&&u[0].handlers.find(fl))&&a.length===1&&this._streamResponseChunks!==n.prototype._streamResponseChunks)try{let g=await this._streamResponseChunks(a[0],t,u==null?void 0:u[0]),y,m;for await(let b of g){if(b.message.id==null){let A=(f=u==null?void 0:u.at(0))==null?void 0:f.runId;A!=null&&b.message._updateId(`run-${A}`)}y===void 0?y=b:y=Te(y,b),yc(b.message)&&b.message.usage_metadata!==void 0&&(m={tokenUsage:{promptTokens:b.message.usage_metadata.input_tokens,completionTokens:b.message.usage_metadata.output_tokens,totalTokens:b.message.usage_metadata.total_tokens}})}if(y===void 0)throw new Error("Received empty response from chat model call.");c.push([y]),await(u==null?void 0:u[0].handleLLMEnd({generations:c,llmOutput:m}))}catch(g){throw await(u==null?void 0:u[0].handleLLMError(g)),g}else{let g=await Promise.allSettled(a.map((y,m)=>this._generate(y,{...t,promptIndex:m},u==null?void 0:u[m])));await Promise.all(g.map(async(y,m)=>{var b,A,I;if(y.status==="fulfilled"){let _=y.value;for(let v of _.generations){if(v.message.id==null){let E=(b=u==null?void 0:u.at(0))==null?void 0:b.runId;E!=null&&v.message._updateId(`run-${E}`)}v.message.response_metadata={...v.generationInfo,...v.message.response_metadata}}return _.generations.length===1&&(_.generations[0].message.response_metadata={..._.llmOutput,..._.generations[0].message.response_metadata}),c[m]=_.generations,l[m]=_.llmOutput,(A=u==null?void 0:u[m])==null?void 0:A.handleLLMEnd({generations:[_.generations],llmOutput:_.llmOutput})}else return await((I=u==null?void 0:u[m])==null?void 0:I.handleLLMError(y.reason)),Promise.reject(y.reason)}))}let h={generations:c,llmOutput:l.length?(p=this._combineLLMOutput)==null?void 0:p.call(this,...l):void 0};return Object.defineProperty(h,Ho,{value:u?{runIds:u==null?void 0:u.map(g=>g.runId)}:void 0,configurable:!0}),h}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){let i=e.map(y=>y.map(En)),o={...s.metadata,...this.getLsParams(a)},u=await Re.configure(s.callbacks,this.callbacks,s.tags,this.tags,o,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1,cached:!0},l=await(u==null?void 0:u.handleChatModelStart(this.toJSON(),i,s.runId,void 0,c,void 0,void 0,s.runName)),d=[],f=(await Promise.allSettled(i.map(async(y,m)=>{let b=n._convertInputToPromptValue(y).toString(),A=await t.lookup(b,r);return A==null&&d.push(m),A}))).map((y,m)=>({result:y,runManager:l==null?void 0:l[m]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),p=[];await Promise.all(f.map(async({result:y,runManager:m},b)=>{if(y.status==="fulfilled"){let A=y.value;return p[b]=A,A.length&&await(m==null?void 0:m.handleLLMNewToken(A[0].text)),m==null?void 0:m.handleLLMEnd({generations:[A]})}else return await(m==null?void 0:m.handleLLMError(y.reason)),Promise.reject(y.reason)}));let g={generations:p,missingPromptIndices:d};return Object.defineProperty(g,Ho,{value:l?{runIds:l==null?void 0:l.map(y=>y.runId)}:void 0,configurable:!0}),g}async generate(e,t,r){var f,p;let a;Array.isArray(t)?a={stop:t}:a=t;let s=e.map(g=>g.map(En)),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(a);if(i.callbacks=(f=i.callbacks)!=null?f:r,!this.cache)return this._generateUncached(s,o,i);let{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d}=await this._generateCached({messages:s,cache:u,llmStringKey:c,parsedOptions:o,handledOptions:i}),h={};if(d.length>0){let g=await this._generateUncached(d.map(y=>s[y]),o,i);await Promise.all(g.generations.map(async(y,m)=>{let b=d[m];l[b]=y;let A=n._convertInputToPromptValue(s[b]).toString();return u.update(A,c,y)})),h=(p=g.llmOutput)!=null?p:{}}return{generations:l,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let a=e.map(s=>s.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(En)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new dt(e),s=await this.call([a],t,r);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}withStructuredOutput(e,t){var g;if(typeof this.bindTools!="function")throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t!=null&&t.strict)throw new Error('"strict" mode is not supported for this model by default.');let r=e,a=t==null?void 0:t.name,s=(g=r.description)!=null?g:"A function available to call.",i=t==null?void 0:t.method,o=t==null?void 0:t.includeRaw;if(i==="jsonMode")throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let u=a!=null?a:"extract",c;pi(r)?c=[{type:"function",function:{name:u,description:s,parameters:Pt(r)}}]:("name"in r&&(u=r.name),c=[{type:"function",function:{name:u,description:s,parameters:r}}]);let l=this.bindTools(c),d=kr.from(y=>{if(!y.tool_calls||y.tool_calls.length===0)throw new Error("No tool calls found in the response.");let m=y.tool_calls.find(b=>b.name===u);if(!m)throw new Error(`No tool call found with name ${u}.`);return m.args});if(!o)return l.pipe(d).withConfig({runName:"StructuredOutput"});let h=or.assign({parsed:(y,m)=>d.invoke(y.raw,m)}),f=or.assign({parsed:()=>null}),p=h.withFallbacks({fallbacks:[f]});return Sr.from([{raw:l},p]).withConfig({runName:"StructuredOutputRunnable"})}};var Ml=class extends ie{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,a)=>this.parseResult([{text:r}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,a)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"})}},ns=class extends Ml{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},Xr=class extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Ji(this,"OUTPUT_PARSING_FAILURE")}};function mi(n,e){let t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;let r=n.length;if(r!==e.length)return!1;for(let a=0;a<r;a++)if(!mi(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;let r=Object.keys(n),a=Object.keys(e);if(r.length!==a.length)return!1;for(let i of r)if(!mi(n[i],e[i]))return!1;return!0}return n===e}var DD=typeof self!="undefined"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");var nO=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,aO=[0,31,28,31,30,31,30,31,31,30,31,30,31],sO=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,iO=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,oO=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,uO=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,cO=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,lO=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,dO=/^(?:\/(?:[^~/]|~0|~1)*)*$/,hO=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,fO=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,pO=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,mO=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,gO=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,yO=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,bO=n=>{if(n[0]==='"')return!1;let[e,t,...r]=n.split("@");return!e||!t||r.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(a=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(a))},_O=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,wO=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,vO=n=>n.length>1&&n.length<80&&(/^P\d+([.,]\d+)?W$/.test(n)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(n)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(n));function ot(n){return n.test.bind(n)}var AO={date:Tg,time:Sg.bind(void 0,!1),"date-time":IO,duration:vO,uri:SO,"uri-reference":ot(oO),"uri-template":ot(uO),url:ot(cO),email:bO,hostname:ot(iO),ipv4:ot(_O),ipv6:ot(wO),regex:CO,uuid:ot(lO),"json-pointer":ot(dO),"json-pointer-uri-fragment":ot(hO),"relative-json-pointer":ot(fO)},EO={...AO,date:ot(pO),time:ot(mO),"date-time":ot(gO),"uri-reference":ot(yO)};function OO(n){return n%4===0&&(n%100!==0||n%400===0)}function Tg(n){let e=n.match(nO);if(!e)return!1;let t=+e[1],r=+e[2],a=+e[3];return r>=1&&r<=12&&a>=1&&a<=(r==2&&OO(t)?29:aO[r])}function Sg(n,e){let t=e.match(sO);if(!t)return!1;let r=+t[1],a=+t[2],s=+t[3],i=!!t[5];return(r<=23&&a<=59&&s<=59||r==23&&a==59&&s==60)&&(!n||i)}var xO=/t|\s/i;function IO(n){let e=n.split(xO);return e.length==2&&Tg(e[0])&&Sg(!0,e[1])}var PO=/\/|:/,TO=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function SO(n){return PO.test(n)&&TO.test(n)}var kO=/[^\\]\\Z/;function CO(n){if(kO.test(n))return!1;try{return new RegExp(n,"u"),!0}catch(e){return!1}}var kg;(function(n){n[n.Flag=1]="Flag",n[n.Basic=2]="Basic",n[n.Detailed=4]="Detailed"})(kg||(kg={}));var as=class extends ns{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},Kn=class extends as{constructor(e){var t;super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(t=e==null?void 0:e.diff)!=null?t:this.diff}async*_transform(e){let t,r;for await(let a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let s;if($h(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new It({message:a,text:a.content})}else if(La(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new It({message:_c(a),text:a.content})}else s=new xt({text:a});r===void 0?r=s:r=r.concat(s);let i=await this.parsePartialResult([r]);i!=null&&!mi(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}getFormatInstructions(){return""}};var gi=class extends ns{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=_t.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,_t.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Pt(this.schema))}
\`\`\`
`}async parse(e){try{let r=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(a,s)=>`"${s.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(r))}catch(t){throw new Xr(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};var yi=class extends Kn{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Fo(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return pc(e[0].text)}async parse(e){return pc(e,JSON.parse)}getFormatInstructions(){return""}};function Ul(n,e){var a;if(n.function===void 0)return;let t;if(e!=null&&e.partial)try{t=ja((a=n.function.arguments)!=null?a:"{}")}catch(s){return}else try{t=JSON.parse(n.function.arguments)}catch(s){throw new Xr([`Function "${n.function.name}" arguments:`,"",n.function.arguments,"","are not valid JSON.",`Error: ${s.message}`].join(`
`))}let r={name:n.function.name,args:t,type:"tool_call"};return e!=null&&e.returnId&&(r.id=n.id),r}function Cg(n){if(n.id===void 0)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:n.id,type:"function",function:{name:n.name,arguments:JSON.stringify(n.args)}}}function Rg(n,e){var t,r;return{name:(t=n.function)==null?void 0:t.name,args:(r=n.function)==null?void 0:r.arguments,id:n.id,error:e,type:"invalid_tool_call"}}var Fl=class extends Kn{static lc_name(){return"JsonOutputToolsParser"}constructor(e){var t;super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(t=e==null?void 0:e.returnId)!=null?t:this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){var i;let r=e[0].message,a;if(Ms(r)&&((i=r.tool_calls)!=null&&i.length)?a=r.tool_calls.map(o=>{let{id:u,...c}=o;return this.returnId?{id:u,...c}:c}):r.additional_kwargs.tool_calls!==void 0&&(a=JSON.parse(JSON.stringify(r.additional_kwargs.tool_calls)).map(u=>Ul(u,{returnId:this.returnId,partial:t}))),!a)return[];let s=[];for(let o of a)if(o!==void 0){let u={type:o.name,args:o.args,id:o.id};s.push(u)}return s}},bi=class extends Fl{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){var t;super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=(t=e.returnSingle)!=null?t:this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Xr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let r=(await super.parsePartialResult(e)).filter(s=>s.type===this.keyName),a=r;if(r.length)return this.returnId||(a=r.map(s=>s.args)),this.returnSingle?a[0]:a}async parseResult(e){let r=(await super.parsePartialResult(e,!1)).filter(i=>i.type===this.keyName),a=r;return r.length?(this.returnId||(a=r.map(i=>i.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(i=>this._validateResult(i)))):void 0}};var $g=Symbol("Let zodToJsonSchema decide on which parser to use"),Ng={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},jg=n=>typeof n=="string"?{...Ng,basePath:["#"],definitions:{},name:n}:{...Ng,basePath:["#"],definitions:{},...n};var _i=n=>"_def"in n?n._def:n;function Lg(n){if(!n)return!0;for(let e in n)return!1;return!0}var Dg=n=>{let e=jg(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[_i(a),{def:_i(a),path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};function zl(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function te(n,e,t,r,a){n[e]=t,zl(n,e,r,a)}function Mg(){return{}}function Fg(n,e){var r,a;let t={type:"array"};return((a=(r=n.type)==null?void 0:r._def)==null?void 0:a.typeName)!==w.ZodAny&&(t.items=U(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&te(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&te(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(te(t,"minItems",n.exactLength.value,n.exactLength.message,e),te(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function Ug(n,e){let t={type:"integer",format:"int64"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?te(t,"minimum",r.value,r.message,e):te(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),te(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?te(t,"maximum",r.value,r.message,e):te(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),te(t,"maximum",r.value,r.message,e));break;case"multipleOf":te(t,"multipleOf",r.value,r.message,e);break}return t}function zg(){return{type:"boolean"}}function Bg(n,e){return U(n.type._def,e)}var qg=(n,e)=>U(n.innerType._def,e);function Bl(n,e,t){let r=t!=null?t:e.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((a,s)=>Bl(n,e,a))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return NO(n,e)}}var NO=(n,e)=>{let t={type:"integer",format:"unix-time"};if(e.target==="openApi3")return t;for(let r of n.checks)switch(r.kind){case"min":te(t,"minimum",r.value,r.message,e);break;case"max":te(t,"maximum",r.value,r.message,e);break}return t};function Vg(n,e){return{...U(n.innerType._def,e),default:n.defaultValue()}}function Hg(n,e,t){return e.effectStrategy==="input"?U(n.schema._def,e,t):{}}function Zg(n){return{type:"string",enum:[...n.values]}}var $O=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function Gg(n,e){let t=[U(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),U(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s),r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,a=[];return t.forEach(s=>{if($O(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){let{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function Kg(n,e){let t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}var ql,Jn={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(ql===void 0&&(ql=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),ql),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function hu(n,e){let t={type:"string"};function r(a){return e.patternStrategy==="escape"?jO(a):a}if(n.checks)for(let a of n.checks)switch(a.kind){case"min":te(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":te(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Bt(t,"email",a.message,e);break;case"format:idn-email":Bt(t,"idn-email",a.message,e);break;case"pattern:zod":qt(t,Jn.email,a.message,e);break}break;case"url":Bt(t,"uri",a.message,e);break;case"uuid":Bt(t,"uuid",a.message,e);break;case"regex":qt(t,a.regex,a.message,e);break;case"cuid":qt(t,Jn.cuid,a.message,e);break;case"cuid2":qt(t,Jn.cuid2,a.message,e);break;case"startsWith":qt(t,RegExp(`^${r(a.value)}`),a.message,e);break;case"endsWith":qt(t,RegExp(`${r(a.value)}$`),a.message,e);break;case"datetime":Bt(t,"date-time",a.message,e);break;case"date":Bt(t,"date",a.message,e);break;case"time":Bt(t,"time",a.message,e);break;case"duration":Bt(t,"duration",a.message,e);break;case"length":te(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),te(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{qt(t,RegExp(r(a.value)),a.message,e);break}case"ip":{a.version!=="v6"&&Bt(t,"ipv4",a.message,e),a.version!=="v4"&&Bt(t,"ipv6",a.message,e);break}case"emoji":qt(t,Jn.emoji,a.message,e);break;case"ulid":{qt(t,Jn.ulid,a.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{Bt(t,"binary",a.message,e);break}case"contentEncoding:base64":{te(t,"contentEncoding","base64",a.message,e);break}case"pattern:zod":{qt(t,Jn.base64,a.message,e);break}}break}case"nanoid":qt(t,Jn.nanoid,a.message,e);case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}var jO=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Bt=(n,e,t,r)=>{var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):te(n,"format",e,t,r)},qt=(n,e,t,r)=>{var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:Jg(e,r),...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):te(n,"pattern",Jg(e,r),t,r)},Jg=(n,e)=>{var c;let t=typeof n=="function"?n():n;if(!e.applyRegexFlags||!t.flags)return t.source;let r={i:t.flags.includes("i"),m:t.flags.includes("m"),s:t.flags.includes("s")},a=r.i?t.source.toLowerCase():t.source,s="",i=!1,o=!1,u=!1;for(let l=0;l<a.length;l++){if(i){s+=a[l],i=!1;continue}if(r.i){if(o){if(a[l].match(/[a-z]/)){u?(s+=a[l],s+=`${a[l-2]}-${a[l]}`.toUpperCase(),u=!1):a[l+1]==="-"&&((c=a[l+2])!=null&&c.match(/[a-z]/))?(s+=a[l],u=!0):s+=`${a[l]}${a[l].toUpperCase()}`;continue}}else if(a[l].match(/[a-z]/)){s+=`[${a[l]}${a[l].toUpperCase()}]`;continue}}if(r.m){if(a[l]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(a[l]==="$"){s+=`($|(?=[\r
]))`;continue}}if(r.s&&a[l]==="."){s+=o?`${a[l]}\r
`:`[${a[l]}\r
]`;continue}s+=a[l],a[l]==="\\"?i=!0:o&&a[l]==="]"?o=!1:!o&&a[l]==="["&&(o=!0)}try{let l=new RegExp(s)}catch(l){return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),t.source}return s};function fu(n,e){var r,a,s,i,o;if(e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===w.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((u,c)=>{var l;return{...u,[c]:(l=U(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]}))!=null?l:{}}},{}),additionalProperties:!1};let t={type:"object",additionalProperties:(a=U(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?a:{}};if(e.target==="openApi3")return t;if(((s=n.keyType)==null?void 0:s._def.typeName)===w.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){let u=Object.entries(hu(n.keyType._def,e)).reduce((c,[l,d])=>l==="type"?c:{...c,[l]:d},{});return{...t,propertyNames:u}}else if(((o=n.keyType)==null?void 0:o._def.typeName)===w.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function Wg(n,e){if(e.mapStrategy==="record")return fu(n,e);let t=U(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=U(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function Xg(n){let e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function Yg(){return{not:{}}}function Qg(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var wi={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function ty(n,e){if(e.target==="openApi3")return ey(n,e);let t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in wi&&(!r._def.checks||!r._def.checks.length))){let r=t.reduce((a,s)=>{let i=wi[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=t.reduce((a,s)=>{let i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){let a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return ey(n,e)}var ey=(n,e)=>{let t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>U(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function ry(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:wi[n.innerType._def.typeName],nullable:!0}:{type:[wi[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let r=U(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let t=U(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function ny(n,e){let t={type:"number"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"int":t.type="integer",zl(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?te(t,"minimum",r.value,r.message,e):te(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),te(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?te(t,"maximum",r.value,r.message,e):te(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),te(t,"maximum",r.value,r.message,e));break;case"multipleOf":te(t,"multipleOf",r.value,r.message,e);break}return t}function LO(n,e){var t,r;return e.removeAdditionalStrategy==="strict"?n.catchall._def.typeName==="ZodNever"?n.unknownKeys!=="strict":(t=U(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?t:!0:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":(r=U(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?r:!0}function ay(n,e){let t={type:"object",...Object.entries(n.shape()).reduce((r,[a,s])=>{if(s===void 0||s._def===void 0)return r;let i=U(s._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return i===void 0?r:{properties:{...r.properties,[a]:i},required:s.isOptional()&&!e.openaiStrictMode?r.required:[...r.required,a]}},{properties:{},required:[]}),additionalProperties:LO(n,e)};return t.required.length||delete t.required,t}var sy=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return U(n.innerType._def,e);let t=U(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}};var iy=(n,e)=>{if(e.pipeStrategy==="input")return U(n.in._def,e);if(e.pipeStrategy==="output")return U(n.out._def,e);let t=U(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=U(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function oy(n,e){return U(n.type._def,e)}function uy(n,e){let r={type:"array",uniqueItems:!0,items:U(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&te(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&te(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function cy(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>U(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:U(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>U(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function ly(){return{not:{}}}function dy(){return{}}var hy=(n,e)=>U(n.innerType._def,e);function U(n,e,t=!1){var i;let r=e.seen.get(n);if(e.override){let o=(i=e.override)==null?void 0:i.call(e,n,e,r,t);if(o!==$g)return o}if(r&&!t){let o=DO(r,e);if(o!==void 0)return"$ref"in o&&e.seenRefs.add(o.$ref),o}let a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);let s=FO(n,n.typeName,e,t);return s&&UO(n,e,s),a.jsonSchema=s,s}var DO=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"extract-to-root":let t=n.path.slice(e.basePath.length+1).join("_");return t!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[t]=n.def),{$ref:[...e.basePath,e.definitionPath,t].join("/")};case"relative":return{$ref:MO(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((r,a)=>e.currentPath[a]===r)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},MO=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},FO=(n,e,t,r)=>{switch(e){case w.ZodString:return hu(n,t);case w.ZodNumber:return ny(n,t);case w.ZodObject:return ay(n,t);case w.ZodBigInt:return Ug(n,t);case w.ZodBoolean:return zg();case w.ZodDate:return Bl(n,t);case w.ZodUndefined:return ly();case w.ZodNull:return Qg(t);case w.ZodArray:return Fg(n,t);case w.ZodUnion:case w.ZodDiscriminatedUnion:return ty(n,t);case w.ZodIntersection:return Gg(n,t);case w.ZodTuple:return cy(n,t);case w.ZodRecord:return fu(n,t);case w.ZodLiteral:return Kg(n,t);case w.ZodEnum:return Zg(n);case w.ZodNativeEnum:return Xg(n);case w.ZodNullable:return ry(n,t);case w.ZodOptional:return sy(n,t);case w.ZodMap:return Wg(n,t);case w.ZodSet:return uy(n,t);case w.ZodLazy:return U(n.getter()._def,t);case w.ZodPromise:return oy(n,t);case w.ZodNaN:case w.ZodNever:return Yg();case w.ZodEffects:return Hg(n,t,r);case w.ZodAny:return Mg();case w.ZodUnknown:return dy();case w.ZodDefault:return Vg(n,t);case w.ZodBranded:return Bg(n,t);case w.ZodReadonly:return hy(n,t);case w.ZodCatch:return qg(n,t);case w.ZodPipeline:return iy(n,t);case w.ZodFunction:case w.ZodVoid:case w.ZodSymbol:return;default:return(a=>{})(e)}},UO=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t);var fy=(n,e)=>{var u;let t=Dg(e),r=typeof e=="string"?e:(e==null?void 0:e.nameStrategy)==="title"||e==null?void 0:e.name,a=(u=U(n._def,r===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,r]},!1))!=null?u:{},s=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;s!==void 0&&(a.title=s);let i=(()=>{var d;if(Lg(t.definitions))return;let c={},l=new Set;for(let h=0;h<500;h++){let f=Object.entries(t.definitions).filter(([p])=>!l.has(p));if(f.length===0)break;for(let[p,g]of f)c[p]=(d=U(_i(g),{...t,currentPath:[...t.basePath,t.definitionPath,p]},!0))!=null?d:{},l.add(p)}return c})(),o=r===void 0?i?{...a,[t.definitionPath]:i}:a:t.nameStrategy==="duplicate-ref"?{...a,...i||t.seenRefs.size?{[t.definitionPath]:{...i,...t.seenRefs.size?{[r]:a}:void 0}}:void 0}:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,r].join("/"),[t.definitionPath]:{...i,[r]:a}};return t.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function py(n,e){return fy(n,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function my(n,e,t){return th({type:"json_schema",json_schema:{...t,name:e,strict:!0,schema:py(n,{name:e})}},r=>n.parse(JSON.parse(r)))}function gy(n){return rh({type:"function",function:{name:n.name,parameters:py(n.parameters,{name:n.name}),strict:!0,...n.description?{description:n.description}:void 0}},{callback:n.function,parser:e=>n.parameters.parse(JSON.parse(e))})}function Yr(n){let{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:a,baseURL:s,azureADTokenProvider:i,azureOpenAIEndpoint:o}=n;if((r||i)&&a&&e)return`${a}/${e}`;if((r||i)&&o&&e)return`${o}/openai/deployments/${e}`;if(r||i){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return s}function pu(n,e){let t=typeof e=="number"?void 0:e;return{name:n.name,description:n.description,parameters:Pt(n.schema),...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}}function mu(n,e){let t=typeof e=="number"?void 0:e,r;return Vl(n)?r={type:"function",function:pu(n)}:r=n,(t==null?void 0:t.strict)!==void 0&&(r.function.strict=t.strict),r}function zO(n){return n!==void 0&&Array.isArray(n.lc_namespace)}function BO(n){return n!==void 0&&ie.isRunnable(n)&&"lc_name"in n.constructor&&typeof n.constructor.lc_name=="function"&&n.constructor.lc_name()==="RunnableToolLike"}function qO(n){return!!n&&typeof n=="object"&&"name"in n&&"schema"in n&&pi(n.schema)}function Vl(n){return qO(n)||BO(n)||zO(n)}function vi(n,e){return n.lc_error_code=e,n.message=`${n.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${e}/
`,n}function Wn(n){let e;return n.constructor.name===Ct.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===ge.name?(e=new Error(n.message),e.name="AbortError"):n.status===400&&n.message.includes("tool_calls")?e=vi(n,"INVALID_TOOL_RESULTS"):n.status===401?e=vi(n,"MODEL_AUTHENTICATION"):n.status===429?e=vi(n,"MODEL_RATE_LIMIT"):n.status===404?e=vi(n,"MODEL_NOT_FOUND"):e=n,e}function yy(n){if(n)return n==="any"||n==="required"?"required":n==="auto"?"auto":n==="none"?"none":typeof n=="string"?{type:"function",function:{name:n}}:n}function VO(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function by(n){var t;let e=["namespace functions {",""];for(let r of n)r.description&&e.push(`// ${r.description}`),Object.keys((t=r.parameters.properties)!=null?t:{}).length>0?(e.push(`type ${r.name} = (_: {`),e.push(_y(r.parameters,0)),e.push("}) => any;")):e.push(`type ${r.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function _y(n,e){var r,a;let t=[];for(let[s,i]of Object.entries((r=n.properties)!=null?r:{}))i.description&&e<2&&t.push(`// ${i.description}`),(a=n.required)!=null&&a.includes(s)?t.push(`${s}: ${gu(i,e)},`):t.push(`${s}?: ${gu(i,e)},`);return t.map(s=>" ".repeat(e)+s).join(`
`)}function gu(n,e){if(VO(n))return n.anyOf.map(t=>gu(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",_y(n,e+2),"}"].join(`
`);case"array":return n.items?`${gu(n.items,e)}[]`:"any[]";default:return""}}function wy(n,e){let t;if(Vl(n)){let r=gy({name:n.name,parameters:n.schema,description:n.description});r.function.parameters?t={type:r.type,function:{name:r.function.name,description:r.function.description,parameters:r.function.parameters,...(e==null?void 0:e.strict)!==void 0?{strict:e.strict}:{}}}:t={type:"function",function:pu(n,e)}}else t=n;return(e==null?void 0:e.strict)!==void 0&&(t.function.strict=e.strict),t}function HO(n){return n.role!=="system"&&n.role!=="developer"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function Ay(n){let e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Ur.isInstance(n))throw new Error("Invalid generic chat message");return HO(n)}default:throw new Error(`Unknown message type: ${e}`)}}function ZO(n,e,t){var a;let r=n.tool_calls;switch(n.role){case"assistant":{let s=[],i=[];for(let c of r!=null?r:[])try{s.push(Ul(c,{returnId:!0}))}catch(l){i.push(Rg(c,l.message))}let o={function_call:n.function_call,tool_calls:r};t!==void 0&&(o.__raw_response=e);let u={model_name:e.model,...e.system_fingerprint?{usage:{...e.usage},system_fingerprint:e.system_fingerprint}:{}};return n.audio&&(o.audio=n.audio),new Qe({content:n.content||"",tool_calls:s,invalid_tool_calls:i,additional_kwargs:o,response_metadata:u,id:e.id})}default:return new Ur(n.content||"",(a=n.role)!=null?a:"unknown")}}function GO(n,e,t,r){var u,c,l,d;let a=(u=n.role)!=null?u:t,s=(c=n.content)!=null?c:"",i;n.function_call?i={function_call:n.function_call}:n.tool_calls?i={tool_calls:n.tool_calls}:i={},r&&(i.__raw_response=e),n.audio&&(i.audio={...n.audio,index:e.choices[0].index});let o={usage:{...e.usage}};if(a==="user")return new An({content:s,response_metadata:o});if(a==="assistant"){let h=[];if(Array.isArray(n.tool_calls))for(let f of n.tool_calls)h.push({name:(l=f.function)==null?void 0:l.name,args:(d=f.function)==null?void 0:d.arguments,id:f.id,index:f.index,type:"tool_call_chunk"});return new Le({content:s,tool_call_chunks:h,additional_kwargs:i,id:e.id,response_metadata:o})}else return a==="system"?new Br({content:s,response_metadata:o}):a==="developer"?new Br({content:s,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):a==="function"?new vn({content:s,additional_kwargs:i,name:n.name,response_metadata:o}):a==="tool"?new Da({content:s,additional_kwargs:i,tool_call_id:n.tool_call_id,response_metadata:o}):new wn({content:s,role:a,response_metadata:o})}function Hl(n,e){return n.flatMap(t=>{var s;let r=Ay(t);r==="system"&&(e!=null&&e.startsWith("o1"))&&(r="developer");let a={role:r,content:t.content};if(t.name!=null&&(a.name=t.name),t.additional_kwargs.function_call!=null&&(a.function_call=t.additional_kwargs.function_call,a.content=null),Ms(t)&&((s=t.tool_calls)!=null&&s.length)?(a.tool_calls=t.tool_calls.map(Cg),a.content=null):(t.additional_kwargs.tool_calls!=null&&(a.tool_calls=t.additional_kwargs.tool_calls),t.tool_call_id!=null&&(a.tool_call_id=t.tool_call_id)),t.additional_kwargs.audio&&typeof t.additional_kwargs.audio=="object"&&"id"in t.additional_kwargs.audio){let i={role:"assistant",audio:{id:t.additional_kwargs.audio.id}};return[a,i]}return a})}function vy(n,e){return Pg(n)?(e==null?void 0:e.strict)!==void 0?{...n,function:{...n.function,strict:e.strict}}:n:wy(n,e)}var ss=class extends rs{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){var r,a,s,i,o,u,c,l,d,h,f,p,g,y,m,b,A,I,_,v,E,O,S,L,q,V,de,Ie,ve,Qr,$e,hs,fs,ps,ms;if(super(e!=null?e:{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(i=(s=(r=e==null?void 0:e.apiKey)!=null?r:e==null?void 0:e.openAIApiKey)!=null?s:(a=e==null?void 0:e.configuration)==null?void 0:a.apiKey)!=null?i:se("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=(o=e==null?void 0:e.azureOpenAIApiKey)!=null?o:se("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=(u=e==null?void 0:e.azureADTokenProvider)!=null?u:void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=(c=e==null?void 0:e.azureOpenAIApiInstanceName)!=null?c:se("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(l=e==null?void 0:e.azureOpenAIApiDeploymentName)!=null?l:se("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(d=e==null?void 0:e.azureOpenAIApiVersion)!=null?d:se("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(h=e==null?void 0:e.azureOpenAIBasePath)!=null?h:se("AZURE_OPENAI_BASE_PATH"),this.organization=(p=(f=e==null?void 0:e.configuration)==null?void 0:f.organization)!=null?p:se("OPENAI_ORGANIZATION"),this.azureOpenAIEndpoint=(g=e==null?void 0:e.azureOpenAIEndpoint)!=null?g:se("AZURE_OPENAI_ENDPOINT"),this.modelName=(m=(y=e==null?void 0:e.model)!=null?y:e==null?void 0:e.modelName)!=null?m:this.model,this.model=this.modelName,this.modelKwargs=(b=e==null?void 0:e.modelKwargs)!=null?b:{},this.timeout=e==null?void 0:e.timeout,this.temperature=(A=e==null?void 0:e.temperature)!=null?A:this.temperature,this.topP=(I=e==null?void 0:e.topP)!=null?I:this.topP,this.frequencyPenalty=(_=e==null?void 0:e.frequencyPenalty)!=null?_:this.frequencyPenalty,this.presencePenalty=(v=e==null?void 0:e.presencePenalty)!=null?v:this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(E=e==null?void 0:e.n)!=null?E:this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=(O=e==null?void 0:e.stopSequences)!=null?O:e==null?void 0:e.stop,this.stopSequences=this==null?void 0:this.stop,this.user=e==null?void 0:e.user,this.__includeRawResponse=e==null?void 0:e.__includeRawResponse,this.audio=e==null?void 0:e.audio,this.modalities=e==null?void 0:e.modalities,this.reasoningEffort=e==null?void 0:e.reasoningEffort,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath&&!this.azureOpenAIEndpoint)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName&&this.azureOpenAIBasePath){let gs=this.azureOpenAIBasePath.split("/openai/deployments/");if(gs.length===2){let[,Ai]=gs;this.azureOpenAIApiDeploymentName=Ai}}if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=(S=this.apiKey)!=null?S:"",this.streamUsage=!1}this.streaming=(L=e==null?void 0:e.streaming)!=null?L:!1,this.streamUsage=(q=e==null?void 0:e.streamUsage)!=null?q:this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:(de=t==null?void 0:t.basePath)!=null?de:(V=e==null?void 0:e.configuration)==null?void 0:V.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:($e=(Ie=t==null?void 0:t.baseOptions)==null?void 0:Ie.headers)!=null?$e:(Qr=(ve=e==null?void 0:e.configuration)==null?void 0:ve.baseOptions)==null?void 0:Qr.headers,defaultQuery:(ms=(hs=t==null?void 0:t.baseOptions)==null?void 0:hs.params)!=null?ms:(ps=(fs=e==null?void 0:e.configuration)==null?void 0:fs.baseOptions)==null?void 0:ps.params,...t,...e==null?void 0:e.configuration},(e==null?void 0:e.supportsStrictToolCalling)!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){var r,a;let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:(r=t.temperature)!=null?r:void 0,ls_max_tokens:(a=t.max_tokens)!=null?a:void 0,ls_stop:e.stop}}bindTools(e,t){let r;return(t==null?void 0:t.strict)!==void 0?r=t.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling),this.bind({tools:e.map(a=>vy(a,{strict:r})),...t})}createResponseFormat(e){return e&&e.type==="json_schema"&&e.json_schema.schema&&yu(e.json_schema.schema)?my(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){var o,u,c;let r;(e==null?void 0:e.strict)!==void 0?r=e.strict:this.supportsStrictToolCalling!==void 0&&(r=this.supportsStrictToolCalling);let a={};(e==null?void 0:e.stream_options)!==void 0?a={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t!=null&&t.streaming)&&(a={stream_options:{include_usage:!0}});let s={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(o=e==null?void 0:e.stop)!=null?o:this.stopSequences,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:(u=e==null?void 0:e.tools)!=null&&u.length?e.tools.map(l=>vy(l,{strict:r})):void 0,tool_choice:yy(e==null?void 0:e.tool_choice),response_format:this.createResponseFormat(e==null?void 0:e.response_format),seed:e==null?void 0:e.seed,...a,parallel_tool_calls:e==null?void 0:e.parallel_tool_calls,...this.audio||e!=null&&e.audio?{audio:this.audio||(e==null?void 0:e.audio)}:{},...this.modalities||e!=null&&e.modalities?{modalities:this.modalities||(e==null?void 0:e.modalities)}:{},...this.modelKwargs};(e==null?void 0:e.prediction)!==void 0&&(s.prediction=e.prediction);let i=(c=e==null?void 0:e.reasoning_effort)!=null?c:this.reasoningEffort;return i!==void 0&&(s.reasoning_effort=i),s}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){var c,l,d,h,f,p,g,y,m,b,A,I,_,v;let a=Hl(e,this.model),s={...this.invocationParams(t,{streaming:!0}),messages:a,stream:!0},i,o=await this.completionWithRetry(s,t),u;for await(let E of o){let O=(c=E==null?void 0:E.choices)==null?void 0:c[0];if(E.usage&&(u=E.usage),!O)continue;let{delta:S}=O;if(!S)continue;let L=GO(S,E,i,this.__includeRawResponse);i=(l=S.role)!=null?l:i;let q={prompt:(d=t.promptIndex)!=null?d:0,completion:(h=O.index)!=null?h:0};if(typeof L.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let V={...q};O.finish_reason!=null&&(V.finish_reason=O.finish_reason,V.system_fingerprint=E.system_fingerprint,V.model_name=E.model),this.logprobs&&(V.logprobs=O.logprobs);let de=new It({message:L,text:L.content,generationInfo:V});yield de,await(r==null?void 0:r.handleLLMNewToken((f=de.text)!=null?f:"",q,void 0,void 0,void 0,{chunk:de}))}if(u){let E={...((p=u.prompt_tokens_details)==null?void 0:p.audio_tokens)!==null&&{audio:(g=u.prompt_tokens_details)==null?void 0:g.audio_tokens},...((y=u.prompt_tokens_details)==null?void 0:y.cached_tokens)!==null&&{cache_read:(m=u.prompt_tokens_details)==null?void 0:m.cached_tokens}},O={...((b=u.completion_tokens_details)==null?void 0:b.audio_tokens)!==null&&{audio:(A=u.completion_tokens_details)==null?void 0:A.audio_tokens},...((I=u.completion_tokens_details)==null?void 0:I.reasoning_tokens)!==null&&{reasoning:(_=u.completion_tokens_details)==null?void 0:_.reasoning_tokens}};yield new It({message:new Le({content:"",response_metadata:{usage:{...u}},usage_metadata:{input_tokens:u.prompt_tokens,output_tokens:u.completion_tokens,total_tokens:u.total_tokens,...Object.keys(E).length>0&&{input_token_details:E},...Object.keys(O).length>0&&{output_token_details:O}}}),text:""})}if((v=t.signal)!=null&&v.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){var o,u,c,l,d,h,f,p,g,y;let a={},s=this.invocationParams(t),i=Hl(e,this.model);if(s.stream){let m=this._streamResponseChunks(e,t,r),b={};for await(let O of m){O.message.response_metadata={...O.generationInfo,...O.message.response_metadata};let S=(u=(o=O.generationInfo)==null?void 0:o.completion)!=null?u:0;b[S]===void 0?b[S]=O:b[S]=b[S].concat(O)}let A=Object.entries(b).sort(([O],[S])=>parseInt(O,10)-parseInt(S,10)).map(([O,S])=>S),{functions:I,function_call:_}=this.invocationParams(t),v=await this.getEstimatedTokenCountFromPrompt(e,I,_),E=await this.getNumTokensFromGenerations(A);return a.input_tokens=v,a.output_tokens=E,a.total_tokens=v+E,{generations:A,llmOutput:{estimatedTokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}else{let m;t.response_format&&t.response_format.type==="json_schema"?m=await this.betaParsedCompletionWithRetry({...s,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}):m=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options});let{completion_tokens:b,prompt_tokens:A,total_tokens:I,prompt_tokens_details:_,completion_tokens_details:v}=(c=m==null?void 0:m.usage)!=null?c:{};b&&(a.output_tokens=((l=a.output_tokens)!=null?l:0)+b),A&&(a.input_tokens=((d=a.input_tokens)!=null?d:0)+A),I&&(a.total_tokens=((h=a.total_tokens)!=null?h:0)+I),((_==null?void 0:_.audio_tokens)!==null||(_==null?void 0:_.cached_tokens)!==null)&&(a.input_token_details={...(_==null?void 0:_.audio_tokens)!==null&&{audio:_==null?void 0:_.audio_tokens},...(_==null?void 0:_.cached_tokens)!==null&&{cache_read:_==null?void 0:_.cached_tokens}}),((v==null?void 0:v.audio_tokens)!==null||(v==null?void 0:v.reasoning_tokens)!==null)&&(a.output_token_details={...(v==null?void 0:v.audio_tokens)!==null&&{audio:v==null?void 0:v.audio_tokens},...(v==null?void 0:v.reasoning_tokens)!==null&&{reasoning:v==null?void 0:v.reasoning_tokens}});let E=[];for(let O of(f=m==null?void 0:m.choices)!=null?f:[]){let L={text:(g=(p=O.message)==null?void 0:p.content)!=null?g:"",message:ZO((y=O.message)!=null?y:{role:"assistant"},m,this.__includeRawResponse)};L.generationInfo={...O.finish_reason?{finish_reason:O.finish_reason}:{},...O.logprobs?{logprobs:O.logprobs}:{}},Ms(L.message)&&(L.message.usage_metadata=a),L.message=new Qe(Object.fromEntries(Object.entries(L.message).filter(([q])=>!q.startsWith("lc_")))),E.push(L)}return{generations:E,llmOutput:{tokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){let s=by(t);a+=await this.getNumTokens(s),a+=9}return t&&e.find(s=>s._getType()==="system")&&(a-=4),r==="none"?a+=1:typeof r=="object"&&(a+=await this.getNumTokens(r.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var a;return(a=r.message.additional_kwargs)!=null&&a.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,a)=>r+a,0)}async getNumTokensFromMessages(e){let t=0,r=0,a=0;this.model==="gpt-3.5-turbo-0301"?(r=4,a=-1):(r=3,a=1);let s=await Promise.all(e.map(async i=>{var h,f,p,g,y,m;let o=await this.getNumTokens(i.content),u=await this.getNumTokens(Ay(i)),c=i.name!==void 0?a+await this.getNumTokens(i.name):0,l=o+r+u+c,d=i;if(d._getType()==="function"&&(l-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(l+=3),(f=d==null?void 0:d.additional_kwargs.function_call)!=null&&f.name&&(l+=await this.getNumTokens((p=d.additional_kwargs.function_call)==null?void 0:p.name)),(g=d.additional_kwargs.function_call)!=null&&g.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse((y=d.additional_kwargs.function_call)==null?void 0:y.arguments)))}catch(b){console.error("Error parsing function arguments",b,JSON.stringify(d.additional_kwargs.function_call)),l+=await this.getNumTokens((m=d.additional_kwargs.function_call)==null?void 0:m.arguments)}return t+=l,l}));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(a){throw Wn(a)}})}async betaParsedCompletionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(a){throw Wn(a)}})}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint},a=Yr(r),s={...this.clientConfig,baseURL:a,timeout:this.timeout,maxRetries:0};s.baseURL||delete s.baseURL,this.client=new W(s)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>{var a,s,i;return r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=(a=r.tokenUsage.completionTokens)!=null?a:0,t.tokenUsage.promptTokens+=(s=r.tokenUsage.promptTokens)!=null?s:0,t.tokenUsage.totalTokens+=(i=r.tokenUsage.totalTokens)!=null?i:0),t},{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){var h,f;let r,a,s,i;KO(e)?(r=e.schema,a=e.name,s=e.method,i=e.includeRaw):(r=e,a=t==null?void 0:t.name,s=t==null?void 0:t.method,i=t==null?void 0:t.includeRaw);let o,u;if((t==null?void 0:t.strict)!==void 0&&s==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if(s==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),yu(r)?u=gi.fromZodSchema(r):u=new yi;else if(s==="jsonSchema")o=this.bind({response_format:{type:"json_schema",json_schema:{name:a!=null?a:"extract",description:r.description,schema:r,strict:t==null?void 0:t.strict}}}),yu(r)?u=gi.fromZodSchema(r):u=new yi;else{let p=a!=null?a:"extract";if(yu(r)){let g=Pt(r);o=this.bind({tools:[{type:"function",function:{name:p,description:g.description,parameters:g}}],tool_choice:{type:"function",function:{name:p}},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),u=new bi({returnSingle:!0,keyName:p,zodSchema:r})}else{let g;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(g=r,p=r.name):(p=(h=r.title)!=null?h:p,g={name:p,description:(f=r.description)!=null?f:"",parameters:r}),o=this.bind({tools:[{type:"function",function:g}],tool_choice:{type:"function",function:{name:p}},...(t==null?void 0:t.strict)!==void 0?{strict:t.strict}:{}}),u=new bi({returnSingle:!0,keyName:p})}}if(!i)return o.pipe(u);let c=or.assign({parsed:(p,g)=>u.invoke(p.raw,g)}),l=or.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[l]});return Sr.from([{raw:o},d])}};function yu(n){return typeof(n==null?void 0:n.parse)=="function"}function KO(n){return n!==void 0&&typeof n.schema=="object"}var Zl=class extends hi{get lc_namespace(){return["langchain","tools"]}constructor(e){var t,r;super(e!=null?e:{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.verboseParsingErrors=(t=e==null?void 0:e.verboseParsingErrors)!=null?t:this.verboseParsingErrors,this.responseFormat=(r=e==null?void 0:e.responseFormat)!=null?r:this.responseFormat}async invoke(e,t){let r,a,s=Q(t);return Fa(e)?(r=e.id,a=e.args,s={...s,toolCall:e,configurable:{...s.configurable,tool_call_id:r}}):a=e,this.call(a,s)}async call(e,t,r){let a;try{a=await this.schema.parseAsync(e)}catch(f){let p="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(p=`${p}
Details: ${f.message}`),new Ma(p,JSON.stringify(e))}let s=Sm(t),i=Re.configure(s.callbacks,this.callbacks,s.tags||r,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),o=await(i==null?void 0:i.handleToolStart(this.toJSON(),typeof a=="string"?a:JSON.stringify(a),s.runId,void 0,void 0,void 0,s.runName));delete s.runId;let u;try{u=await this._call(a,o,s)}catch(f){throw await(o==null?void 0:o.handleToolError(f)),f}let c,l;if(this.responseFormat==="content_and_artifact")if(Array.isArray(u)&&u.length===2)[c,l]=u;else throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(u)}`);else c=u;let d;s&&"configurable"in s&&(d=s.configurable.tool_call_id);let h=YO({content:c,artifact:l,toolCallId:d,name:this.name});return await(o==null?void 0:o.handleToolEnd(h)),h}},bu=class extends Zl{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:_t.object({input:_t.string().optional()}).transform(t=>t.input)})}call(e,t){return super.call(typeof e=="string"||!e?{input:e}:e,t)}};function YO(n){let{content:e,artifact:t,toolCallId:r}=n;return r&&!jh(e)?typeof e=="string"||Array.isArray(e)&&e.every(a=>typeof a=="object")?new mr({content:e,artifact:t,tool_call_id:r,name:n.name}):new mr({content:QO(e),artifact:t,tool_call_id:r,name:n.name}):e}function QO(n){try{return JSON.stringify(n,null,2)}catch(e){return`${n}`}}var Gl=class extends bu{static lc_name(){return"DallEAPIWrapper"}constructor(e){var s,i,o,u,c,l,d,h,f,p;(e==null?void 0:e.responseFormat)!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=(i=(s=e==null?void 0:e.apiKey)!=null?s:e==null?void 0:e.openAIApiKey)!=null?i:se("OPENAI_API_KEY"),r=(o=e==null?void 0:e.organization)!=null?o:se("OPENAI_ORGANIZATION"),a={apiKey:t,organization:r,dangerouslyAllowBrowser:!0,baseUrl:e==null?void 0:e.baseUrl};this.client=new W(a),this.model=(c=(u=e==null?void 0:e.model)!=null?u:e==null?void 0:e.modelName)!=null?c:this.model,this.style=(l=e==null?void 0:e.style)!=null?l:this.style,this.quality=(d=e==null?void 0:e.quality)!=null?d:this.quality,this.n=(h=e==null?void 0:e.n)!=null?h:this.n,this.size=(f=e==null?void 0:e.size)!=null?f:this.size,this.dallEResponseFormat=(p=e==null?void 0:e.dallEResponseFormat)!=null?p:this.dallEResponseFormat,this.user=e==null?void 0:e.user}processMultipleGeneratedUrls(e){return this.dallEResponseFormat==="url"?e.flatMap(t=>t.data.flatMap(a=>a.url?{type:"image_url",image_url:a.url}:[]).filter(a=>a!==void 0&&a.type==="image_url"&&typeof a.image_url=="string"&&a.image_url!==void 0)):e.flatMap(t=>t.data.flatMap(a=>a.b64_json?{type:"image_url",image_url:{url:a.b64_json}}:[]).filter(a=>a!==void 0&&a.type==="image_url"&&typeof a.image_url=="object"&&"url"in a.image_url&&typeof a.image_url.url=="string"&&a.image_url.url!==void 0))}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let s=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(s)}let r=await this.client.images.generate(t),a="";return this.dallEResponseFormat==="url"?[a]=r.data.map(s=>s.url).filter(s=>s!=="undefined"):[a]=r.data.map(s=>s.b64_json).filter(s=>s!=="undefined"),a}};Object.defineProperty(Gl,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var Ne=typeof globalThis!="undefined"&&globalThis||typeof self!="undefined"&&self||typeof global!="undefined"&&global||{},Je={searchParams:"URLSearchParams"in Ne,iterable:"Symbol"in Ne&&"iterator"in Symbol,blob:"FileReader"in Ne&&"Blob"in Ne&&function(){try{return new Blob,!0}catch(n){return!1}}(),formData:"FormData"in Ne,arrayBuffer:"ArrayBuffer"in Ne};function ex(n){return n&&DataView.prototype.isPrototypeOf(n)}Je.arrayBuffer&&(Ey=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],xy=ArrayBuffer.isView||function(n){return n&&Ey.indexOf(Object.prototype.toString.call(n))>-1});var Ey,xy;function is(n){if(typeof n!="string"&&(n=String(n)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(n)||n==="")throw new TypeError('Invalid character in header field name: "'+n+'"');return n.toLowerCase()}function Jl(n){return typeof n!="string"&&(n=String(n)),n}function Wl(n){var e={next:function(){var t=n.shift();return{done:t===void 0,value:t}}};return Je.iterable&&(e[Symbol.iterator]=function(){return e}),e}function xe(n){this.map={},n instanceof xe?n.forEach(function(e,t){this.append(t,e)},this):Array.isArray(n)?n.forEach(function(e){if(e.length!=2)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+e.length);this.append(e[0],e[1])},this):n&&Object.getOwnPropertyNames(n).forEach(function(e){this.append(e,n[e])},this)}xe.prototype.append=function(n,e){n=is(n),e=Jl(e);var t=this.map[n];this.map[n]=t?t+", "+e:e};xe.prototype.delete=function(n){delete this.map[is(n)]};xe.prototype.get=function(n){return n=is(n),this.has(n)?this.map[n]:null};xe.prototype.has=function(n){return this.map.hasOwnProperty(is(n))};xe.prototype.set=function(n,e){this.map[is(n)]=Jl(e)};xe.prototype.forEach=function(n,e){for(var t in this.map)this.map.hasOwnProperty(t)&&n.call(e,this.map[t],t,this)};xe.prototype.keys=function(){var n=[];return this.forEach(function(e,t){n.push(t)}),Wl(n)};xe.prototype.values=function(){var n=[];return this.forEach(function(e){n.push(e)}),Wl(n)};xe.prototype.entries=function(){var n=[];return this.forEach(function(e,t){n.push([t,e])}),Wl(n)};Je.iterable&&(xe.prototype[Symbol.iterator]=xe.prototype.entries);function Kl(n){if(!n._noBody){if(n.bodyUsed)return Promise.reject(new TypeError("Already read"));n.bodyUsed=!0}}function Iy(n){return new Promise(function(e,t){n.onload=function(){e(n.result)},n.onerror=function(){t(n.error)}})}function tx(n){var e=new FileReader,t=Iy(e);return e.readAsArrayBuffer(n),t}function rx(n){var e=new FileReader,t=Iy(e),r=/charset=([A-Za-z0-9_-]+)/.exec(n.type),a=r?r[1]:"utf-8";return e.readAsText(n,a),t}function nx(n){for(var e=new Uint8Array(n),t=new Array(e.length),r=0;r<e.length;r++)t[r]=String.fromCharCode(e[r]);return t.join("")}function Oy(n){if(n.slice)return n.slice(0);var e=new Uint8Array(n.byteLength);return e.set(new Uint8Array(n)),e.buffer}function Py(){return this.bodyUsed=!1,this._initBody=function(n){this.bodyUsed=this.bodyUsed,this._bodyInit=n,n?typeof n=="string"?this._bodyText=n:Je.blob&&Blob.prototype.isPrototypeOf(n)?this._bodyBlob=n:Je.formData&&FormData.prototype.isPrototypeOf(n)?this._bodyFormData=n:Je.searchParams&&URLSearchParams.prototype.isPrototypeOf(n)?this._bodyText=n.toString():Je.arrayBuffer&&Je.blob&&ex(n)?(this._bodyArrayBuffer=Oy(n.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):Je.arrayBuffer&&(ArrayBuffer.prototype.isPrototypeOf(n)||xy(n))?this._bodyArrayBuffer=Oy(n):this._bodyText=n=Object.prototype.toString.call(n):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||(typeof n=="string"?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):Je.searchParams&&URLSearchParams.prototype.isPrototypeOf(n)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},Je.blob&&(this.blob=function(){var n=Kl(this);if(n)return n;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var n=Kl(this);return n||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}else{if(Je.blob)return this.blob().then(tx);throw new Error("could not read as ArrayBuffer")}},this.text=function(){var n=Kl(this);if(n)return n;if(this._bodyBlob)return rx(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(nx(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},Je.formData&&(this.formData=function(){return this.text().then(ix)}),this.json=function(){return this.text().then(JSON.parse)},this}var ax=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function sx(n){var e=n.toUpperCase();return ax.indexOf(e)>-1?e:n}function Yn(n,e){if(!(this instanceof Yn))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');e=e||{};var t=e.body;if(n instanceof Yn){if(n.bodyUsed)throw new TypeError("Already read");this.url=n.url,this.credentials=n.credentials,e.headers||(this.headers=new xe(n.headers)),this.method=n.method,this.mode=n.mode,this.signal=n.signal,!t&&n._bodyInit!=null&&(t=n._bodyInit,n.bodyUsed=!0)}else this.url=String(n);if(this.credentials=e.credentials||this.credentials||"same-origin",(e.headers||!this.headers)&&(this.headers=new xe(e.headers)),this.method=sx(e.method||this.method||"GET"),this.mode=e.mode||this.mode||null,this.signal=e.signal||this.signal||function(){if("AbortController"in Ne){var s=new AbortController;return s.signal}}(),this.referrer=null,(this.method==="GET"||this.method==="HEAD")&&t)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(t),(this.method==="GET"||this.method==="HEAD")&&(e.cache==="no-store"||e.cache==="no-cache")){var r=/([?&])_=[^&]*/;if(r.test(this.url))this.url=this.url.replace(r,"$1_="+new Date().getTime());else{var a=/\?/;this.url+=(a.test(this.url)?"&":"?")+"_="+new Date().getTime()}}}Yn.prototype.clone=function(){return new Yn(this,{body:this._bodyInit})};function ix(n){var e=new FormData;return n.trim().split("&").forEach(function(t){if(t){var r=t.split("="),a=r.shift().replace(/\+/g," "),s=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(a),decodeURIComponent(s))}}),e}function ox(n){var e=new xe,t=n.replace(/\r?\n[\t ]+/g," ");return t.split("\r").map(function(r){return r.indexOf(`
`)===0?r.substr(1,r.length):r}).forEach(function(r){var a=r.split(":"),s=a.shift().trim();if(s){var i=a.join(":").trim();try{e.append(s,i)}catch(o){console.warn("Response "+o.message)}}}),e}Py.call(Yn.prototype);function ur(n,e){if(!(this instanceof ur))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(e||(e={}),this.type="default",this.status=e.status===void 0?200:e.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=e.statusText===void 0?"":""+e.statusText,this.headers=new xe(e.headers),this.url=e.url||"",this._initBody(n)}Py.call(ur.prototype);ur.prototype.clone=function(){return new ur(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new xe(this.headers),url:this.url})};ur.error=function(){var n=new ur(null,{status:200,statusText:""});return n.ok=!1,n.status=0,n.type="error",n};var ux=[301,302,303,307,308];ur.redirect=function(n,e){if(ux.indexOf(e)===-1)throw new RangeError("Invalid status code");return new ur(null,{status:e,headers:{location:n}})};var Xn=Ne.DOMException;try{new Xn}catch(n){Xn=function(e,t){this.message=e,this.name=t;var r=Error(e);this.stack=r.stack},Xn.prototype=Object.create(Error.prototype),Xn.prototype.constructor=Xn}function Ty(n,e){return new Promise(function(t,r){var a=new Yn(n,e);if(a.signal&&a.signal.aborted)return r(new Xn("Aborted","AbortError"));var s=new XMLHttpRequest;function i(){s.abort()}s.onload=function(){var c={statusText:s.statusText,headers:ox(s.getAllResponseHeaders()||"")};a.url.indexOf("file://")===0&&(s.status<200||s.status>599)?c.status=200:c.status=s.status,c.url="responseURL"in s?s.responseURL:c.headers.get("X-Request-URL");var l="response"in s?s.response:s.responseText;setTimeout(function(){t(new ur(l,c))},0)},s.onerror=function(){setTimeout(function(){r(new TypeError("Network request failed"))},0)},s.ontimeout=function(){setTimeout(function(){r(new TypeError("Network request timed out"))},0)},s.onabort=function(){setTimeout(function(){r(new Xn("Aborted","AbortError"))},0)};function o(c){try{return c===""&&Ne.location.href?Ne.location.href:c}catch(l){return c}}if(s.open(a.method,o(a.url),!0),a.credentials==="include"?s.withCredentials=!0:a.credentials==="omit"&&(s.withCredentials=!1),"responseType"in s&&(Je.blob?s.responseType="blob":Je.arrayBuffer&&(s.responseType="arraybuffer")),e&&typeof e.headers=="object"&&!(e.headers instanceof xe||Ne.Headers&&e.headers instanceof Ne.Headers)){var u=[];Object.getOwnPropertyNames(e.headers).forEach(function(c){u.push(is(c)),s.setRequestHeader(c,Jl(e.headers[c]))}),a.headers.forEach(function(c,l){u.indexOf(l)===-1&&s.setRequestHeader(l,c)})}else a.headers.forEach(function(c,l){s.setRequestHeader(l,c)});a.signal&&(a.signal.addEventListener("abort",i),s.onreadystatechange=function(){s.readyState===4&&a.signal.removeEventListener("abort",i)}),s.send(typeof a._bodyInit=="undefined"?null:a._bodyInit)})}Ty.polyfill=!0;Ne.fetch||(Ne.fetch=Ty,Ne.Headers=xe,Ne.Request=Yn,Ne.Response=ur);var cx="0.5.11",lx=Object.defineProperty,dx=(n,e,t)=>e in n?lx(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Xl=(n,e,t)=>(dx(n,typeof e!="symbol"?e+"":e,t),t),Ql=class n extends Error{constructor(e,t){super(e),this.error=e,this.status_code=t,this.name="ResponseError",Error.captureStackTrace&&Error.captureStackTrace(this,n)}},ed=class{constructor(e,t,r){Xl(this,"abortController"),Xl(this,"itr"),Xl(this,"doneCallback"),this.abortController=e,this.itr=t,this.doneCallback=r}abort(){this.abortController.abort()}async*[Symbol.asyncIterator](){for await(let e of this.itr){if("error"in e)throw new Error(e.error);if(yield e,e.done||e.status==="success"){this.doneCallback();return}}throw new Error("Did not receive done or success response in stream.")}},td=async n=>{var r;if(n.ok)return;let e=`Error ${n.status}: ${n.statusText}`,t=null;if((r=n.headers.get("content-type"))!=null&&r.includes("application/json"))try{t=await n.json(),e=t.error||e}catch(a){console.log("Failed to parse error response as JSON")}else try{console.log("Getting text from response"),e=await n.text()||e}catch(a){console.log("Failed to get text from error response")}throw new Ql(e,n.status)};function hx(){return typeof window!="undefined"&&window.navigator?`${window.navigator.platform.toLowerCase()} Browser/${navigator.userAgent};`:typeof process!="undefined"?`${process.arch} ${process.platform} Node.js/${process.version}`:""}var rd=async(n,e,t={})=>{let r={"Content-Type":"application/json",Accept:"application/json","User-Agent":`ollama-js/${cx} (${hx()})`};t.headers||(t.headers={});let a=Object.fromEntries(Object.entries(t.headers).filter(([s])=>!Object.keys(r).some(i=>i.toLowerCase()===s.toLowerCase())));return t.headers={...r,...a},n(e,t)},Sy=async(n,e,t)=>{let r=await rd(n,e,{headers:t==null?void 0:t.headers});return await td(r),r};var os=async(n,e,t,r)=>{let s=(o=>o!==null&&typeof o=="object"&&!Array.isArray(o))(t)?JSON.stringify(t):t,i=await rd(n,e,{method:"POST",body:s,signal:r==null?void 0:r.signal,headers:r==null?void 0:r.headers});return await td(i),i},fx=async(n,e,t,r)=>{let a=await rd(n,e,{method:"DELETE",body:JSON.stringify(t),headers:r==null?void 0:r.headers});return await td(a),a},px=async function*(n){var a;let e=new TextDecoder("utf-8"),t="",r=n.getReader();for(;;){let{done:s,value:i}=await r.read();if(s)break;t+=e.decode(i);let o=t.split(`
`);t=(a=o.pop())!=null?a:"";for(let u of o)try{yield JSON.parse(u)}catch(c){console.warn("invalid json: ",u)}}for(let s of t.split(`
`).filter(i=>i!==""))try{yield JSON.parse(s)}catch(i){console.warn("invalid json: ",s)}},mx=n=>{if(!n)return"http://127.0.0.1:11434";let e=n.includes("://");n.startsWith(":")&&(n=`http://127.0.0.1${n}`,e=!0),e||(n=`http://${n}`);let t=new URL(n),r=t.port;r||(e?r=t.protocol==="https:"?"443":"80":r="11434");let a=`${t.protocol}//${t.hostname}:${r}${t.pathname}`;return a.endsWith("/")&&(a=a.slice(0,-1)),a},gx=Object.defineProperty,yx=(n,e,t)=>e in n?gx(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Yl=(n,e,t)=>(yx(n,typeof e!="symbol"?e+"":e,t),t),us=class{constructor(e){var t,r;Yl(this,"config"),Yl(this,"fetch"),Yl(this,"ongoingStreamedRequests",[]),this.config={host:"",headers:e==null?void 0:e.headers},e!=null&&e.proxy||(this.config.host=mx((t=e==null?void 0:e.host)!=null?t:"http://127.0.0.1:11434")),this.fetch=(r=e==null?void 0:e.fetch)!=null?r:fetch}abort(){for(let e of this.ongoingStreamedRequests)e.abort();this.ongoingStreamedRequests.length=0}async processStreamableRequest(e,t){var s;t.stream=(s=t.stream)!=null?s:!1;let r=`${this.config.host}/api/${e}`;if(t.stream){let i=new AbortController,o=await os(this.fetch,r,t,{signal:i.signal,headers:this.config.headers});if(!o.body)throw new Error("Missing body");let u=px(o.body),c=new ed(i,u,()=>{let l=this.ongoingStreamedRequests.indexOf(c);l>-1&&this.ongoingStreamedRequests.splice(l,1)});return this.ongoingStreamedRequests.push(c),c}return await(await os(this.fetch,r,t,{headers:this.config.headers})).json()}async encodeImage(e){if(typeof e!="string"){let t=new Uint8Array(e),r="",a=t.byteLength;for(let s=0;s<a;s++)r+=String.fromCharCode(t[s]);return btoa(r)}return e}async generate(e){return e.images&&(e.images=await Promise.all(e.images.map(this.encodeImage.bind(this)))),this.processStreamableRequest("generate",e)}async chat(e){if(e.messages)for(let t of e.messages)t.images&&(t.images=await Promise.all(t.images.map(this.encodeImage.bind(this))));return this.processStreamableRequest("chat",e)}async create(e){return this.processStreamableRequest("create",{name:e.model,stream:e.stream,modelfile:e.modelfile,quantize:e.quantize})}async pull(e){return this.processStreamableRequest("pull",{name:e.model,stream:e.stream,insecure:e.insecure})}async push(e){return this.processStreamableRequest("push",{name:e.model,stream:e.stream,insecure:e.insecure})}async delete(e){return await fx(this.fetch,`${this.config.host}/api/delete`,{name:e.model},{headers:this.config.headers}),{status:"success"}}async copy(e){return await os(this.fetch,`${this.config.host}/api/copy`,{...e},{headers:this.config.headers}),{status:"success"}}async list(){return await(await Sy(this.fetch,`${this.config.host}/api/tags`,{headers:this.config.headers})).json()}async show(e){return await(await os(this.fetch,`${this.config.host}/api/show`,{...e},{headers:this.config.headers})).json()}async embed(e){return await(await os(this.fetch,`${this.config.host}/api/embed`,{...e},{headers:this.config.headers})).json()}async embeddings(e){return await(await os(this.fetch,`${this.config.host}/api/embeddings`,{...e},{headers:this.config.headers})).json()}async ps(){return await(await Sy(this.fetch,`${this.config.host}/api/ps`,{headers:this.config.headers})).json()}},bx=new us;function nd(n,e){var t,r;return new Le({content:(t=n.content)!=null?t:"",tool_call_chunks:(r=n.tool_calls)==null?void 0:r.map(a=>({name:a.function.name,args:JSON.stringify(a.function.arguments),type:"tool_call_chunk",index:0,id:pe()})),response_metadata:e==null?void 0:e.responseMetadata,usage_metadata:e==null?void 0:e.usageMetadata})}function ky(n){let e=n.match(/^data:.*?;base64,(.*)$/);return e?e[1]:""}function _x(n){var a,s,i;if(typeof n.content=="string")return[{role:"assistant",content:n.content}];let t=n.content.filter(o=>o.type==="text"&&typeof o.text=="string").map(o=>({role:"assistant",content:o.text})),r;if(n.content.find(o=>o.type==="tool_use")&&((a=n.tool_calls)!=null&&a.length)){let o=(s=n.tool_calls)==null?void 0:s.map(u=>({id:u.id,type:"function",function:{name:u.name,arguments:u.args}}));o&&(r={role:"assistant",tool_calls:o,content:""})}else if(n.content.find(o=>o.type==="tool_use")&&!((i=n.tool_calls)!=null&&i.length))throw new Error("'tool_use' content type is not supported without tool calls.");return[...t,...r?[r]:[]]}function wx(n){return typeof n.content=="string"?[{role:"user",content:n.content}]:n.content.map(e=>{if(e.type==="text")return{role:"user",content:e.text};if(e.type==="image_url"){if(typeof e.image_url=="string")return{role:"user",content:"",images:[ky(e.image_url)]};if(e.image_url.url&&typeof e.image_url.url=="string")return{role:"user",content:"",images:[ky(e.image_url.url)]}}throw new Error(`Unsupported content type: ${e.type}`)})}function vx(n){if(typeof n.content=="string")return[{role:"system",content:n.content}];if(n.content.every(e=>e.type==="text"&&typeof e.text=="string"))return n.content.map(e=>({role:"system",content:e.text}));throw new Error(`Unsupported content type(s): ${n.content.map(e=>e.type).join(", ")}`)}function Ax(n){if(typeof n.content!="string")throw new Error("Non string tool message content is not supported");return[{role:"tool",content:n.content}]}function Cy(n){return n.flatMap(e=>{if(["human","generic"].includes(e._getType()))return wx(e);if(e._getType()==="ai")return _x(e);if(e._getType()==="system")return vx(e);if(e._getType()==="tool")return Ax(e);throw new Error(`Unsupported message type: ${e._getType()}`)})}var _u=class extends rs{static lc_name(){return"ChatOllama"}constructor(e){var t,r,a;super(e!=null?e:{}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"llama3"}),Object.defineProperty(this,"numa",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numCtx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numBatch",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mainGpu",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lowVram",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"f16Kv",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitsAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"vocabOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMmap",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useMlock",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"embeddingOnly",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numThread",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numKeep",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"numPredict",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tfsZ",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"typicalP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatLastN",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"repeatPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostat",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatTau",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"mirostatEta",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"penalizeNewline",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"format",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keepAlive",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"checkOrPullModel",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:"http://127.0.0.1:11434"}),this.client=new us({host:e==null?void 0:e.baseUrl,headers:e==null?void 0:e.headers}),this.baseUrl=(t=e==null?void 0:e.baseUrl)!=null?t:this.baseUrl,this.model=(r=e==null?void 0:e.model)!=null?r:this.model,this.numa=e==null?void 0:e.numa,this.numCtx=e==null?void 0:e.numCtx,this.numBatch=e==null?void 0:e.numBatch,this.numGpu=e==null?void 0:e.numGpu,this.mainGpu=e==null?void 0:e.mainGpu,this.lowVram=e==null?void 0:e.lowVram,this.f16Kv=e==null?void 0:e.f16Kv,this.logitsAll=e==null?void 0:e.logitsAll,this.vocabOnly=e==null?void 0:e.vocabOnly,this.useMmap=e==null?void 0:e.useMmap,this.useMlock=e==null?void 0:e.useMlock,this.embeddingOnly=e==null?void 0:e.embeddingOnly,this.numThread=e==null?void 0:e.numThread,this.numKeep=e==null?void 0:e.numKeep,this.seed=e==null?void 0:e.seed,this.numPredict=e==null?void 0:e.numPredict,this.topK=e==null?void 0:e.topK,this.topP=e==null?void 0:e.topP,this.tfsZ=e==null?void 0:e.tfsZ,this.typicalP=e==null?void 0:e.typicalP,this.repeatLastN=e==null?void 0:e.repeatLastN,this.temperature=e==null?void 0:e.temperature,this.repeatPenalty=e==null?void 0:e.repeatPenalty,this.presencePenalty=e==null?void 0:e.presencePenalty,this.frequencyPenalty=e==null?void 0:e.frequencyPenalty,this.mirostat=e==null?void 0:e.mirostat,this.mirostatTau=e==null?void 0:e.mirostatTau,this.mirostatEta=e==null?void 0:e.mirostatEta,this.penalizeNewline=e==null?void 0:e.penalizeNewline,this.streaming=e==null?void 0:e.streaming,this.format=e==null?void 0:e.format,this.keepAlive=e==null?void 0:e.keepAlive,this.checkOrPullModel=(a=e==null?void 0:e.checkOrPullModel)!=null?a:this.checkOrPullModel}_llmType(){return"ollama"}async pull(e,t){let{stream:r,insecure:a,logProgress:s}={stream:!0,...t};if(r)for await(let i of await this.client.pull({model:e,insecure:a,stream:r}))s&&console.log(i);else{let i=await this.client.pull({model:e,insecure:a});s&&console.log(i)}}bindTools(e,t){return this.bind({tools:e.map(r=>mu(r)),...t})}getLsParams(e){var r,a,s,i;let t=this.invocationParams(e);return{ls_provider:"ollama",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:(a=(r=t.options)==null?void 0:r.temperature)!=null?a:void 0,ls_max_tokens:(i=(s=t.options)==null?void 0:s.num_predict)!=null?i:void 0,ls_stop:e.stop}}invocationParams(e){var t;if(e!=null&&e.tool_choice)throw new Error("Tool choice is not supported for ChatOllama.");return{model:this.model,format:this.format,keep_alive:this.keepAlive,options:{numa:this.numa,num_ctx:this.numCtx,num_batch:this.numBatch,num_gpu:this.numGpu,main_gpu:this.mainGpu,low_vram:this.lowVram,f16_kv:this.f16Kv,logits_all:this.logitsAll,vocab_only:this.vocabOnly,use_mmap:this.useMmap,use_mlock:this.useMlock,embedding_only:this.embeddingOnly,num_thread:this.numThread,num_keep:this.numKeep,seed:this.seed,num_predict:this.numPredict,top_k:this.topK,top_p:this.topP,tfs_z:this.tfsZ,typical_p:this.typicalP,repeat_last_n:this.repeatLastN,temperature:this.temperature,repeat_penalty:this.repeatPenalty,presence_penalty:this.presencePenalty,frequency_penalty:this.frequencyPenalty,mirostat:this.mirostat,mirostat_tau:this.mirostatTau,mirostat_eta:this.mirostatEta,penalize_newline:this.penalizeNewline,stop:e==null?void 0:e.stop},tools:(t=e==null?void 0:e.tools)!=null&&t.length?e.tools.map(r=>mu(r)):void 0}}async checkModelExistsOnMachine(e){let{models:t}=await this.client.list();return!!t.find(r=>r.name===e||r.name===`${e}:latest`)}async _generate(e,t,r){var i;this.checkOrPullModel&&(await this.checkModelExistsOnMachine(this.model)||await this.pull(this.model,{logProgress:!0}));let a;for await(let o of this._streamResponseChunks(e,t,r))a?a=Te(a,o.message):a=o.message;let s=new Qe({id:a==null?void 0:a.id,content:(i=a==null?void 0:a.content)!=null?i:"",tool_calls:a==null?void 0:a.tool_calls,response_metadata:a==null?void 0:a.response_metadata,usage_metadata:a==null?void 0:a.usage_metadata});return{generations:[{text:typeof s.content=="string"?s.content:"",message:s}]}}async*_streamResponseChunks(e,t,r){var c,l,d,h,f,p,g;this.checkOrPullModel&&(await this.checkModelExistsOnMachine(this.model)||await this.pull(this.model,{logProgress:!0}));let a=this.invocationParams(t),s=Cy(e),i={input_tokens:0,output_tokens:0,total_tokens:0};if(a.tools&&a.tools.length>0){let y=await this.client.chat({...a,messages:s,stream:!1}),{message:m,...b}=y;return i.input_tokens+=(c=b.prompt_eval_count)!=null?c:0,i.output_tokens+=(l=b.eval_count)!=null?l:0,i.total_tokens=i.input_tokens+i.output_tokens,yield new It({text:m.content,message:nd(m,{responseMetadata:b,usageMetadata:i})}),r==null?void 0:r.handleLLMNewToken(m.content)}let o=await this.client.chat({...a,messages:s,stream:!0}),u;for await(let y of o){(d=t.signal)!=null&&d.aborted&&this.client.abort();let{message:m,...b}=y;i.input_tokens+=(h=b.prompt_eval_count)!=null?h:0,i.output_tokens+=(f=b.eval_count)!=null?f:0,i.total_tokens=i.input_tokens+i.output_tokens,u=b,yield new It({text:(p=m.content)!=null?p:"",message:nd(m)}),await(r==null?void 0:r.handleLLMNewToken((g=m.content)!=null?g:""))}yield new It({text:"",message:new Le({content:"",response_metadata:u,usage_metadata:i})})}};var Vt=require("obsidian");var wu=require("@codemirror/state");var cs=wu.StateEffect.define(),Qn=wu.StateField.define({create(){return null},update(n,e){if(e.effects.some(t=>t.is(cs))){let t=e.effects.find(r=>r.is(cs));return t?t.value:n}return e.effects.some(t=>t.is(kt))?null:n}});function Ry(n,e,t){for(let r of t){let a=`${e}${r.keyword}`;if(n.includes(a))return n.replace(a,r.prompt)}return n}var vu=class{constructor(e,t){ne(this,"chatClient");ne(this,"app");ne(this,"settings");this.app=t,this.chatClient=this.initializeChatClient(e),this.settings=e}initializeChatClient(e){try{switch(e.provider){case"openai":return e.apiKey?new ss({modelName:e.model,temperature:0,apiKey:e.apiKey}):(new Vt.Notice("\u26A0\uFE0F OpenAI API key is required. Please check your settings."),null);case"ollama":return new _u({model:e.model});case"custom":return!e.apiKey||!e.customURL?(new Vt.Notice("\u26A0\uFE0F API key and custom base URL are required for custom providers."),null):new ss({modelName:e.model,temperature:0,openAIApiKey:e.apiKey,configuration:{baseURL:e.customURL.trim()}});default:return new Vt.Notice(`\u26A0\uFE0F Unsupported provider: ${e.provider}`),null}}catch(t){return console.error("Error initializing chat client:",t),new Vt.Notice(`\u274C Error initializing chat client: ${t.message}`),null}}async callApi(e,t){if(!this.chatClient)return new Vt.Notice("\u26A0\uFE0F Chat client is not initialized. Please check your settings."),"\u26A0\uFE0F Chat client is not available.";let r=[new zr(e),new dt(t)];try{return(await this.chatClient.invoke(r)).content.toString()}catch(a){return console.error("Error calling the chat model:",a),new Vt.Notice(`\u274C Error calling the chat model: ${a.message}`),"\u26A0\uFE0F Failed to generate a response. Please try again later."}}async handleEditorUpdate(e,t){try{let r=await this.callApi(e,t);if(!r)return"\u26A0\uFE0F No response generated.";let a=this.app.workspace.getActiveViewOfType(Vt.MarkdownView);if(!a)return new Vt.Notice("\u26A0\uFE0F No active Markdown editor found."),"";let s=a.editor.cm;return s==null||s.dispatch({effects:cs.of({airesponse:r,prompt:t})}),r}catch(r){return console.error("Error processing request:",r),new Vt.Notice(`\u274C Error processing request: ${r.message}`),"\u26A0\uFE0F Failed to process request."}}async callCursor(e){return this.handleEditorUpdate("You are a helpful assistant. Please help the user with the following request:",e)}async callSelection(e,t){e=Ry(e,this.settings.commandPrefix,this.settings.customCommands);let r=!1;t.trim().length===0&&(r=!0);let a=r?this.settings.cursorPrompt:this.settings.selectionPrompt,s="";return r?s=`
      **Task:** ${e}  
      **Output:**`:s=`
      **Task:** ${e}  
      **Input:**  
      ${t}

      **Output:**`,this.handleEditorUpdate(a,s)}updateSettings(e){this.settings=e;let t=this.initializeChatClient(e);t&&(this.chatClient=t)}};var Ou=require("@codemirror/state"),St=require("@codemirror/view"),Au=pt(Ny());var Eu=class extends St.WidgetType{constructor(t,r){super();this.content=t;this.type=r}toDOM(){let t=document.createElement("span");return t.className=`cm-change-widget cm-change-${this.type}`,t.textContent=this.content,t.setAttribute("aria-label",this.type==="added"?"Added content":"Removed content"),t}ignoreEvent(){return!1}};function Ex(n){var e,t,r;try{let a=n.field(Qn),s=n.field(cr),i=(e=a==null?void 0:a.airesponse)!=null?e:"",o=(t=s==null?void 0:s.text)!=null?t:"",u=new Au.default,c=u.diff_main(o,i);u.diff_cleanupSemantic(c);let l=new Ou.RangeSetBuilder,d=(r=s==null?void 0:s.from)!=null?r:0;return c.forEach(([h,f])=>{let p=f.length;if(h===Au.default.DIFF_INSERT){let g=new Eu(f,"added");l.add(d,d,St.Decoration.widget({widget:g,side:1}))}else if(h===Au.default.DIFF_DELETE){let g=new Eu(f,"removed");l.add(d,d+p,St.Decoration.widget({widget:g,side:-1})),d+=p}else d+=p}),l.finish()}catch(a){return console.error("Error generating diff view:",a),St.Decoration.none}}function Ox(n,e){var t,r,a;try{let s=n.field(Qn),i=n.field(cr),o=(t=s==null?void 0:s.airesponse)!=null?t:"",u=(r=i==null?void 0:i.from)!=null?r:0,c=(a=i==null?void 0:i.to)!=null?a:0;e.dispatch({changes:{from:u,to:c,insert:o}})}catch(s){console.error("Error applying diff changes:",s)}}var xx=Ou.StateField.define({create(){return St.Decoration.none},update(n,e){return e.effects.some(r=>r.is(cs))?Ex(e.state):e.effects.some(r=>r.is(kt))?St.Decoration.none:n},provide:n=>St.EditorView.decorations.from(n)}),Ix=St.ViewPlugin.fromClass(class{update(n){for(let e of n.transactions)for(let t of e.effects)t.is(vs)&&setTimeout(()=>{Ox(n.state,n.view)},0)}}),$y=[xx,Ix];var xu=class extends ds.Plugin{constructor(){super(...arguments);ne(this,"settings",Tu);ne(this,"chatapi")}async onload(){await this.loadSettings(),this.chatapi=new vu(this.settings,this.app),this.registerEditorExtension([Cd(this.chatapi,this),Qn,cr,Pd,$y]),this.addCommand({id:"show-cursor-tooltip",name:"Show cursor tooltip",callback:()=>{let t=this.app.workspace.getActiveViewOfType(ds.MarkdownView);if(t){let r=t.editor.cm,{from:a,to:s}=r.state.selection.main,i=[];if(a!==s){let o=r.state.doc.sliceString(a,s);i.push(Oi.of({from:a,to:s,text:o}))}else i.push(Oi.of(null));i.push(ku.of(null)),r.dispatch({effects:i})}},hotkeys:[]}),this.addCommand({id:"accept-tooltip",name:"Accept tooltip suggestion",callback:()=>{let t=this.app.workspace.getActiveViewOfType(ds.MarkdownView);if(t){let r=t.editor.cm;r.state.field(Qn,!1)&&(r.dispatch({effects:vs.of(null)}),r.dispatch({effects:kt.of(null)}))}}}),this.addCommand({id:"discard-tooltip",name:"Discard tooltip suggestion",callback:()=>{let t=this.app.workspace.getActiveViewOfType(ds.MarkdownView);if(t){let r=t.editor.cm;r.state.field(Qn,!1)&&r.dispatch({effects:kt.of(null)})}}}),this.addSettingTab(new Ei(this.app,this))}onunload(){}async loadSettings(){this.settings=Object.assign({},Tu,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}};
/*! Bundled license information:

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)
*/

/* nosourcemap */